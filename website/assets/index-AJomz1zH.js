class Te{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e=e*2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=Te.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=Te.Repeat(e,t*2);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let s=Te.Clamp(i);return s=-2*s*s*s+3*s*s,t*s+e*(1-s)}static MoveTowards(e,t,i){let s=0;return Math.abs(t-e)<=i?s=t:s=e+Te.Sign(t-e)*i,s}static MoveTowardsAngle(e,t,i){const s=Te.DeltaAngle(e,t);let r=0;return-i<s&&s<i?r=t:(t=e+s,r=Te.MoveTowards(e,t,i)),r}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let s=Te.Repeat(t-e,360);return s>180&&(s-=360),e+s*Te.Clamp(i)}static InverseLerp(e,t,i){let s=0;return e!=t?s=Te.Clamp((i-e)/(t-e)):s=0,s}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,l=2*a-3*n+1,h=-2*a+3*n,c=a-2*n+r,u=a-n;return e*l+i*h+t*c+s*u}static Hermite1stDerivative(e,t,i,s,r){const n=r*r;return(n-r)*6*e+(3*n-4*r+1)*t+(-n+r)*6*i+(3*n-2*r)*s}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-=Te.TwoPi*Math.floor((e+Math.PI)/Te.TwoPi),e}static HCF(e,t){const i=e%t;return i===0?t:Te.HCF(t,i)}}Te.TwoPi=Math.PI*2;const LR=1/2.2,Cc=2.2,dt=.001;class yi{static BuildArray(e,t){const i=[];for(let s=0;s<e;++s)i.push(t());return i}static BuildTuple(e,t){return yi.BuildArray(e,t)}}function FR(o,e,t){const i=o[e];if(typeof i!="function")return null;const s=function(){const r=o.length,n=s.previous.apply(o,arguments);return t(e,r),n};return i.next=s,s.previous=i,o[e]=s,()=>{const r=s.previous;if(!r)return;const n=s.next;n?(r.next=n,n.previous=r):(r.next=void 0,o[e]=r),s.next=void 0,s.previous=void 0}}const wR=["push","splice","pop","shift","unshift"];function pm(o,e){const t=wR.map(i=>FR(o,i,e));return()=>{t.forEach(i=>{i==null||i()})}}const gm={};function Re(o,e){gm[o]=e}function Gr(o){return gm[o]}class Ri{static SetMatrixPrecision(e){if(Ri.MatrixTrackPrecisionChange=!1,e&&!Ri.MatrixUse64Bits&&Ri.MatrixTrackedMatrices)for(let t=0;t<Ri.MatrixTrackedMatrices.length;++t){const i=Ri.MatrixTrackedMatrices[t],s=i._m;i._m=new Array(16);for(let r=0;r<16;++r)i._m[r]=s[r]}Ri.MatrixUse64Bits=e,Ri.MatrixCurrentType=Ri.MatrixUse64Bits?Array:Float32Array,Ri.MatrixTrackedMatrices=null}}Ri.MatrixUse64Bits=!1;Ri.MatrixTrackPrecisionChange=!0;Ri.MatrixCurrentType=Float32Array;Ri.MatrixTrackedMatrices=[];class BR{constructor(e,t=!1,i,s){this.initialize(e,t,i,s)}initialize(e,t=!1,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}}class UR{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(){this._remove&&this._remove()}}class j{static FromPromise(e,t){const i=new j;return e.then(s=>{i.notifyObservers(s)}).catch(s=>{if(t)t.notifyObservers(s);else throw s}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new BR(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,s=null,r=!1){if(!e)return null;const n=new UR(e,t,s);return n.unregisterOnNextCall=r,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(n,this._lastNotifiedValue),n._remove=()=>{this.remove(n)},n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!s._willBeUnregistered&&s.callback===e&&(!t||t===s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;const i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,s,r){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=s,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=r;for(const a of this._observers)if(!a._willBeUnregistered&&(a.mask&t&&(a.unregisterOnNextCall&&this._deferUnregister(a),a.scope?n.lastReturnValue=a.callback.apply(a.scope,[e,n]):n.lastReturnValue=a.callback(e,n)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,s)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){const e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){const e=new j;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class Ze{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}Ze.Instances=[];Ze.OnEnginesDisposedObservable=new j;Ze._LastCreatedScene=null;Ze.UseFallbackTexture=!0;Ze.FallbackTexture="";const ls=o=>parseInt(o.toString().replace(/\W/g,""));class Ke{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=ls(this.x),t=ls(this.y);let i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return Ke.FromArrayToRef(e,t,this),this}asArray(){const e=[];return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=dt){return e&&Te.WithinEpsilon(this.x,e.x,t)&&Te.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),s=Math.sin(e),r=i*this.x-s*this.y,n=s*this.x+i*this.y;return t.x=r,t.y=n,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this.x,this.y):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new Ke(0,0)}static One(){return new Ke(1,1)}static Random(e=0,t=1){return new Ke(Te.RandomRange(e,t),Te.RandomRange(e,t))}static get ZeroReadOnly(){return Ke._ZeroReadOnly}static FromArray(e,t=0){return new Ke(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static CatmullRom(e,t,i,s,r){const n=r*r,a=r*n,l=.5*(2*t.x+(-e.x+i.x)*r+(2*e.x-5*t.x+4*i.x-s.x)*n+(-e.x+3*t.x-3*i.x+s.x)*a),h=.5*(2*t.y+(-e.y+i.y)*r+(2*e.y-5*t.y+4*i.y-s.y)*n+(-e.y+3*t.y-3*i.y+s.y)*a);return new e.constructor(l,h)}static Clamp(e,t,i){let s=e.x;s=s>i.x?i.x:s,s=s<t.x?t.x:s;let r=e.y;return r=r>i.y?i.y:r,r=r<t.y?t.y:r,new e.constructor(s,r)}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,l=2*a-3*n+1,h=-2*a+3*n,c=a-2*n+r,u=a-n,d=e.x*l+i.x*h+t.x*c+s.x*u,f=e.y*l+i.y*h+t.y*c+s.y*u;return new e.constructor(d,f)}static Hermite1stDerivative(e,t,i,s,r){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n.x=(a-r)*6*e.x+(3*a-4*r+1)*t.x+(-a+r)*6*i.x+(3*a-2*r)*s.x,n.y=(a-r)*6*e.y+(3*a-4*r+1)*t.y+(-a+r)*6*i.y+(3*a-2*r)*s.y,n}static Lerp(e,t,i){const s=e.x+(t.x-e.x)*i,r=e.y+(t.y-e.y)*i;return new e.constructor(s,r)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=new e.constructor;return Ke.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,s=e.y<t.y?e.y:t.y;return new e.constructor(i,s)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,s=e.y>t.y?e.y:t.y;return new e.constructor(i,s)}static Transform(e,t){const i=new e.constructor;return Ke.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+s[12],n=e.x*s[1]+e.y*s[5]+s[13];return i.x=r,i.y=n,i}static PointInTriangle(e,t,i,s){const r=.5*(-i.y*s.x+t.y*(-i.x+s.x)+t.x*(i.y-s.y)+i.x*s.y),n=r<0?-1:1,a=(t.y*s.x-t.x*s.y+(s.y-t.y)*e.x+(t.x-s.x)*e.y)*n,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return a>0&&l>0&&a+l<2*r*n}static Distance(e,t){return Math.sqrt(Ke.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static Center(e,t){const i=new e.constructor;return Ke.CenterToRef(e,t,i)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const s=Ke.DistanceSquared(t,i);if(s===0)return Ke.Distance(e,t);const r=i.subtract(t),n=Math.max(0,Math.min(1,Ke.Dot(e.subtract(t),r)/s)),a=t.add(r.multiplyByFloats(n,n));return Ke.Distance(e,a)}}Ke._ZeroReadOnly=Ke.Zero();class m{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=ls(this._x),t=ls(this._y),i=ls(this._z);let s=e;return s=s*397^t,s=s*397^i,s}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return m.FromArrayToRef(e,t,this),this}toQuaternion(){return le.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new this.constructor(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,s){return s.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const s=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const r=t*Math.sin(i)*Math.cos(s),n=t*Math.cos(i),a=t*Math.sin(i)*Math.sin(s);return e.set(r,n,a),e}applyRotationQuaternionToRef(e,t){const i=this._x,s=this._y,r=this._z,n=e._x,a=e._y,l=e._z,h=e._w,c=2*(a*r-l*s),u=2*(l*i-n*r),d=2*(n*s-a*i);return t._x=i+h*c+a*d-l*u,t._y=s+h*u+l*c-n*d,t._z=r+h*d+n*u-a*c,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=new this.constructor;return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const s=e.normal,r=e.d,n=Se.Vector3[0];this.subtractToRef(t,n),n.normalize();const a=m.Dot(n,s);if(Math.abs(a)<1e-10)i.setAll(1/0);else{const l=-(m.Dot(t,s)+r)/a,h=n.scaleInPlace(l);t.addToRef(h,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=dt){return e&&Te.WithinEpsilon(this._x,e._x,t)&&Te.WithinEpsilon(this._y,e._y,t)&&Te.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new this.constructor(this._x*e,this._y*t,this._z*i)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!Te.WithinEpsilon(t,i,e))return!0;const s=Math.abs(this._z);return!Te.WithinEpsilon(t,s,e)||!Te.WithinEpsilon(i,s,e)}get isNonUniform(){const e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;const i=Math.abs(this._z);return e!==i}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if(e=e.toLowerCase(),e==="xyz")return this;const t=Se.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(Se.Matrix[0]),m.TransformCoordinatesToRef(this,Se.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,Se.Vector3[0]),Se.Vector3[0].rotateByQuaternionToRef(e,Se.Vector3[0]),t.addToRef(Se.Vector3[0],i),i}cross(e){const t=new this.constructor;return m.CrossToRef(this,e,t)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,s){const r=m.Dot(e,i),n=m.Dot(t,i);return(r-s)/(r-n)}static GetAngleBetweenVectors(e,t,i){const s=e.normalizeToRef(Se.Vector3[1]),r=t.normalizeToRef(Se.Vector3[2]);let n=m.Dot(s,r);n=Te.Clamp(n,-1,1);const a=Math.acos(n),l=Se.Vector3[3];return m.CrossToRef(s,r,l),m.Dot(l,i)>0?isNaN(a)?0:a:isNaN(a)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){Se.Vector3[0].copyFrom(e);const s=Se.Vector3[0];Se.Vector3[1].copyFrom(t);const r=Se.Vector3[1];Se.Vector3[2].copyFrom(i);const n=Se.Vector3[2],a=Se.Vector3[3],l=Se.Vector3[4];s.normalize(),r.normalize(),n.normalize(),m.CrossToRef(n,s,a),m.CrossToRef(a,n,l);const h=Math.atan2(m.Dot(r,a),m.Dot(r,l));return Te.NormalizeRadians(h)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const s=D.Vector3[0];return t.subtractToRef(e,s),i._y=Math.atan2(s.x,s.z)||0,i._x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=m.Zero();return m.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,s){i=Te.Clamp(i,0,1);const r=Se.Vector3[0],n=Se.Vector3[1];r.copyFrom(e);const a=r.length();r.normalizeFromLength(a),n.copyFrom(t);const l=n.length();n.normalizeFromLength(l);const h=m.Dot(r,n);let c,u;if(h<1-dt){const d=Math.acos(h),f=1/Math.sin(d);c=Math.sin((1-i)*d)*f,u=Math.sin(i*d)*f}else c=1-i,u=i;return r.scaleInPlace(c),n.scaleInPlace(u),s.copyFrom(r).addInPlace(n),s.scaleInPlace(Te.Lerp(a,l,i)),s}static SmoothToRef(e,t,i,s,r){return m.SlerpToRef(e,t,s===0?1:i/s,r),r}static FromArray(e,t=0){return new m(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return m.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return m.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s){return s.copyFromFloats(e,t,i),s}static Zero(){return new m(0,0,0)}static One(){return new m(1,1,1)}static Up(){return new m(0,1,0)}static get UpReadOnly(){return m._UpReadOnly}static get DownReadOnly(){return m._DownReadOnly}static get RightReadOnly(){return m._RightReadOnly}static get LeftReadOnly(){return m._LeftReadOnly}static get LeftHandedForwardReadOnly(){return m._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return m._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return m._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return m._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return m._ZeroReadOnly}static get OneReadOnly(){return m._OneReadOnly}static Down(){return new m(0,-1,0)}static Forward(e=!1){return new m(0,0,e?-1:1)}static Backward(e=!1){return new m(0,0,e?1:-1)}static Right(){return new m(1,0,0)}static Left(){return new m(-1,0,0)}static Random(e=0,t=1){return new m(Te.RandomRange(e,t),Te.RandomRange(e,t),Te.RandomRange(e,t))}static TransformCoordinates(e,t){const i=m.Zero();return m.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return m.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],c=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);return r._x=a*c,r._y=l*c,r._z=h*c,r._isDirty=!0,r}static TransformNormal(e,t){const i=m.Zero();return m.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,s,r){const n=s.m;return r._x=e*n[0]+t*n[4]+i*n[8],r._y=e*n[1]+t*n[5]+i*n[9],r._z=e*n[2]+t*n[6]+i*n[10],r._isDirty=!0,r}static CatmullRom(e,t,i,s,r){const n=r*r,a=r*n,l=.5*(2*t._x+(-e._x+i._x)*r+(2*e._x-5*t._x+4*i._x-s._x)*n+(-e._x+3*t._x-3*i._x+s._x)*a),h=.5*(2*t._y+(-e._y+i._y)*r+(2*e._y-5*t._y+4*i._y-s._y)*n+(-e._y+3*t._y-3*i._y+s._y)*a),c=.5*(2*t._z+(-e._z+i._z)*r+(2*e._z-5*t._z+4*i._z-s._z)*n+(-e._z+3*t._z-3*i._z+s._z)*a);return new e.constructor(l,h,c)}static Clamp(e,t,i){const s=new e.constructor;return m.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){let r=e._x;r=r>i._x?i._x:r,r=r<t._x?t._x:r;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let a=e._z;return a=a>i._z?i._z:a,a=a<t._z?t._z:a,s.copyFromFloats(r,n,a),s}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,l=2*a-3*n+1,h=-2*a+3*n,c=a-2*n+r,u=a-n,d=e._x*l+i._x*h+t._x*c+s._x*u,f=e._y*l+i._y*h+t._y*c+s._y*u,p=e._z*l+i._z*h+t._z*c+s._z*u;return new e.constructor(d,f,p)}static Hermite1stDerivative(e,t,i,s,r){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n._x=(a-r)*6*e._x+(3*a-4*r+1)*t._x+(-a+r)*6*i._x+(3*a-2*r)*s._x,n._y=(a-r)*6*e._y+(3*a-4*r+1)*t._y+(-a+r)*6*i._y+(3*a-2*r)*s._y,n._z=(a-r)*6*e._z+(3*a-4*r+1)*t._z+(-a+r)*6*i._z+(3*a-2*r)*s._z,n._isDirty=!0,n}static Lerp(e,t,i){const s=new e.constructor(0,0,0);return m.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){return s._x=e._x+(t._x-e._x)*i,s._y=e._y+(t._y-e._y)*i,s._z=e._z+(t._z-e._z)*i,s._isDirty=!0,s}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){const i=new e.constructor;return m.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const s=e._y*t._z-e._z*t._y,r=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;return i.copyFromFloats(s,r,n),i}static Normalize(e){const t=m.Zero();return m.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,s){const r=new e.constructor;return m.ProjectToRef(e,t,i,s,r),r}static ProjectToRef(e,t,i,s,r){const n=s.width,a=s.height,l=s.x,h=s.y,c=Se.Matrix[1];L.FromValuesToRef(n/2,0,0,0,0,-a/2,0,0,0,0,.5,0,l+n/2,a/2+h,.5,1,c);const u=Se.Matrix[0];return t.multiplyToRef(i,u),u.multiplyToRef(c,u),m.TransformCoordinatesToRef(e,u,r),r}static Reflect(e,t){return this.ReflectToRef(e,t,new m)}static ReflectToRef(e,t,i){const s=D.Vector3[0];return s.copyFrom(t).scaleInPlace(2*m.Dot(e,t)),i.copyFrom(e).subtractInPlace(s)}static _UnprojectFromInvertedMatrixToRef(e,t,i){m.TransformCoordinatesToRef(e,t,i);const s=t.m,r=e._x*s[3]+e._y*s[7]+e._z*s[11]+s[15];return Te.WithinEpsilon(r,1)&&i.scaleInPlace(1/r),i}static UnprojectFromTransform(e,t,i,s,r){return this.Unproject(e,t,i,s,r,L.IdentityReadOnly)}static Unproject(e,t,i,s,r,n){const a=new e.constructor;return m.UnprojectToRef(e,t,i,s,r,n,a),a}static UnprojectToRef(e,t,i,s,r,n,a){return m.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,s,r,n,a),a}static UnprojectFloatsToRef(e,t,i,s,r,n,a,l,h){var c;const u=Se.Matrix[0];n.multiplyToRef(a,u),u.multiplyToRef(l,u),u.invert();const d=Se.Vector3[0];return d.x=e/s*2-1,d.y=-(t/r*2-1),!((c=Ze.LastCreatedEngine)===null||c===void 0)&&c.isNDCHalfZRange?d.z=i:d.z=2*i-1,m._UnprojectFromInvertedMatrixToRef(d,u,h),h}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(m.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,s=e._y-t._y,r=e._z-t._z;return i*i+s*s+r*r}static ProjectOnTriangleToRef(e,t,i,s,r){const n=Se.Vector3[0],a=Se.Vector3[1],l=Se.Vector3[2],h=Se.Vector3[3],c=Se.Vector3[4];i.subtractToRef(t,n),s.subtractToRef(t,a),s.subtractToRef(i,l);const u=n.length(),d=a.length(),f=l.length();if(u<dt||d<dt||f<dt)return r.copyFrom(t),m.Distance(e,t);e.subtractToRef(t,c),m.CrossToRef(n,a,h);const p=h.length();if(p<dt)return r.copyFrom(t),m.Distance(e,t);h.normalizeFromLength(p);let _=c.length();if(_<dt)return r.copyFrom(t),0;c.normalizeFromLength(_);const g=m.Dot(h,c),E=Se.Vector3[5],R=Se.Vector3[6];E.copyFrom(h).scaleInPlace(-_*g),R.copyFrom(e).addInPlace(E);const x=Se.Vector3[4],S=Se.Vector3[5],b=Se.Vector3[7],y=Se.Vector3[8];x.copyFrom(n).scaleInPlace(1/u),y.copyFrom(a).scaleInPlace(1/d),x.addInPlace(y).scaleInPlace(-1),S.copyFrom(n).scaleInPlace(-1/u),y.copyFrom(l).scaleInPlace(1/f),S.addInPlace(y).scaleInPlace(-1),b.copyFrom(l).scaleInPlace(-1/f),y.copyFrom(a).scaleInPlace(-1/d),b.addInPlace(y).scaleInPlace(-1);const I=Se.Vector3[9];let O;I.copyFrom(R).subtractInPlace(t),m.CrossToRef(x,I,y),O=m.Dot(y,h);const N=O;I.copyFrom(R).subtractInPlace(i),m.CrossToRef(S,I,y),O=m.Dot(y,h);const w=O;I.copyFrom(R).subtractInPlace(s),m.CrossToRef(b,I,y),O=m.Dot(y,h);const G=O,k=Se.Vector3[10];let de,ae;N>0&&w<0?(k.copyFrom(n),de=t,ae=i):w>0&&G<0?(k.copyFrom(l),de=i,ae=s):(k.copyFrom(a).scaleInPlace(-1),de=s,ae=t);const _e=Se.Vector3[9],Ce=Se.Vector3[4];if(de.subtractToRef(R,y),ae.subtractToRef(R,_e),m.CrossToRef(y,_e,Ce),!(m.Dot(Ce,h)<0))return r.copyFrom(R),Math.abs(_*g);const ze=Se.Vector3[5];m.CrossToRef(k,Ce,ze),ze.normalize();const We=Se.Vector3[9];We.copyFrom(de).subtractInPlace(R);const nt=We.length();if(nt<dt)return r.copyFrom(de),m.Distance(e,de);We.normalizeFromLength(nt);const ne=m.Dot(ze,We),Ue=Se.Vector3[7];Ue.copyFrom(R).addInPlace(ze.scaleInPlace(nt*ne)),y.copyFrom(Ue).subtractInPlace(de),_=k.length(),k.normalizeFromLength(_);let Je=m.Dot(y,k)/Math.max(_,dt);return Je=Te.Clamp(Je,0,1),Ue.copyFrom(de).addInPlace(k.scaleInPlace(Je*_)),r.copyFrom(Ue),m.Distance(e,Ue)}static Center(e,t){return m.CenterToRef(e,t,m.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const s=new e.constructor;return m.RotationFromAxisToRef(e,t,i,s),s}static RotationFromAxisToRef(e,t,i,s){const r=Se.Quaternion[0];return le.RotationQuaternionFromAxisToRef(e,t,i,r),r.toEulerAnglesToRef(s),s}}m._UpReadOnly=m.Up();m._DownReadOnly=m.Down();m._LeftHandedForwardReadOnly=m.Forward(!1);m._RightHandedForwardReadOnly=m.Forward(!0);m._LeftHandedBackwardReadOnly=m.Backward(!1);m._RightHandedBackwardReadOnly=m.Backward(!0);m._RightReadOnly=m.Right();m._LeftReadOnly=m.Left();m._ZeroReadOnly=m.Zero();m._OneReadOnly=m.One();class ut{constructor(e=0,t=0,i=0,s=0){this.x=e,this.y=t,this.z=i,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=ls(this.x),t=ls(this.y),i=ls(this.z),s=ls(this.w);let r=e;return r=r*397^t,r=r*397^i,r=r*397^s,r}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return ut.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,i,s){return new this.constructor(this.x-e,this.y-t,this.z-i,this.w-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.x=this.x-e,r.y=this.y-t,r.z=this.z-i,r.w=this.w-s,r}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=dt){return e&&Te.WithinEpsilon(this.x,e.x,t)&&Te.WithinEpsilon(this.y,e.y,t)&&Te.WithinEpsilon(this.z,e.z,t)&&Te.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,s){return this.x===e&&this.y===t&&this.z===i&&this.w===s}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,i,s){return new this.constructor(this.x*e,this.y*t,this.z*i,this.w*s)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this.x,this.y,this.z,this.w):this.scaleToRef(1/t,e)}toVector3(){return new m(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}static FromArray(e,t){return t||(t=0),new ut(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return ut.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,s,r){return r.x=e,r.y=t,r.z=i,r.w=s,r}static Zero(){return new ut(0,0,0,0)}static One(){return new ut(1,1,1,1)}static Random(e=0,t=1){return new ut(Te.RandomRange(e,t),Te.RandomRange(e,t),Te.RandomRange(e,t),Te.RandomRange(e,t))}static get ZeroReadOnly(){return ut._ZeroReadOnly}static Normalize(e){const t=ut.Zero();return ut.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){const i=new e.constructor;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){const i=new e.constructor;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(ut.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static Center(e,t){return ut.CenterToRef(e,t,ut.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=ut.Zero();return ut.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return ut.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,a=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],c=e*n[3]+t*n[7]+i*n[11]+n[15];return r.x=a,r.y=l,r.z=h,r.w=c,r}static TransformNormal(e,t){const i=new e.constructor;return ut.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+e.z*s[8],n=e.x*s[1]+e.y*s[5]+e.z*s[9],a=e.x*s[2]+e.y*s[6]+e.z*s[10];return i.x=r,i.y=n,i.z=a,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,s,r,n){const a=r.m;return n.x=e*a[0]+t*a[4]+i*a[8],n.y=e*a[1]+t*a[5]+i*a[9],n.z=e*a[2]+t*a[6]+i*a[10],n.w=s,n}static FromVector3(e,t=0){return new ut(e._x,e._y,e._z,t)}static Dot(e,t){return e.dot(t)}}ut._ZeroReadOnly=ut.Zero();class le{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,s=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=s}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=ls(this._x),t=ls(this._y),i=ls(this._z),s=ls(this._w);let r=e;return r=r*397^t,r=r*397^i,r=r*397^s,r}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=dt){return e&&Te.WithinEpsilon(this._x,e._x,t)&&Te.WithinEpsilon(this._y,e._y,t)&&Te.WithinEpsilon(this._z,e._z,t)&&Te.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._isDirty=!0,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){const t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,s=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,r=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,s,r,n),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new this.constructor(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){const e=m.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,s=this._y,r=this._w,n=s*t-i*r,a=.4999999;if(n<-a)e._y=2*Math.atan2(s,r),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(n>a)e._y=2*Math.atan2(s,r),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{const l=r*r,h=t*t,c=i*i,u=s*s;e._z=Math.atan2(2*(i*s+t*r),-h-c+u+l),e._x=Math.asin(-2*n),e._y=Math.atan2(2*(t*i+s*r),h-c-u+l),e._isDirty=!0}return e}toRotationMatrix(e){return L.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return le.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){const t=new le;return le.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],a=i[1],l=i[5],h=i[9],c=i[2],u=i[6],d=i[10],f=s+l+d;let p;return f>0?(p=.5/Math.sqrt(f+1),t._w=.25/p,t._x=(u-h)*p,t._y=(n-c)*p,t._z=(a-r)*p,t._isDirty=!0):s>l&&s>d?(p=2*Math.sqrt(1+s-l-d),t._w=(u-h)/p,t._x=.25*p,t._y=(r+a)/p,t._z=(n+c)/p,t._isDirty=!0):l>d?(p=2*Math.sqrt(1+l-s-d),t._w=(n-c)/p,t._x=(r+a)/p,t._y=.25*p,t._z=(h+u)/p,t._isDirty=!0):(p=2*Math.sqrt(1+d-s-l),t._w=(a-r)/p,t._x=(n+c)/p,t._y=(h+u)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const s=le.Dot(e,t);return 1-s*s<=i}static SmoothToRef(e,t,i,s,r){let n=s===0?1:i/s;return n=Te.Clamp(n,0,1),le.SlerpToRef(e,t,n,r),r}static Zero(){return new le(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new le(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return le.RotationAxisToRef(e,t,new le)}static RotationAxisToRef(e,t,i){const s=Math.sin(t/2);return e.normalize(),i._w=Math.cos(t/2),i._x=e._x*s,i._y=e._y*s,i._z=e._z*s,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new le(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromEulerAngles(e,t,i){const s=new le;return le.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerAnglesToRef(e,t,i,s){return le.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerVector(e){const t=new le;return le.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return le.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,s=dt){const r=m.Dot(e,t)+1;return r<s?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(m.CrossToRef(e,t,D.Vector3[0]),i.set(D.Vector3[0].x,D.Vector3[0].y,D.Vector3[0].z,r)),i.normalize()}static RotationYawPitchRoll(e,t,i){const s=new le;return le.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){const r=i*.5,n=t*.5,a=e*.5,l=Math.sin(r),h=Math.cos(r),c=Math.sin(n),u=Math.cos(n),d=Math.sin(a),f=Math.cos(a);return s._x=f*c*h+d*u*l,s._y=d*u*h-f*c*l,s._z=f*u*l-d*c*h,s._w=f*u*h+d*c*l,s._isDirty=!0,s}static RotationAlphaBetaGamma(e,t,i){const s=new le;return le.RotationAlphaBetaGammaToRef(e,t,i,s),s}static RotationAlphaBetaGammaToRef(e,t,i,s){const r=(i+e)*.5,n=(i-e)*.5,a=t*.5;return s._x=Math.cos(n)*Math.sin(a),s._y=Math.sin(n)*Math.sin(a),s._z=Math.sin(r)*Math.cos(a),s._w=Math.cos(r)*Math.cos(a),s._isDirty=!0,s}static RotationQuaternionFromAxis(e,t,i){const s=new le(0,0,0,0);return le.RotationQuaternionFromAxisToRef(e,t,i,s),s}static RotationQuaternionFromAxisToRef(e,t,i,s){const r=Se.Matrix[0];return L.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),r),le.FromRotationMatrixToRef(r,s),s}static FromLookDirectionLH(e,t){const i=new le;return le.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const s=Se.Matrix[0];return L.LookDirectionLHToRef(e,t,s),le.FromRotationMatrixToRef(s,i),i}static FromLookDirectionRH(e,t){const i=new le;return le.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const s=Se.Matrix[0];return L.LookDirectionRHToRef(e,t,s),le.FromRotationMatrixToRef(s,i)}static Slerp(e,t,i){const s=le.Identity();return le.SlerpToRef(e,t,i,s),s}static SlerpToRef(e,t,i,s){let r,n,a=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(a<0&&(l=!0,a=-a),a>.999999)n=1-i,r=l?-i:i;else{const h=Math.acos(a),c=1/Math.sin(h);n=Math.sin((1-i)*h)*c,r=l?-Math.sin(i*h)*c:Math.sin(i*h)*c}return s._x=n*e._x+r*t._x,s._y=n*e._y+r*t._y,s._z=n*e._z+r*t._z,s._w=n*e._w+r*t._w,s._isDirty=!0,s}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,l=2*a-3*n+1,h=-2*a+3*n,c=a-2*n+r,u=a-n,d=e._x*l+i._x*h+t._x*c+s._x*u,f=e._y*l+i._y*h+t._y*c+s._y*u,p=e._z*l+i._z*h+t._z*c+s._z*u,_=e._w*l+i._w*h+t._w*c+s._w*u;return new e.constructor(d,f,p,_)}static Hermite1stDerivative(e,t,i,s,r){const n=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;return n._x=(a-r)*6*e._x+(3*a-4*r+1)*t._x+(-a+r)*6*i._x+(3*a-2*r)*s._x,n._y=(a-r)*6*e._y+(3*a-4*r+1)*t._y+(-a+r)*6*i._y+(3*a-2*r)*s._y,n._z=(a-r)*6*e._z+(3*a-4*r+1)*t._z+(-a+r)*6*i._z+(3*a-2*r)*s._z,n._w=(a-r)*6*e._w+(3*a-4*r+1)*t._w+(-a+r)*6*i._w+(3*a-2*r)*s._w,n._isDirty=!0,n}static Normalize(e){const t=le.Zero();return le.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}}class L{static get Use64Bits(){return Ri.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=L._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,s=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:s}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,Ri.MatrixTrackPrecisionChange&&Ri.MatrixTrackedMatrices.push(this),this._m=new Ri.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],f=e[11],p=e[12],_=e[13],g=e[14],E=e[15],R=d*E-g*f,x=u*E-_*f,S=u*g-_*d,b=c*E-p*f,y=c*g-d*p,I=c*_-p*u,O=+(a*R-l*x+h*S),N=-(n*R-l*b+h*y),w=+(n*x-a*b+h*I),G=-(n*S-a*y+l*I);return t*O+i*N+s*w+r*G}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}
${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}
${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}
${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return L.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,s=t._m,r=e.m;for(let n=0;n<16;n++)s[n]=i[n]+r[n];return t.markAsUpdated(),t}addToSelf(e){const t=this._m,i=e.m;for(let s=0;s<16;s++)t[s]+=i[s];return this.markAsUpdated(),this}invertToRef(e){if(this._isIdentity===!0)return L.IdentityToRef(e),e;const t=this._m,i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],l=t[5],h=t[6],c=t[7],u=t[8],d=t[9],f=t[10],p=t[11],_=t[12],g=t[13],E=t[14],R=t[15],x=f*R-E*p,S=d*R-g*p,b=d*E-g*f,y=u*R-_*p,I=u*E-f*_,O=u*g-_*d,N=+(l*x-h*S+c*b),w=-(a*x-h*y+c*I),G=+(a*S-l*y+c*O),k=-(a*b-l*I+h*O),de=i*N+s*w+r*G+n*k;if(de===0)return e.copyFrom(this),e;const ae=1/de,_e=h*R-E*c,Ce=l*R-g*c,ce=l*E-g*h,ze=a*R-_*c,We=a*E-_*h,nt=a*g-_*l,ne=h*p-f*c,Ue=l*p-d*c,Je=l*f-d*h,St=a*p-u*c,yt=a*f-u*h,tt=a*d-u*l,he=-(s*x-r*S+n*b),Ne=+(i*x-r*y+n*I),Qe=-(i*S-s*y+n*O),Me=+(i*b-s*I+r*O),at=+(s*_e-r*Ce+n*ce),zt=-(i*_e-r*ze+n*We),Ht=+(i*Ce-s*ze+n*nt),ti=-(i*ce-s*We+r*nt),Ci=-(s*ne-r*Ue+n*Je),ui=+(i*ne-r*St+n*yt),_s=-(i*Ue-s*St+n*tt),Zi=+(i*Je-s*yt+r*tt);return L.FromValuesToRef(N*ae,he*ae,at*ae,Ci*ae,w*ae,Ne*ae,zt*ae,ui*ae,G*ae,Qe*ae,Ht*ae,_s*ae,k*ae,Me*ae,ti*ae,Zi*ae,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new m(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){const e=this.m;return L.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}multiply(e){const t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){const s=this._m,r=e.m,n=s[0],a=s[1],l=s[2],h=s[3],c=s[4],u=s[5],d=s[6],f=s[7],p=s[8],_=s[9],g=s[10],E=s[11],R=s[12],x=s[13],S=s[14],b=s[15],y=r[0],I=r[1],O=r[2],N=r[3],w=r[4],G=r[5],k=r[6],de=r[7],ae=r[8],_e=r[9],Ce=r[10],ce=r[11],ze=r[12],We=r[13],nt=r[14],ne=r[15];return t[i]=n*y+a*w+l*ae+h*ze,t[i+1]=n*I+a*G+l*_e+h*We,t[i+2]=n*O+a*k+l*Ce+h*nt,t[i+3]=n*N+a*de+l*ce+h*ne,t[i+4]=c*y+u*w+d*ae+f*ze,t[i+5]=c*I+u*G+d*_e+f*We,t[i+6]=c*O+u*k+d*Ce+f*nt,t[i+7]=c*N+u*de+d*ce+f*ne,t[i+8]=p*y+_*w+g*ae+E*ze,t[i+9]=p*I+_*G+g*_e+E*We,t[i+10]=p*O+_*k+g*Ce+E*nt,t[i+11]=p*N+_*de+g*ce+E*ne,t[i+12]=R*y+x*w+S*ae+b*ze,t[i+13]=R*I+x*G+S*_e+b*We,t[i+14]=R*O+x*k+S*Ce+b*nt,t[i+15]=R*N+x*de+S*ce+b*ne,this}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,s=t.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}clone(){const e=new this.constructor;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=ls(this._m[0]);for(let t=1;t<16;t++)e=e*397^ls(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new le,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,s,r=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const n=this._m;if(i&&i.copyFromFloats(n[12],n[13],n[14]),e=e||Se.Vector3[0],e.x=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),e.y=Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),e.z=Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]),s){const a=(r?s.absoluteScaling.x:s.scaling.x)<0?-1:1,l=(r?s.absoluteScaling.y:s.scaling.y)<0?-1:1,h=(r?s.absoluteScaling.z:s.scaling.z)<0?-1:1;e.x*=a,e.y*=l,e.z*=h}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const a=1/e._x,l=1/e._y,h=1/e._z;L.FromValuesToRef(n[0]*a,n[1]*a,n[2]*a,0,n[4]*l,n[5]*l,n[6]*l,0,n[8]*h,n[9]*h,n[10]*h,0,0,0,0,1,Se.Matrix[0]),le.FromRotationMatrixToRef(Se.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=e*4;return new ut(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){const i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){const e=new this.constructor;return L.TransposeToRef(this,e),e}transposeToRef(e){return L.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,s,r){if(e<0||e>3)return this;const n=e*4;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=s,this._m[n+3]=r,this.markAsUpdated(),this}scale(e){const t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}toNormalMatrix(e){const t=Se.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;return L.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){const e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=Se.Vector3[0];if(!this.decompose(t))return L.IdentityToRef(e),e;const i=this._m,s=1/t._x,r=1/t._y,n=1/t._z;return L.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*r,i[5]*r,i[6]*r,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){const e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){const e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){const i=new L;return L.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let s=0;s<16;s++)i._m[s]=e[s+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,s){for(let r=0;r<16;r++)s._m[r]=e[r+t]*i;return s.markAsUpdated(),s}static get IdentityReadOnly(){return L._IdentityReadOnly}static FromValuesToRef(e,t,i,s,r,n,a,l,h,c,u,d,f,p,_,g,E){const R=E._m;R[0]=e,R[1]=t,R[2]=i,R[3]=s,R[4]=r,R[5]=n,R[6]=a,R[7]=l,R[8]=h,R[9]=c,R[10]=u,R[11]=d,R[12]=f,R[13]=p,R[14]=_,R[15]=g,E.markAsUpdated()}static FromValues(e,t,i,s,r,n,a,l,h,c,u,d,f,p,_,g){const E=new L,R=E._m;return R[0]=e,R[1]=t,R[2]=i,R[3]=s,R[4]=r,R[5]=n,R[6]=a,R[7]=l,R[8]=h,R[9]=c,R[10]=u,R[11]=d,R[12]=f,R[13]=p,R[14]=_,R[15]=g,E.markAsUpdated(),E}static Compose(e,t,i){const s=new L;return L.ComposeToRef(e,t,i,s),s}static ComposeToRef(e,t,i,s){const r=s._m,n=t._x,a=t._y,l=t._z,h=t._w,c=n+n,u=a+a,d=l+l,f=n*c,p=n*u,_=n*d,g=a*u,E=a*d,R=l*d,x=h*c,S=h*u,b=h*d,y=e._x,I=e._y,O=e._z;return r[0]=(1-(g+R))*y,r[1]=(p+b)*y,r[2]=(_-S)*y,r[3]=0,r[4]=(p-b)*I,r[5]=(1-(f+R))*I,r[6]=(E+x)*I,r[7]=0,r[8]=(_+S)*O,r[9]=(E-x)*O,r[10]=(1-(f+g))*O,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,s.markAsUpdated(),s}static Identity(){const e=L.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return L.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){const e=L.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new L;return L.RotationXToRef(e,t),t}static Invert(e){const t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return L.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,t),t._updateIdentityStatus(s===1&&i===0),t}static RotationY(e){const t=new L;return L.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return L.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,t),t._updateIdentityStatus(s===1&&i===0),t}static RotationZ(e){const t=new L;return L.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),s=Math.cos(e);return L.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(s===1&&i===0),t}static RotationAxis(e,t){const i=new L;return L.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const s=Math.sin(-t),r=Math.cos(-t),n=1-r;e.normalize();const a=i._m;return a[0]=e._x*e._x*n+r,a[1]=e._x*e._y*n-e._z*s,a[2]=e._x*e._z*n+e._y*s,a[3]=0,a[4]=e._y*e._x*n+e._z*s,a[5]=e._y*e._y*n+r,a[6]=e._y*e._z*n-e._x*s,a[7]=0,a[8]=e._z*e._x*n-e._y*s,a[9]=e._z*e._y*n+e._x*s,a[10]=e._z*e._z*n+r,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,s=!1){const r=m.Dot(t,e),n=i._m;if(r<-1+dt)n[0]=-1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=s?1:-1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=s?-1:1,n[11]=0;else{const a=m.Cross(t,e),l=1/(1+r);n[0]=a._x*a._x*l+r,n[1]=a._y*a._x*l-a._z,n[2]=a._z*a._x*l+a._y,n[3]=0,n[4]=a._x*a._y*l+a._z,n[5]=a._y*a._y*l+r,n[6]=a._z*a._y*l-a._x,n[7]=0,n[8]=a._x*a._z*l-a._y,n[9]=a._y*a._z*l+a._x,n[10]=a._z*a._z*l+r,n[11]=0}return n[12]=0,n[13]=0,n[14]=0,n[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){const s=new L;return L.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){return le.RotationYawPitchRollToRef(e,t,i,Se.Quaternion[0]),Se.Quaternion[0].toRotationMatrix(s),s}static Scaling(e,t,i){const s=new L;return L.ScalingToRef(e,t,i,s),s}static ScalingToRef(e,t,i,s){return L.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(e===1&&t===1&&i===1),s}static Translation(e,t,i){const s=new L;return L.TranslationToRef(e,t,i,s),s}static TranslationToRef(e,t,i,s){return L.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,s),s._updateIdentityStatus(e===0&&t===0&&i===0),s}static Lerp(e,t,i){const s=new e.constructor;return L.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){const r=s._m,n=e.m,a=t.m;for(let l=0;l<16;l++)r[l]=n[l]*(1-i)+a[l]*i;return s.markAsUpdated(),s}static DecomposeLerp(e,t,i){const s=new e.constructor;return L.DecomposeLerpToRef(e,t,i,s),s}static DecomposeLerpToRef(e,t,i,s){const r=Se.Vector3[0],n=Se.Quaternion[0],a=Se.Vector3[1];e.decompose(r,n,a);const l=Se.Vector3[2],h=Se.Quaternion[1],c=Se.Vector3[3];t.decompose(l,h,c);const u=Se.Vector3[4];m.LerpToRef(r,l,i,u);const d=Se.Quaternion[2];le.SlerpToRef(n,h,i,d);const f=Se.Vector3[5];return m.LerpToRef(a,c,i,f),L.ComposeToRef(u,d,f,s),s}static LookAtLH(e,t,i){const s=new L;return L.LookAtLHToRef(e,t,i,s),s}static LookAtLHToRef(e,t,i,s){const r=Se.Vector3[0],n=Se.Vector3[1],a=Se.Vector3[2];t.subtractToRef(e,a),a.normalize(),m.CrossToRef(i,a,r);const l=r.lengthSquared();l===0?r.x=1:r.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(a,r,n),n.normalize();const h=-m.Dot(r,e),c=-m.Dot(n,e),u=-m.Dot(a,e);return L.FromValuesToRef(r._x,n._x,a._x,0,r._y,n._y,a._y,0,r._z,n._z,a._z,0,h,c,u,1,s),s}static LookAtRH(e,t,i){const s=new L;return L.LookAtRHToRef(e,t,i,s),s}static LookAtRHToRef(e,t,i,s){const r=Se.Vector3[0],n=Se.Vector3[1],a=Se.Vector3[2];e.subtractToRef(t,a),a.normalize(),m.CrossToRef(i,a,r);const l=r.lengthSquared();l===0?r.x=1:r.normalizeFromLength(Math.sqrt(l)),m.CrossToRef(a,r,n),n.normalize();const h=-m.Dot(r,e),c=-m.Dot(n,e),u=-m.Dot(a,e);return L.FromValuesToRef(r._x,n._x,a._x,0,r._y,n._y,a._y,0,r._z,n._z,a._z,0,h,c,u,1,s),s}static LookDirectionLH(e,t){const i=new L;return L.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const s=Se.Vector3[0];s.copyFrom(e),s.scaleInPlace(-1);const r=Se.Vector3[1];return m.CrossToRef(t,s,r),L.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,s._x,s._y,s._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){const i=new L;return L.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const s=Se.Vector3[2];return m.CrossToRef(t,e,s),L.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,s,r){const n=new L;return L.OrthoLHToRef(e,t,i,s,n,r),n}static OrthoLHToRef(e,t,i,s,r,n){const a=i,l=s,h=2/e,c=2/t,u=2/(l-a),d=-(l+a)/(l-a);return L.FromValuesToRef(h,0,0,0,0,c,0,0,0,0,u,0,0,0,d,1,r),n&&r.multiplyToRef(Hn,r),r._updateIdentityStatus(h===1&&c===1&&u===1&&d===0),r}static OrthoOffCenterLH(e,t,i,s,r,n,a){const l=new L;return L.OrthoOffCenterLHToRef(e,t,i,s,r,n,l,a),l}static OrthoOffCenterLHToRef(e,t,i,s,r,n,a,l){const h=r,c=n,u=2/(t-e),d=2/(s-i),f=2/(c-h),p=-(c+h)/(c-h),_=(e+t)/(e-t),g=(s+i)/(i-s);return L.FromValuesToRef(u,0,0,0,0,d,0,0,0,0,f,0,_,g,p,1,a),l&&a.multiplyToRef(Hn,a),a.markAsUpdated(),a}static ObliqueOffCenterLHToRef(e,t,i,s,r,n,a,l,h,c,u){const d=-a*Math.cos(l),f=-a*Math.sin(l);return L.TranslationToRef(0,0,-h,Se.Matrix[1]),L.FromValuesToRef(1,0,0,0,0,1,0,0,d,f,1,0,0,0,0,1,Se.Matrix[0]),Se.Matrix[1].multiplyToRef(Se.Matrix[0],Se.Matrix[0]),L.TranslationToRef(0,0,h,Se.Matrix[1]),Se.Matrix[0].multiplyToRef(Se.Matrix[1],Se.Matrix[0]),L.OrthoOffCenterLHToRef(e,t,i,s,r,n,c,u),Se.Matrix[0].multiplyToRef(c,c),c}static OrthoOffCenterRH(e,t,i,s,r,n,a){const l=new L;return L.OrthoOffCenterRHToRef(e,t,i,s,r,n,l,a),l}static OrthoOffCenterRHToRef(e,t,i,s,r,n,a,l){return L.OrthoOffCenterLHToRef(e,t,i,s,r,n,a,l),a._m[10]*=-1,a}static ObliqueOffCenterRHToRef(e,t,i,s,r,n,a,l,h,c,u){const d=a*Math.cos(l),f=a*Math.sin(l);return L.TranslationToRef(0,0,h,Se.Matrix[1]),L.FromValuesToRef(1,0,0,0,0,1,0,0,d,f,1,0,0,0,0,1,Se.Matrix[0]),Se.Matrix[1].multiplyToRef(Se.Matrix[0],Se.Matrix[0]),L.TranslationToRef(0,0,-h,Se.Matrix[1]),Se.Matrix[0].multiplyToRef(Se.Matrix[1],Se.Matrix[0]),L.OrthoOffCenterRHToRef(e,t,i,s,r,n,c,u),Se.Matrix[0].multiplyToRef(c,c),c}static PerspectiveLH(e,t,i,s,r,n=0){const a=new L,l=i,h=s,c=2*l/e,u=2*l/t,d=(h+l)/(h-l),f=-2*h*l/(h-l),p=Math.tan(n);return L.FromValuesToRef(c,0,0,0,0,u,0,p,0,0,d,1,0,0,f,0,a),r&&a.multiplyToRef(Hn,a),a._updateIdentityStatus(!1),a}static PerspectiveFovLH(e,t,i,s,r,n=0,a=!1){const l=new L;return L.PerspectiveFovLHToRef(e,t,i,s,l,!0,r,n,a),l}static PerspectiveFovLHToRef(e,t,i,s,r,n=!0,a,l=0,h=!1){const c=i,u=s,d=1/Math.tan(e*.5),f=n?d/t:d,p=n?d:d*t,_=h&&c===0?-1:u!==0?(u+c)/(u-c):1,g=h&&c===0?2*u:u!==0?-2*u*c/(u-c):-2*c,E=Math.tan(l);return L.FromValuesToRef(f,0,0,0,0,p,0,E,0,0,_,1,0,0,g,0,r),a&&r.multiplyToRef(Hn,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseLHToRef(e,t,i,s,r,n=!0,a,l=0){const h=1/Math.tan(e*.5),c=n?h/t:h,u=n?h:h*t,d=Math.tan(l);return L.FromValuesToRef(c,0,0,0,0,u,0,d,0,0,-i,1,0,0,1,0,r),a&&r.multiplyToRef(Hn,r),r._updateIdentityStatus(!1),r}static PerspectiveFovRH(e,t,i,s,r,n=0,a=!1){const l=new L;return L.PerspectiveFovRHToRef(e,t,i,s,l,!0,r,n,a),l}static PerspectiveFovRHToRef(e,t,i,s,r,n=!0,a,l=0,h=!1){const c=i,u=s,d=1/Math.tan(e*.5),f=n?d/t:d,p=n?d:d*t,_=h&&c===0?1:u!==0?-(u+c)/(u-c):-1,g=h&&c===0?2*u:u!==0?-2*u*c/(u-c):-2*c,E=Math.tan(l);return L.FromValuesToRef(f,0,0,0,0,p,0,E,0,0,_,-1,0,0,g,0,r),a&&r.multiplyToRef(Hn,r),r._updateIdentityStatus(!1),r}static PerspectiveFovReverseRHToRef(e,t,i,s,r,n=!0,a,l=0){const h=1/Math.tan(e*.5),c=n?h/t:h,u=n?h:h*t,d=Math.tan(l);return L.FromValuesToRef(c,0,0,0,0,u,0,d,0,0,-i,-1,0,0,-1,0,r),a&&r.multiplyToRef(Hn,r),r._updateIdentityStatus(!1),r}static GetFinalMatrix(e,t,i,s,r,n){const a=e.width,l=e.height,h=e.x,c=e.y,u=L.FromValues(a/2,0,0,0,0,-l/2,0,0,0,0,n-r,0,h+a/2,l/2+c,r,1),d=new t.constructor;return t.multiplyToRef(i,d),d.multiplyToRef(s,d),d.multiplyToRef(u,d)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return Ri.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return Ri.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new e.constructor;return L.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],a=i[12],l=i[1],h=i[5],c=i[9],u=i[13],d=i[2],f=i[6],p=i[10],_=i[14],g=i[3],E=i[7],R=i[11],x=i[15],S=t._m;return S[0]=s,S[1]=r,S[2]=n,S[3]=a,S[4]=l,S[5]=h,S[6]=c,S[7]=u,S[8]=d,S[9]=f,S[10]=p,S[11]=_,S[12]=g,S[13]=E,S[14]=R,S[15]=x,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){const t=new L;return L.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,s=e.normal.y,r=e.normal.z,n=-2*i,a=-2*s,l=-2*r;return L.FromValuesToRef(n*i+1,a*i,l*i,0,n*s,a*s+1,l*s,0,n*r,a*r,l*r+1,0,n*e.d,a*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,s){return L.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,s),s}static FromQuaternionToRef(e,t){const i=e._x*e._x,s=e._y*e._y,r=e._z*e._z,n=e._x*e._y,a=e._z*e._w,l=e._z*e._x,h=e._y*e._w,c=e._y*e._z,u=e._x*e._w;return t._m[0]=1-2*(s+r),t._m[1]=2*(n+a),t._m[2]=2*(l-h),t._m[3]=0,t._m[4]=2*(n-a),t._m[5]=1-2*(r+i),t._m[6]=2*(c+u),t._m[7]=0,t._m[8]=2*(l+h),t._m[9]=2*(c-u),t._m[10]=1-2*(s+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}}L._UpdateFlagSeed=0;L._IdentityReadOnly=L.Identity();class Se{}Se.Vector3=yi.BuildTuple(11,m.Zero);Se.Matrix=yi.BuildTuple(2,L.Identity);Se.Quaternion=yi.BuildTuple(3,le.Zero);class D{}D.Vector2=yi.BuildTuple(3,Ke.Zero);D.Vector3=yi.BuildTuple(13,m.Zero);D.Vector4=yi.BuildTuple(3,ut.Zero);D.Quaternion=yi.BuildTuple(2,le.Zero);D.Matrix=yi.BuildTuple(8,L.Identity);Re("BABYLON.Vector2",Ke);Re("BABYLON.Vector3",m);Re("BABYLON.Vector4",ut);Re("BABYLON.Matrix",L);const Hn=L.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);var ft;(function(o){o[o.LOCAL=0]="LOCAL",o[o.WORLD=1]="WORLD",o[o.BONE=2]="BONE"})(ft||(ft={}));class En{}En.X=new m(1,0,0);En.Y=new m(0,1,0);En.Z=new m(0,0,1);var Kn;(function(o){o[o.X=0]="X",o[o.Y=1]="Y",o[o.Z=2]="Z"})(Kn||(Kn={}));function Ha(o){return Math.pow(o,Cc)}function Wa(o){return o<=.04045?.0773993808*o:Math.pow(.947867299*(o+.055),2.4)}function Xa(o){return Math.pow(o,LR)}function Ya(o){return o<=.0031308?12.92*o:1.055*Math.pow(o,.41666)-.055}class J{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return J.FromArrayToRef(e,t,this),this}toColor4(e=1){return new He(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new J(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new J(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=Te.Clamp(this.r,e,t),i.g=Te.Clamp(this.g,e,t),i.b=Te.Clamp(this.b,e,t),this}add(e){return new J(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new J(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new J(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+Te.ToHex(e)+Te.ToHex(t)+Te.ToHex(i)}toHSV(){const e=new J;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,r=Math.max(t,i,s),n=Math.min(t,i,s);let a=0,l=0;const h=r,c=r-n;r!==0&&(l=c/r),r!=n&&(r==t?(a=(i-s)/c,i<s&&(a+=6)):r==i?a=(s-t)/c+2:r==s&&(a=(t-i)/c+4),a*=60),e.r=a,e.g=l,e.b=h}toLinearSpace(e=!1){const t=new J;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Wa(this.r),e.g=Wa(this.g),e.b=Wa(this.b)):(e.r=Ha(this.r),e.g=Ha(this.g),e.b=Ha(this.b)),this}toGammaSpace(e=!1){const t=new J;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Ya(this.r),e.g=Ya(this.g),e.b=Ya(this.b)):(e.r=Xa(this.r),e.g=Xa(this.g),e.b=Xa(this.b)),this}static HSVtoRGBToRef(e,t,i,s){const r=i*t,n=e/60,a=r*(1-Math.abs(n%2-1));let l=0,h=0,c=0;n>=0&&n<=1?(l=r,h=a):n>=1&&n<=2?(l=a,h=r):n>=2&&n<=3?(h=r,c=a):n>=3&&n<=4?(h=a,c=r):n>=4&&n<=5?(l=a,c=r):n>=5&&n<=6&&(l=r,c=a);const u=i-r;s.set(l+u,h+u,c+u)}static FromHSV(e,t,i){const s=new J(0,0,0);return J.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==7)return new J(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16);return J.FromInts(t,i,s)}static FromArray(e,t=0){return new J(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new J(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new J(0,0,0);return J.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,l=2*a-3*n+1,h=-2*a+3*n,c=a-2*n+r,u=a-n,d=e.r*l+i.r*h+t.r*c+s.r*u,f=e.g*l+i.g*h+t.g*c+s.g*u,p=e.b*l+i.b*h+t.b*c+s.b*u;return new J(d,f,p)}static Hermite1stDerivative(e,t,i,s,r){const n=J.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;n.r=(a-r)*6*e.r+(3*a-4*r+1)*t.r+(-a+r)*6*i.r+(3*a-2*r)*s.r,n.g=(a-r)*6*e.g+(3*a-4*r+1)*t.g+(-a+r)*6*i.g+(3*a-2*r)*s.g,n.b=(a-r)*6*e.b+(3*a-4*r+1)*t.b+(-a+r)*6*i.b+(3*a-2*r)*s.b}static Red(){return new J(1,0,0)}static Green(){return new J(0,1,0)}static Blue(){return new J(0,0,1)}static Black(){return new J(0,0,0)}static get BlackReadOnly(){return J._BlackReadOnly}static White(){return new J(1,1,1)}static Purple(){return new J(.5,0,.5)}static Magenta(){return new J(1,0,1)}static Yellow(){return new J(1,1,0)}static Gray(){return new J(.5,.5,.5)}static Teal(){return new J(0,1,1)}static Random(){return new J(Math.random(),Math.random(),Math.random())}}J._BlackReadOnly=J.Black();class He{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return He.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new He(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new He(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new He(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=Te.Clamp(this.r,e,t),i.g=Te.Clamp(this.g,e,t),i.b=Te.Clamp(this.b,e,t),i.a=Te.Clamp(this.a,e,t),this}multiply(e){return new He(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new He(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),s=Math.round(this.b*255);if(e)return"#"+Te.ToHex(t)+Te.ToHex(i)+Te.ToHex(s);const r=Math.round(this.a*255);return"#"+Te.ToHex(t)+Te.ToHex(i)+Te.ToHex(s)+Te.ToHex(r)}toLinearSpace(e=!1){const t=new He;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=Wa(this.r),e.g=Wa(this.g),e.b=Wa(this.b)):(e.r=Ha(this.r),e.g=Ha(this.g),e.b=Ha(this.b)),e.a=this.a,this}toGammaSpace(e=!1){const t=new He;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Ya(this.r),e.g=Ya(this.g),e.b=Ya(this.b)):(e.r=Xa(this.r),e.g=Xa(this.g),e.b=Xa(this.b)),e.a=this.a,this}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new He(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16),r=e.length===9?parseInt(e.substring(7,9),16):255;return He.FromInts(t,i,s,r)}static Lerp(e,t,i){const s=new He(0,0,0,0);return He.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,s,r){const n=r*r,a=r*n,l=2*a-3*n+1,h=-2*a+3*n,c=a-2*n+r,u=a-n,d=e.r*l+i.r*h+t.r*c+s.r*u,f=e.g*l+i.g*h+t.g*c+s.g*u,p=e.b*l+i.b*h+t.b*c+s.b*u,_=e.a*l+i.a*h+t.a*c+s.a*u;return new He(d,f,p,_)}static Hermite1stDerivative(e,t,i,s,r){const n=new He;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const a=r*r;n.r=(a-r)*6*e.r+(3*a-4*r+1)*t.r+(-a+r)*6*i.r+(3*a-2*r)*s.r,n.g=(a-r)*6*e.g+(3*a-4*r+1)*t.g+(-a+r)*6*i.g+(3*a-2*r)*s.g,n.b=(a-r)*6*e.b+(3*a-4*r+1)*t.b+(-a+r)*6*i.b+(3*a-2*r)*s.b,n.a=(a-r)*6*e.a+(3*a-4*r+1)*t.a+(-a+r)*6*i.a+(3*a-2*r)*s.a}static FromColor3(e,t=1){return new He(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new He(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,s){return new He(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let s=0;s<e.length;s+=3){const r=s/3*4;i[r]=e[s],i[r+1]=e[s+1],i[r+2]=e[s+2],i[r+3]=1}return i}return e}}class Zs{}Zs.Color3=yi.BuildArray(3,J.Black);Zs.Color4=yi.BuildArray(3,()=>new He(0,0,0,0));Re("BABYLON.Color3",J);Re("BABYLON.Color4",He);class Us{constructor(e,t,i,s){this.normal=new m(e,t,i),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Us(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Us._TmpMatrix;e.invertToRef(t);const i=t.m,s=this.normal.x,r=this.normal.y,n=this.normal.z,a=this.d,l=s*i[0]+r*i[1]+n*i[2]+a*i[3],h=s*i[4]+r*i[5]+n*i[6]+a*i[7],c=s*i[8]+r*i[9]+n*i[10]+a*i[11],u=s*i[12]+r*i[13]+n*i[14]+a*i[15];return new Us(l,h,c,u)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const s=t.x-e.x,r=t.y-e.y,n=t.z-e.z,a=i.x-e.x,l=i.y-e.y,h=i.z-e.z,c=r*h-n*l,u=n*a-s*h,d=s*l-r*a,f=Math.sqrt(c*c+u*u+d*d);let p;return f!==0?p=1/f:p=0,this.normal.x=c*p,this.normal.y=u*p,this.normal.z=d*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return m.Dot(this.normal,e)<=t}signedDistanceTo(e){return m.Dot(e,this.normal)+this.d}static FromArray(e){return new Us(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const s=new Us(0,0,0,0);return s.copyFromPoints(e,t,i),s}static FromPositionAndNormal(e,t){const i=new Us(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const s=-(t.x*e.x+t.y*e.y+t.z*e.z);return m.Dot(i,t)+s}}Us._TmpMatrix=L.Identity();class Bs{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new Us(0,0,0,0));return Bs.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){Bs.GetNearPlaneToRef(e,t[0]),Bs.GetFarPlaneToRef(e,t[1]),Bs.GetLeftPlaneToRef(e,t[2]),Bs.GetRightPlaneToRef(e,t[3]),Bs.GetTopPlaneToRef(e,t[4]),Bs.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}var Ip;(function(o){o[o.CW=0]="CW",o[o.CCW=1]="CCW"})(Ip||(Ip={}));class xs{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new xs(this.width*e,this.height*t)}clone(){return new xs(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new xs(0,0)}add(e){return new xs(this.width+e.width,this.height+e.height)}subtract(e){return new xs(this.width-e.width,this.height-e.height)}scale(e){return new xs(this.width*e,this.height*e)}static Lerp(e,t,i){const s=e.width+(t.width-e.width)*i,r=e.height+(t.height-e.height)*i;return new xs(s,r)}}class Za{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}toGlobal(e,t){return new Za(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Za(this.x,this.y,this.width,this.height)}}const lr=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],kR=[()=>1,o=>o.y,o=>o.z,o=>o.x,o=>o.x*o.y,o=>o.y*o.z,o=>3*o.z*o.z-1,o=>o.x*o.z,o=>o.x*o.x-o.y*o.y],Pr=(o,e)=>lr[o]*kR[o](e),Dr=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class Qa{constructor(){this.preScaled=!1,this.l00=m.Zero(),this.l1_1=m.Zero(),this.l10=m.Zero(),this.l11=m.Zero(),this.l2_2=m.Zero(),this.l2_1=m.Zero(),this.l20=m.Zero(),this.l21=m.Zero(),this.l22=m.Zero()}addLight(e,t,i){D.Vector3[0].set(t.r,t.g,t.b);const s=D.Vector3[0],r=D.Vector3[1];s.scaleToRef(i,r),r.scaleToRef(Pr(0,e),D.Vector3[2]),this.l00.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(1,e),D.Vector3[2]),this.l1_1.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(2,e),D.Vector3[2]),this.l10.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(3,e),D.Vector3[2]),this.l11.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(4,e),D.Vector3[2]),this.l2_2.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(5,e),D.Vector3[2]),this.l2_1.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(6,e),D.Vector3[2]),this.l20.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(7,e),D.Vector3[2]),this.l21.addInPlace(D.Vector3[2]),r.scaleToRef(Pr(8,e),D.Vector3[2]),this.l22.addInPlace(D.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(Dr[0]),this.l1_1.scaleInPlace(Dr[1]),this.l10.scaleInPlace(Dr[2]),this.l11.scaleInPlace(Dr[3]),this.l2_2.scaleInPlace(Dr[4]),this.l2_1.scaleInPlace(Dr[5]),this.l20.scaleInPlace(Dr[6]),this.l21.scaleInPlace(Dr[7]),this.l22.scaleInPlace(Dr[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(lr[0]),this.l1_1.scaleInPlace(lr[1]),this.l10.scaleInPlace(lr[2]),this.l11.scaleInPlace(lr[3]),this.l2_2.scaleInPlace(lr[4]),this.l2_1.scaleInPlace(lr[5]),this.l20.scaleInPlace(lr[6]),this.l21.scaleInPlace(lr[7]),this.l22.scaleInPlace(lr[8])}updateFromArray(e){return m.FromArrayToRef(e[0],0,this.l00),m.FromArrayToRef(e[1],0,this.l1_1),m.FromArrayToRef(e[2],0,this.l10),m.FromArrayToRef(e[3],0,this.l11),m.FromArrayToRef(e[4],0,this.l2_2),m.FromArrayToRef(e[5],0,this.l2_1),m.FromArrayToRef(e[6],0,this.l20),m.FromArrayToRef(e[7],0,this.l21),m.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return m.FromFloatsToRef(e[0],e[1],e[2],this.l00),m.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),m.FromFloatsToRef(e[6],e[7],e[8],this.l10),m.FromFloatsToRef(e[9],e[10],e[11],this.l11),m.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),m.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),m.FromFloatsToRef(e[18],e[19],e[20],this.l20),m.FromFloatsToRef(e[21],e[22],e[23],this.l21),m.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new Qa().updateFromArray(e)}static FromPolynomial(e){const t=new Qa;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class Tn{constructor(){this.x=m.Zero(),this.y=m.Zero(),this.z=m.Zero(),this.xx=m.Zero(),this.yy=m.Zero(),this.zz=m.Zero(),this.xy=m.Zero(),this.yz=m.Zero(),this.zx=m.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=Qa.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){D.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=D.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),D.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),D.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(D.Vector3[0]).addInPlace(D.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(D.Vector3[0]).subtractInPlace(D.Vector3[1]),this.zz.copyFrom(e.l00),D.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(D.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new Tn().updateFromHarmonics(e)}static FromArray(e){const t=new Tn;return m.FromArrayToRef(e[0],0,t.x),m.FromArrayToRef(e[1],0,t.y),m.FromArrayToRef(e[2],0,t.z),m.FromArrayToRef(e[3],0,t.xx),m.FromArrayToRef(e[4],0,t.yy),m.FromArrayToRef(e[5],0,t.zz),m.FromArrayToRef(e[6],0,t.yz),m.FromArrayToRef(e[7],0,t.zx),m.FromArrayToRef(e[8],0,t.xy),t}}class VR{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,s=1,r=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=r,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var At;(function(o){o[o.Unknown=0]="Unknown",o[o.Url=1]="Url",o[o.Temp=2]="Temp",o[o.Raw=3]="Raw",o[o.Dynamic=4]="Dynamic",o[o.RenderTarget=5]="RenderTarget",o[o.MultiRenderTarget=6]="MultiRenderTarget",o[o.Cube=7]="Cube",o[o.CubeRaw=8]="CubeRaw",o[o.CubePrefiltered=9]="CubePrefiltered",o[o.Raw3D=10]="Raw3D",o[o.Raw2DArray=11]="Raw2DArray",o[o.DepthStencil=12]="DepthStencil",o[o.CubeRawRGBD=13]="CubeRawRGBD",o[o.Depth=14]="Depth"})(At||(At={}));class wi extends VR{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new j,this.onErrorObservable=new j,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=At.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._engine=e,this._source=t,this._uniqueId=wi._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const i=this.onRebuildCallback(this),s=r=>{r._swapAndDie(this,!1),this.isReady=i.isReady};i.isAsync?i.proxy.then(s):s(i.proxy);return}let t;switch(this.source){case At.Temp:break;case At.Url:t=this._engine.createTexture((e=this._originalUrl)!==null&&e!==void 0?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,i=>{i._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case At.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case At.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case At.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case At.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case At.Cube:t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case At.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case At.CubeRawRGBD:return;case At.CubePrefiltered:t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,i=>{i&&i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),t._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var i;(i=this._hardwareTexture)===null||i===void 0||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const s=this._engine.getLoadedTexturesCache();let r=s.indexOf(this);r!==-1&&s.splice(r,1),r=s.indexOf(e),r===-1&&s.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}wi._Counter=0;function Fi(){return typeof window<"u"}function Jl(){return typeof navigator<"u"}function ih(){return typeof document<"u"}function mm(o){let e="",t=o.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}const Pp={};function ke(o,e=!1){if(!(e&&Pp[o]))return Pp[o]=!0,`${o} needs to be imported before as it contains a side-effect required by your code.`}let q=class Ft{static _CheckLimit(e,t){let i=Ft._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},Ft._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const s=Ft._LogLimitOutputs[e];if(!s||!Ft.MessageLimitReached)return;const r=this._Levels[t];s.current===s.limit&&Ft[r.name](Ft.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,(i=r.name)!==null&&i!==void 0?i:""))}static _AddLogEntry(e){Ft._LogCache=e+Ft._LogCache,Ft.OnNewCacheEntry&&Ft.OnNewCacheEntry(e)}static _FormatMessage(e){const t=s=>s<10?"0"+s:""+s,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){const s=Array.isArray(t)?t[0]:t;if(i!==void 0&&!Ft._CheckLimit(s,i))return;const r=Ft._FormatMessage(s),n=this._Levels[e],a=Array.isArray(t)?t.slice(1):[];n.logFunc&&n.logFunc("BJS - "+r,...a);const l=`<div style='color:${n.color}'>${r}</div><br>`;Ft._AddLogEntry(l),Ft._GenerateLimitMessage(s,e)}static get LogCache(){return Ft._LogCache}static ClearLogCache(){Ft._LogCache="",Ft._LogLimitOutputs={},Ft.errorsCount=0}static set LogLevels(e){Ft.Log=Ft._LogDisabled,Ft.Warn=Ft._LogDisabled,Ft.Error=Ft._LogDisabled,[Ft.MessageLogLevel,Ft.WarningLogLevel,Ft.ErrorLogLevel].forEach(t=>{if((e&t)===t){const i=this._Levels[t];Ft[i.name]=Ft._LogEnabled.bind(Ft,t)}})}};q.NoneLogLevel=0;q.MessageLogLevel=1;q.WarningLogLevel=2;q.ErrorLogLevel=4;q.AllLogLevel=7;q.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";q._LogCache="";q._LogLimitOutputs={};q._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];q.errorsCount=0;q.Log=q._LogEnabled.bind(q,q.MessageLogLevel);q.Warn=q._LogEnabled.bind(q,q.WarningLogLevel);q.Error=q._LogEnabled.bind(q,q.ErrorLogLevel);const GR="attribute",zR="varying";class sh{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var i,s,r,n,a,l,h;let c="";if(this.line){let u=this.line;const d=t.processor;if(d){d.lineProcessor&&(u=d.lineProcessor(u,t.isFragment,t.processingContext));const f=(s=(i=t.processor)===null||i===void 0?void 0:i.attributeKeywordName)!==null&&s!==void 0?s:GR,p=t.isFragment&&(!((r=t.processor)===null||r===void 0)&&r.varyingFragmentKeywordName)?(n=t.processor)===null||n===void 0?void 0:n.varyingFragmentKeywordName:!t.isFragment&&(!((a=t.processor)===null||a===void 0)&&a.varyingVertexKeywordName)?(l=t.processor)===null||l===void 0?void 0:l.varyingVertexKeywordName:zR;!t.isFragment&&d.attributeProcessor&&this.line.startsWith(f)?u=d.attributeProcessor(this.line,e,t.processingContext):d.varyingProcessor&&(!((h=d.varyingCheck)===null||h===void 0)&&h.call(d,this.line,t.isFragment)||!d.varyingCheck&&this.line.startsWith(p))?u=d.varyingProcessor(this.line,t.isFragment,e,t.processingContext):d.uniformProcessor&&d.uniformRegexp&&d.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&d.uniformBufferRegexp&&d.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(u=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):d.textureProcessor&&d.textureRegexp&&d.textureRegexp.test(this.line)?u=d.textureProcessor(this.line,t.isFragment,e,t.processingContext):(d.uniformProcessor||d.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?d.uniformProcessor&&(u=d.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):d.uniformBufferProcessor&&(u=d.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,d.endOfUniformBufferProcessor&&(u=d.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}c+=u+`
`}return this.children.forEach(u=>{c+=u.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),c}}class HR{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}const i=t.trim();if(!i)continue;if(i.startsWith("//")){this._lines.push(t);continue}const s=i.indexOf(";");if(s===-1)this._lines.push(i);else if(s===i.length-1)i.length>1&&this._lines.push(i);else{const r=t.split(";");for(let n=0;n<r.length;n++){let a=r[n];a&&(a=a.trim(),a&&this._lines.push(a+(n!==r.length-1?";":"")))}}}}}class Ku extends sh{process(e,t){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.isValid(e))return s.process(e,t)}return""}}class WR extends sh{isValid(e){return this.testExpression.isTrue(e)}}class Qt{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(Qt._OperatorPriority[i]===void 0)t.push(i);else{const s=t[t.length-1],r=t[t.length-2];t.length-=2,t.push(`(${r}${i}${s})`)}return t[t.length-1]}static infixToPostfix(e){const t=Qt._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];const i=[];let s=-1;const r=()=>{c=c.trim(),c!==""&&(i.push(c),c="")},n=u=>{s<Qt._Stack.length-1&&(Qt._Stack[++s]=u)},a=()=>Qt._Stack[s],l=()=>s===-1?"!!INVALID EXPRESSION!!":Qt._Stack[s--];let h=0,c="";for(;h<e.length;){const u=e.charAt(h),d=h<e.length-1?e.substr(h,2):"";if(u==="(")c="",n(u);else if(u===")"){for(r();s!==-1&&a()!=="(";)i.push(l());l()}else if(Qt._OperatorPriority[d]>1){for(r();s!==-1&&Qt._OperatorPriority[a()]>=Qt._OperatorPriority[d];)i.push(l());n(d),h++}else c+=u;h++}for(r();s!==-1;)a()==="("?l():i.push(l());return Qt._InfixToPostfixCache.size>=Qt.InfixToPostfixCacheLimitSize&&Qt.ClearCache(),Qt._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){const e=Array.from(Qt._InfixToPostfixCache.entries()).sort((t,i)=>t[1].accessTime-i[1].accessTime);for(let t=0;t<Qt.InfixToPostfixCacheCleanupSize;t++)Qt._InfixToPostfixCache.delete(e[t][0])}}Qt.InfixToPostfixCacheLimitSize=5e4;Qt.InfixToPostfixCacheCleanupSize=25e3;Qt._InfixToPostfixCache=new Map;Qt._OperatorPriority={")":0,"(":1,"||":2,"&&":3};Qt._Stack=["","","","","","","","","","","","","","","","","","","",""];class Tc extends Qt{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class XR extends Qt{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class YR extends Qt{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class KR extends Qt{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let i=!1;const s=parseInt(t),r=parseInt(this.testValue);switch(this.operand){case">":i=s>r;break;case"<":i=s<r;break;case"<=":i=s<=r;break;case">=":i=s>=r;break;case"==":i=s===r;break;case"!=":i=s!==r;break}return i}}var bi;(function(o){o[o.GLSL=0]="GLSL",o[o.WGSL=1]="WGSL"})(bi||(bi={}));const $R=/defined\s*?\((.+?)\)/g,$u=/defined\s*?\[(.+?)\]/g,jR=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,qR=/__decl__/,Dp=/light\{X\}.(\w*)/g,Op=/\{X\}/g,vc=[];class cr{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,s){var r;!((r=t.processor)===null||r===void 0)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const a=this._ProcessShaderConversion(n,t,s);i(a,n)})}static PreProcess(e,t,i,s){var r;!((r=t.processor)===null||r===void 0)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const a=this._ApplyPreProcessing(n,t,s);i(a,n)})}static Finalize(e,t,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:i.processor.finalizeShaders(e,t,i.processingContext)}static _ProcessPrecision(e,t){var i;if(!((i=t.processor)===null||i===void 0)&&i.noPrecision)return e;const s=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?s?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:s||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const i=/defined\((.+)\)/.exec(e);if(i&&i.length)return new Tc(i[1].trim(),e[0]==="!");const s=["==","!=",">=","<=","<",">"];let r="",n=0;for(r of s)if(n=e.indexOf(r),n>-1)break;if(n===-1)return new Tc(e);const a=e.substring(0,n).trim(),l=e.substring(n+r.length).trim();return new KR(a,r,l)}static _BuildSubExpression(e){e=e.replace($R,"defined[$1]");const t=Qt.infixToPostfix(e),i=[];for(const r of t)if(r!=="||"&&r!=="&&")i.push(r);else if(i.length>=2){let n=i[i.length-1],a=i[i.length-2];i.length-=2;const l=r=="&&"?new YR:new XR;typeof n=="string"&&(n=n.replace($u,"defined($1)")),typeof a=="string"&&(a=a.replace($u,"defined($1)")),l.leftOperand=typeof a=="string"?this._ExtractOperation(a):a,l.rightOperand=typeof n=="string"?this._ExtractOperation(n):n,i.push(l)}let s=i[i.length-1];return typeof s=="string"&&(s=s.replace($u,"defined($1)")),typeof s=="string"?this._ExtractOperation(s):s}static _BuildExpression(e,t){const i=new WR,s=e.substring(0,t);let r=e.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),s==="#ifdef"?i.testExpression=new Tc(r):s==="#ifndef"?i.testExpression=new Tc(r,!0):i.testExpression=this._BuildSubExpression(r),i}static _MoveCursorWithinIf(e,t,i){let s=e.currentLine;for(;this._MoveCursor(e,i);){s=e.currentLine;const r=s.substring(0,5).toLowerCase();if(r==="#else"){const n=new sh;t.children.push(n),this._MoveCursor(e,n);return}else if(r==="#elif"){const n=this._BuildExpression(s,5);t.children.push(n),i=n}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine;if(i.indexOf("#")>=0){const r=cr._MoveCursorRegex.exec(i);if(r&&r.length){switch(r[0]){case"#ifdef":{const a=new Ku;t.children.push(a);const l=this._BuildExpression(i,6);a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const a=new Ku;t.children.push(a);const l=this._BuildExpression(i,7);a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}case"#if":{const a=new Ku,l=this._BuildExpression(i,3);t.children.push(a),a.children.push(l),this._MoveCursorWithinIf(e,a,l);break}}continue}}const s=new sh;if(s.line=i,t.children.push(s),i[0]==="#"&&i[1]==="d"){const r=i.replace(";","").split(" ");s.additionalDefineKey=r[1],r.length===3&&(s.additionalDefineValue=r[2])}}return!1}static _EvaluatePreProcessors(e,t,i){const s=new sh,r=new HR;return r.lineIndex=-1,r.lines=e.split(`
`),this._MoveCursor(r,s),s.process(t,i)}static _PreparePreProcessors(e,t){var i;const s=e.defines,r={};for(const n of s){const l=n.replace("#define","").replace(";","").trim().split(" ");r[l[0]]=l.length>1?l[1]:""}return((i=e.processor)===null||i===void 0?void 0:i.shaderLanguage)===bi.GLSL&&(r.GL_ES="true"),r.__VERSION__=e.version,r[e.platformName]="true",t._getGlobalDefines(r),r}static _ProcessShaderConversion(e,t,i){let s=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===bi.GLSL&&s.indexOf("#version 3")!==-1&&(s=s.replace("#version 300 es",""),!t.processor.parseGLES3))return s;const r=t.defines,n=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(s=t.processor.preProcessor(s,r,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,n,t),t.processor.postProcessor&&(s=t.processor.postProcessor(s,r,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}static _ApplyPreProcessing(e,t,i){var s,r;let n=e;const a=t.defines,l=this._PreparePreProcessors(t,i);return!((s=t.processor)===null||s===void 0)&&s.preProcessor&&(n=t.processor.preProcessor(n,a,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,l,t),!((r=t.processor)===null||r===void 0)&&r.postProcessor&&(n=t.processor.postProcessor(n,a,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}static _ProcessIncludes(e,t,i){vc.length=0;let s;for(;(s=jR.exec(e))!==null;)vc.push(s);let r=String(e),n=[e],a=!1;for(const l of vc){let h=l[1];if(h.indexOf("__decl__")!==-1&&(h=h.replace(qR,""),t.supportsUniformBuffers&&(h=h.replace("Vertex","Ubo").replace("Fragment","Ubo")),h=h+"Declaration"),t.includesShadersStore[h]){let c=t.includesShadersStore[h];if(l[2]){const d=l[3].split(",");for(let f=0;f<d.length;f+=2){const p=new RegExp(d[f],"g"),_=d[f+1];c=c.replace(p,_)}}if(l[4]){const d=l[5];if(d.indexOf("..")!==-1){const f=d.split(".."),p=parseInt(f[0]);let _=parseInt(f[1]),g=c.slice(0);c="",isNaN(_)&&(_=t.indexParameters[f[1]]);for(let E=p;E<_;E++)t.supportsUniformBuffers||(g=g.replace(Dp,(R,x)=>x+"{X}")),c+=g.replace(Op,E.toString())+`
`}else t.supportsUniformBuffers||(c=c.replace(Dp,(f,p)=>p+"{X}")),c=c.replace(Op,d)}const u=[];for(const d of n){const f=d.split(l[0]);for(let p=0;p<f.length-1;p++)u.push(f[p]),u.push(c);u.push(f[f.length-1])}n=u,a=a||c.indexOf("#include<")>=0||c.indexOf("#include <")>=0}else{const c=t.shadersRepository+"ShadersInclude/"+h+".fx";cr._FileToolsLoadFile(c,u=>{t.includesShadersStore[h]=u,this._ProcessIncludes(n.join(""),t,i)});return}}vc.length=0,r=n.join(""),a?this._ProcessIncludes(r.toString(),t,i):i(r)}static _FileToolsLoadFile(e,t,i,s,r,n){throw ke("FileTools")}}cr._MoveCursorRegex=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;class X{static GetShadersRepository(e=bi.GLSL){return e===bi.GLSL?X.ShadersRepository:X.ShadersRepositoryWGSL}static GetShadersStore(e=bi.GLSL){return e===bi.GLSL?X.ShadersStore:X.ShadersStoreWGSL}static GetIncludesShadersStore(e=bi.GLSL){return e===bi.GLSL?X.IncludesShadersStore:X.IncludesShadersStoreWGSL}}X.ShadersRepository="src/Shaders/";X.ShadersStore={};X.IncludesShadersStore={};X.ShadersRepositoryWGSL="src/ShadersWGSL/";X.ShadersStoreWGSL={};X.IncludesShadersStoreWGSL={};class ai{static get ShadersRepository(){return X.ShadersRepository}static set ShadersRepository(e){X.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new j),this._onBindObservable}constructor(e,t,i,s=null,r,n=null,a=null,l=null,h=null,c,u="",d=bi.GLSL){var f,p,_;if(this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new j,this.onErrorObservable=new j,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=u,t.attributes){const g=t;if(this._engine=i,this._attributesNames=g.attributes,this._uniformsNames=g.uniformsNames.concat(g.samplers),this._samplerList=g.samplers.slice(),this.defines=g.defines,this.onError=g.onError,this.onCompiled=g.onCompiled,this._fallbacks=g.fallbacks,this._indexParameters=g.indexParameters,this._transformFeedbackVaryings=g.transformFeedbackVaryings||null,this._multiTarget=!!g.multiTarget,this._shaderLanguage=(f=g.shaderLanguage)!==null&&f!==void 0?f:bi.GLSL,g.uniformBuffersNames){this._uniformBuffersNamesList=g.uniformBuffersNames.slice();for(let E=0;E<g.uniformBuffersNames.length;E++)this._uniformBuffersNames[g.uniformBuffersNames[E]]=E}this._processFinalCode=(p=g.processFinalCode)!==null&&p!==void 0?p:null,this._processCodeAfterIncludes=(_=g.processCodeAfterIncludes)!==null&&_!==void 0?_:void 0}else this._engine=r,this.defines=n??"",this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=h,this.onCompiled=l,this._indexParameters=c,this._fallbacks=a;this._attributeLocationByName={},this.uniqueId=ai._UniqueIdSeed++,this._processShaderCode()}_processShaderCode(e=null,t=!1){let i,s;const r=this.name,n=Fi()?this._engine.getHostDocument():null;r.vertexSource?i="source:"+r.vertexSource:r.vertexElement?(i=n?n.getElementById(r.vertexElement):null,i||(i=r.vertexElement)):i=r.vertex||r,r.fragmentSource?s="source:"+r.fragmentSource:r.fragmentElement?(s=n?n.getElementById(r.fragmentElement):null,s||(s=r.fragmentElement)):s=r.fragment||r,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let a={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:X.GetShadersRepository(this._shaderLanguage),includesShadersStore:X.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};const l=[void 0,void 0],h=()=>{if(l[0]&&l[1]){a.isFragment=!0;const[c,u]=l;cr.Process(u,a,(d,f)=>{this._fragmentSourceCodeBeforeMigration=f,this._processFinalCode&&(d=this._processFinalCode("fragment",d));const p=cr.Finalize(c,d,a);a=null,this._useFinalCode(p.vertexCode,p.fragmentCode,r,t)},this._engine)}};this._loadShader(i,"Vertex","",c=>{cr.Initialize(a),cr.Process(c,a,(u,d)=>{this._rawVertexSourceCode=c,this._vertexSourceCodeBeforeMigration=d,this._processFinalCode&&(u=this._processFinalCode("vertex",u)),l[0]=u,h()},this._engine)}),this._loadShader(s,"Fragment","Pixel",c=>{this._rawFragmentSourceCode=c,l[1]=c,h()})}_useFinalCode(e,t,i,s=!1){if(i){const r=i.vertexElement||i.vertex||i.spectorName||i,n=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===bi.WGSL?"//":"")+"#define SHADER_NAME vertex:"+r+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===bi.WGSL?"//":"")+"#define SHADER_NAME fragment:"+n+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect(s)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,s){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const a=mm(e);s(a);return}if(e.substr(0,7)==="source:"){s(e.substr(7));return}if(e.substr(0,7)==="base64:"){const a=window.atob(e.substr(7));s(a);return}const r=X.GetShadersStore(this._shaderLanguage);if(r[e+t+"Shader"]){s(r[e+t+"Shader"]);return}if(i&&r[e+i+"Shader"]){s(r[e+i+"Shader"]);return}let n;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?n=e:n=X.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",s)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&t!==void 0?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&t!==void 0?t:this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,s){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(r,n)=>{s&&s(n)},this.onCompiled=()=>{const r=this.getEngine().scenes;if(r)for(let n=0;n<r.length;n++)r[n].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(e=!1){var t;const i=this._attributesNames,s=this.defines,r=this._pipelineContext;this._isReady=!1;try{const n=this._engine;this._pipelineContext=(t=e?r:void 0)!==null&&t!==void 0?t:n.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key.replace(/\r/g,"").replace(/\n/g,"|");const a=(l,h,c,u)=>this._rebuildProgram(l,h,c,u);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?n._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,a,null,this._transformFeedbackVaryings,this._key):n._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,a,s,this._transformFeedbackVaryings,this._key),n._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,i,this._attributes),i)for(let l=0;l<i.length;l++){const h=i[l];this._attributeLocationByName[h]=this._attributes[l]}n.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),r&&!e&&this.getEngine()._deletePipelineContext(r)}),this._pipelineContext.isAsync&&this._checkIsReady(r)}catch(n){this._processCompilationErrors(n,r)}}_getShaderCodeAndErrorLine(e,t,i){const s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const n=t.match(s);if(n&&n.length===2){const a=parseInt(n[1]),l=e.split(`
`,-1);l.length>=a&&(r=`Offending line [${a}] in ${i?"fragment":"vertex"} code: ${l[a-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){var i,s,r;this._compilationError=e.message;const n=this._attributesNames,a=this._fallbacks;if(q.Error("Unable to compile effect:"),q.Error("Uniforms: "+this._uniformsNames.map(function(h){return" "+h})),q.Error("Attributes: "+n.map(function(h){return" "+h})),q.Error(`Defines:
`+this.defines),ai.LogShaderCodeOnCompilationError){let h=null,c=null,u=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getVertexShaderCode()&&([u,h]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),u&&(q.Error("Vertex code:"),q.Error(u))),!((s=this._pipelineContext)===null||s===void 0)&&s._getFragmentShaderCode()&&([u,c]=this._getShaderCodeAndErrorLine((r=this._pipelineContext)===null||r===void 0?void 0:r._getFragmentShaderCode(),this._compilationError,!0),u&&(q.Error("Fragment code:"),q.Error(u))),h&&q.Error(h),c&&q.Error(c)}q.Error("Error: "+this._compilationError);const l=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,l()),a?(this._pipelineContext=null,a.hasMoreFallbacks?(this._allFallbacksProcessed=!1,q.Error("Trying next fallback."),this.defines=a.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,l(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||l())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const s=this._samplerList.indexOf(e);for(let n=1;n<t.length;n++){const a=i+(n-1).toString();this._samplerList.splice(s+n,0,a)}let r=0;for(const n of this._samplerList)this._samplers[n]=r,r+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||ai._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(ai._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,s){return this._pipelineContext.setInt3(e,t,i,s),this}setInt4(e,t,i,s,r){return this._pipelineContext.setInt4(e,t,i,s,r),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,s){return this._pipelineContext.setUInt3(e,t,i,s),this}setUInt4(e,t,i,s,r){return this._pipelineContext.setUInt4(e,t,i,s,r),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,s){return this._pipelineContext.setFloat3(e,t,i,s),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,s,r){return this._pipelineContext.setFloat4(e,t,i,s,r),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,s=bi.GLSL){t&&(X.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(X.GetShadersStore(s)[`${e}VertexShader`]=i)}static ResetCache(){ai._BaseCache={}}}ai.LogShaderCodeOnCompilationError=!0;ai._UniqueIdSeed=0;ai._BaseCache={};ai.ShadersStore=X.ShadersStore;ai.IncludesShadersStore=X.IncludesShadersStore;class ZR{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class Ur{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=Ur.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=Ur.KEEP,this.opDepthFail=Ur.KEEP,this.opStencilDepthPass=Ur.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}Ur.ALWAYS=519;Ur.KEEP=7680;Ur.REPLACE=7681;class QR{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,s){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===s||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class JR{constructor(){this.shaderLanguage=bi.GLSL}postProcessor(e,t,i,s,r){if(!r.getCaps().drawBuffersExtension){const n=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(n,"")}return e}}const e0=/(flat\s)?\s*varying\s*.*/;class t0{constructor(){this.shaderLanguage=bi.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return e0.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,r=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(r,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const n=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(s||n?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class Rh{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=Rh._Counter++}}Rh._Counter=0;class fh extends Rh{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}class i0{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,s,r,n,a,l){const h=this.engine;if(h.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this.engine.getUniforms(this,i).forEach((d,f)=>{s[i[f]]=d}),this._uniforms=s;let u;for(u=0;u<r.length;u++)e.getUniform(r[u])==null&&(r.splice(u,1),u--);r.forEach((d,f)=>{n[d]=f});for(const d of h.getAttributes(this,a))l.push(d)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s||s.length!==2)return s=[t,i],this._valueCache[e]=s,!0;let r=!1;return s[0]!==t&&(s[0]=t,r=!0),s[1]!==i&&(s[1]=i,r=!0),r}_cacheFloat3(e,t,i,s){let r=this._valueCache[e];if(!r||r.length!==3)return r=[t,i,s],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),r[2]!==s&&(r[2]=s,n=!0),n}_cacheFloat4(e,t,i,s,r){let n=this._valueCache[e];if(!n||n.length!==4)return n=[t,i,s,r],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==s&&(n[2]=s,a=!0),n[3]!==r&&(n[3]=r,a=!0),a}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setUInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setUInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setUInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setFloat4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class Em{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(const e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){var t,i;return(i=(t=this._MSAARenderBuffers)===null||t===void 0?void 0:t[e])!==null&&i!==void 0?i:null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class _r{static IsWrapper(e){return e.getPipelineContext===void 0}static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){var s;this.effect=e,t!==void 0&&(this.defines=t),i&&((s=this.drawContext)===null||s===void 0||s.reset())}dispose(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()}}class s0{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(!((t=this.stencilMaterial)===null||t===void 0)&&t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class Os{static get Now(){return Fi()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class r0{}class Ie{static get NpmPackage(){return"babylonjs@6.36.0"}static get Version(){return"6.36.0"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return ai.ShadersRepository}static set ShadersRepository(e){ai.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return Ie._CreateCanvas(e,t)}createCanvasImage(){return document.createElement("img")}constructor(e,t,i,s){var r,n,a,l,h,c,u,d,f,p,_;this._name="WebGL",this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new j,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new j,this.onContextRestoredObservable=new j,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new ZR,this._stencilStateComposer=new s0,this._stencilState=new Ur,this._alphaState=new QR,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._currentRenderTarget=null,this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new j,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=Os.Now;let g=null;i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=s??!1,this._stencilStateComposer.stencilGlobal=this._stencilState,Ri.SetMatrixPrecision(!!i.useHighPrecisionMatrix),i.antialias=t??i.antialias,i.deterministicLockstep=(r=i.deterministicLockstep)!==null&&r!==void 0?r:!1,i.lockstepMaxSteps=(n=i.lockstepMaxSteps)!==null&&n!==void 0?n:4,i.timeStep=(a=i.timeStep)!==null&&a!==void 0?a:1/60,i.audioEngine=(l=i.audioEngine)!==null&&l!==void 0?l:!0,i.stencil=(h=i.stencil)!==null&&h!==void 0?h:!0,this._audioContext=(u=(c=i.audioEngineOptions)===null||c===void 0?void 0:c.audioContext)!==null&&u!==void 0?u:null,this._audioDestination=(f=(d=i.audioEngineOptions)===null||d===void 0?void 0:d.audioDestination)!==null&&f!==void 0?f:null,this.premultipliedAlpha=(p=i.premultipliedAlpha)!==null&&p!==void 0?p:!0,this.useExactSrgbConversions=(_=i.useExactSrgbConversions)!==null&&_!==void 0?_:!1,this._doNotHandleContextLost=!!i.doNotHandleContextLost,this._isStencilEnable=!!i.stencil,s=s||i.adaptToDeviceRatio||!1;const E=Fi()&&window.devicePixelRatio||1,R=i.limitDeviceRatio||E;if(this._hardwareScalingLevel=s?1/Math.min(R,E):1,this._lastDevicePixelRatio=E,!e)return;if(e.getContext){if(g=e,this._renderingCanvas=g,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();const S=navigator.userAgent;for(const b of Ie.ExceptionList){const y=b.key,I=b.targets;if(new RegExp(y).test(S)){if(b.capture&&b.captureConstraint){const N=b.capture,w=b.captureConstraint,k=new RegExp(N).exec(S);if(k&&k.length>0&&parseInt(k[k.length-1])>=w)continue}for(const N of I)switch(N){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=S=>{S.preventDefault(),this._contextWasLost=!0,q.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},g.addEventListener("webglcontextlost",this._onContextLost,!1),g.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=g.getContext("webgl2",i)||g.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!g)throw new Error("The provided canvas is null or undefined.");try{this._gl=g.getContext("webgl",i)||g.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const S=this._gl.getContextAttributes();S&&(i.stencil=S.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let S=0;S<this._caps.maxVertexAttribs;S++)this._currentBufferPointers[S]=new r0;this._shaderProcessor=this.webGLVersion>1?new t0:new JR,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const x=`Babylon.js v${Ie.Version}`;q.Log(x+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",x)}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&ih()&&"ontouchend"in document},this._checkForMobile(),Fi()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout(async()=>{var t;this._dummyFramebuffer=null;const i=this._depthCullingState.depthTest,s=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,n=this._stencilState.stencilTest;await e(),this.wipeCaches(!0),this._rebuildEffects(),(t=this._rebuildComputeEffects)===null||t===void 0||t.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=s,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=n,q.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1},0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}ai.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(t!=null&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let s=0;s<16;s++)this._gl["COLOR_ATTACHMENT"+s+"_WEBGL"]=i["COLOR_ATTACHMENT"+s+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const i=this._gl.getExtension("WEBGL_depth_texture");i!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const i=this._gl.getExtension("OES_vertex_array_object");i!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=i.createVertexArrayOES.bind(i),this._gl.bindVertexArray=i.bindVertexArrayOES.bind(i),this._gl.deleteVertexArray=i.deleteVertexArrayOES.bind(i))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const i=this._gl.getExtension("ANGLE_instanced_arrays");i!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),this._gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),this._gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const i=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),s=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);i&&s&&(this._caps.highPrecisionShaderSupported=i.precision!==0&&s.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const i=this._gl.getExtension("EXT_blend_minmax");i!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=i.MAX_EXT,this._gl.MIN=i.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{const i=this._gl.getExtension("EXT_sRGB");i!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:i.SRGB_EXT,SRGB8:i.SRGB_ALPHA_EXT,SRGB8_ALPHA8:i.SRGB_ALPHA_EXT})}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let i=0;i<this._maxSimultaneousTextures;i++)this._nextFreeTextureSlots.push(i);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideMultiple4Bytes:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}const t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._renderingQueueLaunched&&this._frameHandler){if(this._renderingQueueLaunched=!1,Fi()){const{cancelAnimationFrame:e}=this.getHostWindow()||window;if(typeof e=="function")return e(this._frameHandler)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(this._frameHandler);return clearTimeout(this._frameHandler)}}_renderLoop(){if(!this._contextWasLost){let e=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e){this.beginFrame();for(let t=0;t<this._activeRenderLoops.length;t++){const i=this._activeRenderLoops[t];i()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return Fi()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,t){return Ie.QueueNewFrame(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=()=>this._renderLoop(),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,i,s=!1){var r,n;const a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;let l=0;if(t&&e){let h=!0;if(this._currentRenderTarget){const c=(r=this._currentRenderTarget.texture)===null||r===void 0?void 0:r.format;if(c===8||c===9||c===10||c===11){const u=(n=this._currentRenderTarget.texture)===null||n===void 0?void 0:n.type;u===7||u===5?(Ie._TempClearColorUint32[0]=e.r*255,Ie._TempClearColorUint32[1]=e.g*255,Ie._TempClearColorUint32[2]=e.b*255,Ie._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,Ie._TempClearColorUint32),h=!1):(Ie._TempClearColorInt32[0]=e.r*255,Ie._TempClearColorInt32[1]=e.g*255,Ie._TempClearColorInt32[2]=e.b*255,Ie._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,Ie._TempClearColorInt32),h=!1)}}h&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),l|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),l|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),l|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(l)}_viewport(e,t,i,s){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||s!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s,this._gl.viewport(e,t,i,s))}setViewport(e,t,i){const s=t||this.getRenderWidth(),r=i||this.getRenderHeight(),n=e.x||0,a=e.y||0;this._cachedViewport=e,this._viewport(n*s,a*r,s*e.width,r*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const s=Fi()&&window.devicePixelRatio||1,r=this._lastDevicePixelRatio/s;this._lastDevicePixelRatio=s,this._hardwareScalingLevel*=r}if(Fi()&&ih())if(this._renderingCanvas){const s=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};t=this._renderingCanvas.clientWidth||s.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||s.height||this._renderingCanvas.height||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){return!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)}bindFramebuffer(e,t=0,i,s,r,n=0,a=0){var l,h,c,u,d,f;const p=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(p._MSAAFramebuffer?p._MSAAFramebuffer:p._framebuffer);const _=this._gl;e.isMulti||(e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,n,a):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,(h=e.texture._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n):p._currentLOD!==n&&(_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,(c=e.texture._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,n),p._currentLOD=n));const g=e._depthStencilTexture;if(g){const E=e._depthStencilTextureWithStencil?_.DEPTH_STENCIL_ATTACHMENT:_.DEPTH_ATTACHMENT;e.is2DArray?_.framebufferTextureLayer(_.FRAMEBUFFER,E,(u=g._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,n,a):e.isCube?_.framebufferTexture2D(_.FRAMEBUFFER,E,_.TEXTURE_CUBE_MAP_POSITIVE_X+t,(d=g._hardwareTexture)===null||d===void 0?void 0:d.underlyingResource,n):_.framebufferTexture2D(_.FRAMEBUFFER,E,_.TEXTURE_2D,(f=g._hardwareTexture)===null||f===void 0?void 0:f.underlyingResource,n)}this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),s||(s=e.height,n&&(s=s/Math.pow(2,n))),this._viewport(0,0,i,s)),this.wipeCaches()}setState(e,t=0,i,s=!1,r,n,a=0){var l,h;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const c=!((h=(l=this.cullBackFaces)!==null&&l!==void 0?l:r)!==null&&h!==void 0)||h?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==c||i)&&(this._depthCullingState.cullFace=c),this.setZOffset(t),this.setZOffsetUnits(a);const u=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==u||i)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=n}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,i){var s;const r=e;this._currentRenderTarget=null;const n=this._gl;if(r._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}n.bindFramebuffer(n.READ_FRAMEBUFFER,r._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,r._framebuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n.COLOR_BUFFER_BIT,n.NEAREST)}!((s=e.texture)===null||s===void 0)&&s.generateMipMaps&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const s=new fh(i);return this.bindArrayBuffer(s),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){const s=this._gl.createBuffer(),r=new fh(s);if(!s)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);const n=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,n,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=n.BYTES_PER_ELEMENT===4,r}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,r,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,s,r,n,a){const l=this._currentBufferPointers[t];if(!l)return;let h=!1;l.active?(l.buffer!==e&&(l.buffer=e,h=!0),l.size!==i&&(l.size=i,h=!0),l.type!==s&&(l.type=s,h=!0),l.normalized!==r&&(l.normalized=r,h=!0),l.stride!==n&&(l.stride=n,h=!0),l.offset!==a&&(l.offset=a,h=!0)):(h=!0,l.active=!0,l.index=t,l.size=i,l.type=s,l.normalized=r,l.stride=n,l.offset=a,l.buffer=e),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,i,s,n,a):this._gl.vertexAttribPointer(t,i,s,r,n,a))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<s.length;r++){const n=t.getAttributeLocation(r);if(n>=0){const a=s[r];let l=null;if(i&&(l=i[a]),l||(l=e[a]),!l)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const h=l.getBuffer();h&&(this._vertexAttribPointer(h,n,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(h))))}}}recordVertexArrayObject(e,t,i,s){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,s,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const n=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let a=0;for(let l=0;l<n;l++)if(l<i.length){const h=r.getAttributeLocation(l);h>=0&&(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0,this._vertexAttribPointer(e,h,i[l],this._gl.FLOAT,!1,s,a)),a+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,s){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,s)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const s=this._currentInstanceBuffers[t];e!=s&&s.references&&(e=s,this.bindArrayBuffer(s));const r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let s=0;s<4;s++){const r=i[s];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,s*16),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let s=0;if(i)for(let r=0;r<t.length;r++){const n=t[r];s+=n.attributeSize*4}for(let r=0;r<t.length;r++){const n=t[r];n.index===void 0&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),!(n.index<0)&&(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,s,n.offset),this._gl.vertexAttribDivisor(n.index,n.divisor===void 0?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,s){this.drawElementsType(e?0:1,t,i,s)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,s){this.drawArraysType(e?0:1,t,i,s)}drawElementsType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,a=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(r,i,n,t*a,s):this._gl.drawElements(r,i,n,t*a)}drawArraysType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);s?this._gl.drawArraysInstanced(r,t,i,s):this._gl.drawArrays(r,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}createEffect(e,t,i,s,r,n,a,l,h,c=bi.GLSL){var u;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,f=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,p=this._getGlobalDefines();let _=(u=r??t.defines)!==null&&u!==void 0?u:"";p&&(_+=p);const g=d+"+"+f+"@"+_;if(this._compiledEffects[g]){const R=this._compiledEffects[g];return a&&R.isReady()&&a(R),R}const E=new ai(e,t,i,s,this,r,n,a,l,h,g,c);return this._compiledEffects[g]=E,E}static _ConcatenateShader(e,t,i=""){return i+(t?t+`
`:"")+e}_compileShader(e,t,i,s){return this._compileRawShader(Ie._ConcatenateShader(e,i,s),t)}_compileRawShader(e,t){const i=this._gl,s=i.createShader(t==="vertex"?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!s){let r=i.NO_ERROR,n=i.NO_ERROR;for(;(n=i.getError())!==i.NO_ERROR;)r=n;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${r}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return i.shaderSource(s,e),i.compileShader(s),s}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,s,r=null){s=s||this._gl;const n=this._compileRawShader(t,"vertex"),a=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,n,a,s,r)}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl;const a=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=this._compileShader(t,"vertex",s,a),h=this._compileShader(i,"fragment",s,a);return this._createShaderProgram(e,l,h,r,n)}inlineShaderCode(e){return e}createPipelineContext(e){const t=new i0;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");return s.attachShader(n,t),s.attachShader(n,i),s.linkProgram(n),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_finalizePipelineContext(e){const t=e.context,i=e.vertexShader,s=e.fragmentShader,r=e.program;if(!t.getProgramParameter(r,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(i);if(l)throw e.vertexCompilationError=l,new Error("VERTEX SHADER "+l)}if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(s);if(l)throw e.fragmentCompilationError=l,new Error("FRAGMENT SHADER "+l)}const a=t.getProgramInfoLog(r);if(a)throw e.programLinkError=a,new Error(a)}if(this.validateShaderPrograms&&(t.validateProgram(r),!t.getProgramParameter(r,t.VALIDATE_STATUS))){const l=t.getProgramInfoLog(r);if(l)throw e.programValidationError=l,new Error(l)}t.deleteShader(i),t.deleteShader(s),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,t,i,s,r,n,a,l,h,c){const u=e;s?u.program=this.createRawShaderProgram(u,t,i,void 0,h):u.program=this.createShaderProgram(u,t,i,l,void 0,h),u.program.__SPECTOR_rebuildProgram=a}_isRenderingStateCompiled(e){const t=e;return this._isDisposed||t._isDisposed?!1:this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!i.isParallelCompiled){t();return}const s=i.onCompiled;s?i.onCompiled=()=>{s(),t()}:i.onCompiled=t}getUniforms(e,t){const i=new Array,s=e;for(let r=0;r<t.length;r++)i.push(this._gl.getUniformLocation(s.program,t[r]));return i}getAttributes(e,t){const i=[],s=e;for(let r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(s.program,t[r]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&_r.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,s){return e?(this._gl.uniform3i(e,t,i,s),!0):!1}setInt4(e,t,i,s,r){return e?(this._gl.uniform4i(e,t,i,s,r),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,s){return e?(this._gl.uniform3ui(e,t,i,s),!0):!1}setUInt4(e,t,i,s,r){return e?(this._gl.uniform4ui(e,t,i,s,r),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,s){return e?(this._gl.uniform3f(e,t,i,s),!0):!1}setFloat4(e,t,i,s,r){return e?(this._gl.uniform4f(e,t,i,s,r),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let s=i.NEAREST,r=i.NEAREST;switch(e){case 11:s=i.LINEAR,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 3:s=i.LINEAR,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 8:s=i.NEAREST,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 4:s=i.NEAREST,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 5:s=i.NEAREST,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 6:s=i.NEAREST,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 7:s=i.NEAREST,r=i.LINEAR;break;case 1:s=i.NEAREST,r=i.NEAREST;break;case 9:s=i.LINEAR,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 10:s=i.LINEAR,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 2:s=i.LINEAR,r=i.LINEAR;break;case 12:s=i.LINEAR,r=i.NEAREST;break}return{min:r,mag:s}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new Em(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,s=At.Unknown){var r;let n=!1,a=0,l=3,h=5,c=!1,u=1,d;t!==void 0&&typeof t=="object"?(n=!!t.generateMipMaps,a=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,h=t.format===void 0?5:t.format,c=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=(r=t.samples)!==null&&r!==void 0?r:1,d=t.label):n=!!t,c&&(c=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),a===1&&!this._caps.textureFloat&&(a=0,q.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const f=this._gl,p=new wi(this,s),_=e.width||e,g=e.height||e,E=e.layers||0,R=this._getSamplingParameters(l,n),x=E!==0?f.TEXTURE_2D_ARRAY:f.TEXTURE_2D,S=this._getRGBABufferInternalSizedFormat(a,h,c),b=this._getInternalFormat(h),y=this._getWebGLTextureType(a);return this._bindTextureDirectly(x,p),E!==0?(p.is2DArray=!0,f.texImage3D(x,0,S,_,g,E,0,b,y,null)):f.texImage2D(x,0,S,_,g,0,b,y,null),f.texParameteri(x,f.TEXTURE_MAG_FILTER,R.mag),f.texParameteri(x,f.TEXTURE_MIN_FILTER,R.min),f.texParameteri(x,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(x,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),n&&this._gl.generateMipmap(x),this._bindTextureDirectly(x,null),p._useSRGBBuffer=c,p.baseWidth=_,p.baseHeight=g,p.width=_,p.height=g,p.depth=E,p.isReady=!0,p.samples=u,p.generateMipMaps=n,p.samplingMode=l,p.type=a,p.format=h,p.label=d,this._internalTexturesCache.push(p),p}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(e,t,i,s,r=3,n=null,a=null,l,h,c=null,u=null,d=null,f=null,p,_,g){e=e||"";const E=e.substr(0,5)==="data:",R=e.substr(0,5)==="blob:",x=E&&e.indexOf(";base64,")!==-1,S=u||new wi(this,At.Url);S!==u&&(S.label=e.substring(0,60));const b=e;this._transformTextureUrl&&!x&&!u&&!c&&(e=this._transformTextureUrl(e)),b!==e&&(S._originalUrl=b);const y=e.lastIndexOf(".");let I=f||(y>-1?e.substring(y).toLowerCase():""),O=null;I.indexOf("?")>-1&&(I=I.split("?")[0]);for(const k of Ie._TextureLoaders)if(k.canLoad(I,p)){O=k;break}s&&s.addPendingData(S),S.url=e,S.generateMipMaps=!t,S.samplingMode=r,S.invertY=i,S._useSRGBBuffer=this._getUseSRGBBuffer(!!g,t),this._doNotHandleContextLost||(S._buffer=c);let w=null;n&&!u&&(w=S.onLoadedObservable.add(n)),u||this._internalTexturesCache.push(S);const G=(k,de)=>{s&&s.removePendingData(S),e===b?(w&&S.onLoadedObservable.remove(w),Ze.UseFallbackTexture&&this._createTextureBase(Ze.FallbackTexture,t,S.invertY,s,r,null,a,l,h,c,S),k=(k||"Unknown error")+(Ze.UseFallbackTexture?" - Fallback texture was used":""),S.onErrorObservable.notifyObservers({message:k,exception:de}),a&&a(k,de)):(q.Warn(`Failed to load ${e}, falling back to ${b}`),this._createTextureBase(b,t,S.invertY,s,r,n,a,l,h,c,S,d,f,p,_,g))};if(O){const k=de=>{O.loadData(de,S,(ae,_e,Ce,ce,ze,We)=>{We?G("TextureLoader failed to load data"):l(S,I,s,{width:ae,height:_e},S.invertY,!Ce,ce,()=>(ze(),!1),r)},_)};c?c instanceof ArrayBuffer?k(new Uint8Array(c)):ArrayBuffer.isView(c)?k(c):a&&a("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,de=>k(new Uint8Array(de)),void 0,s?s.offlineProvider:void 0,!0,(de,ae)=>{G("Unable to load "+(de&&de.responseURL,ae))})}else{const k=de=>{R&&!this._doNotHandleContextLost&&(S._buffer=de),l(S,I,s,de,S.invertY,t,!1,h,r)};!E||x?c&&(typeof c.decoding=="string"||c.close)?k(c):Ie._FileToolsLoadImage(e,k,G,s?s.offlineProvider:null,p,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof c=="string"||c instanceof ArrayBuffer||ArrayBuffer.isView(c)||c instanceof Blob?Ie._FileToolsLoadImage(c,k,G,s?s.offlineProvider:null,p,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):c&&k(c)}return S}createTexture(e,t,i,s,r=3,n=null,a=null,l=null,h=null,c=null,u=null,d,f,p,_){return this._createTextureBase(e,t,i,s,r,n,a,this._prepareWebGLTexture.bind(this),(g,E,R,x,S,b)=>{const y=this._gl,I=R.width===g&&R.height===E,O=this._getTexImageParametersForCreateTexture(c,x,S._useSRGBBuffer);if(I)return y.texImage2D(y.TEXTURE_2D,0,O.internalFormat,O.format,O.type,R),!1;const N=this._caps.maxTextureSize;if(R.width>N||R.height>N||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=g,this._workingCanvas.height=E,this._workingContext.drawImage(R,0,0,R.width,R.height,0,0,g,E),y.texImage2D(y.TEXTURE_2D,0,O.internalFormat,O.format,O.type,this._workingCanvas),S.width=g,S.height=E),!1;{const w=new wi(this,At.Temp);this._bindTextureDirectly(y.TEXTURE_2D,w,!0),y.texImage2D(y.TEXTURE_2D,0,O.internalFormat,O.format,O.type,R),this._rescaleTexture(w,S,s,O.format,()=>{this._releaseTexture(w),this._bindTextureDirectly(y.TEXTURE_2D,S,!0),b()})}return!0},l,h,c,u,d,f,_)}_getTexImageParametersForCreateTexture(e,t,i){e==null&&(e=t===".jpg"&&!i?4:5);let s,r;return this.webGLVersion===1?(s=this._getInternalFormat(e,i),r=s):(s=this._getInternalFormat(e,!1),r=this._getRGBABufferInternalSizedFormat(0,e,i)),{internalFormat:r,format:s,type:this._gl.UNSIGNED_BYTE}}static _FileToolsLoadImage(e,t,i,s,r,n){throw ke("FileTools")}_rescaleTexture(e,t,i,s,r){}createRawTexture(e,t,i,s,r,n,a,l=null,h=0,c=0,u=!1){throw ke("Engine.RawTexture")}createRawCubeTexture(e,t,i,s,r,n,a,l=null){throw ke("Engine.RawTexture")}createRawTexture3D(e,t,i,s,r,n,a,l,h=null,c=0){throw ke("Engine.RawTexture")}createRawTexture2DArray(e,t,i,s,r,n,a,l,h=null,c=0){throw ke("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const s=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,r.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e}updateTextureDimensions(e,t,i,s=1){}updateTextureWrappingMode(e,t,i=null,s=null){const r=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&s!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(r,null)}_setupDepthStencilTexture(e,t,i,s,r,n=1){const a=t.width||t,l=t.height||t,h=t.layers||0;e.baseWidth=a,e.baseHeight=l,e.width=a,e.height=l,e.is2DArray=h>0,e.depth=h,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=s?2:1,e.type=0,e._comparisonFunction=r;const c=this._gl,u=this._getTextureTarget(e),d=this._getSamplingParameters(e.samplingMode,!1);c.texParameteri(u,c.TEXTURE_MAG_FILTER,d.mag),c.texParameteri(u,c.TEXTURE_MIN_FILTER,d.min),c.texParameteri(u,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(u,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this.webGLVersion>1&&(r===0?(c.texParameteri(u,c.TEXTURE_COMPARE_FUNC,515),c.texParameteri(u,c.TEXTURE_COMPARE_MODE,c.NONE)):(c.texParameteri(u,c.TEXTURE_COMPARE_FUNC,r),c.texParameteri(u,c.TEXTURE_COMPARE_MODE,c.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,a=0){const l=this._gl;let h=l.TEXTURE_2D;if(e.isCube&&(h=l.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(h,a,t,i,s,0,r)}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=!1){const a=this._gl,l=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),c=r===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let u=a.TEXTURE_2D;e.isCube&&(u=a.TEXTURE_CUBE_MAP_POSITIVE_X+i);const d=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),p=n?e.width:Math.pow(2,Math.max(d-s,0)),_=n?e.height:Math.pow(2,Math.max(f-s,0));a.texImage2D(u,s,c,p,_,0,h,l,t)}updateTextureData(e,t,i,s,r,n,a=0,l=0,h=!1){const c=this._gl,u=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=c.TEXTURE_2D,p=c.TEXTURE_2D;e.isCube&&(p=c.TEXTURE_CUBE_MAP_POSITIVE_X+a,f=c.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f,e,!0),c.texSubImage2D(p,l,i,s,r,n,d,u,t),h&&this._gl.generateMipmap(p),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){const r=this._gl,n=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,s),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,s,r){const n=this._gl;if(!n)return;const a=this._getSamplingParameters(r,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,a.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a.min),!i&&!s&&n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,s,r,n,a,l,h=3){const c=this.getCaps().maxTextureSize,u=Math.min(c,this.needPOTTextures?Ie.GetExponentOfTwo(s.width,c):s.width),d=Math.min(c,this.needPOTTextures?Ie.GetExponentOfTwo(s.height,c):s.height),f=this._gl;if(f){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(f.TEXTURE_2D,e,!0),this._unpackFlipY(r===void 0?!0:!!r),e.baseWidth=s.width,e.baseHeight=s.height,e.width=u,e.height=d,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:t===".jpg"&&!e._useSRGBBuffer?4:5,!l(u,d,s,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,n,a,h)})&&this._prepareWebGLTextureContinuation(e,i,n,a,h)}}_setupFramebufferDepthAttachments(e,t,i,s,r=1){const n=this._gl;if(e&&t)return this._createRenderBuffer(i,s,r,n.DEPTH_STENCIL,n.DEPTH24_STENCIL8,n.DEPTH_STENCIL_ATTACHMENT);if(t){let a=n.DEPTH_COMPONENT16;return this._webGLVersion>1&&(a=n.DEPTH_COMPONENT32F),this._createRenderBuffer(i,s,r,a,a,n.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,s,r,n.STENCIL_INDEX8,n.STENCIL_INDEX8,n.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,s,r,n,a=!0){const h=this._gl.createRenderbuffer();return this._updateRenderBuffer(h,e,t,i,s,r,n,a)}_updateRenderBuffer(e,t,i,s,r,n,a,l=!0){const h=this._gl;return h.bindRenderbuffer(h.RENDERBUFFER,e),s>1&&h.renderbufferStorageMultisample?h.renderbufferStorageMultisample(h.RENDERBUFFER,s,n,t,i):h.renderbufferStorage(h.RENDERBUFFER,r,t,i),h.framebufferRenderbuffer(h.FRAMEBUFFER,a,h.RENDERBUFFER,e),l&&h.bindRenderbuffer(h.RENDERBUFFER,null),e}_releaseTexture(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();const i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let s=0;s<i.length;s++){const r=e.getUniform(i[s]);r&&(this._boundUniforms[s]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,s=!1){var r,n;let a=!1;const l=t&&t._associatedChannel>-1;if(i&&l&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw q.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(n=(r=t==null?void 0:t._hardwareTexture)===null||r===void 0?void 0:r.underlyingResource)!==null&&n!==void 0?n:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(a=!0,this._activateCurrentTexture());return l&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),a}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,s){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,s=!1,r=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;const h=t.getInternalTexture();h&&(h._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;s?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,!i&&n&&(n._associatedChannel=e);let a=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),a=!1),this._activeChannel=e;const l=this._getTextureTarget(n);if(a&&this._bindTextureDirectly(l,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const h=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=h,t.wrapV=h}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(l,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,s){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let r=0;r<i.length;r++){const n=i[r].getInternalTexture();n?(this._textureUnits[r]=e+r,n._associatedChannel=e+r):this._textureUnits[r]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let r=0;r<i.length;r++)this._setTexture(this._textureUnits[r],i[r],!0)}}_setAnisotropicLevel(e,t,i){const s=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),s&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,s){this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,s){s&&this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e,t;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},Fi()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,ai.ResetCache();for(const i of this._activeRequests)i.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._creationOptions.loseContextOnDispose&&((t=this._gl.getExtension("WEBGL_lose_context"))===null||t===void 0||t.loseContext())}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const a=t.RGBA,l=t.UNSIGNED_BYTE,h=new Uint8Array(4);t.readPixels(0,0,1,1,a,l,h),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(s),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}_loadFile(e,t,i,s,r,n){const a=Ie._FileToolsLoadFile(e,t,i,s,r,n);return this._activeRequests.push(a),a.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),a}static _FileToolsLoadFile(e,t,i,s,r,n){throw ke("FileTools")}readPixels(e,t,i,s,r=!0,n=!0){const a=r?4:3,l=r?this._gl.RGBA:this._gl.RGB,h=new Uint8Array(s*i*a);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,s,l,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)}static NearestPOT(e){const t=Ie.CeilingPOT(e),i=Ie.FloorPOT(e);return t-e>e-i?i:t}static GetExponentOfTwo(e,t,i=2){let s;switch(i){case 1:s=Ie.FloorPOT(e);break;case 2:s=Ie.NearestPOT(e);break;case 3:default:s=Ie.CeilingPOT(e);break}return Math.min(s,t)}static QueueNewFrame(e,t){if(Fi()){const{requestAnimationFrame:i}=t||window;if(typeof i=="function")return i(e)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:ih()?document:null}}Ie._TempClearColorUint32=new Uint32Array(4);Ie._TempClearColorInt32=new Int32Array(4);Ie.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];Ie._TextureLoaders=[];Ie.CollisionsEpsilon=.001;Ie._IsSupported=null;Ie._HasMajorPerformanceCaveat=null;class n0{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new a0(e)}sampleFrame(e=Os.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class a0{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}class ur{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){ur.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){ur.Enabled&&(this._startMonitoringTime=Os.Now)}endMonitoring(e=!0){if(!ur.Enabled)return;e&&this.fetchNewFrame();const t=Os.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=Os.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}ur.Enabled=!0;Ie.prototype.setAlphaConstants=function(o,e,t,i){this._alphaState.setAlphaBlendConstants(o,e,t,i)};Ie.prototype.setAlphaMode=function(o,e=!1){if(this._alphaMode===o){if(!e){const t=o===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(o){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=o===0),this._alphaMode=o};Ie.prototype.getAlphaMode=function(){return this._alphaMode};Ie.prototype.setAlphaEquation=function(o){if(this._alphaEquation!==o){switch(o){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=o}};Ie.prototype.getAlphaEquation=function(){return this._alphaEquation};function o0(o,e,t=!1,i){switch(o){case 3:{const r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&r.set(new Int8Array(i)),r}case 0:{const r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&r.set(new Uint8Array(i)),r}case 4:{const r=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&r.set(new Int16Array(i)),r}case 5:case 8:case 9:case 10:case 2:{const r=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&r.set(new Uint16Array(i)),r}case 6:{const r=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&r.set(new Int32Array(i)),r}case 7:case 11:case 12:case 13:case 14:case 15:{const r=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&r.set(new Uint32Array(i)),r}case 1:{const r=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&r.set(new Float32Array(i)),r}}const s=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&s.set(new Uint8Array(i)),s}Ie.prototype._readTexturePixelsSync=function(o,e,t,i=-1,s=0,r=null,n=!0,a=!1,l=0,h=0){var c,u;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const p=d.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),i>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,(c=o._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,s):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,(u=o._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,s);let f=o.type!==void 0?this._getWebGLTextureType(o.type):d.UNSIGNED_BYTE;if(a)r||(r=o0(o.type,4*e*t));else switch(f){case d.UNSIGNED_BYTE:r||(r=new Uint8Array(4*e*t)),f=d.UNSIGNED_BYTE;break;default:r||(r=new Float32Array(4*e*t)),f=d.FLOAT;break}return n&&this.flushFramebuffer(),d.readPixels(l,h,e,t,d.RGBA,f,r),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),r};Ie.prototype._readTexturePixels=function(o,e,t,i=-1,s=0,r=null,n=!0,a=!1,l=0,h=0){return Promise.resolve(this._readTexturePixelsSync(o,e,t,i,s,r,n,a,l,h))};Ie.prototype.updateDynamicIndexBuffer=function(o,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(o);let i;o.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};Ie.prototype.updateDynamicVertexBuffer=function(o,e,t,i){this.bindArrayBuffer(o),t===void 0&&(t=0);const s=e.byteLength||e.length;i===void 0||i>=s&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};class H extends Ie{static get NpmPackage(){return Ie.NpmPackage}static get Version(){return Ie.Version}static get Instances(){return Ze.Instances}static get LastCreatedEngine(){return Ze.LastCreatedEngine}static get LastCreatedScene(){return Ze.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise((s,r)=>{const n=new Image;n.onload=()=>{n.decode().then(()=>{this.createImageBitmap(n,t).then(a=>{s(a)})})},n.onerror=()=>{r(`Error loading image ${n.src}`)},n.src=e})}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const r=this.createCanvas(t,i).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");return r.drawImage(e,0,0),r.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<H.Instances.length;i++){const s=H.Instances[i];for(let r=0;r<s.scenes.length;r++)s.scenes[r].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw ke("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!H._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(e,t,i,s=!1){if(super(e,t,i,s),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=[],this._virtualScenes=new Array,this.onNewSceneAddedObservable=new j,this.postProcesses=[],this.isPointerLock=!1,this.onResizeObservable=new j,this.onCanvasBlurObservable=new j,this.onCanvasFocusObservable=new j,this.onCanvasPointerOutObservable=new j,this.onBeginFrameObservable=new j,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new j,this.onBeforeShaderCompilationObservable=new j,this.onAfterShaderCompilationObservable=new j,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new ur,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new n0,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],H.Instances.push(this),!!e&&(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext)){const r=e;this._sharedInit(r)}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=i=>{this.disableContextMenu&&i.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=i=>{document.elementFromPoint(i.clientX,i.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(i)};const t=this.getHostWindow();t&&typeof t.addEventListener=="function"&&(t.addEventListener("blur",this._onBlur),t.addEventListener("focus",this._onFocus)),e.addEventListener("pointerout",this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!H.audioEngine&&this._creationOptions.audioEngine&&H.AudioEngineFactory&&(H.audioEngine=H.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),ih()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&e&&H._RequestPointerlock(e)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1)),this.enableOfflineSupport=H.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var e;(e=this._onPointerLockChange)===null||e===void 0||e.call(this)}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,s){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,s),r}scissorClear(e,t,i,s,r){this.enableScissor(e,t,i,s),this.clear(r,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,s){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,i,s)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}_loadFileAsync(e,t,i){return new Promise((s,r)=>{this._loadFile(e,n=>{s(n)},void 0,t,i,(n,a)=>{r(a)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,s){e!==void 0&&(t&&(this._boundUniforms[e]=t),!i||!i.depthStencilTexture?this._setTexture(e,null,void 0,void 0,s):this._setTexture(e,i,!1,!0,s))}setTextureFromPostProcess(e,t,i){var s;let r=null;t&&(t._forcedOutputTexture?r=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(r=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,(s=r==null?void 0:r.texture)!==null&&s!==void 0?s:null,i)}setTextureFromPostProcessOutput(e,t,i){var s,r;this._bindTexture(e,(r=(s=t==null?void 0:t._outputTexture)===null||s===void 0?void 0:s.texture)!==null&&r!==void 0?r:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_cancelFrame(){if(this._renderingQueueLaunched&&this.customAnimationFrameRequester){this._renderingQueueLaunched=!1;const{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}else super._cancelFrame()}_renderLoop(){if(!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&H._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&H._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&H._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){H._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this.onEndFrameObservable.notifyObservers(this)}setSize(e,t,i=!1){if(!this._renderingCanvas||!super.setSize(e,t,i))return!1;if(this.scenes){for(let s=0;s<this.scenes.length;s++){const r=this.scenes[s];for(let n=0;n<r.cameras.length;n++){const a=r.cameras[n];a._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const a=super.createShaderProgram(e,t,i,s,r,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),a}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(s.attachShader(n,t),s.attachShader(n,i),this.webGLVersion>1&&r){const a=this.createTransformFeedback();this.bindTransformFeedback(a),this.setTranformFeedbackVaryings(n,r),e.transformFeedback=a}return s.linkProgram(n),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(i=>{i._outputTexture===e&&(i._outputTexture=null)}),t.cameras.forEach(i=>{i._postProcesses.forEach(s=>{s&&s._outputTexture===e&&(s._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++H._RenderPassIdCounter;return this._renderPassNames[t]=e??"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let s=0;s<i.meshes.length;++s){const r=i.meshes[s];if(r.subMeshes)for(let n=0;n<r.subMeshes.length;++n)r.subMeshes[n]._removeDrawWrapper(e)}}}_rescaleTexture(e,t,i,s,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&H._RescalePostProcessFactory&&(this._rescalePostProcess=H._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",e)};let a=i;a||(a=this.scenes[this.scenes.length-1]),a.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),r&&r()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e,t=!1,i=3,s=0,r=0){const n=new Em(e,this._gl),a=new wi(this,At.Unknown,!0);return a._hardwareTexture=n,a.baseWidth=s,a.baseHeight=r,a.width=s,a.height=r,a.isReady=!0,a.useMipMaps=t,this.updateTextureSamplingMode(i,a),a}_uploadImageToTexture(e,t,i=0,s=0){const r=this._gl,n=this._getWebGLTextureType(e.type),a=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,a),h=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(h,e,!0),this._unpackFlipY(e.invertY);let c=r.TEXTURE_2D;e.isCube&&(c=r.TEXTURE_CUBE_MAP_POSITIVE_X+i),r.texImage2D(c,s,l,a,n,t),this._bindTextureDirectly(h,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){q.Error("WebGL 1 does not support texture comparison.");return}const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new fh(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const s=this._gl;return new Promise((r,n)=>{const a=()=>{const l=s.clientWaitSync(e,t,0);if(l==s.WAIT_FAILED){n();return}if(l==s.TIMEOUT_EXPIRED){setTimeout(a,i);return}r()};a()})}_readPixelsAsync(e,t,i,s,r,n,a){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,h=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.bufferData(l.PIXEL_PACK_BUFFER,a.byteLength,l.STREAM_READ),l.readPixels(e,t,i,s,r,n,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const c=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return c?(l.flush(),this._clientWaitAsync(c,0,10).then(()=>(l.deleteSync(c),l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,a),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(h),a))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();Ze.Instances.length===1&&H.audioEngine&&(H.audioEngine.dispose(),H.audioEngine=null);const e=this.getHostWindow();e&&typeof e.removeEventListener=="function"&&(e.removeEventListener("blur",this._onBlur),e.removeEventListener("focus",this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),ih()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)),super.dispose();const t=Ze.Instances.indexOf(this);t>=0&&Ze.Instances.splice(t,1),H.Instances.length||Ze.OnEnginesDisposedObservable.notifyObservers(this),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!Fi())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!Fi())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=H.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){if(e.requestPointerLock){const t=e.requestPointerLock();t instanceof Promise?t.then(()=>{e.focus()}).catch(()=>{}):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(t),s.appendChild(i),document.body.appendChild(s);let r=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",r=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(s)}return{ascent:r,height:n,descent:n-r}}}H.ALPHA_DISABLE=0;H.ALPHA_ADD=1;H.ALPHA_COMBINE=2;H.ALPHA_SUBTRACT=3;H.ALPHA_MULTIPLY=4;H.ALPHA_MAXIMIZED=5;H.ALPHA_ONEONE=6;H.ALPHA_PREMULTIPLIED=7;H.ALPHA_PREMULTIPLIED_PORTERDUFF=8;H.ALPHA_INTERPOLATE=9;H.ALPHA_SCREENMODE=10;H.DELAYLOADSTATE_NONE=0;H.DELAYLOADSTATE_LOADED=1;H.DELAYLOADSTATE_LOADING=2;H.DELAYLOADSTATE_NOTLOADED=4;H.NEVER=512;H.ALWAYS=519;H.LESS=513;H.EQUAL=514;H.LEQUAL=515;H.GREATER=516;H.GEQUAL=518;H.NOTEQUAL=517;H.KEEP=7680;H.REPLACE=7681;H.INCR=7682;H.DECR=7683;H.INVERT=5386;H.INCR_WRAP=34055;H.DECR_WRAP=34056;H.TEXTURE_CLAMP_ADDRESSMODE=0;H.TEXTURE_WRAP_ADDRESSMODE=1;H.TEXTURE_MIRROR_ADDRESSMODE=2;H.TEXTUREFORMAT_ALPHA=0;H.TEXTUREFORMAT_LUMINANCE=1;H.TEXTUREFORMAT_LUMINANCE_ALPHA=2;H.TEXTUREFORMAT_RGB=4;H.TEXTUREFORMAT_RGBA=5;H.TEXTUREFORMAT_RED=6;H.TEXTUREFORMAT_R=6;H.TEXTUREFORMAT_RG=7;H.TEXTUREFORMAT_RED_INTEGER=8;H.TEXTUREFORMAT_R_INTEGER=8;H.TEXTUREFORMAT_RG_INTEGER=9;H.TEXTUREFORMAT_RGB_INTEGER=10;H.TEXTUREFORMAT_RGBA_INTEGER=11;H.TEXTURETYPE_UNSIGNED_BYTE=0;H.TEXTURETYPE_UNSIGNED_INT=0;H.TEXTURETYPE_FLOAT=1;H.TEXTURETYPE_HALF_FLOAT=2;H.TEXTURETYPE_BYTE=3;H.TEXTURETYPE_SHORT=4;H.TEXTURETYPE_UNSIGNED_SHORT=5;H.TEXTURETYPE_INT=6;H.TEXTURETYPE_UNSIGNED_INTEGER=7;H.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;H.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;H.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;H.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;H.TEXTURETYPE_UNSIGNED_INT_24_8=12;H.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;H.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;H.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;H.TEXTURE_NEAREST_SAMPLINGMODE=1;H.TEXTURE_BILINEAR_SAMPLINGMODE=2;H.TEXTURE_TRILINEAR_SAMPLINGMODE=3;H.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;H.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;H.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;H.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;H.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;H.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;H.TEXTURE_NEAREST_LINEAR=7;H.TEXTURE_NEAREST_NEAREST=1;H.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;H.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;H.TEXTURE_LINEAR_LINEAR=2;H.TEXTURE_LINEAR_NEAREST=12;H.TEXTURE_EXPLICIT_MODE=0;H.TEXTURE_SPHERICAL_MODE=1;H.TEXTURE_PLANAR_MODE=2;H.TEXTURE_CUBIC_MODE=3;H.TEXTURE_PROJECTION_MODE=4;H.TEXTURE_SKYBOX_MODE=5;H.TEXTURE_INVCUBIC_MODE=6;H.TEXTURE_EQUIRECTANGULAR_MODE=7;H.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;H.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;H.SCALEMODE_FLOOR=1;H.SCALEMODE_NEAREST=2;H.SCALEMODE_CEILING=3;H._RescalePostProcessFactory=null;H._RenderPassIdCounter=0;class La{constructor(e,t,i,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=s}}class bh{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;(t=e.getScene())===null||t===void 0||t.getEngine().flushFramebuffer();const i=e.getSize().width,s=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let n,a;e.isRenderTarget?(n=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(n=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));const l=e.readPixels(4,void 0,void 0,!1),h=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace,u=5;let d=0;return(e.textureType==1||e.textureType==2)&&(d=1),new Promise(f=>{Promise.all([r,s,n,a,l,h]).then(([p,_,g,E,R,x])=>{const S={size:i,right:_,left:p,up:g,down:E,front:R,back:x,format:u,type:d,gammaSpace:c};f(this.ConvertCubeMapToSphericalPolynomial(S))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new Qa;let i=0;const s=2/e.size,r=s,n=.5*s,a=n-1;for(let d=0;d<6;d++){const f=this._FileFaces[d],p=e[f.name];let _=a;const g=e.format===5?4:3;for(let E=0;E<e.size;E++){let R=a;for(let x=0;x<e.size;x++){const S=f.worldAxisForFileX.scale(R).add(f.worldAxisForFileY.scale(_)).add(f.worldAxisForNormal);S.normalize();const b=this._AreaElement(R-n,_-n)-this._AreaElement(R-n,_+n)-this._AreaElement(R+n,_-n)+this._AreaElement(R+n,_+n);let y=p[E*e.size*g+x*g+0],I=p[E*e.size*g+x*g+1],O=p[E*e.size*g+x*g+2];isNaN(y)&&(y=0),isNaN(I)&&(I=0),isNaN(O)&&(O=0),e.type===0&&(y/=255,I/=255,O/=255),e.gammaSpace&&(y=Math.pow(Te.Clamp(y),Cc),I=Math.pow(Te.Clamp(I),Cc),O=Math.pow(Te.Clamp(O),Cc));const N=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const G=Math.max(y,I,O);if(G>N){const k=N/G;y*=k,I*=k,O*=k}}else y=Te.Clamp(y,0,N),I=Te.Clamp(I,0,N),O=Te.Clamp(O,0,N);const w=new J(y,I,O);t.addLight(S,w,b),i+=b,R+=s}_+=r}}const u=4*Math.PI*6/6/i;return t.scaleInPlace(u),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),Tn.FromHarmonics(t)}}bh._FileFaces=[new La("right",new m(1,0,0),new m(0,0,-1),new m(0,-1,0)),new La("left",new m(-1,0,0),new m(0,0,1),new m(0,-1,0)),new La("up",new m(0,1,0),new m(1,0,0),new m(0,0,1)),new La("down",new m(0,-1,0),new m(1,0,0),new m(0,0,-1)),new La("front",new m(0,0,1),new m(1,0,0),new m(0,-1,0)),new La("back",new m(0,0,-1),new m(-1,0,0),new m(0,-1,0))];bh.MAX_HDRI_VALUE=4096;bh.PRESERVE_CLAMPED_COLORS=!1;function v(o,e,t,i){var s=arguments.length,r=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(n=o[a])&&(r=(s<3?n(r):s>3?n(e,t,r):n(e,t))||r);return s>3&&r&&Object.defineProperty(e,t,r),r}class $n{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),$n._HandleParenthesisContent(i,t))):e=$n._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:$n.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(r=>r==="true");let i;const s=e.split("||");for(const r in s)if(Object.prototype.hasOwnProperty.call(s,r)){let n=$n._SimplifyNegation(s[r].trim());const a=n.split("&&");if(a.length>1)for(let l=0;l<a.length;++l){const h=$n._SimplifyNegation(a[l].trim());if(h!=="true"&&h!=="false"?h[0]==="!"?i=!t(h.substring(1)):i=t(h):i=h==="true",!i){n="false";break}}if(i||n==="true"){i=!0;break}n!=="true"&&n!=="false"?n[0]==="!"?i=!t(n.substring(1)):i=t(n):i=n==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class ot{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>ot.HasTags(e),e.addTags=t=>ot.AddTagsTo(e,t),e.removeTags=t=>ot.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>ot.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const s in e._tags)Object.prototype.hasOwnProperty.call(e._tags,s)&&e._tags[s]===!0&&i.push(s);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(s){ot._AddTagTo(e,s)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(ot.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!ot.HasTags(e))return;const i=t.split(" ");for(const s in i)ot._RemoveTagFrom(e,i[s])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?ot.HasTags(e):$n.Eval(t,i=>ot.HasTags(e)&&e._tags[i])}}const xc={},Ac={},Np=function(o,e,t,i={}){const s=o();ot&&ot.HasTags(e)&&ot.AddTagsTo(s,ot.GetTags(e,!0));const r=Ed(s),n={};for(const a in r){const l=r[a],h=e[a],c=l.type;if(h!=null&&(a!=="uniqueId"||Le.AllowLoadingUniqueId))switch(c){case 0:case 6:case 11:s[a]=h;break;case 1:i.cloneTexturesOnlyOnce&&n[h.uniqueId]?s[a]=n[h.uniqueId]:(s[a]=t||h.isRenderTarget?h:h.clone(),n[h.uniqueId]=s[a]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:s[a]=t?h:h.clone();break}}return s};function l0(o){const e=o.getClassName();return xc[e]||(xc[e]={}),xc[e]}function Ed(o){const e=o.getClassName();if(Ac[e])return Ac[e];Ac[e]={};const t=Ac[e];let i=o,s=e;for(;s;){const r=xc[s];for(const l in r)t[l]=r[l];let n,a=!1;do{if(n=Object.getPrototypeOf(i),!n.getClassName){a=!0;break}if(n.getClassName()!==s)break;i=n}while(n);if(a)break;s=n.getClassName(),i=n}return t}function Hs(o,e){return(t,i)=>{const s=l0(t);s[i]||(s[i]={type:o,sourceName:e})}}function h0(o,e=null){return(t,i)=>{const s=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[s]},set:function(r){typeof this.equals=="function"&&this.equals(r)||this[s]!==r&&(this[s]=r,t[o].apply(this))},enumerable:!0,configurable:!0})}}function Z(o,e=null){return h0(o,e)}function M(o){return Hs(0,o)}function rt(o){return Hs(1,o)}function oi(o){return Hs(2,o)}function Sh(o){return Hs(3,o)}function Af(o){return Hs(4,o)}function zi(o){return Hs(5,o)}function Rf(o){return Hs(6,o)}function c0(o){return Hs(7,o)}function Tm(o){return Hs(8,o)}function vm(o){return Hs(9,o)}function u0(o){return Hs(10,o)}function Am(o){return Hs(12,o)}class Le{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const s=e.animations[i];t.animations.push(s.serialize())}}}static Serialize(e,t){t||(t={}),ot&&(t.tags=ot.GetTags(e));const i=Ed(e);for(const s in i){const r=i[s],n=r.sourceName||s,a=r.type,l=e[s];if(l!=null&&(s!=="uniqueId"||Le.AllowLoadingUniqueId))switch(a){case 0:t[n]=l;break;case 1:t[n]=l.serialize();break;case 2:t[n]=l.asArray();break;case 3:t[n]=l.serialize();break;case 4:t[n]=l.asArray();break;case 5:t[n]=l.asArray();break;case 6:t[n]=l.id;break;case 7:t[n]=l.serialize();break;case 8:t[n]=l.asArray();break;case 9:t[n]=l.serialize();break;case 10:t[n]=l.asArray();break;case 11:t[n]=l.id;break;case 12:t[n]=l.asArray();break}}return t}static ParseProperties(e,t,i,s){s||(s="");const r=Ed(t);for(const n in r){const a=r[n],l=e[a.sourceName||n],h=a.type;if(l!=null&&(n!=="uniqueId"||Le.AllowLoadingUniqueId)){const c=t;switch(h){case 0:c[n]=l;break;case 1:i&&(c[n]=Le._TextureParser(l,i,s));break;case 2:c[n]=J.FromArray(l);break;case 3:c[n]=Le._FresnelParametersParser(l);break;case 4:c[n]=Ke.FromArray(l);break;case 5:c[n]=m.FromArray(l);break;case 6:i&&(c[n]=i.getLastMeshById(l));break;case 7:c[n]=Le._ColorCurvesParser(l);break;case 8:c[n]=He.FromArray(l);break;case 9:c[n]=Le._ImageProcessingConfigurationParser(l);break;case 10:c[n]=le.FromArray(l);break;case 11:i&&(c[n]=i.getCameraById(l));break;case 12:c[n]=L.FromArray(l);break}}}}static Parse(e,t,i,s=null){const r=e();return ot&&ot.AddTagsTo(r,t.tags),Le.ParseProperties(t,r,i,s),r}static Clone(e,t,i={}){return Np(e,t,!1,i)}static Instanciate(e,t){return Np(e,t,!0)}}Le.AllowLoadingUniqueId=!1;Le._ImageProcessingConfigurationParser=o=>{throw ke("ImageProcessingConfiguration")};Le._FresnelParametersParser=o=>{throw ke("FresnelParameters")};Le._ColorCurvesParser=o=>{throw ke("ColorCurves")};Le._TextureParser=(o,e,t)=>{throw ke("Texture")};function vn(o,e,t,i){const s=t.value;t.value=(...r)=>{let n=s;if(typeof _native<"u"&&_native[e]){const a=_native[e];i?n=(...l)=>i(...l)?a(...l):s(...l):n=a}return o[e]=n,n(...r)}}vn.filter=function(o){return(e,t,i)=>vn(e,t,i,o)};function Qs(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const e=Math.random()*16|0;return(o==="x"?e:e&3|8).toString(16)})}function d0(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class Pi{constructor(){this._xhr=d0(),this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(Pi.CustomRequestHeaders).length>0||Pi.CustomRequestModifiers.length>0}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Pi.CustomRequestHeaders){const t=Pi.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return Pi.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){Pi.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of Pi.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}return t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}Pi.CustomRequestHeaders={};Pi.CustomRequestModifiers=new Array;Pi.SkipRequestModificationForBabylonCDN=!0;class rh{}rh.FilesToLoad={};class f0{static ExponentialBackoff(e=3,t=500){return(i,s,r)=>s.status!==0||r>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,r)*t}}class Ja extends Error{}Ja._setPrototypeOf=Object.setPrototypeOf||((o,e)=>(o.__proto__=e,o));const pn={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class fr extends Ja{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Ja._setPrototypeOf(this,fr.prototype)}}const _0=o=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(o);let e="";for(let t=0;t<o.byteLength;t++)e+=String.fromCharCode(o[t]);return e},Rm=o=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",i,s,r,n,a,l,h,c=0;const u=ArrayBuffer.isView(o)?new Uint8Array(o.buffer,o.byteOffset,o.byteLength):new Uint8Array(o);for(;c<u.length;)i=u[c++],s=c<u.length?u[c++]:Number.NaN,r=c<u.length?u[c++]:Number.NaN,n=i>>2,a=(i&3)<<4|s>>4,l=(s&15)<<2|r>>6,h=r&63,isNaN(s)?l=h=64:isNaN(r)&&(h=64),t+=e.charAt(n)+e.charAt(a)+e.charAt(l)+e.charAt(h);return t},bm=o=>atob(o),p0=o=>{const e=bm(o),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let s=0;s<t;s++)i[s]=e.charCodeAt(s);return i.buffer};class Ic{static SetImmediate(e){Fi()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const Sm=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class _h extends fr{constructor(e,t){super(e,pn.LoadFileError),this.name="LoadFileError",Ja._setPrototypeOf(this,_h.prototype),t instanceof Pi?this.request=t:this.file=t}}class Pc extends fr{constructor(e,t){super(e,pn.RequestFileError),this.request=t,this.name="RequestFileError",Ja._setPrototypeOf(this,Pc.prototype)}}class bf extends fr{constructor(e,t){super(e,pn.ReadFileError),this.file=t,this.name="ReadFileError",Ja._setPrototypeOf(this,bf.prototype)}}const fi={DefaultRetryStrategy:f0.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:o=>o,ScriptBaseUrl:"",ScriptPreprocessUrl:o=>o},ym=o=>(o=o.replace(/#/gm,"%23"),o),Sf=(o,e)=>{if(!(o&&o.indexOf("data:")===0)&&fi.CorsBehavior)if(typeof fi.CorsBehavior=="string"||fi.CorsBehavior instanceof String)e.crossOrigin=fi.CorsBehavior;else{const t=fi.CorsBehavior(o);t&&(e.crossOrigin=t)}},Wc=(o,e,t,i,s="",r)=>{const n=Ze.LastCreatedEngine;if(typeof HTMLImageElement>"u"&&!(n!=null&&n._features.forceBitmapOverHTMLImageElement))return t("LoadImage is only supported in web or BabylonNative environments."),null;let a,l=!1;o instanceof ArrayBuffer||ArrayBuffer.isView(o)?typeof Blob<"u"&&typeof URL<"u"?(a=URL.createObjectURL(new Blob([o],{type:s})),l=!0):a=`data:${s};base64,`+Rm(o):o instanceof Blob?(a=URL.createObjectURL(o),l=!0):(a=ym(o),a=fi.PreprocessUrl(o));const h=b=>{if(t){const y=a||o.toString();t(`Error while trying to load image: ${y.indexOf("http")===0||y.length<=128?y:y.slice(0,128)+"..."}`,b)}};if(n!=null&&n._features.forceBitmapOverHTMLImageElement)return An(a,b=>{n.createImageBitmap(new Blob([b],{type:s}),Object.assign({premultiplyAlpha:"none"},r)).then(y=>{e(y),l&&URL.revokeObjectURL(a)}).catch(y=>{t&&t("Error while trying to load image: "+o,y)})},void 0,i||void 0,!0,(b,y)=>{h(y)}),null;const c=new Image;Sf(a,c);const u=[],d=()=>{u.forEach(b=>{b.target.addEventListener(b.name,b.handler)})},f=()=>{u.forEach(b=>{b.target.removeEventListener(b.name,b.handler)}),u.length=0},p=()=>{f(),e(c),l&&c.src&&URL.revokeObjectURL(c.src)},_=b=>{f(),h(b),l&&c.src&&URL.revokeObjectURL(c.src)},g=b=>{if(b.blockedURI!==c.src)return;f();const y=new Error(`CSP violation of policy ${b.effectiveDirective} ${b.blockedURI}. Current policy is ${b.originalPolicy}`);Ze.UseFallbackTexture=!1,h(y),l&&c.src&&URL.revokeObjectURL(c.src),c.src=""};u.push({target:c,name:"load",handler:p}),u.push({target:c,name:"error",handler:_}),u.push({target:document,name:"securitypolicyviolation",handler:g}),d();const E=a.substring(0,5)==="blob:",R=a.substring(0,5)==="data:",x=()=>{E||R||!Pi.IsCustomRequestAvailable?c.src=a:An(a,(b,y,I)=>{const O=!s&&I?I:s,N=new Blob([b],{type:O}),w=URL.createObjectURL(N);l=!0,c.src=w},void 0,i||void 0,!0,(b,y)=>{h(y)})},S=()=>{i&&i.loadImage(a,c)};if(!E&&!R&&i&&i.enableTexturesOffline)i.open(S,x);else{if(a.indexOf("file:")!==-1){const b=decodeURIComponent(a.substring(5).toLowerCase());if(rh.FilesToLoad[b]&&typeof URL<"u"){try{let y;try{y=URL.createObjectURL(rh.FilesToLoad[b])}catch{y=URL.createObjectURL(rh.FilesToLoad[b])}c.src=y,l=!0}catch{c.src=""}return c}}x()}return c},ph=(o,e,t,i,s)=>{const r=new FileReader,n={onCompleteObservable:new j,abort:()=>r.abort()};return r.onloadend=()=>n.onCompleteObservable.notifyObservers(n),s&&(r.onerror=()=>{s(new bf(`Unable to read ${o.name}`,o))}),r.onload=a=>{e(a.target.result)},t&&(r.onprogress=t),i?r.readAsArrayBuffer(o):r.readAsText(o),n},An=(o,e,t,i,s,r,n)=>{if(o.name)return ph(o,e,t,s,r?c=>{r(void 0,c)}:void 0);const a=o;if(a.indexOf("file:")!==-1){let c=decodeURIComponent(a.substring(5).toLowerCase());c.indexOf("./")===0&&(c=c.substring(2));const u=rh.FilesToLoad[c];if(u)return ph(u,e,t,s,r?d=>r(void 0,new _h(d.message,d.file)):void 0)}const{match:l,type:h}=g0(a);if(l){const c={onCompleteObservable:new j,abort:()=>()=>{}};try{const u=s?yh(a):xm(a);e(u,void 0,h)}catch(u){r?r(void 0,u):q.Error(u.message||"Failed to parse the Data URL")}return Ic.SetImmediate(()=>{c.onCompleteObservable.notifyObservers(c)}),c}return yf(a,(c,u)=>{e(c,u==null?void 0:u.responseURL,u==null?void 0:u.getResponseHeader("content-type"))},t,i,s,r?c=>{r(c.request,new _h(c.message,c.request))}:void 0,n)},yf=(o,e,t,i,s,r,n)=>{o=ym(o),o=fi.PreprocessUrl(o);const a=fi.BaseUrl+o;let l=!1;const h={onCompleteObservable:new j,abort:()=>l=!0},c=()=>{let u=new Pi,d=null,f;const p=()=>{u&&(t&&u.removeEventListener("progress",t),f&&u.removeEventListener("readystatechange",f),u.removeEventListener("loadend",_))};let _=()=>{p(),h.onCompleteObservable.notifyObservers(h),h.onCompleteObservable.clear(),t=void 0,f=null,_=null,r=void 0,n=void 0,e=void 0};h.abort=()=>{l=!0,_&&_(),u&&u.readyState!==(XMLHttpRequest.DONE||4)&&u.abort(),d!==null&&(clearTimeout(d),d=null),u=null};const g=R=>{const x=R.message||"Unknown error";r&&u?r(new Pc(x,u)):q.Error(x)},E=R=>{if(u){if(u.open("GET",a),n)try{n(u)}catch(x){g(x);return}s&&(u.responseType="arraybuffer"),t&&u.addEventListener("progress",t),_&&u.addEventListener("loadend",_),f=()=>{if(!(l||!u)&&u.readyState===(XMLHttpRequest.DONE||4)){if(f&&u.removeEventListener("readystatechange",f),u.status>=200&&u.status<300||u.status===0&&(!Fi()||Cm())){try{e&&e(s?u.response:u.responseText,u)}catch(b){g(b)}return}const x=fi.DefaultRetryStrategy;if(x){const b=x(a,u,R);if(b!==-1){p(),u=new Pi,d=setTimeout(()=>E(R+1),b);return}}const S=new Pc("Error status: "+u.status+" "+u.statusText+" - Unable to load "+a,u);r&&r(S)}},u.addEventListener("readystatechange",f),u.send()}};E(0)};if(i&&i.enableSceneOffline){const u=f=>{f&&f.status>400?r&&r(f):c()},d=()=>{i&&i.loadFile(fi.BaseUrl+o,f=>{!l&&e&&e(f),h.onCompleteObservable.notifyObservers(h)},t?f=>{!l&&t&&t(f)}:void 0,u,s)};i.open(d,u)}else c();return h},Cm=()=>typeof location<"u"&&location.protocol==="file:",Xc=o=>Sm.test(o),g0=o=>{const e=Sm.exec(o);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function yh(o){return p0(o.split(",")[1])}const xm=o=>bm(o.split(",")[1]),m0=()=>{Ie._FileToolsLoadImage=Wc,Ie._FileToolsLoadFile=An,cr._FileToolsLoadFile=An};m0();let Yl;const E0=(o,e,t,i,s,r,n,a,l,h)=>{Yl={DecodeBase64UrlToBinary:o,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:s,LoadFile:r,LoadImage:n,ReadFile:a,RequestFile:l,SetCorsBehavior:h},Object.defineProperty(Yl,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(c){t.DefaultRetryStrategy=c}}),Object.defineProperty(Yl,"BaseUrl",{get:function(){return t.BaseUrl},set:function(c){t.BaseUrl=c}}),Object.defineProperty(Yl,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(c){t.PreprocessUrl=c}}),Object.defineProperty(Yl,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(c){t.CorsBehavior=c}})};E0(yh,xm,fi,Xc,Cm,An,Wc,ph,yf,Sf);class Qn{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return(e==null?void 0:e._shareDepth)!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=xs.Zero(),this._cachedBaseSize=xs.Zero(),this._initialSamplingMode=2,this._texture=Qn._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class bt extends Qn{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){var t;if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}(t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this))}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){var t;e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),(t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Qs()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=bt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new j,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?bt._IsScene(e)?this._scene=e:this._engine=e:this._scene=Ze.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return e!==null}getTextureMatrix(){return L.IdentityReadOnly}getReflectionTextureMatrix(){return L.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,s,r,n){const a=this._getEngine();if(!a)return null;const l=a._getUseSRGBBuffer(!!r,t),h=a.getLoadedTexturesCache();for(let c=0;c<h.length;c++){const u=h[c];if((r===void 0||l===u._useSRGBBuffer)&&(s===void 0||s===u.invertY)&&u.url===e&&u.generateMipMaps===!t&&(!i||i===u.samplingMode)&&(n===void 0||n===u.isCube))return u.incrementReferences(),u}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,s=!0,r=!1,n=0,a=0,l=Number.MAX_VALUE,h=Number.MAX_VALUE){if(!this._texture)return null;const c=this._getEngine();if(!c)return null;const u=this.getSize();let d=u.width,f=u.height;t!==0&&(d=d/Math.pow(2,t),f=f/Math.pow(2,t),d=Math.round(d),f=Math.round(f)),l=Math.min(d,l),h=Math.min(f,h);try{return this._texture.isCube?c._readTexturePixels(this._texture,l,h,e,t,i,s,r,n,a):c._readTexturePixels(this._texture,l,h,-1,t,i,s,r,n,a)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,s=!0,r=!1){if(!this._texture)return null;const n=this.getSize();let a=n.width,l=n.height;const h=this._getEngine();if(!h)return null;t!=0&&(a=a/Math.pow(2,t),l=l/Math.pow(2,t),a=Math.round(a),l=Math.round(l));try{return this._texture.isCube?h._readTexturePixelsSync(this._texture,a,l,e,t,i,s,r):h._readTexturePixelsSync(this._texture,a,l,-1,t,i,s,r)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;const t=Le.Serialize(this);return Le.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let s=0;s<e.length;s++){const r=e[s];if(r.isReady())--i===0&&t();else{const n=r.onLoadObservable;n?n.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}bt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;v([M()],bt.prototype,"uniqueId",void 0);v([M()],bt.prototype,"name",void 0);v([M()],bt.prototype,"metadata",void 0);v([M("hasAlpha")],bt.prototype,"_hasAlpha",void 0);v([M("getAlphaFromRGB")],bt.prototype,"_getAlphaFromRGB",void 0);v([M()],bt.prototype,"level",void 0);v([M("coordinatesIndex")],bt.prototype,"_coordinatesIndex",void 0);v([M()],bt.prototype,"optimizeUVAllocation",void 0);v([M("coordinatesMode")],bt.prototype,"_coordinatesMode",void 0);v([M()],bt.prototype,"wrapU",null);v([M()],bt.prototype,"wrapV",null);v([M()],bt.prototype,"wrapR",void 0);v([M()],bt.prototype,"anisotropicFilteringLevel",void 0);v([M()],bt.prototype,"isCube",null);v([M()],bt.prototype,"is3D",null);v([M()],bt.prototype,"is2DArray",null);v([M()],bt.prototype,"gammaSpace",null);v([M()],bt.prototype,"invertZ",void 0);v([M()],bt.prototype,"lodLevelInAlpha",void 0);v([M()],bt.prototype,"lodGenerationOffset",null);v([M()],bt.prototype,"lodGenerationScale",null);v([M()],bt.prototype,"linearSpecularLOD",null);v([rt()],bt.prototype,"irradianceTexture",null);v([M()],bt.prototype,"isRenderTarget",void 0);class nh{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=Gr(e);if(t)return t;q.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let s=window||this;for(let r=0,n=i.length;r<n;r++)s=s[i[r]];return typeof s!="function"?null:s}}nh.RegisteredExternalClasses={};function Mm(o,e,t=!1){const i=e.width,s=e.height;if(o instanceof Float32Array){let h=o.byteLength/o.BYTES_PER_ELEMENT;const c=new Uint8Array(h);for(;--h>=0;){let u=o[h];u<0?u=0:u>1&&(u=1),c[h]=u*255}o=c}const r=document.createElement("canvas");r.width=i,r.height=s;const n=r.getContext("2d");if(!n)return null;const a=n.createImageData(i,s);if(a.data.set(o),n.putImageData(a,0,0),t){const h=document.createElement("canvas");h.width=i,h.height=s;const c=h.getContext("2d");return c?(c.translate(0,s),c.scale(1,-1),c.drawImage(r,0,0),h.toDataURL("image/png")):null}return r.toDataURL("image/png")}function T0(o,e=0,t=0){const i=o.getInternalTexture();if(!i)return null;const s=o._readPixelsSync(e,t);return s?Mm(s,o.getSize(),i.invertY):null}async function v0(o,e=0,t=0){const i=o.getInternalTexture();if(!i)return null;const s=await o.readPixels(e,t);return s?Mm(s,o.getSize(),i.invertY):null}class Dt{}Dt.UseOpenGLOrientationForUV=!1;class V extends bt{static _CreateVideoTexture(e,t,i,s=!1,r=!1,n=V.TRILINEAR_SAMPLINGMODE,a={},l,h=5){throw ke("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,s,r=V.TRILINEAR_SAMPLINGMODE,n=null,a=null,l=null,h=!1,c,u,d,f,p){var _,g,E,R,x,S,b,y,I,O;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new j,this._isBlocking=!0,this.name=e||"",this.url=e;let N,w=!1,G=null,k=!0;typeof i=="object"&&i!==null?(N=(_=i.noMipmap)!==null&&_!==void 0?_:!1,s=(g=i.invertY)!==null&&g!==void 0?g:!Dt.UseOpenGLOrientationForUV,r=(E=i.samplingMode)!==null&&E!==void 0?E:V.TRILINEAR_SAMPLINGMODE,n=(R=i.onLoad)!==null&&R!==void 0?R:null,a=(x=i.onError)!==null&&x!==void 0?x:null,l=(S=i.buffer)!==null&&S!==void 0?S:null,h=(b=i.deleteBuffer)!==null&&b!==void 0?b:!1,c=i.format,u=i.mimeType,d=i.loaderOptions,f=i.creationFlags,w=(y=i.useSRGBBuffer)!==null&&y!==void 0?y:!1,G=(I=i.internalTexture)!==null&&I!==void 0?I:null,k=(O=i.gammaSpace)!==null&&O!==void 0?O:k):N=!!i,this._gammaSpace=k,this._noMipmap=N,this._invertY=s===void 0?!Dt.UseOpenGLOrientationForUV:s,this._initialSamplingMode=r,this._buffer=l,this._deleteBuffer=h,this._mimeType=u,this._loaderOptions=d,this._creationFlags=f,this._useSRGBBuffer=w,this._forcedExtension=p,c&&(this._format=c);const de=this.getScene(),ae=this._getEngine();if(!ae)return;ae.onBeforeTextureInitObservable.notifyObservers(this);const _e=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),n&&n(),!this.isBlocking&&de&&de.resetCachedMaterial()},Ce=(ce,ze)=>{this._loadingError=!0,this._errorObject={message:ce,exception:ze},a&&a(ce,ze),V.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!G){this._delayedOnLoad=_e,this._delayedOnError=Ce;return}if(this._texture=G??this._getFromCache(this.url,N,r,this._invertY,w,this.isCube),this._texture)if(this._texture.isReady)Ic.SetImmediate(()=>_e());else{const ce=this._texture.onLoadedObservable.add(_e);this._texture.onErrorObservable.add(ze=>{var We;Ce(ze.message,ze.exception),(We=this._texture)===null||We===void 0||We.onLoadedObservable.remove(ce)})}else if(!de||!de.useDelayedTextureLoading){try{this._texture=ae.createTexture(this.url,N,this._invertY,de,r,_e,Ce,this._buffer,void 0,this._format,this._forcedExtension,u,d,f,w)}catch(ce){throw Ce("error loading",ce),ce}h&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=_e,this._delayedOnError=Ce}updateURL(e,t=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,r=>r.hasTexture(this))),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=s,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?Ic.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,s){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,m.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return e!==null&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=L.Zero(),this._rowGenerationMatrix=new L,this._t0=m.Zero(),this._t1=m.Zero(),this._t2=m.Zero()),L.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(L.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,D.Matrix[0]),L.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,D.Matrix[1]),L.ScalingToRef(this._cachedUScale,this._cachedVScale,0,D.Matrix[2]),L.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,D.Matrix[3]),D.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(D.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(D.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(D.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),L.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===V.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=L.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=L.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case V.PLANAR_MODE:{L.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case V.PROJECTION_MODE:{L.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:L.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return Le.Clone(()=>new V(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){var e,t;const i=this.name;V.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const s=super.serialize(V._SerializeInternalTextureUniqueId);return s?((V.SerializeBuffers||V.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(s.base64String=this._buffer,s.name=s.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?s.base64String="data:image/png;base64,"+Rm(this._buffer):(V.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(s.base64String=!this._engine||this._engine._features.supportSyncTextureRead?T0(this):v0(this))),s.invertY=this._invertY,s.samplingMode=this.samplingMode,s._creationFlags=this._creationFlags,s._useSRGBBuffer=this._useSRGBBuffer,V._SerializeInternalTextureUniqueId&&(s.internalTextureUniqueId=(t=(e=this._texture)===null||e===void 0?void 0:e.uniqueId)!==null&&t!==void 0?t:void 0),s.noMipmap=this._noMipmap,this.name=i,s):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){const h=nh.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&h.updateSamplingMode&&h._samplingMode&&h._samplingMode!==e.samplingMode&&h.updateSamplingMode(e.samplingMode),h}if(e.isCube&&!e.isRenderTarget)return V._CubeTextureParser(e,t,i);const s=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!s)return null;let r;if(s){const l=t.getEngine().getLoadedTexturesCache();for(const h of l)if(h.uniqueId===e.internalTextureUniqueId){r=h;break}}const n=l=>{var h;if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){const c=e.samplingMode;l&&l.samplingMode!==c&&l.updateSamplingMode(c)}if(l&&e.animations)for(let c=0;c<e.animations.length;c++){const u=e.animations[c],d=Gr("BABYLON.Animation");d&&l.animations.push(d.Parse(u))}s&&!r&&((h=l==null?void 0:l._texture)===null||h===void 0||h._setUniqueId(e.internalTextureUniqueId))};return Le.Parse(()=>{var l,h,c;let u=!0;if(e.noMipmap&&(u=!1),e.mirrorPlane){const d=V._CreateMirror(e.name,e.renderTargetSize,t,u);return d._waitingRenderList=e.renderList,d.mirrorPlane=Us.FromArray(e.mirrorPlane),n(d),d}else if(e.isRenderTarget){let d=null;if(e.isCube){if(t.reflectionProbes)for(let f=0;f<t.reflectionProbes.length;f++){const p=t.reflectionProbes[f];if(p.name===e.name)return p.cubeTexture}}else d=V._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,u,(l=e._creationFlags)!==null&&l!==void 0?l:0),d._waitingRenderList=e.renderList;return n(d),d}else if(e.isVideo){const d=V._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,u,e.invertY,e.samplingMode,e.settings||{});return n(d),d}else{let d;if(e.base64String&&!r)d=V.CreateFromBase64String(e.base64String,e.base64String,t,!u,e.invertY,e.samplingMode,()=>{n(d)},(h=e._creationFlags)!==null&&h!==void 0?h:0,(c=e._useSRGBBuffer)!==null&&c!==void 0?c:!1),d.name=e.name;else{let f;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?f=e.name:f=i+e.name,e.url&&(e.url.startsWith("data:")||V.UseSerializedUrlIfAny)&&(f=e.url);const p={noMipmap:!u,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{n(d)},internalTexture:r};d=new V(f,t,p)}return d}},e,t)}static CreateFromBase64String(e,t,i,s,r,n=V.TRILINEAR_SAMPLINGMODE,a=null,l=null,h=5,c){return new V("data:"+t,i,s,r,n,a,l,e,!1,h,void 0,void 0,c)}static LoadFromDataString(e,t,i,s=!1,r,n=!0,a=V.TRILINEAR_SAMPLINGMODE,l=null,h=null,c=5,u){return e.substr(0,5)!=="data:"&&(e="data:"+e),new V(e,i,r,n,a,l,h,t,s,c,void 0,void 0,u)}}V.SerializeBuffers=!0;V.ForceSerializeBuffers=!1;V.OnTextureLoadErrorObservable=new j;V._SerializeInternalTextureUniqueId=!1;V._CubeTextureParser=(o,e,t)=>{throw ke("CubeTexture")};V._CreateMirror=(o,e,t,i)=>{throw ke("MirrorTexture")};V._CreateRenderTargetTexture=(o,e,t,i,s)=>{throw ke("RenderTargetTexture")};V.NEAREST_SAMPLINGMODE=1;V.NEAREST_NEAREST_MIPLINEAR=8;V.BILINEAR_SAMPLINGMODE=2;V.LINEAR_LINEAR_MIPNEAREST=11;V.TRILINEAR_SAMPLINGMODE=3;V.LINEAR_LINEAR_MIPLINEAR=3;V.NEAREST_NEAREST_MIPNEAREST=4;V.NEAREST_LINEAR_MIPNEAREST=5;V.NEAREST_LINEAR_MIPLINEAR=6;V.NEAREST_LINEAR=7;V.NEAREST_NEAREST=1;V.LINEAR_NEAREST_MIPNEAREST=9;V.LINEAR_NEAREST_MIPLINEAR=10;V.LINEAR_LINEAR=2;V.LINEAR_NEAREST=12;V.EXPLICIT_MODE=0;V.SPHERICAL_MODE=1;V.PLANAR_MODE=2;V.CUBIC_MODE=3;V.PROJECTION_MODE=4;V.SKYBOX_MODE=5;V.INVCUBIC_MODE=6;V.EQUIRECTANGULAR_MODE=7;V.FIXED_EQUIRECTANGULAR_MODE=8;V.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;V.CLAMP_ADDRESSMODE=0;V.WRAP_ADDRESSMODE=1;V.MIRROR_ADDRESSMODE=2;V.UseSerializedUrlIfAny=!1;v([M()],V.prototype,"url",void 0);v([M()],V.prototype,"uOffset",void 0);v([M()],V.prototype,"vOffset",void 0);v([M()],V.prototype,"uScale",void 0);v([M()],V.prototype,"vScale",void 0);v([M()],V.prototype,"uAng",void 0);v([M()],V.prototype,"vAng",void 0);v([M()],V.prototype,"wAng",void 0);v([M()],V.prototype,"uRotationCenter",void 0);v([M()],V.prototype,"vRotationCenter",void 0);v([M()],V.prototype,"wRotationCenter",void 0);v([M()],V.prototype,"homogeneousRotationInUVTransform",void 0);v([M()],V.prototype,"isBlocking",null);Re("BABYLON.Texture",V);Le._TextureParser=V.Parse;class eo{get isDisposed(){return this._isDisposed}constructor(e,t,i,s=0,r=!1,n=!1,a=!1,l,h){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=l||1,this._label=h,t instanceof Rh?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=a?s:s*Float32Array.BYTES_PER_ELEMENT,r||this.create()}createVertexBuffer(e,t,i,s,r,n=!1,a){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,h=s?n?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new T(this._engine,this,e,this._updatable,!0,h,r===void 0?this._instanced:r,l,i,void 0,void 0,!0,this._divisor||a)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,s=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}}class T{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get totalVertices(){const e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,s,r,n,a,l,h,c,u=!1,d=!1,f=1,p=!1){var _,g,E,R,x;this._isDisposed=!1;let S=!1;if(this.engine=e,typeof s=="object"&&s!==null?(S=(_=s.updatable)!==null&&_!==void 0?_:!1,r=s.postponeInternalCreation,n=s.stride,a=s.instanced,l=s.offset,h=s.size,c=s.type,u=(g=s.normalized)!==null&&g!==void 0?g:!1,d=(E=s.useBytes)!==null&&E!==void 0?E:!1,f=(R=s.divisor)!==null&&R!==void 0?R:1,p=(x=s.takeBufferOwnership)!==null&&x!==void 0?x:!1,this._label=s.label):S=!!s,t instanceof eo?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new eo(e,t,S,n,r,a,d,f,this._label),this._ownsBuffer=!0),this.uniqueId=T._Counter++,this._kind=i,c===void 0){const y=this.getData();this.type=y?T.GetDataType(y):T.FLOAT}else this.type=c;const b=T.GetTypeByteLength(this.type);d?(this._size=h||(n?n/b:T.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*b,this.byteOffset=l||0):(this._size=h||n||T.DeduceStride(i),this.byteStride=n?n*b:this._buffer.byteStride||this._size*b,this.byteOffset=(l||0)*b),this.normalized=u,this._instanced=a!==void 0?a:!1,this._instanceDivisor=a?f:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){var e;(e=this._buffer)===null||e===void 0||e._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();return i?(e=e??this.totalVertices,T.GetFloatData(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t)):null}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/T.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/T.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*T.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){T.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}_alignBuffer(){}static DeduceStride(e){switch(e){case T.UVKind:case T.UV2Kind:case T.UV3Kind:case T.UV4Kind:case T.UV5Kind:case T.UV6Kind:return 2;case T.NormalKind:case T.PositionKind:return 3;case T.ColorKind:case T.ColorInstanceKind:case T.MatricesIndicesKind:case T.MatricesIndicesExtraKind:case T.MatricesWeightsKind:case T.MatricesWeightsExtraKind:case T.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?T.BYTE:e instanceof Uint8Array?T.UNSIGNED_BYTE:e instanceof Int16Array?T.SHORT:e instanceof Uint16Array?T.UNSIGNED_SHORT:e instanceof Int32Array?T.INT:e instanceof Uint32Array?T.UNSIGNED_INT:T.FLOAT}static GetTypeByteLength(e){switch(e){case T.BYTE:case T.UNSIGNED_BYTE:return 1;case T.SHORT:case T.UNSIGNED_SHORT:return 2;case T.INT:case T.UNSIGNED_INT:case T.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,s,r,n,a,l){if(e instanceof Array){let h=t/4;const c=i/4;for(let u=0;u<n;u+=s){for(let d=0;d<s;d++)l(e[h+d],u+d);h+=c}}else{const h=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),c=T.GetTypeByteLength(r);for(let u=0;u<n;u+=s){let d=t;for(let f=0;f<s;f++){const p=T._GetFloatValue(h,r,d,a);l(p,u+f),d+=c}t+=i}}}static _GetFloatValue(e,t,i,s){switch(t){case T.BYTE:{let r=e.getInt8(i);return s&&(r=Math.max(r/127,-1)),r}case T.UNSIGNED_BYTE:{let r=e.getUint8(i);return s&&(r=r/255),r}case T.SHORT:{let r=e.getInt16(i,!0);return s&&(r=Math.max(r/32767,-1)),r}case T.UNSIGNED_SHORT:{let r=e.getUint16(i,!0);return s&&(r=r/65535),r}case T.INT:return e.getInt32(i,!0);case T.UNSIGNED_INT:return e.getUint32(i,!0);case T.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}static GetFloatData(e,t,i,s,r,n,a,l){const h=t*T.GetTypeByteLength(i),c=a*t;if(i!==T.FLOAT||r!==h){const u=new Float32Array(c);return T.ForEach(e,s,r,t,i,c,n,(d,f)=>u[f]=d),u}if(!(e instanceof Array||e instanceof Float32Array)||s!==0||e.length!==c)if(e instanceof Array){const u=s/4;return e.slice(u,u+c)}else{if(e instanceof ArrayBuffer)return new Float32Array(e,s,c);{let u=e.byteOffset+s;if(l){const f=new Float32Array(c),p=new Float32Array(e.buffer,u,c);return f.set(p),f}const d=u%4;return d&&(u=Math.max(0,u-d)),new Float32Array(e.buffer,u,c)}}return l?e.slice():e}}T._Counter=0;T.BYTE=5120;T.UNSIGNED_BYTE=5121;T.SHORT=5122;T.UNSIGNED_SHORT=5123;T.INT=5124;T.UNSIGNED_INT=5125;T.FLOAT=5126;T.PositionKind="position";T.NormalKind="normal";T.TangentKind="tangent";T.UVKind="uv";T.UV2Kind="uv2";T.UV3Kind="uv3";T.UV4Kind="uv4";T.UV5Kind="uv5";T.UV6Kind="uv6";T.ColorKind="color";T.ColorInstanceKind="instanceColor";T.MatricesIndicesKind="matricesIndices";T.MatricesWeightsKind="matricesWeights";T.MatricesIndicesExtraKind="matricesIndicesExtra";T.MatricesWeightsExtraKind="matricesWeightsExtra";class Dc{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[T.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[T.PositionKind]=new T(this._scene.getEngine(),e,T.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[T.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(s=>s!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,s=0,r=0,n=!1){var a;const l=this._scene.getEngine();for(let h=0;h<e.length;h++){h<e.length-1?e[h+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?l.bindFramebuffer(t,s,void 0,void 0,i,r):n||l.restoreDefaultFramebuffer(),(a=l._debugInsertMarker)===null||a===void 0||a.call(l,`post process ${e[h].name} output`));const c=e[h],u=c.apply();u&&(c.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,u),l.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(u))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,s,r=!1){var n;const a=this._scene.activeCamera;if(!a||(s=s||a._postProcesses.filter(h=>h!=null),s.length===0||!this._scene.postProcessesEnabled))return;const l=this._scene.getEngine();for(let h=0,c=s.length;h<c;h++){const u=s[h];if(h<c-1?u._outputTexture=s[h+1].activate(a,t==null?void 0:t.texture):(t?(l.bindFramebuffer(t,i,void 0,void 0,r),u._outputTexture=t):(l.restoreDefaultFramebuffer(),u._outputTexture=null),(n=l._debugInsertMarker)===null||n===void 0||n.call(l,`post process ${s[h].name} output`)),e)break;const d=u.apply();d&&(u.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,d),l.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(d))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[T.PositionKind];e&&(e.dispose(),this._vertexBuffers[T.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class li{constructor(e){this.length=0,this.data=new Array(e),this._id=li._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}li._GlobalId=0;class Xn extends li{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class qs{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=qs.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=qs.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=qs.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,s=null,r=null){this.index=e,this._opaqueSubMeshes=new li(256),this._transparentSubMeshes=new li(256),this._alphaTestSubMeshes=new li(256),this._depthOnlySubMeshes=new li(256),this._particleSystems=new li(256),this._spriteManagers=new li(256),this._empty=!0,this._edgesRenderers=new Xn(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=r}render(e,t,i,s){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const r=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=r.getStencilBuffer();if(r.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const a=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);a.length&&this._renderTransparent(a)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(let a=0;a<this._edgesRenderers.length;a++)this._edgesRenderers.data[a].render();r.setAlphaMode(0)}r.setStencilBuffer(n)}_renderOpaqueSorted(e){return qs._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return qs._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return qs._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,s){let r=0,n;const a=i?i.globalPosition:qs._ZeroVector;if(s)for(;r<e.length;r++)n=e.data[r],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=m.Distance(n.getBoundingInfo().boundingSphere.centerWorld,a);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const h=l[0].getMesh().getScene();for(r=0;r<l.length;r++)if(n=l[r],!(h._activeMeshesFrozenButKeepClipping&&!n.isInFrustum(h._frustumPlanes))){if(s){const c=n.getMaterial();if(c&&c.needDepthPrePass){const u=c.getScene().getEngine();u.setColorWrite(!1),u.setAlphaMode(0),n.render(!1),u.setColorWrite(!0)}}n.render(s)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:qs.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const s=this._particleSystems.data[i];if((t&&t.layerMask&s.layerMask)===0)continue;const r=s.emitter;(!r.position||!e||e.indexOf(r)!==-1)&&this._scene._activeParticles.addCount(s.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}qs._ZeroVector=m.Zero();class A0{}class Ii{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(const e of this._scene.meshes)if(e.subMeshes)for(const t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(const e of this._scene.spriteManagers)e._wasDispatched=!1;for(const e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new A0,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=Ii.MIN_RENDERINGGROUPS;t<Ii.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,s){const r=this._renderingGroupInfo;if(r.scene=this._scene,r.camera=this._scene.activeCamera,this._scene.spriteManagers&&s)for(let n=0;n<this._scene.spriteManagers.length;n++){const a=this._scene.spriteManagers[n];this.dispatchSprites(a)}for(let n=Ii.MIN_RENDERINGGROUPS;n<Ii.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===Ii.MIN_RENDERINGGROUPS;const a=this._renderingGroups[n];if(!a||a._empty)continue;const l=Math.pow(2,n);if(r.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(r,l),Ii.AUTOCLEAR){const h=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];h&&h.autoClear&&this._clearDepthStencilBuffer(h.depth,h.stencil)}for(const h of this._scene._beforeRenderingGroupDrawStage)h.action(n);a.render(e,s,i,t);for(const h of this._scene._afterRenderingGroupDrawStage)h.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(r,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=Ii.MIN_RENDERINGGROUPS;e<Ii.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=Ii.MIN_RENDERINGGROUPS;e<Ii.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=Ii.MIN_RENDERINGGROUPS;e<Ii.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new qs(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,s=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=s,this._renderingGroups[e]){const r=this._renderingGroups[e];r.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],r.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],r.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:s}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}Ii.MAX_RENDERINGGROUPS=4;Ii.MIN_RENDERINGGROUPS=0;Ii.AUTOCLEAR=!0;class R0{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return(t=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&t!==void 0?t:null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}constructor(e,t,i,s,r){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=s,this._depthStencilTexture=null,this.label=r}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),t!==void 0&&t>=0&&(this._layerIndices[e]=t),i!==void 0&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14,n){var a;return(a=this._depthStencilTexture)===null||a===void 0||a.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:r,label:n},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,s,r,n,a,l;let h=null;if(this._isMulti){const c=this.textures;if(c&&c.length>0){let u=!1,d=c.length;const f=c[c.length-1]._source;(f===At.Depth||f===At.DepthStencil)&&(u=!0,d--);const p=[],_=[],g=[],E=[],R=[],x=[],S=[],b={};for(let O=0;O<d;++O){const N=c[O];p.push(N.samplingMode),_.push(N.type),g.push(N.format),b[N.uniqueId]!==void 0?(E.push(-1),S.push(0)):(b[N.uniqueId]=O,N.is2DArray?(E.push(35866),S.push(N.depth)):N.isCube?(E.push(34067),S.push(0)):N.is3D?(E.push(32879),S.push(N.depth)):(E.push(3553),S.push(0))),this._faceIndices&&R.push((e=this._faceIndices[O])!==null&&e!==void 0?e:0),this._layerIndices&&x.push((t=this._layerIndices[O])!==null&&t!==void 0?t:0)}const y={samplingModes:p,generateMipMaps:c[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:u,types:_,formats:g,textureCount:d,targetTypes:E,faceIndex:R,layerIndex:x,layerCounts:S},I={width:this.width,height:this.height};h=this._engine.createMultipleRenderTarget(I,y);for(let O=0;O<d;++O){if(E[O]!==-1)continue;const N=b[c[O].uniqueId];h.setTexture(h.textures[N],O)}}}else{const c={};if(c.generateDepthBuffer=this._generateDepthBuffer,c.generateMipMaps=(s=(i=this.texture)===null||i===void 0?void 0:i.generateMipMaps)!==null&&s!==void 0?s:!1,c.generateStencilBuffer=this._generateStencilBuffer,c.samplingMode=(r=this.texture)===null||r===void 0?void 0:r.samplingMode,c.type=(n=this.texture)===null||n===void 0?void 0:n.type,c.format=(a=this.texture)===null||a===void 0?void 0:a.format,this.isCube)h=this._engine.createRenderTargetCubeTexture(this.width,c);else{const u={width:this.width,height:this.height,layers:this.is2DArray?(l=this.texture)===null||l===void 0?void 0:l.depth:void 0};h=this._engine.createRenderTargetTexture(u,c)}h.texture.isReady=!0}return h}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;(t=i<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&t!==void 0&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||((t=this._depthStencilTexture)===null||t===void 0||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class b0 extends R0{constructor(e,t,i,s,r){super(e,t,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=r}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;const r=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;this._engine._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,r,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,s=0){var r,n,a,l;if(!e._hardwareTexture)return;const h=this._framebuffer,c=this._engine._currentFramebuffer;if(this._engine._bindUnboundFramebuffer(h),this._engine.webGLVersion>1){const u=this._context,d=u["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=(n=i??((r=this.layerIndices)===null||r===void 0?void 0:r[t]))!==null&&n!==void 0?n:0,u.framebufferTextureLayer(u.FRAMEBUFFER,d,e._hardwareTexture.underlyingResource,s,i)):e.isCube?(i=(l=i??((a=this.faceIndices)===null||a===void 0?void 0:a[t]))!==null&&l!==void 0?l:0,u.framebufferTexture2D(u.FRAMEBUFFER,d,u.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,s)):u.framebufferTexture2D(u.FRAMEBUFFER,d,u.TEXTURE_2D,e._hardwareTexture.underlyingResource,s)}else{const u=this._context,d=u["COLOR_ATTACHMENT"+t+"_WEBGL"],f=i!==void 0?u.TEXTURE_CUBE_MAP_POSITIVE_X+i:u.TEXTURE_2D;u.framebufferTexture2D(u.FRAMEBUFFER,d,f,e._hardwareTexture.underlyingResource,s)}this._engine._bindUnboundFramebuffer(c)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){var i,s;if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;const r=(s=(i=this._attachments)===null||i===void 0?void 0:i.length)!==null&&s!==void 0?s:this.textures.length;for(let n=0;n<r;n++){const a=this.textures[n];a&&(a.is2DArray||a.is3D?this._bindTextureRenderTarget(a,n,this.layerIndices[n]):a.isCube?this._bindTextureRenderTarget(a,n,this.faceIndices[n]):this._bindTextureRenderTarget(a,n))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;const s=this.textures[e];s.is2DArray||s.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):s.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=this._disposeOnlyFramebuffers){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}Ie.prototype._createHardwareRenderTargetWrapper=function(o,e,t){const i=new b0(o,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};Ie.prototype.createRenderTargetTexture=function(o,e){var t,i;const s=this._createHardwareRenderTargetWrapper(!1,!1,o);let r=!0,n=!1,a=!1,l,h=1;e!==void 0&&typeof e=="object"&&(r=(t=e.generateDepthBuffer)!==null&&t!==void 0?t:!0,n=!!e.generateStencilBuffer,a=!!e.noColorAttachment,l=e.colorAttachment,h=(i=e.samples)!==null&&i!==void 0?i:1);const c=l||(a?null:this._createInternalTexture(o,e,!0,At.RenderTarget)),u=o.width||o,d=o.height||o,f=this._currentFramebuffer,p=this._gl,_=p.createFramebuffer();return this._bindUnboundFramebuffer(_),s._depthStencilBuffer=this._setupFramebufferDepthAttachments(n,r,u,d),c&&!c.is2DArray&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(f),s._framebuffer=_,s._generateDepthBuffer=r,s._generateStencilBuffer=n,s.setTextures(c),this.updateRenderTargetTextureSampleCount(s,h),s};Ie.prototype.createDepthStencilTexture=function(o,e,t){if(e.isCube){const i=o.width||o;return this._createDepthStencilCubeTexture(i,e,t)}else return this._createDepthStencilTexture(o,e,t)};Ie.prototype._createDepthStencilTexture=function(o,e,t){const i=this._gl,s=o.layers||0,r=s!==0?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,n=new wi(this,At.DepthStencil);if(!this._caps.depthTextureExtension)return q.Error("Depth texture is not supported by your browser or hardware."),n;const a=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e);if(this._bindTextureDirectly(r,n,!0),this._setupDepthStencilTexture(n,o,a.generateStencil,a.comparisonFunction===0?!1:a.bilinearFiltering,a.comparisonFunction,a.samples),a.depthTextureFormat!==void 0){if(a.depthTextureFormat!==15&&a.depthTextureFormat!==16&&a.depthTextureFormat!==17&&a.depthTextureFormat!==13&&a.depthTextureFormat!==14&&a.depthTextureFormat!==18)return q.Error("Depth texture format is not supported."),n;n.format=a.depthTextureFormat}else n.format=a.generateStencil?13:16;const l=n.format===17||n.format===13||n.format===18;t._depthStencilTexture=n,t._depthStencilTextureWithStencil=l;let h=i.UNSIGNED_INT;n.format===15?h=i.UNSIGNED_SHORT:n.format===17||n.format===13?h=i.UNSIGNED_INT_24_8:n.format===14?h=i.FLOAT:n.format===18&&(h=i.FLOAT_32_UNSIGNED_INT_24_8_REV);const c=l?i.DEPTH_STENCIL:i.DEPTH_COMPONENT;let u=c;this.webGLVersion>1&&(n.format===15?u=i.DEPTH_COMPONENT16:n.format===16?u=i.DEPTH_COMPONENT24:n.format===17||n.format===13?u=i.DEPTH24_STENCIL8:n.format===14?u=i.DEPTH_COMPONENT32F:n.format===18&&(u=i.DEPTH32F_STENCIL8)),n.is2DArray?i.texImage3D(r,0,u,n.width,n.height,s,0,c,h,null):i.texImage2D(r,0,u,n.width,n.height,0,c,h,null),this._bindTextureDirectly(r,null),this._internalTexturesCache.push(n);const d=t;if(d._depthStencilBuffer){const f=this._currentFramebuffer;this._bindUnboundFramebuffer(d._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),i.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null}return n};Ie.prototype.updateRenderTargetTextureSampleCount=function(o,e){if(this.webGLVersion<2||!o||!o.texture)return 1;if(o.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),o._depthStencilBuffer&&(t.deleteRenderbuffer(o._depthStencilBuffer),o._depthStencilBuffer=null),o._MSAAFramebuffer&&(t.deleteFramebuffer(o._MSAAFramebuffer),o._MSAAFramebuffer=null);const i=o.texture._hardwareTexture;if(i.releaseMSAARenderBuffers(),e>1&&typeof t.renderbufferStorageMultisample=="function"){const s=t.createFramebuffer();if(!s)throw new Error("Unable to create multi sampled framebuffer");o._MSAAFramebuffer=s,this._bindUnboundFramebuffer(o._MSAAFramebuffer);const r=this._createRenderBuffer(o.texture.width,o.texture.height,e,-1,this._getRGBABufferInternalSizedFormat(o.texture.type,o.texture.format,o.texture._useSRGBBuffer),t.COLOR_ATTACHMENT0,!1);if(!r)throw new Error("Unable to create multi sampled framebuffer");i.addMSAARenderBuffer(r)}else this._bindUnboundFramebuffer(o._framebuffer);return o.texture.samples=e,o._samples=e,o._depthStencilBuffer=this._setupFramebufferDepthAttachments(o._generateStencilBuffer,o._generateDepthBuffer,o.texture.width,o.texture.height,e),this._bindUnboundFramebuffer(null),e};Ie.prototype.createRenderTargetCubeTexture=function(o,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,o),i=Object.assign({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const s=this._gl,r=new wi(this,At.RenderTarget);this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,r,!0);const n=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,q.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,n.mag),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,n.min),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let l=0;l<6;l++)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),o,o,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const a=s.createFramebuffer();return this._bindUnboundFramebuffer(a),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,o,o),i.generateMipMaps&&s.generateMipmap(s.TEXTURE_CUBE_MAP),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=a,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,r.width=o,r.height=o,r.isReady=!0,r.isCube=!0,r.samples=1,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),t};const S0="postprocessVertexShader",y0=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;X.ShadersStore[S0]=y0;const ju={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Cf{constructor(e,t=ju){var i,s;this._fullscreenViewport=new Za(0,0,1,1);const r=(i=t.positions)!==null&&i!==void 0?i:ju.positions,n=(s=t.indices)!==null&&s!==void 0?s:ju.indices;this.engine=e,this._vertexBuffers={[T.PositionKind]:new T(e,r,T.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(n),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(n);for(const a in this._vertexBuffers)this._vertexBuffers[a]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[T.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[T.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class gn{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.onApplyObservable=new j;let t;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));const s=e.defines?e.defines.join(`
`):"";this._drawWrapper=new _r(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,s,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new ai(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,s,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const Lp=(o,e,t)=>!o||o.getClassName&&o.getClassName()==="Mesh"?null:o.getClassName&&(o.getClassName()==="SubMesh"||o.getClassName()==="PhysicsBody")?o.clone(e):o.clone?o.clone():Array.isArray(o)?o.slice():t&&typeof o=="object"?Object.assign({},o):null;function C0(o){const e=[];do Object.getOwnPropertyNames(o).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(o=Object.getPrototypeOf(o));return e}class Yc{static DeepCopy(e,t,i,s,r=!1){const n=C0(e);for(const a of n){if(a[0]==="_"&&(!s||s.indexOf(a)===-1)||a.endsWith("Observable")||i&&i.indexOf(a)!==-1)continue;const l=e[a],h=typeof l;if(h!=="function")try{if(h==="object")if(l instanceof Uint8Array)t[a]=Uint8Array.from(l);else if(l instanceof Array){if(t[a]=[],l.length>0)if(typeof l[0]=="object")for(let c=0;c<l.length;c++){const u=Lp(l[c],t,r);t[a].indexOf(u)===-1&&t[a].push(u)}else t[a]=l.slice(0)}else t[a]=Lp(l,t,r);else t[a]=l}catch(c){q.Warn(c.message)}}}}class Y{static get BaseUrl(){return fi.BaseUrl}static set BaseUrl(e){fi.BaseUrl=e}static IsAbsoluteUrl(e){return e.indexOf("//")===0?!0:e.indexOf("://")===-1||e.indexOf(".")===-1||e.indexOf("/")===-1||e.indexOf(":")>e.indexOf("/")?!1:e.indexOf("://")<e.indexOf(".")||e.indexOf("data:")===0||e.indexOf("blob:")===0}static set ScriptBaseUrl(e){fi.ScriptBaseUrl=e}static get ScriptBaseUrl(){return fi.ScriptBaseUrl}static set ScriptPreprocessUrl(e){fi.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return fi.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return fi.DefaultRetryStrategy}static set DefaultRetryStrategy(e){fi.DefaultRetryStrategy=e}static get CorsBehavior(){return fi.CorsBehavior}static set CorsBehavior(e){fi.CorsBehavior=e}static get UseFallbackTexture(){return Ze.UseFallbackTexture}static set UseFallbackTexture(e){Ze.UseFallbackTexture=e}static get RegisteredExternalClasses(){return nh.RegisteredExternalClasses}static set RegisteredExternalClasses(e){nh.RegisteredExternalClasses=e}static get fallbackTexture(){return Ze.FallbackTexture}static set fallbackTexture(e){Ze.FallbackTexture=e}static FetchToRef(e,t,i,s,r,n){const a=Math.abs(e)*i%i|0,l=Math.abs(t)*s%s|0,h=(a+l*i)*4;n.r=r[h]/255,n.g=r[h+1]/255,n.b=r[h+2]/255,n.a=r[h+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return nh.Instantiate(e)}static SetImmediate(e){Ic.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do t*=2;while(t<e);return t===e}static FloatRound(e){return Math.fround(e)}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const s=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(s),(1-i)*Math.cos(r)+i*Math.cos(s)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let t="pointer";return Fi()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){Sf(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e=e.replace(/#/gm,"%23"),e}static get PreprocessUrl(){return fi.PreprocessUrl}static set PreprocessUrl(e){fi.PreprocessUrl=e}static LoadImage(e,t,i,s,r,n){return Wc(e,t,i,s,r,n)}static LoadFile(e,t,i,s,r,n){return An(e,t,i,s,r,n)}static LoadFileAsync(e,t=!0){return new Promise((i,s)=>{An(e,r=>{i(r)},void 0,void 0,t,(r,n)=>{s(n)})})}static GetBabylonScriptURL(e,t){if(!e)return"";if(Y.ScriptBaseUrl&&e.startsWith(Y._DefaultCdnUrl)){const i=Y.ScriptBaseUrl[Y.ScriptBaseUrl.length-1]==="/"?Y.ScriptBaseUrl.substring(0,Y.ScriptBaseUrl.length-1):Y.ScriptBaseUrl;e=e.replace(Y._DefaultCdnUrl,i)}return e=Y.ScriptPreprocessUrl(e),t&&(e=Y.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,s){e=Y.GetBabylonScriptURL(e),Y.LoadScript(e,t,i)}static LoadBabylonScriptAsync(e){return e=Y.GetBabylonScriptURL(e),Y.LoadScriptAsync(e)}static LoadScript(e,t,i,s){if(typeof importScripts=="function"){try{importScripts(e),t()}catch(a){i==null||i(`Unable to load script '${e}' in worker`,a)}return}else if(!Fi()){i==null||i(`Cannot load script '${e}' outside of a window or a worker`);return}const r=document.getElementsByTagName("head")[0],n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e),s&&(n.id=s),n.onload=()=>{t&&t()},n.onerror=a=>{i&&i(`Unable to load script '${e}'`,a)},r.appendChild(n)}static LoadScriptAsync(e){return new Promise((t,i)=>{this.LoadScript(e,()=>{t()},(s,r)=>{i(r||new Error(s))})})}static ReadFileAsDataURL(e,t,i){const s=new FileReader,r={onCompleteObservable:new j,abort:()=>s.abort()};return s.onloadend=()=>{r.onCompleteObservable.notifyObservers(r)},s.onload=n=>{t(n.target.result)},s.onprogress=i,s.readAsDataURL(e),r}static ReadFile(e,t,i,s,r){return ph(e,t,i,s,r)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,s){Yc.DeepCopy(e,t,i,s)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.removeEventListener(s.name,s.handler);try{e.parent&&e.parent.removeEventListener(s.name,s.handler)}catch{}}}static async DumpFramebuffer(e,t,i,s,r="image/png",n,a){throw ke("DumpTools")}static DumpData(e,t,i,s,r="image/png",n,a=!1,l=!1,h){throw ke("DumpTools")}static DumpDataAsync(e,t,i,s="image/png",r,n=!1,a=!1,l){throw ke("DumpTools")}static _IsOffScreenCanvas(e){return e.convertToBlob!==void 0}static ToBlob(e,t,i="image/png",s){!Y._IsOffScreenCanvas(e)&&!e.toBlob&&(e.toBlob=function(r,n,a){setTimeout(()=>{const l=atob(this.toDataURL(n,a).split(",")[1]),h=l.length,c=new Uint8Array(h);for(let u=0;u<h;u++)c[u]=l.charCodeAt(u);r(new Blob([c]))})}),Y._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:s}).then(r=>t(r)):e.toBlob(function(r){t(r)},i,s)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date;t="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}Y.Download(e,t)}else if(e&&typeof URL<"u"){const i=URL.createObjectURL(e),s=window.open("");if(!s)return;const r=s.document.createElement("img");r.onload=function(){URL.revokeObjectURL(i)},r.src=i,s.document.body.appendChild(r)}}static EncodeScreenshotCanvasData(e,t,i="image/png",s,r){if(typeof s=="string"||!t)this.ToBlob(e,function(n){n&&Y.DownloadBlob(n,s),t&&t("")},i,r);else if(t){if(Y._IsOffScreenCanvas(e)){e.convertToBlob({type:i,quality:r}).then(a=>{const l=new FileReader;l.readAsDataURL(a),l.onloadend=()=>{const h=l.result;t(h)}});return}const n=e.toDataURL(i,r);t(n)}}static Download(e,t){if(typeof URL>"u")return;const i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=t,s.addEventListener("click",()=>{s.parentElement&&s.parentElement.removeChild(s)}),s.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,s,r="image/png",n=!1,a){throw ke("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,s="image/png",r){throw ke("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,s,r="image/png",n=1,a=!1,l,h=!1,c=!1,u=!0,d){throw ke("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,s="image/png",r=1,n=!1,a,l=!1,h=!1,c=!0,u){throw ke("ScreenshotTools")}static RandomId(){return Qs()}static IsBase64(e){return Xc(e)}static DecodeBase64(e){return yh(e)}static get errorsCount(){return q.errorsCount}static Log(e){q.Log(e)}static Warn(e){q.Warn(e)}static Error(e){q.Error(e)}static get LogCache(){return q.LogCache}static ClearLogCache(){q.ClearLogCache()}static set LogLevels(e){q.LogLevels=e}static set PerformanceLogLevel(e){if((e&Y.PerformanceUserMarkLogLevel)===Y.PerformanceUserMarkLogLevel){Y.StartPerformanceCounter=Y._StartUserMark,Y.EndPerformanceCounter=Y._EndUserMark;return}if((e&Y.PerformanceConsoleLogLevel)===Y.PerformanceConsoleLogLevel){Y.StartPerformanceCounter=Y._StartPerformanceConsole,Y.EndPerformanceCounter=Y._EndPerformanceConsole;return}Y.StartPerformanceCounter=Y._StartPerformanceCounterDisabled,Y.EndPerformanceCounter=Y._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!Y._Performance){if(!Fi())return;Y._Performance=window.performance}!t||!Y._Performance.mark||Y._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!Y._Performance.mark||(Y._Performance.mark(e+"-End"),Y._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(Y._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(Y._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Os.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,s=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const r=t?e:Object.getPrototypeOf(e);i=r.constructor.__bjsclassName__,s=r.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(s!=null?s+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return Jl()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}Y.UseCustomRequestHeaders=!1;Y.CustomRequestHeaders=Pi.CustomRequestHeaders;Y.GetDOMTextContent=mm;Y._DefaultCdnUrl="https://cdn.babylonjs.com";Y.GetAbsoluteUrl=typeof document=="object"?o=>{const e=document.createElement("a");return e.href=o,e.href}:typeof URL=="function"&&typeof location=="object"?o=>new URL(o,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};Y.NoneLogLevel=q.NoneLogLevel;Y.MessageLogLevel=q.MessageLogLevel;Y.WarningLogLevel=q.WarningLogLevel;Y.ErrorLogLevel=q.ErrorLogLevel;Y.AllLogLevel=q.AllLogLevel;Y.IsWindowObjectExist=Fi;Y.PerformanceNoneLogLevel=0;Y.PerformanceUserMarkLogLevel=1;Y.PerformanceConsoleLogLevel=2;Y.StartPerformanceCounter=Y._StartPerformanceCounterDisabled;Y.EndPerformanceCounter=Y._EndPerformanceCounterDisabled;class Oc{constructor(e,t,i,s=0){this.iterations=e,this.index=s-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,s=0){const r=new Oc(e,t,i,s);return r.executeNext(),r}static SyncAsyncForLoop(e,t,i,s,r,n=0){return Oc.Run(Math.ceil(e/t),a=>{r&&r()?a.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const h=a.index*t+l;if(h>=e)break;if(i(h),r&&r()){a.breakLoop();break}}a.executeNext()},n)},s)}}Ze.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";const Im="passPixelShader",Pm=`varying vec2 vUV;uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);}`;X.ShadersStore[Im]=Pm;const Fp={name:Im,shader:Pm};class Ji{static _CreateDumpRenderer(){if(!Ji._DumpToolsEngine){let e,t=null;const i={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};try{e=new OffscreenCanvas(100,100),t=new Ie(e,!1,i)}catch{e=document.createElement("canvas"),t=new Ie(e,!1,i)}t.getCaps().parallelShaderCompile=void 0;const s=new Cf(t),r=new gn({engine:t,name:Fp.name,fragmentShader:Fp.shader,samplerNames:["textureSampler"]});Ji._DumpToolsEngine={canvas:e,engine:t,renderer:s,wrapper:r}}return Ji._DumpToolsEngine}static async DumpFramebuffer(e,t,i,s,r="image/png",n,a){const l=await i.readPixels(0,0,e,t),h=new Uint8Array(l.buffer);Ji.DumpData(e,t,h,s,r,n,!0,void 0,a)}static DumpDataAsync(e,t,i,s="image/png",r,n=!1,a=!1,l){return new Promise(h=>{Ji.DumpData(e,t,i,c=>h(c),s,r,n,a,l)})}static DumpData(e,t,i,s,r="image/png",n,a=!1,l=!1,h){const c=Ji._CreateDumpRenderer();if(c.engine.setSize(e,t,!0),i instanceof Float32Array){const d=new Uint8Array(i.length);let f=i.length;for(;f--;){const p=i[f];d[f]=Math.round(Te.Clamp(p)*255)}i=d}const u=c.engine.createRawTexture(i,e,t,5,!1,!a,1);c.renderer.setViewport(),c.renderer.applyEffectWrapper(c.wrapper),c.wrapper.effect._bindTexture("textureSampler",u),c.renderer.draw(),l?Y.ToBlob(c.canvas,d=>{const f=new FileReader;f.onload=p=>{const _=p.target.result;s&&s(_)},f.readAsArrayBuffer(d)},r,h):Y.EncodeScreenshotCanvasData(c.canvas,s,r,n,h),u.dispose()}static Dispose(){Ji._DumpToolsEngine&&(Ji._DumpToolsEngine.wrapper.dispose(),Ji._DumpToolsEngine.renderer.dispose(),Ji._DumpToolsEngine.engine.dispose()),Ji._DumpToolsEngine=null}}const x0=()=>{Y.DumpData=Ji.DumpData,Y.DumpDataAsync=Ji.DumpDataAsync,Y.DumpFramebuffer=Ji.DumpFramebuffer};x0();class Ki extends V{get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=pm(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;Array.isArray(e)?i=e:i=[e];for(let s=0;s<i.length;++s)for(let r=0;r<this._renderPassIds.length;++r)i[s].setMaterialForRenderPass(this._renderPassIds[r],t!==void 0?Array.isArray(t)?t[r]:t:void 0)}get isMulti(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e.isMulti)!==null&&t!==void 0?t:!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e._depthStencilTexture)!==null&&t!==void 0?t:null}constructor(e,t,i,s=!1,r=!0,n=0,a=!1,l=V.TRILINEAR_SAMPLINGMODE,h=!0,c=!1,u=!1,d=5,f=!1,p,_,g=!1,E=!1){var R,x,S,b,y,I,O;let N,w=!0;if(typeof s=="object"){const k=s;s=!!k.generateMipMaps,r=(R=k.doNotChangeAspectRatio)!==null&&R!==void 0?R:!0,n=(x=k.type)!==null&&x!==void 0?x:0,a=!!k.isCube,l=(S=k.samplingMode)!==null&&S!==void 0?S:V.TRILINEAR_SAMPLINGMODE,h=(b=k.generateDepthBuffer)!==null&&b!==void 0?b:!0,c=!!k.generateStencilBuffer,u=!!k.isMulti,d=(y=k.format)!==null&&y!==void 0?y:5,f=!!k.delayAllocation,p=k.samples,_=k.creationFlags,g=!!k.noColorAttachment,E=!!k.useSRGBBuffer,N=k.colorAttachment,w=(I=k.gammaSpace)!==null&&I!==void 0?I:w}if(super(null,i,!s,void 0,l,void 0,void 0,void 0,void 0,d),this._unObserveRenderList=null,this._renderListHasChanged=(k,de)=>{var ae;const _e=this._renderList?this._renderList.length:0;(de===0&&_e>0||_e===0)&&((ae=this.getScene())===null||ae===void 0||ae.meshes.forEach(Ce=>{Ce._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new j,this.onAfterUnbindObservable=new j,this.onBeforeRenderObservable=new j,this.onAfterRenderObservable=new j,this.onClearObservable=new j,this.onResizeObservable=new j,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=m.Zero(),i=this.getScene(),!i)return;const G=this.getScene().getEngine();this._gammaSpace=w,this._coordinatesMode=V.PROJECTION_MODE,this.renderList=[],this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=a,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=G.onResizeObservable.add(()=>{}),this._generateMipMaps=!!s,this._doNotChangeAspectRatio=r,this._renderingManager=new Ii(i),this._renderingManager._useSceneAutoClearSetup=!0,!u&&(this._renderTargetOptions={generateMipMaps:s,type:n,format:(O=this._format)!==null&&O!==void 0?O:void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:c,samples:p,creationFlags:_,noColorAttachment:g,useSRGBBuffer:E,colorAttachment:N,label:this.name},this.samplingMode===V.NEAREST_SAMPLINGMODE&&(this.wrapU=V.CLAMP_ADDRESSMODE,this.wrapV=V.CLAMP_ADDRESSMODE),f||(a?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=V.INVCUBIC_MODE,this._textureMatrix=L.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,p!==void 0&&(this.samples=p)))}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14){var n;(n=this._renderTarget)===null||n===void 0||n.createDepthStencilTexture(e,t,i,s,r)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e,t=!0){if(e.ratio){this._sizeRatio=e.ratio;const i=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(i.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(i.getRenderHeight(),this._sizeRatio)}}else this._size=e;t&&this._createRenderPassId()}get samples(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new Dc(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;return e||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var t;const i=this.isCube;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null;const s=this.getScene();s&&(this._processSizeParameter(e,!1),i?this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){var s;const r=this.getScene();if(!r)return i;const n=r.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let u=0;u<this._waitingRenderList.length;u++){const d=this._waitingRenderList[u],f=r.getMeshById(d);f&&this.renderList.push(f)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const u=this.getScene();if(!u)return i;const d=u.meshes;for(let f=0;f<d.length;f++){const p=d[f];this.renderListPredicate(p)&&this.renderList.push(p)}}const a=n.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const l=(s=this.activeCamera)!==null&&s!==void 0?s:r.activeCamera,h=r.activeCamera;l&&(l!==r.activeCamera&&(r.setTransformMatrix(l.getViewMatrix(),l.getProjectionMatrix(!0)),r.activeCamera=l),n.setViewport(l.rigParent?l.rigParent.viewport:l.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let c=i;if(i){r.getViewMatrix()||r.updateTransformMatrix();const u=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let d=0;d<u&&c;d++){let f=null;const p=this.renderList?this.renderList:r.getActiveMeshes().data,_=this.renderList?this.renderList.length:r.getActiveMeshes().length;n.currentRenderPassId=this._renderPassIds[d],this.onBeforeRenderObservable.notifyObservers(d),this.getCustomRenderList&&(f=this.getCustomRenderList(d,p,_)),f||(f=p),this._doNotChangeAspectRatio||r.updateTransformMatrix(!0);for(let g=0;g<f.length&&c;++g){const E=f[g];if(!(!E.isEnabled()||E.isBlocked||!E.isVisible||!E.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(E,this.refreshRate,i)){c=!1;continue}}else if(!E.isReady(!0)){c=!1;continue}}}this.onAfterRenderObservable.notifyObservers(d),(this.is2DArray||this.isCube)&&(r.incrementRenderId(),r.resetCachedMaterial())}}else if(this.is2DArray&&!this.isMulti)for(let u=0;u<this.getRenderLayers();u++)this._renderToTarget(0,e,t,u,l),r.incrementRenderId(),r.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let u=0;u<6;u++)this._renderToTarget(u,e,t,void 0,l),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,l);return this.onAfterUnbindObservable.notifyObservers(this),n.currentRenderPassId=a,h&&(r.activeCamera=h,this.activeCamera&&this.activeCamera!==r.activeCamera&&r.setTransformMatrix(r.activeCamera.getViewMatrix(),r.activeCamera.getProjectionMatrix(!0)),n.setViewport(r.activeCamera.viewport)),r.resetCachedMaterial(),c}_bestReflectionRenderTargetDimension(e,t){const s=e*t,r=H.NearestPOT(s+128*128/(128+s));return Math.min(H.FloorPOT(e),r)}_prepareRenderingManager(e,t,i,s){const r=this.getScene();if(!r)return;this._renderingManager.reset();const n=r.getRenderId();for(let a=0;a<t;a++){const l=e[a];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&r.activeCamera&&(l._internalAbstractMeshDataInfo._currentLOD=r.customLODSelector?r.customLODSelector(l,this.activeCamera||r.activeCamera):l.getLOD(this.activeCamera||r.activeCamera),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;let h=l._internalAbstractMeshDataInfo._currentLOD;h._preActivateForIntermediateRendering(n);let c;if(s&&i?c=(l.layerMask&i.layerMask)===0:c=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!c&&(h!==l&&h._activate(n,!0),l._activate(n,!0)&&l.subMeshes.length)){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(h=l):h._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,h._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let u=0;u<h.subMeshes.length;u++){const d=h.subMeshes[u];this._renderingManager.dispatch(d,h)}}}}for(let a=0;a<r.particleSystems.length;a++){const l=r.particleSystems[a],h=l.emitter;!l.isStarted()||!h||h.position&&!h.isEnabled()||this._renderingManager.dispatchParticles(l)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const s=i.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,i,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!s||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,s=0,r=null){var n,a,l,h,c,u;const d=this.getScene();if(!d)return;const f=d.getEngine();if((n=f._debugPushGroup)===null||n===void 0||n.call(f,`render to face #${e} layer #${s}`,1),this._prepareFrame(d,e,s,t),this.is2DArray?(f.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s)):(f.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),f.snapshotRendering&&f.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0);else{let _=null;const g=this.renderList?this.renderList:d.getActiveMeshes().data,E=this.renderList?this.renderList.length:d.getActiveMeshes().length;this.getCustomRenderList&&(_=this.getCustomRenderList(this.is2DArray?s:e,g,E)),_?this._prepareRenderingManager(_,_.length,r,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(g,E,r,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),_=g);for(const x of d._beforeRenderTargetClearStage)x.action(this,e,s);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0);for(const x of d._beforeRenderTargetDrawStage)x.action(this,e,s);this._renderingManager.render(this.customRenderFunction,_,this.renderParticles,this.renderSprites);for(const x of d._afterRenderTargetDrawStage)x.action(this,e,s);const R=(l=(a=this._texture)===null||a===void 0?void 0:a.generateMipMaps)!==null&&l!==void 0?l:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(h=this._renderTarget)!==null&&h!==void 0?h:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&d.postProcessManager._finalizeFrame(!1,(c=this._renderTarget)!==null&&c!==void 0?c:void 0,e);for(const x of d._afterRenderTargetPostProcessStage)x.action(this,e,s);this._texture&&(this._texture.generateMipMaps=R),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0),i&&Ji.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),f)}this._unbindFrameBuffer(f,e),this._texture&&this.isCube&&e===5&&f.generateMipMapsForCubemap(this._texture),(u=f._debugPopGroup)===null||u===void 0||u.call(f,1)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new Ki(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)===null||e===void 0||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)===null||e===void 0||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const t=this.getScene();if(!t)return;let i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(const s of t.cameras)i=s.customRenderTargets.indexOf(this),i>=0&&s.customRenderTargets.splice(i,1);(e=this._renderTarget)===null||e===void 0||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===Ki.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Ki.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}Ki.REFRESHRATE_RENDER_ONCE=0;Ki.REFRESHRATE_RENDER_ONEVERYFRAME=1;Ki.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;V._CreateRenderTargetTexture=(o,e,t,i,s)=>new Ki(o,e,t,i);class ht{static RegisterShaderCodeProcessing(e,t){if(!t){delete ht._CustomShaderCodeProcessing[e??""];return}ht._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){var t;return(t=ht._CustomShaderCodeProcessing[e])!==null&&t!==void 0?t:ht._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,s,r,n,a=1,l,h,c=null,u=0,d="postprocess",f,p=!1,_=5,g=bi.GLSL){var E,R,x,S,b,y,I,O,N,w,G,k;this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new li(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new Ke(1,1),this._texelSize=Ke.Zero(),this.onActivateObservable=new j,this.onSizeChangedObservable=new j,this.onApplyObservable=new j,this.onBeforeRenderObservable=new j,this.onAfterRenderObservable=new j,this.name=e;let de=1,ae=null;if(i&&!Array.isArray(i)){const _e=i;i=(E=_e.uniforms)!==null&&E!==void 0?E:null,s=(R=_e.samplers)!==null&&R!==void 0?R:null,de=(x=_e.size)!==null&&x!==void 0?x:1,n=(S=_e.camera)!==null&&S!==void 0?S:null,a=(b=_e.samplingMode)!==null&&b!==void 0?b:1,l=_e.engine,h=_e.reusable,c=(y=_e.defines)!==null&&y!==void 0?y:null,u=(I=_e.textureType)!==null&&I!==void 0?I:0,d=(O=_e.vertexUrl)!==null&&O!==void 0?O:"postprocess",f=_e.indexParameters,p=(N=_e.blockCompilation)!==null&&N!==void 0?N:!1,_=(w=_e.textureFormat)!==null&&w!==void 0?w:5,g=(G=_e.shaderLanguage)!==null&&G!==void 0?G:bi.GLSL,ae=(k=_e.uniformBuffers)!==null&&k!==void 0?k:null}else r&&(typeof r=="number"?de=r:de={width:r.width,height:r.height});n!=null?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=de,this.renderTargetSamplingMode=a||1,this._reusable=h||!1,this._textureType=u,this._textureFormat=_,this._shaderLanguage=g,this._samplers=s||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._uniformBuffers=ae||[],this._indexParameters=f,this._drawWrapper=new _r(this._engine),p||this.updateEffect(c)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new li(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,s,r,n,a,l){var h,c;const u=ht._GetShaderCodeProcessing(this.name);if(u!=null&&u.defineCustomBindings){const d=(h=t==null?void 0:t.slice())!==null&&h!==void 0?h:[];d.push(...this._parameters);const f=(c=i==null?void 0:i.slice())!==null&&c!==void 0?c:[];f.push(...this._samplers),e=u.defineCustomBindings(this.name,e,d,f),t=d,i=f}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:a??this._vertexUrl,fragment:l??this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:this._uniformBuffers,samplers:i||this._samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:r??null,onError:n??null,indexParameters:s||this._indexParameters,processCodeAfterIncludes:u!=null&&u.processCodeAfterIncludes?(d,f)=>u.processCodeAfterIncludes(this.name,d,f):null,processFinalCode:u!=null&&u.processFinalCode?(d,f)=>u.processFinalCode(this.name,d,f):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture.width===e.width&&this._textureCache[r].texture.height===e.height&&this._textureCache[r].postProcessChannel===i&&this._textureCache[r].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[r].texture.samples===t.samples)return this._textureCache[r].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:i,lastUsedRenderId:-1}),s}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let s=0;s<this._textures.length;s++)if(this._textures.data[s]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,s=!1,r=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(i){for(let h=0;h<i._postProcesses.length;h++)if(i._postProcesses[h]!==null){n=i._postProcesses[h];break}}const a={width:this.width,height:this.height},l={generateMipMaps:s,generateDepthBuffer:r||n===this,generateStencilBuffer:(r||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){var s,r;e=e||this._camera;const n=e.getScene(),a=n.getEngine(),l=a.getCaps().maxTextureSize,h=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,c=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let u=this._options.width||h,d=this._options.height||c;const f=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;let p=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const _=a.currentViewport;_&&(u*=_.width,d*=_.height)}(f||this.alwaysForcePOT)&&(this._options.width||(u=a.needPOTTextures?H.GetExponentOfTwo(u,l,this.scaleMode):u),this._options.height||(d=a.needPOTTextures?H.GetExponentOfTwo(d,l,this.scaleMode):d)),(this.width!==u||this.height!==d||!(p=this._getTarget()))&&this.resize(u,d,e,f,i),this._textures.forEach(_=>{_.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(_,this.samples)}),this._flushTextureCache(),this._renderId++}return p||(p=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(h/u,c/d),this._engine.bindFramebuffer(p,0,h,c,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(p,0,void 0,void 0,this.forceFullscreenViewport)),(r=(s=this._engine)._debugInsertMarker)===null||r===void 0||r.call(s,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:n.clearColor,n._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),p}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return(t=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}apply(){var e,t,i;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let s;return this._shareOutputWithPostProcess?s=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?s=this._forcedOutputTexture:s=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",s==null?void 0:s.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),(i=(t=ht._GetShaderCodeProcessing(this.name))===null||t===void 0?void 0:t.bindCustomBindings)===null||i===void 0||i.call(t,this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=Le.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=ht.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const s=Gr(e.customType);if(!s||!s._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return s._Parse(e,r,t,i)}static _Parse(e,t,i,s){return Le.Parse(()=>new ht(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,s)}}ht._CustomShaderCodeProcessing={};v([M()],ht.prototype,"uniqueId",void 0);v([M()],ht.prototype,"name",void 0);v([M()],ht.prototype,"width",void 0);v([M()],ht.prototype,"height",void 0);v([M()],ht.prototype,"renderTargetSamplingMode",void 0);v([Tm()],ht.prototype,"clearColor",void 0);v([M()],ht.prototype,"autoClear",void 0);v([M()],ht.prototype,"forceAutoClearInAlphaMode",void 0);v([M()],ht.prototype,"alphaMode",void 0);v([M()],ht.prototype,"alphaConstants",void 0);v([M()],ht.prototype,"enablePixelPerfectMode",void 0);v([M()],ht.prototype,"forceFullscreenViewport",void 0);v([M()],ht.prototype,"scaleMode",void 0);v([M()],ht.prototype,"alwaysForcePOT",void 0);v([M("samples")],ht.prototype,"_samples",void 0);v([M()],ht.prototype,"adaptScaleToCurrentViewport",void 0);Re("BABYLON.PostProcess",ht);const M0="passCubePixelShader",I0=`varying vec2 vUV;uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;X.ShadersStore[M0]=I0;class Ch extends ht{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,s,r,n,a=0,l=!1){super(e,"pass",null,null,t,i,s,r,n,void 0,a,void 0,null,l)}static _Parse(e,t,i,s){return Le.Parse(()=>new Ch(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,s)}}Re("BABYLON.PassPostProcess",Ch);H._RescalePostProcessFactory=o=>new Ch("rescale",1,null,2,o,!1,0);function P0(o,e,t,i,s,r,n,a){const l=e.getEngine();return e.isReady=!1,s=s??e.samplingMode,i=i??e.type,r=r??e.format,n=n??e.width,a=a??e.height,i===-1&&(i=0),new Promise(h=>{const c=new ht("postprocess",o,null,null,1,null,s,l,!1,void 0,i,void 0,null,!1,r);c.externalTextureSamplerBinding=!0;const u=l.createRenderTargetTexture({width:n,height:a},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:s,type:i,format:r});c.getEffect().executeWhenCompiled(()=>{c.onApply=d=>{d._bindTexture("textureSampler",e),d.setFloat2("scale",1,1)},t.postProcessManager.directRender([c],u,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(e),c&&c.dispose(),u._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,h(e)})})}let Rc,wp;function Fa(o){Rc||(Rc=new Float32Array(1),wp=new Int32Array(Rc.buffer)),Rc[0]=o;const e=wp[0];let t=e>>16&32768,i=e>>12&2047;const s=e>>23&255;return s<103?t:s>142?(t|=31744,t|=(s==255?0:1)&&e&8388607,t):s<113?(i|=2048,t|=(i>>114-s)+(i>>113-s&1),t):(t|=s-112<<10|i>>1,t+=i&1,t)}function an(o){const e=(o&32768)>>15,t=(o&31744)>>10,i=o&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}Ie.prototype._createDepthStencilCubeTexture=function(o,e,t){const i=new wi(this,At.DepthStencil);if(i.isCube=!0,this.webGLVersion===1)return q.Error("Depth cube texture is not supported by WebGL 1."),i;const s=Object.assign({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e),r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,o,s.generateStencil,s.bilinearFiltering,s.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=s.generateStencil;for(let n=0;n<6;n++)s.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH24_STENCIL8,o,o,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH_COMPONENT24,o,o,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i};Ie.prototype._partialLoadFile=function(o,e,t,i,s=null){const r=a=>{t[e]=a,t._internalCount++,t._internalCount===6&&i(t)},n=(a,l)=>{s&&a&&s(a.status+" "+a.statusText,l)};this._loadFile(o,r,void 0,void 0,!0,n)};Ie.prototype._cascadeLoadFiles=function(o,e,t,i=null){const s=[];s._internalCount=0;for(let r=0;r<6;r++)this._partialLoadFile(t[r],r,s,e,i)};Ie.prototype._cascadeLoadImgs=function(o,e,t,i,s=null,r){const n=[];n._internalCount=0;for(let a=0;a<6;a++)this._partialLoadImg(i[a],a,n,o,e,t,s,r)};Ie.prototype._partialLoadImg=function(o,e,t,i,s,r,n=null,a){const l=Qs();Wc(o,u=>{t[e]=u,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&r&&r(s,t)},(u,d)=>{i&&i.removePendingData(l),n&&n(u,d)},i?i.offlineProvider:null,a),i&&i.addPendingData(l)};Ie.prototype._setCubeMapTextureParams=function(o,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),o.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),o._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};Ie.prototype.createCubeTextureBase=function(o,e,t,i,s=null,r=null,n,a=null,l=!1,h=0,c=0,u=null,d=null,f=null,p=!1){const _=u||new wi(this,At.Cube);_.isCube=!0,_.url=o,_.generateMipMaps=!i,_._lodGenerationScale=h,_._lodGenerationOffset=c,_._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),_!==u&&(_.label=o.substring(0,60)),this._doNotHandleContextLost||(_._extension=a,_._files=t);const g=o;this._transformTextureUrl&&!u&&(o=this._transformTextureUrl(o));const E=o.split("?")[0],R=E.lastIndexOf("."),x=a||(R>-1?E.substring(R).toLowerCase():"");let S=null;for(const y of Ie._TextureLoaders)if(y.canLoad(x)){S=y;break}const b=(y,I)=>{o===g?r&&y&&r(y.status+" "+y.statusText,I):(q.Warn(`Failed to load ${o}, falling back to the ${g}`),this.createCubeTextureBase(g,e,t,!!i,s,r,n,a,l,h,c,_,d,f,p))};if(S){const y=I=>{d&&d(_,I),S.loadCubeData(I,_,l,s,r)};t&&t.length===6?S.supportCascades?this._cascadeLoadFiles(e,I=>y(I.map(O=>new Uint8Array(O))),t,r):r?r("Textures type does not support cascades."):q.Warn("Texture loader does not support cascades."):this._loadFile(o,I=>y(new Uint8Array(I)),void 0,void 0,!0,b)}else{if(!t||t.length===0)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(e,_,(y,I)=>{f&&f(y,I)},t,r)}return this._internalTexturesCache.push(_),_};Ie.prototype.createCubeTexture=function(o,e,t,i,s=null,r=null,n,a=null,l=!1,h=0,c=0,u=null,d,f=!1){const p=this._gl;return this.createCubeTextureBase(o,e,t,!!i,s,r,n,a,l,h,c,u,_=>this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),(_,g)=>{const E=this.needPOTTextures?Ie.GetExponentOfTwo(g[0].width,this._caps.maxCubemapTextureSize):g[0].width,R=E,x=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),this._unpackFlipY(!1);const S=n?this._getInternalFormat(n,_._useSRGBBuffer):_._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:p.RGBA;let b=n?this._getInternalFormat(n):p.RGBA;_._useSRGBBuffer&&this.webGLVersion===1&&(b=S);for(let y=0;y<x.length;y++)if(g[y].width!==E||g[y].height!==R){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){q.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=E,this._workingCanvas.height=R,this._workingContext.drawImage(g[y],0,0,g[y].width,g[y].height,0,0,E,R),p.texImage2D(x[y],0,S,b,p.UNSIGNED_BYTE,this._workingCanvas)}else p.texImage2D(x[y],0,S,b,p.UNSIGNED_BYTE,g[y]);i||p.generateMipmap(p.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(_,!i),_.width=E,_.height=R,_.isReady=!0,n&&(_.format=n),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),s&&s()},!!f)};const D0=542327876,Bp=131072,Up=512,kp=4,Vp=64,Gp=131072;function Kc(o){return o.charCodeAt(0)+(o.charCodeAt(1)<<8)+(o.charCodeAt(2)<<16)+(o.charCodeAt(3)<<24)}function O0(o){return String.fromCharCode(o&255,o>>8&255,o>>16&255,o>>24&255)}const zp=Kc("DXT1"),Hp=Kc("DXT3"),Wp=Kc("DXT5"),qu=Kc("DX10"),Xp=113,Yp=116,Kp=2,$p=10,N0=88,Zu=31,L0=0,F0=1,jp=2,qp=3,Qu=4,Zp=7,Ju=20,Qp=21,w0=22,B0=23,U0=24,k0=25,V0=26,G0=28,z0=32;class Tt{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,Zu),i=new Int32Array(e.buffer,e.byteOffset,Zu+4);let s=1;t[jp]&Bp&&(s=Math.max(1,t[Zp]));const r=t[Qp],n=r===qu?i[z0]:0;let a=0;switch(r){case Xp:a=2;break;case Yp:a=1;break;case qu:if(n===$p){a=2;break}if(n===Kp){a=1;break}}return{width:t[Qu],height:t[qp],mipmapCount:s,isFourCC:(t[Ju]&kp)===kp,isRGB:(t[Ju]&Vp)===Vp,isLuminance:(t[Ju]&Gp)===Gp,isCube:(t[G0]&Up)===Up,isCompressed:r===zp||r===Hp||r===Wp,dxgiFormat:n,textureType:a}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,s,r,n){const a=new Float32Array(s),l=new Uint16Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;a[h]=an(l[d]),a[h+1]=an(l[d+1]),a[h+2]=an(l[d+2]),Tt.StoreLODInAlphaChannel?a[h+3]=n:a[h+3]=an(l[d+3]),h+=4}return a}static _GetHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){if(Tt.StoreLODInAlphaChannel){const a=new Uint16Array(s),l=new Uint16Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;a[h]=l[d],a[h+1]=l[d+1],a[h+2]=l[d+2],a[h+3]=Fa(n),h+=4}return a}return new Uint16Array(r,i,s)}static _GetFloatRGBAArrayBuffer(e,t,i,s,r,n){if(Tt.StoreLODInAlphaChannel){const a=new Float32Array(s),l=new Float32Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;a[h]=l[d],a[h+1]=l[d+1],a[h+2]=l[d+2],a[h+3]=n,h+=4}return a}return new Float32Array(r,i,s)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){const a=new Uint16Array(s),l=new Float32Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++)a[h]=Fa(l[h]),a[h+1]=Fa(l[h+1]),a[h+2]=Fa(l[h+2]),Tt.StoreLODInAlphaChannel?a[h+3]=Fa(n):a[h+3]=Fa(l[h+3]),h+=4;return a}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,s,r,n){const a=new Uint8Array(s),l=new Float32Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;a[h]=Te.Clamp(l[d])*255,a[h+1]=Te.Clamp(l[d+1])*255,a[h+2]=Te.Clamp(l[d+2])*255,Tt.StoreLODInAlphaChannel?a[h+3]=n:a[h+3]=Te.Clamp(l[d+3])*255,h+=4}return a}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,s,r,n){const a=new Uint8Array(s),l=new Uint16Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;a[h]=Te.Clamp(an(l[d]))*255,a[h+1]=Te.Clamp(an(l[d+1]))*255,a[h+2]=Te.Clamp(an(l[d+2]))*255,Tt.StoreLODInAlphaChannel?a[h+3]=n:a[h+3]=Te.Clamp(an(l[d+3]))*255,h+=4}return a}static _GetRGBAArrayBuffer(e,t,i,s,r,n,a,l,h){const c=new Uint8Array(s),u=new Uint8Array(r,i);let d=0;for(let f=0;f<t;f++)for(let p=0;p<e;p++){const _=(p+f*e)*4;c[d]=u[_+n],c[d+1]=u[_+a],c[d+2]=u[_+l],c[d+3]=u[_+h],d+=4}return c}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+Tt._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,s,r,n,a,l){const h=new Uint8Array(s),c=new Uint8Array(r,i);let u=0;for(let d=0;d<t;d++)for(let f=0;f<e;f++){const p=(f+d*e)*3;h[u]=c[p+n],h[u+1]=c[p+a],h[u+2]=c[p+l],u+=3}return h}static _GetLuminanceArrayBuffer(e,t,i,s,r){const n=new Uint8Array(s),a=new Uint8Array(r,i);let l=0;for(let h=0;h<t;h++)for(let c=0;c<e;c++){const u=c+h*e;n[l]=a[u],l++}return n}static UploadDDSLevels(e,t,i,s,r,n,a=-1,l,h=!0){let c=null;s.sphericalPolynomial&&(c=[]);const u=!!e.getCaps().s3tc;t.generateMipMaps=r;const d=new Int32Array(i.buffer,i.byteOffset,Zu);let f,p,_,g=0,E,R,x,S,b=0,y=1;if(d[L0]!==D0){q.Error("Invalid magic number in DDS header");return}if(!s.isFourCC&&!s.isRGB&&!s.isLuminance){q.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(s.isCompressed&&!u){q.Error("Compressed textures are not supported on this platform.");return}let I=d[w0];E=d[F0]+4;let O=!1;if(s.isFourCC)switch(f=d[Qp],f){case zp:y=8,b=33777;break;case Hp:y=16,b=33778;break;case Wp:y=16,b=33779;break;case Xp:O=!0,I=64;break;case Yp:O=!0,I=128;break;case qu:{E+=5*4;let _e=!1;switch(s.dxgiFormat){case $p:O=!0,I=64,_e=!0;break;case Kp:O=!0,I=128,_e=!0;break;case N0:s.isRGB=!0,s.isFourCC=!1,I=32,_e=!0;break}if(_e)break}default:q.Error(["Unsupported FourCC code:",O0(f)]);return}const N=Tt._ExtractLongWordOrder(d[B0]),w=Tt._ExtractLongWordOrder(d[U0]),G=Tt._ExtractLongWordOrder(d[k0]),k=Tt._ExtractLongWordOrder(d[V0]);O&&(b=e._getRGBABufferInternalSizedFormat(s.textureType)),x=1,d[jp]&Bp&&r!==!1&&(x=Math.max(1,d[Zp]));const de=l||0,ae=e.getCaps();for(let _e=de;_e<n;_e++){for(p=d[Qu],_=d[qp],S=0;S<x;++S){if(a===-1||a===S){const Ce=a===-1?S:0;if(!s.isCompressed&&s.isFourCC){t.format=5,g=p*_*4;let ce=null;if(e._badOS||e._badDesktopOS||!ae.textureHalfFloat&&!ae.textureFloat)I===128?(ce=Tt._GetFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,Ce),c&&Ce==0&&c.push(Tt._GetFloatRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,Ce))):I===64&&(ce=Tt._GetHalfFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,Ce),c&&Ce==0&&c.push(Tt._GetHalfFloatAsFloatRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,Ce))),t.type=0;else{const ze=ae.textureFloat&&(h&&ae.textureFloatLinearFiltering||!h),We=ae.textureHalfFloat&&(h&&ae.textureHalfFloatLinearFiltering||!h),nt=(I===128||I===64&&!We)&&ze?1:(I===64||I===128&&!ze)&&We?2:0;let ne,Ue=null;switch(I){case 128:{switch(nt){case 1:ne=Tt._GetFloatRGBAArrayBuffer,Ue=null;break;case 2:ne=Tt._GetFloatAsHalfFloatRGBAArrayBuffer,Ue=Tt._GetFloatRGBAArrayBuffer;break;case 0:ne=Tt._GetFloatAsUIntRGBAArrayBuffer,Ue=Tt._GetFloatRGBAArrayBuffer;break}break}default:{switch(nt){case 1:ne=Tt._GetHalfFloatAsFloatRGBAArrayBuffer,Ue=null;break;case 2:ne=Tt._GetHalfFloatRGBAArrayBuffer,Ue=Tt._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:ne=Tt._GetHalfFloatAsUIntRGBAArrayBuffer,Ue=Tt._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}t.type=nt,ce=ne(p,_,i.byteOffset+E,g,i.buffer,Ce),c&&Ce==0&&c.push(Ue?Ue(p,_,i.byteOffset+E,g,i.buffer,Ce):ce)}ce&&e._uploadDataToTextureDirectly(t,ce,_e,Ce)}else if(s.isRGB)t.type=0,I===24?(t.format=4,g=p*_*3,R=Tt._GetRGBArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,N,w,G),e._uploadDataToTextureDirectly(t,R,_e,Ce)):(t.format=5,g=p*_*4,R=Tt._GetRGBAArrayBuffer(p,_,i.byteOffset+E,g,i.buffer,N,w,G,k),e._uploadDataToTextureDirectly(t,R,_e,Ce));else if(s.isLuminance){const ce=e._getUnpackAlignement(),ze=p;g=Math.floor((p+ce-1)/ce)*ce*(_-1)+ze,R=Tt._GetLuminanceArrayBuffer(p,_,i.byteOffset+E,g,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,R,_e,Ce)}else g=Math.max(4,p)/4*Math.max(4,_)/4*y,R=new Uint8Array(i.buffer,i.byteOffset+E,g),t.type=0,e._uploadCompressedDataToTextureDirectly(t,b,p,_,R,_e,Ce)}E+=I?p*_*(I/8):g,p*=.5,_*=.5,p=Math.max(1,p),_=Math.max(1,_)}if(l!==void 0)break}c&&c.length>0?s.sphericalPolynomial=bh.ConvertCubeMapToSphericalPolynomial({size:d[Qu],right:c[0],left:c[1],up:c[2],down:c[3],front:c[4],back:c[5],format:5,type:1,gammaSpace:!1}):s.sphericalPolynomial=void 0}}Tt.StoreLODInAlphaChannel=!1;Ie.prototype.createPrefilteredCubeTexture=function(o,e,t,i,s=null,r=null,n,a=null,l=!0){const h=c=>{if(!c){s&&s(null);return}const u=c.texture;if(l?c.info.sphericalPolynomial&&(u._sphericalPolynomial=c.info.sphericalPolynomial):u._sphericalPolynomial=new Tn,u._source=At.CubePrefiltered,this.getCaps().textureLOD){s&&s(u);return}const d=3,f=this._gl,p=c.width;if(!p)return;const _=[];for(let g=0;g<d;g++){const R=1-g/(d-1),x=i,S=Te.Log2(p)*t+i,b=x+(S-x)*R,y=Math.round(Math.min(Math.max(b,0),S)),I=new wi(this,At.Temp);if(I.type=u.type,I.format=u.format,I.width=Math.pow(2,Math.max(Te.Log2(p)-y,0)),I.height=I.width,I.isCube=!0,I._cachedWrapU=0,I._cachedWrapV=0,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,I,!0),I.samplingMode=2,f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),c.isDDS){const N=c.info,w=c.data;this._unpackFlipY(N.isCompressed),Tt.UploadDDSLevels(this,I,w,N,!0,6,y)}else q.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null);const O=new bt(e);O._isCube=!0,O._texture=I,I.isReady=!0,_.push(O)}u._lodTextureHigh=_[2],u._lodTextureMid=_[1],u._lodTextureLow=_[0],s&&s(u)};return this.createCubeTexture(o,e,null,!1,h,r,n,a,l,t,i)};class H0{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,s){const r=t.getEngine();let n,a=!1,l=1e3;if(Array.isArray(e))for(let h=0;h<e.length;h++){const c=e[h];n=Tt.GetDDSInfo(c),t.width=n.width,t.height=n.height,a=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),Tt.UploadDDSLevels(r,t,c,n,a,6,-1,h),!n.isFourCC&&n.mipmapCount===1?r.generateMipMapsForCubemap(t):l=n.mipmapCount-1}else{const h=e;n=Tt.GetDDSInfo(h),t.width=n.width,t.height=n.height,i&&(n.sphericalPolynomial=new Tn),a=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),Tt.UploadDDSLevels(r,t,h,n,a,6),!n.isFourCC&&n.mipmapCount===1?r.generateMipMapsForCubemap(t,!1):l=n.mipmapCount-1}r._setCubeMapTextureParams(t,a,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:n,data:e,texture:t})}loadData(e,t,i){const s=Tt.GetDDSInfo(e),r=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&s.width>>s.mipmapCount-1===1;i(s.width,s.height,r,s.isFourCC,()=>{Tt.UploadDDSLevels(t.getEngine(),t,e,s,r,1)})}}H._TextureLoaders.push(new H0);class Jp{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data){const i=this._data[t];e(t,i)}}first(e){for(const t in this._data){const i=this._data[t],s=e(t,i);if(s)return s}return null}}class da{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[]}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,i,s){for(const r in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,r)&&this._BabylonFileParsers[r](e,t,i,s)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}da._BabylonFileParsers={};da._IndividualBabylonFileParsers={};class ir{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,i,s,r,n;const a=(s=(i=(t=this._externalProperties)===null||t===void 0?void 0:t[e])===null||i===void 0?void 0:i.type)!==null&&s!==void 0?s:typeof this[e],l=(n=(r=this._externalProperties)===null||r===void 0?void 0:r[e])===null||n===void 0?void 0:n.default;switch(a){case"number":this[e]=l??0;break;case"string":this[e]=l??"";break;default:this[e]=l??!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=this[i];switch(typeof s){case"number":case"string":e+="#define "+i+" "+s+`
`;break;default:s&&(e+="#define "+i+`
`);break}}return e}}class $t{constructor(){this._dirty=!0,this._tempColor=new He(0,0,0,0),this._globalCurve=new He(0,0,0,0),this._highlightsCurve=new He(0,0,0,0),this._midtonesCurve=new He(0,0,0,0),this._shadowsCurve=new He(0,0,0,0),this._positiveCurve=new He(0,0,0,0),this._negativeCurve=new He(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,s,r){e!=null&&(e=$t._Clamp(e,0,360),t=$t._Clamp(t,-100,100),i=$t._Clamp(i,-100,100),s=$t._Clamp(s,-100,100),t=$t._ApplyColorGradingSliderNonlinear(t),t*=.5,s=$t._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),$t._FromHSBToRef(e,t,50+.25*s,r),r.scaleToRef(2,r),r.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,s){let r=$t._Clamp(e,0,360);const n=$t._Clamp(t/100,0,1),a=$t._Clamp(i/100,0,1);if(n===0)s.r=a,s.g=a,s.b=a;else{r/=60;const l=Math.floor(r),h=r-l,c=a*(1-n),u=a*(1-n*h),d=a*(1-n*(1-h));switch(l){case 0:s.r=a,s.g=d,s.b=c;break;case 1:s.r=u,s.g=a,s.b=c;break;case 2:s.r=c,s.g=a,s.b=d;break;case 3:s.r=c,s.g=u,s.b=a;break;case 4:s.r=d,s.g=c,s.b=a;break;default:s.r=a,s.g=c,s.b=u;break}}s.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return Le.Clone(()=>new $t,this)}serialize(){return Le.Serialize(this)}static Parse(e){return Le.Parse(()=>new $t,e,null,null)}}v([M()],$t.prototype,"_globalHue",void 0);v([M()],$t.prototype,"_globalDensity",void 0);v([M()],$t.prototype,"_globalSaturation",void 0);v([M()],$t.prototype,"_globalExposure",void 0);v([M()],$t.prototype,"_highlightsHue",void 0);v([M()],$t.prototype,"_highlightsDensity",void 0);v([M()],$t.prototype,"_highlightsSaturation",void 0);v([M()],$t.prototype,"_highlightsExposure",void 0);v([M()],$t.prototype,"_midtonesHue",void 0);v([M()],$t.prototype,"_midtonesDensity",void 0);v([M()],$t.prototype,"_midtonesSaturation",void 0);v([M()],$t.prototype,"_midtonesExposure",void 0);Le._ColorCurvesParser=$t.Parse;class st{constructor(){this.colorCurves=new $t,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=st.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new He(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=st.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new j}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&$t.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===st._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case st.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&$t.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),s=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const r=t??s/i;let n=Math.tan(this.vignetteCameraFov*.5),a=n*r;const l=Math.sqrt(a*n);a=Y.Mix(a,l,this.vignetteStretch),n=Y.Mix(n,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,n,-a*this.vignetteCenterX,-n*this.vignetteCenterY);const h=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,h)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return Le.Clone(()=>new st,this)}serialize(){return Le.Serialize(this)}static Parse(e){const t=Le.Parse(()=>new st,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}st.TONEMAPPING_STANDARD=0;st.TONEMAPPING_ACES=1;st._VIGNETTEMODE_MULTIPLY=0;st._VIGNETTEMODE_OPAQUE=1;v([c0()],st.prototype,"colorCurves",void 0);v([M()],st.prototype,"_colorCurvesEnabled",void 0);v([rt("colorGradingTexture")],st.prototype,"_colorGradingTexture",void 0);v([M()],st.prototype,"_colorGradingEnabled",void 0);v([M()],st.prototype,"_colorGradingWithGreenDepth",void 0);v([M()],st.prototype,"_colorGradingBGR",void 0);v([M()],st.prototype,"_exposure",void 0);v([M()],st.prototype,"_toneMappingEnabled",void 0);v([M()],st.prototype,"_toneMappingType",void 0);v([M()],st.prototype,"_contrast",void 0);v([M()],st.prototype,"vignetteStretch",void 0);v([M()],st.prototype,"vignetteCenterX",void 0);v([M()],st.prototype,"vignetteCenterY",void 0);v([M()],st.prototype,"vignetteWeight",void 0);v([Tm()],st.prototype,"vignetteColor",void 0);v([M()],st.prototype,"vignetteCameraFov",void 0);v([M()],st.prototype,"_vignetteBlendMode",void 0);v([M()],st.prototype,"_vignetteEnabled",void 0);v([M()],st.prototype,"_ditheringEnabled",void 0);v([M()],st.prototype,"_ditheringIntensity",void 0);v([M()],st.prototype,"_skipFinalColorClamp",void 0);v([M()],st.prototype,"_applyByPostProcess",void 0);v([M()],st.prototype,"_isEnabled",void 0);Le._ImageProcessingConfigurationParser=st.Parse;Ie.prototype.createUniformBuffer=function(o,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");const i=new fh(t);return this.bindUniformBuffer(i),o instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,o,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(o),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};Ie.prototype.createDynamicUniformBuffer=function(o,e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");const i=new fh(t);return this.bindUniformBuffer(i),o instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,o,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(o),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};Ie.prototype.updateUniformBuffer=function(o,e,t,i){this.bindUniformBuffer(o),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};Ie.prototype.bindUniformBuffer=function(o){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,o?o.underlyingResource:null)};Ie.prototype.bindUniformBufferBase=function(o,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,o?o.underlyingResource:null)};Ie.prototype.bindUniformBlock=function(o,e,t){const i=o.program,s=this._gl.getUniformBlockIndex(i,e);s!==4294967295&&this._gl.uniformBlockBinding(i,s,t)};class ve{constructor(e,t,i,s,r=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=i,this._name=s??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const s=this._uniformLocationPointer-i;for(let r=0;r<s;r++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let s;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{const n=(4-t)*i;t=t*i+n}s=[];for(let r=0;r<t;r++)s.push(0)}else{if(t instanceof Array)s=t,t=s.length;else{t=t,s=[];for(let r=0;r<t;r++)s.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let r=0;r<t;r++)this._data.push(s[r]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){const s=[t,i];this.addUniform(e,s)}addFloat3(e,t,i,s){const r=[t,i,s];this.addUniform(e,r)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const s=[t.r,t.g,t.b,i];this.addUniform(e,s)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){const e=[];for(const t in this._uniformLocations)e.push(t);return e.join(",")}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(ve._UpdatedUbosInFrame[this._name]||(ve._UpdatedUbosInFrame[this._name]=0),ve._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let s=this._uniformLocations[e];if(s===void 0){if(this._buffer){q.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,i),s=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let r=0;r<i;r++)this._bufferData[s+r]=t[r];else{let r=!1;for(let n=0;n<i;n++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[s+n]!==Math.fround(t[n]))&&(r=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+n]=t[n]);this._needSync=this._needSync||r}}updateUniformArray(e,t,i){this._checkNewFrame();const s=this._uniformLocations[e];if(s===void 0){q.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();const r=this._uniformArraySizes[e];if(this._dynamic)for(let n=0;n<i;n++)this._bufferData[s+n]=t[n];else{let n=!1,a=0,l=0;for(let h=0;h<i;h++)if(this._bufferData[s+l*4+a]!==Y.FloatRound(t[h])&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+l*4+a]=t[h]),a++,a===r.strideSize){for(;a<4;a++)this._bufferData[s+l*4+a]=0;a=0,l++}this._needSync=this._needSync||n}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],s=t.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[e]=s,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)ve._TempBuffer[i*4]=t[i*3],ve._TempBuffer[i*4+1]=t[i*3+1],ve._TempBuffer[i*4+2]=t[i*3+2],ve._TempBuffer[i*4+3]=0;this.updateUniform(e,ve._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)ve._TempBuffer[i*4]=t[i*2],ve._TempBuffer[i*4+1]=t[i*2+1],ve._TempBuffer[i*4+2]=0,ve._TempBuffer[i*4+3]=0;this.updateUniform(e,ve._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){ve._TempBuffer[0]=t,this.updateUniform(e,ve._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i)}_updateFloat2ForUniform(e,t,i){ve._TempBuffer[0]=t,ve._TempBuffer[1]=i,this.updateUniform(e,ve._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,s,r=""){this._currentEffect.setFloat3(e+r,t,i,s)}_updateFloat3ForUniform(e,t,i,s){ve._TempBuffer[0]=t,ve._TempBuffer[1]=i,ve._TempBuffer[2]=s,this.updateUniform(e,ve._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setFloat4(e+n,t,i,s,r)}_updateFloat4ForUniform(e,t,i,s,r){ve._TempBuffer[0]=t,ve._TempBuffer[1]=i,ve._TempBuffer[2]=s,ve._TempBuffer[3]=r,this.updateUniform(e,ve._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){ve._TempBufferInt32View.set(t),this.updateUniformArray(e,ve._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){ve._TempBufferUInt32View.set(t),this.updateUniformArray(e,ve._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){ve._TempBuffer[0]=t.x,ve._TempBuffer[1]=t.y,ve._TempBuffer[2]=t.z,this.updateUniform(e,ve._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){ve._TempBuffer[0]=t.x,ve._TempBuffer[1]=t.y,ve._TempBuffer[2]=t.z,ve._TempBuffer[3]=t.w,this.updateUniform(e,ve._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){ve._TempBuffer[0]=t.r,ve._TempBuffer[1]=t.g,ve._TempBuffer[2]=t.b,this.updateUniform(e,ve._TempBuffer,3)}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){ve._TempBuffer[0]=t.r,ve._TempBuffer[1]=t.g,ve._TempBuffer[2]=t.b,ve._TempBuffer[3]=i,this.updateUniform(e,ve._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){ve._TempBuffer[0]=t.r,ve._TempBuffer[1]=t.g,ve._TempBuffer[2]=t.b,ve._TempBuffer[3]=t.a,this.updateUniform(e,ve._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){ve._TempBufferInt32View[0]=t,this.updateUniform(e,ve._TempBuffer,1)}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i)}_updateInt2ForUniform(e,t,i){ve._TempBufferInt32View[0]=t,ve._TempBufferInt32View[1]=i,this.updateUniform(e,ve._TempBuffer,2)}_updateInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setInt3(e+r,t,i,s)}_updateInt3ForUniform(e,t,i,s){ve._TempBufferInt32View[0]=t,ve._TempBufferInt32View[1]=i,ve._TempBufferInt32View[2]=s,this.updateUniform(e,ve._TempBuffer,3)}_updateInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setInt4(e+n,t,i,s,r)}_updateInt4ForUniform(e,t,i,s,r){ve._TempBufferInt32View[0]=t,ve._TempBufferInt32View[1]=i,ve._TempBufferInt32View[2]=s,ve._TempBufferInt32View[3]=r,this.updateUniform(e,ve._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){ve._TempBufferUInt32View[0]=t,this.updateUniform(e,ve._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,s=""){this._currentEffect.setUInt2(e+s,t,i)}_updateUInt2ForUniform(e,t,i){ve._TempBufferUInt32View[0]=t,ve._TempBufferUInt32View[1]=i,this.updateUniform(e,ve._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setUInt3(e+r,t,i,s)}_updateUInt3ForUniform(e,t,i,s){ve._TempBufferUInt32View[0]=t,ve._TempBufferUInt32View[1]=i,ve._TempBufferUInt32View[2]=s,this.updateUniform(e,ve._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setUInt4(e+n,t,i,s,r)}_updateUInt4ForUniform(e,t,i,s,r){ve._TempBufferUInt32View[0]=t,ve._TempBufferUInt32View[1]=i,ve._TempBufferUInt32View[2]=s,ve._TempBufferUInt32View[3]=r,this.updateUniform(e,ve._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const s=this._buffers[i][0];this._engine._releaseBuffer(s)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}ve._UpdatedUbosInFrame={};ve._MAX_UNIFORM_SIZE=256;ve._TempBuffer=new Float32Array(ve._MAX_UNIFORM_SIZE);ve._TempBufferInt32View=new Int32Array(ve._TempBuffer.buffer);ve._TempBufferUInt32View=new Uint32Array(ve._TempBuffer.buffer);class pr{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(T.NormalKind))return null;let i=this.pickedMesh.getIndices();(i==null?void 0:i.length)===0&&(i=null);let s;const r=D.Vector3[0],n=D.Vector3[1],a=D.Vector3[2];if(t){const h=this.pickedMesh.getVerticesData(T.NormalKind);let c=i?m.FromArrayToRef(h,i[this.faceId*3]*3,r):r.copyFromFloats(h[this.faceId*3*3],h[this.faceId*3*3+1],h[this.faceId*3*3+2]),u=i?m.FromArrayToRef(h,i[this.faceId*3+1]*3,n):n.copyFromFloats(h[(this.faceId*3+1)*3],h[(this.faceId*3+1)*3+1],h[(this.faceId*3+1)*3+2]),d=i?m.FromArrayToRef(h,i[this.faceId*3+2]*3,a):a.copyFromFloats(h[(this.faceId*3+2)*3],h[(this.faceId*3+2)*3+1],h[(this.faceId*3+2)*3+2]);c=c.scale(this.bu),u=u.scale(this.bv),d=d.scale(1-this.bu-this.bv),s=new m(c.x+u.x+d.x,c.y+u.y+d.y,c.z+u.z+d.z)}else{const h=this.pickedMesh.getVerticesData(T.PositionKind),c=i?m.FromArrayToRef(h,i[this.faceId*3]*3,r):r.copyFromFloats(h[this.faceId*3*3],h[this.faceId*3*3+1],h[this.faceId*3*3+2]),u=i?m.FromArrayToRef(h,i[this.faceId*3+1]*3,n):n.copyFromFloats(h[(this.faceId*3+1)*3],h[(this.faceId*3+1)*3+1],h[(this.faceId*3+1)*3+2]),d=i?m.FromArrayToRef(h,i[this.faceId*3+2]*3,a):a.copyFromFloats(h[(this.faceId*3+2)*3],h[(this.faceId*3+2)*3+1],h[(this.faceId*3+2)*3+2]),f=c.subtract(u),p=d.subtract(u);s=m.Cross(f,p)}const l=(h,c)=>{let u=h.getWorldMatrix();h.nonUniformScaling&&(D.Matrix[0].copyFrom(u),u=D.Matrix[0],u.setTranslationFromFloats(0,0,0),u.invert(),u.transposeToRef(D.Matrix[1]),u=D.Matrix[1]),m.TransformNormalToRef(c,u,c)};if(e&&l(this.pickedMesh,s),this.ray){const h=D.Vector3[0].copyFrom(s);e||l(this.pickedMesh,h),m.Dot(h,this.ray.direction)>0&&s.negateInPlace()}return s.normalize(),s}getTextureCoordinates(e=T.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;const t=this.pickedMesh.getIndices();if(!t)return null;const i=this.pickedMesh.getVerticesData(e);if(!i)return null;let s=Ke.FromArray(i,t[this.faceId*3]*2),r=Ke.FromArray(i,t[this.faceId*3+1]*2),n=Ke.FromArray(i,t[this.faceId*3+2]*2);return s=s.scale(this.bu),r=r.scale(this.bv),n=n.scale(1-this.bu-this.bv),new Ke(s.x+r.x+n.x,s.y+r.y+n.y)}}class Mi{constructor(e,t,i,s,r,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=r,this.additionalData=n}static CreateNew(e,t,i){const s=e.getScene();return new Mi(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new Mi(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new Mi(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new Mi(e,t.x,t.y,null,i,s)}}class pe{}pe.NAME_EFFECTLAYER="EffectLayer";pe.NAME_LAYER="Layer";pe.NAME_LENSFLARESYSTEM="LensFlareSystem";pe.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";pe.NAME_PARTICLESYSTEM="ParticleSystem";pe.NAME_GAMEPAD="Gamepad";pe.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";pe.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";pe.NAME_PREPASSRENDERER="PrePassRenderer";pe.NAME_DEPTHRENDERER="DepthRenderer";pe.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";pe.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";pe.NAME_SPRITE="Sprite";pe.NAME_SUBSURFACE="SubSurface";pe.NAME_OUTLINERENDERER="Outline";pe.NAME_PROCEDURALTEXTURE="ProceduralTexture";pe.NAME_SHADOWGENERATOR="ShadowGenerator";pe.NAME_OCTREE="Octree";pe.NAME_PHYSICSENGINE="PhysicsEngine";pe.NAME_AUDIO="Audio";pe.NAME_FLUIDRENDERER="FluidRenderer";pe.STEP_ISREADYFORMESH_EFFECTLAYER=0;pe.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;pe.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;pe.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;pe.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;pe.STEP_BEFORECAMERADRAW_PREPASS=0;pe.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;pe.STEP_BEFORECAMERADRAW_LAYER=2;pe.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;pe.STEP_BEFORERENDERTARGETDRAW_LAYER=1;pe.STEP_BEFORERENDERINGMESH_PREPASS=0;pe.STEP_BEFORERENDERINGMESH_OUTLINE=1;pe.STEP_AFTERRENDERINGMESH_PREPASS=0;pe.STEP_AFTERRENDERINGMESH_OUTLINE=1;pe.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;pe.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;pe.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;pe.STEP_BEFORECAMERAUPDATE_GAMEPAD=1;pe.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;pe.STEP_BEFORECLEAR_PREPASS=1;pe.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;pe.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;pe.STEP_AFTERRENDERTARGETDRAW_LAYER=1;pe.STEP_AFTERCAMERADRAW_PREPASS=0;pe.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;pe.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;pe.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;pe.STEP_AFTERCAMERADRAW_LAYER=4;pe.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5;pe.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;pe.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;pe.STEP_AFTERRENDER_AUDIO=0;pe.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;pe.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;pe.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;pe.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;pe.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;pe.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1;pe.STEP_POINTERMOVE_SPRITE=0;pe.STEP_POINTERDOWN_SPRITE=0;pe.STEP_POINTERUP_SPRITE=0;class si extends Array{constructor(e){super(...e)}static Create(){return Object.create(si.prototype)}registerStep(e,t,i){let s=0,r=Number.MAX_VALUE;for(;s<this.length&&(r=this[s].index,!(e<r));s++);this.splice(s,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class xe{}xe.POINTERDOWN=1;xe.POINTERUP=2;xe.POINTERMOVE=4;xe.POINTERWHEEL=8;xe.POINTERPICK=16;xe.POINTERTAP=32;xe.POINTERDOUBLETAP=64;class Dm{constructor(e,t){this.type=e,this.event=t}}class W0 extends Dm{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new Ke(i,s)}}class Ls extends Dm{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,s=null){super(e,t),this._pickInfo=i,this._inputManager=s}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}class Ms{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1}static get HasTriggers(){for(const e in Ms.Triggers)if(Object.prototype.hasOwnProperty.call(Ms.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in Ms.Triggers)if(Object.prototype.hasOwnProperty.call(Ms.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in Ms.Triggers)if(Object.prototype.hasOwnProperty.call(Ms.Triggers,t)&&parseInt(t)===e)return!0;return!1}}Ms.Triggers={};class to{}to.KEYDOWN=1;to.KEYUP=2;class Td{constructor(e,t){this.type=e,this.event=t}}class eg extends Td{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}var Pe;(function(o){o[o.Generic=0]="Generic",o[o.Keyboard=1]="Keyboard",o[o.Mouse=2]="Mouse",o[o.Touch=3]="Touch",o[o.DualShock=4]="DualShock",o[o.Xbox=5]="Xbox",o[o.Switch=6]="Switch",o[o.DualSense=7]="DualSense"})(Pe||(Pe={}));var Xe;(function(o){o[o.Horizontal=0]="Horizontal",o[o.Vertical=1]="Vertical",o[o.LeftClick=2]="LeftClick",o[o.MiddleClick=3]="MiddleClick",o[o.RightClick=4]="RightClick",o[o.BrowserBack=5]="BrowserBack",o[o.BrowserForward=6]="BrowserForward",o[o.MouseWheelX=7]="MouseWheelX",o[o.MouseWheelY=8]="MouseWheelY",o[o.MouseWheelZ=9]="MouseWheelZ",o[o.Move=12]="Move"})(Xe||(Xe={}));var Nc;(function(o){o[o.Horizontal=0]="Horizontal",o[o.Vertical=1]="Vertical",o[o.LeftClick=2]="LeftClick",o[o.MiddleClick=3]="MiddleClick",o[o.RightClick=4]="RightClick",o[o.BrowserBack=5]="BrowserBack",o[o.BrowserForward=6]="BrowserForward",o[o.MouseWheelX=7]="MouseWheelX",o[o.MouseWheelY=8]="MouseWheelY",o[o.MouseWheelZ=9]="MouseWheelZ",o[o.DeltaHorizontal=10]="DeltaHorizontal",o[o.DeltaVertical=11]="DeltaVertical"})(Nc||(Nc={}));var tg;(function(o){o[o.Cross=0]="Cross",o[o.Circle=1]="Circle",o[o.Square=2]="Square",o[o.Triangle=3]="Triangle",o[o.L1=4]="L1",o[o.R1=5]="R1",o[o.L2=6]="L2",o[o.R2=7]="R2",o[o.Share=8]="Share",o[o.Options=9]="Options",o[o.L3=10]="L3",o[o.R3=11]="R3",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.TouchPad=17]="TouchPad",o[o.LStickXAxis=18]="LStickXAxis",o[o.LStickYAxis=19]="LStickYAxis",o[o.RStickXAxis=20]="RStickXAxis",o[o.RStickYAxis=21]="RStickYAxis"})(tg||(tg={}));var ig;(function(o){o[o.Cross=0]="Cross",o[o.Circle=1]="Circle",o[o.Square=2]="Square",o[o.Triangle=3]="Triangle",o[o.L1=4]="L1",o[o.R1=5]="R1",o[o.L2=6]="L2",o[o.R2=7]="R2",o[o.Create=8]="Create",o[o.Options=9]="Options",o[o.L3=10]="L3",o[o.R3=11]="R3",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.TouchPad=17]="TouchPad",o[o.LStickXAxis=18]="LStickXAxis",o[o.LStickYAxis=19]="LStickYAxis",o[o.RStickXAxis=20]="RStickXAxis",o[o.RStickYAxis=21]="RStickYAxis"})(ig||(ig={}));var sg;(function(o){o[o.A=0]="A",o[o.B=1]="B",o[o.X=2]="X",o[o.Y=3]="Y",o[o.LB=4]="LB",o[o.RB=5]="RB",o[o.LT=6]="LT",o[o.RT=7]="RT",o[o.Back=8]="Back",o[o.Start=9]="Start",o[o.LS=10]="LS",o[o.RS=11]="RS",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.LStickXAxis=17]="LStickXAxis",o[o.LStickYAxis=18]="LStickYAxis",o[o.RStickXAxis=19]="RStickXAxis",o[o.RStickYAxis=20]="RStickYAxis"})(sg||(sg={}));var rg;(function(o){o[o.B=0]="B",o[o.A=1]="A",o[o.Y=2]="Y",o[o.X=3]="X",o[o.L=4]="L",o[o.R=5]="R",o[o.ZL=6]="ZL",o[o.ZR=7]="ZR",o[o.Minus=8]="Minus",o[o.Plus=9]="Plus",o[o.LS=10]="LS",o[o.RS=11]="RS",o[o.DPadUp=12]="DPadUp",o[o.DPadDown=13]="DPadDown",o[o.DPadLeft=14]="DPadLeft",o[o.DPadRight=15]="DPadRight",o[o.Home=16]="Home",o[o.Capture=17]="Capture",o[o.LStickXAxis=18]="LStickXAxis",o[o.LStickYAxis=19]="LStickYAxis",o[o.RStickXAxis=20]="RStickXAxis",o[o.RStickYAxis=21]="RStickYAxis"})(rg||(rg={}));var ng;(function(o){o[o.PointerMove=0]="PointerMove",o[o.PointerDown=1]="PointerDown",o[o.PointerUp=2]="PointerUp"})(ng||(ng={}));class vl{}vl.DOM_DELTA_PIXEL=0;vl.DOM_DELTA_LINE=1;vl.DOM_DELTA_PAGE=2;class Yn{static CreateDeviceEvent(e,t,i,s,r,n,a){switch(e){case Pe.Keyboard:return this._CreateKeyboardEvent(i,s,r,n);case Pe.Mouse:if(i===Xe.MouseWheelX||i===Xe.MouseWheelY||i===Xe.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,r,n);case Pe.Touch:return this._CreatePointerEvent(e,t,i,s,r,n,a);default:throw`Unable to generate event for device ${Pe[e]}`}}static _CreatePointerEvent(e,t,i,s,r,n,a){const l=this._CreateMouseEvent(e,t,i,s,r,n);e===Pe.Mouse?(l.deviceType=Pe.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=Pe.Touch,l.pointerId=a??t,l.pointerType="touch");let h=0;return h+=r.pollInput(e,t,Xe.LeftClick),h+=r.pollInput(e,t,Xe.RightClick)*2,h+=r.pollInput(e,t,Xe.MiddleClick)*4,l.buttons=h,i===Xe.Move?l.type="pointermove":i>=Xe.LeftClick&&i<=Xe.RightClick&&(l.type=s===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,s,r,n){const a=this._CreateMouseEvent(e,t,i,s,r,n);switch(a.pointerId=1,a.type="wheel",a.deltaMode=vl.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case Xe.MouseWheelX:a.deltaX=s;break;case Xe.MouseWheelY:a.deltaY=s;break;case Xe.MouseWheelZ:a.deltaZ=s;break}return a}static _CreateMouseEvent(e,t,i,s,r,n){const a=this._CreateEvent(n),l=r.pollInput(e,t,Xe.Horizontal),h=r.pollInput(e,t,Xe.Vertical);return n?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-n.getBoundingClientRect().x,a.offsetY=a.movementY-n.getBoundingClientRect().y):(a.movementX=r.pollInput(e,t,Nc.DeltaHorizontal),a.movementY=r.pollInput(e,t,Nc.DeltaVertical),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,r),a.clientX=l,a.clientY=h,a.x=l,a.y=h,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}static _CreateKeyboardEvent(e,t,i,s){const r=this._CreateEvent(s);return this._CheckNonCharacterKeys(r,i),r.deviceType=Pe.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=t===1?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Pe.Keyboard),s=i&&t.pollInput(Pe.Keyboard,0,18)===1,r=i&&t.pollInput(Pe.Keyboard,0,17)===1,n=i&&(t.pollInput(Pe.Keyboard,0,91)===1||t.pollInput(Pe.Keyboard,0,92)===1||t.pollInput(Pe.Keyboard,0,93)===1),a=i&&t.pollInput(Pe.Keyboard,0,16)===1;e.altKey=s,e.ctrlKey=r,e.metaKey=n,e.shiftKey=a}static _CreateEvent(e){const t={};return t.preventDefault=()=>{},t.target=e,t}}class X0{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(s,r,n,a)=>{const l=Yn.CreateDeviceEvent(s,r,n,a,this);i(s,r,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Pe.Mouse||e===Pe.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const ag=255,og=Object.keys(Xe).length/2;class Y0{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=Y.IsSafari(),this._usingMacOS=Jl()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=r=>{},this._keyboardUpEvent=r=>{},this._keyboardBlurEvent=r=>{},this._pointerMoveEvent=r=>{},this._pointerDownEvent=r=>{},this._pointerUpEvent=r=>{},this._pointerCancelEvent=r=>{},this._pointerWheelEvent=r=>{},this._pointerBlurEvent=r=>{},this._pointerMacOSChromeOutEvent=r=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Jl()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._isUsingChromium=Jl()&&navigator.userAgent&&navigator.userAgent.indexOf("Chrome")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=r=>{},this._gamepadDisconnectedEvent=r=>{},this._eventPrefix=Y.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const s=this._inputs[e][t];if(!s)throw`Unable to find device ${Pe[e]}`;e>=Pe.DualShock&&e<=Pe.DualSense&&this._updateDevice(e,t,i);const r=s[i];if(r===void 0)throw`Unable to find input ${i} for device ${Pe[e]} in slot ${t}`;return i===Xe.Move&&Y.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const t of this._inputs)if(t)for(const i in t){const s=+i,r=t[s];if(r)for(let n=0;n<r.length;n++)r[n]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Pe.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,og);const r=this._inputs[e][t];r[0]=i,r[1]=s}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${Pe[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Pe.Keyboard,0,ag));const t=this._inputs[Pe.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Pe.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Pe.Keyboard,0,ag));const t=this._inputs[Pe.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const s of this._metaKeys){const r=Yn.CreateDeviceEvent(Pe.Keyboard,0,s,0,this,this._elementToAttachTo);t[s]=0,this._onInputChanged(Pe.Keyboard,0,r)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Pe.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Pe.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;const i=Yn.CreateDeviceEvent(Pe.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Pe.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Jl()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const s=this._getPointerType(i);let r=s===Pe.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(s===Pe.Touch&&r===-1){const a=this._activeTouchIds.indexOf(-1);if(a>=0)r=a,this._activeTouchIds[a]=i.pointerId,this._onDeviceConnected(s,r);else{Y.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[s]||(this._inputs[s]={}),this._inputs[s][r]||this._addPointerDevice(s,r,i.clientX,i.clientY);const n=this._inputs[s][r];if(n){const a=i;a.inputIndex=Xe.Move,n[Xe.Horizontal]=i.clientX,n[Xe.Vertical]=i.clientY,s===Pe.Touch&&n[Xe.LeftClick]===0&&(n[Xe.LeftClick]=1),i.pointerId===void 0&&(i.pointerId=this._mouseId),this._onInputChanged(s,r,a),!this._usingSafari&&i.button!==-1&&(a.inputIndex=i.button+2,n[i.button+2]=n[i.button+2]?0:1,this._onInputChanged(s,r,a))}},this._pointerDownEvent=i=>{const s=this._getPointerType(i);let r=s===Pe.Mouse?0:i.pointerId;if(s===Pe.Touch){const a=this._activeTouchIds.indexOf(-1);if(a>=0)r=a,this._activeTouchIds[a]=i.pointerId;else{Y.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[s]||(this._inputs[s]={}),this._inputs[s][r]?s===Pe.Touch&&this._onDeviceConnected(s,r):this._addPointerDevice(s,r,i.clientX,i.clientY);const n=this._inputs[s][r];if(n){const a=n[Xe.Horizontal],l=n[Xe.Vertical];if(s===Pe.Mouse){if(i.pointerId===void 0&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}n[Xe.Horizontal]=i.clientX,n[Xe.Vertical]=i.clientY,n[i.button+2]=1;const h=i;h.inputIndex=i.button+2,this._onInputChanged(s,r,h),(a!==i.clientX||l!==i.clientY)&&(h.inputIndex=Xe.Move,this._onInputChanged(s,r,h))}},this._pointerUpEvent=i=>{var s,r,n,a,l;const h=this._getPointerType(i),c=h===Pe.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(h===Pe.Touch){if(c===-1)return;this._activeTouchIds[c]=-1}const u=(s=this._inputs[h])===null||s===void 0?void 0:s[c];if(u&&u[i.button+2]!==0){const d=u[Xe.Horizontal],f=u[Xe.Vertical];u[Xe.Horizontal]=i.clientX,u[Xe.Vertical]=i.clientY,u[i.button+2]=0;const p=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),(d!==i.clientX||f!==i.clientY)&&(p.inputIndex=Xe.Move,this._onInputChanged(h,c,p)),p.inputIndex=i.button+2,h===Pe.Mouse&&this._mouseId>=0&&(!((n=(r=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(r,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&(!((l=(a=this._elementToAttachTo).hasPointerCapture)===null||l===void 0)&&l.call(a,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(h,c,p),h===Pe.Touch&&this._onDeviceDisconnected(h,c)}},this._pointerCancelEvent=i=>{var s,r,n,a;if(i.pointerType==="mouse"){const l=this._inputs[Pe.Mouse][0];this._mouseId>=0&&(!((r=(s=this._elementToAttachTo).hasPointerCapture)===null||r===void 0)&&r.call(s,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let h=Xe.LeftClick;h<=Xe.BrowserForward;h++)if(l[h]===1){l[h]=0;const c=Yn.CreateDeviceEvent(Pe.Mouse,0,h,0,this,this._elementToAttachTo);this._onInputChanged(Pe.Mouse,0,c)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);if(l===-1)return;!((a=(n=this._elementToAttachTo).hasPointerCapture)===null||a===void 0)&&a.call(n,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[Pe.Touch][l][Xe.LeftClick]=0;const h=Yn.CreateDeviceEvent(Pe.Touch,l,Xe.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(Pe.Touch,l,h),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(Pe.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{var i,s,r,n,a;if(this.isDeviceAvailable(Pe.Mouse)){const l=this._inputs[Pe.Mouse][0];this._mouseId>=0&&(!((s=(i=this._elementToAttachTo).hasPointerCapture)===null||s===void 0)&&s.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let h=Xe.LeftClick;h<=Xe.BrowserForward;h++)if(l[h]===1){l[h]=0;const c=Yn.CreateDeviceEvent(Pe.Mouse,0,h,0,this,this._elementToAttachTo);this._onInputChanged(Pe.Mouse,0,c)}}if(this.isDeviceAvailable(Pe.Touch)){const l=this._inputs[Pe.Touch];for(let h=0;h<this._activeTouchIds.length;h++){const c=this._activeTouchIds[h];if(!((n=(r=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(r,c)&&this._elementToAttachTo.releasePointerCapture(c),c!==-1&&((a=l[h])===null||a===void 0?void 0:a[Xe.LeftClick])===1){l[h][Xe.LeftClick]=0;const u=Yn.CreateDeviceEvent(Pe.Touch,h,Xe.LeftClick,0,this,this._elementToAttachTo,c);this._onInputChanged(Pe.Touch,h,u),this._activeTouchIds[h]=-1,this._onDeviceDisconnected(Pe.Touch,h)}}}},this._pointerWheelEvent=i=>{const s=Pe.Mouse,r=0;this._inputs[s]||(this._inputs[s]=[]),this._inputs[s][r]||(this._pointerActive=!0,this._registerDevice(s,r,og));const n=this._inputs[s][r];if(n){n[Xe.MouseWheelX]=i.deltaX||0,n[Xe.MouseWheelY]=i.deltaY||i.wheelDelta||0,n[Xe.MouseWheelZ]=i.deltaZ||0;const a=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),n[Xe.MouseWheelX]!==0&&(a.inputIndex=Xe.MouseWheelX,this._onInputChanged(s,r,a)),n[Xe.MouseWheelY]!==0&&(a.inputIndex=Xe.MouseWheelY,this._onInputChanged(s,r,a)),n[Xe.MouseWheelZ]!==0&&(a.inputIndex=Xe.MouseWheelZ,this._onInputChanged(s,r,a))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=i=>{i.buttons>1&&this._pointerCancelEvent(i)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(Pe.Mouse)){const i=this._inputs[Pe.Mouse][0];i[Xe.MouseWheelX]=0,i[Xe.MouseWheelY]=0,i[Xe.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){const r=this._inputs[e][t];i>=s.buttons.length?r[i]=s.axes[i-s.buttons.length].valueOf():r[i]=s.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?Pe.DualSense:Pe.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?Pe.Xbox:e.indexOf("057e")!==-1?Pe.Switch:Pe.Generic}_getPointerType(e){let t=Pe.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=Pe.Touch),t}}class lg{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new j,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class K0{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=n=>{for(let a=0;a<this._devices.length;a++){const l=this._devices[a];for(const h in l){const c=+h;n._addDevice(new lg(this._deviceInputSystem,a,c))}}this._registeredManagers.push(n)},this.unregisterManager=n=>{const a=this._registeredManagers.indexOf(n);a>-1&&this._registeredManagers.splice(a,1)};const t=Object.keys(Pe).length/2;this._devices=new Array(t);const i=(n,a)=>{this._devices[n]||(this._devices[n]=new Array),this._devices[n][a]||(this._devices[n][a]=a);for(const l of this._registeredManagers){const h=new lg(this._deviceInputSystem,n,a);l._addDevice(h)}},s=(n,a)=>{var l;!((l=this._devices[n])===null||l===void 0)&&l[a]&&delete this._devices[n][a];for(const h of this._registeredManagers)h._removeDevice(n,a)},r=(n,a,l)=>{if(l)for(const h of this._registeredManagers)h._onInputChanged(n,a,l)};typeof _native<"u"?this._deviceInputSystem=new X0(i,s,r):this._deviceInputSystem=new Y0(e,i,s,r)}dispose(){this._deviceInputSystem.dispose()}}class $0{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){const t=Object.keys(Pe).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new K0(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new j(i=>{for(const s of this._devices)if(s)for(const r of s)r&&this.onDeviceConnectedObservable.notifyObserver(i,r)}),this.onDeviceDisconnectedObservable=new j,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,s;const r=(i=this._devices[e])===null||i===void 0?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(r),!((s=this._devices[e])===null||s===void 0)&&s[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var s,r;(r=(s=this._devices[e])===null||s===void 0?void 0:s[t])===null||r===void 0||r.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Pe.Keyboard:case Pe.Mouse:this._firstDevice[e]=0;break;case Pe.Touch:case Pe.DualSense:case Pe.DualShock:case Pe.Xbox:case Pe.Switch:case Pe.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}class hg{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class ni{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new Ke(0,0),this._previousStartingPointerPosition=new Ke(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||Ze.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new Ke(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,s=i.getEngine(),r=s.getInputElement();r&&(r.tabIndex=s.canvasTabIndex,i.doNotHandleCursors||(r.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(const l of i._pointerMoveStage){e=e||this._pickMove(t);const h=!!(e!=null&&e.pickedMesh);e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,h,r)}const n=t.inputIndex>=Xe.MouseWheelX&&t.inputIndex<=Xe.MouseWheelZ?xe.POINTERWHEEL:xe.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,n));let a;e?(a=new Ls(n,t,e),this._setRayOnPointerInfo(e,t)):(a=new Ls(n,t,null,this),this._movePointerInfo=a),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(a,n)}_setRayOnPointerInfo(e,t){const i=this._scene;e&&i._pickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,L.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){const s=this._scene,r=new W0(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,e.originMesh&&(r.nearInteractionPickingInfo=e)),s.onPrePointerObservable.notifyObservers(r,i),!!r.skipOnPointerObservable}_pickMove(e){const t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){const r=i.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&r&&this._pointerOverMesh){const n=this._pointerOverMesh._getActionManagerForTrigger();n&&n.hasPointerTriggers&&(r.style.cursor=n.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=Xe.Move,!this._checkPrePointerObservable(e,i,xe.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,xe.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e!=null&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const n=e.pickedMesh._getActionManagerForTrigger();if(n){if(n.hasPickTriggers)switch(n.processTrigger(5,Mi.CreateNew(e.pickedMesh,t,e)),t.button){case 0:n.processTrigger(2,Mi.CreateNew(e.pickedMesh,t,e));break;case 1:n.processTrigger(4,Mi.CreateNew(e.pickedMesh,t,e));break;case 2:n.processTrigger(3,Mi.CreateNew(e.pickedMesh,t,e));break}n.hasSpecificTrigger(8)&&window.setTimeout(()=>{const a=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,i.cameraToUseForPointers);a!=null&&a.pickedMesh&&n&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>ni.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,n.processTrigger(8,Mi.CreateNew(a.pickedMesh,t)))},ni.LongPressDelay)}}else for(const n of i._pointerDownStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let s;const r=xe.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,r),s=new Ls(r,t,e),this._setRayOnPointerInfo(e,t)):s=new Ls(r,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(s,r)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){const s=new PointerEvent("pointerup",t);s.inputIndex=Xe.Move;const r=new hg;i?r.doubleClick=!0:r.singleClick=!0,!this._checkPrePointerObservable(e,s,xe.POINTERUP)&&this._processPointerUp(e,s,r)}_processPointerUp(e,t,i){const s=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(s.onPointerPick&&s.onPointerPick(t,e),i.singleClick&&!i.ignore&&s.onPointerObservable.observers.length>this._cameraObserverCount)){const n=xe.POINTERPICK,a=new Ls(n,t,e);this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(a,n)}const r=e.pickedMesh._getActionManagerForTrigger();if(r&&!i.ignore){r.processTrigger(7,Mi.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&r.processTrigger(1,Mi.CreateNew(e.pickedMesh,t,e));const n=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&n&&n.processTrigger(6,Mi.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const r of s._pointerUpStage)e=r.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const r=this._pickedDownMesh._getActionManagerForTrigger(16);r&&r.processTrigger(16,Mi.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){const r=new Ls(xe.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),s.onPointerObservable.notifyObservers(r,xe.POINTERUP),s.onPointerUp&&s.onPointerUp(t,e,xe.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let n=0;if(i.singleClick?n=xe.POINTERTAP:i.doubleClick&&(n=xe.POINTERDOUBLETAP),n){const a=new Ls(n,t,e);s.onPointerObservable.hasObservers()&&s.onPointerObservable.hasSpecificMask(n)&&s.onPointerObservable.notifyObservers(a,n)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,s=null){const r=this._scene,n=r.getEngine();s||(s=n.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new $0(n),this._initActionManager=a=>{if(!this._meshPickProceed){const l=r.skipPointerUpPicking||r._registeredActions===0&&!this._checkForPicking()&&!r.onPointerUp?null:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerUpPredicate,r.pointerUpFastCheck,r.cameraToUseForPointers);this._currentPickResult=l,l&&(a=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return a},this._delayedSimpleClick=(a,l,h)=>{if((Date.now()-this._previousStartingPointerTime>ni.DoubleClickDelay&&!this._doubleClickOccured||a!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,this._delayedClicks[a])){const c=this._delayedClicks[a].evt,u=xe.POINTERTAP,d=new Ls(u,c,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(u)&&r.onPointerObservable.notifyObservers(d,u),this._delayedClicks[a]=null}},this._initClickEvent=(a,l,h,c)=>{var u,d;const f=new hg;this._currentPickResult=null;let p=null,_=a.hasSpecificMask(xe.POINTERPICK)||l.hasSpecificMask(xe.POINTERPICK)||a.hasSpecificMask(xe.POINTERTAP)||l.hasSpecificMask(xe.POINTERTAP)||a.hasSpecificMask(xe.POINTERDOUBLETAP)||l.hasSpecificMask(xe.POINTERDOUBLETAP);!_&&Ms&&(p=this._initActionManager(p,f),p&&(_=p.hasPickTriggers));let g=!1;if(_){const E=h.button;if(f.hasSwiped=this._isPointerSwiping(),!f.hasSwiped){let R=!ni.ExclusiveDoubleClickMode;if(R||(R=!a.hasSpecificMask(xe.POINTERDOUBLETAP)&&!l.hasSpecificMask(xe.POINTERDOUBLETAP),R&&!Ms.HasSpecificTrigger(6)&&(p=this._initActionManager(p,f),p&&(R=!p.hasSpecificTrigger(6)))),R)(Date.now()-this._previousStartingPointerTime>ni.DoubleClickDelay||E!==this._previousButtonPressed)&&(f.singleClick=!0,c(f,this._currentPickResult),g=!0);else{const S={evt:h,clickInfo:f,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,E,f,c),ni.DoubleClickDelay)};this._delayedClicks[E]=S}let x=a.hasSpecificMask(xe.POINTERDOUBLETAP)||l.hasSpecificMask(xe.POINTERDOUBLETAP);!x&&Ms.HasSpecificTrigger(6)&&(p=this._initActionManager(p,f),p&&(x=p.hasSpecificTrigger(6))),x&&(E===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<ni.DoubleClickDelay&&!this._doubleClickOccured?(!f.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,f.doubleClick=!0,f.ignore=!1,ni.ExclusiveDoubleClickMode&&this._delayedClicks[E]&&(clearTimeout((u=this._delayedClicks[E])===null||u===void 0?void 0:u.timeoutId),this._delayedClicks[E]=null),c(f,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E,ni.ExclusiveDoubleClickMode?(this._delayedClicks[E]&&(clearTimeout((d=this._delayedClicks[E])===null||d===void 0?void 0:d.timeoutId),this._delayedClicks[E]=null),c(f,this._previousPickResult)):c(f,this._currentPickResult)),g=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=E))}}g||c(f,this._currentPickResult)},this._onPointerMove=a=>{if(this._updatePointerPosition(a),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>ni.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>ni.DragMovementThreshold),n.isPointerLock&&n._verifyPointerLock(),this._checkPrePointerObservable(null,a,a.inputIndex>=Xe.MouseWheelX&&a.inputIndex<=Xe.MouseWheelZ?xe.POINTERWHEEL:xe.POINTERMOVE)||!r.cameraToUseForPointers&&!r.activeCamera)return;if(r.skipPointerMovePicking){this._processPointerMove(new pr,a);return}r.pointerMovePredicate||(r.pointerMovePredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(h.enablePointerMoveEvents||r.constantlyUpdateMeshUnderPointer||h._getActionManagerForTrigger()!==null)&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&h.layerMask)!==0));const l=r._registeredActions>0||r.constantlyUpdateMeshUnderPointer?this._pickMove(a):null;this._processPointerMove(l,a)},this._onPointerDown=a=>{var l;if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,ni.ExclusiveDoubleClickMode){for(let c=0;c<this._delayedClicks.length;c++)if(this._delayedClicks[c])if(a.button===c)clearTimeout((l=this._delayedClicks[c])===null||l===void 0?void 0:l.timeoutId);else{const u=this._delayedClicks[c].clickInfo;this._doubleClickOccured=!1,u.singleClick=!0,u.ignore=!1;const d=this._delayedClicks[c].evt,f=xe.POINTERTAP,p=new Ls(f,d,this._currentPickResult);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(f)&&r.onPointerObservable.notifyObservers(p,f),this._delayedClicks[c]=null}}if(this._updatePointerPosition(a),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=a.button),r.preventDefaultOnPointerDown&&s&&(a.preventDefault(),s.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,a,xe.POINTERDOWN)||!r.cameraToUseForPointers&&!r.activeCamera)return;this._pointerCaptures[a.pointerId]=!0,r.pointerDownPredicate||(r.pointerDownPredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&c.layerMask)!==0)),this._pickedDownMesh=null;let h;r.skipPointerDownPicking||r._registeredActions===0&&!this._checkForPicking()&&!r.onPointerDown?h=new pr:h=r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerDownPredicate,r.pointerDownFastCheck,r.cameraToUseForPointers),this._processPointerDown(h,a)},this._onPointerUp=a=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(a),r.preventDefaultOnPointerUp&&s&&(a.preventDefault(),s.focus()),this._initClickEvent(r.onPrePointerObservable,r.onPointerObservable,a,(l,h)=>{if(r.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!l.ignore)){if(this._checkPrePointerObservable(null,a,xe.POINTERUP)){this._swipeButtonPressed===a.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),a.buttons===0&&(this._pointerCaptures[a.pointerId]=!1);return}l.hasSwiped||(l.singleClick&&r.onPrePointerObservable.hasSpecificMask(xe.POINTERTAP)&&this._checkPrePointerObservable(null,a,xe.POINTERTAP)&&(this._skipPointerTap=!0),l.doubleClick&&r.onPrePointerObservable.hasSpecificMask(xe.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,a,xe.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[a.pointerId]){this._swipeButtonPressed===a.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}a.buttons===0&&(this._pointerCaptures[a.pointerId]=!1),!(!r.cameraToUseForPointers&&!r.activeCamera)&&(r.pointerUpPredicate||(r.pointerUpPredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&c.layerMask)!==0)),!this._meshPickProceed&&(Ms&&Ms.HasTriggers||this._checkForPicking()||r.onPointerUp)&&this._initActionManager(null,l),h||(h=this._currentPickResult),this._processPointerUp(h,a,l),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===a.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=a=>{const l=to.KEYDOWN;if(r.onPreKeyboardObservable.hasObservers()){const h=new eg(l,a);if(r.onPreKeyboardObservable.notifyObservers(h,l),h.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const h=new Td(l,a);r.onKeyboardObservable.notifyObservers(h,l)}r.actionManager&&r.actionManager.processTrigger(14,Mi.CreateNewFromScene(r,a))},this._onKeyUp=a=>{const l=to.KEYUP;if(r.onPreKeyboardObservable.hasObservers()){const h=new eg(l,a);if(r.onPreKeyboardObservable.notifyObservers(h,l),h.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const h=new Td(l,a);r.onKeyboardObservable.notifyObservers(h,l)}r.actionManager&&r.actionManager.processTrigger(15,Mi.CreateNewFromScene(r,a))},this._deviceSourceManager.onDeviceConnectedObservable.add(a=>{a.deviceType===Pe.Mouse?a.onInputChangedObservable.add(l=>{l.inputIndex===Xe.LeftClick||l.inputIndex===Xe.MiddleClick||l.inputIndex===Xe.RightClick||l.inputIndex===Xe.BrowserBack||l.inputIndex===Xe.BrowserForward?t&&a.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&a.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===Xe.Move?this._onPointerMove(l):(l.inputIndex===Xe.MouseWheelX||l.inputIndex===Xe.MouseWheelY||l.inputIndex===Xe.MouseWheelZ)&&this._onPointerMove(l))}):a.deviceType===Pe.Touch?a.onInputChangedObservable.add(l=>{l.inputIndex===Xe.LeftClick&&(t&&a.getInput(l.inputIndex)===1?(this._onPointerDown(l),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):e&&a.getInput(l.inputIndex)===0&&(this._onPointerUp(l),this._totalPointersPressed===0&&(this._isMultiTouchGesture=!1))),i&&l.inputIndex===Xe.Move&&this._onPointerMove(l)}):a.deviceType===Pe.Keyboard&&a.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,s){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const r=this._meshUnderPointerId[t];let n;r&&(n=r._getActionManagerForTrigger(10),n&&n.processTrigger(10,Mi.CreateNew(r,s,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,n=e._getActionManagerForTrigger(9),n&&n.processTrigger(9,Mi.CreateNew(e,s,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}ni.DragMovementThreshold=10;ni.LongPressDelay=500;ni.DoubleClickDelay=300;ni.ExclusiveDoubleClickMode=!1;class Om{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}Om._UniqueIdCounter=1;class mt{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}mt.FALLOFF_DEFAULT=0;mt.FALLOFF_PHYSICAL=1;mt.FALLOFF_GLTF=2;mt.FALLOFF_STANDARD=3;mt.LIGHTMAP_DEFAULT=0;mt.LIGHTMAP_SPECULAR=1;mt.LIGHTMAP_SHADOWSONLY=2;mt.INTENSITYMODE_AUTOMATIC=0;mt.INTENSITYMODE_LUMINOUSPOWER=1;mt.INTENSITYMODE_LUMINOUSINTENSITY=2;mt.INTENSITYMODE_ILLUMINANCE=3;mt.INTENSITYMODE_LUMINANCE=4;mt.LIGHTTYPEID_POINTLIGHT=0;mt.LIGHTTYPEID_DIRECTIONALLIGHT=1;mt.LIGHTTYPEID_SPOTLIGHT=2;mt.LIGHTTYPEID_HEMISPHERICLIGHT=3;class j0{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}var dr;(function(o){o[o.BackwardCompatible=0]="BackwardCompatible",o[o.Intermediate=1]="Intermediate",o[o.Aggressive=2]="Aggressive"})(dr||(dr={}));class Ve extends da{static DefaultMaterialFactory(e){throw ke("StandardMaterial")}static CollisionCoordinatorFactory(){throw ke("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case dr.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case dr.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case dr.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return ni.DragMovementThreshold}static set DragMovementThreshold(e){ni.DragMovementThreshold=e}static get LongPressDelay(){return ni.LongPressDelay}static set LongPressDelay(e){ni.LongPressDelay=e}static get DoubleClickDelay(){return ni.DoubleClickDelay}static set DoubleClickDelay(e){ni.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return ni.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){ni.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){const s=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera.globalPosition,r=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return D.Vector4[0].set(s.x,s.y,s.z,r?-1:1),e&&(i?e.setFloat3(t,D.Vector4[0].x,D.Vector4[0].y,D.Vector4[0].z):e.setVector4(t,D.Vector4[0])),D.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=pm(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=Ve.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=Ve.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}constructor(e,t){super(),this._inputManager=new ni(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new He(.2,.2,.3,1),this.ambientColor=new J(0,0,0),this.environmentIntensity=1,this._performancePriority=dr.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new j,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new j,this._onDisposeObserver=null,this.onBeforeRenderObservable=new j,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new j,this.onAfterRenderCameraObservable=new j,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new j,this.onAfterAnimationsObservable=new j,this.onBeforeDrawPhaseObservable=new j,this.onAfterDrawPhaseObservable=new j,this.onReadyObservable=new j,this.onBeforeCameraRenderObservable=new j,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new j,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new j,this.onAfterActiveMeshesEvaluationObservable=new j,this.onBeforeParticlesRenderingObservable=new j,this.onAfterParticlesRenderingObservable=new j,this.onDataLoadedObservable=new j,this.onNewCameraAddedObservable=new j,this.onCameraRemovedObservable=new j,this.onNewLightAddedObservable=new j,this.onLightRemovedObservable=new j,this.onNewGeometryAddedObservable=new j,this.onGeometryRemovedObservable=new j,this.onNewTransformNodeAddedObservable=new j,this.onTransformNodeRemovedObservable=new j,this.onNewMeshAddedObservable=new j,this.onMeshRemovedObservable=new j,this.onNewSkeletonAddedObservable=new j,this.onSkeletonRemovedObservable=new j,this.onNewMaterialAddedObservable=new j,this.onNewMultiMaterialAddedObservable=new j,this.onMaterialRemovedObservable=new j,this.onMultiMaterialRemovedObservable=new j,this.onNewTextureAddedObservable=new j,this.onTextureRemovedObservable=new j,this.onBeforeRenderTargetsRenderObservable=new j,this.onAfterRenderTargetsRenderObservable=new j,this.onBeforeStepObservable=new j,this.onAfterStepObservable=new j,this.onActiveCameraChanged=new j,this.onActiveCamerasChanged=new j,this.onBeforeRenderingGroupObservable=new j,this.onAfterRenderingGroupObservable=new j,this.onMeshImportedObservable=new j,this.onAnimationFileImportedObservable=new j,this._registeredForLateAnimationBindings=new Xn(256),this._pointerPickingConfiguration=new j0,this.onPrePointerObservable=new j,this.onPointerObservable=new j,this.onPreKeyboardObservable=new j,this.onKeyboardObservable=new j,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=Ve.FOGMODE_NONE,this.fogColor=new J(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new m(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new Xn(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new ur,this._activeIndices=new ur,this._activeParticles=new ur,this._activeBones=new ur,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new li(256),this._processedMaterials=new li(256),this._renderTargets=new Xn(256),this._materialsRenderTargets=new Xn(256),this._activeParticleSystems=new li(256),this._activeSkeletons=new Xn(32),this._softwareSkinnedMeshes=new Xn(32),this._activeAnimatables=new Array,this._transformMatrix=L.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=si.Create(),this._beforeClearStage=si.Create(),this._beforeRenderTargetClearStage=si.Create(),this._gatherRenderTargetsStage=si.Create(),this._gatherActiveCameraRenderTargetsStage=si.Create(),this._isReadyForMeshStage=si.Create(),this._beforeEvaluateActiveMeshStage=si.Create(),this._evaluateSubMeshStage=si.Create(),this._preActiveMeshStage=si.Create(),this._cameraDrawRenderTargetStage=si.Create(),this._beforeCameraDrawStage=si.Create(),this._beforeRenderTargetDrawStage=si.Create(),this._beforeRenderingGroupDrawStage=si.Create(),this._beforeRenderingMeshStage=si.Create(),this._afterRenderingMeshStage=si.Create(),this._afterRenderingGroupDrawStage=si.Create(),this._afterCameraDrawStage=si.Create(),this._afterCameraPostProcessStage=si.Create(),this._afterRenderTargetDrawStage=si.Create(),this._afterRenderTargetPostProcessStage=si.Create(),this._afterRenderStage=si.Create(),this._pointerMoveStage=si.Create(),this._pointerDownStage=si.Create(),this._pointerUpStage=si.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];const i=Object.assign({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},t);e=this._engine=e||Ze.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(Ze._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new Ii(this),Dc&&(this.postProcessManager=new Dc(this)),Fi()&&this.attachControl(),this._createUbo(),st&&(this._imageProcessingConfiguration=new st),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){var t,i,s;if(this._isDisposed)return!1;let r;const n=this.getEngine(),a=n.currentRenderPassId;n.currentRenderPassId=(i=(t=this.activeCamera)===null||t===void 0?void 0:t.renderPassId)!==null&&i!==void 0?i:a;let l=!0;for(this._pendingData.length>0&&(l=!1),(s=this.prePassRenderer)===null||s===void 0||s.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&l&&(l=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),r=0;r<this.meshes.length;r++){const h=this.meshes[r];if(!h.subMeshes||h.subMeshes.length===0)continue;if(!h.isReady(!0)){l=!1;continue}const c=h.hasThinInstances||h.getClassName()==="InstancedMesh"||h.getClassName()==="InstancedLinesMesh"||n.getCaps().instancedArrays&&h.instances.length>0;for(const d of this._isReadyForMeshStage)d.action(h,c)||(l=!1);if(!e)continue;const u=h.material||this.defaultMaterial;if(u)if(u._storeEffectOnSubMeshes)for(const d of h.subMeshes){const f=d.getMaterial();f&&f.hasRenderTargetTextures&&f.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(f)===-1&&(this._processedMaterials.push(f),this._materialsRenderTargets.concatWithNoDuplicate(f.getRenderTargetTextures()))}else u.hasRenderTargetTextures&&u.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(u)===-1&&(this._processedMaterials.push(u),this._materialsRenderTargets.concatWithNoDuplicate(u.getRenderTargetTextures()))}if(e)for(r=0;r<this._materialsRenderTargets.length;++r)this._materialsRenderTargets.data[r].isReadyForRendering()||(l=!1);for(r=0;r<this.geometries.length;r++)this.geometries[r].delayLoadState===2&&(l=!1);if(this.activeCameras&&this.activeCameras.length>0)for(const h of this.activeCameras)h.isReady(!0)||(l=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(l=!1));for(const h of this.particleSystems)h.isReady()||(l=!1);if(this.layers)for(const h of this.layers)h.isReady()||(l=!1);return n.areAllEffectsReady()||(l=!1),n.currentRenderPassId=a,l}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Os.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,s){!i&&!s&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?Bs.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Bs.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new ve(this._engine,void 0,!1,e??"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return Om.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(i=>{this.addMesh(i)}))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return i!==-1&&(this.meshes[i]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(s=>{this.removeMesh(s)}),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){const i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(t!==-1){for(const i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){const i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(mt.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let i=0;i<this.materials.length;i++){const s=this.materials[i];if(t(s))return s}if(e)for(let i=0;i<this.multiMaterials.length;i++){const s=this.multiMaterials[i];if(t(s))return s}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,i=>i.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,i=>i.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,i=>i.name===e)}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let s=0;s<i.bones.length;s++)if(i.bones[s].id===e)return i.bones[s]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let s=0;s<i.bones.length;s++)if(i.bones[s].name===e)return i.bones[s]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const s=this.getLightById(e);if(s)return s;const r=this.getCameraById(e);if(r)return r;const n=this.getBoneById(e);return n||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const s=this.getLightByName(e);if(s)return s;const r=this.getCameraByName(e);if(r)return r;const n=this.getBoneByName(e);return n||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let s=0;s<i.numTargets;++s){const r=i.getTarget(s);if(r.id===e)return r}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let s=0;s<i.numTargets;++s){const r=i.getTarget(s);if(r.name===e)return r}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=Y.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new Jp),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new Jp),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,s){if(s||e.isInFrustum(this._frustumPlanes)){for(const n of this._evaluateSubMeshStage)n.action(t,e);const r=e.getMaterial();r!=null&&(r.hasRenderTargetTextures&&r.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(r)===-1&&(this._processedMaterials.push(r),this._materialsRenderTargets.concatWithNoDuplicate(r.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,r))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,s=!0,r=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,s)for(let n=0;n<this._activeMeshes.length;n++)this._activeMeshes.data[n]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)===null||e===void 0||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const s=this._activeMeshes.length;for(let r=0;r<s;r++)this._activeMeshes.data[r].computeWorldMatrix()}if(this._activeParticleSystems){const s=this._activeParticleSystems.length;for(let r=0;r<s;r++)this._activeParticleSystems.data[r].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const s of this._beforeEvaluateActiveMeshStage)s.action();const t=this.getActiveMeshCandidates(),i=t.length;for(let s=0;s<i;s++){const r=t.data[s];if(r._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,r.isBlocked||(this._totalVertices.addCount(r.getTotalVertices(),!1),!r.isReady()||!r.isEnabled()||r.scaling.hasAZeroComponent))continue;r.computeWorldMatrix(),r.actionManager&&r.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(r);let n=this.customLODSelector?this.customLODSelector(r,this.activeCamera):r.getLOD(this.activeCamera);if(r._internalAbstractMeshDataInfo._currentLOD=n,r._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,n!=null&&(n!==r&&n.billboardMode!==0&&n.computeWorldMatrix(),r._preActivate(),r.isVisible&&r.visibility>0&&r.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||r.alwaysSelectAsActiveMesh||r.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(r),this.activeCamera._activeMeshes.push(r),n!==r&&n._activate(this._renderId,!1);for(const a of this._preActiveMeshStage)a.action(r);r._activate(this._renderId,!1)&&(r.isAnInstance?r._internalAbstractMeshDataInfo._actAsRegularMesh&&(n=r):n._internalAbstractMeshDataInfo._onlyForInstances=!1,n._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(r,n)),r._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let s=0;s<this.particleSystems.length;s++){const r=this.particleSystems[s];if(!r.isStarted()||!r.emitter)continue;const n=r.emitter;(!n.position||n.isEnabled())&&(this._activeParticleSystems.push(r),r.animate(),this._renderingManager.dispatchParticles(r))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&t.skeleton!==null&&t.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(t),r=s.length;i=i||r===1;for(let n=0;n<r;n++){const a=s.data[n];this._evaluateSubMesh(a,t,e,i)}}}updateTransformMatrix(e){const t=this.activeCamera;if(t)if(t._renderingMultiview){const i=t._rigCameras[0],s=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),s.getViewMatrix(),s.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var s,r,n;if(e&&e._skipRendering)return;const a=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(a.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let h=!0;e._renderingMultiview&&e.outputRenderTarget&&(h=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=h)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let h=0;h<this._softwareSkinnedMeshes.length;h++){const c=this._softwareSkinnedMeshes.data[h];c.applySkeleton(c.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const h of this._gatherActiveCameraRenderTargetsStage)h.action(this._renderTargets);let l=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){Y.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let h=0;h<this._renderTargets.length;h++){const c=this._renderTargets.data[h];if(c._shouldRender()){this._renderId++;const u=c.activeCamera&&c.activeCamera!==this.activeCamera;c.render(u,this.dumpNextRenderTargets),l=!0}}Y.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const h of this._cameraDrawRenderTargetStage)l=h.action(this.activeCamera)||l;this._intermediateRendering=!1}this._engine.currentRenderPassId=(n=(r=(s=e.outputRenderTarget)===null||s===void 0?void 0:s.renderPassId)!==null&&r!==void 0?r:e.renderPassId)!==null&&n!==void 0?n:0,l&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const h of this._beforeCameraDrawStage)h.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),a.snapshotRendering&&a.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const h of this._afterCameraDrawStage)h.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const h=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,h)}for(const h of this._afterCameraPostProcessStage)h.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){const s=t.actionManager.actions[i];if(s.trigger===12||s.trigger===13){const r=s.getTriggerParameter(),n=r.mesh?r.mesh:r,a=n.intersectsMesh(t,r.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(n);a&&l===-1?s.trigger===12?(s._executeCurrent(Mi.CreateNew(t,void 0,n)),t._intersectionsInProgress.push(n)):s.trigger===13&&t._intersectionsInProgress.push(n):!a&&l>-1&&(s.trigger===13&&s._executeCurrent(Mi.CreateNew(t,void 0,n)),(!t.actionManager.hasSpecificTrigger(13,h=>{const c=h.mesh?h.mesh:h;return n===c})||s.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(Ve.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Ve.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let s=0;const r=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,r);e>0&&s<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(Ve.MinDeltaTime,Math.min(this._engine.getDeltaTime(),Ve.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),!((t=e==null?void 0:e.rigCameras)===null||t===void 0)&&t.length)for(let i=0;i<e.rigCameras.length;++i){const s=e.rigCameras[i].outputRenderTarget;s&&(s._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var i,s,r;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((i=this.activeCameras)===null||i===void 0)&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const l of this._beforeCameraUpdateStage)l.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++){const h=this.activeCameras[l];if(h.update(),h.cameraRigMode!==0)for(let c=0;c<h._rigCameras.length;c++)h._rigCameras[c].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let l=0;l<this.activeCamera._rigCameras.length;l++)this.activeCamera._rigCameras[l].update()}this.onBeforeRenderObservable.notifyObservers(this);const n=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const a=!((s=this.activeCameras)===null||s===void 0)&&s.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){Y.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let l=0;l<this.customRenderTargets.length;l++){const h=this.customRenderTargets[l];if(h._shouldRender()){if(this._renderId++,this.activeCamera=h.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");n.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),h.render(a!==this.activeCamera,this.dumpNextRenderTargets)}}Y.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(r=a==null?void 0:a.renderPassId)!==null&&r!==void 0?r:0,this.activeCamera=a,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const l of this._beforeClearStage)l.action();this._clearFrameBuffer(this.activeCamera);for(const l of this._gatherRenderTargetsStage)l.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let l=0;l<this.activeCameras.length;l++)this._processSubCameras(this.activeCameras[l],l>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(const l of this._afterRenderStage)l.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let l=0;l<this._toBeDisposed.length;l++){const h=this._toBeDisposed[l];h&&h.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this.stopAllAnimations&&(this._activeAnimatables.forEach(r=>{r.onAnimationEndObservable.clear(),r.onAnimationEnd=null}),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const e=this._activeRequests.slice();for(const r of e)r.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(r){q.Error("An error occurred while calling onDisposeObservable!",r)}if(this.detachControl(),this._engine.getInputElement())for(let r=0;r<this.cameras.length;r++)this.cameras[r].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,r=>r.dispose(!0)),this._disposeList(this.transformNodes,r=>r.dispose(!0));const i=this.cameras;this._disposeList(i),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let s=this._engine.scenes.indexOf(this);s>-1&&this._engine.scenes.splice(s,1),Ze._LastCreatedScene===this&&(this._engine.scenes.length>0?Ze._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:Ze._LastCreatedScene=null),s=this._engine._virtualScenes.indexOf(this),s>-1&&this._engine._virtualScenes.splice(s,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t??(s=>s.dispose());for(const s of i)t(s);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(s=>{if(s.computeWorldMatrix(!0),!s.subMeshes||s.subMeshes.length===0||s.infiniteDistance)return;const r=s.getBoundingInfo(),n=r.boundingBox.minimumWorld,a=r.boundingBox.maximumWorld;m.CheckExtends(n,t,i),m.CheckExtends(a,t,i)}),{min:t,max:i}}createPickingRay(e,t,i,s,r=!1){throw ke("Ray")}createPickingRayToRef(e,t,i,s,r,n=!1,a=!1){throw ke("Ray")}createPickingRayInCameraSpace(e,t,i){throw ke("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,s){throw ke("Ray")}get _pickingAvailable(){return!1}pick(e,t,i,s,r,n){const a=ke("Ray",!0);return a&&q.Warn(a),new pr}pickWithBoundingInfo(e,t,i,s,r){const n=ke("Ray",!0);return n&&q.Warn(n),new pr}pickWithRay(e,t,i,s){throw ke("Ray")}multiPick(e,t,i,s,r){throw ke("Ray")}multiPickWithRay(e,t,i){throw ke("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;const s=[];for(const r in e){const n=e[r];ot&&ot.MatchesQuery(n,t)&&(!i||i(n))&&s.push(n)}return s}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,s,r,n,a){const l=An(e,t,i,s?this.offlineProvider:void 0,r,n,a);return this._activeRequests.push(l),l.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),l}_loadFileAsync(e,t,i,s,r){return new Promise((n,a)=>{this._loadFile(e,l=>{n(l)},t,i,s,(l,h)=>{a(h)},r)})}_requestFile(e,t,i,s,r,n,a){const l=yf(e,t,i,s?this.offlineProvider:void 0,r,n,a);return this._activeRequests.push(l),l.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),l}_requestFileAsync(e,t,i,s,r){return new Promise((n,a)=>{this._requestFile(e,l=>{n(l)},t,i,s,l=>{a(l)},r)})}_readFile(e,t,i,s,r){const n=ph(e,t,i,s,r);return this._activeRequests.push(n),n.onCompleteObservable.add(a=>{this._activeRequests.splice(this._activeRequests.indexOf(a),1)}),n}_readFileAsync(e,t,i){return new Promise((s,r)=>{this._readFile(e,n=>{s(n)},t,i,n=>{r(n)})})}getPerfCollector(){throw ke("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}}Ve.FOGMODE_NONE=0;Ve.FOGMODE_EXP=1;Ve.FOGMODE_EXP2=2;Ve.FOGMODE_LINEAR=3;Ve.MinDeltaTime=1;Ve.MaxDeltaTime=1e3;const q0="helperFunctions",Z0=`const float PI=3.1415926535897932384626433832795;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
mat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{return value*value;}
vec3 square(vec3 value)
{return value*value;}
float pow5(float value) {float sq=value*value;return sq*sq*value;}
float getLuminance(vec3 color)
{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}
float getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}
float dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}
const float rgbdMaxRange=255.0;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(clamp(rgb,0.,1.),D); }
vec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
`;X.IncludesShadersStore[q0]=Z0;const Q0="rgbdDecodePixelShader",J0=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}`;X.ShadersStore[Q0]=J0;class cg{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),s=i.getCaps(),r=t.isReady;let n=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(n=!0,t.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(n=!0,t.type=1),n&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const a=()=>{if(n){const l=new ht("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;const h=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(()=>{l.onApply=c=>{c._bindTexture("textureSampler",t),c.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],h,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),l&&l.dispose(),h._swapAndDie(t),t.isReady=!0})}};r?a():e.onLoadObservable.addOnce(a)}static EncodeTextureToRGBD(e,t,i=0){return P0("rgbdEncode",e,t,i,1,5)}}bt.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(bt.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=bh.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(o=>{this._texture._sphericalPolynomial=o,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(o){this._texture&&(this._texture._sphericalPolynomial=o)},enumerable:!0,configurable:!0});const eb="rgbdEncodePixelShader",tb=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}`;X.ShadersStore[eb]=tb;const Nm="image/png",ug=2,dg=[134,22,135,150,246,214,150,54];function ib(o){const e=new DataView(o.buffer,o.byteOffset,o.byteLength);let t=0;for(let n=0;n<dg.length;n++)if(e.getUint8(t++)!==dg[n])return q.Error("Not a babylon environment map"),null;let i="",s=0;for(;s=e.getUint8(t++);)i+=String.fromCharCode(s);let r=JSON.parse(i);return r=$c(r),r.specular&&(r.specular.specularDataPosition=t,r.specular.lodGenerationScale=r.specular.lodGenerationScale||.8),r}function $c(o){if(o.version>ug)throw new Error(`Unsupported babylon environment map version "${o.version}". Latest supported version is "${ug}".`);return o.version===2||(o=Object.assign(Object.assign({},o),{version:2,imageType:Nm})),o}function sb(o,e){e=$c(e);const t=e.specular;let i=Te.Log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const s=new Array(i);for(let r=0;r<i;r++){s[r]=new Array(6);for(let n=0;n<6;n++){const a=t.mipmaps[r*6+n];s[r][n]=new Uint8Array(o.buffer,o.byteOffset+t.specularDataPosition+a.position,a.length)}}return s}function rb(o,e,t){t=$c(t);const i=t.specular;if(!i)return Promise.resolve();o._lodGenerationScale=i.lodGenerationScale;const s=sb(e,t);return vd(o,s,t.imageType)}function fg(o,e,t,i,s,r,n,a,l,h,c){return new Promise((u,d)=>{if(t){const f=e.createTexture(null,!0,!0,null,1,null,p=>{d(p)},o);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=p=>{p._bindTexture("textureSampler",f),p.setFloat2("scale",1,e._features.needsInvertingBitmap&&o instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],h,!0,r,n),e.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(s),u())})}else{if(e._uploadImageToTexture(c,o,r,n),a){const f=l[n];f&&e._uploadImageToTexture(f._texture,o,r,0)}u()}})}function vd(o,e,t=Nm){if(!Y.IsExponentOfTwo(o.width))throw new Error("Texture size must be a power of two");const i=Te.ILog2(o.width)+1,s=o.getEngine();let r=!1,n=!1,a=null,l=null,h=null;const c=s.getCaps();if(o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,s.updateTextureSamplingMode(3,o),c.textureLOD?s._features.supportRenderAndCopyToLodForFloatTextures?c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering?(r=!0,o.type=2):c.textureFloatRender&&c.textureFloatLinearFiltering&&(r=!0,o.type=1):r=!1:(r=!1,n=!0,h={}),r)a=new ht("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,o.type,void 0,null,!1),o._isRGBD=!1,o.invertY=!1,l=s.createRenderTargetCubeTexture(o.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:o.type,format:5});else if(o._isRGBD=!0,o.invertY=!0,n){const f=o._lodGenerationScale,p=o._lodGenerationOffset;for(let _=0;_<3;_++){const E=1-_/2,R=p,x=(i-1)*f+p,S=R+(x-R)*E,b=Math.round(Math.min(Math.max(S,0),x)),y=new wi(s,At.Temp);y.isCube=!0,y.invertY=!0,y.generateMipMaps=!1,s.updateTextureSamplingMode(2,y);const I=new bt(null);switch(I._isCube=!0,I._texture=y,h[b]=I,_){case 0:o._lodTextureLow=I;break;case 1:o._lodTextureMid=I;break;case 2:o._lodTextureHigh=I;break}}}const u=[];for(let d=0;d<e.length;d++)for(let f=0;f<6;f++){const p=e[d][f],_=new Blob([p],{type:t}),g=URL.createObjectURL(_);let E;if(s._features.forceBitmapOverHTMLImageElement)E=s.createImageBitmap(_,{premultiplyAlpha:"none"}).then(R=>fg(R,s,r,a,g,f,d,n,h,l,o));else{const R=new Image;R.src=g,E=new Promise((x,S)=>{R.onload=()=>{fg(R,s,r,a,g,f,d,n,h,l,o).then(()=>x()).catch(b=>{S(b)})},R.onerror=b=>{S(b)}})}u.push(E)}if(e.length<i){let d;const f=Math.pow(2,i-1-e.length),p=f*f*4;switch(o.type){case 0:{d=new Uint8Array(p);break}case 2:{d=new Uint16Array(p);break}case 1:{d=new Float32Array(p);break}}for(let _=e.length;_<i;_++)for(let g=0;g<6;g++)s._uploadArrayBufferViewToTexture(o,d,g,_)}return Promise.all(u).then(()=>{l&&(s._releaseTexture(o),l._swapAndDie(o)),a&&a.dispose(),n&&(o._lodTextureHigh&&o._lodTextureHigh._texture&&(o._lodTextureHigh._texture.isReady=!0),o._lodTextureMid&&o._lodTextureMid._texture&&(o._lodTextureMid._texture.isReady=!0),o._lodTextureLow&&o._lodTextureLow._texture&&(o._lodTextureLow._texture.isReady=!0))})}function nb(o,e){e=$c(e);const t=e.irradiance;if(!t)return;const i=new Tn;m.FromArrayToRef(t.x,0,i.x),m.FromArrayToRef(t.y,0,i.y),m.FromArrayToRef(t.z,0,i.z),m.FromArrayToRef(t.xx,0,i.xx),m.FromArrayToRef(t.yy,0,i.yy),m.FromArrayToRef(t.zz,0,i.zz),m.FromArrayToRef(t.yz,0,i.yz),m.FromArrayToRef(t.zx,0,i.zx),m.FromArrayToRef(t.xy,0,i.xy),o._sphericalPolynomial=i}function ab(o,e,t,i,s){const r=o.getEngine().createRawCubeTexture(null,o.width,o.format,o.type,o.generateMipMaps,o.invertY,o.samplingMode,o._compression),n=vd(r,e).then(()=>o);return o.onRebuildCallback=a=>({proxy:n,isReady:!0,isAsync:!0}),o._source=At.CubeRawRGBD,o._bufferViewArrayArray=e,o._lodGenerationScale=i,o._lodGenerationOffset=s,o._sphericalPolynomial=t,vd(o,e).then(()=>(o.isReady=!0,o))}class ob{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,s,r){if(Array.isArray(e))return;const n=ib(e);if(n){t.width=n.width,t.height=n.width;try{nb(t,n),rb(t,e,n).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()},a=>{r==null||r("Can not upload environment levels",a)})}catch(a){r==null||r("Can not upload environment file",a)}}else r&&r("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}H._TextureLoaders.push(new ob);class Is{constructor(e,t){if(this.data=e,this.isInvalid=!1,!Is.IsValid(e)){this.isInvalid=!0,q.Error("texture missing KTX identifier");return}const i=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),n=s.getUint32(0,!0)===67305985;if(this.glType=s.getUint32(1*i,n),this.glTypeSize=s.getUint32(2*i,n),this.glFormat=s.getUint32(3*i,n),this.glInternalFormat=s.getUint32(4*i,n),this.glBaseInternalFormat=s.getUint32(5*i,n),this.pixelWidth=s.getUint32(6*i,n),this.pixelHeight=s.getUint32(7*i,n),this.pixelDepth=s.getUint32(8*i,n),this.numberOfArrayElements=s.getUint32(9*i,n),this.numberOfFaces=s.getUint32(10*i,n),this.numberOfMipmapLevels=s.getUint32(11*i,n),this.bytesOfKeyValueData=s.getUint32(12*i,n),this.glType!==0){q.Error("only compressed formats currently supported"),this.isInvalid=!0;return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){q.Error("only 2D textures currently supported"),this.isInvalid=!0;return}if(this.numberOfArrayElements!==0){q.Error("texture arrays not currently supported"),this.isInvalid=!0;return}if(this.numberOfFaces!==t){q.Error("number of faces expected"+t+", but found "+this.numberOfFaces),this.isInvalid=!0;return}this.loadType=Is.COMPRESSED_2D}uploadLevels(e,t){switch(this.loadType){case Is.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break}}_upload2DCompressedLevels(e,t){let i=Is.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,r=this.pixelHeight;const n=t?this.numberOfMipmapLevels:1;for(let a=0;a<n;a++){const l=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let h=0;h<this.numberOfFaces;h++){const c=new Uint8Array(this.data.buffer,this.data.byteOffset+i,l);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,s,r,c,h,a),i+=l,i+=3-(l+3)%4}s=Math.max(1,s*.5),r=Math.max(1,r*.5)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===49&&t[6]===49&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}Is.HEADER_LEN=12+13*4;Is.COMPRESSED_2D=0;Is.COMPRESSED_3D=1;Is.TEX_2D=2;Is.TEX_3D=3;class lb{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const s=this._pendingActions.shift();s?this._execute(e,s):e.idle=!0})})}}class xh extends lb{constructor(e,t,i=xh.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,s)=>{t(i,()=>{s(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(n=>{n.terminate()});const r=this._workerInfos.indexOf(e);r!==-1&&this._workerInfos.splice(r,1)},this._options.idleTimeElapsedBeforeRelease))})})}}xh.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};var _g;(function(o){o[o.ETC1S=0]="ETC1S",o[o.UASTC4x4=1]="UASTC4x4"})(_g||(_g={}));var ah;(function(o){o[o.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",o[o.BC7_RGBA=1]="BC7_RGBA",o[o.BC3_RGBA=2]="BC3_RGBA",o[o.BC1_RGB=3]="BC1_RGB",o[o.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",o[o.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",o[o.ETC2_RGBA=6]="ETC2_RGBA",o[o.ETC1_RGB=7]="ETC1_RGB",o[o.RGBA32=8]="RGBA32",o[o.R8=9]="R8",o[o.RG8=10]="RG8"})(ah||(ah={}));var Ad;(function(o){o[o.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",o[o.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",o[o.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",o[o.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",o[o.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",o[o.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",o[o.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",o[o.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",o[o.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",o[o.RGBA8Format=32856]="RGBA8Format",o[o.R8Format=33321]="R8Format",o[o.RG8Format=33323]="RG8Format"})(Ad||(Ad={}));function Rd(o){o.wasmUASTCToASTC&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=o.wasmUASTCToASTC),o.wasmUASTCToBC7&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=o.wasmUASTCToBC7),o.wasmUASTCToRGBA_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=o.wasmUASTCToRGBA_UNORM),o.wasmUASTCToRGBA_SRGB&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=o.wasmUASTCToRGBA_SRGB),o.wasmUASTCToR8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=o.wasmUASTCToR8_UNORM),o.wasmUASTCToRG8_UNORM&&(KTX2DECODER.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=o.wasmUASTCToRG8_UNORM),o.jsMSCTranscoder&&(KTX2DECODER.MSCTranscoder.JSModuleURL=o.jsMSCTranscoder),o.wasmMSCTranscoder&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=o.wasmMSCTranscoder),o.wasmZSTDDecoder&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=o.wasmZSTDDecoder)}class hb{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[ah.BC1_RGB,ah.BC3_RGBA],yes:{transcodeFormat:ah.RGBA32,engineFormat:Ad.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}}class Ei{static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){if(Ei._WorkerPoolPromise||Ei._DecoderModulePromise)return;const t={jsDecoderModule:Y.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:Y.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:Y.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:Y.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:Y.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:Y.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:Y.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:Y.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:Y.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:Y.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&typeof Worker=="function"&&typeof URL<"u"?Ei._WorkerPoolPromise=new Promise(i=>{const s=`${Rd}(${cb})()`,r=URL.createObjectURL(new Blob([s],{type:"application/javascript"}));i(new xh(e,()=>new Promise((n,a)=>{const l=new Worker(r),h=u=>{l.removeEventListener("error",h),l.removeEventListener("message",c),a(u)},c=u=>{u.data.action==="init"&&(l.removeEventListener("error",h),l.removeEventListener("message",c),n(l))};l.addEventListener("error",h),l.addEventListener("message",c),l.postMessage({action:"init",urls:t})})))}):typeof KTX2DECODER>"u"?Ei._DecoderModulePromise=Y.LoadBabylonScriptAsync(t.jsDecoderModule).then(()=>(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Rd(t),new KTX2DECODER.KTX2Decoder)):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Ei._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder))}constructor(e,t=Ei.DefaultNumWorkers){this._engine=e,Ei._Initialize(t)}uploadAsync(e,t,i){const s=this._engine.getCaps(),r={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(Ei._WorkerPoolPromise)return Ei._WorkerPoolPromise.then(n=>new Promise((a,l)=>{n.push((h,c)=>{const u=p=>{h.removeEventListener("error",u),h.removeEventListener("message",d),l(p),c()},d=p=>{if(p.data.action==="decoded"){if(h.removeEventListener("error",u),h.removeEventListener("message",d),!p.data.success)l({message:p.data.msg});else try{this._createTexture(p.data.decodedData,t,i),a()}catch(_){l({message:_})}c()}};h.addEventListener("error",u),h.addEventListener("message",d),h.postMessage({action:"setDefaultDecoderOptions",options:Ei.DefaultDecoderOptions._getKTX2DecoderOptions()});const f=new Uint8Array(e.byteLength);f.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),h.postMessage({action:"decode",data:f,caps:r,options:i},[f.buffer])})}));if(Ei._DecoderModulePromise)return Ei._DecoderModulePromise.then(n=>(Ei.DefaultDecoderOptions.isDirty&&(KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=Ei.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((a,l)=>{n.decode(e,s).then(h=>{this._createTexture(h,t),a()}).catch(h=>{l({message:h})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let r=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,r=!1;break}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let n=0;n<e.mipmaps.length;++n){const a=e.mipmaps[n];if(!a||!a.data)throw new Error("KTX2 container - could not transcode one of the image");r?(t.width=a.width,t.height=a.height,this._engine._uploadDataToTextureDirectly(t,a.data,0,n,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,a.width,a.height,a.data,0,n)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}Ei.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null};Ei.DefaultNumWorkers=Ei.GetDefaultNumWorkers();Ei.DefaultDecoderOptions=new hb;function cb(){let o;onmessage=e=>{if(e.data)switch(e.data.action){case"init":{const t=e.data.urls;importScripts(t.jsDecoderModule),Rd(t),o=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":{KTX2DECODER.KTX2Decoder.DefaultDecoderOptions=e.data.options;break}case"decode":o.decode(e.data.data,e.data.caps,e.data.options).then(t=>{const i=[];for(let s=0;s<t.mipmaps.length;++s){const r=t.mipmaps[s];r&&r.data&&i.push(r.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:t},i)}).catch(t=>{postMessage({action:"decoded",success:!1,msg:t})});break}}}function ub(o){switch(o){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}class db{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||t==="image/ktx"||t==="image/ktx2"}loadCubeData(e,t,i,s){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const r=t.getEngine(),n=new Is(e,6),a=n.numberOfMipmapLevels>1&&t.generateMipMaps;r._unpackFlipY(!0),n.uploadLevels(t,t.generateMipMaps),t.width=n.pixelWidth,t.height=n.pixelHeight,r._setCubeMapTextureParams(t,a,n.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}loadData(e,t,i,s){if(Is.IsValid(e)){t._invertVScale=!t.invertY;const r=new Is(e,1),n=ub(r.glInternalFormat);n?(t.format=n,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=r.glInternalFormat,i(r.pixelWidth,r.pixelHeight,t.generateMipMaps,!0,()=>{r.uploadLevels(t,t.generateMipMaps)},r.isInvalid)}else Ei.IsValid(e)?new Ei(t.getEngine()).uploadAsync(e,t,s).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},n=>{q.Warn(`Failed to load KTX2 texture data: ${n.message}`),i(0,0,!1,!1,()=>{},!0)}):(q.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}}H._TextureLoaders.unshift(new db);const fb=1,_b=2,pb=3,gb=9,mb=10,Eb=11,Tb=48,vb=4,Ab=0,Rb=1,bb=2,Sb=3;function xf(o){let e=0;return{id_length:o[e++],colormap_type:o[e++],image_type:o[e++],colormap_index:o[e++]|o[e++]<<8,colormap_length:o[e++]|o[e++]<<8,colormap_size:o[e++],origin:[o[e++]|o[e++]<<8,o[e++]|o[e++]<<8],width:o[e++]|o[e++]<<8,height:o[e++]|o[e++]<<8,pixel_size:o[e++],flags:o[e++]}}function Lm(o,e){if(e.length<19){q.Error("Unable to load TGA file - Not enough data to contain header");return}let t=18;const i=xf(e);if(i.id_length+t>e.length){q.Error("Unable to load TGA file - Not enough data");return}t+=i.id_length;let s=!1,r=!1,n=!1;switch(i.image_type){case gb:s=!0;case fb:r=!0;break;case mb:s=!0;case _b:break;case Eb:s=!0;case pb:n=!0;break}let a;const l=i.pixel_size>>3,h=i.width*i.height*l;let c;if(r&&(c=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),s){a=new Uint8Array(h);let S,b,y,I=0;const O=new Uint8Array(l);for(;t<h&&I<h;)if(S=e[t++],b=(S&127)+1,S&128){for(y=0;y<l;++y)O[y]=e[t++];for(y=0;y<b;++y)a.set(O,I+y*l);I+=l*b}else{for(b*=l,y=0;y<b;++y)a[I+y]=e[t++];I+=b}}else a=e.subarray(t,t+=r?i.width*i.height:h);let u,d,f,p,_,g;switch((i.flags&Tb)>>vb){default:case bb:u=0,f=1,g=i.width,d=0,p=1,_=i.height;break;case Ab:u=0,f=1,g=i.width,d=i.height-1,p=-1,_=-1;break;case Sb:u=i.width-1,f=-1,g=-1,d=0,p=1,_=i.height;break;case Rb:u=i.width-1,f=-1,g=-1,d=i.height-1,p=-1,_=-1;break}const E="_getImageData"+(n?"Grey":"")+i.pixel_size+"bits",R=Db[E](i,c,a,d,p,_,u,f,g);o.getEngine()._uploadDataToTextureDirectly(o,R)}function yb(o,e,t,i,s,r,n,a,l){const h=t,c=e,u=o.width,d=o.height;let f,p=0,_,g;const E=new Uint8Array(u*d*4);for(g=i;g!==r;g+=s)for(_=n;_!==l;_+=a,p++)f=h[p],E[(_+u*g)*4+3]=255,E[(_+u*g)*4+2]=c[f*3+0],E[(_+u*g)*4+1]=c[f*3+1],E[(_+u*g)*4+0]=c[f*3+2];return E}function Cb(o,e,t,i,s,r,n,a,l){const h=t,c=o.width,u=o.height;let d,f=0,p,_;const g=new Uint8Array(c*u*4);for(_=i;_!==r;_+=s)for(p=n;p!==l;p+=a,f+=2){d=h[f+0]+(h[f+1]<<8);const E=((d&31744)>>10)*255/31|0,R=((d&992)>>5)*255/31|0,x=(d&31)*255/31|0;g[(p+c*_)*4+0]=E,g[(p+c*_)*4+1]=R,g[(p+c*_)*4+2]=x,g[(p+c*_)*4+3]=d&32768?0:255}return g}function xb(o,e,t,i,s,r,n,a,l){const h=t,c=o.width,u=o.height;let d=0,f,p;const _=new Uint8Array(c*u*4);for(p=i;p!==r;p+=s)for(f=n;f!==l;f+=a,d+=3)_[(f+c*p)*4+3]=255,_[(f+c*p)*4+2]=h[d+0],_[(f+c*p)*4+1]=h[d+1],_[(f+c*p)*4+0]=h[d+2];return _}function Mb(o,e,t,i,s,r,n,a,l){const h=t,c=o.width,u=o.height;let d=0,f,p;const _=new Uint8Array(c*u*4);for(p=i;p!==r;p+=s)for(f=n;f!==l;f+=a,d+=4)_[(f+c*p)*4+2]=h[d+0],_[(f+c*p)*4+1]=h[d+1],_[(f+c*p)*4+0]=h[d+2],_[(f+c*p)*4+3]=h[d+3];return _}function Ib(o,e,t,i,s,r,n,a,l){const h=t,c=o.width,u=o.height;let d,f=0,p,_;const g=new Uint8Array(c*u*4);for(_=i;_!==r;_+=s)for(p=n;p!==l;p+=a,f++)d=h[f],g[(p+c*_)*4+0]=d,g[(p+c*_)*4+1]=d,g[(p+c*_)*4+2]=d,g[(p+c*_)*4+3]=255;return g}function Pb(o,e,t,i,s,r,n,a,l){const h=t,c=o.width,u=o.height;let d=0,f,p;const _=new Uint8Array(c*u*4);for(p=i;p!==r;p+=s)for(f=n;f!==l;f+=a,d+=2)_[(f+c*p)*4+0]=h[d+0],_[(f+c*p)*4+1]=h[d+0],_[(f+c*p)*4+2]=h[d+0],_[(f+c*p)*4+3]=h[d+1];return _}const Db={GetTGAHeader:xf,UploadContent:Lm,_getImageData8bits:yb,_getImageData16bits:Cb,_getImageData24bits:xb,_getImageData32bits:Mb,_getImageDataGrey8bits:Ib,_getImageDataGrey16bits:Pb};class Ob{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=xf(s);i(r.width,r.height,t.generateMipMaps,!1,()=>{Lm(t,s)})}}H._TextureLoaders.push(new Ob);class fa{static ConvertPanoramaToCubemap(e,t,i,s,r=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";const n=this.CreateCubemapTexture(s,this.FACE_FRONT,e,t,i,r),a=this.CreateCubemapTexture(s,this.FACE_BACK,e,t,i,r),l=this.CreateCubemapTexture(s,this.FACE_LEFT,e,t,i,r),h=this.CreateCubemapTexture(s,this.FACE_RIGHT,e,t,i,r),c=this.CreateCubemapTexture(s,this.FACE_UP,e,t,i,r),u=this.CreateCubemapTexture(s,this.FACE_DOWN,e,t,i,r);return{front:n,back:a,left:l,right:h,up:c,down:u,size:s,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,s,r,n=!1){const a=new ArrayBuffer(e*e*4*3),l=new Float32Array(a),h=n?Math.max(1,Math.round(s/4/e)):1,c=1/h,u=c*c,d=t[1].subtract(t[0]).scale(c/e),f=t[3].subtract(t[2]).scale(c/e),p=1/e;let _=0;for(let g=0;g<e;g++)for(let E=0;E<h;E++){let R=t[0],x=t[2];for(let S=0;S<e;S++)for(let b=0;b<h;b++){const y=x.subtract(R).scale(_).add(R);y.normalize();const I=this.CalcProjectionSpherical(y,i,s,r);l[g*e*3+S*3+0]+=I.r*u,l[g*e*3+S*3+1]+=I.g*u,l[g*e*3+S*3+2]+=I.b*u,R=R.add(d),x=x.add(f)}_+=p*c}return l}static CalcProjectionSpherical(e,t,i,s){let r=Math.atan2(e.z,e.x);const n=Math.acos(e.y);for(;r<-Math.PI;)r+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;let a=r/Math.PI;const l=n/Math.PI;a=a*.5+.5;let h=Math.round(a*i);h<0?h=0:h>=i&&(h=i-1);let c=Math.round(l*s);c<0?c=0:c>=s&&(c=s-1);const u=s-c-1,d=t[u*i*3+h*3+0],f=t[u*i*3+h*3+1],p=t[u*i*3+h*3+2];return{r:d,g:f,b:p}}}fa.FACE_LEFT=[new m(-1,-1,-1),new m(1,-1,-1),new m(-1,1,-1),new m(1,1,-1)];fa.FACE_RIGHT=[new m(1,-1,1),new m(-1,-1,1),new m(1,1,1),new m(-1,1,1)];fa.FACE_FRONT=[new m(1,-1,-1),new m(1,-1,1),new m(1,1,-1),new m(1,1,1)];fa.FACE_BACK=[new m(-1,-1,1),new m(-1,-1,-1),new m(-1,1,1),new m(-1,1,-1)];fa.FACE_DOWN=[new m(1,1,-1),new m(1,1,1),new m(-1,1,-1),new m(-1,1,1)];fa.FACE_UP=[new m(-1,-1,-1),new m(-1,-1,1),new m(1,-1,-1),new m(1,-1,1)];class pg{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,s,r,n){r>0?(r=this._Ldexp(1,r-136),e[n+0]=t*r,e[n+1]=i*r,e[n+2]=s*r):(e[n+0]=0,e[n+1]=0,e[n+2]=0)}static _ReadStringLine(e,t){let i="",s="";for(let r=t;r<e.length-t&&(s=String.fromCharCode(e[r]),s!=`
`);r++)i+=s;return i}static RGBE_ReadHeader(e){let t=0,i=0,s=this._ReadStringLine(e,0);if(s[0]!="#"||s[1]!="?")throw"Bad HDR Format.";let r=!1,n=!1,a=0;do a+=s.length+1,s=this._ReadStringLine(e,a),s=="FORMAT=32-bit_rle_rgbe"?n=!0:s.length==0&&(r=!0);while(!r);if(!n)throw"HDR Bad header format, unsupported FORMAT";a+=s.length+1,s=this._ReadStringLine(e,a);const h=/^-Y (.*) \+X (.*)$/g.exec(s);if(!h||h.length<3)throw"HDR Bad header format, no size";if(i=parseInt(h[2]),t=parseInt(h[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return a+=s.length+1,{height:t,width:i,dataPosition:a}}static GetCubeMapTextureData(e,t,i=!1){const s=new Uint8Array(e),r=this.RGBE_ReadHeader(s),n=this.RGBE_ReadPixels(s,r);return fa.ConvertPanoramaToCubemap(n,r.width,r.height,t,i)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height;const s=t.width;let r,n,a,l,h,c=t.dataPosition,u=0,d=0,f=0;const p=new ArrayBuffer(s*4),_=new Uint8Array(p),g=new ArrayBuffer(t.width*t.height*4*3),E=new Float32Array(g);for(;i>0;){if(r=e[c++],n=e[c++],a=e[c++],l=e[c++],r!=2||n!=2||a&128||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((a<<8|l)!=s)throw"HDR Bad header format, wrong scan line width";for(u=0,f=0;f<4;f++)for(d=(f+1)*s;u<d;)if(r=e[c++],n=e[c++],r>128){if(h=r-128,h==0||h>d-u)throw"HDR Bad Format, bad scanline data (run)";for(;h-- >0;)_[u++]=n}else{if(h=r,h==0||h>d-u)throw"HDR Bad Format, bad scanline data (non-run)";if(_[u++]=n,--h>0)for(let R=0;R<h;R++)_[u++]=e[c++]}for(f=0;f<s;f++)r=_[f],n=_[f+s],a=_[f+2*s],l=_[f+3*s],this._Rgbe2float(E,r,n,a,l,(t.height-i)*s*3+f*3);i--}return E}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height;const s=t.width;let r,n,a,l,h,c=t.dataPosition;const u=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(u);for(;i>0;){for(h=0;h<t.width;h++)r=e[c++],n=e[c++],a=e[c++],l=e[c++],this._Rgbe2float(d,r,n,a,l,(t.height-i)*s*3+h*3);i--}return d}}class Nb{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=pg.RGBE_ReadHeader(s),n=pg.RGBE_ReadPixels(s,r),a=r.width*r.height,l=new Float32Array(a*4);for(let h=0;h<a;h+=1)l[h*4]=n[h*3],l[h*4+1]=n[h*3+1],l[h*4+2]=n[h*3+2],l[h*4+3]=1;i(r.width,r.height,t.generateMipMaps,!1,()=>{const h=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,h._uploadDataToTextureDirectly(t,l)})}}H._TextureLoaders.push(new Nb);var Lr;(function(o){o[o.cTFETC1=0]="cTFETC1",o[o.cTFETC2=1]="cTFETC2",o[o.cTFBC1=2]="cTFBC1",o[o.cTFBC3=3]="cTFBC3",o[o.cTFBC4=4]="cTFBC4",o[o.cTFBC5=5]="cTFBC5",o[o.cTFBC7=6]="cTFBC7",o[o.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",o[o.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",o[o.cTFASTC_4x4=10]="cTFASTC_4x4",o[o.cTFATC_RGB=11]="cTFATC_RGB",o[o.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",o[o.cTFRGBA32=13]="cTFRGBA32",o[o.cTFRGB565=14]="cTFRGB565",o[o.cTFBGR565=15]="cTFBGR565",o[o.cTFRGBA4444=16]="cTFRGBA4444",o[o.cTFFXT1_RGB=17]="cTFFXT1_RGB",o[o.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",o[o.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",o[o.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",o[o.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(Lr||(Lr={}));const Rn={JSModuleURL:`${Y._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${Y._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},Lb=(o,e)=>{let t;switch(o){case Lr.cTFETC1:t=36196;break;case Lr.cTFBC1:t=33776;break;case Lr.cTFBC4:t=33779;break;case Lr.cTFASTC_4x4:t=37808;break;case Lr.cTFETC2:t=37496;break;case Lr.cTFBC7:t=36492;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t};let ed=null,hr=null,Fb=0;const wb=!1,Bb=()=>(ed||(ed=new Promise((o,e)=>{hr?o(hr):Y.LoadFileAsync(Y.GetBabylonScriptURL(Rn.WasmModuleURL)).then(t=>{if(typeof URL!="function")return e("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${Ub})()`],{type:"application/javascript"}));hr=new Worker(i);const s=r=>{r.data.action==="init"?(hr.removeEventListener("message",s),o(hr)):r.data.action==="error"&&e(r.data.error||"error initializing worker")};hr.addEventListener("message",s),hr.postMessage({action:"init",url:Y.GetBabylonScriptURL(Rn.JSModuleURL),wasmBinary:t})}).catch(e)})),ed),bd=(o,e)=>{const t=o instanceof ArrayBuffer?new Uint8Array(o):o;return new Promise((i,s)=>{Bb().then(()=>{const r=Fb++,n=l=>{l.data.action==="transcode"&&l.data.id===r&&(hr.removeEventListener("message",n),l.data.success?i(l.data):s("Transcode is not supported on this device"))};hr.addEventListener("message",n);const a=new Uint8Array(t.byteLength);a.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),hr.postMessage({action:"transcode",id:r,imageData:a,config:e,ignoreSupportedFormats:wb},[a.buffer])},r=>{s(r)})})},bc=(o,e)=>{var t,i;let s=(t=e._gl)===null||t===void 0?void 0:t.TEXTURE_2D;o.isCube&&(s=(i=e._gl)===null||i===void 0?void 0:i.TEXTURE_CUBE_MAP),e._bindTextureDirectly(s,o,!0)},Sd=(o,e)=>{const t=o.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){const s=e.fileInfo.images[i].levels[0];if(o._invertVScale=o.invertY,e.format===-1||e.format===Lr.cTFRGB565)if(o.type=10,o.format=4,t._features.basisNeedsPOT&&(Te.Log2(s.width)%1!==0||Te.Log2(s.height)%1!==0)){const r=new wi(t,At.Temp);o._invertVScale=o.invertY,r.type=10,r.format=4,r.width=s.width+3&-4,r.height=s.height+3&-4,bc(r,t),t._uploadDataToTextureDirectly(r,new Uint16Array(s.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(r,o,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(r),bc(o,t)})}else o._invertVScale=!o.invertY,o.width=s.width+3&-4,o.height=s.height+3&-4,o.samplingMode=2,bc(o,t),t._uploadDataToTextureDirectly(o,new Uint16Array(s.transcodedPixels.buffer),i,0,4,!0);else{o.width=s.width,o.height=s.height,o.generateMipMaps=e.fileInfo.images[i].levels.length>1;const r=Mf.GetInternalFormatFromBasisFormat(e.format,t);o.format=r,bc(o,t),e.fileInfo.images[i].levels.forEach((n,a)=>{t._uploadCompressedDataToTextureDirectly(o,r,n.width,n.height,n.transcodedPixels,i,a)}),t._features.basisNeedsPOT&&(Te.Log2(o.width)%1!==0||Te.Log2(o.height)%1!==0)&&(Y.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),o._cachedWrapU=V.CLAMP_ADDRESSMODE,o._cachedWrapV=V.CLAMP_ADDRESSMODE)}}},Mf={JSModuleURL:Rn.JSModuleURL,WasmModuleURL:Rn.WasmModuleURL,GetInternalFormatFromBasisFormat:Lb,TranscodeAsync:bd,LoadTextureFromTranscodeResult:Sd};function Ub(){const o={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21};let e=null;onmessage=n=>{if(n.data.action==="init"){if(!e){try{importScripts(n.data.url)}catch(a){postMessage({action:"error",error:a})}e=BASIS({wasmBinary:n.data.wasmBinary})}e!==null&&e.then(a=>{BASIS=a,a.initializeBasis(),postMessage({action:"init"})})}else if(n.data.action==="transcode"){const a=n.data.config,l=n.data.imageData,h=new BASIS.BasisFile(l),c=i(h);let u=n.data.ignoreSupportedFormats?null:t(n.data.config,c),d=!1;u===null&&(d=!0,u=c.hasAlpha?o.cTFBC3:o.cTFBC1);let f=!0;h.startTranscoding()||(f=!1);const p=[];for(let _=0;_<c.images.length&&f;_++){const g=c.images[_];if(a.loadSingleImage===void 0||a.loadSingleImage===_){let E=g.levels.length;a.loadMipmapLevels===!1&&(E=1);for(let R=0;R<E;R++){const x=g.levels[R],S=s(h,_,R,u,d);if(!S){f=!1;break}x.transcodedPixels=S,p.push(x.transcodedPixels.buffer)}}}h.close(),h.delete(),d&&(u=-1),f?postMessage({action:"transcode",success:f,id:n.data.id,fileInfo:c,format:u},p):postMessage({action:"transcode",success:f,id:n.data.id})}};function t(n,a){let l=null;return n.supportedCompressionFormats&&(n.supportedCompressionFormats.astc?l=o.cTFASTC_4x4:n.supportedCompressionFormats.bc7?l=o.cTFBC7:n.supportedCompressionFormats.s3tc?l=a.hasAlpha?o.cTFBC3:o.cTFBC1:n.supportedCompressionFormats.pvrtc?l=a.hasAlpha?o.cTFPVRTC1_4_RGBA:o.cTFPVRTC1_4_RGB:n.supportedCompressionFormats.etc2?l=o.cTFETC2:n.supportedCompressionFormats.etc1?l=o.cTFETC1:l=o.cTFRGB565),l}function i(n){const a=n.getHasAlpha(),l=n.getNumImages(),h=[];for(let u=0;u<l;u++){const d={levels:[]},f=n.getNumLevels(u);for(let p=0;p<f;p++){const _={width:n.getImageWidth(u,p),height:n.getImageHeight(u,p)};d.levels.push(_)}h.push(d)}return{hasAlpha:a,images:h}}function s(n,a,l,h,c){const u=n.getImageTranscodedSizeInBytes(a,l,h);let d=new Uint8Array(u);if(!n.transcodeImage(d,a,l,h,1,0))return null;if(c){const f=n.getImageWidth(a,l)+3&-4,p=n.getImageHeight(a,l)+3&-4;d=r(d,0,f,p)}return d}function r(n,a,l,h){const c=new Uint16Array(4),u=new Uint16Array(l*h),d=l/4,f=h/4;for(let p=0;p<f;p++)for(let _=0;_<d;_++){const g=a+8*(p*d+_);c[0]=n[g]|n[g+1]<<8,c[1]=n[g+2]|n[g+3]<<8,c[2]=(2*(c[0]&31)+1*(c[1]&31))/3|(2*(c[0]&2016)+1*(c[1]&2016))/3&2016|(2*(c[0]&63488)+1*(c[1]&63488))/3&63488,c[3]=(2*(c[1]&31)+1*(c[0]&31))/3|(2*(c[1]&2016)+1*(c[0]&2016))/3&2016|(2*(c[1]&63488)+1*(c[0]&63488))/3&63488;for(let E=0;E<4;E++){const R=n[g+4+E];let x=(p*4+E)*l+_*4;u[x++]=c[R&3],u[x++]=c[R>>2&3],u[x++]=c[R>>4&3],u[x++]=c[R>>6&3]}}return u}}Object.defineProperty(Mf,"JSModuleURL",{get:function(){return Rn.JSModuleURL},set:function(o){Rn.JSModuleURL=o}});Object.defineProperty(Mf,"WasmModuleURL",{get:function(){return Rn.WasmModuleURL},set:function(o){Rn.WasmModuleURL=o}});class kb{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,s,r){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};bd(e,a).then(l=>{const h=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;Sd(t,l),t.getEngine()._setCubeMapTextureParams(t,h),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}).catch(l=>{const h="Failed to transcode Basis file, transcoding may not be supported on this device";Y.Warn(h),t.isReady=!0,r&&r(l)})}loadData(e,t,i){const s=t.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}};bd(e,r).then(n=>{const a=n.fileInfo.images[0].levels[0],l=n.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(a.width,a.height,l,n.format!==-1,()=>{Sd(t,n)})}).catch(n=>{Y.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),Y.Warn(`Failed to transcode Basis file: ${n}`),i(0,0,!1,!1,()=>{},!0)})}}H._TextureLoaders.push(new kb);var Lc;(function(o){o[o.NONE=0]="NONE",o[o.STEP=1]="STEP"})(Lc||(Lc={}));class io{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new io(this.name,this.from,this.to)}}class Vb{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new j,this._onClonedObservable=new j}}class Jt{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,s){const r=this._NodeConstructors[e];return r?r(t,i,s):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new Vb,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new j,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=L.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new j,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||Ze.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let s=0;s<this._children.length;s++){const r=this._children[s];(!i||i(r))&&e.push(r),t||r._getDescendants(e,!1,i)}}getDescendants(e,t){const i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,s=>(!t||t(s))&&s.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=Jt._AnimationRangeFactory(e,t,i);for(let s=0,r=this.animations.length;s<r;s++)this.animations[s]&&this.animations[s].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){const s=Le.Clone(()=>new Jt(e,this.getScene()),this);if(t&&(s.parent=t),!i){const r=this.getDescendants(!0);for(let n=0;n<r.length;n++){const a=r[n];a.clone(e+"."+a.name,s)}}return s}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=L.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const s of i)s.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let s=0;s<t.ranges.length;s++){const r=t.ranges[s];e.createAnimationRange(r.name,r.from,r.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,s;const r=this;if(r.getBoundingInfo&&r.subMeshes){const n=r.getBoundingInfo();i=n.boundingBox.minimumWorld.clone(),s=n.boundingBox.maximumWorld.clone()}else i=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const n=this.getDescendants(!1);for(const a of n){const l=a;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;const c=l.getBoundingInfo().boundingBox,u=c.minimumWorld,d=c.maximumWorld;m.CheckExtends(u,i,s),m.CheckExtends(d,i,s)}}return{min:i,max:s}}}Jt._AnimationRangeFactory=(o,e,t)=>{throw ke("AnimationRange")};Jt._NodeConstructors={};v([M()],Jt.prototype,"name",void 0);v([M()],Jt.prototype,"id",void 0);v([M()],Jt.prototype,"uniqueId",void 0);v([M()],Jt.prototype,"state",void 0);v([M()],Jt.prototype,"metadata",void 0);const Fm=Object.freeze(new le(0,0,0,0)),wm=Object.freeze(m.Zero()),Bm=Object.freeze(Ke.Zero()),Um=Object.freeze(xs.Zero()),km=Object.freeze(J.Black()),Vm=Object.freeze(new He(0,0,0,0)),js={key:0,repeatCount:0,loopMode:2};class W{static _PrepareAnimation(e,t,i,s,r,n,a,l){let h;if(!isNaN(parseFloat(r))&&isFinite(r)?h=W.ANIMATIONTYPE_FLOAT:r instanceof le?h=W.ANIMATIONTYPE_QUATERNION:r instanceof m?h=W.ANIMATIONTYPE_VECTOR3:r instanceof Ke?h=W.ANIMATIONTYPE_VECTOR2:r instanceof J?h=W.ANIMATIONTYPE_COLOR3:r instanceof He?h=W.ANIMATIONTYPE_COLOR4:r instanceof xs&&(h=W.ANIMATIONTYPE_SIZE),h==null)return null;const c=new W(e,t,i,h,a),u=[{frame:0,value:r},{frame:s,value:n}];return c.setKeys(u),l!==void 0&&c.setEasingFunction(l),c}static CreateAnimation(e,t,i,s){const r=new W(e+"Animation",e,i,t,W.ANIMATIONLOOPMODE_CONSTANT);return r.setEasingFunction(s),r}static CreateAndStartAnimation(e,t,i,s,r,n,a,l,h,c,u){const d=W._PrepareAnimation(e,i,s,r,n,a,l,h);return!d||(t.getScene&&(u=t.getScene()),!u)?null:u.beginDirectAnimation(t,[d],0,r,d.loopMode===1,1,c)}static CreateAndStartHierarchyAnimation(e,t,i,s,r,n,a,l,h,c,u){const d=W._PrepareAnimation(e,s,r,n,a,l,h,c);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,n,d.loopMode===1,1,u):null}static CreateMergeAndStartAnimation(e,t,i,s,r,n,a,l,h,c){const u=W._PrepareAnimation(e,i,s,r,n,a,l,h);return u?(t.animations.push(u),t.getScene().beginAnimation(t,0,r,u.loopMode===1,1,c)):null}static MakeAnimationAdditive(e,t,i,s=!1,r){var n,a;let l;typeof t=="object"?l=t:l={referenceFrame:t??0,range:i,cloneOriginalAnimation:s,clonedAnimationName:r};let h=e;if(l.cloneOriginalAnimation&&(h=e.clone(),h.name=l.clonedAnimationName||h.name),!h._keys.length)return h;const c=l.referenceFrame&&l.referenceFrame>=0?l.referenceFrame:0;let u=0;const d=h._keys[0];let f=h._keys.length-1;const p=h._keys[f],_={referenceValue:d.value,referencePosition:D.Vector3[0],referenceQuaternion:D.Quaternion[0],referenceScaling:D.Vector3[1],keyPosition:D.Vector3[2],keyQuaternion:D.Quaternion[1],keyScaling:D.Vector3[3]};let g=d.frame,E=p.frame;if(l.range){const S=h.getRange(l.range);S&&(g=S.from,E=S.to)}else g=(n=l.fromFrame)!==null&&n!==void 0?n:g,E=(a=l.toFrame)!==null&&a!==void 0?a:E;if(g!==d.frame&&(u=h.createKeyForFrame(g)),E!==p.frame&&(f=h.createKeyForFrame(E)),h._keys.length===1){const S=h._getKeyValue(h._keys[0]);_.referenceValue=S.clone?S.clone():S}else if(c<=d.frame){const S=h._getKeyValue(d.value);_.referenceValue=S.clone?S.clone():S}else if(c>=p.frame){const S=h._getKeyValue(p.value);_.referenceValue=S.clone?S.clone():S}else{js.key=0;const S=h._interpolate(c,js);_.referenceValue=S.clone?S.clone():S}h.dataType===W.ANIMATIONTYPE_QUATERNION?_.referenceValue.normalize().conjugateInPlace():h.dataType===W.ANIMATIONTYPE_MATRIX&&(_.referenceValue.decompose(_.referenceScaling,_.referenceQuaternion,_.referencePosition),_.referenceQuaternion.normalize().conjugateInPlace());let R=Number.MAX_VALUE;const x=l.clipKeys?[]:null;for(let S=u;S<=f;S++){let b=h._keys[S];if(x&&(b={frame:b.frame,value:b.value.clone?b.value.clone():b.value,inTangent:b.inTangent,outTangent:b.outTangent,interpolation:b.interpolation,lockedTangent:b.lockedTangent},R===Number.MAX_VALUE&&(R=b.frame),b.frame-=R,x.push(b)),!(S&&h.dataType!==W.ANIMATIONTYPE_FLOAT&&b.value===d.value))switch(h.dataType){case W.ANIMATIONTYPE_MATRIX:b.value.decompose(_.keyScaling,_.keyQuaternion,_.keyPosition),_.keyPosition.subtractInPlace(_.referencePosition),_.keyScaling.divideInPlace(_.referenceScaling),_.referenceQuaternion.multiplyToRef(_.keyQuaternion,_.keyQuaternion),L.ComposeToRef(_.keyScaling,_.keyQuaternion,_.keyPosition,b.value);break;case W.ANIMATIONTYPE_QUATERNION:_.referenceValue.multiplyToRef(b.value,b.value);break;case W.ANIMATIONTYPE_VECTOR2:case W.ANIMATIONTYPE_VECTOR3:case W.ANIMATIONTYPE_COLOR3:case W.ANIMATIONTYPE_COLOR4:b.value.subtractToRef(_.referenceValue,b.value);break;case W.ANIMATIONTYPE_SIZE:b.value.width-=_.referenceValue.width,b.value.height-=_.referenceValue.height;break;default:b.value-=_.referenceValue}}return x&&h.setKeys(x,!0),h}static TransitionTo(e,t,i,s,r,n,a,l=null){if(a<=0)return i[e]=t,l&&l(),null;const h=r*(a/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:h,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const c=s.beginAnimation(i,0,h,!1);return c.onAnimationEnd=l,c}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,s,r,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=s,this.loopMode=r,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=s,this.loopMode=r===void 0?W.ANIMATIONLOOPMODE_CYCLE:r,this.uniqueId=W._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const s in this._ranges)i&&(t+=", ",i=!1),t+=s;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new io(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(i){if(t){const s=i.from,r=i.to;for(let n=this._keys.length-1;n>=0;n--)this._keys[n].frame>=s&&this._keys[n].frame<=r&&this._keys.splice(n,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return Te.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,s,r){return Te.Hermite(e,t,i,s,r)}quaternionInterpolateFunction(e,t,i){return le.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,r){return le.Hermite(e,t,i,s,r).normalize()}vector3InterpolateFunction(e,t,i){return m.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,r){return m.Hermite(e,t,i,s,r)}vector2InterpolateFunction(e,t,i){return Ke.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,r){return Ke.Hermite(e,t,i,s,r)}sizeInterpolateFunction(e,t,i){return xs.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return J.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,s,r){return J.Hermite(e,t,i,s,r)}color4InterpolateFunction(e,t,i){return He.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,s,r){return He.Hermite(e,t,i,s,r)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return js.key=0,this._interpolate(e,js)}_interpolate(e,t,i=!1){var s;if(t.loopMode===W.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const r=this._keys,n=r.length;let a=t.key;for(;a>=0&&e<r[a].frame;)--a;for(;a+1<=n-1&&e>=r[a+1].frame;)++a;if(t.key=a,a<0)return i?void 0:this._getKeyValue(r[0].value);if(a+1>n-1)return i?void 0:this._getKeyValue(r[n-1].value);const l=r[a],h=r[a+1];if(i&&(e===l.frame||e===h.frame))return;const c=this._getKeyValue(l.value),u=this._getKeyValue(h.value);if(l.interpolation===Lc.STEP)return h.frame>e?c:u;const d=l.outTangent!==void 0&&h.inTangent!==void 0,f=h.frame-l.frame;let p=(e-l.frame)/f;const _=l.easingFunction||this.getEasingFunction();switch(_!==null&&(p=_.ease(p)),this.dataType){case W.ANIMATIONTYPE_FLOAT:{const g=d?this.floatInterpolateFunctionWithTangents(c,l.outTangent*f,u,h.inTangent*f,p):this.floatInterpolateFunction(c,u,p);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return g;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return((s=t.offsetValue)!==null&&s!==void 0?s:0)*t.repeatCount+g}break}case W.ANIMATIONTYPE_QUATERNION:{const g=d?this.quaternionInterpolateFunctionWithTangents(c,l.outTangent.scale(f),u,h.inTangent.scale(f),p):this.quaternionInterpolateFunction(c,u,p);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return g;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.addInPlace((t.offsetValue||Fm).scale(t.repeatCount))}return g}case W.ANIMATIONTYPE_VECTOR3:{const g=d?this.vector3InterpolateFunctionWithTangents(c,l.outTangent.scale(f),u,h.inTangent.scale(f),p):this.vector3InterpolateFunction(c,u,p);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return g;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||wm).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_VECTOR2:{const g=d?this.vector2InterpolateFunctionWithTangents(c,l.outTangent.scale(f),u,h.inTangent.scale(f),p):this.vector2InterpolateFunction(c,u,p);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return g;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||Bm).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(c,u,p);case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(c,u,p).add((t.offsetValue||Um).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_COLOR3:{const g=d?this.color3InterpolateFunctionWithTangents(c,l.outTangent.scale(f),u,h.inTangent.scale(f),p):this.color3InterpolateFunction(c,u,p);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return g;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||km).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_COLOR4:{const g=d?this.color4InterpolateFunctionWithTangents(c,l.outTangent.scale(f),u,h.inTangent.scale(f),p):this.color4InterpolateFunction(c,u,p);switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return g;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||Vm).scale(t.repeatCount))}break}case W.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case W.ANIMATIONLOOPMODE_CYCLE:case W.ANIMATIONLOOPMODE_CONSTANT:case W.ANIMATIONLOOPMODE_YOYO:return W.AllowMatricesInterpolation?this.matrixInterpolateFunction(c,u,p,t.workValue):c;case W.ANIMATIONLOOPMODE_RELATIVE:case W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return c}break}}return 0}matrixInterpolateFunction(e,t,i,s){return W.AllowMatrixDecomposeForInterpolation?s?(L.DecomposeLerpToRef(e,t,i,s),s):L.DecomposeLerp(e,t,i):s?(L.LerpToRef(e,t,i,s),s):L.Lerp(e,t,i)}clone(){const e=new W(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){js.key=0;const t=this._interpolate(e,js,!0);if(!t)return this._keys[js.key].frame===e?js.key:js.key+1;const i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(js.key+1,0,i),js.key+1}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let s=0;s<i.length;s++){const r=i[s],n={};switch(n.frame=r.frame,t){case W.ANIMATIONTYPE_FLOAT:n.values=[r.value],r.inTangent!==void 0&&n.values.push(r.inTangent),r.outTangent!==void 0&&(r.inTangent===void 0&&n.values.push(void 0),n.values.push(r.outTangent)),r.interpolation!==void 0&&(r.inTangent===void 0&&n.values.push(void 0),r.outTangent===void 0&&n.values.push(void 0),n.values.push(r.interpolation));break;case W.ANIMATIONTYPE_QUATERNION:case W.ANIMATIONTYPE_MATRIX:case W.ANIMATIONTYPE_VECTOR3:case W.ANIMATIONTYPE_COLOR3:case W.ANIMATIONTYPE_COLOR4:n.values=r.value.asArray(),r.inTangent!=null&&n.values.push(r.inTangent.asArray()),r.outTangent!=null&&(r.inTangent===void 0&&n.values.push(void 0),n.values.push(r.outTangent.asArray())),r.interpolation!==void 0&&(r.inTangent===void 0&&n.values.push(void 0),r.outTangent===void 0&&n.values.push(void 0),n.values.push(r.interpolation));break}e.keys.push(n)}e.ranges=[];for(const s in this._ranges){const r=this._ranges[s];if(!r)continue;const n={};n.name=s,n.from=r.from,n.to=r.to,e.ranges.push(n)}return e}static _UniversalLerp(e,t,i){const s=e.constructor;return s.Lerp?s.Lerp(e,t,i):s.Slerp?s.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new W(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let r,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const a=e.keys[n];let l,h,c;switch(i){case W.ANIMATIONTYPE_FLOAT:r=a.values[0],a.values.length>=2&&(l=a.values[1]),a.values.length>=3&&(h=a.values[2]),a.values.length>=4&&(c=a.values[3]);break;case W.ANIMATIONTYPE_QUATERNION:if(r=le.FromArray(a.values),a.values.length>=8){const d=le.FromArray(a.values.slice(4,8));d.equals(le.Zero())||(l=d)}if(a.values.length>=12){const d=le.FromArray(a.values.slice(8,12));d.equals(le.Zero())||(h=d)}a.values.length>=13&&(c=a.values[12]);break;case W.ANIMATIONTYPE_MATRIX:r=L.FromArray(a.values),a.values.length>=17&&(c=a.values[16]);break;case W.ANIMATIONTYPE_COLOR3:r=J.FromArray(a.values),a.values[3]&&(l=J.FromArray(a.values[3])),a.values[4]&&(h=J.FromArray(a.values[4])),a.values[5]&&(c=a.values[5]);break;case W.ANIMATIONTYPE_COLOR4:r=He.FromArray(a.values),a.values[4]&&(l=He.FromArray(a.values[4])),a.values[5]&&(h=He.FromArray(a.values[5])),a.values[6]&&(c=He.FromArray(a.values[6]));break;case W.ANIMATIONTYPE_VECTOR3:default:r=m.FromArray(a.values),a.values[3]&&(l=m.FromArray(a.values[3])),a.values[4]&&(h=m.FromArray(a.values[4])),a.values[5]&&(c=a.values[5]);break}const u={};u.frame=a.frame,u.value=r,l!=null&&(u.inTangent=l),h!=null&&(u.outTangent=h),c!=null&&(u.interpolation=c),s.push(u)}if(t.setKeys(s),e.ranges)for(n=0;n<e.ranges.length;n++)r=e.ranges[n],t.createRange(r.name,r.from,r.to);return t}static AppendSerializedAnimations(e,t){Le.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,s)=>{const r=new Pi;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){let n=JSON.parse(r.responseText);if(n.animations&&(n=n.animations),n.length){const a=[];for(const l of n)a.push(this.Parse(l));i(a)}else{const a=this.Parse(n);e&&(a.name=e),i(a)}}else s("Unable to load the animation")}),r.open("GET",t),r.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const s=new Pi;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){const r=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(r.animations){const n=JSON.parse(r.animations),a=[];for(const l of n.animations){const h=this.Parse(l);h.snippetId=e,a.push(h)}t(a)}else{const n=JSON.parse(r.animation),a=this.Parse(n);a.snippetId=e,t(a)}}else i("Unable to load the snippet "+e)}),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()})}}W._UniqueIdGenerator=0;W.AllowMatricesInterpolation=!1;W.AllowMatrixDecomposeForInterpolation=!0;W.SnippetUrl="https://snippet.babylonjs.com";W.ANIMATIONTYPE_FLOAT=0;W.ANIMATIONTYPE_VECTOR3=1;W.ANIMATIONTYPE_QUATERNION=2;W.ANIMATIONTYPE_MATRIX=3;W.ANIMATIONTYPE_COLOR3=4;W.ANIMATIONTYPE_COLOR4=7;W.ANIMATIONTYPE_VECTOR2=5;W.ANIMATIONTYPE_SIZE=6;W.ANIMATIONLOOPMODE_RELATIVE=0;W.ANIMATIONLOOPMODE_CYCLE=1;W.ANIMATIONLOOPMODE_CONSTANT=2;W.ANIMATIONLOOPMODE_YOYO=4;W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5;W.CreateFromSnippetAsync=W.ParseFromSnippetAsync;Re("BABYLON.Animation",W);Jt._AnimationRangeFactory=(o,e,t)=>new io(o,e,t);class Gb{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===W.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=L.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const n={frame:0,value:this._minValue};this._keys.splice(0,0,n)}if(this._target instanceof Array){let n=0;for(const a of this._target)this._preparePath(a,n),this._getOriginalValues(n),n++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const r=t.getEvents();r&&r.length>0&&r.forEach(n=>{this._events.push(n._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let s=e[i[0]];for(let r=1;r<i.length-1;r++)s=s[i[r]];this._targetPath=i[i.length-1],this._activeTargets[t]=s}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const s=this._target[i];this._setValue(s,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getLocalMatrix&&this._targetPath==="_matrix"?t=i.getLocalMatrix():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,s,r){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const a=t[this._targetPath];a.clone?this._originalBlendValue=a.clone():this._originalBlendValue=a}this._originalBlendValue.m?W.AllowMatrixDecomposeForInterpolation?this._currentValue?L.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=L.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?L.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=L.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=W._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const n=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=n}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;s!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[r]):this._animationState.loopMode===W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[r],t[this._targetPath]):t[this._targetPath]=this._originalValue[r]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let r=0;r<i.length;r++)i[r].onlyOnce||(i[r].isDone=i[r].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,-1)}_prepareForSpeedRatioChange(e){const t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,s,r,n=-1){const a=this._animation,l=a.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let h=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const c=i-t;let u,d=e*(a.framePerSecond*r)/1e3+this._absoluteFrameOffset,f=0;if(s&&this._animationState.loopMode===W.ANIMATIONLOOPMODE_YOYO){const E=(d-t)/c;d=Math.abs(Math.sin(E*Math.PI))*c+t}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=d,!s&&i>=t&&d>=c)h=!1,f=a._getKeyValue(this._maxValue);else if(!s&&t>=i&&d<=c)h=!1,f=a._getKeyValue(this._minValue);else if(this._animationState.loopMode!==W.ANIMATIONLOOPMODE_CYCLE){const E=i.toString()+t.toString();if(!this._offsetsCache[E]){this._animationState.repeatCount=0,this._animationState.loopMode=W.ANIMATIONLOOPMODE_CYCLE;const R=a._interpolate(t,this._animationState),x=a._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),a.dataType){case W.ANIMATIONTYPE_FLOAT:this._offsetsCache[E]=x-R;break;case W.ANIMATIONTYPE_QUATERNION:this._offsetsCache[E]=x.subtract(R);break;case W.ANIMATIONTYPE_VECTOR3:this._offsetsCache[E]=x.subtract(R);break;case W.ANIMATIONTYPE_VECTOR2:this._offsetsCache[E]=x.subtract(R);break;case W.ANIMATIONTYPE_SIZE:this._offsetsCache[E]=x.subtract(R);break;case W.ANIMATIONTYPE_COLOR3:this._offsetsCache[E]=x.subtract(R);break}this._highLimitsCache[E]=x}f=this._highLimitsCache[E],u=this._offsetsCache[E]}if(u===void 0)switch(a.dataType){case W.ANIMATIONTYPE_FLOAT:u=0;break;case W.ANIMATIONTYPE_QUATERNION:u=Fm;break;case W.ANIMATIONTYPE_VECTOR3:u=wm;break;case W.ANIMATIONTYPE_VECTOR2:u=Bm;break;case W.ANIMATIONTYPE_SIZE:u=Um;break;case W.ANIMATIONTYPE_COLOR3:u=km;break;case W.ANIMATIONTYPE_COLOR4:u=Vm;break}let p;if(this._host&&this._host.syncRoot){const E=this._host.syncRoot,R=(E.masterFrame-E.fromFrame)/(E.toFrame-E.fromFrame);p=t+c*R}else d>0&&t>i||d<0&&t<i?p=h&&c!==0?i+d%c:t:p=h&&c!==0?t+d%c:i;const _=this._events;if(r>0&&this.currentFrame>p||r<0&&this.currentFrame<p){this._onLoop();for(let E=0;E<_.length;E++)_[E].onlyOnce||(_[E].isDone=!1);this._animationState.key=r>0?0:a.getKeys().length-1}this._currentFrame=p,this._animationState.repeatCount=c===0?0:d/c>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=u;const g=a._interpolate(p,this._animationState);if(this.setValue(g,n),_.length){for(let E=0;E<_.length;E++)if(c>0&&p>=_[E].frame&&_[E].frame>=t||c<0&&p<=_[E].frame&&_[E].frame<=t){const R=_[E];R.isDone||(R.onlyOnce&&(_.splice(E,1),E--),R.isDone=!0,R.action(p))}}return h||(this._stopped=!0),h}}class vt extends Jt{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){e.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,s=null,r=null,n=null,a=null){var l;super(e,t.getScene()),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=(l=s==null?void 0:s.clone())!==null&&l!==void 0?l:L.Identity(),this._restMatrix=r??this._localMatrix.clone(),this._bindMatrix=n??this._localMatrix.clone(),this._index=a,this._absoluteMatrix=new L,this._absoluteBindMatrix=new L,this._absoluteInverseBindMatrix=new L,this._finalMatrix=new L,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){var e;if(this._linkedTransformNode){const t=D.Vector3[0],i=D.Quaternion[0],s=D.Vector3[1];this.getRestMatrix().decompose(t,i,s),this._linkedTransformNode.position.copyFrom(s),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:le.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=m.Zero(),this._localRotation=le.Zero(),this._localPosition=m.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,L.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=ft.LOCAL,i,s=!0){const r=this.getLocalMatrix();if(t==ft.LOCAL)s?(r.addAtIndex(12,e.x),r.addAtIndex(13,e.y),r.addAtIndex(14,e.z)):r.setTranslationFromFloats(e.x,e.y,e.z);else{let n=null;i&&(n=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const a=vt._TmpMats[0],l=vt._TmpVecs[0];this.parent?i&&n?(a.copyFrom(this.parent.getAbsoluteMatrix()),a.multiplyToRef(n,a)):a.copyFrom(this.parent.getAbsoluteMatrix()):L.IdentityToRef(a),s&&a.setTranslationFromFloats(0,0,0),a.invert(),m.TransformCoordinatesToRef(e,a,l),s?(r.addAtIndex(12,l.x),r.addAtIndex(13,l.y),r.addAtIndex(14,l.z)):r.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=ft.LOCAL,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=ft.LOCAL,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,ft.WORLD,t)}scale(e,t,i,s=!1){const r=this.getLocalMatrix(),n=vt._TmpMats[0];L.ScalingToRef(e,t,i,n),n.multiplyToRef(r,r),n.invert();for(const a of this.children){const l=a.getLocalMatrix();l.multiplyToRef(n,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),a._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const a of this.children)a.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=ft.LOCAL,r){if(s===ft.LOCAL){const l=vt._TmpQuat;le.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,s,r);return}const n=vt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,r))return;const a=vt._TmpMats[1];L.RotationYawPitchRollToRef(e,t,i,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,s,r)}rotate(e,t,i=ft.LOCAL,s){const r=vt._TmpMats[0];r.setTranslationFromFloats(0,0,0),L.RotationAxisToRef(e,t,r),this._rotateWithMatrix(r,i,s)}setAxisAngle(e,t,i=ft.LOCAL,s){if(i===ft.LOCAL){const a=vt._TmpQuat;le.RotationAxisToRef(e,t,a),this.setRotationQuaternion(a,i,s);return}const r=vt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,s))return;const n=vt._TmpMats[1];L.RotationAxisToRef(e,t,n),r.multiplyToRef(n,n),this._rotateWithMatrix(n,i,s)}setRotation(e,t=ft.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=ft.LOCAL,i){if(t===ft.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const s=vt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const r=vt._TmpMats[1];L.FromQuaternionToRef(e,r),s.multiplyToRef(r,r),this._rotateWithMatrix(r,t,i)}setRotationMatrix(e,t=ft.LOCAL,i){if(t===ft.LOCAL){const n=vt._TmpQuat;le.FromRotationMatrixToRef(e,n),this.setRotationQuaternion(n,t,i);return}const s=vt._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;const r=vt._TmpMats[1];r.copyFrom(e),s.multiplyToRef(e,r),this._rotateWithMatrix(r,t,i)}_rotateWithMatrix(e,t=ft.LOCAL,i){const s=this.getLocalMatrix(),r=s.m[12],n=s.m[13],a=s.m[14],l=this.getParent(),h=vt._TmpMats[3],c=vt._TmpMats[4];l&&t==ft.WORLD?(i?(h.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(h,h)):h.copyFrom(l.getAbsoluteMatrix()),c.copyFrom(h),c.invert(),s.multiplyToRef(h,s),s.multiplyToRef(e,s),s.multiplyToRef(c,s)):t==ft.WORLD&&i?(h.copyFrom(i.getWorldMatrix()),c.copyFrom(h),c.invert(),s.multiplyToRef(h,s),s.multiplyToRef(e,s),s.multiplyToRef(c,s)):s.multiplyToRef(e,s),s.setTranslationFromFloats(r,n,a),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){const i=vt._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),L.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):L.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=ft.LOCAL,t=null){const i=m.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=ft.LOCAL,t,i){if(e==ft.LOCAL){const s=this.getLocalMatrix();i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}else{let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let r=vt._TmpMats[0];t&&s?(r.copyFrom(this.getAbsoluteMatrix()),r.multiplyToRef(s,r)):r=this.getAbsoluteMatrix(),i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}}getAbsolutePosition(e=null){const t=m.Zero();return this.getPositionToRef(ft.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(ft.WORLD,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){const i=m.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=vt._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),m.TransformNormalToRef(e,r,i),i.normalize()}getRotation(e=ft.LOCAL,t=null){const i=m.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=ft.LOCAL,t=null,i){const s=vt._TmpQuat;this.getRotationQuaternionToRef(e,t,s),s.toEulerAnglesToRef(i)}getRotationQuaternion(e=ft.LOCAL,t=null){const i=le.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=ft.LOCAL,t=null,i){if(e==ft.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const s=vt._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(r),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.decompose(void 0,i,void 0)}}getRotationMatrix(e=ft.LOCAL,t){const i=L.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=ft.LOCAL,t,i){if(e==ft.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const s=vt._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(r),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=m.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=vt._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),m.TransformCoordinatesToRef(e,r,i)}getLocalPositionFromAbsolute(e,t=null){const i=m.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();const r=vt._TmpMats[0];r.copyFrom(this.getAbsoluteMatrix()),t&&s&&r.multiplyToRef(s,r),r.invert(),m.TransformCoordinatesToRef(e,r,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}vt._TmpVecs=yi.BuildArray(2,m.Zero);vt._TmpQuat=le.Identity();vt._TmpMats=yi.BuildArray(5,L.Identity);class Gm{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,s=100,r=!1,n=1,a,l,h,c=!1,u=0){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=r,this.onAnimationEnd=a,this.onAnimationLoop=h,this.isAdditive=c,this.playOrder=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new j,this.onAnimationLoopObservable=new j,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=n,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=t[i],r=new Gb(e,s,this._scene,this);r._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(r)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const s=i[0].animation.framePerSecond;this._frameToSyncFromJump=(t=this._frameToSyncFromJump)!==null&&t!==void 0?t:i[0].currentFrame;const r=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let s=0;s<i.length;s++)i[s].goToFrame(e);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){const r=this._runtimeAnimations;for(let n=r.length-1;n>=0;n--){const a=r[n];e&&a.animation.name!=e||t&&!t(a.target)||(a.dispose(),r.splice(n,1))}r.length==0&&(i||this._scene._activeAnimatables.splice(s,1),this._raiseOnAnimationEnd())}}else{const s=this._scene._activeAnimatables.indexOf(this);if(s>-1){i||this._scene._activeAnimatables.splice(s,1);const r=this._runtimeAnimations;for(let n=0;n<r.length;n++)r[n].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const n=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||n}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}Ve.prototype._animate=function(){if(!this.animationsEnabled)return;const o=Os.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=o}this.deltaTime=this.useConstantAnimationDeltaTime?16:(o-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=o;const e=this._activeAnimatables;if(e.length===0)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const s=e[i];!s._animate(t)&&s.disposeOnEnd&&i--}this._processLateAnimationBindings()};Ve.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((o,e)=>o.playOrder-e.playOrder)};Ve.prototype.beginWeightedAnimation=function(o,e,t,i=1,s,r=1,n,a,l,h,c=!1){const u=this.beginAnimation(o,e,t,s,r,n,a,!1,l,h,c);return u.weight=i,u};Ve.prototype.beginAnimation=function(o,e,t,i,s=1,r,n,a=!0,l,h,c=!1){e>t&&s>0&&(s*=-1),a&&this.stopAnimation(o,void 0,l),n||(n=new Gm(this,o,e,t,i,s,r,void 0,h,c));const u=l?l(o):!0;if(o.animations&&u&&n.appendAnimations(o,o.animations),o.getAnimatables){const d=o.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,s,r,n,a,l,h)}return n.reset(),n};Ve.prototype.beginHierarchyAnimation=function(o,e,t,i,s,r=1,n,a,l=!0,h,c,u=!1){const d=o.getDescendants(e),f=[];f.push(this.beginAnimation(o,t,i,s,r,n,a,l,h,void 0,u));for(const p of d)f.push(this.beginAnimation(p,t,i,s,r,n,a,l,h,void 0,u));return f};Ve.prototype.beginDirectAnimation=function(o,e,t,i,s,r,n,a,l=!1){if(r===void 0&&(r=1),t>i&&r>0)r*=-1;else if(i>t&&r<0){const c=i;i=t,t=c}return new Gm(this,o,t,i,s,r,n,e,a,l)};Ve.prototype.beginDirectHierarchyAnimation=function(o,e,t,i,s,r,n,a,l,h=!1){const c=o.getDescendants(e),u=[];u.push(this.beginDirectAnimation(o,t,i,s,r,n,a,l,h));for(const d of c)u.push(this.beginDirectAnimation(d,t,i,s,r,n,a,l,h));return u};Ve.prototype.getAnimatableByTarget=function(o){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===o)return this._activeAnimatables[e];return null};Ve.prototype.getAllAnimatablesByTarget=function(o){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===o&&e.push(this._activeAnimatables[t]);return e};Ve.prototype.stopAnimation=function(o,e,t){const i=this.getAllAnimatablesByTarget(o);for(const s of i)s.stop(e,t)};Ve.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let o=0;o<this._activeAnimatables.length;o++)this._activeAnimatables[o].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(const o of this.animationGroups)o.stop()};Ve.prototype._registerTargetForLateAnimationBinding=function(o,e){const t=o.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[o.targetPath]||(t._lateAnimationHolders[o.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),o.isAdditive?(t._lateAnimationHolders[o.targetPath].additiveAnimations.push(o),t._lateAnimationHolders[o.targetPath].totalAdditiveWeight+=o.weight):(t._lateAnimationHolders[o.targetPath].animations.push(o),t._lateAnimationHolders[o.targetPath].totalWeight+=o.weight)};Ve.prototype._processLateAnimationBindingsForMatrices=function(o){if(o.totalWeight===0&&o.totalAdditiveWeight===0)return o.originalValue;let e=1;const t=D.Vector3[0],i=D.Vector3[1],s=D.Quaternion[0];let r=0;const n=o.animations[0],a=o.originalValue;let l=1,h=!1;if(o.totalWeight<1)l=1-o.totalWeight,a.decompose(i,s,t);else{if(r=1,e=o.totalWeight,l=n.weight/e,l==1)if(o.totalAdditiveWeight)h=!0;else return n.currentValue;n.currentValue.decompose(i,s,t)}if(!h){i.scaleInPlace(l),t.scaleInPlace(l),s.scaleInPlace(l);for(let u=r;u<o.animations.length;u++){const d=o.animations[u];if(d.weight===0)continue;l=d.weight/e;const f=D.Vector3[2],p=D.Vector3[3],_=D.Quaternion[1];d.currentValue.decompose(p,_,f),p.scaleAndAddToRef(l,i),_.scaleAndAddToRef(le.Dot(s,_)>0?l:-l,s),f.scaleAndAddToRef(l,t)}s.normalize()}for(let u=0;u<o.additiveAnimations.length;u++){const d=o.additiveAnimations[u];if(d.weight===0)continue;const f=D.Vector3[2],p=D.Vector3[3],_=D.Quaternion[1];d.currentValue.decompose(p,_,f),p.multiplyToRef(i,p),m.LerpToRef(i,p,d.weight,i),s.multiplyToRef(_,_),le.SlerpToRef(s,_,d.weight,s),f.scaleAndAddToRef(d.weight,t)}const c=n?n._animationState.workValue:D.Matrix[0].clone();return L.ComposeToRef(i,s,t,c),c};Ve.prototype._processLateAnimationBindingsForQuaternions=function(o,e){if(o.totalWeight===0&&o.totalAdditiveWeight===0)return e;const t=o.animations[0],i=o.originalValue;let s=e;if(o.totalWeight===0&&o.totalAdditiveWeight>0)s.copyFrom(i);else if(o.animations.length===1){if(le.SlerpToRef(i,t.currentValue,Math.min(1,o.totalWeight),s),o.totalAdditiveWeight===0)return s}else if(o.animations.length>1){let r=1,n,a;if(o.totalWeight<1){const h=1-o.totalWeight;n=[],a=[],n.push(i),a.push(h)}else{if(o.animations.length===2&&(le.SlerpToRef(o.animations[0].currentValue,o.animations[1].currentValue,o.animations[1].weight/o.totalWeight,e),o.totalAdditiveWeight===0))return e;n=[],a=[],r=o.totalWeight}for(let h=0;h<o.animations.length;h++){const c=o.animations[h];n.push(c.currentValue),a.push(c.weight/r)}let l=0;for(let h=0;h<n.length;){if(!h){le.SlerpToRef(n[h],n[h+1],a[h+1]/(a[h]+a[h+1]),e),s=e,l=a[h]+a[h+1],h+=2;continue}l+=a[h],le.SlerpToRef(s,n[h],a[h]/l,s),h++}}for(let r=0;r<o.additiveAnimations.length;r++){const n=o.additiveAnimations[r];n.weight!==0&&(s.multiplyToRef(n.currentValue,D.Quaternion[0]),le.SlerpToRef(s,D.Quaternion[0],n.weight,s))}return s};Ve.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let o=0;o<this._registeredForLateAnimationBindings.length;o++){const e=this._registeredForLateAnimationBindings.data[o];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],s=i.animations[0],r=i.originalValue;if(r==null)continue;const n=W.AllowMatrixDecomposeForInterpolation&&r.m;let a=e[t];if(n)a=this._processLateAnimationBindingsForMatrices(i);else if(r.w!==void 0)a=this._processLateAnimationBindingsForQuaternions(i,a||le.Identity());else{let h=0,c=1;const u=s&&s._animationState.loopMode===W.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(i.totalWeight<1)u?a=r.clone?r.clone():r:s&&r.scale?a=r.scale(1-i.totalWeight):s?a=r*(1-i.totalWeight):r.clone?a=r.clone():a=r;else if(s){c=i.totalWeight;const d=s.weight/c;d!==1?s.currentValue.scale?a=s.currentValue.scale(d):a=s.currentValue*d:a=s.currentValue,u&&(a.addToRef?a.addToRef(r,a):a+=r),h=1}for(let d=h;d<i.animations.length;d++){const f=i.animations[d],p=f.weight/c;if(p)f.currentValue.scaleAndAddToRef?f.currentValue.scaleAndAddToRef(p,a):a+=f.currentValue*p;else continue}for(let d=0;d<i.additiveAnimations.length;d++){const f=i.additiveAnimations[d],p=f.weight;if(p)f.currentValue.scaleAndAddToRef?f.currentValue.scaleAndAddToRef(p,a):a+=f.currentValue*p;else continue}}e[t]=a}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};vt.prototype.copyAnimationRange=function(o,e,t,i=!1,s=null){this.animations.length===0&&(this.animations.push(new W(this.name,"_matrix",o.animations[0].framePerSecond,W.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const r=o.animations[0].getRange(e);if(!r)return!1;const n=r.from,a=r.to,l=o.animations[0].getKeys(),h=o.length,c=o.getParent(),u=this.getParent(),d=i&&c&&h&&this.length&&h!==this.length,f=d&&u&&c?u.length/c.length:1,p=i&&!u&&s&&(s.x!==1||s.y!==1||s.z!==1),_=this.animations[0].getKeys();let g,E,R;for(let x=0,S=l.length;x<S;x++)g=l[x],g.frame>=n&&g.frame<=a&&(i?(R=g.value.clone(),d?(E=R.getTranslation(),R.setTranslation(E.scaleInPlace(f))):p&&s?(E=R.getTranslation(),R.setTranslation(E.multiplyInPlace(s))):R=g.value):R=g.value,_.push({frame:g.frame+t,value:R}));return this.animations[0].createRange(e,n+t,a+t),!0};class tr{constructor(){this._easingMode=tr.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case tr.EASINGMODE_EASEIN:return this.easeInCore(e);case tr.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}tr.EASINGMODE_EASEIN=0;tr.EASINGMODE_EASEOUT=1;tr.EASINGMODE_EASEINOUT=2;class zb extends tr{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class Hb extends tr{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class If{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new If(this.frame,this.action,this.onlyOnce)}}class Wb{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class Nr{syncWithMask(){if(!this.mask){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.disabled||this.mask.retainsTarget(t.target.name)?(this._numActiveAnimatables++,t.paused&&t.restart()):t.paused||t.pause()}}removeUnmaskedAnimations(){if(!(!this.mask||this.mask.disabled)){for(let e=0;e<this._animatables.length;++e){const t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){const t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){e=e??this._from,t=t??this._to;const i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(t-e)/i}static MergeAnimationGroups(e,t=!0,i=!1,s){if(e.length===0)return null;s=s??e[0].weight;let r=Number.MAX_VALUE,n=-Number.MAX_VALUE;if(i)for(const l of e)l.from<r&&(r=l.from),l.to>n&&(n=l.to);const a=new Nr(e[0].name+"_merged",e[0]._scene,s);for(const l of e){i&&l.normalize(r,n);for(const h of l.targetedAnimations)a.addTargetedAnimation(h.animation,h.target);t&&l.dispose()}return a}constructor(e,t=null,i=-1,s=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._parentContainer=null,this.onAnimationEndObservable=new j,this.onAnimationLoopObservable=new j,this.onAnimationGroupLoopObservable=new j,this.onAnimationGroupEndObservable=new j,this.onAnimationGroupPauseObservable=new j,this.onAnimationGroupPlayObservable=new j,this.metadata=null,this._animationLoopFlags=[],this._scene=t||Ze.LastCreatedScene,this._weight=i,this._playOrder=s,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){const i=new Wb;i.animation=e,i.target=t;const s=e.getKeys();return this._from>s[0].frame&&(this._from=s[0].frame),this._to<s[s.length-1].frame&&(this._to=s[s.length-1].frame),this._enableBlending!==null&&(e.enableBlending=this._enableBlending),this._blendingSpeed!==null&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const r=this._targetedAnimations[i].animation.getKeys(),n=r[0],a=r[r.length-1];if(n.frame>e){const l={frame:e,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};r.splice(0,0,l)}if(a.frame<t){const l={frame:t,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};r.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,s,r){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){const a=this._targetedAnimations[n],l=this._scene.beginDirectAnimation(a.target,[a.animation],i!==void 0?i:this._from,s!==void 0?s:this._to,e,t,void 0,void 0,r!==void 0?r:this._isAdditive);l.weight=this._weight,l.playOrder=this._playOrder,l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(l)},this._processLoop(l,a,n),this._animatables.push(l)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let i=0;i<e.length;i++)e[i].stop(void 0,void 0,!0);let t=0;for(let i=0;i<this._scene._activeAnimatables.length;i++){const s=this._scene._activeAnimatables[i];s._runtimeAnimations.length>0&&(this._scene._activeAnimatables[t++]=s)}return this._scene._activeAnimatables.length=t,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const s=new Nr(e||this.name,this._scene,this._weight,this._playOrder);s._from=this.from,s._to=this.to,s._speedRatio=this.speedRatio,s._loopAnimation=this.loopAnimation,s._isAdditive=this.isAdditive,s._enableBlending=this.enableBlending,s._blendingSpeed=this.blendingSpeed,s.metadata=this.metadata,s.mask=this.mask;for(const r of this._targetedAnimations)s.addTargetedAnimation(i?r.animation.clone():r.animation,t?t(r.target):r.target);return s}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return ot&&ot.HasTags(this)&&(e.tags=ot.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new Nr(e.name,t,e.weight,e.playOrder);for(let s=0;s<e.targetedAnimations.length;s++){const r=e.targetedAnimations[s],n=W.Parse(r.animation),a=r.targetId;if(r.animation.property==="influence"){const l=t.getMorphTargetById(a);l&&i.addTargetedAnimation(n,l)}else{const l=t.getNodeById(a);l!=null&&i.addTargetedAnimation(n,l)}}return ot&&ot.AddTagsTo(i,e.tags),e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),e.speedRatio!==void 0&&(i._speedRatio=e.speedRatio),e.loopAnimation!==void 0&&(i._loopAnimation=e.loopAnimation),e.isAdditive!==void 0&&(i._isAdditive=e.isAdditive),e.weight!==void 0&&(i._weight=e.weight),e.playOrder!==void 0&&(i._playOrder=e.playOrder),e.enableBlending!==void 0&&(i._enableBlending=e.enableBlending),e.blendingSpeed!==void 0&&(i._blendingSpeed=e.blendingSpeed),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,s=!1,r){let n;typeof t=="object"?n=t:n={referenceFrame:t,range:i,cloneOriginalAnimationGroup:s,clonedAnimationName:r};let a=e;n.cloneOriginalAnimationGroup&&(a=e.clone(n.clonedAnimationGroupName||a.name));const l=a.targetedAnimations;for(let h=0;h<l.length;h++){const c=l[h];c.animation=W.MakeAnimationAdditive(c.animation,n)}if(a.isAdditive=!0,n.clipKeys){let h=Number.MAX_VALUE,c=-Number.MAX_VALUE;const u=a.targetedAnimations;for(let d=0;d<u.length;d++){const _=u[d].animation.getKeys();h>_[0].frame&&(h=_[0].frame),c<_[_.length-1].frame&&(c=_[_.length-1].frame)}a._from=h,a._to=c}return a}static ClipKeys(e,t,i,s,r){const n=e.clone(s||e.name);return Nr.ClipKeysInPlace(n,t,i,r)}static ClipKeysInPlace(e,t,i,s){return Nr.ClipInPlace(e,t,i,s,!1)}static ClipFrames(e,t,i,s,r){const n=e.clone(s||e.name);return Nr.ClipFramesInPlace(n,t,i,r)}static ClipFramesInPlace(e,t,i,s){return Nr.ClipInPlace(e,t,i,s,!0)}static ClipInPlace(e,t,i,s,r=!1){let n=Number.MAX_VALUE,a=-Number.MAX_VALUE;const l=e.targetedAnimations;for(let h=0;h<l.length;h++){const c=l[h],u=s?c.animation:c.animation.clone();r&&(u.createKeyForFrame(t),u.createKeyForFrame(i));const d=u.getKeys(),f=[];let p=Number.MAX_VALUE;for(let _=0;_<d.length;_++){const g=d[_];if(!r&&_>=t&&_<=i||r&&g.frame>=t&&g.frame<=i){const E={frame:g.frame,value:g.value.clone?g.value.clone():g.value,inTangent:g.inTangent,outTangent:g.outTangent,interpolation:g.interpolation,lockedTangent:g.lockedTangent};p===Number.MAX_VALUE&&(p=E.frame),E.frame-=p,f.push(E)}}if(f.length===0){l.splice(h,1),h--;continue}n>f[0].frame&&(n=f[0].frame),a<f[f.length-1].frame&&(a=f[f.length-1].frame),u.setKeys(f,!0),c.animation=u}return e._from=n,e._to=a,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}var gg;(function(o){o[o.Include=0]="Include",o[o.Exclude=1]="Exclude"})(gg||(gg={}));function yd(o,e,t){try{const i=o.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function Xb(o=25){let e;return(t,i,s)=>{const r=performance.now();e===void 0||r-e>o?(e=r,setTimeout(()=>{yd(t,i,s)},0)):yd(t,i,s)}}function zm(o,e,t,i,s){const r=()=>{let n;const a=l=>{l.done?t(l.value):n===void 0?n=!0:r()};do n=void 0,!s||!s.aborted?e(o,a,i):i(new Error("Aborted")),n===void 0&&(n=!1);while(n)};r()}function Pf(o,e){let t;return zm(o,yd,i=>t=i,i=>{throw i},e),t}function Yb(o,e,t){return new Promise((i,s)=>{zm(o,e,i,s,t)})}function Kb(o,e){return(...t)=>Pf(o(...t),e)}class Cd{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class wr{constructor(e,t,i){this.vectors=yi.BuildArray(8,m.Zero),this.center=m.Zero(),this.centerWorld=m.Zero(),this.extendSize=m.Zero(),this.extendSizeWorld=m.Zero(),this.directions=yi.BuildArray(3,m.Zero),this.vectorsWorld=yi.BuildArray(8,m.Zero),this.minimumWorld=m.Zero(),this.maximumWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const s=e.x,r=e.y,n=e.z,a=t.x,l=t.y,h=t.z,c=this.vectors;this.minimum.copyFromFloats(s,r,n),this.maximum.copyFromFloats(a,l,h),c[0].copyFromFloats(s,r,n),c[1].copyFromFloats(a,l,h),c[2].copyFromFloats(a,r,n),c[3].copyFromFloats(s,l,n),c[4].copyFromFloats(s,r,h),c[5].copyFromFloats(a,l,n),c[6].copyFromFloats(s,l,h),c[7].copyFromFloats(a,r,h),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||L.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=wr._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);const r=s*e,n=i.scaleInPlace(r*.5),a=this.center.subtractToRef(n,t[1]),l=this.center.addToRef(n,t[2]);return this.reConstruct(a,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,s=this.directions,r=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let a=0;a<8;++a)r[a].copyFrom(n[a]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let a=0;a<8;++a){const l=r[a];m.TransformCoordinatesToRef(n[a],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}m.FromArrayToRef(e.m,0,s[0]),m.FromArrayToRef(e.m,4,s[1]),m.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e}isInFrustum(e){return wr.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return wr.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,s=t.x,r=t.y,n=t.z,a=i.x,l=i.y,h=i.z,c=e.x,u=e.y,d=e.z,f=-dt;return!(a-c<f||f>c-s||l-u<f||f>u-r||h-d<f||f>d-n)}intersectsSphere(e){return wr.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,s=this.maximumWorld,r=i.x,n=i.y,a=i.z,l=s.x,h=s.y,c=s.z,u=e.x,d=e.y,f=e.z,p=t.x,_=t.y,g=t.z;return!(l<u||r>p||h<d||n>_||c<f||a>g)}dispose(){var e,t;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(t=this._drawWrapperBack)===null||t===void 0||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){const r=wr._TmpVector3[0];return m.ClampToRef(i,e,t,r),m.DistanceSquared(i,r)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const s=t[i];for(let r=0;r<8;++r)if(s.dotCoordinate(e[r])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=!0;const r=t[i];for(let n=0;n<8;++n)if(r.dotCoordinate(e[n])>=0){s=!1;break}if(s)return!1}return!0}}wr._TmpVector3=yi.BuildArray(3,m.Zero);class ta{constructor(e,t,i){this.center=m.Zero(),this.centerWorld=m.Zero(),this.minimum=m.Zero(),this.maximum=m.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const s=m.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=s*.5,this._update(i||L.IdentityReadOnly)}scale(e){const t=this.radius*e,i=ta._TmpVector3,s=i[0].setAll(t),r=this.center.subtractToRef(s,i[1]),n=this.center.addToRef(s,i[2]);return this.reConstruct(r,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{m.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=ta._TmpVector3[0];m.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=m.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=m.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const s=new ta(this._TmpVector3[0],this._TmpVector3[2]);return i?s._worldMatrix=i:s._worldMatrix=L.Identity(),s}}ta._TmpVector3=yi.BuildArray(3,m.Zero);const td={min:0,max:0},id={min:0,max:0},mg=(o,e,t)=>{const i=m.Dot(e.centerWorld,o),s=Math.abs(m.Dot(e.directions[0],o))*e.extendSize.x,r=Math.abs(m.Dot(e.directions[1],o))*e.extendSize.y,n=Math.abs(m.Dot(e.directions[2],o))*e.extendSize.z,a=s+r+n;t.min=i-a,t.max=i+a},rs=(o,e,t)=>(mg(o,e,td),mg(o,t,id),!(td.min>id.max||id.min>td.max));class hs{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new wr(e,t,i),this.boundingSphere=new ta(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=hs._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=hs._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=m.Minimize(this.minimum,e),i=m.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){const t=D.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);const i=D.Vector3[0];return m.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),m.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,hs._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!ta.Intersects(this.boundingSphere,e.boundingSphere)||!wr.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,s=e.boundingBox;return!(!rs(i.directions[0],i,s)||!rs(i.directions[1],i,s)||!rs(i.directions[2],i,s)||!rs(s.directions[0],i,s)||!rs(s.directions[1],i,s)||!rs(s.directions[2],i,s)||!rs(m.Cross(i.directions[0],s.directions[0]),i,s)||!rs(m.Cross(i.directions[0],s.directions[1]),i,s)||!rs(m.Cross(i.directions[0],s.directions[2]),i,s)||!rs(m.Cross(i.directions[1],s.directions[0]),i,s)||!rs(m.Cross(i.directions[1],s.directions[1]),i,s)||!rs(m.Cross(i.directions[1],s.directions[2]),i,s)||!rs(m.Cross(i.directions[2],s.directions[0]),i,s)||!rs(m.Cross(i.directions[2],s.directions[1]),i,s)||!rs(m.Cross(i.directions[2],s.directions[2]),i,s))}}hs._TmpVector3=yi.BuildArray(2,m.Zero);class jc{static extractMinAndMaxIndexed(e,t,i,s,r,n){for(let a=i;a<i+s;a++){const l=t[a]*3,h=e[l],c=e[l+1],u=e[l+2];r.minimizeInPlaceFromFloats(h,c,u),n.maximizeInPlaceFromFloats(h,c,u)}}static extractMinAndMax(e,t,i,s,r,n){for(let a=t,l=t*s;a<t+i;a++,l+=s){const h=e[l],c=e[l+1],u=e[l+2];r.minimizeInPlaceFromFloats(h,c,u),n.maximizeInPlaceFromFloats(h,c,u)}}}v([vn.filter((...[o,e])=>!Array.isArray(o)&&!Array.isArray(e))],jc,"extractMinAndMaxIndexed",null);v([vn.filter((...[o])=>!Array.isArray(o))],jc,"extractMinAndMax",null);function $b(o,e,t,i,s=null){const r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return jc.extractMinAndMaxIndexed(o,e,t,i,r,n),s&&(r.x-=r.x*s.x+s.y,r.y-=r.y*s.x+s.y,r.z-=r.z*s.x+s.y,n.x+=n.x*s.x+s.y,n.y+=n.y*s.x+s.y,n.z+=n.z*s.x+s.y),{minimum:r,maximum:n}}function Hm(o,e,t,i=null,s){const r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return s||(s=3),jc.extractMinAndMax(o,e,t,s,r,n),i&&(r.x-=r.x*i.x+i.y,r.y-=r.y*i.x+i.y,r.z-=r.z*i.x+i.y,n.x+=n.x*i.x+i.y,n.y+=n.y*i.x+i.y,n.z+=n.z*i.x+i.y),{minimum:r,maximum:n}}class Ps{get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines}set materialDefines(e){var t;const i=(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0);i.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new _r(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&((i=this._drawWrappers[e])===null||i===void 0||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(t=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&t!==void 0?t:null}get _drawWrapper(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,s=!0){const r=this._drawWrapper;r.setEffect(e,t,s),i!==void 0&&(r.materialContext=i),e||(r.defines=null,r.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(const t of this._drawWrappers)t==null||t.dispose();this._drawWrappers=[]}static AddToMesh(e,t,i,s,r,n,a,l=!0){return new Ps(e,t,i,s,r,n,a,l)}constructor(e,t,i,s,r,n,a,l=!0,h=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=s,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=a||n,h&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,l&&(this.refreshBoundingInfo(),n.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){var t;const i=(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&t!==void 0?t:this._renderingMesh.material;if(i){if(this._isMultiMaterial(i)){const s=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==s&&(this._currentMaterial=s,this.resetDrawCache()),s}}else return e?this._mesh.getScene().defaultMaterial:null;return i}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(T.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(this.indexStart===0&&this.indexCount===t.length){const s=this._renderingMesh.getBoundingInfo();i={minimum:s.minimum.clone(),maximum:s.maximum.clone()}}else i=$b(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new hs(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let s=this.indexStart;s<this.indexStart+this.indexCount;s+=3)i.push(e[s],e[s+1],e[s+1],e[s+2],e[s+2],e[s]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,s,r){const n=this.getMaterial();if(!n)return null;let a=3,l=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return null;case 7:a=1,l=!0;break}return n.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,s,r):this._intersectTriangles(e,t,i,a,l,s,r)}_intersectLines(e,t,i,s,r){let n=null;for(let a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){const l=t[i[a]],h=t[i[a+1]],c=e.intersectionSegment(l,h,s);if(!(c<0)&&(r||!n||c<n.distance)&&(n=new Cd(null,null,c),n.faceId=a/2,r))break}return n}_intersectUnIndexedLines(e,t,i,s,r){let n=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=2){const l=t[a],h=t[a+1],c=e.intersectionSegment(l,h,s);if(!(c<0)&&(r||!n||c<n.distance)&&(n=new Cd(null,null,c),n.faceId=a/2,r))break}return n}_intersectTriangles(e,t,i,s,r,n,a){let l=null,h=-1;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-s);c+=s){h++;const u=i[c],d=i[c+1],f=i[c+2];if(r&&f===4294967295){c+=2;continue}const p=t[u],_=t[d],g=t[f];if(!p||!_||!g||a&&!a(p,_,g,e,u,d,f))continue;const E=e.intersectsTriangle(p,_,g);if(E){if(E.distance<0)continue;if((n||!l||E.distance<l.distance)&&(l=E,l.faceId=h,n))break}}return l}_intersectUnIndexedTriangles(e,t,i,s,r){let n=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){const l=t[a],h=t[a+1],c=t[a+2];if(r&&!r(l,h,c,e,-1,-1,-1))continue;const u=e.intersectsTriangle(l,h,c);if(u){if(u.distance<0)continue;if((s||!n||u.distance<n.distance)&&(n=u,n.faceId=a/3,s))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new Ps(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const s=this.getBoundingInfo();if(!s)return i;i._boundingInfo=new hs(s.minimum,s.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,s,r,n=!0){let a=Number.MAX_VALUE,l=-Number.MAX_VALUE;const c=(r||s).getIndices();for(let u=t;u<t+i;u++){const d=c[u];d<a&&(a=d),d>l&&(l=d)}return new Ps(e,a,l-a+1,t,i,s,r,n)}}class sd{}class fe{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=Kb(this._applyToCoroutine.bind(this)),this.uniqueId=fe._UniqueIDGenerator,fe._UniqueIDGenerator++}set(e,t){switch(e.length||q.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case T.PositionKind:this.positions=e;break;case T.NormalKind:this.normals=e;break;case T.TangentKind:this.tangents=e;break;case T.UVKind:this.uvs=e;break;case T.UV2Kind:this.uvs2=e;break;case T.UV3Kind:this.uvs3=e;break;case T.UV4Kind:this.uvs4=e;break;case T.UV5Kind:this.uvs5=e;break;case T.UV6Kind:this.uvs6=e;break;case T.ColorKind:this.colors=e;break;case T.MatricesIndicesKind:this.matricesIndices=e;break;case T.MatricesWeightsKind:this.matricesWeights=e;break;case T.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case T.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(T.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(T.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(T.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(T.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(T.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(T.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(T.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(T.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(T.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(T.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(T.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(T.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(T.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(T.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){const s=e;s.subMeshes=[];for(const r of this.materialInfos)new Ps(r.materialIndex,r.verticesStart,r.verticesCount,r.indexStart,r.indexCount,s)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(T.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(T.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(T.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(T.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(T.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(T.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(T.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(T.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(T.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(T.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(T.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(T.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(T.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(T.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,s=e.length){const r=D.Vector3[0],n=D.Vector3[1];for(let a=i;a<i+s;a+=3)m.FromArrayToRef(e,a,r),m.TransformCoordinatesToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z}static _TransformVector3Normals(e,t,i=0,s=e.length){const r=D.Vector3[0],n=D.Vector3[1];for(let a=i;a<i+s;a+=3)m.FromArrayToRef(e,a,r),m.TransformNormalToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z}static _TransformVector4Normals(e,t,i=0,s=e.length){const r=D.Vector4[0],n=D.Vector4[1];for(let a=i;a<i+s;a+=4)ut.FromArrayToRef(e,a,r),ut.TransformNormalToRef(r,t,n),e[a]=n.x,e[a+1]=n.y,e[a+2]=n.z,e[a+3]=n.w}static _FlipFaces(e,t=0,i=e.length){for(let s=t;s<t+i;s+=3){const r=e[s+1];e[s+1]=e[s+2],e[s+2]=r}}transform(e){const t=e.determinant()<0;return this.positions&&fe._TransformVector3Coordinates(this.positions,e),this.normals&&fe._TransformVector3Normals(this.normals,e),this.tangents&&fe._TransformVector4Normals(this.tangents,e),t&&this.indices&&fe._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];const e=[];for(const t of this.materialInfos){const i=new fe;if(this.positions&&(i.positions=this.positions.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.indices){i.indices=[];for(let r=t.indexStart;r<t.indexStart+t.indexCount;r++)i.indices.push(this.indices[r]-t.verticesStart)}const s=new sd;s.indexStart=0,s.indexCount=i.indices?i.indices.length:0,s.materialIndex=t.materialIndex,s.verticesStart=0,s.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[s],e.push(i)}return e}merge(e,t=!1,i=!1,s=!1,r=!1){const n=Array.isArray(e)?e.map(a=>({vertexData:a})):[{vertexData:e}];return Pf(this._mergeCoroutine(void 0,n,t,!1,i,s,r))}*_mergeCoroutine(e,t,i=!1,s,r,n=!1,a=!1){var l,h,c,u;this._validate();let d=t.map(E=>E.vertexData),f=this;if(a)for(const E of d)E&&(E._validate(),!this.normals&&E.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&E.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&E.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&E.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&E.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&E.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&E.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&E.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&E.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&E.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&E.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&E.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&E.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(const E of d)if(E){if(a)this.normals&&!E.normals&&(E.normals=new Float32Array(E.positions.length)),this.tangents&&!E.tangents&&(E.tangents=new Float32Array(E.positions.length/3*4)),this.uvs&&!E.uvs&&(E.uvs=new Float32Array(E.positions.length/3*2)),this.uvs2&&!E.uvs2&&(E.uvs2=new Float32Array(E.positions.length/3*2)),this.uvs3&&!E.uvs3&&(E.uvs3=new Float32Array(E.positions.length/3*2)),this.uvs4&&!E.uvs4&&(E.uvs4=new Float32Array(E.positions.length/3*2)),this.uvs5&&!E.uvs5&&(E.uvs5=new Float32Array(E.positions.length/3*2)),this.uvs6&&!E.uvs6&&(E.uvs6=new Float32Array(E.positions.length/3*2)),this.colors&&!E.colors&&(E.colors=new Float32Array(E.positions.length/3*4),E.colors.fill(1)),this.matricesIndices&&!E.matricesIndices&&(E.matricesIndices=new Float32Array(E.positions.length/3*4)),this.matricesWeights&&!E.matricesWeights&&(E.matricesWeights=new Float32Array(E.positions.length/3*4)),this.matricesIndicesExtra&&!E.matricesIndicesExtra&&(E.matricesIndicesExtra=new Float32Array(E.positions.length/3*4)),this.matricesWeightsExtra&&!E.matricesWeightsExtra&&(E.matricesWeightsExtra=new Float32Array(E.positions.length/3*4));else if(E._validate(),!this.normals!=!E.normals||!this.tangents!=!E.tangents||!this.uvs!=!E.uvs||!this.uvs2!=!E.uvs2||!this.uvs3!=!E.uvs3||!this.uvs4!=!E.uvs4||!this.uvs5!=!E.uvs5||!this.uvs6!=!E.uvs6||!this.colors!=!E.colors||!this.matricesIndices!=!E.matricesIndices||!this.matricesWeights!=!E.matricesWeights||!this.matricesIndicesExtra!=!E.matricesIndicesExtra||!this.matricesWeightsExtra!=!E.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(n){let E=0,R=0,x=0;const S=[];let b=null;const y=[];for(const O of this.splitBasedOnMaterialID())y.push({vertexData:O,transform:e});for(const O of t)if(O.vertexData)for(const N of O.vertexData.splitBasedOnMaterialID())y.push({vertexData:N,transform:O.transform});y.sort((O,N)=>{const w=O.vertexData.materialInfos?O.vertexData.materialInfos[0].materialIndex:0,G=N.vertexData.materialInfos?N.vertexData.materialInfos[0].materialIndex:0;return w>G?1:w===G?0:-1});for(const O of y){const N=O.vertexData;if(N.materialInfos?E=N.materialInfos[0].materialIndex:E=0,b&&b.materialIndex===E)b.indexCount+=N.indices.length,b.verticesCount+=N.positions.length/3;else{const w=new sd;w.materialIndex=E,w.indexStart=R,w.indexCount=N.indices.length,w.verticesStart=x,w.verticesCount=N.positions.length/3,S.push(w),b=w}R+=N.indices.length,x+=N.positions.length/3}const I=y.splice(0,1)[0];f=I.vertexData,e=I.transform,d=y.map(O=>O.vertexData),t=y,this.materialInfos=S}const p=d.reduce((E,R)=>{var x,S;return E+((S=(x=R.indices)===null||x===void 0?void 0:x.length)!==null&&S!==void 0?S:0)},(h=(l=f.indices)===null||l===void 0?void 0:l.length)!==null&&h!==void 0?h:0);let g=r||d.some(E=>E.indices===f.indices)?(c=f.indices)===null||c===void 0?void 0:c.slice():f.indices;if(p>0){let E=(u=g==null?void 0:g.length)!==null&&u!==void 0?u:0;if(g||(g=new Array(p)),g.length!==p){if(Array.isArray(g))g.length=p;else{const x=i||g instanceof Uint32Array?new Uint32Array(p):new Uint16Array(p);x.set(g),g=x}e&&e.determinant()<0&&fe._FlipFaces(g,0,E)}let R=f.positions?f.positions.length/3:0;for(const{vertexData:x,transform:S}of t)if(x.indices){for(let b=0;b<x.indices.length;b++)g[E+b]=x.indices[b]+R;S&&S.determinant()<0&&fe._FlipFaces(g,E,x.indices.length),R+=x.positions.length/3,E+=x.indices.length,s&&(yield)}}return this.indices=g,this.positions=fe._MergeElement(T.PositionKind,f.positions,e,t.map(E=>[E.vertexData.positions,E.transform])),s&&(yield),f.normals&&(this.normals=fe._MergeElement(T.NormalKind,f.normals,e,t.map(E=>[E.vertexData.normals,E.transform])),s&&(yield)),f.tangents&&(this.tangents=fe._MergeElement(T.TangentKind,f.tangents,e,t.map(E=>[E.vertexData.tangents,E.transform])),s&&(yield)),f.uvs&&(this.uvs=fe._MergeElement(T.UVKind,f.uvs,e,t.map(E=>[E.vertexData.uvs,E.transform])),s&&(yield)),f.uvs2&&(this.uvs2=fe._MergeElement(T.UV2Kind,f.uvs2,e,t.map(E=>[E.vertexData.uvs2,E.transform])),s&&(yield)),f.uvs3&&(this.uvs3=fe._MergeElement(T.UV3Kind,f.uvs3,e,t.map(E=>[E.vertexData.uvs3,E.transform])),s&&(yield)),f.uvs4&&(this.uvs4=fe._MergeElement(T.UV4Kind,f.uvs4,e,t.map(E=>[E.vertexData.uvs4,E.transform])),s&&(yield)),f.uvs5&&(this.uvs5=fe._MergeElement(T.UV5Kind,f.uvs5,e,t.map(E=>[E.vertexData.uvs5,E.transform])),s&&(yield)),f.uvs6&&(this.uvs6=fe._MergeElement(T.UV6Kind,f.uvs6,e,t.map(E=>[E.vertexData.uvs6,E.transform])),s&&(yield)),f.colors&&(this.colors=fe._MergeElement(T.ColorKind,f.colors,e,t.map(E=>[E.vertexData.colors,E.transform])),s&&(yield)),f.matricesIndices&&(this.matricesIndices=fe._MergeElement(T.MatricesIndicesKind,f.matricesIndices,e,t.map(E=>[E.vertexData.matricesIndices,E.transform])),s&&(yield)),f.matricesWeights&&(this.matricesWeights=fe._MergeElement(T.MatricesWeightsKind,f.matricesWeights,e,t.map(E=>[E.vertexData.matricesWeights,E.transform])),s&&(yield)),f.matricesIndicesExtra&&(this.matricesIndicesExtra=fe._MergeElement(T.MatricesIndicesExtraKind,f.matricesIndicesExtra,e,t.map(E=>[E.vertexData.matricesIndicesExtra,E.transform])),s&&(yield)),f.matricesWeightsExtra&&(this.matricesWeightsExtra=fe._MergeElement(T.MatricesWeightsExtraKind,f.matricesWeightsExtra,e,t.map(E=>[E.vertexData.matricesWeightsExtra,E.transform]))),this}static _MergeElement(e,t,i,s){const r=s.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&r.length==0)return t;if(!t)return this._MergeElement(e,r[0][0],r[0][1],r.slice(1));const n=r.reduce((l,h)=>l+h[0].length,t.length),a=e===T.PositionKind?fe._TransformVector3Coordinates:e===T.NormalKind?fe._TransformVector3Normals:e===T.TangentKind?fe._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(n);l.set(t),i&&a(l,i,0,t.length);let h=t.length;for(const[c,u]of r)l.set(c,h),u&&a(l,u,h,c.length),h+=c.length;return l}else{const l=new Array(n);for(let c=0;c<t.length;c++)l[c]=t[c];i&&a(l,i,0,t.length);let h=t.length;for(const[c,u]of r){for(let d=0;d<c.length;d++)l[h+d]=c[d];u&&a(l,u,h,c.length),h+=c.length}return l}}_validate(){if(!this.positions)throw new fr("Positions are required",pn.MeshInvalidPositionsError);const e=(s,r)=>{const n=T.DeduceStride(s);if(r.length%n!==0)throw new Error("The "+s+"s array count must be a multiple of "+n);return r.length/n},t=e(T.PositionKind,this.positions),i=(s,r)=>{const n=e(s,r);if(n!==t)throw new Error("The "+s+"s element count ("+n+") does not match the positions count ("+t+")")};this.normals&&i(T.NormalKind,this.normals),this.tangents&&i(T.TangentKind,this.tangents),this.uvs&&i(T.UVKind,this.uvs),this.uvs2&&i(T.UV2Kind,this.uvs2),this.uvs3&&i(T.UV3Kind,this.uvs3),this.uvs4&&i(T.UV4Kind,this.uvs4),this.uvs5&&i(T.UV5Kind,this.uvs5),this.uvs6&&i(T.UV6Kind,this.uvs6),this.colors&&i(T.ColorKind,this.colors),this.matricesIndices&&i(T.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(T.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(T.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(T.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){const e=this.serialize();return fe.Parse(e)}serialize(){const e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors)),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=Array.from(this.indices),this.materialInfos){e.materialInfos=[];for(const t of this.materialInfos){const i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return fe._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return fe._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const s=new fe;return e.isVerticesDataPresent(T.PositionKind)&&(s.positions=e.getVerticesData(T.PositionKind,t,i)),e.isVerticesDataPresent(T.NormalKind)&&(s.normals=e.getVerticesData(T.NormalKind,t,i)),e.isVerticesDataPresent(T.TangentKind)&&(s.tangents=e.getVerticesData(T.TangentKind,t,i)),e.isVerticesDataPresent(T.UVKind)&&(s.uvs=e.getVerticesData(T.UVKind,t,i)),e.isVerticesDataPresent(T.UV2Kind)&&(s.uvs2=e.getVerticesData(T.UV2Kind,t,i)),e.isVerticesDataPresent(T.UV3Kind)&&(s.uvs3=e.getVerticesData(T.UV3Kind,t,i)),e.isVerticesDataPresent(T.UV4Kind)&&(s.uvs4=e.getVerticesData(T.UV4Kind,t,i)),e.isVerticesDataPresent(T.UV5Kind)&&(s.uvs5=e.getVerticesData(T.UV5Kind,t,i)),e.isVerticesDataPresent(T.UV6Kind)&&(s.uvs6=e.getVerticesData(T.UV6Kind,t,i)),e.isVerticesDataPresent(T.ColorKind)&&(s.colors=e.getVerticesData(T.ColorKind,t,i)),e.isVerticesDataPresent(T.MatricesIndicesKind)&&(s.matricesIndices=e.getVerticesData(T.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(T.MatricesWeightsKind)&&(s.matricesWeights=e.getVerticesData(T.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(T.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=e.getVerticesData(T.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(T.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=e.getVerticesData(T.MatricesWeightsExtraKind,t,i)),s.indices=e.getIndices(t,i),s}static CreateRibbon(e){throw ke("ribbonBuilder")}static CreateBox(e){throw ke("boxBuilder")}static CreateTiledBox(e){throw ke("tiledBoxBuilder")}static CreateTiledPlane(e){throw ke("tiledPlaneBuilder")}static CreateSphere(e){throw ke("sphereBuilder")}static CreateCylinder(e){throw ke("cylinderBuilder")}static CreateTorus(e){throw ke("torusBuilder")}static CreateLineSystem(e){throw ke("linesBuilder")}static CreateDashedLines(e){throw ke("linesBuilder")}static CreateGround(e){throw ke("groundBuilder")}static CreateTiledGround(e){throw ke("groundBuilder")}static CreateGroundFromHeightMap(e){throw ke("groundBuilder")}static CreatePlane(e){throw ke("planeBuilder")}static CreateDisc(e){throw ke("discBuilder")}static CreatePolygon(e,t,i,s,r,n,a){throw ke("polygonBuilder")}static CreateIcoSphere(e){throw ke("icoSphereBuilder")}static CreatePolyhedron(e){throw ke("polyhedronBuilder")}static CreateCapsule(e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw ke("capsuleBuilder")}static CreateTorusKnot(e){throw ke("torusKnotBuilder")}static ComputeNormals(e,t,i,s){let r=0,n=0,a=0,l=0,h=0,c=0,u=0,d=0,f=0,p=0,_=0,g=0,E=0,R=0,x=0,S=0,b=0,y=0,I=0,O=0,N=!1,w=!1,G=!1,k=!1,de=1,ae=0,_e=null;s&&(N=!!s.facetNormals,w=!!s.facetPositions,G=!!s.facetPartitioning,de=s.useRightHandedSystem===!0?-1:1,ae=s.ratio||0,k=!!s.depthSort,_e=s.distanceTo,k&&_e===void 0&&(_e=m.Zero()));let Ce=0,ce=0,ze=0,We=0;for(G&&s&&s.bbSize&&(Ce=s.subDiv.X*ae/s.bbSize.x,ce=s.subDiv.Y*ae/s.bbSize.y,ze=s.subDiv.Z*ae/s.bbSize.z,We=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),r=0;r<e.length;r++)i[r]=0;const nt=t.length/3|0;for(r=0;r<nt;r++){if(g=t[r*3]*3,E=g+1,R=g+2,x=t[r*3+1]*3,S=x+1,b=x+2,y=t[r*3+2]*3,I=y+1,O=y+2,n=e[g]-e[x],a=e[E]-e[S],l=e[R]-e[b],h=e[y]-e[x],c=e[I]-e[S],u=e[O]-e[b],d=de*(a*u-l*c),f=de*(l*h-n*u),p=de*(n*c-a*h),_=Math.sqrt(d*d+f*f+p*p),_=_===0?1:_,d/=_,f/=_,p/=_,N&&s&&(s.facetNormals[r].x=d,s.facetNormals[r].y=f,s.facetNormals[r].z=p),w&&s&&(s.facetPositions[r].x=(e[g]+e[x]+e[y])/3,s.facetPositions[r].y=(e[E]+e[S]+e[I])/3,s.facetPositions[r].z=(e[R]+e[b]+e[O])/3),G&&s){const ne=Math.floor((s.facetPositions[r].x-s.bInfo.minimum.x*ae)*Ce),Ue=Math.floor((s.facetPositions[r].y-s.bInfo.minimum.y*ae)*ce),Je=Math.floor((s.facetPositions[r].z-s.bInfo.minimum.z*ae)*ze),St=Math.floor((e[g]-s.bInfo.minimum.x*ae)*Ce),yt=Math.floor((e[E]-s.bInfo.minimum.y*ae)*ce),tt=Math.floor((e[R]-s.bInfo.minimum.z*ae)*ze),he=Math.floor((e[x]-s.bInfo.minimum.x*ae)*Ce),Ne=Math.floor((e[S]-s.bInfo.minimum.y*ae)*ce),Qe=Math.floor((e[b]-s.bInfo.minimum.z*ae)*ze),Me=Math.floor((e[y]-s.bInfo.minimum.x*ae)*Ce),at=Math.floor((e[I]-s.bInfo.minimum.y*ae)*ce),zt=Math.floor((e[O]-s.bInfo.minimum.z*ae)*ze),Ht=St+s.subDiv.max*yt+We*tt,ti=he+s.subDiv.max*Ne+We*Qe,Ci=Me+s.subDiv.max*at+We*zt,ui=ne+s.subDiv.max*Ue+We*Je;s.facetPartitioning[ui]=s.facetPartitioning[ui]?s.facetPartitioning[ui]:new Array,s.facetPartitioning[Ht]=s.facetPartitioning[Ht]?s.facetPartitioning[Ht]:new Array,s.facetPartitioning[ti]=s.facetPartitioning[ti]?s.facetPartitioning[ti]:new Array,s.facetPartitioning[Ci]=s.facetPartitioning[Ci]?s.facetPartitioning[Ci]:new Array,s.facetPartitioning[Ht].push(r),ti!=Ht&&s.facetPartitioning[ti].push(r),Ci==ti||Ci==Ht||s.facetPartitioning[Ci].push(r),ui==Ht||ui==ti||ui==Ci||s.facetPartitioning[ui].push(r)}if(k&&s&&s.facetPositions){const ne=s.depthSortedFacets[r];ne.ind=r*3,ne.sqDistance=m.DistanceSquared(s.facetPositions[r],_e)}i[g]+=d,i[E]+=f,i[R]+=p,i[x]+=d,i[S]+=f,i[b]+=p,i[y]+=d,i[I]+=f,i[O]+=p}for(r=0;r<i.length/3;r++)d=i[r*3],f=i[r*3+1],p=i[r*3+2],_=Math.sqrt(d*d+f*f+p*p),_=_===0?1:_,d/=_,f/=_,p/=_,i[r*3]=d,i[r*3+1]=f,i[r*3+2]=p}static _ComputeSides(e,t,i,s,r,n,a){const l=i.length,h=s.length;let c,u;switch(e=e||fe.DEFAULTSIDE,e){case fe.FRONTSIDE:break;case fe.BACKSIDE:for(c=0;c<l;c+=3){const d=i[c];i[c]=i[c+2],i[c+2]=d}for(u=0;u<h;u++)s[u]=-s[u];break;case fe.DOUBLESIDE:{const d=t.length,f=d/3;for(let g=0;g<d;g++)t[d+g]=t[g];for(c=0;c<l;c+=3)i[c+l]=i[c+2]+f,i[c+1+l]=i[c+1]+f,i[c+2+l]=i[c]+f;for(u=0;u<h;u++)s[h+u]=-s[u];const p=r.length;let _=0;for(_=0;_<p;_++)r[_+p]=r[_];for(n=n||new ut(0,0,1,1),a=a||new ut(0,0,1,1),_=0,c=0;c<p/2;c++)r[_]=n.x+(n.z-n.x)*r[_],r[_+1]=n.y+(n.w-n.y)*r[_+1],r[_+p]=a.x+(a.z-a.x)*r[_+p],r[_+p+1]=a.y+(a.w-a.y)*r[_+p+1],_+=2;break}}}static Parse(e){const t=new fe,i=e.positions;i&&t.set(i,T.PositionKind);const s=e.normals;s&&t.set(s,T.NormalKind);const r=e.tangents;r&&t.set(r,T.TangentKind);const n=e.uvs;n&&t.set(n,T.UVKind);const a=e.uvs2;a&&t.set(a,T.UV2Kind);const l=e.uvs3;l&&t.set(l,T.UV3Kind);const h=e.uvs4;h&&t.set(h,T.UV4Kind);const c=e.uvs5;c&&t.set(c,T.UV5Kind);const u=e.uvs6;u&&t.set(u,T.UV6Kind);const d=e.colors;d&&t.set(He.CheckColors4(d,i.length/3),T.ColorKind);const f=e.matricesIndices;f&&t.set(f,T.MatricesIndicesKind);const p=e.matricesWeights;p&&t.set(p,T.MatricesWeightsKind);const _=e.indices;_&&(t.indices=_);const g=e.materialInfos;if(g){t.materialInfos=[];for(const E of g){const R=new sd;R.indexCount=E.indexCount,R.indexStart=E.indexStart,R.verticesCount=E.verticesCount,R.verticesStart=E.verticesStart,R.materialIndex=E.materialIndex,t.materialInfos.push(R)}}return t}static ImportVertexData(e,t){const i=fe.Parse(e);t.setAllVerticesData(i,e.updatable)}}fe.FRONTSIDE=0;fe.BACKSIDE=1;fe.DOUBLESIDE=2;fe.DEFAULTSIDE=0;fe._UniqueIDGenerator=0;v([vn.filter((...[o])=>!Array.isArray(o))],fe,"_TransformVector3Coordinates",null);v([vn.filter((...[o])=>!Array.isArray(o))],fe,"_TransformVector3Normals",null);v([vn.filter((...[o])=>!Array.isArray(o))],fe,"_TransformVector4Normals",null);v([vn.filter((...[o])=>!Array.isArray(o))],fe,"_FlipFaces",null);const jb=L.Compose(m.One(),le.FromEulerAngles(0,Math.PI,0),m.Zero());class we extends Jt{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&we.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==we.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t),this._forward=new m(0,0,1),this._up=new m(0,1,0),this._right=new m(1,0,0),this._position=m.Zero(),this._rotation=m.Zero(),this._rotationQuaternion=null,this._scaling=m.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=we.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=L.Zero(),this._usePivotMatrix=!1,this._absolutePosition=m.Zero(),this._absoluteScaling=m.Zero(),this._absoluteRotationQuaternion=le.Identity(),this._pivotMatrix=L.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new j,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return m.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return m.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return m.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=L.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==we.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=L.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);s&&i&&i(this,s);for(const r of this.getChildTransformNodes(!0))r.instantiateHierarchy(s,t,i);return s}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||le.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,s;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],s=arguments[2]}else t=e.x,i=e.y,s=e.z;if(this.parent){const r=D.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),m.TransformCoordinatesFromFloatsToRef(t,i,s,r,this.position)}else this.position.x=t,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=m.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=D.Matrix[0];return this._localMatrix.invertToRef(e),m.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=m.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,s=0,r=ft.LOCAL){const n=we._LookAtVectorCache,a=r===ft.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(a,n),this.setDirection(n,t,i,s),r===ft.WORLD&&this.parent)if(this.rotationQuaternion){const l=D.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const h=D.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(h),h.invert(),l.multiplyToRef(h,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=D.Quaternion[0];le.FromEulerVectorToRef(this.rotation,l);const h=D.Matrix[0];l.toRotationMatrix(h);const c=D.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),h.multiplyToRef(c,h),l.fromRotationMatrix(h),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=m.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return m.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,s=0){const r=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),a=-Math.atan2(e.y,n);return this.rotationQuaternion?le.RotationYawPitchRollToRef(r+t,a+i,s,this.rotationQuaternion):(this.rotation.x=a+i,this.rotation.y=r+t,this.rotation.z=s),this}setPivotPoint(e,t=ft.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==ft.WORLD){const s=D.Matrix[0];i.invertToRef(s),e=m.TransformCoordinates(e,s)}return this.setPivotMatrix(L.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=m.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=m.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),m.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const s=D.Quaternion[0],r=D.Vector3[0],n=D.Vector3[1],a=D.Matrix[1];L.IdentityToRef(a);const l=D.Matrix[0];this.computeWorldMatrix(!0);let h=this.rotationQuaternion;return h||(h=we._TmpRotation,le.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,h)),L.ComposeToRef(this.scaling,h,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(a),l.multiplyToRef(a,l)),l.decompose(n,s,r,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(r),this.parent=e,i&&this.setPivotMatrix(L.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let s;if(!i||i===ft.LOCAL)s=le.RotationAxisToRef(e,t,we._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);else{if(this.parent){const r=this.parent.getWorldMatrix(),n=D.Matrix[0];r.invertToRef(n),e=m.TransformNormal(e,n),r.determinant()<0&&(t*=-1)}s=le.RotationAxisToRef(e,t,we._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=le.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=D.Vector3[0],r=D.Vector3[1],n=D.Vector3[2],a=D.Quaternion[0],l=D.Matrix[0],h=D.Matrix[1],c=D.Matrix[2],u=D.Matrix[3];return e.subtractToRef(this.position,s),L.TranslationToRef(s.x,s.y,s.z,l),L.TranslationToRef(-s.x,-s.y,-s.z,h),L.RotationAxisToRef(t,i,c),h.multiplyToRef(c,u),u.multiplyToRef(l,u),u.decompose(r,a,n),this.position.addInPlace(n),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const s=e.scale(t);if(!i||i===ft.LOCAL){const r=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(r)}else this.setAbsolutePosition(this.getAbsolutePosition().add(s));return this}addRotation(e,t,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=D.Quaternion[1],le.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const r=D.Quaternion[0];return le.RotationYawPitchRollToRef(t,e,i,r),s.multiplyInPlace(r),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==we.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();const s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const r=this._getEffectiveParent(),n=we._TmpScaling;let a=this._position;if(this._infiniteDistance&&!this.parent&&t){const h=t.getWorldMatrix(),c=new m(h.m[12],h.m[13],h.m[14]);a=we._TmpTranslation,a.copyFromFloats(this._position.x+c.x,this._position.y+c.y,this._position.z+c.z)}n.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(le.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=we._TmpRotation,le.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){const h=D.Matrix[1];L.ScalingToRef(n.x,n.y,n.z,h);const c=D.Matrix[0];l.toRotationMatrix(c),this._pivotMatrix.multiplyToRef(h,D.Matrix[4]),D.Matrix[4].multiplyToRef(c,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(a.x,a.y,a.z)}else L.ComposeToRef(n,l,a,this._localMatrix);if(r&&r.getWorldMatrix){if(e&&r.computeWorldMatrix(e),s.useBillboardPath){if(this._transformToBoneReferal){const d=this.parent;d.getSkeleton().prepare(),d.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),D.Matrix[7])}else D.Matrix[7].copyFrom(r.getWorldMatrix());const h=D.Vector3[5],c=D.Vector3[6],u=D.Quaternion[0];D.Matrix[7].decompose(c,u,h),L.ScalingToRef(c.x,c.y,c.z,D.Matrix[7]),D.Matrix[7].setTranslation(h),we.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(u,h),this._localMatrix.setTranslation(h)),this._localMatrix.multiplyToRef(D.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){const h=this.parent;h.getSkeleton().prepare(),this._localMatrix.multiplyToRef(h.getFinalMatrix(),D.Matrix[6]),D.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(r.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(s.useBillboardPath&&t&&this.billboardMode&&!s.useBillboardPosition){const h=D.Vector3[0];if(this._worldMatrix.getTranslationToRef(h),D.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&D.Matrix[1].multiplyToRef(jb,D.Matrix[1]),D.Matrix[1].setTranslationFromFloats(0,0,0),D.Matrix[1].invertToRef(D.Matrix[0]),(this.billboardMode&we.BILLBOARDMODE_ALL)!==we.BILLBOARDMODE_ALL){D.Matrix[0].decompose(void 0,D.Quaternion[0],void 0);const c=D.Vector3[1];D.Quaternion[0].toEulerAnglesToRef(c),(this.billboardMode&we.BILLBOARDMODE_X)!==we.BILLBOARDMODE_X&&(c.x=0),(this.billboardMode&we.BILLBOARDMODE_Y)!==we.BILLBOARDMODE_Y&&(c.y=0),(this.billboardMode&we.BILLBOARDMODE_Z)!==we.BILLBOARDMODE_Z&&(c.z=0),L.RotationYawPitchRollToRef(c.y,c.x,c.z,D.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(D.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(D.Vector3[0])}else if(s.useBillboardPath&&t&&s.useBillboardPosition){const h=D.Vector3[0];this._worldMatrix.getTranslationToRef(h);const c=t.globalPosition;this._worldMatrix.invertToRef(D.Matrix[1]);const u=D.Vector3[1];m.TransformCoordinatesToRef(c,D.Matrix[1],u),u.normalize();const d=-Math.atan2(u.z,u.x)+Math.PI/2,f=Math.sqrt(u.x*u.x+u.z*u.z),p=-Math.atan2(u.y,f);if(le.RotationYawPitchRollToRef(d,p,0,D.Quaternion[0]),(this.billboardMode&we.BILLBOARDMODE_ALL)!==we.BILLBOARDMODE_ALL){const _=D.Vector3[1];D.Quaternion[0].toEulerAnglesToRef(_),(this.billboardMode&we.BILLBOARDMODE_X)!==we.BILLBOARDMODE_X&&(_.x=0),(this.billboardMode&we.BILLBOARDMODE_Y)!==we.BILLBOARDMODE_Y&&(_.y=0),(this.billboardMode&we.BILLBOARDMODE_Z)!==we.BILLBOARDMODE_Z&&(_.z=0),L.RotationYawPitchRollToRef(_.y,_.x,_.z,D.Matrix[0])}else L.FromQuaternionToRef(D.Quaternion[0],D.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(D.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(D.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):r&&r._nonUniformScaling?this._updateNonUniformScalingState(r._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=L.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const s=t[i];if(s){s.computeWorldMatrix();const r=D.Matrix[0];s._localMatrix.multiplyToRef(this._localMatrix,r);const n=D.Quaternion[0];r.decompose(s.scaling,n,s.position),s.rotationQuaternion?s.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(s.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=le.Identity()),this._worldMatrix=L.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),m.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const s=Le.Clone(()=>new we(e,this.getScene()),this);if(s.name=e,s.id=e,t&&(s.parent=t),!i){const r=this.getDescendants(!0);for(let n=0;n<r.length;n++){const a=r[n];a.clone&&a.clone(e+"."+a.name,s)}}return s}serialize(e){const t=Le.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const s=Le.Parse(()=>new we(e.name,t),e,t,i);return e.localMatrix?s.setPreTransformMatrix(L.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(L.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,s=>(!t||t(s))&&s instanceof we),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const s of i)s.parent=null,s.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let s=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),a=n.max.subtract(n.min),l=Math.max(a.x,a.y,a.z);if(l===0)return this;const h=1/l;return this.scaling.scaleInPlace(h),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}we.BILLBOARDMODE_NONE=0;we.BILLBOARDMODE_X=1;we.BILLBOARDMODE_Y=2;we.BILLBOARDMODE_Z=4;we.BILLBOARDMODE_ALL=7;we.BILLBOARDMODE_USE_POSITION=128;we.BillboardUseParentOrientation=!1;we._TmpRotation=le.Zero();we._TmpScaling=m.Zero();we._TmpTranslation=m.Zero();we._LookAtVectorCache=new m(0,0,0);we._RotationAxisCache=new le;v([zi("position")],we.prototype,"_position",void 0);v([zi("rotation")],we.prototype,"_rotation",void 0);v([u0("rotationQuaternion")],we.prototype,"_rotationQuaternion",void 0);v([zi("scaling")],we.prototype,"_scaling",void 0);v([M("billboardMode")],we.prototype,"_billboardMode",void 0);v([M()],we.prototype,"scalingDeterminant",void 0);v([M("infiniteDistance")],we.prototype,"_infiniteDistance",void 0);v([M()],we.prototype,"ignoreNonUniformScaling",void 0);v([M()],we.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);class qb{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new m(0,0,0),this._diffPositionForCollisions=new m(0,0,0),this._collisionResponse=!0}}class Zb{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=m.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class Qb{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new Zb,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new qb,this._enableDistantPicking=!1,this._rawBoundingInfo=null}}class pi extends we{static get BILLBOARDMODE_NONE(){return we.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return we.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return we.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return we.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return we.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return we.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return(t=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||t===void 0?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new Qb,this._waitingMaterialId=null,this.cullingStrategy=pi.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new j,this.onCollisionPositionChangeObservable=new j,this.onMaterialChangedObservable=new j,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=J.Red(),this.outlineWidth=.02,this.overlayColor=J.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.edgesWidth=1,this.edgesColor=new He(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new j,this._onCollisionPositionChange=(i,s,r=null)=>{s.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>H.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),r&&this.onCollideObservable.notifyObservers(r),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new ve(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case dr.Aggressive:this.doNotSyncBoundingInfo=!0;case dr.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==we.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(const t of this.subMeshes)t._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let s=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;s=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(s)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const s=t._drawWrappers[i];!s||!s.defines||!s.defines.markAllAsDirty||e(s.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,s){return this}updateVerticesData(e,t,i,s){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){var e;return(e=this.rawBoundingInfo)!==null&&e!==void 0?e:this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new hs(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(T.MatricesIndicesKind)&&this.isVerticesDataPresent(T.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===we.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const s=new L;(this.rotationQuaternion?this.rotationQuaternion:le.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const n=m.Zero(),a=this.definedFacingForward?-1:1;return m.TransformCoordinatesFromFloatsToRef(e*a,t,i*a,s,n),n}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const s=this.definedFacingForward?1:-1;return new m(e*s,t,i*s)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,t),null),this)}_refreshBoundingInfo(e,t){if(e){const i=Hm(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new hs(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,i,s=T.PositionKind){if(i=i??this.getVerticesData(s).slice(),i&&t&&this.morphTargetManager){let r=0,n=0;for(let a=0;a<i.length;a++){let l=i[a];for(let h=0;h<this.morphTargetManager.numTargets;h++){const c=this.morphTargetManager.getTarget(h),u=c.influence;if(u!==0){let d=null;switch(s){case T.PositionKind:d=c.getPositions();break;case T.NormalKind:d=c.getNormals();break;case T.TangentKind:d=c.getTangents();break;case T.UVKind:d=c.getUVs();break}d&&(l+=(d[a]-i[a])*u)}}if(i[a]=l,r++,s===T.PositionKind&&this._positions&&r===3){r=0;const h=n*3;this._positions[n++].copyFromFloats(i[h],i[h+1],i[h+2])}}}if(i&&e&&this.skeleton){const r=this.getVerticesData(T.MatricesIndicesKind),n=this.getVerticesData(T.MatricesWeightsKind);if(n&&r){const a=this.numBoneInfluencers>4,l=a?this.getVerticesData(T.MatricesIndicesExtraKind):null,h=a?this.getVerticesData(T.MatricesWeightsExtraKind):null,c=this.skeleton.getTransformMatrices(this),u=D.Vector3[0],d=D.Matrix[0],f=D.Matrix[1];let p=0;for(let _=0;_<i.length;_+=3,p+=4){d.reset();let g,E;for(g=0;g<4;g++)E=n[p+g],E>0&&(L.FromFloat32ArrayToRefScaled(c,Math.floor(r[p+g]*16),E,f),d.addToSelf(f));if(a)for(g=0;g<4;g++)E=h[p+g],E>0&&(L.FromFloat32ArrayToRefScaled(c,Math.floor(l[p+g]*16),E,f),d.addToSelf(f));s===T.NormalKind?m.TransformNormalFromFloatsToRef(i[_],i[_+1],i[_+2],d,u):m.TransformCoordinatesFromFloatsToRef(i[_],i[_+1],i[_+2],d,u),u.toArray(i,_),s===T.PositionKind&&this._positions&&this._positions[_/3].copyFrom(u)}}}return i}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,T.NormalKind)}getPositionData(e=!1,t=!1,i){return this._getData(e,t,i,T.PositionKind)}_getPositionData(e,t){var i;let s=this.getVerticesData(T.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),s&&(e&&this.skeleton||t&&this.morphTargetManager)){if(s=s.slice(),this._generatePointsArray(),this._positions){const r=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(r.length);for(let n=0;n<r.length;n++)this._internalAbstractMeshDataInfo._positions[n]=((i=r[n])===null||i===void 0?void 0:i.clone())||new m}return this.getPositionData(e,t,s)}return s}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new hs(m.Zero(),m.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const s=this.subMeshes[i];(t>1||!s.IsGlobal)&&s.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const s=this.getBoundingInfo(),r=e.getBoundingInfo();if(s.intersects(r,t))return!0;if(i){for(const n of this.getChildMeshes())if(n.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var s;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const r=e.verticesStart,n=e.verticesStart+e.verticesCount;for(let a=r;a<n;a++)e._lastColliderWorldVertices.push(m.TransformCoordinates(this._positions[a],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((s=e.getMaterial())===null||s===void 0?void 0:s.fillMode)===7),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),s=i.length;for(let r=0;r<s;r++){const n=i.data[r];s>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=D.Matrix[0],i=D.Matrix[1];return L.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,s=!1,r,n=!1){const a=new pr,l=this.getClassName(),h=l==="InstancedLinesMesh"||l==="LinesMesh"||l==="GreasedLineMesh"?this.intersectionThreshold:0,c=this.getBoundingInfo();if(!this.subMeshes||!n&&(!e.intersectsSphere(c.boundingSphere,h)||!e.intersectsBox(c.boundingBox,h)))return a;if(s)return a.hit=!n,a.pickedMesh=n?null:this,a.distance=n?0:m.Distance(e.origin,c.boundingSphere.center),a.subMeshId=0,a;if(!this._generatePointsArray())return a;let u=null;const d=this._scene.getIntersectingSubMeshCandidates(this,e),f=d.length;let p=!1;for(let _=0;_<f;_++){const E=d.data[_].getMaterial();if(E&&(E.fillMode==7||E.fillMode==0||E.fillMode==1||E.fillMode==2||E.fillMode==4)){p=!0;break}}if(!p)return a.hit=!0,a.pickedMesh=this,a.distance=m.Distance(e.origin,c.boundingSphere.center),a.subMeshId=-1,a;for(let _=0;_<f;_++){const g=d.data[_];if(f>1&&!n&&!g.canIntersects(e))continue;const E=g.intersects(e,this._positions,this.getIndices(),t,i);if(E&&(t||!u||E.distance<u.distance)&&(u=E,u.subMeshId=_,t))break}if(u){const _=r??this.getWorldMatrix(),g=D.Vector3[0],E=D.Vector3[1];m.TransformCoordinatesToRef(e.origin,_,g),e.direction.scaleToRef(u.distance,E);const x=m.TransformNormal(E,_).addInPlace(g);return a.hit=!0,a.distance=m.Distance(g,x),a.pickedPoint=x,a.pickedMesh=this,a.bu=u.bu||0,a.bv=u.bv||0,a.subMeshFaceId=u.faceId,a.faceId=u.faceId+d.data[u.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),a.subMeshId=u.subMeshId,a}return a}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this}dispose(e,t=!1){let i;const s=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),s.freeActiveMeshes(),s.freeRenderingGroups(),s.renderingManager.maintainStateBetweenFrames&&s.renderingManager.restoreDispachedFlags(),this.actionManager!==void 0&&this.actionManager!==null&&(this._scene.meshes.some(a=>a!==this&&a.actionManager===this.actionManager)||this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const a=this._intersectionsInProgress[i],l=a._intersectionsInProgress.indexOf(this);a._intersectionsInProgress.splice(l,1)}this._intersectionsInProgress.length=0,s.lights.forEach(a=>{let l=a.includedOnlyMeshes.indexOf(this);l!==-1&&a.includedOnlyMeshes.splice(l,1),l=a.excludedMeshes.indexOf(this),l!==-1&&a.excludedMeshes.splice(l,1);const h=a.getShadowGenerators();if(h){const c=h.values();for(let u=c.next();u.done!==!0;u=c.next()){const f=u.value.getShadowMap();f&&f.renderList&&(l=f.renderList.indexOf(this),l!==-1&&f.renderList.splice(l,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();const n=s.getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,n.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),n.wipeCaches(),s.removeMesh(this),this._parentContainer){const a=this._parentContainer.meshes.indexOf(this);a>-1&&this._parentContainer.meshes.splice(a,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<s.particleSystems.length;i++)s.particleSystems[i].emitter===this&&(s.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=m.Zero(),e.facetPositions[t]=m.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(T.PositionKind),i=this.getIndices(),s=this.getVerticesData(T.NormalKind),r=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let a=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){a=!0;break}a?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(a,l){return l.sqDistance-a.sqDistance},!e.facetDepthSortFrom){const a=this.getScene().activeCamera;e.facetDepthSortFrom=a?a.position:m.Zero()}e.depthSortedFacets=[];for(let a=0;a<e.facetNb;a++){const l={ind:a*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=L.Identity(),e.facetDepthSortOrigin=m.Zero()}e.bbSize.x=r.maximum.x-r.minimum.x>dt?r.maximum.x-r.minimum.x:dt,e.bbSize.y=r.maximum.y-r.minimum.y>dt?r.maximum.y-r.minimum.y:dt,e.bbSize.z=r.maximum.z-r.minimum.z>dt?r.maximum.z-r.minimum.z:dt;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=r,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),m.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,s&&fe.ComputeNormals(t,i,s,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const a=e.depthSortedIndices.length/3|0;for(let l=0;l<a;l++){const h=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[h],e.depthSortedIndices[l*3+1]=i[h+1],e.depthSortedIndices[l*3+2]=i[h+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=m.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],s=this.getWorldMatrix();return m.TransformCoordinatesToRef(i,s,t),this}getFacetNormal(e){const t=m.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return m.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const s=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-s.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),a=Math.floor((t-s.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),l=Math.floor((i-s.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return n<0||n>r.subDiv.max||a<0||a>r.subDiv.max||l<0||l>r.subDiv.max?null:r.facetPartitioning[n+r.subDiv.max*a+r.subDiv.max*r.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,s,r=!1,n=!0){const a=this.getWorldMatrix(),l=D.Matrix[5];a.invertToRef(l);const h=D.Vector3[8];m.TransformCoordinatesFromFloatsToRef(e,t,i,l,h);const c=this.getClosestFacetAtLocalCoordinates(h.x,h.y,h.z,s,r,n);return s&&m.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,a,s),c}getClosestFacetAtLocalCoordinates(e,t,i,s,r=!1,n=!0){let a=null,l=0,h=0,c=0,u=0,d=0,f=0,p=0,_=0;const g=this.getFacetLocalPositions(),E=this.getFacetLocalNormals(),R=this.getFacetsAtLocalCoordinates(e,t,i);if(!R)return null;let x=Number.MAX_VALUE,S=x,b,y,I;for(let O=0;O<R.length;O++)b=R[O],y=E[b],I=g[b],u=(e-I.x)*y.x+(t-I.y)*y.y+(i-I.z)*y.z,(!r||r&&n&&u>=0||r&&!n&&u<=0)&&(u=y.x*I.x+y.y*I.y+y.z*I.z,d=-(y.x*e+y.y*t+y.z*i-u)/(y.x*y.x+y.y*y.y+y.z*y.z),f=e+y.x*d,p=t+y.y*d,_=i+y.z*d,l=f-e,h=p-t,c=_-i,S=l*l+h*h+c*c,S<x&&(x=S,a=b,s&&(s.x=f,s.y=p,s.z=_)));return a}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(T.PositionKind),i=this.getIndices();let s;return this.isVerticesDataPresent(T.NormalKind)?s=this.getVerticesData(T.NormalKind):s=[],fe.ComputeNormals(t,i,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(T.NormalKind,s,e),this}alignWithNormal(e,t){t||(t=En.Y);const i=D.Vector3[0],s=D.Vector3[1];return m.CrossToRef(t,e,s),m.CrossToRef(e,s,i),this.rotationQuaternion?le.RotationQuaternionFromAxisToRef(i,e,s,this.rotationQuaternion):m.RotationFromAxisToRef(i,e,s,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw ke("EdgesRenderer")}enableEdgesRendering(e,t,i){throw ke("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}pi.OCCLUSION_TYPE_NONE=0;pi.OCCLUSION_TYPE_OPTIMISTIC=1;pi.OCCLUSION_TYPE_STRICT=2;pi.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;pi.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;pi.CULLINGSTRATEGY_STANDARD=0;pi.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;pi.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;pi.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;Re("BABYLON.AbstractMesh",pi);class De extends Jt{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,s;let r=0,n=0;if(this.mode===De.PERSPECTIVE_CAMERA)this.fovMode===De.FOVMODE_VERTICAL_FIXED?(n=this.minZ*2*Math.tan(this.fov/2),r=this.getEngine().getAspectRatio(this)*n):(r=this.minZ*2*Math.tan(this.fov/2),n=r/this.getEngine().getAspectRatio(this));else{const a=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;r=((e=this.orthoRight)!==null&&e!==void 0?e:a)-((t=this.orthoLeft)!==null&&t!==void 0?t:-a),n=((i=this.orthoTop)!==null&&i!==void 0?i:l)-((s=this.orthoBottom)!==null&&s!==void 0?s:-l)}return r*n}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(e,t,i,s=!0){super(e,i),this._position=m.Zero(),this._upVector=m.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=De.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Za(0,0,1,1),this.layerMask=268435455,this.fovMode=De.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=De.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new j,this.onProjectionMatrixChangedObservable=new j,this.onAfterCheckInputsObservable=new j,this.onRestoreStateObservable=new j,this.isRigCamera=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new L,this._postProcesses=new Array,this._activeMeshes=new li(256),this._globalPosition=m.Zero(),this._computedViewMatrix=L.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=L.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=le.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===De.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==De.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const s=this._rigCameras[t],r=s._rigPostProcess;r?(r.getEffectName()==="pass"&&(s.isIntermediate=this._postProcesses.length===0),s._postProcesses=this._postProcesses.slice(0).concat(r),r.markTextureDirty()):s._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(q.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return L.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,s,r,n,a,l,h,c,u,d,f,p,_,g,E,R,x,S;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const b=this.getEngine(),y=this.getScene(),I=b.useReverseDepthBuffer;if(this.mode===De.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=b.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let O;y.useRightHandedSystem?O=L.PerspectiveFovRHToRef:O=L.PerspectiveFovLHToRef,O(this.fov,b.getAspectRatio(this),I?this.maxZ:this.minZ,I?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===De.FOVMODE_VERTICAL_FIXED,b.isNDCHalfZRange,this.projectionPlaneTilt,I)}else{const O=b.getRenderWidth()/2,N=b.getRenderHeight()/2;y.useRightHandedSystem?this.oblique?L.ObliqueOffCenterRHToRef((t=this.orthoLeft)!==null&&t!==void 0?t:-O,(i=this.orthoRight)!==null&&i!==void 0?i:O,(s=this.orthoBottom)!==null&&s!==void 0?s:-N,(r=this.orthoTop)!==null&&r!==void 0?r:N,I?this.maxZ:this.minZ,I?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,b.isNDCHalfZRange):L.OrthoOffCenterRHToRef((n=this.orthoLeft)!==null&&n!==void 0?n:-O,(a=this.orthoRight)!==null&&a!==void 0?a:O,(l=this.orthoBottom)!==null&&l!==void 0?l:-N,(h=this.orthoTop)!==null&&h!==void 0?h:N,I?this.maxZ:this.minZ,I?this.minZ:this.maxZ,this._projectionMatrix,b.isNDCHalfZRange):this.oblique?L.ObliqueOffCenterLHToRef((c=this.orthoLeft)!==null&&c!==void 0?c:-O,(u=this.orthoRight)!==null&&u!==void 0?u:O,(d=this.orthoBottom)!==null&&d!==void 0?d:-N,(f=this.orthoTop)!==null&&f!==void 0?f:N,I?this.maxZ:this.minZ,I?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,b.isNDCHalfZRange):L.OrthoOffCenterLHToRef((p=this.orthoLeft)!==null&&p!==void 0?p:-O,(_=this.orthoRight)!==null&&_!==void 0?_:O,(g=this.orthoBottom)!==null&&g!==void 0?g:-N,(E=this.orthoTop)!==null&&E!==void 0?E:N,I?this.maxZ:this.minZ,I?this.minZ:this.maxZ,this._projectionMatrix,b.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=(R=this.oblique)===null||R===void 0?void 0:R.angle,this._cache.obliqueLength=(x=this.oblique)===null||x===void 0?void 0:x.length,this._cache.obliqueOffset=(S=this.oblique)===null||S===void 0?void 0:S.offset,this._cache.renderWidth=b.getRenderWidth(),this._cache.renderHeight=b.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){const t=this,i=this;return(t.radius||(i.target?m.Distance(this.position,i.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?Bs.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=Bs.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(s=>{s._updateFrustumPlanes(),i=i||e.isInFrustum(s._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw ke("Ray")}getForwardRayToRef(e,t=100,i,s){throw ke("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const s=this._rigCameras.pop();s&&s.dispose()}if(this._parentContainer){const s=this._parentContainer.cameras.indexOf(this);s>-1&&this._parentContainer.cameras.splice(s,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==De.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let s=this._postProcesses.length;for(;--s>=0;){const r=this._postProcesses[s];r&&r.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=Y.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==De.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const s=this.createRigCamera(this.name+"_R",1);s&&(s._isRightCamera=!0),i&&s&&(this._rigCameras.push(i),this._rigCameras.push(s))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return L.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=Y.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===De.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=Le.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),Le.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=Le.Clone(De.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=m.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){m.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,s=0,r=!0){const n=Jt.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:r});return n||(()=>De._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,s=De.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),r=Le.Parse(s,e,t);if(e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r.inputs&&(r.inputs.parse(e),r._setupInputs()),e.upVector&&(r.upVector=m.FromArray(e.upVector)),r.setPosition&&(r.position.copyFromFloats(0,0,0),r.setPosition(m.FromArray(e.position))),e.target&&r.setTarget&&r.setTarget(m.FromArray(e.target)),e.cameraRigMode){const n=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};r.setCameraRigMode(e.cameraRigMode,n)}if(e.animations){for(let n=0;n<e.animations.length;n++){const a=e.animations[n],l=Gr("BABYLON.Animation");l&&r.animations.push(l.Parse(a))}Jt.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}De._CreateDefaultParsedCamera=(o,e)=>{throw ke("UniversalCamera")};De.PERSPECTIVE_CAMERA=0;De.ORTHOGRAPHIC_CAMERA=1;De.FOVMODE_VERTICAL_FIXED=0;De.FOVMODE_HORIZONTAL_FIXED=1;De.RIG_MODE_NONE=0;De.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;De.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;De.RIG_MODE_STEREOSCOPIC_INTERLACED=14;De.RIG_MODE_VR=20;De.RIG_MODE_CUSTOM=22;De.ForceAttachControlToAlwaysPreventDefault=!1;v([zi("position")],De.prototype,"_position",void 0);v([zi("upVector")],De.prototype,"_upVector",void 0);v([M()],De.prototype,"orthoLeft",null);v([M()],De.prototype,"orthoRight",null);v([M()],De.prototype,"orthoBottom",null);v([M()],De.prototype,"orthoTop",null);v([M()],De.prototype,"fov",void 0);v([M()],De.prototype,"projectionPlaneTilt",void 0);v([M()],De.prototype,"minZ",void 0);v([M()],De.prototype,"maxZ",void 0);v([M()],De.prototype,"inertia",void 0);v([M()],De.prototype,"mode",null);v([M()],De.prototype,"layerMask",void 0);v([M()],De.prototype,"fovMode",void 0);v([M()],De.prototype,"cameraRigMode",void 0);v([M()],De.prototype,"interaxialDistance",void 0);v([M()],De.prototype,"isStereoscopicSideBySide",void 0);function In(o){o.indexOf("vClipPlane")===-1&&o.push("vClipPlane"),o.indexOf("vClipPlane2")===-1&&o.push("vClipPlane2"),o.indexOf("vClipPlane3")===-1&&o.push("vClipPlane3"),o.indexOf("vClipPlane4")===-1&&o.push("vClipPlane4"),o.indexOf("vClipPlane5")===-1&&o.push("vClipPlane5"),o.indexOf("vClipPlane6")===-1&&o.push("vClipPlane6")}function Mh(o,e,t){var i,s,r,n,a,l;const h=!!((i=o.clipPlane)!==null&&i!==void 0?i:e.clipPlane),c=!!((s=o.clipPlane2)!==null&&s!==void 0?s:e.clipPlane2),u=!!((r=o.clipPlane3)!==null&&r!==void 0?r:e.clipPlane3),d=!!((n=o.clipPlane4)!==null&&n!==void 0?n:e.clipPlane4),f=!!((a=o.clipPlane5)!==null&&a!==void 0?a:e.clipPlane5),p=!!((l=o.clipPlane6)!==null&&l!==void 0?l:e.clipPlane6);h&&t.push("#define CLIPPLANE"),c&&t.push("#define CLIPPLANE2"),u&&t.push("#define CLIPPLANE3"),d&&t.push("#define CLIPPLANE4"),f&&t.push("#define CLIPPLANE5"),p&&t.push("#define CLIPPLANE6")}function Jb(o,e,t){var i,s,r,n,a,l;let h=!1;const c=!!((i=o.clipPlane)!==null&&i!==void 0?i:e.clipPlane),u=!!((s=o.clipPlane2)!==null&&s!==void 0?s:e.clipPlane2),d=!!((r=o.clipPlane3)!==null&&r!==void 0?r:e.clipPlane3),f=!!((n=o.clipPlane4)!==null&&n!==void 0?n:e.clipPlane4),p=!!((a=o.clipPlane5)!==null&&a!==void 0?a:e.clipPlane5),_=!!((l=o.clipPlane6)!==null&&l!==void 0?l:e.clipPlane6);return t.CLIPPLANE!==c&&(t.CLIPPLANE=c,h=!0),t.CLIPPLANE2!==u&&(t.CLIPPLANE2=u,h=!0),t.CLIPPLANE3!==d&&(t.CLIPPLANE3=d,h=!0),t.CLIPPLANE4!==f&&(t.CLIPPLANE4=f,h=!0),t.CLIPPLANE5!==p&&(t.CLIPPLANE5=p,h=!0),t.CLIPPLANE6!==_&&(t.CLIPPLANE6=_,h=!0),h}function Pn(o,e,t){var i,s,r,n,a,l;let h=(i=e.clipPlane)!==null&&i!==void 0?i:t.clipPlane;wa(o,"vClipPlane",h),h=(s=e.clipPlane2)!==null&&s!==void 0?s:t.clipPlane2,wa(o,"vClipPlane2",h),h=(r=e.clipPlane3)!==null&&r!==void 0?r:t.clipPlane3,wa(o,"vClipPlane3",h),h=(n=e.clipPlane4)!==null&&n!==void 0?n:t.clipPlane4,wa(o,"vClipPlane4",h),h=(a=e.clipPlane5)!==null&&a!==void 0?a:t.clipPlane5,wa(o,"vClipPlane5",h),h=(l=e.clipPlane6)!==null&&l!==void 0?l:t.clipPlane6,wa(o,"vClipPlane6",h)}function wa(o,e,t){t&&o.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}class se{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==Ve.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,s,r,n,a,l=!1){a._areMiscDirty&&(a.LOGARITHMICDEPTH=i,a.POINTSIZE=s,a.FOG=r&&this.GetFogState(e,t),a.NONUNIFORMSCALING=e.nonUniformScaling,a.ALPHATEST=n,a.DECAL_AFTER_DETAIL=l)}static PrepareDefinesForCamera(e,t){let i=!1;if(e.activeCamera){const s=t.CAMERA_ORTHOGRAPHIC?1:0,r=t.CAMERA_PERSPECTIVE?1:0,n=e.activeCamera.mode===De.ORTHOGRAPHIC_CAMERA?1:0,a=e.activeCamera.mode===De.PERSPECTIVE_CAMERA?1:0;(s^n||r^a)&&(t.CAMERA_ORTHOGRAPHIC=n===1,t.CAMERA_PERSPECTIVE=a===1,i=!0)}return i}static PrepareDefinesForFrameBoundValues(e,t,i,s,r,n=null,a=!1){let l=se.PrepareDefinesForCamera(e,s);n!==!1&&(l=Jb(i,e,s)),s.DEPTHPREPASS!==!t.getColorWrite()&&(s.DEPTHPREPASS=!s.DEPTHPREPASS,l=!0),s.INSTANCES!==r&&(s.INSTANCES=r,l=!0),s.THIN_INSTANCES!==a&&(s.THIN_INSTANCES=a,l=!0),l&&s.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=i?!1:void 0;const s=e.getScene().prePassRenderer;if(s&&s.enabled){const r=s.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=r}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE!==void 0&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(i&&i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,s,r=!1,n=!0,a=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(T.NormalKind),t._needNormals&&e.isVerticesDataPresent(T.TangentKind)&&(t.TANGENT=!0);for(let l=1;l<=6;++l)t["UV"+l]=t._needUVs?e.isVerticesDataPresent(`uv${l===1?"":l}`):!1;if(i){const l=e.useVertexColors&&e.isVerticesDataPresent(T.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&n}return e.isVerticesDataPresent(T.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),s&&this.PrepareDefinesForBones(e,t),r&&this.PrepareDefinesForMorphTargets(e,t),a&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const s=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(s!==t.ORDER_INDEPENDENT_TRANSPARENCY||r!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const s=t.PREPASS;if(!t._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount,t.PREPASS_NORMAL_WORLDSPACE=e.prePassRenderer.generateNormalsInWorldSpace;for(let n=0;n<r.length;n++){const a=e.prePassRenderer.getIndex(r[n].type);a!==-1?(t[r[n].define]=!0,t[r[n].index]=a):t[r[n].define]=!1}}else{t.PREPASS=!1;for(let n=0;n<r.length;n++)t[r[n].define]=!1}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,s,r,n,a){var l;switch(a.needNormals=!0,r["LIGHT"+s]===void 0&&(a.needRebuild=!0),r["LIGHT"+s]=!0,r["SPOTLIGHT"+s]=!1,r["HEMILIGHT"+s]=!1,r["POINTLIGHT"+s]=!1,r["DIRLIGHT"+s]=!1,i.prepareLightSpecificDefines(r,s),r["LIGHT_FALLOFF_PHYSICAL"+s]=!1,r["LIGHT_FALLOFF_GLTF"+s]=!1,r["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case mt.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+s]=!0;break;case mt.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case mt.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+s]=!0;break}if(n&&!i.specular.equalsFloats(0,0,0)&&(a.specularEnabled=!0),r["SHADOW"+s]=!1,r["SHADOWCSM"+s]=!1,r["SHADOWCSMDEBUG"+s]=!1,r["SHADOWCSMNUM_CASCADES"+s]=!1,r["SHADOWCSMUSESHADOWMAXZ"+s]=!1,r["SHADOWCSMNOBLEND"+s]=!1,r["SHADOWCSM_RIGHTHANDED"+s]=!1,r["SHADOWPCF"+s]=!1,r["SHADOWPCSS"+s]=!1,r["SHADOWPOISSON"+s]=!1,r["SHADOWESM"+s]=!1,r["SHADOWCLOSEESM"+s]=!1,r["SHADOWCUBE"+s]=!1,r["SHADOWLOWQUALITY"+s]=!1,r["SHADOWMEDIUMQUALITY"+s]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const h=(l=i.getShadowGenerator(e.activeCamera))!==null&&l!==void 0?l:i.getShadowGenerator();if(h){const c=h.getShadowMap();c&&c.renderList&&c.renderList.length>0&&(a.shadowEnabled=!0,h.prepareDefines(r,s))}}i.lightmapMode!=mt.LIGHTMAP_DEFAULT?(a.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+s]=!0,r["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==mt.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+s]=!1,r["LIGHTMAPNOSPECULAR"+s]=!1)}static PrepareDefinesForLights(e,t,i,s,r=4,n=!1){if(!i._areLightsDirty)return i._needNormals;let a=0;const l={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!n){for(const c of t.lightSources)if(this.PrepareDefinesForLight(e,t,c,a,i,s,l),a++,a===r)break}i.SPECULARTERM=l.specularEnabled,i.SHADOWS=l.shadowEnabled;for(let c=a;c<r;c++)i["LIGHT"+c]!==void 0&&(i["LIGHT"+c]=!1,i["HEMILIGHT"+c]=!1,i["POINTLIGHT"+c]=!1,i["DIRLIGHT"+c]=!1,i["SPOTLIGHT"+c]=!1,i["SHADOW"+c]=!1,i["SHADOWCSM"+c]=!1,i["SHADOWCSMDEBUG"+c]=!1,i["SHADOWCSMNUM_CASCADES"+c]=!1,i["SHADOWCSMUSESHADOWMAXZ"+c]=!1,i["SHADOWCSMNOBLEND"+c]=!1,i["SHADOWCSM_RIGHTHANDED"+c]=!1,i["SHADOWPCF"+c]=!1,i["SHADOWPCSS"+c]=!1,i["SHADOWPOISSON"+c]=!1,i["SHADOWESM"+c]=!1,i["SHADOWCLOSEESM"+c]=!1,i["SHADOWCUBE"+c]=!1,i["SHADOWLOWQUALITY"+c]=!1,i["SHADOWMEDIUMQUALITY"+c]=!1);const h=e.getEngine().getCaps();return i.SHADOWFLOAT===void 0&&(l.needRebuild=!0),i.SHADOWFLOAT=l.shadowEnabled&&(h.textureFloatRender&&h.textureFloatLinearFiltering||h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&i.rebuild(),l.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,s,r=null,n=!1){r&&r.push("Light"+e),!n&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,s=4){let r,n=null;if(e.uniformsNames){const a=e;r=a.uniformsNames,n=a.uniformBuffersNames,t=a.samplers,i=a.defines,s=a.maxSimultaneousLights||0}else r=e,t||(t=[]);for(let a=0;a<s&&i["LIGHT"+a];a++)this.PrepareUniformsAndSamplersForLight(a,r,t,i["PROJECTEDLIGHTTEXTURE"+a],n);i.NUM_MORPH_INFLUENCERS&&r.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,s=0){let r=0;for(let n=0;n<i&&e["LIGHT"+n];n++)n>0&&(r=s+n,t.addFallback(r,"LIGHT"+n)),e.SHADOWS||(e["SHADOW"+n]&&t.addFallback(s,"SHADOW"+n),e["SHADOWPCF"+n]&&t.addFallback(s,"SHADOWPCF"+n),e["SHADOWPCSS"+n]&&t.addFallback(s,"SHADOWPCSS"+n),e["SHADOWPOISSON"+n]&&t.addFallback(s,"SHADOWPOISSON"+n),e["SHADOWESM"+n]&&t.addFallback(s,"SHADOWESM"+n),e["SHADOWCLOSEESM"+n]&&t.addFallback(s,"SHADOWCLOSEESM"+n));return r++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const s=i.NUM_MORPH_INFLUENCERS;if(s>0&&Ze.LastCreatedEngine){const r=Ze.LastCreatedEngine.getCaps().maxVertexAttribs,n=t.morphTargetManager;if(n!=null&&n.isUsingTextureForTargets)return;const a=n&&n.supportsNormals&&i.NORMAL,l=n&&n.supportsTangents&&i.TANGENT,h=n&&n.supportsUVs&&i.UV1;for(let c=0;c<s;c++)e.push(T.PositionKind+c),a&&e.push(T.NormalKind+c),l&&e.push(T.TangentKind+c),h&&e.push(T.UVKind+"_"+c),e.length>r&&q.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push(T.MatricesIndicesKind),e.push(T.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(T.MatricesIndicesExtraKind),e.push(T.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(T.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,s,r,n=!0){e._bindLight(t,i,s,r,n)}static BindLights(e,t,i,s,r=4){const n=Math.min(t.lightSources.length,r);for(let a=0;a<n;a++){const l=t.lightSources[a];this.BindLight(l,a,e,i,typeof s=="boolean"?s:s.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,i,s=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==Ve.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const s=e.skeleton;if(s.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const r=s.getTransformMatrixTexture(e);t.setTexture("boneSampler",r),t.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{const r=s.getTransformMatrices(e);r&&(t.setMatrices("mBones",r),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=r.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),se._CopyBonesTransformationMatrices(r,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const s=i.activeCamera;s.mode===De.ORTHOGRAPHIC_CAMERA&&q.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(s.maxZ+1)/Math.LN2))}}}se._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0};se._TempFogColor=J.Black();class $r{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){Le.Clone(()=>e,this)}serialize(){return Le.Serialize(this)}parse(e,t,i){Le.Parse(()=>this,e,t,i)}}v([M()],$r.prototype,"func",null);v([M()],$r.prototype,"funcRef",null);v([M()],$r.prototype,"funcMask",null);v([M()],$r.prototype,"opStencilFail",null);v([M()],$r.prototype,"opDepthFail",null);v([M()],$r.prototype,"opStencilDepthPass",null);v([M()],$r.prototype,"mask",null);v([M()],$r.prototype,"enabled",null);var Di;(function(o){o[o.Created=1]="Created",o[o.Disposed=2]="Disposed",o[o.GetDefineNames=4]="GetDefineNames",o[o.PrepareUniformBuffer=8]="PrepareUniformBuffer",o[o.IsReadyForSubMesh=16]="IsReadyForSubMesh",o[o.PrepareDefines=32]="PrepareDefines",o[o.BindForSubMesh=64]="BindForSubMesh",o[o.PrepareEffect=128]="PrepareEffect",o[o.GetAnimatables=256]="GetAnimatables",o[o.GetActiveTextures=512]="GetActiveTextures",o[o.HasTexture=1024]="HasTexture",o[o.FillRenderTargetTextures=2048]="FillRenderTargetTextures",o[o.HasRenderTargetTextures=4096]="HasRenderTargetTextures",o[o.HardBindForSubMesh=8192]="HardBindForSubMesh"})(Di||(Di={}));class Q{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(Q.MiscDirtyFlag+Q.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(Q.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(Q.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new j),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new j),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new j),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(Q.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(Q.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case Q.WireFrameFillMode:case Q.LineListDrawMode:case Q.LineLoopDrawMode:case Q.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?Q.WireFrameFillMode:Q.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case Q.PointFillMode:case Q.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?Q.PointFillMode:Q.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(Q.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){const t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&q.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new j,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new $r,this._useUBO=!1,this._fillMode=Q.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const s=t||Ze.LastCreatedScene;s&&(this._scene=s,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||Y.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new _r(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=Q.ClockWiseSideOrientation:this.sideOrientation=Q.CounterClockWiseSideOrientation,this._uniformBuffer=new ve(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),Q.OnEventObservable.notifyObservers(this,Di.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const s=t.materialDefines;return s?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===Q.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===Q.MATERIAL_OPAQUE||this._transparencyMode===Q.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){const t=this.getScene().meshes;for(const i of t)if(i.subMeshes)for(const s of i.subMeshes)s.getMaterial()===this&&s.effect&&(s.effect._wasPreviouslyReady=!1,s.effect._wasPreviouslyUsingInstances=null,s.effect._forceRebindOnNextCall=e);e&&this.markAsDirty(Q.AllDirtyFlag)}_preBind(e,t=null){const i=this._scene.getEngine(),r=(t??this.sideOrientation)===Q.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,r,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),r}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Di.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){const s=i.effect;s&&(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),s._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,se.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){const i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(this.depthFunction!==0){const i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Di.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Di.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Di.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){const i={};if(this._serializePlugins(i),Q._parsePlugins(i,e,this._scene,t),this.pluginManager)for(const s of this.pluginManager._plugins){const r=e.pluginManager.getPlugin(s.name);s.copyTo(r)}}getBindedMeshes(){if(this.meshMap){const e=[];for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,s){const r=Object.assign({clipPlane:!1,useInstances:!1},i),n=this.getScene(),a=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const h=n.clipPlane;if(r.clipPlane&&(n.clipPlane=new Us(0,0,0,1)),this._storeEffectOnSubMeshes){let c=!0,u=null;if(e.subMeshes){const d=new Ps(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,r.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?u=d.effect.getCompilationError():(c=!1,setTimeout(l,16)))}c&&(this.allowShaderHotSwapping=a,u&&s&&s(u),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=a,t&&t(this)):setTimeout(l,16);r.clipPlane&&(n.clipPlane=h)};l()}forceCompilationAsync(e,t){return new Promise((i,s)=>{this.forceCompilation(e,()=>{i()},t,r=>{s(r)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(Q._DirtyCallbackArray.length=0,e&Q.TextureDirtyFlag&&Q._DirtyCallbackArray.push(Q._TextureDirtyCallBack),e&Q.LightDirtyFlag&&Q._DirtyCallbackArray.push(Q._LightsDirtyCallBack),e&Q.FresnelDirtyFlag&&Q._DirtyCallbackArray.push(Q._FresnelDirtyCallBack),e&Q.AttributesDirtyFlag&&Q._DirtyCallbackArray.push(Q._AttributeDirtyCallBack),e&Q.MiscDirtyFlag&&Q._DirtyCallbackArray.push(Q._MiscDirtyCallBack),e&Q.PrePassDirtyFlag&&Q._DirtyCallbackArray.push(Q._PrePassDirtyCallBack),Q._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(Q._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(i.subMeshes){for(const s of i.subMeshes)if(s.getMaterial(!1)===this)for(const r of s._drawWrappers)!r||!r.defines||!r.defines.markAllAsDirty||this._materialContext===r.materialContext&&e(r.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(Q._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(Q._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(Q._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(Q._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(Q._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(Q._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(Q._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(Q._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(Q._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(Q._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==dr.BackwardCompatible){this.checkReadyOnlyOnce=!0;const e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Di.Disposed,this._eventInfo),this._parentContainer){const r=this._parentContainer.materials.indexOf(this);r>-1&&this._parentContainer.materials.splice(r,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(const r in this.meshMap){const n=this.meshMap[r];n&&(n.material=null,this.releaseVertexArrayObject(n,e))}else{const r=s.meshes;for(const n of r)n.material===this&&!n.sourceMesh&&(n.material=null,this.releaseVertexArrayObject(n,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){const i=e.geometry;if(i)if(this._storeEffectOnSubMeshes){if(e.subMeshes)for(const s of e.subMeshes)i._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose()}else i._releaseVertexArrayObject(this._drawWrapper.effect)}serialize(){const e=Le.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(const t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return q.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const r=Y.Instantiate(e.customType).Parse(e,t,i);return r._loadedUniqueId=e.uniqueId,r}static _parsePlugins(e,t,i,s){var r;if(e.plugins)for(const n in e.plugins){const a=e.plugins[n];let l=(r=t.pluginManager)===null||r===void 0?void 0:r.getPlugin(a.name);if(!l){const h=Y.Instantiate("BABYLON."+n);h&&(l=new h(t))}l==null||l.parse(a,i,s)}}}Q.TriangleFillMode=0;Q.WireFrameFillMode=1;Q.PointFillMode=2;Q.PointListDrawMode=3;Q.LineListDrawMode=4;Q.LineLoopDrawMode=5;Q.LineStripDrawMode=6;Q.TriangleStripDrawMode=7;Q.TriangleFanDrawMode=8;Q.ClockWiseSideOrientation=0;Q.CounterClockWiseSideOrientation=1;Q.TextureDirtyFlag=1;Q.LightDirtyFlag=2;Q.FresnelDirtyFlag=4;Q.AttributesDirtyFlag=8;Q.MiscDirtyFlag=16;Q.PrePassDirtyFlag=32;Q.AllDirtyFlag=63;Q.MATERIAL_OPAQUE=0;Q.MATERIAL_ALPHATEST=1;Q.MATERIAL_ALPHABLEND=2;Q.MATERIAL_ALPHATESTANDBLEND=3;Q.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;Q.MATERIAL_NORMALBLENDMETHOD_RNM=1;Q.OnEventObservable=new j;Q._AllDirtyCallBack=o=>o.markAllAsDirty();Q._ImageProcessingDirtyCallBack=o=>o.markAsImageProcessingDirty();Q._TextureDirtyCallBack=o=>o.markAsTexturesDirty();Q._FresnelDirtyCallBack=o=>o.markAsFresnelDirty();Q._MiscDirtyCallBack=o=>o.markAsMiscDirty();Q._PrePassDirtyCallBack=o=>o.markAsPrePassDirty();Q._LightsDirtyCallBack=o=>o.markAsLightDirty();Q._AttributeDirtyCallBack=o=>o.markAsAttributesDirty();Q._FresnelAndMiscDirtyCallBack=o=>{Q._FresnelDirtyCallBack(o),Q._MiscDirtyCallBack(o)};Q._TextureAndMiscDirtyCallBack=o=>{Q._TextureDirtyCallBack(o),Q._MiscDirtyCallBack(o)};Q._DirtyCallbackArray=[];Q._RunDirtyCallBacks=o=>{for(const e of Q._DirtyCallbackArray)e(o)};v([M()],Q.prototype,"id",void 0);v([M()],Q.prototype,"uniqueId",void 0);v([M()],Q.prototype,"name",void 0);v([M()],Q.prototype,"metadata",void 0);v([M()],Q.prototype,"checkReadyOnEveryCall",void 0);v([M()],Q.prototype,"checkReadyOnlyOnce",void 0);v([M()],Q.prototype,"state",void 0);v([M("alpha")],Q.prototype,"_alpha",void 0);v([M("backFaceCulling")],Q.prototype,"_backFaceCulling",void 0);v([M("cullBackFaces")],Q.prototype,"_cullBackFaces",void 0);v([M()],Q.prototype,"sideOrientation",void 0);v([M("alphaMode")],Q.prototype,"_alphaMode",void 0);v([M()],Q.prototype,"_needDepthPrePass",void 0);v([M()],Q.prototype,"disableDepthWrite",void 0);v([M()],Q.prototype,"disableColorWrite",void 0);v([M()],Q.prototype,"forceDepthWrite",void 0);v([M()],Q.prototype,"depthFunction",void 0);v([M()],Q.prototype,"separateCullingPass",void 0);v([M("fogEnabled")],Q.prototype,"_fogEnabled",void 0);v([M()],Q.prototype,"pointSize",void 0);v([M()],Q.prototype,"zOffset",void 0);v([M()],Q.prototype,"zOffsetUnits",void 0);v([M()],Q.prototype,"pointsCloud",null);v([M()],Q.prototype,"fillMode",null);v([M()],Q.prototype,"useLogarithmicDepth",null);v([M()],Q.prototype,"transparencyMode",null);class Ih{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let s=0;s<i.meshes.length;s++){const r=i.meshes[s];if(!r.material){!this._mesh.material&&r.computeBonesUsingShaders&&r.numBoneInfluencers>0&&(r.computeBonesUsingShaders=!1);continue}if(!(!r.computeBonesUsingShaders||r.numBoneInfluencers===0)){if(r.material.getEffect()===t)r.computeBonesUsingShaders=!1;else if(r.subMeshes){for(const n of r.subMeshes)if(n.effect===t){r.computeBonesUsingShaders=!1;break}}}}}else{const i=this._defines[this._currentRank];if(i)for(let s=0;s<i.length;s++)e=e.replace("#define "+i[s],"");this._currentRank++}return e}}class Ph extends Q{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new L,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){const t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t,t&&(t._forceRebindOnNextCall=!1)}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}const rd={effect:null,subMesh:null};class Rs extends Ph{constructor(e,t,i,s={},r=!0){super(e,t,r),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new L,this._cachedWorldViewProjectionMatrix=new L,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options=Object.assign({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},s)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(t.length*16);for(let s=0;s<t.length;s++)t[s].copyToArray(i,s*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){const i=e.trimEnd()+" ",s=this.options.defines.findIndex(r=>r===e||r.startsWith(i));return s>=0&&this.options.defines.splice(s,1),(typeof t!="boolean"||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var s,r,n,a;const l=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(l){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const N=this._drawWrapper.effect;if(N&&N._wasPreviouslyReady&&N._wasPreviouslyUsingInstances===t)return!0}const h=this.getScene(),c=h.getEngine(),u=[],d=[],f=new Ih;let p=this._shaderPath,_=this._options.uniforms,g=this._options.uniformBuffers,E=this._options.samplers;c.getCaps().multiview&&h.activeCamera&&h.activeCamera.outputRenderTarget&&h.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,u.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(let N=0;N<this._options.defines.length;N++){const w=this._options.defines[N].indexOf("#define")===0?this._options.defines[N]:`#define ${this._options.defines[N]}`;u.push(w)}for(let N=0;N<this._options.attributes.length;N++)d.push(this._options.attributes[N]);if(e&&e.isVerticesDataPresent(T.ColorKind)&&(d.indexOf(T.ColorKind)===-1&&d.push(T.ColorKind),u.push("#define VERTEXCOLOR")),t&&(u.push("#define INSTANCES"),se.PushAttributesForInstances(d,this._materialHelperNeedsPreviousMatrices),e!=null&&e.hasThinInstances&&(u.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(T.ColorInstanceKind)&&(d.push(T.ColorInstanceKind),u.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(T.MatricesIndicesKind),d.push(T.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(T.MatricesIndicesExtraKind),d.push(T.MatricesWeightsExtraKind));const N=e.skeleton;u.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),f.addCPUSkinningFallback(0,e),N.isUsingTextureForMatrices?(u.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(u.push("#define BonesPerMesh "+(N.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else u.push("#define NUM_BONE_INFLUENCERS 0");let R=0;const x=e?e.morphTargetManager:null;if(x){const N=x.supportsUVs&&u.indexOf("#define UV1")!==-1,w=x.supportsTangents&&u.indexOf("#define TANGENT")!==-1,G=x.supportsNormals&&u.indexOf("#define NORMAL")!==-1;R=x.numInfluencers,N&&u.push("#define MORPHTARGETS_UV"),w&&u.push("#define MORPHTARGETS_TANGENT"),G&&u.push("#define MORPHTARGETS_NORMAL"),R>0&&u.push("#define MORPHTARGETS"),x.isUsingTextureForTargets&&(u.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),u.push("#define NUM_MORPH_INFLUENCERS "+R);for(let k=0;k<R;k++)d.push(T.PositionKind+k),G&&d.push(T.NormalKind+k),w&&d.push(T.TangentKind+k),N&&d.push(T.UVKind+"_"+k);R>0&&(_=_.slice(),_.push("morphTargetInfluences"),_.push("morphTargetTextureInfo"),_.push("morphTargetTextureIndices"))}else u.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const N=e.bakedVertexAnimationManager;N&&N.isEnabled&&(u.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),se.PrepareAttributesForBakedVertexAnimation(d,e,u)}for(const N in this._textures)if(!this._textures[N].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&u.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(In(_),Mh(this,h,u)),this._useLogarithmicDepth&&(u.push("#define LOGARITHMICDEPTH"),this._options.uniforms.indexOf("logarithmicDepthConstant")===-1&&this._options.uniforms.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(_=_.slice(),g=g.slice(),E=E.slice(),p=this.customShaderNameResolve(p,_,g,E,u,d));const S=l?i._getDrawWrapper():this._drawWrapper,b=(s=S==null?void 0:S.effect)!==null&&s!==void 0?s:null,y=(r=S==null?void 0:S.defines)!==null&&r!==void 0?r:null,I=u.join(`
`);let O=b;return y!==I&&(O=c.createEffect(p,{attributes:d,uniformsNames:_,uniformBuffersNames:g,samplers:E,defines:I,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:R},shaderLanguage:this._options.shaderLanguage},c),l?i.setEffect(O,I,this._materialContext):S&&S.setEffect(O,I),this._onEffectCreatedObservable&&(rd.effect=O,rd.subMesh=(n=i??(e==null?void 0:e.subMeshes[0]))!==null&&n!==void 0?n:null,this._onEffectCreatedObservable.notifyObservers(rd))),O._wasPreviouslyUsingInstances=!!t,!((a=!(O!=null&&O.isReady()))!==null&&a!==void 0)||a?!1:(b!==O&&h.resetCachedMaterial(),O._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),s=t??this.getEffect();s&&(this._options.uniforms.indexOf("world")!==-1&&s.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),s.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),s.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var s;this.bind(e,t,(s=i._drawWrapperOverride)===null||s===void 0?void 0:s.effect,i)}bind(e,t,i,s){var r;const n=s&&this._storeEffectOnSubMeshes,a=i??(n?s.effect:this.getEffect());if(!a)return;const l=this.getScene();this._activeEffect=a,this.bindOnlyWorldMatrix(e,i);const h=this._options.uniformBuffers;let c=!1;if(a&&h&&h.length>0&&l.getEngine().supportsUniformBuffers)for(let d=0;d<h.length;++d)switch(h[d]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e));break;case"Scene":se.BindSceneUniformBuffer(a,l.getSceneUniformBuffer()),l.finalizeSceneUbo(),c=!0;break}const u=t&&n?this._mustRebind(l,a,t.visibility):l.getCachedMaterial()!==this;if(a&&u){!c&&this._options.uniforms.indexOf("view")!==-1&&a.setMatrix("view",l.getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&a.setMatrix("projection",l.getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(a.setMatrix("viewProjection",l.getTransformMatrix()),this._multiview&&a.setMatrix("viewProjectionR",l._transformMatrixR)),l.activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&a.setVector3("cameraPosition",l.activeCamera.globalPosition),se.BindBonesParameters(t,a),Pn(a,this,l),this._useLogarithmicDepth&&se.BindLogDepth(n?s.materialDefines:a.defines,a,l);let d;for(d in this._textures)a.setTexture(d,this._textures[d]);for(d in this._textureArrays)a.setTextureArray(d,this._textureArrays[d]);for(d in this._externalTextures)a.setExternalTexture(d,this._externalTextures[d]);for(d in this._ints)a.setInt(d,this._ints[d]);for(d in this._uints)a.setUInt(d,this._uints[d]);for(d in this._floats)a.setFloat(d,this._floats[d]);for(d in this._floatsArrays)a.setArray(d,this._floatsArrays[d]);for(d in this._colors3)a.setColor3(d,this._colors3[d]);for(d in this._colors3Arrays)a.setArray3(d,this._colors3Arrays[d]);for(d in this._colors4){const f=this._colors4[d];a.setFloat4(d,f.r,f.g,f.b,f.a)}for(d in this._colors4Arrays)a.setArray4(d,this._colors4Arrays[d]);for(d in this._vectors2)a.setVector2(d,this._vectors2[d]);for(d in this._vectors3)a.setVector3(d,this._vectors3[d]);for(d in this._vectors4)a.setVector4(d,this._vectors4[d]);for(d in this._quaternions)a.setQuaternion(d,this._quaternions[d]);for(d in this._matrices)a.setMatrix(d,this._matrices[d]);for(d in this._matrixArrays)a.setMatrices(d,this._matrixArrays[d]);for(d in this._matrices3x3)a.setMatrix3x3(d,this._matrices3x3[d]);for(d in this._matrices2x2)a.setMatrix2x2(d,this._matrices2x2[d]);for(d in this._vectors2Arrays)a.setArray2(d,this._vectors2Arrays[d]);for(d in this._vectors3Arrays)a.setArray3(d,this._vectors3Arrays[d]);for(d in this._vectors4Arrays)a.setArray4(d,this._vectors4Arrays[d]);for(d in this._quaternionsArrays)a.setArray4(d,this._quaternionsArrays[d]);for(d in this._uniformBuffers){const f=this._uniformBuffers[d].getBuffer();f&&a.bindUniformBuffer(f,d)}for(d in this._textureSamplers)a.setTextureSampler(d,this._textureSamplers[d]);for(d in this._storageBuffers)a.setStorageBuffer(d,this._storageBuffers[d])}if(a&&t&&(u||!this.isFrozen)){const d=t.morphTargetManager;d&&d.numInfluencers>0&&se.BindMorphTargetParameters(t,a);const f=t.bakedVertexAnimationManager;f&&f.isEnabled&&((r=t.bakedVertexAnimationManager)===null||r===void 0||r.bind(a,!!a._wasPreviouslyUsingInstances))}this._afterBind(t,a)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.push(i[s])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let s=0;s<i.length;s++)if(i[s]===e)return!0}return!1}clone(e){const t=Le.Clone(()=>new Rs(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath=Object.assign({},t._shaderPath)),this._options=Object.assign({},this._options),Object.keys(this._options).forEach(i=>{const s=this._options[i];Array.isArray(s)&&(this._options[i]=s.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._uints)t.setUInt(i,this._uints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let s;for(s in this._textures)this._textures[s].dispose();for(s in this._textureArrays){const r=this._textureArrays[s];for(let n=0;n<r.length;n++)r[n].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=Le.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.textureArrays[t].push(i[s].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.FloatArrays={};for(t in this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();e.vectors3={};for(t in this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();e.vectors4={};for(t in this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const s=Le.Parse(()=>new Rs(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let r;e.stencil&&s.stencil.parse(e.stencil,t,i);for(r in e.textures)s.setTexture(r,V.Parse(e.textures[r],t,i));for(r in e.textureArrays){const n=e.textureArrays[r],a=[];for(let l=0;l<n.length;l++)a.push(V.Parse(n[l],t,i));s.setTextureArray(r,a)}for(r in e.ints)s.setInt(r,e.ints[r]);for(r in e.uints)s.setUInt(r,e.uints[r]);for(r in e.floats)s.setFloat(r,e.floats[r]);for(r in e.floatsArrays)s.setFloats(r,e.floatsArrays[r]);for(r in e.colors3)s.setColor3(r,J.FromArray(e.colors3[r]));for(r in e.colors3Arrays){const n=e.colors3Arrays[r].reduce((a,l,h)=>(h%3===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>J.FromArray(a));s.setColor3Array(r,n)}for(r in e.colors4)s.setColor4(r,He.FromArray(e.colors4[r]));for(r in e.colors4Arrays){const n=e.colors4Arrays[r].reduce((a,l,h)=>(h%4===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>He.FromArray(a));s.setColor4Array(r,n)}for(r in e.vectors2)s.setVector2(r,Ke.FromArray(e.vectors2[r]));for(r in e.vectors3)s.setVector3(r,m.FromArray(e.vectors3[r]));for(r in e.vectors4)s.setVector4(r,ut.FromArray(e.vectors4[r]));for(r in e.quaternions)s.setQuaternion(r,le.FromArray(e.quaternions[r]));for(r in e.matrices)s.setMatrix(r,L.FromArray(e.matrices[r]));for(r in e.matrixArray)s._matrixArrays[r]=new Float32Array(e.matrixArray[r]);for(r in e.matrices3x3)s.setMatrix3x3(r,e.matrices3x3[r]);for(r in e.matrices2x2)s.setMatrix2x2(r,e.matrices2x2[r]);for(r in e.vectors2Arrays)s.setArray2(r,e.vectors2Arrays[r]);for(r in e.vectors3Arrays)s.setArray3(r,e.vectors3Arrays[r]);for(r in e.vectors4Arrays)s.setArray4(r,e.vectors4Arrays[r]);for(r in e.quaternionsArrays)s.setArray4(r,e.quaternionsArrays[r]);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise((r,n)=>{const a=new Pi;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){const l=JSON.parse(a.responseText),h=this.Parse(l,i||Ze.LastCreatedScene,s);e&&(h.name=e),r(h)}else n("Unable to load the ShaderMaterial")}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((s,r)=>{const n=new Pi;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const a=JSON.parse(JSON.parse(n.responseText).jsonPayload),l=JSON.parse(a.shaderMaterial),h=this.Parse(l,t||Ze.LastCreatedScene,i);h.snippetId=e,s(h)}else r("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}Rs.SnippetUrl="https://snippet.babylonjs.com";Rs.CreateFromSnippetAsync=Rs.ParseFromSnippetAsync;Re("BABYLON.ShaderMaterial",Rs);class _i{static get ForceFullSceneLoadingForIncremental(){return _i._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){_i._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return _i._ShowLoadingScreen}static set ShowLoadingScreen(e){_i._ShowLoadingScreen=e}static get loggingLevel(){return _i._LoggingLevel}static set loggingLevel(e){_i._LoggingLevel=e}static get CleanBoneMatrixWeights(){return _i._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){_i._CleanBoneMatrixWeights=e}}_i._ForceFullSceneLoadingForIncremental=!1;_i._ShowLoadingScreen=!0;_i._CleanBoneMatrixWeights=!1;_i._LoggingLevel=0;class Ai{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new Ai(Ai.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,s=!1,r=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||Ze.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=s,i?this.setAllVerticesData(i,s):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,s){i&&Array.isArray(t)&&(t=new Float32Array(t));const r=new T(this._engine,t,e,{updatable:i,postponeInternalCreation:this._meshes.length===0,stride:s,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(r)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const s=e.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[s]=e;const r=this._meshes,n=r.length;if(s===T.PositionKind){this._totalVertices=t??e.totalVertices,this._updateExtend(e.getFloatData()),this._resetPointsArrayCache();const a=this._extend&&this._extend.minimum||new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l=this._extend&&this._extend.maximum||new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let h=0;h<n;h++){const c=r[h];c.buildBoundingInfo(a,l),c._createGlobalSubMesh(c.isUnIndexed),c.computeWorldMatrix(!0),c.synchronizeInstances()}}this._notifyUpdate(s)}updateVerticesDataDirectly(e,t,i,s=!1){const r=this.getVertexBuffer(e);r&&(r.updateDirectly(t,i,s),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const s=this.getVertexBuffer(e);s&&(s.update(t),e===T.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const s of i){s.hasBoundingInfo?s.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):s.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const r=s.subMeshes;for(const n of r)n.refreshBoundingInfo()}}}_bind(e,t,i,s){if(!e)return;t===void 0&&(t=this._indexBuffer);const r=this.getVertexBuffers();if(!r)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!s){this._engine.bindBuffers(r,t,e,i);return}const n=s||this._vertexArrayObjects;n[e.key]||(n[e.key]=this._engine.recordVertexArrayObject(r,t,e,i)),this._engine.bindVertexArrayObject(n[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const s=this.getVertexBuffer(e);return s?s.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const s=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),s)for(const r of this._meshes)r._createGlobalSubMesh(!0)}}setIndexBuffer(e,t,i){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,e.is32Bits||(e.is32Bits=this._totalIndices>65535);for(const s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),t!=null&&(this._totalVertices=t);for(const s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._totalIndices!==void 0?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,s=i.indexOf(e);s!==-1&&(i.splice(s,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(T.PositionKind),!e))return;this._extend=Hm(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===T.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const s=this._meshes,r=s.length;for(let n=0;n<r;n++)this._applyToMesh(s[n]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let s=0;s<e.length;s+=3){const r=e[s+0];e[s+0]=e[s+2],e[s+2]=r}this.setIndices(e)}const t=this.getVerticesData(T.PositionKind,!1);if(t!=null&&t.length>0){for(let s=0;s<t.length;s+=3)t[s+2]=-t[s+2];this.setVerticesData(T.PositionKind,t,!1)}const i=this.getVerticesData(T.NormalKind,!1);if(i!=null&&i.length>0){for(let s=0;s<i.length;s+=3)i[s+2]=-i[s+2];this.setVerticesData(T.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(T.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=m.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const s in this._vertexBuffers)this._vertexBuffers[s].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const s=this._parentContainer.geometries.indexOf(this);s>-1&&this._parentContainer.geometries.splice(s,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new fe;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let s=!1,r=!1,n;for(n in this._vertexBuffers){const l=this.getVerticesData(n);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),n):t.set(l.slice(0),n),!r)){const h=this.getVertexBuffer(n);h&&(s=h.isUpdatable(),r=!s)}}const a=new Ai(e,this._scene,t,s);a.delayLoadState=this.delayLoadState,a.delayLoadingFile=this.delayLoadingFile,a._delayLoadingFunction=this._delayLoadingFunction;for(n in this._delayInfo)a._delayInfo=a._delayInfo||[],a._delayInfo.push(n);return a._boundingInfo=new hs(this._extend.minimum,this._extend.maximum),a}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,ot&&ot.HasTags(this)&&(e.tags=ot.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(T.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(T.PositionKind)),this.isVertexBufferUpdatable(T.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(T.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(T.NormalKind)),this.isVertexBufferUpdatable(T.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(T.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(T.TangentKind)),this.isVertexBufferUpdatable(T.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(T.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(T.UVKind)),this.isVertexBufferUpdatable(T.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(T.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(T.UV2Kind)),this.isVertexBufferUpdatable(T.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(T.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(T.UV3Kind)),this.isVertexBufferUpdatable(T.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(T.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(T.UV4Kind)),this.isVertexBufferUpdatable(T.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(T.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(T.UV5Kind)),this.isVertexBufferUpdatable(T.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(T.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(T.UV6Kind)),this.isVertexBufferUpdatable(T.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(T.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(T.ColorKind)),this.isVertexBufferUpdatable(T.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(T.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(T.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(T.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(T.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(T.MatricesWeightsKind)),this.isVertexBufferUpdatable(T.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return Y.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),s=e.geometryUniqueId,r=e.geometryId;if(s||r){const n=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(r);n&&n.applyToMesh(t)}else if(e instanceof ArrayBuffer){const n=t._binaryInfo;if(n.positionsAttrDesc&&n.positionsAttrDesc.count>0){const a=new Float32Array(e,n.positionsAttrDesc.offset,n.positionsAttrDesc.count);t.setVerticesData(T.PositionKind,a,!1)}if(n.normalsAttrDesc&&n.normalsAttrDesc.count>0){const a=new Float32Array(e,n.normalsAttrDesc.offset,n.normalsAttrDesc.count);t.setVerticesData(T.NormalKind,a,!1)}if(n.tangetsAttrDesc&&n.tangetsAttrDesc.count>0){const a=new Float32Array(e,n.tangetsAttrDesc.offset,n.tangetsAttrDesc.count);t.setVerticesData(T.TangentKind,a,!1)}if(n.uvsAttrDesc&&n.uvsAttrDesc.count>0){const a=new Float32Array(e,n.uvsAttrDesc.offset,n.uvsAttrDesc.count);if(Dt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UVKind,a,!1)}if(n.uvs2AttrDesc&&n.uvs2AttrDesc.count>0){const a=new Float32Array(e,n.uvs2AttrDesc.offset,n.uvs2AttrDesc.count);if(Dt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV2Kind,a,!1)}if(n.uvs3AttrDesc&&n.uvs3AttrDesc.count>0){const a=new Float32Array(e,n.uvs3AttrDesc.offset,n.uvs3AttrDesc.count);if(Dt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV3Kind,a,!1)}if(n.uvs4AttrDesc&&n.uvs4AttrDesc.count>0){const a=new Float32Array(e,n.uvs4AttrDesc.offset,n.uvs4AttrDesc.count);if(Dt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV4Kind,a,!1)}if(n.uvs5AttrDesc&&n.uvs5AttrDesc.count>0){const a=new Float32Array(e,n.uvs5AttrDesc.offset,n.uvs5AttrDesc.count);if(Dt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV5Kind,a,!1)}if(n.uvs6AttrDesc&&n.uvs6AttrDesc.count>0){const a=new Float32Array(e,n.uvs6AttrDesc.offset,n.uvs6AttrDesc.count);if(Dt.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV6Kind,a,!1)}if(n.colorsAttrDesc&&n.colorsAttrDesc.count>0){const a=new Float32Array(e,n.colorsAttrDesc.offset,n.colorsAttrDesc.count);t.setVerticesData(T.ColorKind,a,!1,n.colorsAttrDesc.stride)}if(n.matricesIndicesAttrDesc&&n.matricesIndicesAttrDesc.count>0){const a=new Int32Array(e,n.matricesIndicesAttrDesc.offset,n.matricesIndicesAttrDesc.count),l=[];for(let h=0;h<a.length;h++){const c=a[h];l.push(c&255),l.push((c&65280)>>8),l.push((c&16711680)>>16),l.push(c>>24&255)}t.setVerticesData(T.MatricesIndicesKind,l,!1)}if(n.matricesIndicesExtraAttrDesc&&n.matricesIndicesExtraAttrDesc.count>0){const a=new Int32Array(e,n.matricesIndicesExtraAttrDesc.offset,n.matricesIndicesExtraAttrDesc.count),l=[];for(let h=0;h<a.length;h++){const c=a[h];l.push(c&255),l.push((c&65280)>>8),l.push((c&16711680)>>16),l.push(c>>24&255)}t.setVerticesData(T.MatricesIndicesExtraKind,l,!1)}if(n.matricesWeightsAttrDesc&&n.matricesWeightsAttrDesc.count>0){const a=new Float32Array(e,n.matricesWeightsAttrDesc.offset,n.matricesWeightsAttrDesc.count);t.setVerticesData(T.MatricesWeightsKind,a,!1)}if(n.indicesAttrDesc&&n.indicesAttrDesc.count>0){const a=new Int32Array(e,n.indicesAttrDesc.offset,n.indicesAttrDesc.count);t.setIndices(a,null)}if(n.subMeshesAttrDesc&&n.subMeshesAttrDesc.count>0){const a=new Int32Array(e,n.subMeshesAttrDesc.offset,n.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<n.subMeshesAttrDesc.count;l++){const h=a[l*5+0],c=a[l*5+1],u=a[l*5+2],d=a[l*5+3],f=a[l*5+4];Ps.AddToMesh(h,c,u,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(T.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(T.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(T.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(T.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(T.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(T.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(T.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(T.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(T.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(T.ColorKind,He.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(T.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const n=[];for(let a=0;a<e.matricesIndices.length;a++){const l=e.matricesIndices[a];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(T.MatricesIndicesKind,n,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(T.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const n=[];for(let a=0;a<e.matricesIndicesExtra.length;a++){const l=e.matricesIndicesExtra[a];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(T.MatricesIndicesExtraKind,n,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(Ai._CleanMatricesWeights(e,t),t.setVerticesData(T.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(T.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let n=0;n<e.subMeshes.length;n++){const a=e.subMeshes[n];Ps.AddToMesh(a.materialIndex,a.verticesStart,a.verticesCount,a.indexStart,a.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!_i.CleanBoneMatrixWeights)return;let s=0;if(e.skeletonId>-1){const u=t.getScene().getLastSkeletonById(e.skeletonId);if(!u)return;s=u.bones.length}else return;const r=t.getVerticesData(T.MatricesIndicesKind),n=t.getVerticesData(T.MatricesIndicesExtraKind),a=e.matricesWeights,l=e.matricesWeightsExtra,h=e.numBoneInfluencer,c=a.length;for(let u=0;u<c;u+=4){let d=0,f=-1;for(let p=0;p<4;p++){const _=a[u+p];d+=_,_<.001&&f<0&&(f=p)}if(l)for(let p=0;p<4;p++){const _=l[u+p];d+=_,_<.001&&f<0&&(f=p+4)}if((f<0||f>h-1)&&(f=h-1),d>.001){const p=1/d;for(let _=0;_<4;_++)a[u+_]*=p;if(l)for(let _=0;_<4;_++)l[u+_]*=p}else f>=4?(l[u+f-4]=1-d,n[u+f-4]=s):(a[u+f]=1-d,r[u+f]=s)}t.setVerticesData(T.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(T.MatricesIndicesExtraKind,n)}static Parse(e,t,i){const s=new Ai(e.id,t,void 0,e.updatable);return s._loadedUniqueId=e.uniqueId,ot&&ot.AddTagsTo(s,e.tags),e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s._boundingInfo=new hs(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(T.UVKind),e.hasUVs2&&s._delayInfo.push(T.UV2Kind),e.hasUVs3&&s._delayInfo.push(T.UV3Kind),e.hasUVs4&&s._delayInfo.push(T.UV4Kind),e.hasUVs5&&s._delayInfo.push(T.UV5Kind),e.hasUVs6&&s._delayInfo.push(T.UV6Kind),e.hasColors&&s._delayInfo.push(T.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(T.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(T.MatricesWeightsKind),s._delayLoadingFunction=fe.ImportVertexData):fe.ImportVertexData(e,s),t.pushGeometry(s,!0),s}}class aa extends Q{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){const t=e.push;e.push=(...s)=>{const r=t.apply(e,s);return this._markAllSubMeshesAsTexturesDirty(),r};const i=e.splice;e.splice=(s,r)=>{const n=i.apply(e,[s,r]);return this._markAllSubMeshesAsTexturesDirty(),n}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(!((t=this.subMaterials[i])===null||t===void 0)&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let s=0;s<this.subMaterials.length;s++){const r=this.subMaterials[s];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,i))return!1;continue}if(!r.isReady(e))return!1}}return!0}clone(e,t){const i=new aa(e,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let r=null;const n=this.subMaterials[s];t&&n?r=n.clone(e+"-"+n.name):r=this.subMaterials[s],i.subMaterials.push(r)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,ot&&(e.tags=ot.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const s=this.getScene();if(!s)return;if(i)for(let n=0;n<this.subMaterials.length;n++){const a=this.subMaterials[n];a&&a.dispose(e,t)}const r=s.multiMaterials.indexOf(this);r>=0&&s.multiMaterials.splice(r,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new aa(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,ot&&ot.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(s=>i.subMaterials.push(t.getLastMaterialById(s))),i}}Re("BABYLON.MultiMaterial",aa);class eS{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class tS{}class iS{constructor(){this.visibleInstances={},this.batchCache=new Eg,this.batchCacheReplacementModeInFrozenMode=new Eg,this.instancesBufferSize=32*16*4}}class Eg{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}}class sS{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class rS{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}}class re extends pi{static _GetDefaultSideOrientation(e){return e||re.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(T.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(T.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new j),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new j),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new j),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new j),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new j),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,s=null,r,n=!0){if(super(e,t),this._internalMeshDataInfo=new rS,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new iS,this._thinInstanceDataStorage=new sS,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=re.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(a,l,h)=>{a&&h&&(this._uniformBuffer?this.transferToEffect(l):h.bindOnlyWorldMatrix(l))},s){if(s._geometry&&s._geometry.applyToMesh(this),Yc.DeepCopy(s,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=s,t.useClonedMeshMap&&(s._internalMeshDataInfo.meshMap||(s._internalMeshDataInfo.meshMap={}),s._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=s._originalBuilderSideOrientation,this._creationDataStorage=s._creationDataStorage,s._ranges){const a=s._ranges;for(const l in a)Object.prototype.hasOwnProperty.call(a,l)&&a[l]&&this.createAnimationRange(l,a[l].from,a[l].to)}if(s.metadata&&s.metadata.clone?this.metadata=s.metadata.clone():this.metadata=s.metadata,this._internalMetadata=s._internalMetadata,ot&&ot.HasTags(s)&&ot.AddTagsTo(this,ot.GetTags(s,!0)),this.setEnabled(s.isEnabled(!1)),this.parent=s.parent,this.setPivotMatrix(s.getPivotMatrix()),this.id=e+"."+s.id,this.material=s.material,!r){const a=s.getDescendants(!0);for(let l=0;l<a.length;l++){const h=a[l];h.clone&&h.clone(e+"."+h.name,this)}}if(s.morphTargetManager&&(this.morphTargetManager=s.morphTargetManager),t.getPhysicsEngine){const a=t.getPhysicsEngine();if(n&&a)if(a.getPluginVersion()===1){const l=a.getImpostorForPhysicsObject(s);l&&(this.physicsImpostor=l.clone(this))}else a.getPluginVersion()===2&&s.physicsBody&&s.physicsBody.clone(this)}for(let a=0;a<t.particleSystems.length;a++){const l=t.particleSystems[a];l.emitter===s&&l.clone(l.name,this)}this.skeleton=s.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=a=>{a.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new j(this._internalMeshDataInfo._onMeshReadyObserverAdded),s&&s.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){const s=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const r of this.getChildTransformNodes(!0))r.getClassName()==="InstancedMesh"&&s.getClassName()==="Mesh"&&r.sourceMesh===this?r.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:s},i):r.instantiateHierarchy(s,t,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),s=this.getVerticesData(T.PositionKind);s&&i&&(t+=", flat shading: "+(s.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return q.Warn("You cannot use a mesh as LOD level twice"),this;const i=new eS(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;const s=t||this.getBoundingInfo().boundingSphere,r=e.mode===De.ORTHOGRAPHIC_CAMERA?e.minZ:s.centerWorld.subtract(e.globalPosition).length();let n=r,a=1;if(i._useLODScreenCoverage){const l=e.screenArea;let h=s.radiusWorld*e.minZ/r;h=h*h*Math.PI,n=h/l,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*n)return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this;for(let l=0;l<i._LODLevels.length;l++){const h=i._LODLevels[l];if(a*h.distanceOrScreenCoverage<a*n){if(h.mesh){if(h.mesh.delayLoadState===4)return h.mesh._checkDelayState(),this;if(h.mesh.delayLoadState===2)return this;h.mesh._preActivate(),h.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,h.mesh),h.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(n,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,s){var r,n;if(!this._geometry)return null;let a=s||(n=(r=this._userInstancedBuffersStorage)===null||r===void 0?void 0:r.vertexBuffers[e])===null||n===void 0?void 0:n.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return a||(a=this._geometry.getVerticesData(e,t,i)),a}getVertexBuffer(e,t){var i,s;return this._geometry?(s=t||(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==null&&s!==void 0?s:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){var i;return this._geometry?!t&&((i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){var i;if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){const s=(i=this._userInstancedBuffersStorage)===null||i===void 0?void 0:i.vertexBuffers[e];if(s)return s.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){const i=[];return this._delayInfo&&this._delayInfo.forEach(function(s){i.push(s)}),i}const t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(const i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var i,s,r,n,a,l,h;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const c=this.getEngine(),u=this.getScene(),d=t||c.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const f=this.material||u.defaultMaterial;if(f){if(f._storeEffectOnSubMeshes)for(const _ of this.subMeshes){const g=_.getMaterial();if(g){if(g._storeEffectOnSubMeshes){if(!g.isReadyForSubMesh(this,_,d))return!1}else if(!g.isReady(this,d))return!1}}else if(!f.isReady(this,d))return!1}const p=c.currentRenderPassId;for(const _ of this.lightSources){const g=_.getShadowGenerators();if(!g)continue;const E=g.values();for(let R=E.next();R.done!==!0;R=E.next()){const x=R.value;if(x&&(!(!((i=x.getShadowMap())===null||i===void 0)&&i.renderList)||!((s=x.getShadowMap())===null||s===void 0)&&s.renderList&&((n=(r=x.getShadowMap())===null||r===void 0?void 0:r.renderList)===null||n===void 0?void 0:n.indexOf(this))!==-1)){const b=(a=x.getShadowMap().renderPassIds)!==null&&a!==void 0?a:[c.currentRenderPassId];for(let y=0;y<b.length;++y){c.currentRenderPassId=b[y];for(const I of this.subMeshes)if(!x.isReady(I,d,(h=(l=I.getMaterial())===null||l===void 0?void 0:l.needAlphaBlendingForMesh(this))!==null&&h!==void 0?h:!1))return c.currentRenderPassId=p,!1}c.currentRenderPassId=p}}}for(const _ of this._internalMeshDataInfo._LODLevels)if(_.mesh&&!_.mesh.isReady(d))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let r=!1;if(e)r=!0;else for(const n of this.subMeshes){if(n.indexStart+n.indexCount>s){r=!0;break}if(n.verticesStart+n.verticesCount>t){r=!0;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new Ps(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let r=0;r<e&&!(s>=t);r++)Ps.CreateFromIndices(0,s,r===e-1?t-s:i,this,void 0,!1),s+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else{const r=new fe;r.set(t,e);const n=this.getScene();new Ai(Ai.RandomId(),n,r,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Ai.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(T.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(T.PositionKind,i,!1,!1),t){const s=this.getIndices(),r=this.getVerticesData(T.NormalKind);if(!r)return this;fe.ComputeNormals(i,s,r),this.updateVerticesData(T.NormalKind,r,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,t=this._geometry.copy(Ai.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i){let s=this._geometry;s||(s=new Ai(Ai.RandomId(),this.getScene(),void 0,void 0,this)),s.setIndexBuffer(e,t,i)}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const s=new fe;s.indices=e;const r=this.getScene();new Ai(Ai.RandomId(),r,s,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,s=!0){if(!this._geometry)return this;const r=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t);let n;if(this._unIndexed)n=null;else switch(this._getRenderingFillMode(i)){case Q.PointFillMode:n=null;break;case Q.WireFrameFillMode:n=e._getLinesIndexBuffer(this.getIndices(),r);break;default:case Q.TriangleFillMode:n=this._geometry.getIndexBuffer();break}return!s||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,n):this._geometry._bind(t,n,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const r=this.getScene().getEngine();return this._unIndexed||t==Q.PointFillMode?r.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==Q.WireFrameFillMode?r.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):r.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),s=i._isInIntermediateRendering(),r=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,n=this._instanceDataStorage.batchCache;if(n.mustReturn=!1,n.renderSelf[e]=t||!r&&this.isEnabled()&&this.isVisible,n.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const a=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),h=s?a.intermediateDefaultRenderId:a.defaultRenderId;n.visibleInstances[e]=a[l],!n.visibleInstances[e]&&h&&(n.visibleInstances[e]=a[h])}return n.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&n.visibleInstances[e]!==null&&n.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=n,n}_renderWithInstances(e,t,i,s,r){var n;const a=i.visibleInstances[e._id],l=a?a.length:0,h=this._instanceDataStorage,c=h.instancesBufferSize;let u=h.instancesBuffer,d=h.instancesPreviousBuffer;const p=(l+1)*16*4;for(;h.instancesBufferSize<p;)h.instancesBufferSize*=2;(!h.instancesData||c!=h.instancesBufferSize)&&(h.instancesData=new Float32Array(h.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousData||c!=h.instancesBufferSize)&&(h.instancesPreviousData=new Float32Array(h.instancesBufferSize/4));let _=0,g=0;const E=i.renderSelf[e._id],R=!u||c!==h.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!h.isFrozen||R)){const x=this.getWorldMatrix();if(E&&(this._scene.needsPreviousWorldMatrices&&(h.masterMeshPreviousWorldMatrix?(h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,_),h.masterMeshPreviousWorldMatrix.copyFrom(x)):(h.masterMeshPreviousWorldMatrix=x.clone(),h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,_))),x.copyToArray(h.instancesData,_),_+=16,g++),a){if(re.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(!((n=e.getMaterial())===null||n===void 0)&&n.needAlphaBlendingForMesh(e.getRenderingMesh()))){const S=this._scene.activeCamera.globalPosition;for(let b=0;b<a.length;b++){const y=a[b];y._distanceToCamera=m.Distance(y.getBoundingInfo().boundingSphere.centerWorld,S)}a.sort((b,y)=>b._distanceToCamera>y._distanceToCamera?-1:b._distanceToCamera<y._distanceToCamera?1:0)}for(let S=0;S<a.length;S++){const b=a[S],y=b.getWorldMatrix();y.copyToArray(h.instancesData,_),this._scene.needsPreviousWorldMatrices&&(b._previousWorldMatrix?(b._previousWorldMatrix.copyToArray(h.instancesPreviousData,_),b._previousWorldMatrix.copyFrom(y)):(b._previousWorldMatrix=y.clone(),b._previousWorldMatrix.copyToArray(h.instancesPreviousData,_))),_+=16,g++}}}else g=(E?1:0)+l;return R?(u&&u.dispose(),d&&d.dispose(),u=new eo(r,h.instancesData,!0,16,!1,!0),h.instancesBuffer=u,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=u.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=u.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=u.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=u.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new eo(r,h.instancesPreviousData,!0,16,!1,!0),h.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(u.updateDirectly(h.instancesData,0,g),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(h.instancesPreviousData,0,g)),this._processInstancedBuffers(a,E),this.getScene()._activeIndices.addCount(e.indexCount*g,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,s,t),this._draw(e,t,g),this._scene.needsPreviousWorldMatrices&&!R&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(h.instancesData,0,g),r.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){var r,n;const a=(n=(r=this._thinInstanceDataStorage)===null||r===void 0?void 0:r.instancesCount)!==null&&n!==void 0?n:0;this.getScene()._activeIndices.addCount(e.indexCount*a,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,a),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,a):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,r,n,a,l){const h=this.getScene(),c=h.getEngine();if(s=this._getRenderingFillMode(s),n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,c),this;if(n)this._renderWithInstances(t,s,r,i,c);else{c._currentDrawContext&&(c._currentDrawContext.useInstancing=!1);let u=0;r.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),l),u++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const d=r.visibleInstances[t._id];if(d){const f=d.length;u+=f;for(let p=0;p<f;p++){const g=d[p].getWorldMatrix();a&&a(!0,g,l),this._draw(t,s)}}h._activeIndices.addCount(t.indexCount*u,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,i,s,r=!0){const n=this._scene.getEngine(),a=n.currentRenderPassId;if(e!==void 0&&(n.currentRenderPassId=e),s)(!r||r&&s.isInFrustum(this._scene._frustumPlanes))&&this.render(s,!!t,i);else for(let l=0;l<this.subMeshes.length;l++){const h=this.subMeshes[l];(!r||r&&h.isInFrustum(this._scene._frustumPlanes))&&this.render(h,!!t,i)}return e!==void 0&&(n.currentRenderPassId=a),this}render(e,t,i){var s,r,n,a,l;const h=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;const c=(r=(s=h.activeCameras)===null||s===void 0?void 0:s.length)!==null&&r!==void 0?r:0;if((c>1&&h.activeCamera===h.activeCameras[0]||c<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const d=this._getInstancesRenderList(e._id,!!i);if(d.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const f=h.getEngine();let p=0,_=null;this.ignoreCameraMaxZ&&h.activeCamera&&!h._isInIntermediateRendering()&&(p=h.activeCamera.maxZ,_=h.activeCamera,h.activeCamera.maxZ=0,h.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const g=e.getRenderingMesh(),E=d.hardwareInstancedRendering[e._id]||g.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,R=this._instanceDataStorage,x=e.getMaterial();if(!x)return _&&(_.maxZ=p,h.updateTransformMatrix(!0)),this;if(!R.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==x){if(x._storeEffectOnSubMeshes){if(!x.isReadyForSubMesh(this,e,E))return _&&(_.maxZ=p,h.updateTransformMatrix(!0)),this}else if(!x.isReady(this,E))return _&&(_.maxZ=p,h.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=x}else if(x._storeEffectOnSubMeshes&&!(!((n=e.effect)===null||n===void 0)&&n._wasPreviouslyReady)||!x._storeEffectOnSubMeshes&&!(!((a=x.getEffect())===null||a===void 0)&&a._wasPreviouslyReady))return _&&(_.maxZ=p,h.updateTransformMatrix(!0)),this;t&&f.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let S;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?S=e._drawWrapper:S=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const b=(l=S==null?void 0:S.effect)!==null&&l!==void 0?l:null;for(const k of h._beforeRenderingMeshStage)k.action(this,e,d,b);if(!S||!b)return _&&(_.maxZ=p,h.updateTransformMatrix(!0)),this;const y=i||this;let I;if(!R.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null||this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)){const k=y._getWorldMatrixDeterminant();I=this.overrideMaterialSideOrientation,I==null&&(I=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),k<0&&(I=I===Q.ClockWiseSideOrientation?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation),R.sideOrientation=I}else I=R.sideOrientation;const O=this._internalMeshDataInfo._effectiveMaterial._preBind(S,I);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&f.setDepthWrite(!0);const N=this._internalMeshDataInfo._effectiveMaterial,w=N.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),E||this._bind(e,b,w,!1);const G=y.getWorldMatrix();N._storeEffectOnSubMeshes?N.bindForSubMesh(G,this,e):N.bind(G,this),!N.backFaceCulling&&N.separateCullingPass&&(f.setState(!0,N.zOffset,!1,!O,N.cullBackFaces,N.stencil,N.zOffsetUnits),this._processRendering(this,e,b,w,d,E,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),f.setState(!0,N.zOffset,!1,O,N.cullBackFaces,N.stencil,N.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,b,w,d,E,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const k of h._afterRenderingMeshStage)k.action(this,e,d,b);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),_&&(_.maxZ=p,h.updateTransformMatrix(!0)),h.performancePriority===dr.Aggressive&&!R.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(T.MatricesWeightsKind)&&(this.isVerticesDataPresent(T.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(T.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const s=e[i]+e[i+1]+e[i+2]+e[i+3];if(s===0)e[i]=1;else{const r=1/s;e[i]*=r,e[i+1]*=r,e[i+2]*=r,e[i+3]*=r}}this.setVerticesData(T.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(T.MatricesWeightsExtraKind),t=this.getVerticesData(T.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let r=t[s]+t[s+1]+t[s+2]+t[s+3];if(r+=e[s]+e[s+1]+e[s+2]+e[s+3],r===0)t[s]=1;else{const n=1/r;t[s]*=n,t[s+1]*=n,t[s+2]*=n,t[s+3]*=n,e[s]*=n,e[s+1]*=n,e[s+2]*=n,e[s+3]*=n}}this.setVerticesData(T.MatricesWeightsKind,t),this.setVerticesData(T.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(T.MatricesWeightsExtraKind),t=this.getVerticesData(T.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let s=0,r=0,n=0,a=0;const l=e===null?4:8,h=[];for(let g=0;g<=l;g++)h[g]=0;const c=.001;for(let g=0;g<i;g+=4){let E=t[g],R=E,x=R===0?0:1;for(let S=1;S<l;S++){const b=S<4?t[g+S]:e[g+S-4];b>E&&s++,b!==0&&x++,R+=b,E=b}if(h[x]++,x>n&&(n=x),R===0)r++;else{const S=1/R;let b=0;for(let y=0;y<l;y++)y<4?b+=Math.abs(t[g+y]-t[g+y]*S):b+=Math.abs(e[g+y-4]-e[g+y-4]*S);b>c&&a++}}const u=this.skeleton.bones.length,d=this.getVerticesData(T.MatricesIndicesKind),f=this.getVerticesData(T.MatricesIndicesExtraKind);let p=0;for(let g=0;g<i;g+=4)for(let E=0;E<l;E++){const R=E<4?d[g+E]:f[g+E-4];(R>=u||R<0)&&p++}const _="Number of Weights = "+i/4+`
Maximum influences = `+n+`
Missing Weights = `+r+`
Not Sorted = `+s+`
Not Normalized = `+a+`
WeightCounts = [`+h+`]
Number of bones = `+u+`
Bad Bone Indices = `+p;return{skinned:!0,valid:r===0&&a===0&&p===0,report:_}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return Y.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(s=>{s.refreshBoundingInfo(),s._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(T.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(T.PositionKind);const s=m.Zero();let r;for(r=0;r<i.length;r+=3)m.TransformCoordinatesFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).toArray(i,r);if(this.setVerticesData(T.PositionKind,i,this.getVertexBuffer(T.PositionKind).isUpdatable()),this.isVerticesDataPresent(T.NormalKind)){for(i=this.getVerticesData(T.NormalKind),r=0;r<i.length;r+=3)m.TransformNormalFromFloatsToRef(i[r],i[r+1],i[r+2],e,s).normalize().toArray(i,r);this.setVerticesData(T.NormalKind,i,this.getVertexBuffer(T.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,s=!0){return new re(e,this.getScene(),t,this,i,s)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const s in i.meshMap){const r=i.meshMap[s];r&&(r._internalMeshDataInfo._source=null,i.meshMap[s]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const s=this.getScene().meshes;for(const r of s){const n=r;n._internalMeshDataInfo&&n._internalMeshDataInfo._source&&n._internalMeshDataInfo._source===this&&(n._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,r,n,a=!1,l){const h=this.getScene(),c=u=>{const d=u.width,f=u.height,_=this.getEngine().createCanvas(d,f).getContext("2d");_.drawImage(u,0,0);const g=_.getImageData(0,0,d,f).data;this.applyDisplacementMapFromBuffer(g,d,f,t,i,r,n,a),s&&s(this)};return Y.LoadImage(e,c,l||(()=>{}),h.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,r,n,a,l=!1){if(!this.isVerticesDataPresent(T.PositionKind)||!this.isVerticesDataPresent(T.NormalKind)||!this.isVerticesDataPresent(T.UVKind))return q.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const h=this.getVerticesData(T.PositionKind,!0,!0),c=this.getVerticesData(T.NormalKind),u=this.getVerticesData(T.UVKind);let d=m.Zero();const f=m.Zero(),p=Ke.Zero();n=n||Ke.Zero(),a=a||new Ke(1,1);for(let _=0;_<h.length;_+=3){m.FromArrayToRef(h,_,d),m.FromArrayToRef(c,_,f),Ke.FromArrayToRef(u,_/3*2,p);const g=Math.abs(p.x*a.x+n.x%1)*(t-1)%t|0,E=Math.abs(p.y*a.y+n.y%1)*(i-1)%i|0,R=(g+E*t)*4,x=e[R]/255,S=e[R+1]/255,b=e[R+2]/255,y=x*.3+S*.59+b*.11;f.normalize(),f.scaleInPlace(s+(r-s)*y),d=d.add(f),d.toArray(h,_)}return fe.ComputeNormals(h,this.getIndices(),c),l?(this.setVerticesData(T.PositionKind,h),this.setVerticesData(T.NormalKind,c),this.setVerticesData(T.UVKind,u)):(this.updateVerticesData(T.PositionKind,h),this.updateVerticesData(T.NormalKind,c)),this}_getFlattenedNormals(e,t){const i=new Float32Array(e.length*3);let s=0;const r=this.overrideMaterialSideOrientation===(this._scene.useRightHandedSystem?1:0);for(let n=0;n<e.length;n+=3){const a=m.FromArray(t,e[n]*3),l=m.FromArray(t,e[n+1]*3),h=m.FromArray(t,e[n+2]*3),c=a.subtract(l),u=h.subtract(l),d=m.Normalize(m.Cross(c,u));r&&d.scaleInPlace(-1);for(let f=0;f<3;f++)i[s++]=d.x,i[s++]=d.y,i[s++]=d.z}return i}_convertToUnIndexedMesh(e=!1){const t=this.getVerticesDataKinds(),i=this.getIndices(),s={},r=(a,l)=>{const h=new Float32Array(i.length*l);let c=0;for(let u=0;u<i.length;u++)for(let d=0;d<l;d++)h[c++]=a[i[u]*l+d];return h},n=this.geometry?this.subMeshes.slice(0):[];for(const a of t)s[a]=this.getVerticesData(a);for(const a of t){const l=this.getVertexBuffer(a),h=l.getStrideSize();if(e&&a===T.NormalKind){const c=this._getFlattenedNormals(i,s[T.PositionKind]);this.setVerticesData(T.NormalKind,c,l.isUpdatable(),h)}else this.setVerticesData(a,r(s[a],h),l.isUpdatable(),h)}if(this.morphTargetManager){for(let a=0;a<this.morphTargetManager.numTargets;a++){const l=this.morphTargetManager.getTarget(a),h=l.getPositions();l.setPositions(r(h,3));const c=l.getNormals();c&&l.setNormals(e?this._getFlattenedNormals(i,h):r(c,3));const u=l.getTangents();u&&l.setTangents(r(u,3));const d=l.getUVs();d&&l.setUVs(r(d,2))}this.morphTargetManager.synchronize()}for(let a=0;a<i.length;a++)i[a]=a;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(const a of n)Ps.AddToMesh(a.materialIndex,a.indexStart,a.indexCount,a.indexStart,a.indexCount,this);return this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){const t=fe.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(T.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let s;for(i=0;i<t.indices.length;i+=3)s=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=s}return t.applyToMesh(this,this.isVertexBufferUpdatable(T.PositionKind)),this}increaseVertices(e=1){const t=fe.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,r=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!s)q.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=s,r&&(t.uvs=r),n&&(t.normals=n);const a=e+1,l=new Array;for(let b=0;b<a+1;b++)l[b]=new Array;let h,c;const u=new m(0,0,0),d=new m(0,0,0),f=new Ke(0,0),p=new Array,_=new Array,g=new Array;let E,R=s.length,x;r&&(x=r.length);let S;n&&(S=n.length);for(let b=0;b<i.length;b+=3){_[0]=i[b],_[1]=i[b+1],_[2]=i[b+2];for(let y=0;y<3;y++)if(h=_[y],c=_[(y+1)%3],g[h]===void 0&&g[c]===void 0?(g[h]=new Array,g[c]=new Array):(g[h]===void 0&&(g[h]=new Array),g[c]===void 0&&(g[c]=new Array)),g[h][c]===void 0&&g[c][h]===void 0){g[h][c]=[],u.x=(s[3*c]-s[3*h])/a,u.y=(s[3*c+1]-s[3*h+1])/a,u.z=(s[3*c+2]-s[3*h+2])/a,n&&(d.x=(n[3*c]-n[3*h])/a,d.y=(n[3*c+1]-n[3*h+1])/a,d.z=(n[3*c+2]-n[3*h+2])/a),r&&(f.x=(r[2*c]-r[2*h])/a,f.y=(r[2*c+1]-r[2*h+1])/a),g[h][c].push(h);for(let I=1;I<a;I++)g[h][c].push(s.length/3),s[R++]=s[3*h]+I*u.x,s[R++]=s[3*h+1]+I*u.y,s[R++]=s[3*h+2]+I*u.z,n&&(n[S++]=n[3*h]+I*d.x,n[S++]=n[3*h+1]+I*d.y,n[S++]=n[3*h+2]+I*d.z),r&&(r[x++]=r[2*h]+I*f.x,r[x++]=r[2*h+1]+I*f.y);g[h][c].push(c),g[c][h]=new Array,E=g[h][c].length;for(let I=0;I<E;I++)g[c][h][I]=g[h][c][E-1-I]}l[0][0]=i[b],l[1][0]=g[i[b]][i[b+1]][1],l[1][1]=g[i[b]][i[b+2]][1];for(let y=2;y<a;y++){l[y][0]=g[i[b]][i[b+1]][y],l[y][y]=g[i[b]][i[b+2]][y],u.x=(s[3*l[y][y]]-s[3*l[y][0]])/y,u.y=(s[3*l[y][y]+1]-s[3*l[y][0]+1])/y,u.z=(s[3*l[y][y]+2]-s[3*l[y][0]+2])/y,n&&(d.x=(n[3*l[y][y]]-n[3*l[y][0]])/y,d.y=(n[3*l[y][y]+1]-n[3*l[y][0]+1])/y,d.z=(n[3*l[y][y]+2]-n[3*l[y][0]+2])/y),r&&(f.x=(r[2*l[y][y]]-r[2*l[y][0]])/y,f.y=(r[2*l[y][y]+1]-r[2*l[y][0]+1])/y);for(let I=1;I<y;I++)l[y][I]=s.length/3,s[R++]=s[3*l[y][0]]+I*u.x,s[R++]=s[3*l[y][0]+1]+I*u.y,s[R++]=s[3*l[y][0]+2]+I*u.z,n&&(n[S++]=n[3*l[y][0]]+I*d.x,n[S++]=n[3*l[y][0]+1]+I*d.y,n[S++]=n[3*l[y][0]+2]+I*d.z),r&&(r[x++]=r[2*l[y][0]]+I*f.x,r[x++]=r[2*l[y][0]+1]+I*f.y)}l[a]=g[i[b+1]][i[b+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let y=1;y<a;y++){let I;for(I=0;I<y;I++)p.push(l[y][I],l[y+1][I],l[y+1][I+1]),p.push(l[y][I],l[y+1][I+1],l[y][I+1]);p.push(l[y][I],l[y+1][I],l[y+1][I+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(T.PositionKind))}}forceSharedVertices(){const e=fe.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,r=e.colors,n=e.matricesIndices,a=e.matricesWeights,l=e.matricesIndicesExtra,h=e.matricesWeightsExtra;if(i===void 0||s===void 0||i===null||s===null)q.Warn("VertexData contains empty entries");else{const c=new Array,u=new Array,d=new Array,f=new Array,p=new Array,_=new Array,g=new Array,E=new Array;let R=new Array,x=0;const S={};let b,y;for(let O=0;O<i.length;O+=3){y=[i[O],i[O+1],i[O+2]],R=[];for(let N=0;N<3;N++){R[N]="";for(let w=0;w<3;w++)Math.abs(s[3*y[N]+w])<1e-8&&(s[3*y[N]+w]=0),R[N]+=s[3*y[N]+w]+"|"}if(!(R[0]==R[1]||R[0]==R[2]||R[1]==R[2]))for(let N=0;N<3;N++){if(b=S[R[N]],b===void 0){S[R[N]]=x,b=x++;for(let w=0;w<3;w++)c.push(s[3*y[N]+w]);if(r!=null)for(let w=0;w<4;w++)f.push(r[4*y[N]+w]);if(t!=null)for(let w=0;w<2;w++)d.push(t[2*y[N]+w]);if(n!=null)for(let w=0;w<4;w++)p.push(n[4*y[N]+w]);if(a!=null)for(let w=0;w<4;w++)_.push(a[4*y[N]+w]);if(l!=null)for(let w=0;w<4;w++)g.push(l[4*y[N]+w]);if(h!=null)for(let w=0;w<4;w++)E.push(h[4*y[N]+w])}u.push(b)}}const I=new Array;fe.ComputeNormals(c,u,I),e.positions=c,e.indices=u,e.normals=I,t!=null&&(e.uvs=d),r!=null&&(e.colors=f),n!=null&&(e.matricesIndices=p),a!=null&&(e.matricesWeights=_),l!=null&&(e.matricesIndicesExtra=g),a!=null&&(e.matricesWeightsExtra=E),e.applyToMesh(this,this.isVertexBufferUpdatable(T.PositionKind))}}static _instancedMeshFactory(e,t){throw ke("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw ke("PhysicsImpostor")}createInstance(e){return re._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(T.PositionKind);if(!i||!t)return this;const s=[];for(let n=0;n<i.length;n=n+3)s.push(m.FromArray(i,n));const r=[];return Oc.SyncAsyncForLoop(s.length,40,n=>{const a=s.length-1-n,l=s[a];for(let h=0;h<a;++h){const c=s[h];if(l.equals(c)){r[a]=h;break}}},()=>{for(let a=0;a<t.length;++a)t[a]=r[t[a]]||t[a];const n=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=n,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),ot&&ot.HasTags(this)&&(e.tags=ot.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const s=this.subMeshes[i];e.subMeshes.push({materialIndex:s.materialIndex,verticesStart:s.verticesStart,verticesCount:s.verticesCount,indexStart:s.indexStart,indexCount:s.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(pe.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const s=this.instances[i];if(s.doNotSerialize)continue;const r={name:s.name,id:s.id,isEnabled:s.isEnabled(!1),isVisible:s.isVisible,isPickable:s.isPickable,checkCollisions:s.checkCollisions,position:s.position.asArray(),scaling:s.scaling.asArray()};if(s.parent&&s.parent._serializeAsParent(r),s.rotationQuaternion?r.rotationQuaternion=s.rotationQuaternion.asArray():s.rotation&&(r.rotation=s.rotation.asArray()),this.getScene()._getComponent(pe.NAME_PHYSICSENGINE)){const n=s.getPhysicsImpostor();n&&(r.physicsMass=n.getParam("mass"),r.physicsFriction=n.getParam("friction"),r.physicsRestitution=n.getParam("mass"),r.physicsImpostor=n.type)}s.metadata&&(r.metadata=s.metadata),s.actionManager&&(r.actions=s.actionManager.serialize(s.name)),e.instances.push(r),Le.AppendSerializedAnimations(s,r),r.ranges=s.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const s in this._userThinInstanceBuffersStorage.data)i.data[s]=Array.from(this._userThinInstanceBuffersStorage.data[s]),i.sizes[s]=this._userThinInstanceBuffersStorage.sizes[s],i.strides[s]=this._userThinInstanceBuffersStorage.strides[s];e.thinInstances.userThinInstance=i}return Le.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){q.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s){q.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(T.PositionKind+t,s,!1,3);const r=i.getNormals();r&&this.geometry.setVerticesData(T.NormalKind+t,r,!1,3);const n=i.getTangents();n&&this.geometry.setVerticesData(T.TangentKind+t,n,!1,3);const a=i.getUVs();a&&this.geometry.setVerticesData(T.UVKind+"_"+t,a,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(T.PositionKind+t);)this.geometry.removeVerticesData(T.PositionKind+t),this.geometry.isVerticesDataPresent(T.NormalKind+t)&&this.geometry.removeVerticesData(T.NormalKind+t),this.geometry.isVerticesDataPresent(T.TangentKind+t)&&this.geometry.removeVerticesData(T.TangentKind+t),this.geometry.isVerticesDataPresent(T.UVKind+t)&&this.geometry.removeVerticesData(T.UVKind+"_"+t),t++}}static Parse(e,t,i){let s;if(e.type&&e.type==="LinesMesh"?s=re._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?s=re._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?s=re._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?s=re._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?s=re._TrailMeshParser(e,t):s=new re(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,ot&&ot.AddTagsTo(s,e.tags),s.position=m.FromArray(e.position),e.metadata!==void 0&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=le.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=m.FromArray(e.rotation)),s.scaling=m.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(L.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(L.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(s.applyFog=e.applyFog),e.pickable!==void 0&&(s.isPickable=e.pickable),e.alphaIndex!==void 0&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(s.billboardMode=e.billboardMode),e.visibility!==void 0&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,e.overrideMaterialSideOrientation!==void 0&&(s.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation),e.isBlocker!==void 0&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(s._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(s.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(s.overlayColor=J.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(T.UVKind),e.hasUVs2&&s._delayInfo.push(T.UV2Kind),e.hasUVs3&&s._delayInfo.push(T.UV3Kind),e.hasUVs4&&s._delayInfo.push(T.UV4Kind),e.hasUVs5&&s._delayInfo.push(T.UV5Kind),e.hasUVs6&&s._delayInfo.push(T.UV6Kind),e.hasColors&&s._delayInfo.push(T.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(T.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(T.MatricesWeightsKind),s._delayLoadingFunction=Ai._ImportGeometry,_i.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):Ai._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let r=0;r<e.animations.length;r++){const n=e.animations[r],a=Gr("BABYLON.Animation");a&&s.animations.push(a.Parse(n))}Jt.ParseAnimationRanges(s,e,t)}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&re._PhysicsImpostorParser(t,s,e),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let r=0;r<e.instances.length;r++){const n=e.instances[r],a=s.createInstance(n.name);if(n.id&&(a.id=n.id),ot&&(n.tags?ot.AddTagsTo(a,n.tags):ot.AddTagsTo(a,e.tags)),a.position=m.FromArray(n.position),n.metadata!==void 0&&(a.metadata=n.metadata),n.parentId!==void 0&&(a._waitingParentId=n.parentId),n.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=n.parentInstanceIndex),n.isEnabled!==void 0&&n.isEnabled!==null&&a.setEnabled(n.isEnabled),n.isVisible!==void 0&&n.isVisible!==null&&(a.isVisible=n.isVisible),n.isPickable!==void 0&&n.isPickable!==null&&(a.isPickable=n.isPickable),n.rotationQuaternion?a.rotationQuaternion=le.FromArray(n.rotationQuaternion):n.rotation&&(a.rotation=m.FromArray(n.rotation)),a.scaling=m.FromArray(n.scaling),n.checkCollisions!=null&&n.checkCollisions!=null&&(a.checkCollisions=n.checkCollisions),n.pickable!=null&&n.pickable!=null&&(a.isPickable=n.pickable),n.showBoundingBox!=null&&n.showBoundingBox!=null&&(a.showBoundingBox=n.showBoundingBox),n.showSubMeshesBoundingBox!=null&&n.showSubMeshesBoundingBox!=null&&(a.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),n.alphaIndex!=null&&n.showSubMeshesBoundingBox!=null&&(a.alphaIndex=n.alphaIndex),n.physicsImpostor&&re._PhysicsImpostorParser(t,a,n),n.actions!==void 0&&(a._waitingData.actions=n.actions),n.animations){for(let l=0;l<n.animations.length;l++){const h=n.animations[l],c=Gr("BABYLON.Animation");c&&a.animations.push(c.Parse(h))}Jt.ParseAnimationRanges(a,n,t),n.autoAnimate&&t.beginAnimation(a,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(e.thinInstances){const r=e.thinInstances;if(s.thinInstanceEnablePicking=!!r.enablePicking,r.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(r.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=r.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,e.thinInstances.userThinInstance){const n=e.thinInstances.userThinInstance;for(const a in n.data)s.thinInstanceSetBuffer(a,new Float32Array(n.data[a]),n.strides[a],!1),s._userThinInstanceBuffersStorage.sizes[a]=n.sizes[a]}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(T.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(T.PositionKind)||this.setVerticesData(T.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(T.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(T.NormalKind)||this.setVerticesData(T.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(T.PositionKind))return this;if(!this.isVerticesDataPresent(T.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(T.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(T.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const E=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=E}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(T.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let r=this.getVerticesData(T.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}const n=this.getVerticesData(T.MatricesIndicesKind),a=this.getVerticesData(T.MatricesWeightsKind);if(!a||!n)return this;const l=this.numBoneInfluencers>4,h=l?this.getVerticesData(T.MatricesIndicesExtraKind):null,c=l?this.getVerticesData(T.MatricesWeightsExtraKind):null,u=e.getTransformMatrices(this),d=m.Zero(),f=new L,p=new L;let _=0,g;for(let E=0;E<s.length;E+=3,_+=4){let R;for(g=0;g<4;g++)R=a[_+g],R>0&&(L.FromFloat32ArrayToRefScaled(u,Math.floor(n[_+g]*16),R,p),f.addToSelf(p));if(l)for(g=0;g<4;g++)R=c[_+g],R>0&&(L.FromFloat32ArrayToRefScaled(u,Math.floor(h[_+g]*16),R,p),f.addToSelf(p));m.TransformCoordinatesFromFloatsToRef(i._sourcePositions[E],i._sourcePositions[E+1],i._sourcePositions[E+2],f,d),d.toArray(s,E),t&&(m.TransformNormalFromFloatsToRef(i._sourceNormals[E],i._sourceNormals[E+1],i._sourceNormals[E+2],f,d),d.toArray(r,E)),f.reset()}return this.updateVerticesData(T.PositionKind,s),t&&this.updateVerticesData(T.NormalKind,r),this}static MinMax(e){let t=null,i=null;return e.forEach(function(s){const n=s.getBoundingInfo().boundingBox;!t||!i?(t=n.minimumWorld,i=n.maximumWorld):(t.minimizeInPlace(n.minimumWorld),i.maximizeInPlace(n.maximumWorld))}),!t||!i?{min:m.Zero(),max:m.Zero()}:{min:t,max:i}}static Center(e){const t=e instanceof Array?re.MinMax(e):e;return m.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,s,r,n){return Pf(re._MergeMeshesCoroutine(e,t,i,s,r,n,!1))}static MergeMeshesAsync(e,t=!0,i,s,r,n){return Yb(re._MergeMeshesCoroutine(e,t,i,s,r,n,!0),Xb())}static*_MergeMeshesCoroutine(e,t=!0,i,s,r,n,a){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let I=0;for(l=0;l<e.length;l++)if(I+=e[l].getTotalVertices(),I>=65536)return q.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(r=!1);const h=new Array,c=new Array,u=new Array,d=e[0].overrideMaterialSideOrientation;for(l=0;l<e.length;l++){const I=e[l];if(I.isAnInstance)return q.Warn("Cannot merge instance meshes."),null;if(d!==I.overrideMaterialSideOrientation)return q.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(r&&u.push(I.getTotalIndices()),n)if(I.material){const O=I.material;if(O instanceof aa){for(let N=0;N<O.subMaterials.length;N++)h.indexOf(O.subMaterials[N])<0&&h.push(O.subMaterials[N]);for(let N=0;N<I.subMeshes.length;N++)c.push(h.indexOf(O.subMaterials[I.subMeshes[N].materialIndex])),u.push(I.subMeshes[N].indexCount)}else{h.indexOf(O)<0&&h.push(O);for(let N=0;N<I.subMeshes.length;N++)c.push(h.indexOf(O)),u.push(I.subMeshes[N].indexCount)}}else for(let O=0;O<I.subMeshes.length;O++)c.push(0),u.push(I.subMeshes[O].indexCount)}const f=e[0],p=I=>{const O=I.computeWorldMatrix(!0);return{vertexData:fe.ExtractFromMesh(I,!1,!1),transform:O}},{vertexData:_,transform:g}=p(f);a&&(yield);const E=new Array(e.length-1);for(let I=1;I<e.length;I++)E[I-1]=p(e[I]),a&&(yield);const R=_._mergeCoroutine(g,E,i,a,!t);let x=R.next();for(;!x.done;)a&&(yield),x=R.next();const S=x.value;s||(s=new re(f.name+"_merged",f.getScene()));const b=S._applyToCoroutine(s,void 0,a);let y=b.next();for(;!y.done;)a&&(yield),y=b.next();if(s.checkCollisions=f.checkCollisions,s.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(r||n){s.releaseSubMeshes(),l=0;let I=0;for(;l<u.length;)Ps.CreateFromIndices(0,I,u[l],s,void 0,!1),I+=u[l],l++;for(const O of s.subMeshes)O.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(n){const I=new aa(f.name+"_merged",f.getScene());I.subMaterials=h;for(let O=0;O<s.subMeshes.length;O++)s.subMeshes[O].materialIndex=c[O];s.material=I}else s.material=f.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===Q.CounterClockWiseSideOrientation}_getRenderingFillMode(e){var t;const i=this.getScene();return i.forcePointsCloud?Q.PointFillMode:i.forceWireframe?Q.WireFrameFillMode:(t=this.overrideRenderingFillMode)!==null&&t!==void 0?t:e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,s,r,n,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,s){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,s,r,n,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,s,r,n,a,l,h,c){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,s,r,n,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,s,r,n,a,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,s,r,n,a,l,h,c){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,s,r,n,a,l,h,c,u,d){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,s,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,s,r){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,s,r,n,a,l,h){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,s,r,n,a,l,h,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,s,r,n,a,l,h,c){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,s,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}}re.FRONTSIDE=fe.FRONTSIDE;re.BACKSIDE=fe.BACKSIDE;re.DOUBLESIDE=fe.DOUBLESIDE;re.DEFAULTSIDE=fe.DEFAULTSIDE;re.NO_CAP=0;re.CAP_START=1;re.CAP_END=2;re.CAP_ALL=3;re.NO_FLIP=0;re.FLIP_TILE=1;re.ROTATE_TILE=2;re.FLIP_ROW=3;re.ROTATE_ROW=4;re.FLIP_N_ROTATE_TILE=5;re.FLIP_N_ROTATE_ROW=6;re.CENTER=0;re.LEFT=1;re.RIGHT=2;re.TOP=3;re.BOTTOM=4;re.INSTANCEDMESH_SORT_TRANSPARENT=!1;re._GroundMeshParser=(o,e)=>{throw ke("GroundMesh")};re._GoldbergMeshParser=(o,e)=>{throw ke("GoldbergMesh")};re._LinesMeshParser=(o,e)=>{throw ke("LinesMesh")};re._GreasedLineMeshParser=(o,e)=>{throw ke("GreasedLineMesh")};re._GreasedLineRibbonMeshParser=(o,e)=>{throw ke("GreasedLineRibbonMesh")};re._TrailMeshParser=(o,e)=>{throw ke("TrailMesh")};Re("BABYLON.Mesh",re);re._GroundMeshParser=(o,e)=>Dh.Parse(o,e);class Dh extends re{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),s=D.Matrix[5];i.invertToRef(s);const r=D.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,s,r),e=r.x,t=r.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),a=-(n.x*e+n.z*t+n.w)/n.y;return m.TransformCoordinatesFromFloatsToRef(0,a,0,i,r),r.y}getNormalAtCoordinates(e,t){const i=new m(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const s=this.getWorldMatrix(),r=D.Matrix[5];s.invertToRef(r);const n=D.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const a=this._getFacetAt(e,t);return m.TransformNormalFromFloatsToRef(a.x,a.y,a.z,s,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),s=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),r=this._heightQuads[s*this._subdivisionsX+i];let n;return t<r.slope.x*e+r.slope.y?n=r.facet1:n=r.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let s=0;s<e;s++){const r={slope:Ke.Zero(),facet1:new ut(0,0,0,0),facet2:new ut(0,0,0,0)};this._heightQuads[i*e+s]=r}return this}_computeHeightQuads(){const e=this.getVerticesData(T.PositionKind);if(!e)return this;const t=D.Vector3[3],i=D.Vector3[2],s=D.Vector3[1],r=D.Vector3[0],n=D.Vector3[4],a=D.Vector3[5],l=D.Vector3[6],h=D.Vector3[7],c=D.Vector3[8];let u=0,d=0,f=0,p=0,_=0,g=0,E=0;const R=this._subdivisionsX,x=this._subdivisionsY;for(let S=0;S<x;S++)for(let b=0;b<R;b++){u=b*3,d=S*(R+1)*3,f=(S+1)*(R+1)*3,t.x=e[d+u],t.y=e[d+u+1],t.z=e[d+u+2],i.x=e[d+u+3],i.y=e[d+u+4],i.z=e[d+u+5],s.x=e[f+u],s.y=e[f+u+1],s.z=e[f+u+2],r.x=e[f+u+3],r.y=e[f+u+4],r.z=e[f+u+5],p=(r.z-t.z)/(r.x-t.x),_=t.z-p*t.x,i.subtractToRef(t,n),s.subtractToRef(t,a),r.subtractToRef(t,l),m.CrossToRef(l,a,h),m.CrossToRef(n,l,c),h.normalize(),c.normalize(),g=-(h.x*t.x+h.y*t.y+h.z*t.z),E=-(c.x*i.x+c.y*i.y+c.z*i.z);const y=this._heightQuads[S*R+b];y.slope.copyFromFloats(p,_),y.facet1.copyFromFloats(h.x,h.y,h.z,g),y.facet2.copyFromFloats(c.x,c.y,c.z,E)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new Dh(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function Wm(o){const e=[],t=[],i=[],s=[];let r,n;const a=o.width||1,l=o.height||1,h=(o.subdivisionsX||o.subdivisions||1)|0,c=(o.subdivisionsY||o.subdivisions||1)|0;for(r=0;r<=c;r++)for(n=0;n<=h;n++){const d=new m(n*a/h-a/2,0,(c-r)*l/c-l/2),f=new m(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),s.push(n/h,Dt.UseOpenGLOrientationForUV?r/c:1-r/c)}for(r=0;r<c;r++)for(n=0;n<h;n++)e.push(n+1+(r+1)*(h+1)),e.push(n+1+r*(h+1)),e.push(n+r*(h+1)),e.push(n+(r+1)*(h+1)),e.push(n+1+(r+1)*(h+1)),e.push(n+r*(h+1));const u=new fe;return u.indices=e,u.positions=t,u.normals=i,u.uvs=s,u}function Xm(o){const e=o.xmin!==void 0&&o.xmin!==null?o.xmin:-1,t=o.zmin!==void 0&&o.zmin!==null?o.zmin:-1,i=o.xmax!==void 0&&o.xmax!==null?o.xmax:1,s=o.zmax!==void 0&&o.zmax!==null?o.zmax:1,r=o.subdivisions||{w:1,h:1},n=o.precision||{w:1,h:1},a=[],l=[],h=[],c=[];let u,d,f,p;r.h=r.h<1?1:r.h,r.w=r.w<1?1:r.w,n.w=n.w<1?1:n.w,n.h=n.h<1?1:n.h;const _={w:(i-e)/r.w,h:(s-t)/r.h};function g(R,x,S,b){const y=l.length/3,I=n.w+1;for(u=0;u<n.h;u++)for(d=0;d<n.w;d++){const w=[y+d+u*I,y+(d+1)+u*I,y+(d+1)+(u+1)*I,y+d+(u+1)*I];a.push(w[1]),a.push(w[2]),a.push(w[3]),a.push(w[0]),a.push(w[1]),a.push(w[3])}const O=m.Zero(),N=new m(0,1,0);for(u=0;u<=n.h;u++)for(O.z=u*(b-x)/n.h+x,d=0;d<=n.w;d++)O.x=d*(S-R)/n.w+R,O.y=0,l.push(O.x,O.y,O.z),h.push(N.x,N.y,N.z),c.push(d/n.w,u/n.h)}for(f=0;f<r.h;f++)for(p=0;p<r.w;p++)g(e+p*_.w,t+f*_.h,e+(p+1)*_.w,t+(f+1)*_.h);const E=new fe;return E.indices=a,E.positions=l,E.normals=h,E.uvs=c,E}function Ym(o){const e=[],t=[],i=[],s=[];let r,n;const a=o.colorFilter||new J(.3,.59,.11),l=o.alphaFilter||0;let h=!1;if(o.minHeight>o.maxHeight){h=!0;const u=o.maxHeight;o.maxHeight=o.minHeight,o.minHeight=u}for(r=0;r<=o.subdivisions;r++)for(n=0;n<=o.subdivisions;n++){const u=new m(n*o.width/o.subdivisions-o.width/2,0,(o.subdivisions-r)*o.height/o.subdivisions-o.height/2),d=(u.x+o.width/2)/o.width*(o.bufferWidth-1)|0,f=(1-(u.z+o.height/2)/o.height)*(o.bufferHeight-1)|0,p=(d+f*o.bufferWidth)*4;let _=o.buffer[p]/255,g=o.buffer[p+1]/255,E=o.buffer[p+2]/255;const R=o.buffer[p+3]/255;h&&(_=1-_,g=1-g,E=1-E);const x=_*a.r+g*a.g+E*a.b;R>=l?u.y=o.minHeight+(o.maxHeight-o.minHeight)*x:u.y=o.minHeight-dt,t.push(u.x,u.y,u.z),i.push(0,0,0),s.push(n/o.subdivisions,1-r/o.subdivisions)}for(r=0;r<o.subdivisions;r++)for(n=0;n<o.subdivisions;n++){const u=n+1+(r+1)*(o.subdivisions+1),d=n+1+r*(o.subdivisions+1),f=n+r*(o.subdivisions+1),p=n+(r+1)*(o.subdivisions+1),_=t[u*3+1]>=o.minHeight,g=t[d*3+1]>=o.minHeight,E=t[f*3+1]>=o.minHeight;_&&g&&E&&(e.push(u),e.push(d),e.push(f)),t[p*3+1]>=o.minHeight&&_&&E&&(e.push(p),e.push(u),e.push(f))}fe.ComputeNormals(t,e,i);const c=new fe;return c.indices=e,c.positions=t,c.normals=i,c.uvs=s,c}function nS(o,e={},t){const i=new Dh(o,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,Wm(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function aS(o,e,t=null){const i=new re(o,t);return Xm(e).applyToMesh(i,e.updatable),i}function oS(o,e,t={},i=null){const s=t.width||10,r=t.height||10,n=t.subdivisions||1,a=t.minHeight||0,l=t.maxHeight||1,h=t.colorFilter||new J(.3,.59,.11),c=t.alphaFilter||0,u=t.updatable,d=t.onReady;i=i||Ze.LastCreatedScene;const f=new Dh(o,i);f._subdivisionsX=n,f._subdivisionsY=n,f._width=s,f._height=r,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);const p=(_,g,E)=>{Ym({width:s,height:r,subdivisions:n,minHeight:a,maxHeight:l,colorFilter:h,buffer:_,bufferWidth:g,bufferHeight:E,alphaFilter:c}).applyToMesh(f,u),d&&d(f),f._setReady(!0)};if(typeof e=="string"){const _=g=>{const E=g.width,R=g.height;if(i.isDisposed)return;const x=i==null?void 0:i.getEngine().resizeImageBitmap(g,E,R);p(x,E,R)};Y.LoadImage(e,_,t.onError?t.onError:()=>{},i.offlineProvider)}else p(e.data,e.width,e.height);return f}fe.CreateGround=Wm;fe.CreateTiledGround=Xm;fe.CreateGroundFromHeightMap=Ym;re.CreateGround=(o,e,t,i,s,r)=>nS(o,{width:e,height:t,subdivisions:i,updatable:r},s);re.CreateTiledGround=(o,e,t,i,s,r,n,a,l)=>aS(o,{xmin:e,zmin:t,xmax:i,zmax:s,subdivisions:r,precision:n,updatable:l},a);re.CreateGroundFromHeightMap=(o,e,t,i,s,r,n,a,l,h,c)=>oS(o,e,{width:t,height:i,subdivisions:s,minHeight:r,maxHeight:n,updatable:l,onReady:h,alphaFilter:c},a);function qc(o){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let r=[];const n=o.width||o.size||1,a=o.height||o.size||1,l=o.depth||o.size||1,h=o.wrap||!1;let c=o.topBaseAt===void 0?1:o.topBaseAt,u=o.bottomBaseAt===void 0?0:o.bottomBaseAt;c=(c+4)%4,u=(u+4)%4;const d=[2,0,3,1],f=[2,0,1,3];let p=d[c],_=f[u],g=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(h){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],g=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let I=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],O=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const N=[17,18,19,16],w=[22,23,20,21];for(;p>0;)I.unshift(I.pop()),N.unshift(N.pop()),p--;for(;_>0;)O.unshift(O.pop()),w.unshift(w.pop()),_--;I=I.flat(),O=O.flat(),g=g.concat(I).concat(O),t.push(N[0],N[2],N[3],N[0],N[1],N[2]),t.push(w[0],w[2],w[3],w[0],w[1],w[2])}const E=[n/2,a/2,l/2];r=g.reduce((I,O,N)=>I.concat(O*E[N%3]),[]);const R=o.sideOrientation===0?0:o.sideOrientation||fe.DEFAULTSIDE,x=o.faceUV||new Array(6),S=o.faceColors,b=[];for(let I=0;I<6;I++)x[I]===void 0&&(x[I]=new ut(0,0,1,1)),S&&S[I]===void 0&&(S[I]=new He(1,1,1,1));for(let I=0;I<6;I++)if(s.push(x[I].z,Dt.UseOpenGLOrientationForUV?1-x[I].w:x[I].w),s.push(x[I].x,Dt.UseOpenGLOrientationForUV?1-x[I].w:x[I].w),s.push(x[I].x,Dt.UseOpenGLOrientationForUV?1-x[I].y:x[I].y),s.push(x[I].z,Dt.UseOpenGLOrientationForUV?1-x[I].y:x[I].y),S)for(let O=0;O<4;O++)b.push(S[I].r,S[I].g,S[I].b,S[I].a);fe._ComputeSides(R,r,t,i,s,o.frontUVs,o.backUVs);const y=new fe;if(y.indices=t,y.positions=r,y.normals=i,y.uvs=s,S){const I=R===fe.DOUBLESIDE?b.concat(b):b;y.colors=I}return y}function Df(o,e={},t=null){const i=new re(o,t);return e.sideOrientation=re._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,qc(e).applyToMesh(i,e.updatable),i}fe.CreateBox=qc;re.CreateBox=(o,e,t=null,i,s)=>Df(o,{size:e,sideOrientation:s,updatable:i},t);const lS="boundingBoxRendererFragmentDeclaration",hS=`uniform vec4 color;
`;X.IncludesShadersStore[lS]=hS;const cS="boundingBoxRendererUboDeclaration",uS=`#ifdef WEBGL2
uniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#else
layout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};
#endif
`;X.IncludesShadersStore[cS]=uS;const dS="boundingBoxRendererPixelShader",fS=`#include<__decl__boundingBoxRendererFragment>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;X.ShadersStore[dS]=fS;const _S="boundingBoxRendererVertexDeclaration",pS=`uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
`;X.IncludesShadersStore[_S]=pS;const gS="boundingBoxRendererVertexShader",mS=`attribute vec3 position;
#include<__decl__boundingBoxRendererVertex>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec4 worldPos=world*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;X.ShadersStore[gS]=mS;Object.defineProperty(Ve.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(o){this._forceShowBoundingBoxes=o,o&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0});Ve.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new ES(this)),this._boundingBoxRenderer};Object.defineProperty(pi.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(o){this._showBoundingBox=o,o&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class ES{constructor(e){this.name=pe.NAME_BOUNDINGBOXRENDERER,this.frontColor=new J(1,1,1),this.backColor=new J(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new j,this.onAfterBoxRenderingObservable=new j,this.onResourcesReadyObservable=new j,this.enabled=!0,this.renderList=new li(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new ve(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new ve(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(pe.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(pe.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(pe.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(pe.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();i!=null&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new Rs("colorShader",this.scene,"boundingBoxRenderer",{attributes:[T.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new Rs("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[T.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=qc({size:1});this._vertexBuffers[T.PositionKind]=new T(e,t.positions,T.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[T.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){var t,i;if(this.renderList.length===0||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;const s=this.scene.getEngine();s.setDepthWrite(!1);const r=this.scene.getTransformMatrix();for(let n=0;n<this.renderList.length;n++){const a=this.renderList.data[n];if(a._tag!==e)continue;this._createWrappersForBoundingBox(a),this.onBeforeBoxRenderingObservable.notifyObservers(a);const l=a.minimum,c=a.maximum.subtract(l),u=l.add(c.scale(.5)),d=L.Scaling(c.x,c.y,c.z).multiply(L.Translation(u.x,u.y,u.z)).multiply(a.getWorldMatrix()),f=s.useReverseDepthBuffer;if(this.showBackLines){const _=(t=a._drawWrapperBack)!==null&&t!==void 0?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(_),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),f?s.setDepthFunctionToLessOrEqual():s.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(_.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",d),this._uniformBufferBack.updateMatrix("viewProjection",r),this._uniformBufferBack.update(),s.drawElementsType(Q.LineListDrawMode,0,24)}const p=(i=a._drawWrapperFront)!==null&&i!==void 0?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(p),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),f?s.setDepthFunctionToGreater():s.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(p.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",d),this._uniformBufferFront.updateMatrix("viewProjection",r),this._uniformBufferFront.update(),s.drawElementsType(Q.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(a)}this._colorShader.unbind(),s.setDepthFunctionToLessOrEqual(),s.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new _r(t),e._drawWrapperBack=new _r(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();this._renderPassIdForOcclusionQuery===void 0&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const s=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,s)||!e.hasBoundingInfo){t.currentRenderPassId=i;return}this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const r=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const n=e.getBoundingInfo().boundingBox,a=n.minimum,h=n.maximum.subtract(a),c=a.add(h.scale(.5)),u=L.Scaling(h.x,h.y,h.z).multiply(L.Translation(c.x,c.y,c.z)).multiply(n.getWorldMatrix()),d=s._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),r?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(Q.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(this._renderPassIdForOcclusionQuery!==void 0&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[T.PositionKind];e&&(e.dispose(),this._vertexBuffers[T.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}const TS="clipPlaneFragmentDeclaration",vS=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;X.IncludesShadersStore[TS]=vS;const AS="packingFunctions",RS=`vec4 pack(float depth)
{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;X.IncludesShadersStore[AS]=RS;const bS="clipPlaneFragment",SS=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{discard;}
#endif
`;X.IncludesShadersStore[bS]=SS;const yS="depthPixelShader",CS=`#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vec4 vViewPos;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
gl_FragColor=pack(vViewPos.z);
#else
gl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;X.ShadersStore[yS]=CS;const xS="bonesDeclaration",MS=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform highp sampler2D boneSampler;uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#endif
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}
#endif
#endif
#endif
`;X.IncludesShadersStore[xS]=MS;const IS="bakedVertexAnimationDeclaration",PS=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}
#endif
`;X.IncludesShadersStore[IS]=PS;const DS="morphTargetsVertexGlobalDeclaration",OS=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}
#endif
#endif
`;X.IncludesShadersStore[DS]=OS;const NS="morphTargetsVertexDeclaration",LS=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;X.IncludesShadersStore[NS]=LS;const FS="clipPlaneVertexDeclaration",wS=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;varying float fClipDistance6;
#endif
`;X.IncludesShadersStore[FS]=wS;const BS="instancesDeclaration",US=`#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;X.IncludesShadersStore[BS]=US;const kS="pointCloudVertexDeclaration",VS=`#ifdef POINTSIZE
uniform float pointSize;
#endif
`;X.IncludesShadersStore[kS]=VS;const GS="morphTargetsVertexGlobal",zS=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;X.IncludesShadersStore[GS]=zS;const HS="morphTargetsVertex",WS=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;X.IncludesShadersStore[HS]=WS;const XS="instancesVertex",YS=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;X.IncludesShadersStore[XS]=YS;const KS="bonesVertex",$S=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;X.IncludesShadersStore[KS]=$S;const jS="bakedVertexAnimation",qS=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;X.IncludesShadersStore[jS]=qS;const ZS="clipPlaneVertex",QS=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;X.IncludesShadersStore[ZS]=QS;const JS="pointCloudVertex",ey=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;X.IncludesShadersStore[JS]=ey;const ty="depthVertexShader",iy=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform mat4 view;varying vec4 vViewPos;
#endif
#include<pointCloudVertexDeclaration>
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vViewPos=view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<pointCloudVertex>
}
`;X.ShadersStore[ty]=iy;class Al{setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,s=!1,r=V.TRILINEAR_SAMPLINGMODE,n=!1,a){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._scene=e,this._storeNonLinearDepth=s,this._storeCameraSpaceZ=n,this.isPacked=t===0,this.isPacked?this.clearColor=new He(1,1,1,1):this.clearColor=new He(n?1e8:1,0,0,1),Al._SceneComponentInitialization(this._scene);const l=e.getEngine();this._camera=i,r!==V.NEAREST_SAMPLINGMODE&&(t===1&&!l._caps.textureFloatLinearFiltering&&(r=V.NEAREST_SAMPLINGMODE),t===2&&!l._caps.textureHalfFloatLinearFiltering&&(r=V.NEAREST_SAMPLINGMODE));const h=this.isPacked||!l._features.supportExtendedTextureFormats?5:6;this._depthMap=new Ki(a??"DepthRenderer",{width:l.getRenderWidth(),height:l.getRenderHeight()},this._scene,!1,!0,t,!1,r,void 0,void 0,void 0,h),this._depthMap.wrapU=V.CLAMP_ADDRESSMODE,this._depthMap.wrapV=V.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(u=>{u.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var u;(u=l._debugPushGroup)===null||u===void 0||u.call(l,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var u;(u=l._debugPopGroup)===null||u===void 0||u.call(l,1)}),this._depthMap.customIsReadyFunction=(u,d,f)=>{if((f||d===0)&&u.subMeshes)for(let p=0;p<u.subMeshes.length;++p){const _=u.subMeshes[p],g=_.getRenderingMesh(),E=g._getInstancesRenderList(_._id,!!_.getReplacementMesh()),R=l.getCaps().instancedArrays&&(E.visibleInstances[_._id]!==null&&E.visibleInstances[_._id]!==void 0||g.hasThinInstances);if(!this.isReady(_,R))return!1}return!0};const c=u=>{var d,f;const p=u.getRenderingMesh(),_=u.getEffectiveMesh(),g=this._scene,E=g.getEngine(),R=u.getMaterial();if(_._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!R||_.infiniteDistance||R.disableDepthWrite||u.verticesCount===0||u._renderId===g.getRenderId())return;const x=_._getWorldMatrixDeterminant()<0;let S=(d=p.overrideMaterialSideOrientation)!==null&&d!==void 0?d:R.sideOrientation;x&&(S=S===0?1:0);const b=S===0;E.setState(R.backFaceCulling,0,!1,b,this.reverseCulling?!R.cullBackFaces:R.cullBackFaces);const y=p._getInstancesRenderList(u._id,!!u.getReplacementMesh());if(y.mustReturn)return;const I=E.getCaps().instancedArrays&&(y.visibleInstances[u._id]!==null&&y.visibleInstances[u._id]!==void 0||p.hasThinInstances),O=this._camera||g.activeCamera;if(this.isReady(u,I)&&O){u._renderId=g.getRenderId();const N=(f=_._internalAbstractMeshDataInfo._materialForRenderPass)===null||f===void 0?void 0:f[E.currentRenderPassId];let w=u._getDrawWrapper();!w&&N&&(w=N._getDrawWrapper());const G=O.mode===De.ORTHOGRAPHIC_CAMERA;if(!w)return;const k=w.effect;E.enableEffect(w),I||p._bind(u,k,R.fillMode),N?N.bindForSubMesh(_.getWorldMatrix(),_,u):(k.setMatrix("viewProjection",g.getTransformMatrix()),k.setMatrix("world",_.getWorldMatrix()),this._storeCameraSpaceZ&&k.setMatrix("view",g.getViewMatrix()));let de,ae;if(G?(de=!E.useReverseDepthBuffer&&E.isNDCHalfZRange?0:1,ae=E.useReverseDepthBuffer&&E.isNDCHalfZRange?0:1):(de=E.useReverseDepthBuffer&&E.isNDCHalfZRange?O.minZ:E.isNDCHalfZRange?0:O.minZ,ae=E.useReverseDepthBuffer&&E.isNDCHalfZRange?0:O.maxZ),k.setFloat2("depthValues",de,de+ae),!N){if(R.needAlphaTesting()){const _e=R.getAlphaTestTexture();_e&&(k.setTexture("diffuseSampler",_e),k.setMatrix("diffuseMatrix",_e.getTextureMatrix()))}if(p.useBones&&p.computeBonesUsingShaders&&p.skeleton){const _e=p.skeleton;if(_e.isUsingTextureForMatrices){const Ce=_e.getTransformMatrixTexture(p);if(!Ce)return;k.setTexture("boneSampler",Ce),k.setFloat("boneTextureWidth",4*(_e.bones.length+1))}else k.setMatrices("mBones",_e.getTransformMatrices(p))}Pn(k,R,g),se.BindMorphTargetParameters(p,k),p.morphTargetManager&&p.morphTargetManager.isUsingTextureForTargets&&p.morphTargetManager._bind(k),R.pointsCloud&&k.setFloat("pointSize",R.pointSize)}p._processRendering(_,u,k,R.fillMode,y,I,(_e,Ce)=>k.setMatrix("world",Ce))}};this._depthMap.customRenderFunction=(u,d,f,p)=>{let _;if(p.length)for(_=0;_<p.length;_++)c(p.data[_]);for(_=0;_<u.length;_++)c(u.data[_]);for(_=0;_<d.length;_++)c(d.data[_]);if(this.forceDepthWriteTransparentMeshes)for(_=0;_<f.length;_++)c(f.data[_]);else for(_=0;_<f.length;_++)f.data[_].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}isReady(e,t){var i;const s=this._scene.getEngine(),r=e.getMesh(),n=r.getScene(),a=(i=r._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[s.currentRenderPassId];if(a)return a.isReadyForSubMesh(r,e,t);const l=e.getMaterial();if(!l||l.disableDepthWrite)return!1;const h=[],c=[T.PositionKind];if(l&&l.needAlphaTesting()&&l.getAlphaTestTexture()&&(h.push("#define ALPHATEST"),r.isVerticesDataPresent(T.UVKind)&&(c.push(T.UVKind),h.push("#define UV1")),r.isVerticesDataPresent(T.UV2Kind)&&(c.push(T.UV2Kind),h.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders){c.push(T.MatricesIndicesKind),c.push(T.MatricesWeightsKind),r.numBoneInfluencers>4&&(c.push(T.MatricesIndicesExtraKind),c.push(T.MatricesWeightsExtraKind)),h.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),h.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0));const g=e.getRenderingMesh().skeleton;g!=null&&g.isUsingTextureForMatrices&&h.push("#define BONETEXTURE")}else h.push("#define NUM_BONE_INFLUENCERS 0");const u=r.morphTargetManager;let d=0;u&&u.numInfluencers>0&&(d=u.numInfluencers,h.push("#define MORPHTARGETS"),h.push("#define NUM_MORPH_INFLUENCERS "+d),u.isUsingTextureForTargets&&h.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(c,r,d)),l.pointsCloud&&h.push("#define POINTSIZE"),t&&(h.push("#define INSTANCES"),se.PushAttributesForInstances(c),e.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&h.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&h.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&h.push("#define PACKED"),Mh(l,n,h);const f=e._getDrawWrapper(void 0,!0),p=f.defines,_=h.join(`
`);if(p!==_){const g=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];In(g),f.setEffect(s.createEffect("depth",c,g,["diffuseSampler","morphTargets","boneSampler"],_,void 0,void 0,void 0,{maxSimultaneousMorphTargets:d}),_)}return f.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}Al._SceneComponentInitialization=o=>{throw ke("DepthRendererSceneComponent")};Ve.prototype.enableDepthRenderer=function(o,e=!1,t=!1,i=3,s=!1){if(o=o||this.activeCamera,!o)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[o.id]){const r=!!this.getEngine().getCaps().textureFloatRender;let n=0;this.getEngine().getCaps().textureHalfFloatRender&&(!t||!r)?n=2:r?n=1:n=0,this._depthRenderer[o.id]=new Al(this,n,o,e,i,s)}return this._depthRenderer[o.id]};Ve.prototype.disableDepthRenderer=function(o){o=o||this.activeCamera,!(!o||!this._depthRenderer||!this._depthRenderer[o.id])&&this._depthRenderer[o.id].dispose()};class sy{constructor(e){this.name=pe.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(pe.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(pe.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}Al._SceneComponentInitialization=o=>{let e=o._getComponent(pe.NAME_DEPTHRENDERER);e||(e=new sy(o),o._addComponent(e))};Ie.prototype.restoreSingleAttachment=function(){const o=this._gl;this.bindAttachments([o.BACK])};Ie.prototype.restoreSingleAttachmentForRenderTarget=function(){const o=this._gl;this.bindAttachments([o.COLOR_ATTACHMENT0])};Ie.prototype.buildTextureLayout=function(o){const e=this._gl,t=[];for(let i=0;i<o.length;i++)o[i]?t.push(e["COLOR_ATTACHMENT"+i]):t.push(e.NONE);return t};Ie.prototype.bindAttachments=function(o){this._gl.drawBuffers(o)};Ie.prototype.unBindMultiColorAttachmentFramebuffer=function(o,e=!1,t){this._currentRenderTarget=null;const i=this._gl,s=o._attachments,r=s.length;if(o._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,o._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,o._framebuffer);for(let n=0;n<r;n++){const a=o.textures[n];for(let l=0;l<r;l++)s[l]=i.NONE;s[n]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+n:"COLOR_ATTACHMENT"+n+"_WEBGL"],i.readBuffer(s[n]),i.drawBuffers(s),i.blitFramebuffer(0,0,a.width,a.height,0,0,a.width,a.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(let n=0;n<r;n++)s[n]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+n:"COLOR_ATTACHMENT"+n+"_WEBGL"];i.drawBuffers(s)}for(let n=0;n<r;n++){const a=o.textures[n];a!=null&&a.generateMipMaps&&!e&&!a.isCube&&(this._bindTextureDirectly(i.TEXTURE_2D,a,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(o._MSAAFramebuffer&&this._bindUnboundFramebuffer(o._framebuffer),t()),this._bindUnboundFramebuffer(null)};Ie.prototype.createMultipleRenderTarget=function(o,e,t=!0){var i,s;let r=!1,n=!0,a=!1,l=!1,h=15,c=1;const u=0,d=3,f=!1,p=5,_=3553;let g=[],E=[],R=[],x=[],S=[],b=[],y=[],I=[];const O=this._createHardwareRenderTargetWrapper(!0,!1,o);e!==void 0&&(r=e.generateMipMaps===void 0?!1:e.generateMipMaps,n=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,a=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,l=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,c=e.textureCount||1,e.types&&(g=e.types),e.samplingModes&&(E=e.samplingModes),e.useSRGBBuffers&&(R=e.useSRGBBuffers),e.formats&&(x=e.formats),e.targetTypes&&(S=e.targetTypes),e.faceIndex&&(b=e.faceIndex),e.layerIndex&&(y=e.layerIndex),e.layerCounts&&(I=e.layerCounts),this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(h=e.depthTextureFormat)),O.label=(i=e==null?void 0:e.label)!==null&&i!==void 0?i:"MultiRenderTargetWrapper";const N=this._gl,w=N.createFramebuffer();this._bindUnboundFramebuffer(w);const G=o.width||o,k=o.height||o,de=[],ae=[],_e=this.webGLVersion>1&&l&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===18),Ce=this._setupFramebufferDepthAttachments(!_e&&a,!l&&n,G,k);O._framebuffer=w,O._depthStencilBuffer=Ce,O._generateDepthBuffer=!l&&n,O._generateStencilBuffer=!_e&&a,O._attachments=ae;for(let ce=0;ce<c;ce++){let ze=E[ce]||d,We=g[ce]||u,nt=R[ce]||f;const ne=x[ce]||p,Ue=S[ce]||_,Je=(s=I[ce])!==null&&s!==void 0?s:1;(We===1&&!this._caps.textureFloatLinearFiltering||We===2&&!this._caps.textureHalfFloatLinearFiltering)&&(ze=1);const St=this._getSamplingParameters(ze,r);We===1&&!this._caps.textureFloat&&(We=0,q.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),nt=nt&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const yt=this.webGLVersion>1,tt=N[yt?"COLOR_ATTACHMENT"+ce:"COLOR_ATTACHMENT"+ce+"_WEBGL"];if(ae.push(tt),Ue===-1)continue;const he=new wi(this,At.MultiRenderTarget);de[ce]=he,N.activeTexture(N["TEXTURE"+ce]),N.bindTexture(Ue,he._hardwareTexture.underlyingResource),N.texParameteri(Ue,N.TEXTURE_MAG_FILTER,St.mag),N.texParameteri(Ue,N.TEXTURE_MIN_FILTER,St.min),N.texParameteri(Ue,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(Ue,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE);const Ne=this._getRGBABufferInternalSizedFormat(We,ne,nt),Qe=this._getInternalFormat(ne),Me=this._getWebGLTextureType(We);if(yt&&(Ue===35866||Ue===32879))Ue===35866?he.is2DArray=!0:he.is3D=!0,he.baseDepth=he.depth=Je,N.texImage3D(Ue,0,Ne,G,k,Je,0,Qe,Me,null);else if(Ue===34067){for(let at=0;at<6;at++)N.texImage2D(N.TEXTURE_CUBE_MAP_POSITIVE_X+at,0,Ne,G,k,0,Qe,Me,null);he.isCube=!0}else N.texImage2D(N.TEXTURE_2D,0,Ne,G,k,0,Qe,Me,null);r&&N.generateMipmap(Ue),this._bindTextureDirectly(Ue,null),he.baseWidth=G,he.baseHeight=k,he.width=G,he.height=k,he.isReady=!0,he.samples=1,he.generateMipMaps=r,he.samplingMode=ze,he.type=We,he._useSRGBBuffer=nt,he.format=ne,this._internalTexturesCache.push(he)}if(l&&this._caps.depthTextureExtension){const ce=new wi(this,At.Depth);let ze=5,We=N.DEPTH_COMPONENT16,nt=N.DEPTH_COMPONENT,ne=N.UNSIGNED_SHORT,Ue=N.DEPTH_ATTACHMENT;this.webGLVersion<2?We=N.DEPTH_COMPONENT:h===14?(ze=1,ne=N.FLOAT,We=N.DEPTH_COMPONENT32F):h===18?(ze=0,ne=N.FLOAT_32_UNSIGNED_INT_24_8_REV,We=N.DEPTH32F_STENCIL8,nt=N.DEPTH_STENCIL,Ue=N.DEPTH_STENCIL_ATTACHMENT):h===16?(ze=0,ne=N.UNSIGNED_INT,We=N.DEPTH_COMPONENT24,Ue=N.DEPTH_ATTACHMENT):(h===13||h===17)&&(ze=12,ne=N.UNSIGNED_INT_24_8,We=N.DEPTH24_STENCIL8,nt=N.DEPTH_STENCIL,Ue=N.DEPTH_STENCIL_ATTACHMENT),N.activeTexture(N.TEXTURE0),N.bindTexture(N.TEXTURE_2D,ce._hardwareTexture.underlyingResource),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_MAG_FILTER,N.NEAREST),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_MIN_FILTER,N.NEAREST),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_WRAP_S,N.CLAMP_TO_EDGE),N.texParameteri(N.TEXTURE_2D,N.TEXTURE_WRAP_T,N.CLAMP_TO_EDGE),N.texImage2D(N.TEXTURE_2D,0,We,G,k,0,nt,ne,null),N.framebufferTexture2D(N.FRAMEBUFFER,Ue,N.TEXTURE_2D,ce._hardwareTexture.underlyingResource,0),ce.baseWidth=G,ce.baseHeight=k,ce.width=G,ce.height=k,ce.isReady=!0,ce.samples=1,ce.generateMipMaps=r,ce.samplingMode=1,ce.format=h,ce.type=ze,de[c]=ce,this._internalTexturesCache.push(ce)}return O.setTextures(de),t&&N.drawBuffers(ae),this._bindUnboundFramebuffer(null),O.setLayerAndFaceIndices(y,b),this.resetTextureCache(),O};Ie.prototype.updateMultipleRenderTargetTextureSampleCount=function(o,e,t=!0){if(this.webGLVersion<2||!o||!o.texture)return 1;if(o.samples===e)return e;const i=o._attachments.length;if(i===0)return 1;const s=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples);const r=!!o._depthStencilBuffer;if(r&&(s.deleteRenderbuffer(o._depthStencilBuffer),o._depthStencilBuffer=null),o._MSAAFramebuffer&&(s.deleteFramebuffer(o._MSAAFramebuffer),o._MSAAFramebuffer=null),e>1&&typeof s.renderbufferStorageMultisample=="function"){const n=s.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");o._MSAAFramebuffer=n,this._bindUnboundFramebuffer(n);const a=[];for(let l=0;l<i;l++)o.textures[l]._hardwareTexture.releaseMSAARenderBuffers();for(let l=0;l<i;l++){const h=o.textures[l],c=h._hardwareTexture,u=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],d=this._createRenderBuffer(h.width,h.height,e,-1,this._getRGBABufferInternalSizedFormat(h.type,h.format,h._useSRGBBuffer),u);if(!d)throw new Error("Unable to create multi sampled framebuffer");c.addMSAARenderBuffer(d),h.samples=e,a.push(u)}t&&s.drawBuffers(a)}else this._bindUnboundFramebuffer(o._framebuffer);return r&&(o._depthStencilBuffer=this._setupFramebufferDepthAttachments(o._generateStencilBuffer,o._generateDepthBuffer,o.texture.width,o.texture.height,e)),this._bindUnboundFramebuffer(null),e};class jn extends Ki{get isSupported(){var e,t;return(t=(e=this._engine)===null||e===void 0?void 0:e.getCaps().drawBuffersExtension)!==null&&t!==void 0?t:!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,s,r,n){const a=r&&r.generateMipMaps?r.generateMipMaps:!1,l=r&&r.generateDepthTexture?r.generateDepthTexture:!1,h=r&&r.depthTextureFormat?r.depthTextureFormat:15,c=!r||r.doNotChangeAspectRatio===void 0?!0:r.doNotChangeAspectRatio,u=r&&r.drawOnlyOnFirstAttachmentByDefault?r.drawOnlyOnFirstAttachmentByDefault:!1;if(super(e,t,s,a,c,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported){this.dispose();return}this._textureNames=n;const d=[],f=[],p=[],_=[],g=[],E=[],R=[],x=[];this._initTypes(i,d,f,p,_,g,E,R,x,r);const S=!r||r.generateDepthBuffer===void 0?!0:r.generateDepthBuffer,b=!r||r.generateStencilBuffer===void 0?!1:r.generateStencilBuffer;this._multiRenderTargetOptions={samplingModes:f,generateMipMaps:a,generateDepthBuffer:S,generateStencilBuffer:b,generateDepthTexture:l,depthTextureFormat:h,types:d,textureCount:i,useSRGBBuffers:p,formats:_,targetTypes:g,faceIndex:E,layerIndex:R,layerCounts:x,labels:n,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=u,i>0&&(this._createInternalTextures(),this._createTextures(n))}_initTypes(e,t,i,s,r,n,a,l,h,c){for(let u=0;u<e;u++)c&&c.types&&c.types[u]!==void 0?t.push(c.types[u]):t.push(c&&c.defaultType?c.defaultType:0),c&&c.samplingModes&&c.samplingModes[u]!==void 0?i.push(c.samplingModes[u]):i.push(V.BILINEAR_SAMPLINGMODE),c&&c.useSRGBBuffers&&c.useSRGBBuffers[u]!==void 0?s.push(c.useSRGBBuffers[u]):s.push(!1),c&&c.formats&&c.formats[u]!==void 0?r.push(c.formats[u]):r.push(5),c&&c.targetTypes&&c.targetTypes[u]!==void 0?n.push(c.targetTypes[u]):n.push(3553),c&&c.faceIndex&&c.faceIndex[u]!==void 0?a.push(c.faceIndex[u]):a.push(0),c&&c.layerIndex&&c.layerIndex[u]!==void 0?l.push(c.layerIndex[u]):l.push(0),c&&c.layerCounts&&c.layerCounts[u]!==void 0?h.push(c.layerCounts[u]):h.push(1)}_createInternaTextureIndexMapping(){const e={},t=[];if(!this._renderTarget)return t;const i=this._renderTarget.textures;for(let s=0;s<i.length;s++){const r=i[s];if(!r)continue;const n=e[r.uniqueId];n!==void 0?t[s]=n:e[r.uniqueId]=s}return t}_rebuild(e=!1,t){if(this._count<1)return;const i=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),e&&(this._releaseTextures(),this._createTextures(t));const s=this._renderTarget.textures;for(let r=0;r<s.length;r++){const n=this._textures[r];i[r]!==void 0&&this._renderTarget.setTexture(s[i[r]],r),n._texture=s[r],n._texture&&(n._noMipmap=!n._texture.useMipMaps,n._useSRGBBuffer=n._texture._useSRGBBuffer)}this.samples!==1&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const s=new V(null,this.getScene());e!=null&&e[i]&&(s.name=e[i]),s._texture=t[i],s._texture&&(s._noMipmap=!s._texture.useMipMaps,s._useSRGBBuffer=s._texture._useSRGBBuffer),this._textures.push(s)}}setInternalTexture(e,t,i=!0){var s,r;if(this.renderTarget&&(t===0&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new V(null,this.getScene()),this.textures[t].name=(r=(s=this._textureNames)===null||s===void 0?void 0:s[t])!==null&&r!==void 0?r:this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&this._multiRenderTargetOptions.targetTypes[t]!==-1)){let n=0;e.is2DArray?n=35866:e.isCube?n=34067:e.is3D?n=32879:n=3553,this._multiRenderTargetOptions.targetTypes[t]=n}}setLayerAndFaceIndex(e,t=-1,i=-1){!this.textures[e]||!this.renderTarget||(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e,!1),this._rebuild(void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const s=[],r=[],n=[],a=[],l=[],h=[],c=[],u=[];this._textureNames=i,this._initTypes(e,s,r,n,a,l,h,c,u,t),this._multiRenderTargetOptions.types=s,this._multiRenderTargetOptions.samplingModes=r,this._multiRenderTargetOptions.useSRGBBuffers=n,this._multiRenderTargetOptions.formats=a,this._multiRenderTargetOptions.targetTypes=l,this._multiRenderTargetOptions.faceIndex=h,this._multiRenderTargetOptions.layerIndex=c,this._multiRenderTargetOptions.layerCounts=u,this._multiRenderTargetOptions.labels=i,this._rebuild(!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var e,t;const i=(e=this._renderTarget)===null||e===void 0?void 0:e.textures;if(i){for(let s=i.length-1;s>=0;s--)this._textures[s]._texture=null;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null}}}const ry="oitFinalPixelShader",ny=`precision highp float;uniform sampler2D uFrontColor;uniform sampler2D uBackColor;void main() {ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);vec4 backColor=texelFetch(uBackColor,fragCoord,0);float alphaMultiplier=1.0-frontColor.a;glFragColor=vec4(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);}`;X.ShadersStore[ry]=ny;const ay="oitBackBlendPixelShader",oy=`precision highp float;uniform sampler2D uBackColor;void main() {glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);if (glFragColor.a==0.0) { 
discard;}}`;X.ShadersStore[ay]=oy;class ly{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class kr{get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new li(10),this._excludedSubMeshes=new li(10),this._excludedMeshes=[],this._colorCache=[new He(kr._DEPTH_CLEAR_VALUE,kr._DEPTH_CLEAR_VALUE,0,0),new He(-kr._MIN_DEPTH,kr._MAX_DEPTH,0,0),new He(0,0,0,0)],this._scene=e,this._engine=e.getEngine(),this._passCount=t,!e.enablePrePassRenderer()){q.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.");return}for(let i=0;i<this._layoutCacheFormat.length;++i)this._layoutCache[i]=this._engine.buildTextureLayout(this._layoutCacheFormat[i]);this._renderPassIds=[],this.useRenderPasses=!1,this._prePassEffectConfiguration=new ly,this._createTextures(),this._createEffects()}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){const e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new jn("depthPeelingDepth0MRT",e,3,this._scene,void 0,["depthPeelingDepth0MRT_depth","depthPeelingDepth0MRT_frontColor","depthPeelingDepth0MRT_backColor"]),new jn("depthPeelingDepth1MRT",e,3,this._scene,void 0,["depthPeelingDepth1MRT_depth","depthPeelingDepth1MRT_frontColor","depthPeelingDepth1MRT_backColor"])],this._colorMrts=[new jn("depthPeelingColor0MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor0MRT_frontColor","depthPeelingColor0MRT_backColor"]),new jn("depthPeelingColor1MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor1MRT_frontColor","depthPeelingColor1MRT_backColor"])],this._blendBackMrt=new jn("depthPeelingBackMRT",e,1,this._scene,{generateDepthBuffer:!1},["depthPeelingBackMRT_blendBack"]),this._outputRT=new Ki("depthPeelingOutputRTT",e,this._scene,!1);const t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2,label:"DepthPeelingRenderer-DepthTexture"},{format:5,samplingMode:1,type:2,label:"DepthPeelingRenderer-ColorTexture"}];for(let i=0;i<2;i++){const s=this._engine._createInternalTexture(e,t[0],!1),r=this._engine._createInternalTexture(e,t[1],!1),n=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(s,0),this._depthMrts[i].setInternalTexture(r,1),this._depthMrts[i].setInternalTexture(n,2),this._colorMrts[i].setInternalTexture(r,0),this._colorMrts[i].setInternalTexture(n,1),this._thinTextures.push(new Qn(s),new Qn(r),new Qn(n))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)e!==6&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){var e;const t=this._scene.prePassRenderer;if(!t)return!1;const i=t.getIndex(4),s=!((e=t.defaultRT.textures)===null||e===void 0)&&e.length?t.defaultRT.textures[i].getInternalTexture():null;return s?(this._blendBackTexture!==s&&(this._blendBackTexture=s,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new Qn(this._blendBackTexture),t.defaultRT.renderTarget._shareDepth(this._depthMrts[0].renderTarget)),!0):!1}_createEffects(){this._blendBackEffectWrapper=new gn({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._blendBackEffectWrapperPingPong=new gn({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._finalEffectWrapper=new gn({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this._effectRenderer=new Cf(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[this._currentPingPongState*3]),e.setTexture("oitFrontColorSampler",this._thinTextures[this._currentPingPongState*3+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){const s=e.data[i].getMaterial();let r=!0,n=!1;const a=e.data[i];let l,h=!1;if(this._useRenderPasses&&(l=a._getDrawWrapper(),h=!l),s&&(r=s.allowShaderHotSwapping,n=s.backFaceCulling,s.allowShaderHotSwapping=!1,s.backFaceCulling=!1),a.render(!1),h&&(l=a._getDrawWrapper(),l.materialContext)){let c=t[l.materialContext.uniqueId];c||(c=t[l.materialContext.uniqueId]=this._engine.createMaterialContext()),a._getDrawWrapper().materialContext=c}s&&(s.allowShaderHotSwapping=r,s.backFaceCulling=n)}}_finalCompose(e){var t;((t=this._scene.prePassRenderer)===null||t===void 0?void 0:t.setCustomOutput(this._outputRT))?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[e*3+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}isReady(){return this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this.isReady())return this._excludedSubMeshes;this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport);for(let r=0;r<e.length;r++){const n=e.data[r],a=n.getMaterial(),l=a&&n.getRenderingMesh()._getRenderingFillMode(a.fillMode);a&&(l===Q.TriangleFanDrawMode||l===Q.TriangleFillMode||l===Q.TriangleStripDrawMode)&&this._excludedMeshes.indexOf(n.getMesh().uniqueId)===-1?this._candidateSubMeshes.push(n):this._excludedSubMeshes.push(n)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;const t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,s=0;for(let r=0;r<this._passCount;r++){i=r%2,s=1-i,this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[r+1]),this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport),this._engine.bindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindFramebuffer(this._colorMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[s].renderTarget),this._engine.bindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[s].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const n=s===0||!this._useRenderPasses?this._blendBackEffectWrapper:this._blendBackEffectWrapperPingPong;this._engine.enableEffect(n._drawWrapper),n.effect.setTexture("uBackColor",this._thinTextures[s*3+2]),this._effectRenderer.render(n),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(s),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}kr._DEPTH_CLEAR_VALUE=-99999;kr._MIN_DEPTH=0;kr._MAX_DEPTH=1;Object.defineProperty(Ve.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let o=this._getComponent(pe.NAME_DEPTHPEELINGRENDERER);o||(o=new hy(this),this._addComponent(o))}return this._depthPeelingRenderer},set:function(o){this._depthPeelingRenderer=o},enumerable:!0,configurable:!0});Object.defineProperty(Ve.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(o){var e;this._useOrderIndependentTransparency!==o&&(this._useOrderIndependentTransparency=o,this.markAllMaterialsAsDirty(63),(e=this.prePassRenderer)===null||e===void 0||e.markAsDirty())},enumerable:!0,configurable:!0});class hy{constructor(e){this.name=pe.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new kr(e)}register(){}rebuild(){}dispose(){var e;(e=this.scene.depthPeelingRenderer)===null||e===void 0||e.dispose(),this.scene.depthPeelingRenderer=null}}re._instancedMeshFactory=(o,e)=>{const t=new Zc(o,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class Zc extends pi{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.receiveShadows)!==e&&Y.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.material)!==e&&Y.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.visibility)!==e&&Y.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){var t;((t=this._sourceMesh)===null||t===void 0?void 0:t.skeleton)!==e&&Y.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||q.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}setVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,s),this.sourceMesh}updateVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,s),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||q.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==we.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new L);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,D.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(D.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,s){const r=(s||this._sourceMesh).createInstance(e);if(Yc.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(r.parent=t),!i)for(let n=0;n<this.getScene().meshes.length;n++){const a=this.getScene().meshes[n];a.parent===this&&a.clone(a.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);s&&i&&i(this,s);for(const r of this.getChildTransformNodes(!0))r.instantiateHierarchy(s,t,i);return s}}re.prototype.registerInstancedBuffer=function(o,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[o])===null||i===void 0||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const s of this.instances)s.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[o]=null,this._userInstancedBuffersStorage.strides[o]=e,this._userInstancedBuffersStorage.sizes[o]=e*32,this._userInstancedBuffersStorage.data[o]=new Float32Array(this._userInstancedBuffersStorage.sizes[o]),this._userInstancedBuffersStorage.vertexBuffers[o]=new T(this.getEngine(),this._userInstancedBuffersStorage.data[o],o,!0,!1,e,!0);for(const s of this.instances)s.instancedBuffers[o]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};re.prototype._processInstancedBuffers=function(o,e){const t=o?o.length:0;for(const i in this.instancedBuffers){let s=this._userInstancedBuffersStorage.sizes[i];const r=this._userInstancedBuffersStorage.strides[i],n=(t+1)*r;for(;s<n;)s*=2;this._userInstancedBuffersStorage.data[i].length!=s&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(s),this._userInstancedBuffersStorage.sizes[i]=s,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const a=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const h=this.instancedBuffers[i];h.toArray?h.toArray(a,l):h.copyToArray?h.copyToArray(a,l):a[l]=h,l+=r}for(let h=0;h<t;h++){const u=o[h].instancedBuffers[i];u.toArray?u.toArray(a,l):u.copyToArray?u.copyToArray(a,l):a[l]=u,l+=r}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new T(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,r,!0),this._invalidateInstanceVertexArrayObject())}};re.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const o in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[o]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};re.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const o in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[o]&&this._userInstancedBuffersStorage.vertexBuffers[o].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};const cy="colorPixelShader",uy=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}`;X.ShadersStore[cy]=uy;const dy="vertexColorMixing",fy=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;X.IncludesShadersStore[dy]=fy;const _y="colorVertexShader",py=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;X.ShadersStore[_y]=py;re._LinesMeshParser=(o,e)=>bn.Parse(o,e);class bn extends re{_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}constructor(e,t=null,i=null,s=null,r,n,a,l){super(e,t,i,s,r),this.useVertexColor=n,this.useVertexAlpha=a,this.color=new J(1,1,1),this.alpha=1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const h=[],c={attributes:[T.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:h,useClipPlane:null};a===!1?c.needAlphaBlending=!1:c.defines.push("#define VERTEXALPHA"),n?(c.defines.push("#define VERTEXCOLOR"),c.attributes.push(T.ColorKind)):(c.uniforms.push("color"),this._color4=new He),l?this.material=l:(this.material=new Rs("colorShader",this.getScene(),"color",c,!1),this.material.doNotSerialize=!0)}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=Q.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;const i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:s,g:r,b:n}=this.color;this._color4.set(s,r,n,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(Q.LineListDrawMode,e.verticesStart,e.verticesCount,i):s.drawElementsType(Q.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new bn(e,this.getScene(),t,this,i)}createInstance(e){const t=new Km(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new bn(e.name,t);return i.color=J.FromArray(e.color),i.alpha=e.alpha,i}}class Km extends Zc{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}const gy="logDepthDeclaration",my=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;X.IncludesShadersStore[gy]=my;const Ey="logDepthFragment",Ty=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;X.IncludesShadersStore[Ey]=Ty;const vy="linePixelShader",Ay=`#include<clipPlaneFragmentDeclaration>
uniform vec4 color;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<logDepthFragment>
#include<clipPlaneFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;X.ShadersStore[vy]=Ay;const Ry="logDepthVertex",by=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;X.IncludesShadersStore[Ry]=by;const Sy="lineVertexShader",yy=`#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec4 normal;uniform mat4 viewProjection;uniform float width;uniform float aspectRatio;
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;vec4 viewPosition=worldViewProjection*vec4(position,1.0);vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);vec2 currentScreen=viewPosition.xy/viewPosition.w;vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;currentScreen.x*=aspectRatio;nextScreen.x*=aspectRatio;vec2 dir=normalize(nextScreen-currentScreen);vec2 normalDir=vec2(-dir.y,dir.x);normalDir*=width/2.0;normalDir.x/=aspectRatio;vec4 offset=vec4(normalDir*normal.w,0.0,0.0);gl_Position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<clipPlaneVertex>
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;X.ShadersStore[Sy]=yy;pi.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this};pi.prototype.enableEdgesRendering=function(o=.95,e=!1,t){return this.disableEdgesRendering(),this._edgesRenderer=new Qc(this,o,e,!0,t),this};Object.defineProperty(pi.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0});bn.prototype.enableEdgesRendering=function(o=.95,e=!1){return this.disableEdgesRendering(),this._edgesRenderer=new xy(this,o,e),this};Km.prototype.enableEdgesRendering=function(o=.95,e=!1){return bn.prototype.enableEdgesRendering.apply(this,arguments),this};class Cy{constructor(){this.edges=[],this.edgesConnectedCount=0}}class Qc{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e){if(!e._edgeRenderLineShader){const t=new Rs("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader}constructor(e,t=.95,i=!1,s=!0,r){var n;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new li(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=r??null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new _r(e.getEngine())),this._prepareRessources(),s&&(!((n=r==null?void 0:r.useAlternateEdgeFinder)!==null&&n!==void 0)||n?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}_prepareRessources(){this._lineShader||(this._lineShader=Qc._GetShader(this._source.getScene()))}_rebuild(){let e=this._buffers[T.PositionKind];e&&e._rebuild(),e=this._buffers[T.NormalKind],e&&e._rebuild();const i=this._source.getScene().getEngine();this._ib=i.createIndexBuffer(this._linesIndices)}dispose(){var e;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let t=this._buffers[T.PositionKind];t&&(t.dispose(),this._buffers[T.PositionKind]=null),t=this._buffers[T.NormalKind],t&&(t.dispose(),this._buffers[T.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),(e=this._drawWrapper)===null||e===void 0||e.dispose()}_processEdgeForAdjacencies(e,t,i,s,r){return e===i&&t===s||e===s&&t===i?0:e===s&&t===r||e===r&&t===s?1:e===r&&t===i||e===i&&t===r?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,s,r){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(s,1e-10)||e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(r,1e-10)||e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(s,1e-10)?1:e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(r,1e-10)?2:-1}_checkEdge(e,t,i,s,r){let n;t===void 0?n=!0:n=m.Dot(i[e],i[t])<this._epsilon,n&&this.createLine(s,r,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,s){const r=(O,N,w)=>{w>=0&&N.push(w);for(let G=0;G<O.length;++G)N.push(O[G][0])};let n=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?n=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(n=2);for(let O=0;O<3;++O)O===n?e[O].sort((N,w)=>N[1]<w[1]?-1:N[1]>w[1]?1:0):e[O].sort((N,w)=>N[1]>w[1]?-1:N[1]<w[1]?1:0);const a=[],l=[];r(e[n],a,-1);const h=a.length;for(let O=n+2;O>=n+1;--O)r(e[O%3],l,O!==n+2?s[i[t+(O+1)%3]]:-1);const c=l.length,u=0,d=0;i.push(s[i[t+n]],a[0],l[0]),i.push(s[i[t+(n+1)%3]],l[c-1],a[h-1]);const f=h<=c,p=f?h:c,_=f?c:h,g=f?h-1:c-1,E=f?0:1;let R=h+c-2,x=f?u:d,S=f?d:u;const b=f?a:l,y=f?l:a;let I=0;for(;R-- >0;){E?i.push(b[x],y[S]):i.push(y[S],b[x]),I+=p;let O;I>=_&&x<g?(O=b[++x],I-=_):O=y[++S],i.push(O)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){var e,t,i,s,r,n,a,l,h,c;const u=this._source.getVerticesData(T.PositionKind);let d=this._source.getIndices();if(!d||!u)return;Array.isArray(d)||(d=Array.from(d));const f=(t=(e=this._options)===null||e===void 0?void 0:e.useFastVertexMerger)!==null&&t!==void 0?t:!0,p=f?Math.round(-Math.log((s=(i=this._options)===null||i===void 0?void 0:i.epsilonVertexMerge)!==null&&s!==void 0?s:1e-6)/Math.log(10)):(n=(r=this._options)===null||r===void 0?void 0:r.epsilonVertexMerge)!==null&&n!==void 0?n:1e-6,_=[],g=[];if(f){const x={};for(let S=0;S<u.length;S+=3){const b=u[S+0],y=u[S+1],I=u[S+2],O=b.toFixed(p)+"|"+y.toFixed(p)+"|"+I.toFixed(p);if(x[O]!==void 0)_.push(x[O]);else{const N=S/3;x[O]=N,_.push(N),g.push(N)}}}else for(let x=0;x<u.length;x+=3){const S=u[x+0],b=u[x+1],y=u[x+2];let I=!1;for(let O=0;O<x&&!I;O+=3){const N=u[O+0],w=u[O+1],G=u[O+2];if(Math.abs(S-N)<p&&Math.abs(b-w)<p&&Math.abs(y-G)<p){_.push(O/3),I=!0;break}}I||(_.push(x/3),g.push(x/3))}if(!((a=this._options)===null||a===void 0)&&a.applyTessellation){const x=(h=(l=this._options)===null||l===void 0?void 0:l.epsilonVertexAligned)!==null&&h!==void 0?h:1e-6,S=[];for(let b=0;b<d.length;b+=3){let y;for(let I=0;I<3;++I){const O=_[d[b+I]],N=_[d[b+(I+1)%3]],w=_[d[b+(I+2)%3]];if(O===N)continue;const G=u[O*3+0],k=u[O*3+1],de=u[O*3+2],ae=u[N*3+0],_e=u[N*3+1],Ce=u[N*3+2],ce=Math.sqrt((ae-G)*(ae-G)+(_e-k)*(_e-k)+(Ce-de)*(Ce-de));for(let ze=0;ze<g.length-1;ze++){const We=g[ze];if(We===O||We===N||We===w)continue;const nt=u[We*3+0],ne=u[We*3+1],Ue=u[We*3+2],Je=Math.sqrt((nt-G)*(nt-G)+(ne-k)*(ne-k)+(Ue-de)*(Ue-de)),St=Math.sqrt((nt-ae)*(nt-ae)+(ne-_e)*(ne-_e)+(Ue-Ce)*(Ue-Ce));Math.abs(Je+St-ce)<x&&(y||(y={index:b,edgesPoints:[[],[],[]]},S.push(y)),y.edgesPoints[I].push([We,Je]))}}}for(let b=0;b<S.length;++b){const y=S[b];this._tessellateTriangle(y.edgesPoints,y.index,d,_)}S.length=0}const E={};for(let x=0;x<d.length;x+=3){let S;for(let b=0;b<3;++b){let y=_[d[x+b]],I=_[d[x+(b+1)%3]];const O=_[d[x+(b+2)%3]];if(y===I||(y===O||I===O)&&(!((c=this._options)===null||c===void 0)&&c.removeDegeneratedTriangles))continue;if(D.Vector3[0].copyFromFloats(u[y*3+0],u[y*3+1],u[y*3+2]),D.Vector3[1].copyFromFloats(u[I*3+0],u[I*3+1],u[I*3+2]),D.Vector3[2].copyFromFloats(u[O*3+0],u[O*3+1],u[O*3+2]),S||(D.Vector3[1].subtractToRef(D.Vector3[0],D.Vector3[3]),D.Vector3[2].subtractToRef(D.Vector3[1],D.Vector3[4]),S=m.Cross(D.Vector3[3],D.Vector3[4]),S.normalize()),y>I){const G=y;y=I,I=G}const N=y+"_"+I,w=E[N];w?w.done||(m.Dot(S,w.normal)<this._epsilon&&this.createLine(D.Vector3[0],D.Vector3[1],this._linesPositions.length/3),w.done=!0):E[N]={normal:S,done:!1,index:x,i:b}}}for(const x in E){const S=E[x];if(!S.done){const b=_[d[S.index+S.i]],y=_[d[S.index+(S.i+1)%3]];D.Vector3[0].copyFromFloats(u[b*3+0],u[b*3+1],u[b*3+2]),D.Vector3[1].copyFromFloats(u[y*3+0],u[y*3+1],u[y*3+2]),this.createLine(D.Vector3[0],D.Vector3[1],this._linesPositions.length/3)}}const R=this._source.getScene().getEngine();this._buffers[T.PositionKind]=new T(R,this._linesPositions,T.PositionKind,!1),this._buffers[T.NormalKind]=new T(R,this._linesNormals,T.NormalKind,!1,!1,4),this._buffersForInstances[T.PositionKind]=this._buffers[T.PositionKind],this._buffersForInstances[T.NormalKind]=this._buffers[T.NormalKind],this._ib=R.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(T.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=[],s=[];let r,n;for(r=0;r<t.length;r+=3){n=new Cy;const l=t[r],h=t[r+1],c=t[r+2];n.p0=new m(e[l*3],e[l*3+1],e[l*3+2]),n.p1=new m(e[h*3],e[h*3+1],e[h*3+2]),n.p2=new m(e[c*3],e[c*3+1],e[c*3+2]);const u=m.Cross(n.p1.subtract(n.p0),n.p2.subtract(n.p1));u.normalize(),s.push(u),i.push(n)}for(r=0;r<i.length;r++){n=i[r];for(let l=r+1;l<i.length;l++){const h=i[l];if(n.edgesConnectedCount===3)break;if(h.edgesConnectedCount===3)continue;const c=t[l*3],u=t[l*3+1],d=t[l*3+2];for(let f=0;f<3;f++){let p=0;if(n.edges[f]===void 0){switch(f){case 0:this._checkVerticesInsteadOfIndices?p=this._processEdgeForAdjacenciesWithVertices(n.p0,n.p1,h.p0,h.p1,h.p2):p=this._processEdgeForAdjacencies(t[r*3],t[r*3+1],c,u,d);break;case 1:this._checkVerticesInsteadOfIndices?p=this._processEdgeForAdjacenciesWithVertices(n.p1,n.p2,h.p0,h.p1,h.p2):p=this._processEdgeForAdjacencies(t[r*3+1],t[r*3+2],c,u,d);break;case 2:this._checkVerticesInsteadOfIndices?p=this._processEdgeForAdjacenciesWithVertices(n.p2,n.p0,h.p0,h.p1,h.p2):p=this._processEdgeForAdjacencies(t[r*3+2],t[r*3],c,u,d);break}if(p!==-1&&(n.edges[f]=l,h.edges[p]=r,n.edgesConnectedCount++,h.edgesConnectedCount++,n.edgesConnectedCount===3))break}}}}for(r=0;r<i.length;r++){const l=i[r];this._checkEdge(r,l.edges[0],s,l.p0,l.p1),this._checkEdge(r,l.edges[1],s,l.p1,l.p2),this._checkEdge(r,l.edges[2],s,l.p2,l.p0)}const a=this._source.getScene().getEngine();this._buffers[T.PositionKind]=new T(a,this._linesPositions,T.PositionKind,!1),this._buffers[T.NormalKind]=new T(a,this._linesNormals,T.NormalKind,!1,!1,4),this._buffersForInstances[T.PositionKind]=this._buffers[T.PositionKind],this._buffersForInstances[T.NormalKind]=this._buffers[T.NormalKind],this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera){this._lineShader._setDrawWrapper(t);return}const i=this._source.hasInstances&&this.customInstances.length>0,s=i||this._source.hasThinInstances;let r=0;if(s)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const a=this._source._instanceDataStorage;if(r=this.customInstances.length,!a.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!a.isFrozen){let l=0;for(let h=0;h<r;++h)this.customInstances.data[h].copyToArray(a.instancesData,l),l+=16;a.instancesBuffer.updateDirectly(a.instancesData,0,r)}}else r=this._source.thinInstanceCount;const n=e.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?n.setAlphaMode(2):n.setAlphaMode(0),n.bindBuffers(s?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===De.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",n.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),n.drawElementsType(Q.TriangleFillMode,0,this._indicesCount,r),this._lineShader.unbind(),s&&n.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class xy extends Qc{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(T.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=D.Vector3[0],s=D.Vector3[1],r=t.length-1;for(let a=0,l=0;a<r;a+=2,l+=4)m.FromArrayToRef(e,3*t[a],i),m.FromArrayToRef(e,3*t[a+1],s),this.createLine(i,s,l);const n=this._source.getScene().getEngine();this._buffers[T.PositionKind]=new T(n,this._linesPositions,T.PositionKind,!1),this._buffers[T.NormalKind]=new T(n,this._linesNormals,T.NormalKind,!1,!1,4),this._ib=n.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}const My="mrtFragmentDeclaration",Iy=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;X.IncludesShadersStore[My]=Iy;const Py="bumpFragmentMainFunctions",Dy=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;X.IncludesShadersStore[Py]=Dy;const Oy="samplerFragmentDeclaration",Ny=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;X.IncludesShadersStore[Oy]=Ny;const Ly="bumpFragmentFunctions",Fy=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;X.IncludesShadersStore[Ly]=Fy;const wy="bumpFragment",By=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;X.IncludesShadersStore[wy]=By;const Uy="geometryPixelShader",ky=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
uniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;
#endif
#ifdef ALBEDOTEXTURE
varying vec2 vAlbedoUV;uniform sampler2D albedoSampler;
#endif
#ifdef REFLECTIVITYCOLOR
uniform vec3 reflectivityColor;
#endif
#ifdef ALBEDOCOLOR
uniform vec3 albedoColor;
#endif
#ifdef METALLIC
uniform float metallic;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform float glossiness;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
void main() {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#endif
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
#ifdef PREPASS
#ifdef PREPASS_DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#else
gl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);gl_FragData[1]=vec4(normalOutput,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
vec4 reflectivity=vec4(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
float metal=1.0;float roughness=1.0;
#ifdef ORMTEXTURE
metal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-glossiness); 
#endif
reflectivity.a-=roughness;vec3 color=vec3(1.0);
#ifdef ALBEDOTEXTURE
color=texture2D(albedoSampler,vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpace(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=albedoColor.xyz;
#endif
reflectivity.rgb=mix(vec3(0.04),color,metal);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;
#endif
#endif
#ifdef GLOSSINESSS
reflectivity.a*=glossiness; 
#endif
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;X.ShadersStore[Uy]=ky;const Vy="geometryVertexDeclaration",Gy="uniform mat4 viewProjection;uniform mat4 view;";X.IncludesShadersStore[Vy]=Gy;const zy="sceneUboDeclaration",Hy=`layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;mat4 projection;vec4 vEyePosition;};
`;X.IncludesShadersStore[zy]=Hy;const Wy="geometryUboDeclaration",Xy=`#include<sceneUboDeclaration>
`;X.IncludesShadersStore[Wy]=Xy;const Yy="bumpVertex",Ky=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;X.IncludesShadersStore[Yy]=Ky;const $y="geometryVertexShader",jy=`precision highp float;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;vNormalW=normalUpdated;
#else
#ifdef NORMAL_WORLDSPACE
vNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
#endif
vViewPos=view*worldPos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=worldPos.xyz/worldPos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uv;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef ALBEDO_UV1
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#else
vUV=uv2;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef ALBEDO_UV2
vAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;X.ShadersStore[$y]=jy;class ie{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,H.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,H.MarkAllMaterialsAsDirty(1))}}ie._DiffuseTextureEnabled=!0;ie._DetailTextureEnabled=!0;ie._DecalMapEnabled=!0;ie._AmbientTextureEnabled=!0;ie._OpacityTextureEnabled=!0;ie._ReflectionTextureEnabled=!0;ie._EmissiveTextureEnabled=!0;ie._SpecularTextureEnabled=!0;ie._BumpTextureEnabled=!0;ie._LightmapTextureEnabled=!0;ie._RefractionTextureEnabled=!0;ie._ColorGradingTextureEnabled=!0;ie._FresnelEnabled=!0;ie._ClearCoatTextureEnabled=!0;ie._ClearCoatBumpTextureEnabled=!0;ie._ClearCoatTintTextureEnabled=!0;ie._SheenTextureEnabled=!0;ie._AnisotropicTextureEnabled=!0;ie._ThicknessTextureEnabled=!0;ie._RefractionIntensityTextureEnabled=!0;ie._TranslucencyIntensityTextureEnabled=!0;ie._IridescenceTextureEnabled=!0;const $m=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];In($m);class Ot{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===Ot.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===Ot.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===Ot.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===Ot.DEPTH_TEXTURE_TYPE?this._depthIndex=t:e===Ot.NORMAL_TEXTURE_TYPE&&(this._normalIndex=t)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case Ot.POSITION_TEXTURE_TYPE:return this._positionIndex;case Ot.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case Ot.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case Ot.DEPTH_TEXTURE_TYPE:return this._linkedWithPrePass?this._depthIndex:0;case Ot.NORMAL_TEXTURE_TYPE:return this._linkedWithPrePass?this._normalIndex:1;default:return-1}}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return typeof this._ratioOrDimensions=="object"?1:this._ratioOrDimensions}constructor(e,t=1,i=15,s){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._clearColor=new He(0,0,0,0),this._clearDepthColor=new He(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,this._textureTypesAndFormats=s||{},Ot._SceneComponentInitialization(this._scene),this._createRenderTargets()}isReady(e,t){const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const s=[],r=[T.PositionKind,T.NormalKind],n=e.getMesh();if(i){let f=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(s.push("#define ALPHATEST"),s.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),f=!0),i.bumpTexture&&ie.BumpTextureEnabled&&(s.push("#define BUMP"),s.push(`#define BUMP_UV${i.bumpTexture.coordinatesIndex+1}`),f=!0),this._enableReflectivity){let p=!1;i.getClassName()==="PBRMetallicRoughnessMaterial"?(i.metallicRoughnessTexture!==null&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),f=!0,p=!0),i.metallic!==null&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),p=!0),i.roughness!==null&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),p=!0),p&&(i.baseTexture!==null&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),f=!0),i.baseColor!==null&&s.push("#define ALBEDOCOLOR"))):i.getClassName()==="PBRSpecularGlossinessMaterial"?(i.specularGlossinessTexture!==null?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),f=!0,i.specularGlossinessTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor!==null&&s.push("#define REFLECTIVITYCOLOR"),i.glossiness!==null&&s.push("#define GLOSSINESS")):i.getClassName()==="PBRMaterial"?(i.metallicTexture!==null&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),f=!0,p=!0),i.metallic!==null&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),p=!0),i.roughness!==null&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),p=!0),p?(i.albedoTexture!==null&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),f=!0),i.albedoColor!==null&&s.push("#define ALBEDOCOLOR")):(i.reflectivityTexture!==null?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0):i.reflectivityColor!==null&&s.push("#define REFLECTIVITYCOLOR"),i.microSurface!==null&&s.push("#define GLOSSINESS"))):i.getClassName()==="StandardMaterial"&&(i.specularTexture!==null&&(s.push("#define REFLECTIVITYTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0),i.specularColor!==null&&s.push("#define REFLECTIVITYCOLOR"))}f&&(s.push("#define NEED_UV"),n.isVerticesDataPresent(T.UVKind)&&(r.push(T.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(T.UV2Kind)&&(r.push(T.UV2Kind),s.push("#define UV2")))}this._linkedWithPrePass&&(s.push("#define PREPASS"),this._depthIndex!==-1&&(s.push("#define DEPTH_INDEX "+this._depthIndex),s.push("#define PREPASS_DEPTH")),this._normalIndex!==-1&&(s.push("#define NORMAL_INDEX "+this._normalIndex),s.push("#define PREPASS_NORMAL"))),this._enablePosition&&(s.push("#define POSITION"),s.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(s.push("#define VELOCITY"),s.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(n)===-1&&s.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(s.push("#define REFLECTIVITY"),s.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this.generateNormalsInWorldSpace&&s.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&s.push("#define ENCODE_NORMAL"),n.useBones&&n.computeBonesUsingShaders&&n.skeleton?(r.push(T.MatricesIndicesKind),r.push(T.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(T.MatricesIndicesExtraKind),r.push(T.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BONETEXTURE "+n.skeleton.isUsingTextureForMatrices),s.push("#define BonesPerMesh "+(n.skeleton.bones.length+1))):(s.push("#define NUM_BONE_INFLUENCERS 0"),s.push("#define BONETEXTURE false"),s.push("#define BonesPerMesh 0"));const a=n.morphTargetManager;let l=0;a&&a.numInfluencers>0&&(l=a.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+l),a.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(r,n,l)),t&&(s.push("#define INSTANCES"),se.PushAttributesForInstances(r,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this._linkedWithPrePass?s.push("#define RENDER_TARGET_COUNT "+this._attachmentsFromPrePass.length):s.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length),Mh(i,this._scene,s);const h=this._scene.getEngine(),c=e._getDrawWrapper(void 0,!0),u=c.defines,d=s.join(`
`);return u!==d&&c.setEffect(h.createEffect("geometry",{attributes:r,uniformsNames:$m,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:d,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:l}},h),d),c.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[],t=[];let i=2;return e.push("gBuffer_Depth","gBuffer_Normal"),t.push(this._textureTypesAndFormats[Ot.DEPTH_TEXTURE_TYPE]),t.push(this._textureTypesAndFormats[Ot.NORMAL_TEXTURE_TYPE]),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[Ot.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[Ot.VELOCITY_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[Ot.REFLECTIVITY_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i,s]=this._assignRenderTargetIndices();let r=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?r=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(r=2);const n=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},a=[],l=[];for(const g of s)g?(a.push(g.textureType),l.push(g.textureFormat)):(a.push(r),l.push(5));if(this._normalsAreUnsigned=a[Ot.NORMAL_TEXTURE_TYPE]===11||a[Ot.NORMAL_TEXTURE_TYPE]===13,this._multiRenderTarget=new jn("gBuffer",n,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:a,formats:l,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=V.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=V.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;const h=[!0],c=[!1],u=[!0];for(let g=1;g<t;++g)h.push(!0),u.push(!1),c.push(!0);const d=e.buildTextureLayout(h),f=e.buildTextureLayout(c),p=e.buildTextureLayout(u);this._multiRenderTarget.onClearObservable.add(g=>{g.bindAttachments(this.useSpecificClearForDepthTexture?f:d),g.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(g.bindAttachments(p),g.clear(this._clearDepthColor,!0,!0,!0)),g.bindAttachments(d)}),this._resizeObserver=e.onResizeObservable.add(()=>{if(this._multiRenderTarget){const g=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(g)}});const _=g=>{const E=g.getRenderingMesh(),R=g.getEffectiveMesh(),x=this._scene,S=x.getEngine(),b=g.getMaterial();if(!b)return;if(R._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[R.uniqueId]&&(this._previousTransformationMatrices[R.uniqueId]={world:L.Identity(),viewProjection:x.getTransformMatrix()},E.skeleton)){const N=E.skeleton.getTransformMatrices(E);this._previousBonesTransformationMatrices[E.uniqueId]=this._copyBonesTransformationMatrices(N,new Float32Array(N.length))}const y=E._getInstancesRenderList(g._id,!!g.getReplacementMesh());if(y.mustReturn)return;const I=S.getCaps().instancedArrays&&(y.visibleInstances[g._id]!==null||E.hasThinInstances),O=R.getWorldMatrix();if(this.isReady(g,I)){const N=g._getDrawWrapper();if(!N)return;const w=N.effect;S.enableEffect(N),I||E._bind(g,w,b.fillMode),this._useUbo?(se.BindSceneUniformBuffer(w,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(w.setMatrix("viewProjection",x.getTransformMatrix()),w.setMatrix("view",x.getViewMatrix()));let G;const k=E._instanceDataStorage;if(!k.isFrozen&&(b.backFaceCulling||E.overrideMaterialSideOrientation!==null)){const de=R._getWorldMatrixDeterminant();G=E.overrideMaterialSideOrientation,G===null&&(G=b.sideOrientation),de<0&&(G=G===Q.ClockWiseSideOrientation?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation)}else G=k.sideOrientation;if(b._preBind(N,G),b.needAlphaTesting()){const de=b.getAlphaTestTexture();de&&(w.setTexture("diffuseSampler",de),w.setMatrix("diffuseMatrix",de.getTextureMatrix()))}if(b.bumpTexture&&x.getEngine().getCaps().standardDerivatives&&ie.BumpTextureEnabled&&(w.setFloat3("vBumpInfos",b.bumpTexture.coordinatesIndex,1/b.bumpTexture.level,b.parallaxScaleBias),w.setMatrix("bumpMatrix",b.bumpTexture.getTextureMatrix()),w.setTexture("bumpSampler",b.bumpTexture),w.setFloat2("vTangentSpaceParams",b.invertNormalMapX?-1:1,b.invertNormalMapY?-1:1)),this._enableReflectivity&&(b.getClassName()==="PBRMetallicRoughnessMaterial"?(b.metallicRoughnessTexture!==null&&(w.setTexture("reflectivitySampler",b.metallicRoughnessTexture),w.setMatrix("reflectivityMatrix",b.metallicRoughnessTexture.getTextureMatrix())),b.metallic!==null&&w.setFloat("metallic",b.metallic),b.roughness!==null&&w.setFloat("glossiness",1-b.roughness),b.baseTexture!==null&&(w.setTexture("albedoSampler",b.baseTexture),w.setMatrix("albedoMatrix",b.baseTexture.getTextureMatrix())),b.baseColor!==null&&w.setColor3("albedoColor",b.baseColor)):b.getClassName()==="PBRSpecularGlossinessMaterial"?(b.specularGlossinessTexture!==null?(w.setTexture("reflectivitySampler",b.specularGlossinessTexture),w.setMatrix("reflectivityMatrix",b.specularGlossinessTexture.getTextureMatrix())):b.specularColor!==null&&w.setColor3("reflectivityColor",b.specularColor),b.glossiness!==null&&w.setFloat("glossiness",b.glossiness)):b.getClassName()==="PBRMaterial"?(b.metallicTexture!==null&&(w.setTexture("reflectivitySampler",b.metallicTexture),w.setMatrix("reflectivityMatrix",b.metallicTexture.getTextureMatrix())),b.metallic!==null&&w.setFloat("metallic",b.metallic),b.roughness!==null&&w.setFloat("glossiness",1-b.roughness),b.roughness!==null||b.metallic!==null||b.metallicTexture!==null?(b.albedoTexture!==null&&(w.setTexture("albedoSampler",b.albedoTexture),w.setMatrix("albedoMatrix",b.albedoTexture.getTextureMatrix())),b.albedoColor!==null&&w.setColor3("albedoColor",b.albedoColor)):(b.reflectivityTexture!==null?(w.setTexture("reflectivitySampler",b.reflectivityTexture),w.setMatrix("reflectivityMatrix",b.reflectivityTexture.getTextureMatrix())):b.reflectivityColor!==null&&w.setColor3("reflectivityColor",b.reflectivityColor),b.microSurface!==null&&w.setFloat("glossiness",b.microSurface))):b.getClassName()==="StandardMaterial"&&(b.specularTexture!==null&&(w.setTexture("reflectivitySampler",b.specularTexture),w.setMatrix("reflectivityMatrix",b.specularTexture.getTextureMatrix())),b.specularColor!==null&&w.setColor3("reflectivityColor",b.specularColor))),Pn(w,b,this._scene),E.useBones&&E.computeBonesUsingShaders&&E.skeleton){const de=E.skeleton;if(de.isUsingTextureForMatrices&&w.getUniformIndex("boneTextureWidth")>-1){const ae=de.getTransformMatrixTexture(E);w.setTexture("boneSampler",ae),w.setFloat("boneTextureWidth",4*(de.bones.length+1))}else w.setMatrices("mBones",E.skeleton.getTransformMatrices(E));this._enableVelocity&&w.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[E.uniqueId])}se.BindMorphTargetParameters(E,w),E.morphTargetManager&&E.morphTargetManager.isUsingTextureForTargets&&E.morphTargetManager._bind(w),this._enableVelocity&&(w.setMatrix("previousWorld",this._previousTransformationMatrices[R.uniqueId].world),w.setMatrix("previousViewProjection",this._previousTransformationMatrices[R.uniqueId].viewProjection)),I&&E.hasThinInstances&&w.setMatrix("world",O),E._processRendering(R,g,w,b.fillMode,y,I,(de,ae)=>{de||w.setMatrix("world",ae)})}this._enableVelocity&&(this._previousTransformationMatrices[R.uniqueId].world=O.clone(),this._previousTransformationMatrices[R.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),E.skeleton&&this._copyBonesTransformationMatrices(E.skeleton.getTransformMatrices(E),this._previousBonesTransformationMatrices[R.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(g,E,R)=>{if((R||E===0)&&g.subMeshes)for(let x=0;x<g.subMeshes.length;++x){const S=g.subMeshes[x],b=S.getMaterial(),y=S.getRenderingMesh();if(!b)continue;const I=y._getInstancesRenderList(S._id,!!S.getReplacementMesh()),O=e.getCaps().instancedArrays&&(I.visibleInstances[S._id]!==null||y.hasThinInstances);if(!this.isReady(S,O))return!1}return!0},this._multiRenderTarget.customRenderFunction=(g,E,R,x)=>{let S;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(x.length){for(e.setColorWrite(!1),S=0;S<x.length;S++)_(x.data[S]);e.setColorWrite(!0)}for(S=0;S<g.length;S++)_(g.data[S]);for(e.setDepthWrite(!1),S=0;S<E.length;S++)_(E.data[S]);if(this.renderTransparentMeshes)for(S=0;S<R.length;S++)_(R.data[S]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}Ot.DEPTH_TEXTURE_TYPE=0;Ot.NORMAL_TEXTURE_TYPE=1;Ot.POSITION_TEXTURE_TYPE=2;Ot.VELOCITY_TEXTURE_TYPE=3;Ot.REFLECTIVITY_TEXTURE_TYPE=4;Ot._SceneComponentInitialization=o=>{throw ke("GeometryBufferRendererSceneComponent")};Object.defineProperty(Ve.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(o){o&&o.isSupported&&(this._geometryBufferRenderer=o)},enumerable:!0,configurable:!0});Ve.prototype.enableGeometryBufferRenderer=function(o=1,e=15,t){return this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new Ot(this,o,e,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)};Ve.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class qy{constructor(e){this.name=pe.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(pe.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}Ot._SceneComponentInitialization=o=>{let e=o._getComponent(pe.NAME_GEOMETRYBUFFERRENDERER);e||(e=new qy(o),o._addComponent(e))};const Zy="imageProcessingDeclaration",Qy=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;X.IncludesShadersStore[Zy]=Qy;const Jy="imageProcessingFunctions",eC=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);vec3 RRTAndODTFit(vec3 v)
{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
vec3 ACESFitted(vec3 color)
{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;}`;X.IncludesShadersStore[Jy]=eC;const tC="imageProcessingPixelShader",iC=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;}`;X.ShadersStore[tC]=iC;class jm extends ht{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let i=null;const s=this.getEngine(),r=this.getCamera();if(r)i=r.getScene();else if(s&&s.scenes){const n=s.scenes;i=n[n.length-1]}else i=Ze.LastCreatedScene;i?this._imageProcessingConfiguration=i.imageProcessingConfiguration:this._imageProcessingConfiguration=new st}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,s,r,n,a=0,l){super(e,"imageProcessing",[],[],t,i,s,r,n,null,a,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},l?(l.applyByPostProcess=!0,this._attachImageProcessingConfiguration(l,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=h=>{this.imageProcessingConfiguration.bind(h,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const s in this._defines)this._defines[s]&&(e+=`#define ${s};
`);const t=["textureSampler"],i=["scale"];st&&(st.PrepareSamplers(t,this._defines),st.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}v([M()],jm.prototype,"_fromLinearSpace",void 0);class sC extends jn{constructor(e,t,i,s,r,n){super(e,i,s,r,n),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new jm("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),s=this.getRenderHeight();(i!==e||s!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);t!==-1&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class Ni{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(e){this._generateNormalsInWorldSpace!==e&&(this._generateNormalsInWorldSpace=e,this._markAllMaterialsAsPrePassDirty())}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(e){this._useSpecificClearForDepthTexture!==e&&(this._useSpecificClearForDepthTexture=e,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){var t,i;e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=(i=(t=this._scene.activeCamera)===null||t===void 0?void 0:t.renderPassId)!==null&&i!==void 0?i:this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=!1,this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new He(0,0,0,0),this._clearDepthColor=new He(1e8,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine();let t=0;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?t=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(t=2);for(let i=0;i<Ni.TextureFormats.length;++i){const s=Ni.TextureFormats[i].format;Ni.TextureFormats[i].type===1&&(Ni.TextureFormats[5].type=t,(s===6||s===7||s===5)&&!this._engine._caps.supportFloatTexturesResolve&&(Ni.TextureFormats[5].type=2))}Ni._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(e,t){const i=new sC(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),this._enabled&&this._update(),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const i=t.getMaterial(),s=i&&i.isPrePassCapable,r=i&&this.excludedMaterials.indexOf(i)!==-1;this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&s&&!r?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!r&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){const e=[],t=[!1],i=[!1],s=[!0];for(let r=0;r<this.mrtCount;r++)e.push(!0),r>0&&(this._useSpecificClearForDepthTexture&&this._mrtLayout[r]===5?(t.push(!1),i.push(!0)):(t.push(!0),i.push(!1)),s.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._clearDepthAttachments=this._engine.buildTextureLayout(i),this._defaultAttachments=this._engine.buildTextureLayout(s)}_resetLayout(){for(let e=0;e<Ni.TextureFormats.length;e++)this._textureIndices[Ni.TextureFormats[e].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[Ni.TextureFormats[4].type],this._mrtFormats=[Ni.TextureFormats[4].format],this._mrtNames=[Ni.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let i=0;i<this._mrtLayout.length;i++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:5,geometryBufferConstant:Ot.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:Ot.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:Ot.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:Ot.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:Ot.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){const s=this._mrtLayout.indexOf(t[i].prePassConstant);s!==-1&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,s),e[s]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return t?(t.inputTexture=e.renderTarget,!0):!1}_renderPostProcesses(e,t){var i;const s=this._postProcessesSourceForThisPass[0],r=s?s.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let n=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(n=n.concat([this._currentTarget.imageProcessingPostProcess])),n.length&&(this._scene.postProcessManager._prepareFrame((i=this._currentTarget.renderTarget)===null||i===void 0?void 0:i.texture,n),this._scene.postProcessManager.directRender(n,r,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const e=this._currentTarget.renderTarget;e&&this._engine.bindFramebuffer(e)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e}getEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e)return this._effectConfigurations[t];return null}_enable(){const e=this.mrtCount;for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].enabled&&this._enableTextures(this._effectConfigurations[t].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){(this.mrtCount!==e||this.renderTargets[t].count!==this.mrtCount)&&this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let i=0;i<this._effectConfigurations.length;i++)this._effectConfigurations[i].enabled&&(!this._effectConfigurations[i].postProcess&&this._effectConfigurations[i].createPostProcess&&this._effectConfigurations[i].createPostProcess(),this._effectConfigurations[i].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[i].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture)if(e.renderTargetTexture.useCameraPostProcesses){const i=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return i?i._postProcesses:[]}else return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(t)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(l=>l!=null),this._scene.autoClear=!0;const s=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!s&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;const r=this._getFirstPostProcess(this._postProcessesSourceForThisPass),n=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let a=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||s,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),n?a=n:this._needsCompositionForThisPass?a=e.imageProcessingPostProcess:r&&(a=r),this._bindFrameBuffer(),this._linkInternalTexture(e,a)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){var t;let i=!1;if(e){for(let s=0;s<e.length;s++)if(((t=e[s])===null||t===void 0?void 0:t.getClassName())==="ImageProcessingPostProcess"){i=!0;break}}return i}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(e[t]!==null)return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){const i=e[t];this._textureIndices[i]===-1&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtTypes.push(Ni.TextureFormats[i].type),this._mrtFormats.push(Ni.TextureFormats[i].format),this._mrtNames.push(Ni.TextureFormats[i].name),this.mrtCount++),i===2&&(this._scene.needsPreviousWorldMatrices=!0)}}update(){this._isDirty&&this._update()}_update(){this._disable();let e=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),e=!0);for(let i=0;i<this._scene.materials.length;i++)this._scene.materials[i].setPrePassRenderer(this)&&(e=!0);e&&this._setRenderTargetEnabled(this.defaultRT,!0);let t;for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)t=this._getPostProcessesSource(this.renderTargets[i]);else{const s=this._scene.activeCamera;if(!s)continue;t=s._postProcesses}if(t&&(t=t.filter(s=>s!=null),t)){for(let s=0;s<t.length;s++)t[s].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),e=!0);this._hasImageProcessing(t)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,e&&this._enable()}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(Q.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}Ni._SceneComponentInitialization=o=>{throw ke("PrePassRendererSceneComponent")};Ni.TextureFormats=[{purpose:0,type:2,format:5,name:"prePass_Irradiance"},{purpose:1,type:2,format:5,name:"prePass_Position"},{purpose:2,type:0,format:5,name:"prePass_Velocity"},{purpose:3,type:0,format:5,name:"prePass_Reflectivity"},{purpose:4,type:2,format:5,name:"prePass_Color"},{purpose:5,type:1,format:6,name:"prePass_Depth"},{purpose:6,type:2,format:5,name:"prePass_Normal"},{purpose:7,type:0,format:5,name:"prePass_Albedo"}];Object.defineProperty(Ve.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(o){o&&o.isSupported&&(this._prePassRenderer=o)},enumerable:!0,configurable:!0});Ve.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new Ni(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,q.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)};Ve.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class rC{constructor(e){this.name=pe.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(pe.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(pe.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(pe.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(pe.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(pe.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(pe.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(pe.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(pe.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,s){if(!s)return;const r=e.getScene();r.prePassRenderer&&r.prePassRenderer.bindAttachmentsForEffect(s,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()}dispose(){this.scene.disablePrePassRenderer()}}Ni._SceneComponentInitialization=o=>{let e=o._getComponent(pe.NAME_PREPASSRENDERER);e||(e=new rC(o),o._addComponent(e))};const nC="fibonacci",aC=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
#define TWO_PI 6.2831855
vec2 Golden2dSeq(int i,float n)
{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}
vec2 SampleDiskGolden(int i,int sampleCount)
{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}`;X.IncludesShadersStore[nC]=aC;const oC="subSurfaceScatteringFunctions",lC=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;X.IncludesShadersStore[oC]=lC;const hC="diffusionProfile",cC="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];";X.IncludesShadersStore[hC]=cC;const uC="subSurfaceScatteringPixelShader",dC=`#include<fibonacci>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true
vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
vec3 expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp(8.*PI))*expSum; }
vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{u=1.-u; 
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); 
float p=(g*n)*n; 
float c=1.+p+n; 
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
float x=(3./LOG2_E)*log2(c)-d; 
float rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2(r,rcpPdf);}
vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif
float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
vec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; 
float xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))
{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}
else
{}}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)
{centerDepth=texture2D(depthSampler,vUV).r;}
if (!passedStencilTest) { 
gl_FragColor=inputColor;return;}
float distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; 
vec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; 
float mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}
#ifdef DEBUG_SSS_SAMPLES
vec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;
#endif
float phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); 
vec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)
{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);}
totalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}`;X.ShadersStore[uC]=dC;class fC extends ht{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,s=null,r,n,a,l=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,s,r||V.BILINEAR_SAMPLINGMODE,n,a,null,l,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add(h=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration){q.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}const c=this.texelSize;h.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),h.setFloat2("texelSize",c.x,c.y),h.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),h.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),h.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),h.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),h.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),h.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),h.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}}class Oh{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=pe.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new J(1,1,1)),this._scene=e,Oh._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return q.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[t*3]===e.r&&this._ssDiffusionS[t*3+1]===e.g&&this._ssDiffusionS[t*3+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new fC("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){const i=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,i)}_sampleBurleyDiffusionProfile(e,t){e=1-e;const i=1+4*e*(2*e+Math.sqrt(1+4*e*e)),s=Math.pow(i,-1/3),n=1+i*s*s+s;return 3*Math.log(n/(4*e))*t}}Oh._SceneComponentInitialization=o=>{throw ke("SubSurfaceSceneComponent")};da.AddParser(pe.NAME_SUBSURFACE,(o,e)=>{if(o.ssDiffusionProfileColors!==void 0&&o.ssDiffusionProfileColors!==null&&(e.enableSubSurfaceForPrePass(),e.subSurfaceConfiguration))for(let t=0,i=o.ssDiffusionProfileColors.length;t<i;t++){const s=o.ssDiffusionProfileColors[t];e.subSurfaceConfiguration.addDiffusionProfile(new J(s.r,s.g,s.b))}});Object.defineProperty(Ve.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(o){o&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=o)},enumerable:!0,configurable:!0});Ve.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const o=this.enablePrePassRenderer();return o?(this._subSurfaceConfiguration=new Oh(this),o.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null};Ve.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class _C{constructor(e){this.name=pe.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}Oh._SceneComponentInitialization=o=>{let e=o._getComponent(pe.NAME_SUBSURFACE);e||(e=new _C(o),o._addComponent(e))};const pC="outlinePixelShader",gC=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;X.ShadersStore[pC]=gC;const mC="outlineVertexShader",EC=`attribute vec3 position;attribute vec3 normal;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(offsetPosition,1.0);gl_Position=viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;X.ShadersStore[mC]=EC;Ve.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new gh(this)),this._outlineRenderer};Object.defineProperty(re.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(o){o&&this.getScene().getOutlineRenderer(),this._renderOutline=o},enumerable:!0,configurable:!0});Object.defineProperty(re.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(o){o&&this.getScene().getOutlineRenderer(),this._renderOverlay=o},enumerable:!0,configurable:!0});class gh{constructor(e){this.name=pe.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let t=0;t<4;++t)this._passIdForDrawWrapper[t]=this._engine.createRenderPassId(`Outline Renderer (${t})`)}register(){this.scene._beforeRenderingMeshStage.registerStep(pe.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(pe.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,s){s=s??this._passIdForDrawWrapper[0];const r=this.scene,n=r.getEngine(),a=n.getCaps().instancedArrays&&(t.visibleInstances[e._id]!==null&&t.visibleInstances[e._id]!==void 0||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,a,s))return;const l=e.getMesh(),h=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,c=e.getRenderingMesh(),u=h||c,d=e.getMaterial();if(!d||!r.activeCamera)return;const f=e._getDrawWrapper(s),p=_r.GetEffect(f);if(n.enableEffect(f),d.useLogarithmicDepth&&p.setFloat("logarithmicDepthConstant",2/(Math.log(r.activeCamera.maxZ+1)/Math.LN2)),p.setFloat("offset",i?0:c.outlineWidth),p.setColor4("color",i?c.overlayColor:c.outlineColor,i?c.overlayAlpha:d.alpha),p.setMatrix("viewProjection",r.getTransformMatrix()),p.setMatrix("world",u.getWorldMatrix()),c.useBones&&c.computeBonesUsingShaders&&c.skeleton&&p.setMatrices("mBones",c.skeleton.getTransformMatrices(c)),c.morphTargetManager&&c.morphTargetManager.isUsingTextureForTargets&&c.morphTargetManager._bind(p),se.BindMorphTargetParameters(c,p),a||c._bind(e,p,d.fillMode),d&&d.needAlphaTesting()){const _=d.getAlphaTestTexture();_&&(p.setTexture("diffuseSampler",_),p.setMatrix("diffuseMatrix",_.getTextureMatrix()))}Pn(p,d,r),n.setZOffset(-this.zOffset),n.setZOffsetUnits(-this.zOffsetUnits),c._processRendering(u,e,p,d.fillMode,t,a,(_,g)=>{p.setMatrix("world",g)}),n.setZOffset(0),n.setZOffsetUnits(0)}isReady(e,t,i){i=i??this._passIdForDrawWrapper[0];const s=[],r=[T.PositionKind,T.NormalKind],n=e.getMesh(),a=e.getMaterial();if(!a)return!1;const l=n.getScene();a.needAlphaTesting()&&(s.push("#define ALPHATEST"),n.isVerticesDataPresent(T.UVKind)&&(r.push(T.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(T.UV2Kind)&&(r.push(T.UV2Kind),s.push("#define UV2"))),a.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH"),Mh(a,l,s),n.useBones&&n.computeBonesUsingShaders?(r.push(T.MatricesIndicesKind),r.push(T.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(T.MatricesIndicesExtraKind),r.push(T.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");const h=n.morphTargetManager;let c=0;h&&h.numInfluencers>0&&(c=h.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+c),h.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(r,n,c)),t&&(s.push("#define INSTANCES"),se.PushAttributesForInstances(r),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));const u=e._getDrawWrapper(i,!0),d=u.defines,f=s.join(`
`);if(d!==f){const p=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"];In(p),u.setEffect(this.scene.getEngine().createEffect("outline",r,p,["diffuseSampler","morphTargets"],f,void 0,void 0,void 0,{maxSimultaneousMorphTargets:c}),f)}return u.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){const s=t.getMaterial();s&&s.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(gh._StencilReference),this._engine.setStencilFunctionReference(gh._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),s&&s.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){const s=this._engine.getAlphaMode(),r=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(s),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=r}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}gh._StencilReference=4;class qe extends Jt{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t),this.diffuse=new J(1,1,1),this.specular=new J(1,1,1),this.falloffType=qe.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=qe.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new ve(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,r=!0){var n;const a=e.toString();let l=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+a),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;const h=this.getScaledIntensity();this.transferToEffect(i,a),this.diffuse.scaleToRef(h,Zs.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Zs.Color3[0],this.range,a),s&&(this.specular.scaleToRef(h,Zs.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Zs.Color3[1],this.radius,a)),l=!0}if(this.transferTexturesToEffect(i,a),t.shadowsEnabled&&this.shadowEnabled&&r){const h=(n=this.getShadowGenerator(t.activeCamera))!==null&&n!==void 0?n:this.getShadowGenerator();h&&(h.bindShadowLight(a,i),l=!0)}l?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){var t;return this._shadowGenerators===null?null:(t=this._shadowGenerators.get(e))!==null&&t!==void 0?t:null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return m.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&e.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){const i=this._shadowGenerators.values();for(let s=i.next();s.done!==!0;s=i.next())s.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=qe.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const s=Le.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const e=Le.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),Le.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const s=Jt.Construct("Light_Type_"+e,t,i);return s||null}static Parse(e,t){const i=qe.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const s=Le.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(s.falloffType=e.falloffType),e.lightmapMode!==void 0&&(s.lightmapMode=e.lightmapMode),e.animations){for(let r=0;r<e.animations.length;r++){const n=e.animations[r],a=Gr("BABYLON.Animation");a&&s.animations.push(a.Parse(n))}Jt.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){const t=e.push;e.push=(...s)=>{const r=t.apply(e,s);for(const n of s)n._resyncLightSource(this);return r};const i=e.splice;e.splice=(s,r)=>{const n=i.apply(e,[s,r]);for(const a of n)a._resyncLightSource(this);return n};for(const s of e)s._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...s)=>{const r=t.apply(e,s);return this._resyncMeshes(),r};const i=e.splice;e.splice=(s,r)=>{const n=i.apply(e,[s,r]);return this._resyncMeshes(),n},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===qe.INTENSITYMODE_AUTOMATIC&&(t===qe.LIGHTTYPEID_DIRECTIONALLIGHT?i=qe.INTENSITYMODE_ILLUMINANCE:i=qe.INTENSITYMODE_LUMINOUSINTENSITY),t){case qe.LIGHTTYPEID_POINTLIGHT:case qe.LIGHTTYPEID_SPOTLIGHT:switch(i){case qe.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case qe.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case qe.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case qe.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case qe.INTENSITYMODE_ILLUMINANCE:e=1;break;case qe.INTENSITYMODE_LUMINANCE:{let s=this.radius;s=Math.max(s,.001),e=2*Math.PI*(1-Math.cos(s));break}}break;case qe.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}qe.FALLOFF_DEFAULT=mt.FALLOFF_DEFAULT;qe.FALLOFF_PHYSICAL=mt.FALLOFF_PHYSICAL;qe.FALLOFF_GLTF=mt.FALLOFF_GLTF;qe.FALLOFF_STANDARD=mt.FALLOFF_STANDARD;qe.LIGHTMAP_DEFAULT=mt.LIGHTMAP_DEFAULT;qe.LIGHTMAP_SPECULAR=mt.LIGHTMAP_SPECULAR;qe.LIGHTMAP_SHADOWSONLY=mt.LIGHTMAP_SHADOWSONLY;qe.INTENSITYMODE_AUTOMATIC=mt.INTENSITYMODE_AUTOMATIC;qe.INTENSITYMODE_LUMINOUSPOWER=mt.INTENSITYMODE_LUMINOUSPOWER;qe.INTENSITYMODE_LUMINOUSINTENSITY=mt.INTENSITYMODE_LUMINOUSINTENSITY;qe.INTENSITYMODE_ILLUMINANCE=mt.INTENSITYMODE_ILLUMINANCE;qe.INTENSITYMODE_LUMINANCE=mt.INTENSITYMODE_LUMINANCE;qe.LIGHTTYPEID_POINTLIGHT=mt.LIGHTTYPEID_POINTLIGHT;qe.LIGHTTYPEID_DIRECTIONALLIGHT=mt.LIGHTTYPEID_DIRECTIONALLIGHT;qe.LIGHTTYPEID_SPOTLIGHT=mt.LIGHTTYPEID_SPOTLIGHT;qe.LIGHTTYPEID_HEMISPHERICLIGHT=mt.LIGHTTYPEID_HEMISPHERICLIGHT;v([oi()],qe.prototype,"diffuse",void 0);v([oi()],qe.prototype,"specular",void 0);v([M()],qe.prototype,"falloffType",void 0);v([M()],qe.prototype,"intensity",void 0);v([M()],qe.prototype,"range",null);v([M()],qe.prototype,"intensityMode",null);v([M()],qe.prototype,"radius",null);v([M()],qe.prototype,"_renderPriority",void 0);v([Z("_reorderLightsInScene")],qe.prototype,"renderPriority",void 0);v([M("shadowEnabled")],qe.prototype,"_shadowEnabled",void 0);v([M("excludeWithLayerMask")],qe.prototype,"_excludeWithLayerMask",void 0);v([M("includeOnlyWithLayerMask")],qe.prototype,"_includeOnlyWithLayerMask",void 0);v([M("lightmapMode")],qe.prototype,"_lightmapMode",void 0);Jt.AddNodeConstructor("Light_Type_3",(o,e)=>()=>new Dn(o,m.Zero(),e));class Dn extends qe{constructor(e,t,i){super(e,i),this.groundColor=new J(0,0,0),this.direction=t||m.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(m.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=m.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=m.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=L.Identity()),this._worldMatrix}getTypeID(){return qe.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}v([oi()],Dn.prototype,"groundColor",void 0);v([zi()],Dn.prototype,"direction",void 0);class Yt{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Dn("shared gizmo light",new m(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=J.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return Yt._DefaultUtilityLayer==null?Yt._CreateDefaultUtilityLayerFromScene(Ze.LastCreatedScene):Yt._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return Yt._DefaultUtilityLayer=new Yt(e),Yt._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Yt._DefaultUtilityLayer=null}),Yt._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return Yt._DefaultKeepDepthUtilityLayer==null&&(Yt._DefaultKeepDepthUtilityLayer=new Yt(Ze.LastCreatedScene),Yt._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,Yt._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{Yt._DefaultKeepDepthUtilityLayer=null})),Yt._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new j,this.utilityLayerScene=new Ve(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(i=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&i.type!==xe.POINTERMOVE&&i.type!==xe.POINTERUP&&i.type!==xe.POINTERDOWN&&i.type!==xe.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const s=i.event;if(e.isPointerCaptured(s.pointerId)){this._pointerCaptures[s.pointerId]=!1;return}const r=a=>{let l=null;if(i.nearInteractionPickingInfo)i.nearInteractionPickingInfo.pickedMesh.getScene()==a?l=i.nearInteractionPickingInfo:l=new pr;else if(a!==this.utilityLayerScene&&i.originalPickingInfo)l=i.originalPickingInfo;else{let h=null;this._renderCamera&&(h=a._activeCamera,a._activeCamera=this._renderCamera,i.ray=null),l=i.ray?a.pickWithRay(i.ray):a.pick(e.pointerX,e.pointerY),h&&(a._activeCamera=h)}return l},n=r(this.utilityLayerScene);if(!i.ray&&n&&(i.ray=n.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(i),this.onlyCheckPointerDownEvents&&i.type!=xe.POINTERDOWN){i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Ls(i.type,i.event,n),i.type),i.type===xe.POINTERUP&&this._pointerCaptures[s.pointerId]&&(this._pointerCaptures[s.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)n&&n.hit&&(i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Ls(i.type,i.event,n),i.type),i.skipOnPointerObservable=!0);else{const a=r(e),l=i.event;a&&n&&(n.distance===0&&a.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(a.pickedMesh)?(this._notifyObservers(i,a,l),i.skipOnPointerObservable=!0):i.type===xe.POINTERDOWN?this._pointerCaptures[l.pointerId]=!0:(i.type===xe.POINTERMOVE||i.type===xe.POINTERUP)&&(this._lastPointerEvents[l.pointerId]&&(this.onPointerOutObservable.notifyObservers(l.pointerId),delete this._lastPointerEvents[l.pointerId]),this._notifyObservers(i,a,l)):!this._pointerCaptures[l.pointerId]&&(n.distance<a.distance||a.distance===0)?(this._notifyObservers(i,n,l),i.skipOnPointerObservable||(i.skipOnPointerObservable=n.distance>0)):!this._pointerCaptures[l.pointerId]&&n.distance>=a.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(a.pickedMesh)?(this._notifyObservers(i,a,l),i.skipOnPointerObservable=!0):((i.type===xe.POINTERMOVE||i.type===xe.POINTERUP)&&this._lastPointerEvents[l.pointerId]&&(this.onPointerOutObservable.notifyObservers(l.pointerId),delete this._lastPointerEvents[l.pointerId]),this._notifyObservers(i,n,l))),i.type===xe.POINTERUP&&this._pointerCaptures[l.pointerId]&&(this._pointerCaptures[l.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(i=>{this.shouldRender&&i==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Ls(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}Yt._DefaultUtilityLayer=null;Yt._DefaultKeepDepthUtilityLayer=null;class qm{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity===e||!this._hasVelocity()||(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){var e;return!!(!((e=this.vertexBuffers)===null||e===void 0)&&e.velocity)}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}constructor(e){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new j,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null}_createEffects(){const e=["view","projection","particleRadius","size"],t=["position","offset"],i=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),i.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&i.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new gn({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:i}),e.push("particleAlpha"),this._thicknessEffectWrapper=new gn({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[]})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;const e=this._depthEffectWrapper._drawWrapper.effect,t=this._thicknessEffectWrapper._drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){const e=this.numParticles;if(!this._depthEffectWrapper||e===0)return;const t=this._depthEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){const e=this.numParticles;if(!this._thicknessEffectWrapper||e===0)return;const t=this._thicknessEffectWrapper._drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){var e,t;(e=this._depthEffectWrapper)===null||e===void 0||e.dispose(),(t=this._thicknessEffectWrapper)===null||t===void 0||t.dispose()}}class TC extends qm{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add(()=>{this._engine.setAlphaMode(2)})))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t){super(e),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class nd{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,this._blurPostProcesses!==null)){const t=this._blurPostProcesses[0],i=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let s=0;s<this._blurNumIterations*2;++s)this._blurPostProcesses[s]=s&1?i:t}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}constructor(e,t,i,s,r,n,a=1,l=6,h=1,c=6,u=!1,d=null,f=!0,p=1){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new j,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=s,this._blurTextureSizeX=r,this._blurTextureSizeY=n,this._textureType=a,this._textureFormat=l,this._blurTextureType=h,this._blurTextureFormat=c,this._useStandardBlur=u,this._generateDepthBuffer=f,this._samples=p,this._postProcessRunningIndex=0,this.enableBlur=r!==0&&n!==0,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){const[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTT-${this._name}`});const e=this._rt.texture;e.incrementReferences(),this._texture=new V(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=V.CLAMP_ADDRESSMODE,this._texture.wrapV=V.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,i,s,r,n=!1){const a=this._scene.getEngine(),l=new Ke(Math.floor(this._blurTextureSizeX/s),Math.floor(this._blurTextureSizeY/s)),h=t===1&&a.getCaps().textureFloatLinearFiltering||t===2&&a.getCaps().textureHalfFloatLinearFiltering,c=this._engine.createRenderTargetTexture({width:l.x,height:l.y},{generateMipMaps:!1,type:t,format:i,samplingMode:h?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTTBlur-${r}`}),u=c.texture;u.incrementReferences();const d=new V(null,this._scene);if(d.name="rttBlurred"+r,d._texture=u,d.wrapU=V.CLAMP_ADDRESSMODE,d.wrapV=V.CLAMP_ADDRESSMODE,d.anisotropicFilteringLevel=1,n){const f=new ht("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);f.samples=this._samples,f.externalTextureSamplerBinding=!0,f.onApplyObservable.add(g=>{this._postProcessRunningIndex===0?g.setTexture("textureSampler",e):g._bindTexture("textureSampler",f.inputTexture.texture),g.setInt("filterSize",this.blurFilterSize),g.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++}),f.onSizeChangedObservable.add(()=>{f._textures.forEach(g=>{g.texture.wrapU=V.CLAMP_ADDRESSMODE,g.texture.wrapV=V.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(f);const p=new ht("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);p.samples=this._samples,p.onApplyObservable.add(g=>{g.setInt("filterSize",this.blurFilterSize),g.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++}),p.onSizeChangedObservable.add(()=>{p._textures.forEach(g=>{g.texture.wrapU=V.CLAMP_ADDRESSMODE,g.texture.wrapV=V.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(p),f.autoClear=!1,p.autoClear=!1;const _=[];for(let g=0;g<this._blurNumIterations*2;++g)_[g]=g&1?p:f;return[c,d,_]}else{const f=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],p=new ht("BilateralBlurX","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);p.samples=this._samples,p.externalTextureSamplerBinding=!0,p.onApplyObservable.add(E=>{this._postProcessRunningIndex===0?E.setTexture("textureSampler",e):E._bindTexture("textureSampler",p.inputTexture.texture),E.setInt("maxFilterSize",this.blurMaxFilterSize),E.setFloat2("blurDir",1/this._blurTextureSizeX,0),E.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),E.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),p.onSizeChangedObservable.add(()=>{p._textures.forEach(E=>{E.texture.wrapU=V.CLAMP_ADDRESSMODE,E.texture.wrapV=V.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(p);const _=new ht("BilateralBlurY","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);_.samples=this._samples,_.onApplyObservable.add(E=>{E.setInt("maxFilterSize",this.blurMaxFilterSize),E.setFloat2("blurDir",0,1/this._blurTextureSizeY),E.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),E.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),_.onSizeChangedObservable.add(()=>{_._textures.forEach(E=>{E.texture.wrapU=V.CLAMP_ADDRESSMODE,E.texture.wrapV=V.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(_),p.autoClear=!1,_.autoClear=!1;const g=[];for(let E=0;E<this._blurNumIterations*2;++E)g[E]=E&1?_:p;return[c,d,g]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}),e.onApplyObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}))}_getProjectedParticleConstant(){var e,t;return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan(((t=(e=this._camera)===null||e===void 0?void 0:e.fov)!==null&&t!==void 0?t:45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){var e,t,i,s;this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),(e=this._rt)===null||e===void 0||e.dispose(),this._rt=null,(t=this._texture)===null||t===void 0||t.dispose(),this._texture=null,(i=this._rtBlur)===null||i===void 0||i.dispose(),this._rtBlur=null,(s=this._textureBlurred)===null||s===void 0||s.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}var Cs;(function(o){o[o.DepthTexture=0]="DepthTexture",o[o.DepthBlurredTexture=1]="DepthBlurredTexture",o[o.ThicknessTexture=2]="ThicknessTexture",o[o.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",o[o.DiffuseTexture=4]="DiffuseTexture",o[o.Normals=5]="Normals",o[o.DiffuseRendering=6]="DiffuseRendering"})(Cs||(Cs={}));class Tg{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get camera(){return this._camera}constructor(e,t){this._generateDiffuseTexture=!1,this.fluidColor=new J(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new m(-2,-1,1).normalize(),this._debugFeature=Cs.DepthBlurredTexture,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new j,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new L,this._depthClearColor=new He(1e6,1e6,1e6,1),this._thicknessClearColor=new He(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null}_initialize(){var e,t,i;this.dispose(),this._needInitialization=!1;const s=(e=this._depthMapSize)!==null&&e!==void 0?e:this._engine.getRenderWidth(),r=this._depthMapSize!==null?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new nd("Depth",this._scene,s,r,s,r,1,7,1,7,!1,this._camera,!0,this._samples),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){const l=(t=this._diffuseMapSize)!==null&&t!==void 0?t:this._engine.getRenderWidth(),h=this._diffuseMapSize!==null?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new nd("Diffuse",this._scene,l,h,0,0,0,5,0,5,!0,this._camera,!0,this._samples),this._initializeRenderTarget(this._diffuseRenderTarget)}const n=(i=this._thicknessMapSize)!==null&&i!==void 0?i:this._engine.getRenderWidth(),a=this._thicknessMapSize!==null?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new nd("Thickness",this._scene,n,a,n,a,2,6,2,6,!0,this._camera,!1,this._samples),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){(e===null||e===this._depthRenderTarget)&&this._setBlurDepthParameters(),(e===null||e===this._thicknessRenderTarget)&&this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){var e;const t=this._scene.getEngine(),i=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],s=["depthSampler"],r=[];if(this.dispose(!0),!this._camera)return;const n=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,a=new Ke(1/n.getSize().width,1/n.getSize().height);this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),this._environmentMap!==null&&((e=this._environmentMap)!==null&&e!==void 0?e:this._scene.environmentTexture)&&(s.push("reflectionSampler"),r.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(s.push("diffuseSampler"),r.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):i.push("diffuseColor"),this._useVelocity&&(s.push("velocitySampler"),r.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(i.push("thickness"),s.push("bgDepthSampler"),r.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(i.push("minimumThickness"),s.push("thicknessSampler")),this._debug&&(r.push("#define FLUIDRENDERING_DEBUG"),this._debugFeature===Cs.Normals?r.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this._debugFeature===Cs.DiffuseRendering?r.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(r.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),s.push("debugSampler"),(this._debugFeature===Cs.DepthTexture||this._debugFeature===Cs.DepthBlurredTexture)&&r.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new ht("FluidRendering","fluidRenderingRender",i,s,1,null,2,t,!1,null,0,void 0,void 0,!0,void 0),this._renderPostProcess.updateEffect(r.join(`
`)),this._renderPostProcess.samples=this._samples,this._renderPostProcess.onApplyObservable.add(l=>{var h,c,u,d,f,p,_,g,E,R,x,S,b,y,I,O,N,w,G,k,de,ae,_e;if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),t.isWebGPU&&l.setTextureSampler("textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(l.setTexture("depthSampler",this._depthRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("depthSamplerSampler",(d=(u=this._depthRenderTarget.textureBlur)===null||u===void 0?void 0:u.getInternalTexture())!==null&&d!==void 0?d:null)):(l.setTexture("depthSampler",this._depthRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("depthSamplerSampler",(c=(h=this._depthRenderTarget.texture)===null||h===void 0?void 0:h.getInternalTexture())!==null&&c!==void 0?c:null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(l.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("diffuseSamplerSampler",(g=(_=this._diffuseRenderTarget.textureBlur)===null||_===void 0?void 0:_.getInternalTexture())!==null&&g!==void 0?g:null)):(l.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("diffuseSamplerSampler",(p=(f=this._diffuseRenderTarget.texture)===null||f===void 0?void 0:f.getInternalTexture())!==null&&p!==void 0?p:null)):l.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(l.setFloat("thickness",this.minimumThickness),l._bindTexture("bgDepthSampler",this._bgDepthTexture),t.isWebGPU&&l.setTextureSampler("bgDepthSamplerSampler",(E=this._bgDepthTexture)!==null&&E!==void 0?E:null)):(this._thicknessRenderTarget.enableBlur?(l.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),t.isWebGPU&&l.setTextureSampler("thicknessSamplerSampler",(b=(S=this._thicknessRenderTarget.textureBlur)===null||S===void 0?void 0:S.getInternalTexture())!==null&&b!==void 0?b:null)):(l.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),t.isWebGPU&&l.setTextureSampler("thicknessSamplerSampler",(x=(R=this._thicknessRenderTarget.texture)===null||R===void 0?void 0:R.getInternalTexture())!==null&&x!==void 0?x:null)),l.setFloat("minimumThickness",this.minimumThickness)),this._environmentMap!==null){const Ce=(y=this._environmentMap)!==null&&y!==void 0?y:this._scene.environmentTexture;Ce&&(l.setTexture("reflectionSampler",Ce),t.isWebGPU&&l.setTextureSampler("reflectionSamplerSampler",(I=Ce==null?void 0:Ce.getInternalTexture())!==null&&I!==void 0?I:null))}if(l.setMatrix("viewMatrix",this._scene.getViewMatrix()),l.setMatrix("invProjectionMatrix",this._invProjectionMatrix),l.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),l.setVector2("texelSize",a),l.setFloat("density",this.density),l.setFloat("refractionStrength",this.refractionStrength),l.setFloat("fresnelClamp",this.fresnelClamp),l.setFloat("specularPower",this.specularPower),l.setVector3("dirLight",this.dirLight),l.setFloat("cameraFar",this._camera.maxZ),this._debug){let Ce=null;switch(this._debugFeature){case Cs.DepthTexture:Ce=this._depthRenderTarget.texture;break;case Cs.DepthBlurredTexture:Ce=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case Cs.ThicknessTexture:Ce=(N=(O=this._thicknessRenderTarget)===null||O===void 0?void 0:O.texture)!==null&&N!==void 0?N:null;break;case Cs.ThicknessBlurredTexture:Ce=!((w=this._thicknessRenderTarget)===null||w===void 0)&&w.enableBlur?(k=(G=this._thicknessRenderTarget)===null||G===void 0?void 0:G.textureBlur)!==null&&k!==void 0?k:null:(ae=(de=this._thicknessRenderTarget)===null||de===void 0?void 0:de.texture)!==null&&ae!==void 0?ae:null;break;case Cs.DiffuseTexture:this._diffuseRenderTarget&&(Ce=this._diffuseRenderTarget.texture);break}this._debugFeature!==Cs.Normals&&(l.setTexture("debugSampler",Ce),t.isWebGPU&&l.setTextureSampler("debugSamplerSampler",(_e=Ce==null?void 0:Ce.getInternalTexture())!==null&&_e!==void 0?_e:null))}})}_clearTargets(){var e,t,i;!((e=this._depthRenderTarget)===null||e===void 0)&&e.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),!((t=this._diffuseRenderTarget)===null||t===void 0)&&t.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),!((i=this._thicknessRenderTarget)===null||i===void 0)&&i.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){var t,i,s,r,n,a;if(this._needInitialization||!e.isReady())return;const l=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),!((t=this._depthRenderTarget)===null||t===void 0)&&t.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),!((i=this._diffuseRenderTarget)===null||i===void 0)&&i.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),!((s=this._thicknessRenderTarget)===null||s===void 0)&&s.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),(r=this._depthRenderTarget)===null||r===void 0||r.applyBlurPostProcesses(),(n=this._diffuseRenderTarget)===null||n===void 0||n.applyBlurPostProcesses(),(a=this._thicknessRenderTarget)===null||a===void 0||a.applyBlurPostProcesses(),l&&this._engine.bindFramebuffer(l)}dispose(e=!1){var t,i,s,r;e||((t=this._depthRenderTarget)===null||t===void 0||t.dispose(),this._depthRenderTarget=null,(i=this._diffuseRenderTarget)===null||i===void 0||i.dispose(),this._diffuseRenderTarget=null,(s=this._thicknessRenderTarget)===null||s===void 0||s.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),(r=this._renderPostProcess)===null||r===void 0||r.dispose(),this._renderPostProcess=null,this._needInitialization=!1}}class vC extends qm{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i){super(e),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(const t in e){let i,s=!0;switch(t){case"velocity":i=3;break;case"offset":s=!1;break}this._vertexBuffers[t]=new T(this._engine,e[t],t,!0,!1,i,s)}}_createEffects(){super._createEffects();const e=["view","projection","size"],t=["position","offset","color"];this._diffuseEffectWrapper=new gn({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:t,uniformNames:e,samplerNames:[]})}isReady(){var e,t;return this._vertexBuffers.offset||(this._vertexBuffers.offset=new T(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&((t=(e=this._diffuseEffectWrapper)===null||e===void 0?void 0:e.effect.isReady())!==null&&t!==void 0?t:!1)}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){const e=this.numParticles;if(!this._diffuseEffectWrapper||e===0)return;const t=this._diffuseEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),this._particleSize!==null&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){var e;super.dispose(),(e=this._diffuseEffectWrapper)===null||e===void 0||e.dispose();for(const t in this._vertexBuffers)this._vertexBuffers[t].dispose();this._vertexBuffers={}}}const AC="copyTextureToTexturePixelShader",RC=`uniform float conversion;uniform sampler2D textureSampler;varying vec2 vUV;
#include<helperFunctions>
void main(void) 
{vec4 color=texture2D(textureSampler,vUV);
#ifdef DEPTH_TEXTURE
gl_FragDepth=color.r;
#else
if (conversion==1.) {color=toLinearSpace(color);} else if (conversion==2.) {color=toGammaSpace(color);}
gl_FragColor=color;
#endif
}
`;X.ShadersStore[AC]=RC;var xd;(function(o){o[o.None=0]="None",o[o.ToLinearSpace=1]="ToLinearSpace",o[o.ToGammaSpace=2]="ToGammaSpace"})(xd||(xd={}));class bC{_textureIsInternal(e){return e.getInternalTexture===void 0}constructor(e,t=!1){this._engine=e,this._isDepthTexture=t,this._renderer=new Cf(e),this._effectWrapper=new gn({engine:e,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:t?["#define DEPTH_TEXTURE"]:[]}),this._effectWrapper.onApplyObservable.add(()=>{t&&(e.setState(!1),e.setDepthBuffer(!0),e.depthCullingState.depthMask=!0,e.depthCullingState.depthFunc=519),this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)})}isReady(){return this._effectWrapper.effect.isReady()}copy(e,t,i=xd.None){if(!this.isReady())return!1;this._source=e,this._conversion=i;const s=this._engine.depthCullingState.depthFunc;return this._renderer.render(this._effectWrapper,t),this._isDepthTexture&&s&&(this._engine.depthCullingState.depthFunc=s),!0}dispose(){this._effectWrapper.dispose(),this._renderer.dispose()}}class SC{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,s=1){this._engine=e,this._copyTextureToTexture=new bC(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:s,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"});const r=this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil");r.label=`FluidDepthTextureCopy${t}x${i}x${s}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}const yC="fluidRenderingParticleDepthVertexShader",CC=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
attribute vec3 velocity;varying float velocityNorm;
#endif
void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;viewPos=(view*vec4(position,1.0)).xyz;gl_Position=projection*vec4(viewPos+cornerPos,1.0);uv=offset;sphereRadius=size.x/2.0;
#ifdef FLUIDRENDERING_VELOCITY
velocityNorm=length(velocity);
#endif
}
`;X.ShadersStore[yC]=CC;const xC="fluidRenderingParticleDepthPixelShader",MC=`uniform mat4 projection;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
varying float velocityNorm;
#endif
void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;normal.z=sqrt(1.0-r2);
#ifndef FLUIDRENDERING_RHS
normal.z=-normal.z;
#endif
vec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);vec4 clipSpacePos=projection*realViewPos;
#ifdef WEBGPU
gl_FragDepth=clipSpacePos.z/clipSpacePos.w;
#else
gl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;
#endif
#ifdef FLUIDRENDERING_RHS
realViewPos.z=-realViewPos.z;
#endif
#ifdef FLUIDRENDERING_VELOCITY
glFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);
#else
glFragColor=vec4(realViewPos.z,0.,0.,1.);
#endif
}
`;X.ShadersStore[xC]=MC;const IC="fluidRenderingParticleThicknessVertexShader",PC=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;}
`;X.ShadersStore[IC]=PC;const DC="fluidRenderingParticleThicknessPixelShader",OC=`uniform float particleAlpha;varying vec2 uv;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;float thickness=sqrt(1.0-r2);glFragColor=vec4(vec3(particleAlpha*thickness),1.0);}
`;X.ShadersStore[DC]=OC;const NC="fluidRenderingParticleDiffuseVertexShader",LC=`attribute vec3 position;attribute vec2 offset;attribute vec4 color;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;diffuseColor=color.rgb;}
`;X.ShadersStore[NC]=LC;const FC="fluidRenderingParticleDiffusePixelShader",wC=`uniform float particleAlpha;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;glFragColor=vec4(diffuseColor,1.0);}
`;X.ShadersStore[FC]=wC;const BC="fluidRenderingBilateralBlurPixelShader",UC=`uniform sampler2D textureSampler;uniform int maxFilterSize;uniform vec2 blurDir;uniform float projectedParticleConstant;uniform float depthThreshold;varying vec2 vUV;void main(void) {float depth=textureLod(textureSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(vec3(depth),1.);return;}
int filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));float sigma=float(filterSize)/3.0;float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold/3.0;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sum=0.;float wsum=0.;float sumVel=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepthVel.r-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}
glFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);}
`;X.ShadersStore[BC]=UC;const kC="fluidRenderingStandardBlurPixelShader",VC=`uniform sampler2D textureSampler;uniform int filterSize;uniform vec2 blurDir;varying vec2 vUV;void main(void) {vec4 s=textureLod(textureSampler,vUV,0.);if (s.r==0.) {glFragColor=vec4(0.,0.,0.,1.);return;}
float sigma=float(filterSize)/3.0;float twoSigma2=2.0*sigma*sigma;vec4 sum=vec4(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);float w=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}
sum/=wsum;glFragColor=vec4(sum.rgb,1.);}
`;X.ShadersStore[kC]=VC;const GC="fluidRenderingRenderPixelShader",zC=`/* disable_uniformity_analysis */
#define IOR 1.333
#define ETA 1.0/IOR
#define F0 0.02
uniform sampler2D textureSampler;uniform sampler2D depthSampler;
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
uniform sampler2D diffuseSampler;
#else
uniform vec3 diffuseColor;
#endif
#ifdef FLUIDRENDERING_FIXED_THICKNESS
uniform float thickness;uniform sampler2D bgDepthSampler;
#else
uniform float minimumThickness;uniform sampler2D thicknessSampler;
#endif
#ifdef FLUIDRENDERING_ENVIRONMENT
uniform samplerCube reflectionSampler;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
uniform sampler2D debugSampler;
#endif
uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform mat4 invProjectionMatrix;uniform vec2 texelSize;uniform vec3 dirLight;uniform float cameraFar;uniform float density;uniform float refractionStrength;uniform float fresnelClamp;uniform float specularPower;varying vec2 vUV;vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef FLUIDRENDERING_RHS
ndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;
#else
ndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
vec3 getViewPosFromTexCoord(vec2 texCoord) {float depth=textureLod(depthSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}
void main(void) {vec2 texCoord=vUV;
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
vec4 color=texture2D(debugSampler,texCoord);
#ifdef FLUIDRENDERING_DEBUG_DEPTH
glFragColor=vec4(color.rgb/vec3(2.0),1.);if (color.r>0.999 && color.g>0.999) {glFragColor=texture2D(textureSampler,texCoord);}
#else
glFragColor=vec4(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {glFragColor=texture2D(textureSampler,texCoord);}
#endif
return;
#endif
vec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;float depth=depthVel.r;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
float thickness=texture2D(thicknessSampler,texCoord).x;
#else
float bgDepth=texture2D(bgDepthSampler,texCoord).x;float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;
#endif
vec4 backColor=texture2D(textureSampler,texCoord);
#ifndef FLUIDRENDERING_FIXED_THICKNESS
if (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {
#else
if (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {
#endif
glFragColor=backColor;return;}
vec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}
vec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}
vec3 normal=normalize(cross(ddy,ddx));
#ifdef FLUIDRENDERING_RHS
normal=-normal;
#endif
#ifndef WEBGPU
if(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {normal=vec3(0.,0.,-1.);}
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)
glFragColor=vec4(normal*0.5+0.5,1.0);return;
#endif
vec3 rayDir=normalize(viewPos); 
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
vec3 diffuseColor=textureLod(diffuseSampler,texCoord,0.0).rgb;
#endif
vec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));vec3 H =normalize(lightDir-rayDir);float specular=pow(max(0.0,dot(H,normal)),specularPower);
#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING
float diffuse =max(0.0,dot(lightDir,normal))*1.0;glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);return;
#endif
vec3 refractionDir=refract(rayDir,normal,ETA);vec4 transmitted=textureLod(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength),0.0);vec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); 
vec3 refractionColor=transmitted.rgb*transmittance;
#ifdef FLUIDRENDERING_ENVIRONMENT
vec3 reflectionDir=reflect(rayDir,normal);vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;
#else
vec3 finalColor=refractionColor+specular;
#endif
#ifdef FLUIDRENDERING_VELOCITY
float velocity=depthVel.g;finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));
#endif
glFragColor=vec4(finalColor,transmitted.a);}
`;X.ShadersStore[GC]=zC;Object.defineProperty(Ve.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(o){this._fluidRenderer=o},enumerable:!0,configurable:!0});Ve.prototype.enableFluidRenderer=function(){return this._fluidRenderer?this._fluidRenderer:(this._fluidRenderer=new Of(this),this._fluidRenderer)};Ve.prototype.disableFluidRenderer=function(){var o;(o=this._fluidRenderer)===null||o===void 0||o.dispose(),this._fluidRenderer=null};function HC(o){return!!o.particleSystem}class WC{constructor(e){this.name=pe.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(pe.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(pe.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){var t;(t=this.scene.fluidRenderer)===null||t===void 0||t._prepareRendering()}_afterCameraDraw(e){var t;(t=this.scene.fluidRenderer)===null||t===void 0||t._render(e)}rebuild(){this.scene._fluidRenderer&&(this.scene.disableFluidRenderer(),this.scene.enableFluidRenderer())}dispose(){this.scene.disableFluidRenderer()}}class Of{static _SceneComponentInitialization(e){let t=e._getComponent(pe.NAME_FLUIDRENDERER);t||(t=new WC(e),e._addComponent(t))}constructor(e){this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,Of._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add(()=>{this._initialize()})}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){const t=this._getParticleSystemIndex(e);return t!==-1?this.renderObjects[t]:null}addParticleSystem(e,t,i,s){const r=new TC(this._scene,e);r.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),i||(i=new Tg(this._scene,s),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),t!==void 0&&(i.generateDiffuseTexture=t);const n={object:r,targetRenderer:i};return this.renderObjects.push(n),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),n}addCustomParticles(e,t,i,s,r){const n=new vC(this._scene,e,t);n.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),s||(s=new Tg(this._scene,r),this.targetRenderers.push(s)),s._onUseVelocityChanged.hasObservers()||s._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),i!==void 0&&(s.generateDiffuseTexture=i);const a={object:n,targetRenderer:s};return this.renderObjects.push(a),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),a}removeRenderObject(e,t=!0){const i=this.renderObjects.indexOf(e);return i===-1?!1:(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0)}_removeUnusedTargetRenderers(){const e={};for(let s=0;s<this.renderObjects.length;++s){const r=this.renderObjects[s].targetRenderer;e[this.targetRenderers.indexOf(r)]=!0}let t=!1;const i=[];for(let s=0;s<this.targetRenderers.length;++s)e[s]?i.push(this.targetRenderers[s]):(this.targetRenderers[s].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t].object;if(HC(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let i=0;i<this.targetRenderers.length;++i)this.targetRenderers[i].dispose();const e=new Map;for(let i=0;i<this.targetRenderers.length;++i){const s=this.targetRenderers[i];if(s._initialize(),s.camera&&s._renderPostProcess){let r=e.get(s.camera);r||(r=[[],{}],e.set(s.camera,r)),r[0].push(s),s.camera.attachPostProcess(s._renderPostProcess,i)}}let t=e.keys();for(let i=t.next();i.done!==!0;i=t.next()){const s=i.value,r=e.get(s),n=s._getFirstPostProcess();if(!n)continue;const[a,l]=r;n.onSizeChangedObservable.add(()=>{var h;n.inputTexture.depthStencilTexture||n.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,a[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${n.name}`);for(const c of a){const u=(h=c._thicknessRenderTarget)===null||h===void 0?void 0:h.renderTarget,d=u==null?void 0:u.texture;if(u&&d){const f=d.width+"_"+d.height;let p=l[f];p||(p=l[f]=new SC(this._engine,d.width,d.height)),p.depthRTWrapper._shareDepth(u)}}})}t=this._cameras.keys();for(let i=t.next();i.done!==!0;i=t.next()){const s=i.value,n=this._cameras.get(s)[1],a=e.get(s);if(a)for(const l in n)a[1][l]||n[l].dispose();else for(const l in n)n[l].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){const e=new Map;for(let t=0;t<this.renderObjects.length;++t){const i=this.renderObjects[t];let s=e.get(i.targetRenderer);s===void 0&&(s=0),e.set(i.targetRenderer,Math.max(s,i.object.particleSize))}e.forEach((t,i)=>{i._depthRenderTarget&&(i._depthRenderTarget.particleSize=t)})}_setUseVelocityForRenderObject(){for(const e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(const e of this.targetRenderers)if(e.needInitialization){this._initialize();return}}_render(e){var t;for(let s=0;s<this.targetRenderers.length;++s)(!e||this.targetRenderers[s].camera===e)&&this.targetRenderers[s]._clearTargets();const i=this._cameras.keys();for(let s=i.next();s.done!==!0;s=i.next()){const r=s.value,n=this._cameras.get(r);if(e&&r!==e)continue;const a=r._getFirstPostProcess();if(!a)continue;const l=(t=a.inputTexture)===null||t===void 0?void 0:t.depthStencilTexture;if(l){const[h,c]=n;for(const u of h)u._bgDepthTexture=l;for(const u in c)c[u].copy(l)}}for(let s=0;s<this.renderObjects.length;++s){const r=this.renderObjects[s];(!e||r.targetRenderer.camera===e)&&r.targetRenderer._render(r.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach(e=>{const t=e[1];for(const i in t)t[i].dispose()}),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}class _a extends qe{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=L.Identity(),this._projectionMatrix=L.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=m.Zero()),m.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=m.Zero()),m.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=m.Cross(this.direction,En.Y),t=m.Cross(e,this.direction);return m.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=m.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=L.Identity()),L.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){const t=D.Vector3[0];let i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),m.NormalizeToRef(this.getShadowDirection(e),t),Math.abs(m.Dot(t,m.Up()))===1&&(t.z=1e-13);const s=D.Vector3[1];return i.addToRef(t,s),L.LookAtLHToRef(i,s,m.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}v([zi()],_a.prototype,"position",null);v([zi()],_a.prototype,"direction",null);v([M()],_a.prototype,"shadowMinZ",null);v([M()],_a.prototype,"shadowMaxZ",null);const XC="kernelBlurVaryingDeclaration",YC="varying vec2 sampleCoord{X};";X.IncludesShadersStore[XC]=YC;const KC="kernelBlurFragment",$C=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;X.IncludesShadersStore[KC]=$C;const jC="kernelBlurFragment2",qC=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;X.IncludesShadersStore[jC]=qC;const ZC="kernelBlurPixelShader",QC=`uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;X.ShadersStore[ZC]=QC;const JC="kernelBlurVertex",ex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";X.IncludesShadersStore[JC]=ex;const tx="kernelBlurVertexShader",ix=`attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;X.ShadersStore[tx]=ix;class Sn extends ht{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,s,r,n=V.BILINEAR_SAMPLINGMODE,a,l,h=0,c="",u=!1,d=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],s,r,n,a,l,null,h,"kernelBlur",{varyingCount:0,depCount:0},!0,d),this._blockCompilation=u,this._packedFloat=!1,this._staticDefines="",this._staticDefines=c,this.direction=t,this.onApplyObservable.add(f=>{this._outputTexture?f.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):f.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=i}updateEffect(e=null,t=null,i=null,s,r,n){this._updateParameters(r,n)}_updateParameters(e,t){const i=this._kernel,s=(i-1)/2;let r=[],n=[],a=0;for(let g=0;g<i;g++){const E=g/(i-1),R=this._gaussianWeight(E*2-1);r[g]=g-s,n[g]=R,a+=R}for(let g=0;g<n.length;g++)n[g]/=a;const l=[],h=[],c=[];for(let g=0;g<=s;g+=2){const E=Math.min(g+1,Math.floor(s));if(g===E)c.push({o:r[g],w:n[g]});else{const x=E===s,S=n[g]+n[E]*(x?.5:1),b=r[g]+1/(1+n[g]/n[E]);b===0?(c.push({o:r[g],w:n[g]}),c.push({o:r[g+1],w:n[g+1]})):(c.push({o:b,w:S}),c.push({o:-b,w:S}))}}for(let g=0;g<c.length;g++)h[g]=c[g].o,l[g]=c[g].w;r=h,n=l;const u=this.getEngine().getCaps().maxVaryingVectors,d=Math.max(u,0)-1;let f=Math.min(r.length,d),p="";p+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(n[f-1])}
`,f--);for(let g=0;g<f;g++)p+=`#define KERNEL_OFFSET${g} ${this._glslFloat(r[g])}
`,p+=`#define KERNEL_WEIGHT${g} ${this._glslFloat(n[g])}
`;let _=0;for(let g=d;g<r.length;g++)p+=`#define KERNEL_DEP_OFFSET${_} ${this._glslFloat(r[g])}
`,p+=`#define KERNEL_DEP_WEIGHT${_} ${this._glslFloat(n[g])}
`,_++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(p,null,null,{varyingCount:f,depCount:_},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const i of[t,t-1,t+1,t-2,t+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){const t=.3333333333333333,i=Math.sqrt(2*Math.PI)*t,s=-(e*e/(2*t*t));return 1/i*Math.exp(s)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,s){return Le.Parse(()=>new Sn(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,s)}}v([M("kernel")],Sn.prototype,"_kernel",void 0);v([M("packedFloat")],Sn.prototype,"_packedFloat",void 0);v([Af()],Sn.prototype,"direction",void 0);Re("BABYLON.BlurPostProcess",Sn);const sx="bayerDitherFunctions",rx=`float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}
float bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
float bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;X.IncludesShadersStore[sx]=rx;const nx="shadowMapFragmentExtraDeclaration",ax=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;X.IncludesShadersStore[nx]=ax;const ox="shadowMapFragment",lx=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;X.IncludesShadersStore[ox]=lx;const hx="shadowMapPixelShader",cx=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;X.ShadersStore[hx]=cx;const ux="sceneVertexDeclaration",dx=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;X.IncludesShadersStore[ux]=dx;const fx="meshVertexDeclaration",_x=`uniform mat4 world;uniform float visibility;
`;X.IncludesShadersStore[fx]=_x;const px="shadowMapVertexDeclaration",gx=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;X.IncludesShadersStore[px]=gx;const mx="meshUboDeclaration",Ex=`#ifdef WEBGL2
uniform mat4 world;uniform float visibility;
#else
layout(std140,column_major) uniform;uniform Mesh
{mat4 world;float visibility;};
#endif
#define WORLD_UBO
`;X.IncludesShadersStore[mx]=Ex;const Tx="shadowMapUboDeclaration",vx=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;X.IncludesShadersStore[Tx]=vx;const Ax="shadowMapVertexExtraDeclaration",Rx=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;X.IncludesShadersStore[Ax]=Rx;const bx="shadowMapVertexNormalBias",Sx=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;X.IncludesShadersStore[bx]=Sx;const yx="shadowMapVertexMetric",Cx=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;X.IncludesShadersStore[yx]=Cx;const xx="shadowMapVertexShader",Mx=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;X.ShadersStore[xx]=Mx;const Ix="depthBoxBlurPixelShader",Px=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}`;X.ShadersStore[Ix]=Px;const Dx="shadowMapFragmentSoftTransparentShadow",Ox=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;X.IncludesShadersStore[Dx]=Ox;class Fe{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===Fe.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===Fe.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===Fe.FILTER_PCF||e===Fe.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===Fe.FILTER_PCF||e===Fe.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===Fe.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(Fe.FILTER_POISSONSAMPLING);!e&&this.filter!==Fe.FILTER_POISSONSAMPLING||(this.filter=e?t:Fe.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===Fe.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(Fe.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==Fe.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:Fe.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===Fe.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(Fe.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==Fe.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:Fe.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===Fe.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(Fe.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==Fe.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:Fe.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===Fe.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(Fe.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==Fe.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:Fe.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===Fe.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(Fe.FILTER_PCF);!e&&this.filter!==Fe.FILTER_PCF||(this.filter=e?t:Fe.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===Fe.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(Fe.FILTER_PCSS);!e&&this.filter!==Fe.FILTER_PCSS||(this.filter=e?t:Fe.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return Fe.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(const i of e.getChildMeshes())this._shadowMap.renderList.indexOf(i)===-1&&this._shadowMap.renderList.push(i);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(i!==-1&&this._shadowMap.renderList.splice(i,1),t)for(const s of e.getChildren())this.removeShadowCaster(s);return this}getLight(){return this._light}_getCamera(){var e;return(e=this._camera)!==null&&e!==void 0?e:this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,s,r){this.onBeforeShadowMapRenderObservable=new j,this.onAfterShadowMapRenderObservable=new j,this.onBeforeShadowMapRenderMeshObservable=new j,this.onAfterShadowMapRenderMeshObservable=new j,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=Fe.FILTER_NONE,this._filteringQuality=Fe.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=m.Zero(),this._viewMatrix=L.Zero(),this._projectionMatrix=L.Zero(),this._transformMatrix=L.Zero(),this._cachedPosition=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=L.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=s??null,this._useRedTextureType=!!r;let n=t._shadowGenerators;n||(n=t._shadowGenerators=new Map),n.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),Fe._SceneComponentInitialization(this._scene);const a=this._scene.getEngine().getCaps();i?a.textureFloatRender&&a.textureFloatLinearFiltering?this._textureType=1:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:a.textureHalfFloatRender&&a.textureHalfFloatLinearFiltering?this._textureType=2:a.textureFloatRender&&a.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new Ki(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new Ki(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=V.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=V.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(V.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(s,r,n,a)=>this._renderForShadowMap(s,r,n,a),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var s;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(s=e._debugPushGroup)===null||s===void 0||s.call(e,`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(s=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=s,this._filter===Fe.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var s,r;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===Fe.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){(s=e._debugPopGroup)===null||s===void 0||s.call(e,1);return}const n=this.getShadowMapForRendering();n&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,n.renderTarget,!0),e.unBindFramebuffer(n.renderTarget,!0),(r=e._debugPopGroup)===null||r===void 0||r.call(e,1))});const t=new He(0,0,0,0),i=new He(1,1,1,1);this._shadowMap.onClearObservable.add(s=>{this._filter===Fe.FILTER_PCF?s.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?s.clear(t,!0,!0,!1):s.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(s=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=s.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let s=Ii.MIN_RENDERINGGROUPS;s<Ii.MAX_RENDERINGGROUPS;s++)this._shadowMap.setRenderingAutoClearDepthStencil(s,!1)}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new Ki(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=V.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=V.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(V.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Sn(this._light.name+"KernelBlurX",new Ke(1,0),this.blurKernel,1,null,V.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(i=>{i.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new Sn(this._light.name+"KernelBlurY",new Ke(0,1),this.blurKernel,1,null,V.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new ht(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,V.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",t,t),i.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,s){let r;if(s.length)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],!0);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){var i,s;const r=e.getRenderingMesh(),n=e.getEffectiveMesh(),a=this._scene,l=a.getEngine(),h=e.getMaterial();if(n._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!h||e.verticesCount===0||e._renderId===a.getRenderId())return;const c=n._getWorldMatrixDeterminant()<0;let u=(i=r.overrideMaterialSideOrientation)!==null&&i!==void 0?i:h.sideOrientation;c&&(u=u===0?1:0);const d=u===0;l.setState(h.backFaceCulling,void 0,void 0,d,h.cullBackFaces);const f=r._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(f.mustReturn)return;const p=l.getCaps().instancedArrays&&(f.visibleInstances[e._id]!==null&&f.visibleInstances[e._id]!==void 0||r.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,p,t)){e._renderId=a.getRenderId();const _=h.shadowDepthWrapper,g=(s=_==null?void 0:_.getEffect(e,this,l.currentRenderPassId))!==null&&s!==void 0?s:e._getDrawWrapper(),E=_r.GetEffect(g);l.enableEffect(g),p||r._bind(e,E,h.fillMode),this.getTransformMatrix(),E.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===qe.LIGHTTYPEID_DIRECTIONALLIGHT?E.setVector3("lightDataSM",this._cachedDirection):E.setVector3("lightDataSM",this._cachedPosition);const R=this._getCamera();if(R&&E.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(R),this.getLight().getDepthMinZ(R)+this.getLight().getDepthMaxZ(R)),t&&this.enableSoftTransparentShadow&&E.setFloat("softTransparentShadowSM",n.visibility*h.alpha),_)e._setMainDrawWrapperOverride(g),_.standalone?_.baseMaterial.bindForSubMesh(n.getWorldMatrix(),r,e):h.bindForSubMesh(n.getWorldMatrix(),r,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(E.setTexture("diffuseSampler",this._opacityTexture),E.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),r.useBones&&r.computeBonesUsingShaders&&r.skeleton){const S=r.skeleton;if(S.isUsingTextureForMatrices){const b=S.getTransformMatrixTexture(r);if(!b)return;E.setTexture("boneSampler",b),E.setFloat("boneTextureWidth",4*(S.bones.length+1))}else E.setMatrices("mBones",S.getTransformMatrices(r))}se.BindMorphTargetParameters(r,E),r.morphTargetManager&&r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(E),Pn(E,h,a)}!this._useUBO&&!_&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,E,n),se.BindSceneUniformBuffer(E,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const x=n.getWorldMatrix();p&&(n.getMeshUniformBuffer().bindToEffect(E,"Mesh"),n.transferToEffect(x)),this.forceBackFacesOnly&&l.setState(!0,0,!1,!0,h.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(r),this.onBeforeShadowMapRenderObservable.notifyObservers(E),r._processRendering(n,e,E,h.fillMode,f,p,(S,b)=>{n!==r&&!S?(r.getMeshUniformBuffer().bindToEffect(E,"Mesh"),r.transferToEffect(b)):(n.getMeshUniformBuffer().bindToEffect(E,"Mesh"),n.transferToEffect(S?b:x))}),this.forceBackFacesOnly&&l.setState(!0,0,!1,!1,h.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(E),this.onAfterShadowMapRenderMeshObservable.notifyObservers(r)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===Fe.FILTER_NONE||this.filter===Fe.FILTER_PCSS?this._shadowMap.updateSamplingMode(V.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(V.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i=Object.assign({useInstances:!1},t),s=this.getShadowMap();if(!s){e&&e(this);return}const r=s.renderList;if(!r){e&&e(this);return}const n=[];for(const h of r)n.push(...h.subMeshes);if(n.length===0){e&&e(this);return}let a=0;const l=()=>{var h,c;if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(n[a],i.useInstances,(c=(h=n[a].getMaterial())===null||h===void 0?void 0:h.needAlphaBlendingForMesh(n[a].getMesh()))!==null&&c!==void 0?c:!1);)if(a++,a>=n.length){e&&e(this);return}setTimeout(l,16)}};l()}forceCompilationAsync(e){return new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const r=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(T.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===qe.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){var s;const r=e.getMaterial(),n=r==null?void 0:r.shadowDepthWrapper;if(this._opacityTexture=null,!r)return!1;const a=[];if(this._prepareShadowDefines(e,t,a,i),n){if(!n.isReadyForSubMesh(e,a,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const l=e._getDrawWrapper(void 0,!0);let h=l.effect,c=l.defines;const u=[T.PositionKind],d=e.getMesh();this.normalBias&&d.isVerticesDataPresent(T.NormalKind)&&(u.push(T.NormalKind),a.push("#define NORMAL"),d.nonUniformScaling&&a.push("#define NONUNIFORMSCALING"));const f=r.needAlphaTesting();if((f||r.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=r.opacityTexture:this._opacityTexture=r.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;const R=(s=r.alphaCutOff)!==null&&s!==void 0?s:Fe.DEFAULT_ALPHA_CUTOFF;a.push("#define ALPHATEXTURE"),f&&a.push(`#define ALPHATESTVALUE ${R}${R%1===0?".":""}`),d.isVerticesDataPresent(T.UVKind)&&(u.push(T.UVKind),a.push("#define UV1")),d.isVerticesDataPresent(T.UV2Kind)&&this._opacityTexture.coordinatesIndex===1&&(u.push(T.UV2Kind),a.push("#define UV2"))}const p=new Ih;if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){u.push(T.MatricesIndicesKind),u.push(T.MatricesWeightsKind),d.numBoneInfluencers>4&&(u.push(T.MatricesIndicesExtraKind),u.push(T.MatricesWeightsExtraKind));const R=d.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+d.numBoneInfluencers),d.numBoneInfluencers>0&&p.addCPUSkinningFallback(0,d),R.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(R.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");const _=d.morphTargetManager;let g=0;if(_&&_.numInfluencers>0&&(a.push("#define MORPHTARGETS"),g=_.numInfluencers,a.push("#define NUM_MORPH_INFLUENCERS "+g),_.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(u,d,g)),Mh(r,this._scene,a),t&&(a.push("#define INSTANCES"),se.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const R of this.customShaderOptions.defines)a.indexOf(R)===-1&&a.push(R);const E=a.join(`
`);if(c!==E){c=E;let R="shadowMap";const x=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],S=["diffuseSampler","boneSampler","morphTargets"],b=["Scene","Mesh"];if(In(x),this.customShaderOptions){if(R=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const I of this.customShaderOptions.attributes)u.indexOf(I)===-1&&u.push(I);if(this.customShaderOptions.uniforms)for(const I of this.customShaderOptions.uniforms)x.indexOf(I)===-1&&x.push(I);if(this.customShaderOptions.samplers)for(const I of this.customShaderOptions.samplers)S.indexOf(I)===-1&&S.push(I)}const y=this._scene.getEngine();h=y.createEffect(R,{attributes:u,uniformsNames:x,uniformBuffersNames:b,samplers:S,defines:E,fallbacks:p,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:g}},y),l.setEffect(h,c)}if(!h.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,s=this._light;!i.shadowsEnabled||!s.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===Fe.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Fe.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===Fe.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===Fe.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),s.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera();if(!r)return;const n=this.getShadowMap();n&&(i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===Fe.FILTER_PCF?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,e)):this._filter===Fe.FILTER_PCSS?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),t.setTexture("depthSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this._contactHardeningLightSizeUVRatio*n.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e))}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),m.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(m.Dot(this._lightDirection,m.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),L.LookAtLHToRef(t,t.add(this._lightDirection),m.Up(),this._viewMatrix);const i=this.getShadowMap();if(i){const s=i.renderList;s&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,s)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const i of t)this._shadowMap.renderList.push(i)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){const e=this._light._shadowGenerators.entries();for(let t=e.next();t.done!==!0;t=e.next()){const[i,s]=t.value;s===this&&this._light._shadowGenerators.delete(i)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){var e;const t={},i=this.getShadowMap();if(!i)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.cameraId=(e=this._camera)===null||e===void 0?void 0:e.id,t.id=this.id,t.mapSize=i.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],i.renderList)for(let s=0;s<i.renderList.length;s++){const r=i.renderList[s];t.renderList.push(r.id)}return t}static Parse(e,t,i){const s=t.getLightById(e.lightId),r=e.cameraId!==void 0?t.getCameraById(e.cameraId):null,n=i?i(e.mapSize,s,r):new Fe(e.mapSize,s,void 0,r),a=n.getShadowMap();for(let l=0;l<e.renderList.length;l++)t.getMeshesById(e.renderList[l]).forEach(function(c){a&&(a.renderList||(a.renderList=[]),a.renderList.push(c))});return e.id!==void 0&&(n.id=e.id),n.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&n.setDarkness(e.darkness),e.transparencyShadow&&n.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(n.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(n.bias=e.bias),e.normalBias!==void 0&&(n.normalBias=e.normalBias),e.usePercentageCloserFiltering?n.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?n.useContactHardeningShadow=!0:e.usePoissonSampling?n.usePoissonSampling=!0:e.useExponentialShadowMap?n.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?n.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?n.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?n.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?n.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(n.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(n.filteringQuality=e.filteringQuality),e.depthScale&&(n.depthScale=e.depthScale),e.blurScale&&(n.blurScale=e.blurScale),e.blurBoxOffset&&(n.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(n.useKernelBlur=e.useKernelBlur),e.blurKernel&&(n.blurKernel=e.blurKernel),n}}Fe.CLASSNAME="ShadowGenerator";Fe.FILTER_NONE=0;Fe.FILTER_EXPONENTIALSHADOWMAP=1;Fe.FILTER_POISSONSAMPLING=2;Fe.FILTER_BLUREXPONENTIALSHADOWMAP=3;Fe.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;Fe.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;Fe.FILTER_PCF=6;Fe.FILTER_PCSS=7;Fe.QUALITY_HIGH=0;Fe.QUALITY_MEDIUM=1;Fe.QUALITY_LOW=2;Fe.DEFAULT_ALPHA_CUTOFF=.5;Fe._SceneComponentInitialization=o=>{throw ke("ShadowGeneratorSceneComponent")};const Nx="minmaxReduxPixelShader",Lx=`varying vec2 vUV;uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(MAIN)
uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(LAST)
void main(void)
{glFragColor=vec4(0.);if (true) { 
discard;}}
#endif
`;X.ShadersStore[Nx]=Lx;class Fx{constructor(e){this.onAfterReductionPerformed=new j,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new Dc(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,s=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=s;const r=this._camera.getScene(),n=new ht("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,r.getEngine(),!1,"#define INITIAL"+(t?`
#define DEPTH_REDUX`:""),i,void 0,void 0,void 0,7);n.autoClear=!1,n.forceFullscreenViewport=s;let a=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();n.onApply=((c,u)=>d=>{d.setTexture("sourceTexture",this._sourceTexture),d.setFloat2("texSize",c,u)})(a,l),this._reductionSteps.push(n);let h=1;for(;a>1||l>1;){a=Math.max(Math.round(a/2),1),l=Math.max(Math.round(l/2),1);const c=new ht("Reduction phase "+h,"minmaxRedux",["texSize"],null,{width:a,height:l},null,1,r.getEngine(),!1,"#define "+(a==1&&l==1?"LAST":a==1||l==1?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(c.autoClear=!1,c.forceFullscreenViewport=s,c.onApply=((u,d)=>f=>{u==1||d==1?f.setInt2("texSize",u,d):f.setFloat2("texSize",u,d)})(a,l),this._reductionSteps.push(c),h++,a==1&&l==1){const u=(d,f,p)=>{const _=new Float32Array(4*d*f),g={min:0,max:0};return()=>{r.getEngine()._readTexturePixels(p.inputTexture.texture,d,f,-1,0,_,!1),g.min=_[0],g.max=_[1],this.onAfterReductionPerformed.notifyObservers(g)}};c.onAfterRenderObservable.add(u(a,l,c))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var e,t;const i=this._camera.getScene().getEngine();(e=i._debugPushGroup)===null||e===void 0||e.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),(t=i._debugPopGroup)===null||t===void 0||t.call(i,1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class wx extends Fx{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){const s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),e===null&&(s._depthRenderer||(s._depthRenderer={}),e=this._depthRenderer=new Al(s,t,this._camera,!1,1),e.enabled=!1,this._depthRendererId="minmax"+this._camera.id,s._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,s=!0){super.setSourceTexture(e,t,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const vg=m.Up(),Bx=m.Zero(),di=new m,Ba=new m,Sc=new L;class Ti extends Fe{_validateFilter(e){return e===Fe.FILTER_NONE||e===Fe.FILTER_PCF||e===Fe.FILTER_PCSS?e:(q.Error('Unsupported filter "'+e+'"!'),Fe.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){e=Math.min(Math.max(e,Ti.MIN_CASCADES_COUNT),Ti.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(()=>this._computeShadowCastersBoundingInfo())),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let i=0;i<e.length;i++){const s=e[i];if(!s)continue;const r=s.getBoundingInfo(),n=r.boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}const t=this._scene.meshes;for(let i=0;i<t.length;i++){const s=t[i];if(!s||!s.isVisible||!s.isEnabled||!s.receiveShadows)continue;const r=s.getBoundingInfo(),n=r.boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Ti.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){const t=this._getCamera();if(!t){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&t.maxZ!==0||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new wx(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let s=i.min,r=i.max;s>=r&&(s=0,r=1),(s!=this._minDistance||r!=this._maxDistance)&&this.setMinMaxDistance(s,r)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t,i;return(i=(t=(e=this._depthReducer)===null||e===void 0?void 0:e.depthRenderer)===null||t===void 0?void 0:t.getDepthMap().refreshRate)!==null&&i!==void 0?i:-1}set autoCalcDepthBoundsRefreshRate(e){var t;!((t=this._depthReducer)===null||t===void 0)&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._getCamera();if(!e)return;const t=e.minZ,i=e.maxZ||this._shadowMaxZ,s=i-t,r=this._minDistance,n=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,a=t+r*s,l=t+n*s,h=l-a,c=l/a;for(let u=0;u<this._cascades.length;++u){const d=(u+1)/this._numCascades,f=a*c**d,p=a+h*d,_=this._lambda*(f-p)+p;this._cascades[u].prevBreakDistance=u===0?r:this._cascades[u-1].breakDistance,this._cascades[u].breakDistance=(_-t)/s,this._viewSpaceFrustumsZ[u]=_,this._frustumLengths[u]=(this._cascades[u].breakDistance-this._cascades[u].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!this._getCamera())return;m.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(m.Dot(this._lightDirection,m.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const i=e.getEngine().useReverseDepthBuffer;for(let s=0;s<this._numCascades;++s){this._computeFrustumInWorldSpace(s),this._computeCascadeFrustum(s),this._cascadeMaxExtents[s].subtractToRef(this._cascadeMinExtents[s],di),this._frustumCenter[s].addToRef(this._lightDirection.scale(this._cascadeMinExtents[s].z),this._shadowCameraPos[s]),L.LookAtLHToRef(this._shadowCameraPos[s],this._frustumCenter[s],vg,this._viewMatrices[s]);let r=0,n=di.z;const a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[s]),n=Math.min(n,a.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===Fe.FILTER_PCSS?r=Math.min(r,a.boundingBox.minimumWorld.z):r=Math.max(r,a.boundingBox.minimumWorld.z),L.OrthoOffCenterLHToRef(this._cascadeMinExtents[s].x,this._cascadeMaxExtents[s].x,this._cascadeMinExtents[s].y,this._cascadeMaxExtents[s].y,i?n:r,i?r:n,this._projectionMatrices[s],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[s].z=r,this._cascadeMaxExtents[s].z=n,this._viewMatrices[s].multiplyToRef(this._projectionMatrices[s],this._transformMatrices[s]),m.TransformCoordinatesToRef(Bx,this._transformMatrices[s],di),di.scaleInPlace(this._mapSize/2),Ba.copyFromFloats(Math.round(di.x),Math.round(di.y),Math.round(di.z)),Ba.subtractInPlace(di).scaleInPlace(2/this._mapSize),L.TranslationToRef(Ba.x,Ba.y,0,Sc),this._projectionMatrices[s].multiplyToRef(Sc,this._projectionMatrices[s]),this._viewMatrices[s].multiplyToRef(this._projectionMatrices[s],this._transformMatrices[s]),this._transformMatrices[s].copyToArray(this._transformMatricesAsArray,s*16)}}_computeFrustumInWorldSpace(e){const t=this._getCamera();if(!t)return;const i=this._cascades[e].prevBreakDistance,s=this._cascades[e].breakDistance,r=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();const n=t.maxZ===0,a=t.maxZ;n&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));const l=L.Invert(t.getTransformationMatrix());n&&(t.maxZ=a,t.getProjectionMatrix(!0));const h=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let c=0;c<Ti._FrustumCornersNDCSpace.length;++c)di.copyFrom(Ti._FrustumCornersNDCSpace[(c+h)%Ti._FrustumCornersNDCSpace.length]),r&&di.z===-1&&(di.z=0),m.TransformCoordinatesToRef(di,l,this._frustumCornersWorldSpace[e][c]);for(let c=0;c<Ti._FrustumCornersNDCSpace.length/2;++c)di.copyFrom(this._frustumCornersWorldSpace[e][c+4]).subtractInPlace(this._frustumCornersWorldSpace[e][c]),Ba.copyFrom(di).scaleInPlace(i),di.scaleInPlace(s),di.addInPlace(this._frustumCornersWorldSpace[e][c]),this._frustumCornersWorldSpace[e][c+4].copyFrom(di),this._frustumCornersWorldSpace[e][c].addInPlace(Ba)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),!!this._getCamera()){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let s=0;s<this._frustumCornersWorldSpace[e].length;++s){const r=this._frustumCornersWorldSpace[e][s].subtractToRef(this._frustumCenter[e],di).length();i=Math.max(i,r)}i=Math.ceil(i*16)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{const i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,di),L.LookAtLHToRef(i,di,vg,Sc);for(let s=0;s<this._frustumCornersWorldSpace[e].length;++s)m.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][s],Sc,di),this._cascadeMinExtents[e].minimizeInPlace(di),this._cascadeMaxExtents[e].maximizeInPlace(di)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=Ze.LastCreatedEngine;return e?e._features.supportCSM:!1}constructor(e,t,i,s,r=!0){if(!Ti.IsSupported){q.Error("CascadedShadowMap is not supported by the current engine.");return}super(e,t,i,s,r),this.usePercentageCloserFiltering=!0}_initializeGenerator(){var e,t,i,s,r,n,a,l,h,c,u,d,f,p,_,g,E,R,x,S;this.penumbraDarkness=(e=this.penumbraDarkness)!==null&&e!==void 0?e:1,this._numCascades=(t=this._numCascades)!==null&&t!==void 0?t:Ti.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(i=this.stabilizeCascades)!==null&&i!==void 0?i:!1,this._freezeShadowCastersBoundingInfoObservable=(s=this._freezeShadowCastersBoundingInfoObservable)!==null&&s!==void 0?s:null,this.freezeShadowCastersBoundingInfo=(r=this.freezeShadowCastersBoundingInfo)!==null&&r!==void 0?r:!1,this._scbiMin=(n=this._scbiMin)!==null&&n!==void 0?n:new m(0,0,0),this._scbiMax=(a=this._scbiMax)!==null&&a!==void 0?a:new m(0,0,0),this._shadowCastersBoundingInfo=(l=this._shadowCastersBoundingInfo)!==null&&l!==void 0?l:new hs(new m(0,0,0),new m(0,0,0)),this._breaksAreDirty=(h=this._breaksAreDirty)!==null&&h!==void 0?h:!0,this._minDistance=(c=this._minDistance)!==null&&c!==void 0?c:0,this._maxDistance=(u=this._maxDistance)!==null&&u!==void 0?u:1,this._currentLayer=(d=this._currentLayer)!==null&&d!==void 0?d:0,this._shadowMaxZ=(_=(f=this._shadowMaxZ)!==null&&f!==void 0?f:(p=this._getCamera())===null||p===void 0?void 0:p.maxZ)!==null&&_!==void 0?_:1e4,this._debug=(g=this._debug)!==null&&g!==void 0?g:!1,this._depthClamp=(E=this._depthClamp)!==null&&E!==void 0?E:!0,this._cascadeBlendPercentage=(R=this._cascadeBlendPercentage)!==null&&R!==void 0?R:.1,this._lambda=(x=this._lambda)!==null&&x!==void 0?x:.5,this._autoCalcDepthBounds=(S=this._autoCalcDepthBounds)!==null&&S!==void 0?S:!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new Ki(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),this._shadowMap===null)return;this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=L.Zero(),this._projectionMatrices[t]=L.Zero(),this._transformMatrices[t]=L.Zero(),this._cascadeMinExtents[t]=new m,this._cascadeMaxExtents[t]=new m,this._frustumCenter[t]=new m,this._shadowCameraPos[t]=new m,this._frustumCornersWorldSpace[t]=new Array(Ti._FrustumCornersNDCSpace.length);for(let i=0;i<Ti._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new m}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===Fe.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(t=e._debugPushGroup)===null||t===void 0||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==Fe.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const r=this._getCamera();r&&this._shadowMaxZ<=(r.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;const r=this._getCamera();if(!r)return;const n=this.getShadowMap();if(!n)return;const a=n.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===Fe.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);else if(this._filter===Fe.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[l*2+0]=l===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[l*2+1]=l===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=l===0?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,n),t.setTexture("depthSampler"+e,n),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a,this._contactHardeningLightSizeUVRatio*a,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t){const i=Fe.Parse(e,t,(s,r,n)=>new Ti(s,r,void 0,n));return e.numCascades!==void 0&&(i.numCascades=e.numCascades),e.debug!==void 0&&(i.debug=e.debug),e.stabilizeCascades!==void 0&&(i.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(i.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(i.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(i.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(i.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Ti._FrustumCornersNDCSpace=[new m(-1,1,-1),new m(1,1,-1),new m(1,-1,-1),new m(-1,-1,-1),new m(-1,1,1),new m(1,1,1),new m(1,-1,1),new m(-1,-1,1)];Ti.CLASSNAME="CascadedShadowGenerator";Ti.DEFAULT_CASCADES_COUNT=4;Ti.MIN_CASCADES_COUNT=2;Ti.MAX_CASCADES_COUNT=4;Ti._SceneComponentInitialization=o=>{throw ke("ShadowGeneratorSceneComponent")};da.AddParser(pe.NAME_SHADOWGENERATOR,(o,e)=>{if(o.shadowGenerators!==void 0&&o.shadowGenerators!==null)for(let t=0,i=o.shadowGenerators.length;t<i;t++){const s=o.shadowGenerators[t];s.className===Ti.CLASSNAME?Ti.Parse(s,e):Fe.Parse(s,e)}});class Ux{constructor(e){this.name=pe.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(pe.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const s=i.getShadowGenerators();if(s){const r=s.values();for(let n=r.next();n.done!==!0;n=r.next()){const a=n.value;e.shadowGenerators.push(a.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const s=t.lights[i],r=s.getShadowGenerators();if(s.isEnabled()&&s.shadowEnabled&&r){const n=r.values();for(let a=n.next();a.done!==!0;a=n.next()){const h=a.value.getShadowMap();t.textures.indexOf(h)!==-1&&e.push(h)}}}}}Fe._SceneComponentInitialization=o=>{let e=o._getComponent(pe.NAME_SHADOWGENERATOR);e||(e=new Ux(o),o._addComponent(e))};Jt.AddNodeConstructor("Light_Type_1",(o,e)=>()=>new bs(o,m.Zero(),e));class bs extends _a{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return qe.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;t&&L.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const c=m.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let u=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let f=0;f<i.length;f++){const p=i[f];if(!p)continue;const g=p.getBoundingInfo().boundingBox;for(let E=0;E<g.vectorsWorld.length;E++)m.TransformCoordinatesToRef(g.vectorsWorld[E],t,c),c.x<this._orthoLeft&&(this._orthoLeft=c.x),c.y<this._orthoBottom&&(this._orthoBottom=c.y),c.x>this._orthoRight&&(this._orthoRight=c.x),c.y>this._orthoTop&&(this._orthoTop=c.y),this.autoCalcShadowZBounds&&(c.z<u&&(u=c.z),c.z>d&&(d=c.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=u,this._shadowMaxZ=d)}const r=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,a=this.shadowMinZ!==void 0?this.shadowMinZ:s.minZ,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:s.maxZ,h=this.getScene().getEngine().useReverseDepthBuffer;L.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,h?l:a,h?a:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}v([M()],bs.prototype,"shadowFrustumSize",null);v([M()],bs.prototype,"shadowOrthoScale",null);v([M()],bs.prototype,"autoUpdateExtends",void 0);v([M()],bs.prototype,"autoCalcShadowZBounds",void 0);v([M("orthoLeft")],bs.prototype,"_orthoLeft",void 0);v([M("orthoRight")],bs.prototype,"_orthoRight",void 0);v([M("orthoTop")],bs.prototype,"_orthoTop",void 0);v([M("orthoBottom")],bs.prototype,"_orthoBottom",void 0);Jt.AddNodeConstructor("Light_Type_0",(o,e)=>()=>new Rl(o,m.Zero(),e));class Rl extends _a{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){const i=this._shadowGenerators.values();for(let s=i.next();s.done!==!0;s=i.next())s.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return qe.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new m(1,0,0);case 1:return new m(-1,0,0);case 2:return new m(0,-1,0);case 3:return new m(0,1,0);case 4:return new m(0,0,1);case 5:return new m(0,0,-1)}return m.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;const r=this.shadowMinZ!==void 0?this.shadowMinZ:s.minZ,n=this.shadowMaxZ!==void 0?this.shadowMaxZ:s.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;L.PerspectiveFovLHToRef(this.shadowAngle,1,a?n:r,a?r:n,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}v([M()],Rl.prototype,"shadowAngle",null);Jt.AddNodeConstructor("Light_Type_2",(o,e)=>()=>new es(o,m.Zero(),m.Zero(),0,0,e));class es extends _a{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(es._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):es._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,s,r,n){super(e,n),this._innerAngle=0,this._projectionTextureMatrix=L.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=m.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=m.Zero(),this._projectionTextureViewLightMatrix=L.Zero(),this._projectionTextureProjectionLightMatrix=L.Zero(),this._projectionTextureScalingMatrix=L.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=s,this.exponent=r}getClassName(){return"SpotLight"}getTypeID(){return qe.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;this._shadowAngleScale=this._shadowAngleScale||1;const r=this._shadowAngleScale*this._angle,n=this.shadowMinZ!==void 0?this.shadowMinZ:s.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:s.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;L.PerspectiveFovLHToRef(r,1,l?a:n,l?n:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.direction,this._projectionTextureViewTargetVector),L.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),s=-i*t,r=1/Math.tan(this._angle/2),n=1;L.FromValuesToRef(r/n,0,0,0,0,r,0,0,0,0,i,1,0,0,s,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof V){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;L.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=m.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=m.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=m.Normalize(this.transformedDirection):i=m.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}v([M()],es.prototype,"angle",null);v([M()],es.prototype,"innerAngle",null);v([M()],es.prototype,"shadowAngleScale",null);v([M()],es.prototype,"exponent",void 0);v([M()],es.prototype,"projectionTextureLightNear",null);v([M()],es.prototype,"projectionTextureLightFar",null);v([M()],es.prototype,"projectionTextureUpDirection",null);v([rt("projectedLightTexture")],es.prototype,"_projectionTexture",void 0);var on;(function(o){o[o.Clean=0]="Clean",o[o.Stop=1]="Stop",o[o.Sync=2]="Sync",o[o.NoSync=3]="NoSync"})(on||(on={}));class ct{static get ForceFullSceneLoadingForIncremental(){return _i.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){_i.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return _i.ShowLoadingScreen}static set ShowLoadingScreen(e){_i.ShowLoadingScreen=e}static get loggingLevel(){return _i.loggingLevel}static set loggingLevel(e){_i.loggingLevel=e}static get CleanBoneMatrixWeights(){return _i.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){_i.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return ct._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){const t=ct._RegisteredPlugins[e];return t||(q.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),ct.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in ct._RegisteredPlugins){const i=ct._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return ct._RegisteredPlugins[t]}return ct.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));const i=e.lastIndexOf("."),s=e.substring(i,e.length).toLowerCase();return ct._GetPluginForExtension(s)}static _GetDirectLoad(e){return e.substr(0,5)==="data:"?e.substr(5):null}static _FormatErrorMessage(e,t,i){let r="Unable to load from "+(e.rawData?"binary data":e.url);return t?r+=`: ${t}`:i&&(r+=`: ${i}`),r}static _LoadData(e,t,i,s,r,n,a,l){const h=ct._GetDirectLoad(e.url);if(e.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";const c=a?ct._GetPluginForExtension(a):h?ct._GetPluginForDirectLoad(e.url):ct._GetPluginForFilename(e.url);if(e.rawData&&!c.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";let u;if(c.plugin.createPlugin!==void 0?u=c.plugin.createPlugin():u=c.plugin,!u)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(ct.OnPluginActivatedObservable.notifyObservers(u),h&&(u.canDirectLoad&&u.canDirectLoad(e.url)||!Xc(e.url))){if(u.directLoad){const S=u.directLoad(t,h);S.then?S.then(b=>{i(u,b)}).catch(b=>{r("Error in directLoad of _loadData: "+b,b)}):i(u,S)}else i(u,h);return u}const d=c.isBinary,f=(S,b)=>{if(t.isDisposed){r("Scene has been disposed");return}i(u,S,b)};let p=null,_=!1;const g=u.onDisposeObservable;g&&g.add(()=>{_=!0,p&&(p.abort(),p=null),n()});const E=()=>{if(_)return;const S=(b,y)=>{r(b==null?void 0:b.statusText,y)};if(!u.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";p=u.loadFile?u.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,f,s,d,S,l):t._loadFile(e.file||e.url,f,s,!0,d,S)},R=t.getEngine();let x=R.enableOfflineSupport;if(x){let S=!1;for(const b of t.disableOfflineSupportExceptionRules)if(b.test(e.url)){S=!0;break}x=!S}return x&&H.OfflineProviderFactory?t.offlineProvider=H.OfflineProviderFactory(e.url,E,R.disableManifestCheck):E(),u}static _GetFileInfo(e,t){let i,s,r=null,n=null;if(!t)i=e,s=Y.GetFilename(e),e=Y.GetFolderPath(e);else if(t.name){const a=t;i=`file:${a.name}`,s=a.name,r=a}else if(ArrayBuffer.isView(t))i="",s="arrayBuffer",n=t;else if(typeof t=="string"&&t.startsWith("data:"))i=t,s="";else{const a=t;if(a.substr(0,1)==="/")return Y.Error("Wrong sceneFilename parameter"),null;i=e+a,s=a}return{url:i,rootUrl:e,name:s,file:r,rawData:n}}static GetPluginForExtension(e){return ct._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!ct._RegisteredPlugins[e]}static RegisterPlugin(e){if(typeof e.extensions=="string"){const t=e.extensions;ct._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach(i=>{ct._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}static ImportMesh(e,t,i="",s=Ze.LastCreatedScene,r=null,n=null,a=null,l=null,h=""){if(!s)return q.Error("No scene available to import mesh to"),null;const c=ct._GetFileInfo(t,i);if(!c)return null;const u={};s.addPendingData(u);const d=()=>{s.removePendingData(u)},f=(g,E)=>{const R=ct._FormatErrorMessage(c,g,E);a?a(s,R,new fr(R,pn.SceneLoaderError,E)):q.Error(R),d()},p=n?g=>{try{n(g)}catch(E){f("Error in onProgress callback: "+E,E)}}:void 0,_=(g,E,R,x,S,b,y)=>{if(s.importedMeshesFiles.push(c.url),r)try{r(g,E,R,x,S,b,y)}catch(I){f("Error in onSuccess callback: "+I,I)}s.removePendingData(u)};return ct._LoadData(c,s,(g,E,R)=>{if(g.rewriteRootURL&&(c.rootUrl=g.rewriteRootURL(c.rootUrl,R)),g.importMesh){const x=g,S=[],b=[],y=[];if(!x.importMesh(e,s,E,c.rootUrl,S,b,y,f))return;s.loadingPluginName=g.name,_(S,b,y,[],[],[],[])}else g.importMeshAsync(e,s,E,c.rootUrl,p,c.name).then(S=>{s.loadingPluginName=g.name,_(S.meshes,S.particleSystems,S.skeletons,S.animationGroups,S.transformNodes,S.geometries,S.lights)}).catch(S=>{f(S.message,S)})},p,f,d,l,h)}static ImportMeshAsync(e,t,i="",s=Ze.LastCreatedScene,r=null,n=null,a=""){return new Promise((l,h)=>{ct.ImportMesh(e,t,i,s,(c,u,d,f,p,_,g)=>{l({meshes:c,particleSystems:u,skeletons:d,animationGroups:f,transformNodes:p,geometries:_,lights:g})},r,(c,u,d)=>{h(d||new Error(u))},n,a)})}static Load(e,t="",i=Ze.LastCreatedEngine,s=null,r=null,n=null,a=null,l=""){return i?ct.Append(e,t,new Ve(i),s,r,n,a,l):(Y.Error("No engine available"),null)}static LoadAsync(e,t="",i=Ze.LastCreatedEngine,s=null,r=null,n=""){return new Promise((a,l)=>{ct.Load(e,t,i,h=>{a(h)},s,(h,c,u)=>{l(u||new Error(c))},r,n)})}static Append(e,t="",i=Ze.LastCreatedScene,s=null,r=null,n=null,a=null,l=""){if(!i)return q.Error("No scene available to append to"),null;const h=ct._GetFileInfo(e,t);if(!h)return null;const c={};i.addPendingData(c);const u=()=>{i.removePendingData(c)};ct.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));const d=(_,g)=>{const E=ct._FormatErrorMessage(h,_,g);n?n(i,E,new fr(E,pn.SceneLoaderError,g)):q.Error(E),u()},f=r?_=>{try{r(_)}catch(g){d("Error in onProgress callback",g)}}:void 0,p=()=>{if(s)try{s(i)}catch(_){d("Error in onSuccess callback",_)}i.removePendingData(c)};return ct._LoadData(h,i,(_,g)=>{if(_.load){if(!_.load(i,g,h.rootUrl,d))return;i.loadingPluginName=_.name,p()}else _.loadAsync(i,g,h.rootUrl,f,h.name).then(()=>{i.loadingPluginName=_.name,p()}).catch(R=>{d(R.message,R)})},f,d,u,a,l)}static AppendAsync(e,t="",i=Ze.LastCreatedScene,s=null,r=null,n=""){return new Promise((a,l)=>{ct.Append(e,t,i,h=>{a(h)},s,(h,c,u)=>{l(u||new Error(c))},r,n)})}static LoadAssetContainer(e,t="",i=Ze.LastCreatedScene,s=null,r=null,n=null,a=null,l=""){if(!i)return q.Error("No scene available to load asset container to"),null;const h=ct._GetFileInfo(e,t);if(!h)return null;const c={};i.addPendingData(c);const u=()=>{i.removePendingData(c)},d=(_,g)=>{const E=ct._FormatErrorMessage(h,_,g);n?n(i,E,new fr(E,pn.SceneLoaderError,g)):q.Error(E),u()},f=r?_=>{try{r(_)}catch(g){d("Error in onProgress callback",g)}}:void 0,p=_=>{if(s)try{s(_)}catch(g){d("Error in onSuccess callback",g)}i.removePendingData(c)};return ct._LoadData(h,i,(_,g)=>{if(_.loadAssetContainer){const R=_.loadAssetContainer(i,g,h.rootUrl,d);if(!R)return;R.populateRootNodes(),i.loadingPluginName=_.name,p(R)}else _.loadAssetContainerAsync?_.loadAssetContainerAsync(i,g,h.rootUrl,f,h.name).then(R=>{R.populateRootNodes(),i.loadingPluginName=_.name,p(R)}).catch(R=>{d(R.message,R)}):d("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},f,d,u,a,l)}static LoadAssetContainerAsync(e,t="",i=Ze.LastCreatedScene,s=null,r=null){return new Promise((n,a)=>{ct.LoadAssetContainer(e,t,i,l=>{n(l)},s,(l,h,c)=>{a(c||new Error(h))},r)})}static ImportAnimations(e,t="",i=Ze.LastCreatedScene,s=!0,r=on.Clean,n=null,a=null,l=null,h=null,c=null){if(!i){q.Error("No scene available to load animations to");return}if(s){for(const p of i.animatables)p.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(p=>{p.dispose()}),i.getNodes().forEach(p=>{p.animations&&(p.animations=[])})}else switch(r){case on.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case on.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case on.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case on.NoSync:break;default:q.Error("Unknown animation group loading mode value '"+r+"'");return}const u=i.animatables.length,d=f=>{f.mergeAnimationsTo(i,i.animatables.slice(u),n),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),a&&a(i)};this.LoadAssetContainer(e,t,i,d,l,h,c)}static ImportAnimationsAsync(e,t="",i=Ze.LastCreatedScene,s=!0,r=on.Clean,n=null,a=null,l=null,h=null,c=null){return new Promise((u,d)=>{ct.ImportAnimations(e,t,i,s,r,n,f=>{u(f)},l,(f,p,_)=>{d(_||new Error(p))},c)})}}ct.NO_LOGGING=0;ct.MINIMAL_LOGGING=1;ct.SUMMARY_LOGGING=2;ct.DETAILED_LOGGING=3;ct.OnPluginActivatedObservable=new j;ct._RegisteredPlugins={};ct._ShowingLoadingScreen=!1;const kx="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let Vx=0;const Zm=o=>{if(!o.environmentBRDFTexture){const e=o.useDelayedTextureLoading;o.useDelayedTextureLoading=!1;const t=o._blockEntityCollection;o._blockEntityCollection=!1;const i=V.CreateFromBase64String(kx,"EnvironmentBRDFTexture"+Vx++,o,!0,!1,V.BILINEAR_SAMPLINGMODE);o._blockEntityCollection=t;const s=o.getEngine().getLoadedTexturesCache(),r=s.indexOf(i.getInternalTexture());r!==-1&&s.splice(r,1),i.isRGBD=!0,i.wrapU=V.CLAMP_ADDRESSMODE,i.wrapV=V.CLAMP_ADDRESSMODE,o.environmentBRDFTexture=i,o.useDelayedTextureLoading=e,cg.ExpandRGBDTexture(i);const n=o.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const a=()=>{i.isReady()?cg.ExpandRGBDTexture(i):Y.SetImmediate(a)};a()});o.onDisposeObservable.add(()=>{o.getEngine().onContextRestoredObservable.remove(n)})}return o.environmentBRDFTexture},Gx=new RegExp("^([gimus]+)!");class cn{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let s=0;s<this._plugins.length;++s)if(this._plugins[s].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();cn._MaterialPluginClassToMainDefine[t]||(cn._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++cn._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(s,r)=>this._handlePluginEvent(s,r),this._plugins.push(e),this._plugins.sort((s,r)=>s.priority-r.priority),this._codeInjectionPoints={};const i={};i[cn._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const s of this._plugins)s.collectDefines(i),this._collectPointNames("vertex",s.getCustomCode("vertex")),this._collectPointNames("fragment",s.getCustomCode("fragment"));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){var i;switch(e){case Di.GetActiveTextures:{const s=t;for(const r of this._activePlugins)r.getActiveTextures(s.activeTextures);break}case Di.GetAnimatables:{const s=t;for(const r of this._activePlugins)r.getAnimatables(s.animatables);break}case Di.HasTexture:{const s=t;let r=!1;for(const n of this._activePlugins)if(r=n.hasTexture(s.texture),r)break;s.hasTexture=r;break}case Di.Disposed:{const s=t;for(const r of this._plugins)r.dispose(s.forceDisposeTextures);break}case Di.GetDefineNames:{const s=t;s.defineNames=this._defineNamesFromPlugins;break}case Di.PrepareEffect:{const s=t;for(const r of this._activePlugins)s.fallbackRank=r.addFallbacks(s.defines,s.fallbacks,s.fallbackRank),r.getAttributes(s.attributes,this._scene,s.mesh);this._uniformList.length>0&&s.uniforms.push(...this._uniformList),this._samplerList.length>0&&s.samplers.push(...this._samplerList),this._uboList.length>0&&s.uniformBuffersNames.push(...this._uboList),s.customCode=this._injectCustomCode(s,s.customCode);break}case Di.PrepareUniformBuffer:{const s=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const r of this._plugins){const n=r.getUniforms();if(n){if(n.ubo)for(const a of n.ubo){if(a.size&&a.type){const l=(i=a.arraySize)!==null&&i!==void 0?i:0;s.ubo.addUniform(a.name,a.size,l),this._uboDeclaration+=`${a.type} ${a.name}${l>0?`[${l}]`:""};
`}this._uniformList.push(a.name)}n.vertex&&(this._vertexDeclaration+=n.vertex+`
`),n.fragment&&(this._fragmentDeclaration+=n.fragment+`
`)}r.getSamplers(this._samplerList),r.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,s)=>{var r,n;t&&(s=t(i,s)),this._uboDeclaration&&(s=s.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(s=s.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(s=s.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const a=(r=this._codeInjectionPoints)===null||r===void 0?void 0:r[i];if(!a)return s;let l=null;for(let h in a){let c="";for(const u of this._activePlugins){let d=(n=u.getCustomCode(i))===null||n===void 0?void 0:n[h];if(d){if(u.resolveIncludes){if(l===null){const f=bi.GLSL;l={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:X.GetShadersRepository(f),includesShadersStore:X.GetIncludesShadersStore(f),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}l.isFragment=i==="fragment",cr._ProcessIncludes(d,l,f=>d=f)}c+=d+`
`}}if(c.length>0)if(h.charAt(0)==="!"){h=h.substring(1);let u="g";if(h.charAt(0)==="!")u="",h=h.substring(1);else{const _=Gx.exec(h);_&&_.length>=2&&(u=_[1],h=h.substring(u.length+1))}u.indexOf("g")<0&&(u+="g");const d=s,f=new RegExp(h,u);let p=f.exec(d);for(;p!==null;){let _=c;for(let g=0;g<p.length;++g)_=_.replace("$"+g,p[g]);s=s.replace(p[0],_),p=f.exec(d)}}else{const u="#define "+h;s=s.replace(u,`
`+c+`
`+u)}}return s}}}cn._MaterialPluginClassToMainDefine={};cn._MaterialPluginCounter=0;Ze.OnEnginesDisposedObservable.add(()=>{Hx()});const zx=[];let Ag=null;function Hx(){zx.length=0,Q.OnEventObservable.remove(Ag),Ag=null}class sr{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,s,r=!0,n=!1,a=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=a,e.pluginManager||(e.pluginManager=new cn(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=s,this._pluginManager=e.pluginManager,r&&this._pluginManager._addPlugin(this),n&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,s){return!0}hardBindForSubMesh(e,t,i,s){}bindForSubMesh(e,t,i,s){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;const i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){Le.Clone(()=>e,this)}serialize(){return Le.Serialize(this)}parse(e,t,i){Le.Parse(()=>this,e,t,i)}}v([M()],sr.prototype,"name",void 0);v([M()],sr.prototype,"priority",void 0);v([M()],sr.prototype,"resolveIncludes",void 0);v([M()],sr.prototype,"registerForExtraEvents",void 0);class Wx extends ir{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class Vi extends sr{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new Wx,t),this._useEnergyConservation=Vi.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=Vi.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=Vi.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=Vi.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=Vi.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=Vi.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=Vi.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=Vi.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}Vi.DEFAULT_USE_ENERGY_CONSERVATION=!0;Vi.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;Vi.DEFAULT_USE_SPHERICAL_HARMONICS=!0;Vi.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;v([M(),Z("_markAllSubMeshesAsMiscDirty")],Vi.prototype,"useEnergyConservation",void 0);v([M(),Z("_markAllSubMeshesAsMiscDirty")],Vi.prototype,"useSmithVisibilityHeightCorrelated",void 0);v([M(),Z("_markAllSubMeshesAsMiscDirty")],Vi.prototype,"useSphericalHarmonics",void 0);v([M(),Z("_markAllSubMeshesAsMiscDirty")],Vi.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);class Fc{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,s,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const n=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==n.frameId&&(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone()}}}const Xx="prePassDeclaration",Yx=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;X.IncludesShadersStore[Xx]=Yx;const Kx="oitDeclaration",$x=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;
#endif
`;X.IncludesShadersStore[Kx]=$x;const jx="decalFragmentDeclaration",qx=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;X.IncludesShadersStore[jx]=qx;const Zx="pbrFragmentDeclaration",Qx=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;X.IncludesShadersStore[Zx]=Qx;const Jx="pbrUboDeclaration",eM=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;X.IncludesShadersStore[Jx]=eM;const tM="mainUVVaryingDeclaration",iM=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;X.IncludesShadersStore[tM]=iM;const sM="pbrFragmentExtraDeclaration",rM=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;X.IncludesShadersStore[sM]=rM;const nM="lightFragmentDeclaration",aM=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;X.IncludesShadersStore[nM]=aM;const oM="lightUboDeclaration",lM=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};uniform highp sampler2DArray depthSampler{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;X.IncludesShadersStore[oM]=lM;const hM="samplerFragmentAlternateDeclaration",cM=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;X.IncludesShadersStore[hM]=cM;const uM="pbrFragmentSamplersDeclaration",dM=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#endif
`;X.IncludesShadersStore[uM]=dM;const fM="fogFragmentDeclaration",_M=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;X.IncludesShadersStore[fM]=_M;const pM="importanceSampling",gM=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;X.IncludesShadersStore[pM]=gM;const mM="pbrHelperFunctions",EM=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;X.IncludesShadersStore[mM]=EM;const TM="shadowsFragmentFunctions",vM=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
#define inline
float computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);}
#define inline
float computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
#define inline
float computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
/* disable_uniformity_analysis */
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.)
);const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}
else
{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
if (numBlocker<1.0) {return 1.0;}
else
{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
#endif
`;X.IncludesShadersStore[TM]=vM;const AM="harmonicsFunctions",RM=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;X.IncludesShadersStore[AM]=RM;const bM="pbrDirectLightingSetupFunctions",SM=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightOffset=lightData.xyz-vPositionW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}`;X.IncludesShadersStore[bM]=SM;const yM="pbrDirectLightingFalloffFunctions",CM=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;X.IncludesShadersStore[yM]=CM;const xM="pbrBRDFFunctions",MM=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
`;X.IncludesShadersStore[xM]=MM;const IM="hdrFilteringFunctions",PM=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 result=vec3(0.0);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);if (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;X.IncludesShadersStore[IM]=PM;const DM="pbrDirectLightingFunctions",OM=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;X.IncludesShadersStore[DM]=OM;const NM="pbrIBLFunctions",LM=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;X.IncludesShadersStore[NM]=LM;const FM="reflectionFunction",wM=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*(view*worldPos));}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*vec4(positionW,1.));}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;X.IncludesShadersStore[FM]=wM;const BM="decalFragment",UM=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;X.IncludesShadersStore[BM]=UM;const kM="pbrBlockAlbedoOpacity",VM=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
void albedoOpacityBlock(
in vec4 vAlbedoColor,
#ifdef ALBEDO
in vec4 albedoTexture,
in vec2 albedoInfos,
#endif
#ifdef OPACITY
in vec4 opacityMap,
in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
#ifdef DECAL
in vec4 decalColor,
in vec4 vDecalInfos,
#endif
out albedoOpacityOutParams outParams
)
{vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST 
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;}
`;X.IncludesShadersStore[kM]=VM;const GM="pbrBlockReflectivity",zM=`struct reflectivityOutParams
{float microSurface;float roughness;vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
vec2 metallicRoughness;
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
#ifndef FROSTBITE_REFLECTANCE
vec3 metallicF0;
#endif
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
void reflectivityBlock(
in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
in vec3 surfaceAlbedo,
in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
in vec3 reflectivityInfos,
in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;}
`;X.IncludesShadersStore[GM]=zM;const HM="pbrBlockAmbientOcclusion",WM=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;}
`;X.IncludesShadersStore[HM]=WM;const XM="pbrBlockAlphaFresnel",YM=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
void alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface,
out alphaFresnelOutParams outParams
)
{float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;X.IncludesShadersStore[XM]=YM;const KM="pbrBlockAnisotropic",$M=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);}
#endif
`;X.IncludesShadersStore[KM]=$M;const jM="pbrBlockReflection",qM=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
void reflectionBlock(
in vec3 vPositionW,
in vec3 normalW,
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;}
#endif
`;X.IncludesShadersStore[jM]=qM;const ZM="pbrBlockSheen",QM=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 sheenMapRoughnessData,
#endif
#endif
in float roughness,
#ifdef SHEEN_TEXTURE
in vec4 sheenMapData,
in float sheenMapLevel,
#endif
in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
in vec3 baseColor,
in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
in float NdotV,
in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
in vec2 AARoughnessFactors,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
in vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
in vec2 reflectionCoords,
#endif
in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
in float eho,
#endif
#endif
out sheenOutParams outParams
)
{float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;}
#endif
`;X.IncludesShadersStore[ZM]=QM;const JM="pbrBlockClearcoat",eI=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
in vec3 vPositionW,
in vec3 geometricNormalW,
in vec3 viewDirectionW,
in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 clearCoatMapRoughnessData,
#endif
in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
in vec4 vClearCoatTintParams,
in float clearCoatColorAtDistance,
in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
in vec2 vClearCoatBumpInfos,
in vec4 clearCoatBumpMapData,
in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
in mat3 vTBN,
#else
in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
in vec3 faceNormal,
#endif
#ifdef REFLECTION
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;X.IncludesShadersStore[JM]=eI;const tI="pbrBlockIridescence",iI=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
void iridescenceBlock(
in vec4 vIridescenceParams,
in float viewAngle,
in vec3 specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
in vec2 iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
in vec2 iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
in float NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#endif
out iridescenceOutParams outParams
)
{float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE
iridescenceThicknessWeight=iridescenceMapData.g;
#endif
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;}
#endif
`;X.IncludesShadersStore[tI]=iI;const sI="pbrBlockSubSurface",rI=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
void subSurfaceBlock(
in vec3 vSubSurfaceIntensity,
in vec2 vThicknessParam,
in vec4 vTintColor,
in vec3 normalW,
in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
in vec4 thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
in vec4 refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
in vec4 translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
in samplerCube reflectionSampler,
in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
in vec3 surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
in vec3 vPositionW,
in vec3 viewDirectionW,
in mat4 view,
in vec4 vRefractionInfos,
in mat4 refractionMatrix,
in vec4 vRefractionMicrosurfaceInfos,
in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
in float roughness,
#endif
in float alphaG,
#ifdef SS_REFRACTIONMAP_3D
in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
in samplerCube refractionSamplerLow,
in samplerCube refractionSamplerHigh,
#endif
#else
in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
in sampler2D refractionSamplerLow,
in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
in vec2 vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
in vec3 refractionPosition,
in vec3 refractionSize,
#endif
#ifdef SS_DISPERSION
in float dispersion,
#endif
#endif
#ifdef SS_TRANSLUCENCY
in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if defined(SS_USE_GLTF_TEXTURES)
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)
#if defined(SS_USE_GLTF_TEXTURES)
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;X.IncludesShadersStore[sI]=rI;const nI="pbrBlockNormalGeometric",aI=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;X.IncludesShadersStore[nI]=aI;const oI="pbrBlockNormalFinal",lI=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;X.IncludesShadersStore[oI]=lI;const hI="depthPrePass",cI=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);return;
#endif
`;X.IncludesShadersStore[hI]=cI;const uI="pbrBlockLightmapInit",dI=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;X.IncludesShadersStore[uI]=dI;const fI="pbrBlockGeometryInfo",_I=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;X.IncludesShadersStore[fI]=_I;const pI="pbrBlockReflectance0",gI=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;X.IncludesShadersStore[pI]=gI;const mI="pbrBlockReflectance",EI=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;X.IncludesShadersStore[mI]=EI;const TI="pbrBlockDirectLighting",vI=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;X.IncludesShadersStore[TI]=vI;const AI="lightFragment",RI=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;X.IncludesShadersStore[AI]=RI;const bI="pbrBlockFinalLitComponents",SI=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;X.IncludesShadersStore[bI]=SI;const yI="pbrBlockFinalUnlitComponents",CI=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;X.IncludesShadersStore[yI]=CI;const xI="pbrBlockFinalColorComposition",MI=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;X.IncludesShadersStore[xI]=MI;const II="fogFragment",PI=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;X.IncludesShadersStore[II]=PI;const DI="pbrBlockImageProcessing",OI=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;X.IncludesShadersStore[DI]=OI;const NI="oitFragment",LI=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);return;}
#endif
`;X.IncludesShadersStore[NI]=LI;const FI="pbrDebug",wI=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#else
float stripeWidth=30.;float stripePos=floor((gl_FragCoord.x+gl_FragCoord.y)/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;X.IncludesShadersStore[FI]=wI;const BI="pbrPixelShader",UI=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
#ifdef DECAL
decalColor,
vDecalInfos,
#endif
albedoOpacityOut
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
vSheenInfos.y,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceBlock(
vIridescenceParams,
NdotV,
specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#endif
iridescenceOut
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#endif
alphaG,
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
vRefractionPosition,
vRefractionSize,
#endif
#ifdef SS_DISPERSION
dispersion,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); 
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;X.ShadersStore[BI]=UI;const kI="decalVertexDeclaration",VI=`#ifdef DECAL
uniform vec4 vDecalInfos;uniform mat4 decalMatrix;
#endif
`;X.IncludesShadersStore[kI]=VI;const GI="pbrVertexDeclaration",zI=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;X.IncludesShadersStore[GI]=zI;const HI="uvAttributeDeclaration",WI=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;X.IncludesShadersStore[HI]=WI;const XI="prePassVertexDeclaration",YI=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#endif
`;X.IncludesShadersStore[XI]=YI;const KI="samplerVertexDeclaration",$I=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;X.IncludesShadersStore[KI]=$I;const jI="bumpVertexDeclaration",qI=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;X.IncludesShadersStore[jI]=qI;const ZI="fogVertexDeclaration",QI=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;X.IncludesShadersStore[ZI]=QI;const JI="lightVxFragmentDeclaration",eP=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;X.IncludesShadersStore[JI]=eP;const tP="lightVxUboDeclaration",iP=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;X.IncludesShadersStore[tP]=iP;const sP="prePassVertex",rP=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;X.IncludesShadersStore[sP]=rP;const nP="uvVariableDeclaration",aP=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;X.IncludesShadersStore[nP]=aP;const oP="samplerVertexImplementation",lP=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}
#ifdef UV2
else if (v_INFONAME_==1.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}
#endif
#endif
`;X.IncludesShadersStore[oP]=lP;const hP="fogVertex",cP=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;X.IncludesShadersStore[hP]=cP;const uP="shadowsVertex",dP=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;X.IncludesShadersStore[uP]=dP;const fP="pbrVertexShader",_P=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;X.ShadersStore[fP]=_P;class pP extends ir{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Oi extends sr{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new pP,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=Oi._DefaultIndexOfRefraction,this.indexOfRefraction=Oi._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=J.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const s=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ie.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&ie.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&ie.ClearCoatBumpTextureEnabled&&!s&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&ie.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ie.ClearCoatTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&ie.ClearCoatTextureEnabled?se.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&ie.ClearCoatBumpTextureEnabled?se.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Oi._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&ie.ClearCoatTintTextureEnabled?(se.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,s){var r,n,a,l,h,c,u,d;if(!this._isEnabled)return;const f=s.materialDefines,p=this._material.isFrozen,_=this._material._disableBumpMap,g=this._material._invertNormalMapX,E=this._material._invertNormalMapY,R=f.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!p||!e.isSync){R&&ie.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&ie.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",(n=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(a=this._texture)===null||a===void 0?void 0:a.level)!==null&&l!==void 0?l:0,(c=(h=this._textureRoughness)===null||h===void 0?void 0:h.coordinatesIndex)!==null&&c!==void 0?c:0,(d=(u=this._textureRoughness)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!R&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&ie.ClearCoatTextureEnabled&&!_&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),se.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",g?1:-1,E?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",g?-1:1,E?-1:1)),this._tintTexture&&ie.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),se.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const x=1-this._indexOfRefraction,S=1+this._indexOfRefraction,b=Math.pow(-x/S,2),y=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",b,y,x,S),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&ie.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!R&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&ie.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&ie.ClearCoatBumpTextureEnabled&&!_&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&ie.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,s,r;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose(),(s=this._bumpTexture)===null||s===void 0||s.dispose(),(r=this._tintTexture)===null||r===void 0||r.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Oi._DefaultIndexOfRefraction=1.5;v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"isEnabled",void 0);v([M()],Oi.prototype,"intensity",void 0);v([M()],Oi.prototype,"roughness",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"indexOfRefraction",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"texture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"useRoughnessFromMainTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"textureRoughness",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"remapF0OnInterfaceChange",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"bumpTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"isTintEnabled",void 0);v([oi()],Oi.prototype,"tintColor",void 0);v([M()],Oi.prototype,"tintColorAtDistance",void 0);v([M()],Oi.prototype,"tintThickness",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"tintTexture",void 0);class gP extends ir{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class cs extends sr{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new gP,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=cs._DefaultMinimumThickness,this.maximumThickness=cs._DefaultMaximumThickness,this.indexOfRefraction=cs._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ie.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&ie.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=this._texture!==null&&this._texture._texture===((i=this._thicknessTexture)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ie.IridescenceTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&ie.IridescenceTextureEnabled?se.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,s){var r,n,a,l,h,c,u,d;if(!this._isEnabled)return;const f=s.materialDefines,p=this._material.isFrozen,_=f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!p||!e.isSync)&&(_&&ie.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&ie.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",(n=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(a=this._texture)===null||a===void 0?void 0:a.level)!==null&&l!==void 0?l:0,(c=(h=this._thicknessTexture)===null||h===void 0?void 0:h.coordinatesIndex)!==null&&c!==void 0?c:0,(d=(u=this._thicknessTexture)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!_&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&ie.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!_&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&ie.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._thicknessTexture)===null||i===void 0||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}cs._DefaultMinimumThickness=100;cs._DefaultMaximumThickness=400;cs._DefaultIndexOfRefraction=1.3;v([M(),Z("_markAllSubMeshesAsTexturesDirty")],cs.prototype,"isEnabled",void 0);v([M()],cs.prototype,"intensity",void 0);v([M()],cs.prototype,"minimumThickness",void 0);v([M()],cs.prototype,"maximumThickness",void 0);v([M()],cs.prototype,"indexOfRefraction",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],cs.prototype,"texture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],cs.prototype,"thicknessTexture",void 0);class mP extends ir{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class bl extends sr{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new mP,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new Ke(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&ie.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(T.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ie.AnisotropicTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&ie.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),se.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&ie.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),e.legacy===void 0&&(this.legacy=!0)}}v([M(),Z("_markAllSubMeshesAsTexturesDirty")],bl.prototype,"isEnabled",void 0);v([M()],bl.prototype,"intensity",void 0);v([Af()],bl.prototype,"direction",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],bl.prototype,"texture",void 0);v([M(),Z("_markAllSubMeshesAsMiscDirty")],bl.prototype,"legacy",void 0);class EP extends ir{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class Tr extends sr{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new EP,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=J.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ie.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&ie.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ie.SheenTextureEnabled?(se.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&ie.SheenTextureEnabled?se.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,s){var r,n,a,l,h,c,u,d;if(!this._isEnabled)return;const f=s.materialDefines,p=this._material.isFrozen,_=f.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!p||!e.isSync)&&(_&&ie.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&ie.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",(n=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(a=this._texture)===null||a===void 0?void 0:a.level)!==null&&l!==void 0?l:0,(c=(h=this._textureRoughness)===null||h===void 0?void 0:h.coordinatesIndex)!==null&&c!==void 0?c:0,(d=(u=this._textureRoughness)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!_&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&ie.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!_&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&ie.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Tr.prototype,"isEnabled",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Tr.prototype,"linkSheenWithAlbedo",void 0);v([M()],Tr.prototype,"intensity",void 0);v([oi()],Tr.prototype,"color",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],Tr.prototype,"texture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Tr.prototype,"useRoughnessFromMainTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Tr.prototype,"roughness",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],Tr.prototype,"textureRoughness",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Tr.prototype,"albedoScaling",void 0);class TP extends ir{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class qt extends sr{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new TP,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=J.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=J.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&ie.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&ie.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1;return}if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,s=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,r=(i||!this._refractionIntensityTexture)&&(s||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&ie.ThicknessTextureEnabled&&se.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&ie.RefractionIntensityTextureEnabled&&!r&&se.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&ie.TranslucencyIntensityTextureEnabled&&!r&&se.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&r,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&r,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&r,this._isRefractionEnabled&&t.texturesEnabled){const n=this._getRefractionTexture(t);n&&ie.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=n.isCube,e.SS_GAMMAREFRACTION=n.gammaSpace,e.SS_RGBDREFRACTION=n.isRGBD,e.SS_LINEARSPECULARREFRACTION=n.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&n.isCube?!n.invertZ:n.invertZ,e.SS_LODINREFRACTIONALPHA=n.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=n.isCube&&n.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;s.getRenderingMesh().getWorldMatrix().decompose(D.Vector3[0]);const r=Math.max(Math.abs(D.Vector3[0].x),Math.abs(D.Vector3[0].y),Math.abs(D.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*r,(this.maximumThickness-this.minimumThickness)*r)}bindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const r=s.materialDefines,n=this._material.isFrozen,a=this._material.realTimeFiltering,l=r.LODBASEDMICROSFURACE,h=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&ie.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),se.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&ie.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),se.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&ie.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),se.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),h&&ie.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",h.getRefractionTextureMatrix());let c=1;h.isCube||h.depth&&(c=h.depth);const u=h.getSize().width,d=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",h.level,1/d,c,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",u,h.lodGenerationScale,h.lodGenerationOffset,1/this.indexOfRefraction),a&&e.updateFloat2("vRefractionFilteringInfo",u,Te.Log2(u)),h.boundingBoxSize){const f=h;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&ie.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&ie.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&ie.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),h&&ie.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",h):(e.setTexture("refractionSampler",h._lodTextureMid||h),e.setTexture("refractionSamplerLow",h._lodTextureLow||h),e.setTexture("refractionSamplerHigh",h._lodTextureHigh||h))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){ie.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(ie.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"}]}}}v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"isRefractionEnabled",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"isTranslucencyEnabled",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"isDispersionEnabled",void 0);v([M(),Z("_markScenePrePassDirty")],qt.prototype,"isScatteringEnabled",void 0);v([M()],qt.prototype,"_scatteringDiffusionProfileIndex",void 0);v([M()],qt.prototype,"refractionIntensity",void 0);v([M()],qt.prototype,"translucencyIntensity",void 0);v([M()],qt.prototype,"useAlbedoToTintRefraction",void 0);v([M()],qt.prototype,"useAlbedoToTintTranslucency",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"thicknessTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"refractionTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"indexOfRefraction",void 0);v([M()],qt.prototype,"_volumeIndexOfRefraction",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"volumeIndexOfRefraction",null);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"invertRefractionY",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"linkRefractionWithTransparency",void 0);v([M()],qt.prototype,"minimumThickness",void 0);v([M()],qt.prototype,"maximumThickness",void 0);v([M()],qt.prototype,"useThicknessAsDepth",void 0);v([oi()],qt.prototype,"tintColor",void 0);v([M()],qt.prototype,"tintColorAtDistance",void 0);v([M()],qt.prototype,"dispersion",void 0);v([oi()],qt.prototype,"diffusionDistance",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"useMaskFromThicknessTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"refractionIntensityTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"translucencyIntensityTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],qt.prototype,"useGltfStyleTextures",void 0);class vP extends ir{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class On extends sr{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new vP,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=Q.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&ie.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&ie.DetailTextureEnabled&&this._isEnabled?(se.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&ie.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),se.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&ie.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}v([rt("detailTexture"),Z("_markAllSubMeshesAsTexturesDirty")],On.prototype,"texture",void 0);v([M()],On.prototype,"diffuseBlendLevel",void 0);v([M()],On.prototype,"roughnessBlendLevel",void 0);v([M()],On.prototype,"bumpLevel",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],On.prototype,"normalBlendMethod",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],On.prototype,"isEnabled",void 0);const Ua={effect:null,subMesh:null};class Rg extends ir{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class Pt extends Ph{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new ut(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=Pt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=J.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new J(0,0,0),this._albedoColor=new J(1,1,1),this._reflectivityColor=new J(1,1,1),this._reflectionColor=new J(1,1,1),this._emissiveColor=new J(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=Pt.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new li(16),this._globalAmbientColor=new J(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Vi(this),this.clearCoat=new Oi(this),this.iridescence=new cs(this),this.anisotropy=new bl(this),this.sheen=new Tr(this),this.subSurface=new qt(this),this.detailMap=new On(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),ie.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Zm(this.getScene()),this.prePassConfiguration=new Fc}get hasRenderTargetTextures(){return ie.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){var e;return this._transparencyMode===Pt.PBRMATERIAL_OPAQUE||this._transparencyMode===Pt.PBRMATERIAL_ALPHATEST||((e=this.subSurface)===null||e===void 0?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._forceAlphaTest?!0:!((e=this.subSurface)===null||e===void 0)&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Pt.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==Pt.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){var s;if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Di.GetDefineNames,this._eventInfo),t.materialDefines=new Rg(this._eventInfo.defineNames));const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=this.getScene(),a=n.getEngine();if(r._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,n.texturesEnabled)){if(this._albedoTexture&&ie.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&ie.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&ie.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const d=this._getReflectionTexture();if(d&&ie.ReflectionTextureEnabled){if(!d.isReadyOrNotBlocking())return!1;if(d.irradianceTexture){if(!d.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!d.sphericalPolynomial&&(!((s=d.getInternalTexture())===null||s===void 0)&&s._sphericalPolynomialPromise))return!1}if(this._lightmapTexture&&ie.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&ie.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(ie.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(a.getCaps().standardDerivatives&&this._bumpTexture&&ie.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&ie.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!a.getCaps().standardDerivatives&&!e.isVerticesDataPresent(T.NormalKind)&&(e.createNormals(!0),q.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const l=t.effect,h=r._areLightsDisposed;let c=this._prepareEffect(e,r,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),u=!1;if(c)if(this._onEffectCreatedObservable&&(Ua.effect=c,Ua.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ua)),this.allowShaderHotSwapping&&l&&!c.isReady()){if(c=l,r.markAsUnprocessed(),u=this.isFrozen,h)return r._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(c,r,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(r._renderId=n.getRenderId(),t.effect._wasPreviouslyReady=!u,t.effect._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i=null,s=null,r=null,n=null,a){if(this._prepareDefines(e,t,r,n,a),!t.isDirty)return null;t.markAsProcessed();const h=this.getScene().getEngine(),c=new Ih;let u=0;t.USESPHERICALINVERTEX&&c.addFallback(u++,"USESPHERICALINVERTEX"),t.FOG&&c.addFallback(u,"FOG"),t.SPECULARAA&&c.addFallback(u,"SPECULARAA"),t.POINTSIZE&&c.addFallback(u,"POINTSIZE"),t.LOGARITHMICDEPTH&&c.addFallback(u,"LOGARITHMICDEPTH"),t.PARALLAX&&c.addFallback(u,"PARALLAX"),t.PARALLAX_RHS&&c.addFallback(u,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&c.addFallback(u++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&c.addFallback(u++,"ENVIRONMENTBRDF"),t.TANGENT&&c.addFallback(u++,"TANGENT"),t.BUMP&&c.addFallback(u++,"BUMP"),u=se.HandleFallbacksForShadows(t,c,this._maxSimultaneousLights,u++),t.SPECULARTERM&&c.addFallback(u++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&c.addFallback(u++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&c.addFallback(u++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&c.addFallback(u++,"LIGHTMAP"),t.NORMAL&&c.addFallback(u++,"NORMAL"),t.AMBIENT&&c.addFallback(u++,"AMBIENT"),t.EMISSIVE&&c.addFallback(u++,"EMISSIVE"),t.VERTEXCOLOR&&c.addFallback(u++,"VERTEXCOLOR"),t.MORPHTARGETS&&c.addFallback(u++,"MORPHTARGETS"),t.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");const d=[T.PositionKind];t.NORMAL&&d.push(T.NormalKind),t.TANGENT&&d.push(T.TangentKind);for(let b=1;b<=6;++b)t["UV"+b]&&d.push(`uv${b===1?"":b}`);t.VERTEXCOLOR&&d.push(T.ColorKind),se.PrepareAttributesForBones(d,e,t,c),se.PrepareAttributesForInstances(d,t),se.PrepareAttributesForMorphTargets(d,e,t),se.PrepareAttributesForBakedVertexAnimation(d,e,t);let f="pbr";const p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],_=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],g=["Material","Scene","Mesh"],E={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=u,this._eventInfo.defines=t,this._eventInfo.uniforms=p,this._eventInfo.attributes=d,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=g,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=E,this._callbackPluginEventGeneric(Di.PrepareEffect,this._eventInfo),Fc.AddUniforms(p),In(p),st&&(st.PrepareUniforms(p,t),st.PrepareSamplers(_,t)),se.PrepareUniformsAndSamplersList({uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const R={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,p,g,_,t,d,R));const x=t.toString(),S=h.createEffect(f,{attributes:d,uniformsNames:p,uniformBuffersNames:g,samplers:_,defines:x,fallbacks:c,onCompiled:i,onError:s,indexParameters:E,processFinalCode:R.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},h);return this._eventInfo.customCode=void 0,S}_prepareDefines(e,t,i=null,s=null,r=!1){var n;const a=this.getScene(),l=a.getEngine();se.PrepareDefinesForLights(a,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,se.PrepareDefinesForMultiview(a,t);const h=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(se.PrepareDefinesForPrePass(a,t,this.canRenderToMRT&&!h),se.PrepareDefinesForOIT(a,t,h),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let c=1;c<=6;++c)t["MAINUV"+c]=!1;if(a.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&ie.DiffuseTextureEnabled?(se.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&ie.AmbientTextureEnabled?(se.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&ie.OpacityTextureEnabled?(se.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const c=this._getReflectionTexture();if(c&&ie.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=c.gammaSpace,t.RGBDREFLECTION=c.isRGBD,t.LODINREFLECTIONALPHA=c.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=c.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=c.coordinatesMode===V.INVCUBIC_MODE,t.REFLECTIONMAP_3D=c.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!c.invertZ:c.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,c.coordinatesMode){case V.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case V.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case V.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case V.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case V.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case V.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case V.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case V.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case V.CUBIC_MODE:case V.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!c.boundingBoxSize;break}c.coordinatesMode!==V.SKYBOX_MODE&&(c.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):c.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||l.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&ie.LightmapTextureEnabled?(se.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&ie.EmissiveTextureEnabled?(se.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,ie.SpecularTextureEnabled){if(this._metallicTexture?(se.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(se.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const u=this._metallicReflectanceTexture!==null&&this._metallicReflectanceTexture._texture===((n=this._reflectanceTexture)===null||n===void 0?void 0:n._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!u,this._metallicReflectanceTexture?(se.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!u&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(se.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?se.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;l.getCaps().standardDerivatives&&this._bumpTexture&&ie.BumpTextureEnabled&&!this._disableBumpMap?(se.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&ie.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=a.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&ie.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===Pt.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===Pt.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(se.PrepareDefinesForMisc(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(T.NormalKind),t.DEBUGMODE=this._debugMode),se.PrepareDefinesForFrameBoundValues(a,l,this,t,!!i,s,r),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),se.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==Pt.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const s=Object.assign({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(Di.GetDefineNames,this._eventInfo);const r=new Rg(this._eventInfo.defineNames),n=this._prepareEffect(e,r,void 0,void 0,s.useInstances,s.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Ua.effect=n,Ua.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Ua)),n.isReady()?t&&t(this):n.onCompileObservable.add(()=>{t&&t(this)})}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s,r,n,a;const l=this.getScene(),h=i.materialDefines;if(!h)return;const c=i.effect;if(!c)return;this._activeEffect=c,t.getMeshUniformBuffer().bindToEffect(c,"Mesh"),t.transferToEffect(e);const u=l.getEngine();this._uniformBuffer.bindToEffect(c,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),h.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=c._forceRebindOnNextCall||this._mustRebind(l,c,t.visibility);se.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let f=null;const p=this._uniformBuffer;if(d){if(this.bindViewProjection(c),f=this._getReflectionTexture(),!p.useUbo||!this.isFrozen||!p.isSync||c._forceRebindOnNextCall){if(l.texturesEnabled){if(this._albedoTexture&&ie.DiffuseTextureEnabled&&(p.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),se.BindTextureMatrix(this._albedoTexture,p,"albedo")),this._ambientTexture&&ie.AmbientTextureEnabled&&(p.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),se.BindTextureMatrix(this._ambientTexture,p,"ambient")),this._opacityTexture&&ie.OpacityTextureEnabled&&(p.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),se.BindTextureMatrix(this._opacityTexture,p,"opacity")),f&&ie.ReflectionTextureEnabled){if(p.updateMatrix("reflectionMatrix",f.getReflectionTextureMatrix()),p.updateFloat2("vReflectionInfos",f.level,0),f.boundingBoxSize){const _=f;p.updateVector3("vReflectionPosition",_.boundingBoxPosition),p.updateVector3("vReflectionSize",_.boundingBoxSize)}if(this.realTimeFiltering){const _=f.getSize().width;p.updateFloat2("vReflectionFilteringInfo",_,Te.Log2(_))}if(!h.USEIRRADIANCEMAP){const _=f.sphericalPolynomial;if(h.USESPHERICALFROMREFLECTIONMAP&&_)if(h.SPHERICAL_HARMONICS){const g=_.preScaledHarmonics;p.updateVector3("vSphericalL00",g.l00),p.updateVector3("vSphericalL1_1",g.l1_1),p.updateVector3("vSphericalL10",g.l10),p.updateVector3("vSphericalL11",g.l11),p.updateVector3("vSphericalL2_2",g.l2_2),p.updateVector3("vSphericalL2_1",g.l2_1),p.updateVector3("vSphericalL20",g.l20),p.updateVector3("vSphericalL21",g.l21),p.updateVector3("vSphericalL22",g.l22)}else p.updateFloat3("vSphericalX",_.x.x,_.x.y,_.x.z),p.updateFloat3("vSphericalY",_.y.x,_.y.y,_.y.z),p.updateFloat3("vSphericalZ",_.z.x,_.z.y,_.z.z),p.updateFloat3("vSphericalXX_ZZ",_.xx.x-_.zz.x,_.xx.y-_.zz.y,_.xx.z-_.zz.z),p.updateFloat3("vSphericalYY_ZZ",_.yy.x-_.zz.x,_.yy.y-_.zz.y,_.yy.z-_.zz.z),p.updateFloat3("vSphericalZZ",_.zz.x,_.zz.y,_.zz.z),p.updateFloat3("vSphericalXY",_.xy.x,_.xy.y,_.xy.z),p.updateFloat3("vSphericalYZ",_.yz.x,_.yz.y,_.yz.z),p.updateFloat3("vSphericalZX",_.zx.x,_.zx.y,_.zx.z)}p.updateFloat3("vReflectionMicrosurfaceInfos",f.getSize().width,f.lodGenerationScale,f.lodGenerationOffset)}this._emissiveTexture&&ie.EmissiveTextureEnabled&&(p.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),se.BindTextureMatrix(this._emissiveTexture,p,"emissive")),this._lightmapTexture&&ie.LightmapTextureEnabled&&(p.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),se.BindTextureMatrix(this._lightmapTexture,p,"lightmap")),ie.SpecularTextureEnabled&&(this._metallicTexture?(p.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),se.BindTextureMatrix(this._metallicTexture,p,"reflectivity")):this._reflectivityTexture&&(p.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),se.BindTextureMatrix(this._reflectivityTexture,p,"reflectivity")),this._metallicReflectanceTexture&&(p.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),se.BindTextureMatrix(this._metallicReflectanceTexture,p,"metallicReflectance")),this._reflectanceTexture&&h.REFLECTANCE&&(p.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),se.BindTextureMatrix(this._reflectanceTexture,p,"reflectance")),this._microSurfaceTexture&&(p.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),se.BindTextureMatrix(this._microSurfaceTexture,p,"microSurfaceSampler"))),this._bumpTexture&&u.getCaps().standardDerivatives&&ie.BumpTextureEnabled&&!this._disableBumpMap&&(p.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),se.BindTextureMatrix(this._bumpTexture,p,"bump"),l._mirroredCameraPosition?p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&p.updateFloat("pointSize",this.pointSize),h.METALLICWORKFLOW){Zs.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,Zs.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,p.updateColor4("vReflectivityColor",Zs.Color3[0],1);const _=(r=(s=this.subSurface)===null||s===void 0?void 0:s._indexOfRefraction)!==null&&r!==void 0?r:1.5,g=1,E=Math.pow((_-g)/(_+g),2);this._metallicReflectanceColor.scaleToRef(E*this._metallicF0Factor,Zs.Color3[0]);const R=this._metallicF0Factor;p.updateColor4("vMetallicReflectanceFactors",Zs.Color3[0],R)}else p.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);p.updateColor3("vEmissiveColor",ie.EmissiveTextureEnabled?this._emissiveColor:J.BlackReadOnly),p.updateColor3("vReflectionColor",this._reflectionColor),!h.SS_REFRACTION&&(!((n=this.subSurface)===null||n===void 0)&&n._linkRefractionWithTransparency)?p.updateColor4("vAlbedoColor",this._albedoColor,1):p.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,p.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),p.updateColor3("vAmbientColor",this._globalAmbientColor),p.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}l.texturesEnabled&&(this._albedoTexture&&ie.DiffuseTextureEnabled&&p.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&ie.AmbientTextureEnabled&&p.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&ie.OpacityTextureEnabled&&p.setTexture("opacitySampler",this._opacityTexture),f&&ie.ReflectionTextureEnabled&&(h.LODBASEDMICROSFURACE?p.setTexture("reflectionSampler",f):(p.setTexture("reflectionSampler",f._lodTextureMid||f),p.setTexture("reflectionSamplerLow",f._lodTextureLow||f),p.setTexture("reflectionSamplerHigh",f._lodTextureHigh||f)),h.USEIRRADIANCEMAP&&p.setTexture("irradianceSampler",f.irradianceTexture)),h.ENVIRONMENTBRDF&&p.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&ie.EmissiveTextureEnabled&&p.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&ie.LightmapTextureEnabled&&p.setTexture("lightmapSampler",this._lightmapTexture),ie.SpecularTextureEnabled&&(this._metallicTexture?p.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&p.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&p.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&h.REFLECTANCE&&p.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&p.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&u.getCaps().standardDerivatives&&ie.BumpTextureEnabled&&!this._disableBumpMap&&p.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(c),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Pn(this._activeEffect,this,l),this.bindEyePosition(c)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(d||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&se.BindLights(l,t,this._activeEffect,h,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==Ve.FOGMODE_NONE||f||this.subSurface.refractionTexture||t.receiveShadows||h.PREPASS)&&this.bindView(c),se.BindFogParameters(l,t,this._activeEffect,!0),h.NUM_MORPH_INFLUENCERS&&se.BindMorphTargetParameters(t,this._activeEffect),h.BAKED_VERTEX_ANIMATION_TEXTURE&&((a=t.bakedVertexAnimationManager)===null||a===void 0||a.bind(c,h.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),se.BindLogDepth(h,this._activeEffect,l)),this._afterBind(t,this._activeEffect),p.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var e;if(!(!((e=this.subSurface)===null||e===void 0)&&e.isScatteringEnabled))return!1;const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}dispose(e,t){var i,s,r,n,a,l,h,c,u,d,f,p;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)===null||i===void 0||i.dispose(),(s=this._ambientTexture)===null||s===void 0||s.dispose(),(r=this._opacityTexture)===null||r===void 0||r.dispose(),(n=this._reflectionTexture)===null||n===void 0||n.dispose(),(a=this._emissiveTexture)===null||a===void 0||a.dispose(),(l=this._metallicTexture)===null||l===void 0||l.dispose(),(h=this._reflectivityTexture)===null||h===void 0||h.dispose(),(c=this._bumpTexture)===null||c===void 0||c.dispose(),(u=this._lightmapTexture)===null||u===void 0||u.dispose(),(d=this._metallicReflectanceTexture)===null||d===void 0||d.dispose(),(f=this._reflectanceTexture)===null||f===void 0||f.dispose(),(p=this._microSurfaceTexture)===null||p===void 0||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}Pt.PBRMATERIAL_OPAQUE=Q.MATERIAL_OPAQUE;Pt.PBRMATERIAL_ALPHATEST=Q.MATERIAL_ALPHATEST;Pt.PBRMATERIAL_ALPHABLEND=Q.MATERIAL_ALPHABLEND;Pt.PBRMATERIAL_ALPHATESTANDBLEND=Q.MATERIAL_ALPHATESTANDBLEND;Pt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;Pt.LIGHTFALLOFF_PHYSICAL=0;Pt.LIGHTFALLOFF_GLTF=1;Pt.LIGHTFALLOFF_STANDARD=2;v([vm()],Pt.prototype,"_imageProcessingConfiguration",void 0);v([Z("_markAllSubMeshesAsMiscDirty")],Pt.prototype,"debugMode",void 0);class me extends Pt{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===Pt.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Pt.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=Pt.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Pt.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Pt.LIGHTFALLOFF_GLTF:this._lightFalloff=Pt.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=me.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=J.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new J(0,0,0),this.albedoColor=new J(1,1,1),this.reflectivityColor=new J(1,1,1),this.reflectionColor=new J(1,1,1),this.emissiveColor=new J(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=Zm(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){const s=Le.Clone(()=>new me(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return s.id=e,s.name=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){const s=Le.Parse(()=>new me(e.name,t),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),Q._parsePlugins(e,s,t,i),e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}me.PBRMATERIAL_OPAQUE=Pt.PBRMATERIAL_OPAQUE;me.PBRMATERIAL_ALPHATEST=Pt.PBRMATERIAL_ALPHATEST;me.PBRMATERIAL_ALPHABLEND=Pt.PBRMATERIAL_ALPHABLEND;me.PBRMATERIAL_ALPHATESTANDBLEND=Pt.PBRMATERIAL_ALPHATESTANDBLEND;me.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Pt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"directIntensity",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"emissiveIntensity",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"environmentIntensity",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"specularIntensity",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"disableBumpMap",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"albedoTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"ambientTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"ambientTextureStrength",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesAndMiscDirty")],me.prototype,"opacityTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"reflectionTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"emissiveTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"reflectivityTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"metallicTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"metallic",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"roughness",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"metallicF0Factor",void 0);v([oi(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"metallicReflectanceColor",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"metallicReflectanceTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"reflectanceTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"microSurfaceTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"bumpTexture",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty",null)],me.prototype,"lightmapTexture",void 0);v([oi("ambient"),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"ambientColor",void 0);v([oi("albedo"),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"albedoColor",void 0);v([oi("reflectivity"),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"reflectivityColor",void 0);v([oi("reflection"),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"reflectionColor",void 0);v([oi("emissive"),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"emissiveColor",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"microSurface",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useLightmapAsShadowmap",void 0);v([M(),Z("_markAllSubMeshesAsTexturesAndMiscDirty")],me.prototype,"useAlphaFromAlbedoTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesAndMiscDirty")],me.prototype,"forceAlphaTest",void 0);v([M(),Z("_markAllSubMeshesAsTexturesAndMiscDirty")],me.prototype,"alphaCutOff",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useSpecularOverAlpha",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useRoughnessFromMetallicTextureGreen",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useMetallnessFromMetallicTextureBlue",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useAmbientInGrayScale",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);v([M()],me.prototype,"usePhysicalLightFalloff",null);v([M()],me.prototype,"useGLTFLightFalloff",null);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useRadianceOverAlpha",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useObjectSpaceNormalMap",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useParallax",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useParallaxOcclusion",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"parallaxScaleBias",void 0);v([M(),Z("_markAllSubMeshesAsLightsDirty")],me.prototype,"disableLighting",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"forceIrradianceInFragment",void 0);v([M(),Z("_markAllSubMeshesAsLightsDirty")],me.prototype,"maxSimultaneousLights",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"invertNormalMapX",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"invertNormalMapY",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"twoSidedLighting",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useAlphaFresnel",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useLinearAlphaFresnel",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"environmentBRDFTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"forceNormalForward",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"enableSpecularAntiAliasing",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useHorizonOcclusion",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],me.prototype,"useRadianceOcclusion",void 0);v([M(),Z("_markAllSubMeshesAsMiscDirty")],me.prototype,"unlit",void 0);v([M(),Z("_markAllSubMeshesAsMiscDirty")],me.prototype,"applyDecalMapAfterDetailMap",void 0);Re("BABYLON.PBRMaterial",me);class AP extends da{}class RP{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class Qm extends da{constructor(e){super(),this._wasAddedToScene=!1,e=e||Ze.LastCreatedScene,e&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}_topologicalSort(e){const t=new Map;for(const a of e)t.set(a.uniqueId,a);const i={dependsOn:new Map,dependedBy:new Map};for(const a of e){const l=a.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(const a of e){const l=a.uniqueId,h=i.dependsOn.get(l);if(a instanceof Zc){const u=a.sourceMesh;t.has(u.uniqueId)&&(h.add(u.uniqueId),i.dependedBy.get(u.uniqueId).add(l))}const c=i.dependedBy.get(l);for(const u of a.getDescendants()){const d=u.uniqueId;t.has(d)&&(c.add(d),i.dependsOn.get(d).add(l))}}const s=[],r=[];for(const a of e){const l=a.uniqueId;i.dependsOn.get(l).size===0&&(r.push(a),t.delete(l))}const n=r;for(;n.length>0;){const a=n.shift();s.push(a);const l=i.dependedBy.get(a.uniqueId);for(const h of Array.from(l.values())){const c=i.dependsOn.get(h);c.delete(a.uniqueId),c.size===0&&t.get(h)&&(n.push(t.get(h)),t.delete(h))}}return t.size>0&&(q.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(a=>q.Error(a.name))),s}_addNodeAndDescendantsToList(e,t,i,s){if(!(!i||s&&!s(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(const r of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,r,s)}}_isNodeInContainer(e){return e instanceof re&&this.meshes.indexOf(e)!==-1||e instanceof we&&this.transformNodes.indexOf(e)!==-1||e instanceof qe&&this.lights.indexOf(e)!==-1||e instanceof De&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(const e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return q.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return q.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return q.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(const e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return q.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||Y.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");const s={},r={},n=new RP,a=[],l=[],h=Object.assign({doNotInstantiate:!0},i),c=(_,g)=>{if(s[_.uniqueId]=g.uniqueId,r[g.uniqueId]=g,e&&(g.name=e(_.name)),g instanceof re){const E=g;if(E.morphTargetManager){const R=_.morphTargetManager;E.morphTargetManager=R.clone();for(let x=0;x<R.numTargets;x++){const S=R.getTarget(x),b=E.morphTargetManager.getTarget(x);s[S.uniqueId]=b.uniqueId,r[b.uniqueId]=b}}}},u=[],d=new Set;for(const _ of this.transformNodes)_.parent===null&&this._addNodeAndDescendantsToList(u,d,_,h.predicate);for(const _ of this.meshes)_.parent===null&&this._addNodeAndDescendantsToList(u,d,_,h.predicate);const f=this._topologicalSort(u),p=(_,g)=>{if(c(_,g),_.parent){const E=s[_.parent.uniqueId],R=r[E];R?g.parent=R:g.parent=_.parent}if(g.position&&_.position&&g.position.copyFrom(_.position),g.rotationQuaternion&&_.rotationQuaternion&&g.rotationQuaternion.copyFrom(_.rotationQuaternion),g.rotation&&_.rotation&&g.rotation.copyFrom(_.rotation),g.scaling&&_.scaling&&g.scaling.copyFrom(_.scaling),g.material){const E=g;if(E.material)if(t){const R=_.material;if(l.indexOf(R)===-1){let x=R.clone(e?e(R.name):"Clone of "+R.name);if(l.push(R),s[R.uniqueId]=x.uniqueId,r[x.uniqueId]=x,R.getClassName()==="MultiMaterial"){const S=R;for(const b of S.subMaterials)b&&(x=b.clone(e?e(b.name):"Clone of "+b.name),l.push(b),s[b.uniqueId]=x.uniqueId,r[x.uniqueId]=x);S.subMaterials=S.subMaterials.map(b=>b&&r[s[b.uniqueId]])}}E.getClassName()!=="InstancedMesh"&&(E.material=r[s[R.uniqueId]])}else E.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(E.material)===-1&&this.scene.addMultiMaterial(E.material):this.scene.materials.indexOf(E.material)===-1&&this.scene.addMaterial(E.material)}g.parent===null&&n.rootNodes.push(g)};return f.forEach(_=>{if(_.getClassName()==="InstancedMesh"){const g=_,E=g.sourceMesh,R=s[E.uniqueId],S=(typeof R=="number"?r[R]:E).createInstance(g.name);p(g,S)}else{let g=!0;_.getClassName()==="TransformNode"||_.getClassName()==="Node"||_.skeleton||!_.getTotalVertices||_.getTotalVertices()===0?g=!1:h.doNotInstantiate&&(typeof h.doNotInstantiate=="function"?g=!h.doNotInstantiate(_):g=!h.doNotInstantiate);const E=g?_.createInstance(`instance of ${_.name}`):_.clone(`Clone of ${_.name}`,null,!0);if(!E)throw new Error(`Could not clone or instantiate node on Asset Container ${_.name}`);p(_,E)}}),this.skeletons.forEach(_=>{if(h.predicate&&!h.predicate(_))return;const g=_.clone(e?e(_.name):"Clone of "+_.name);for(const E of this.meshes)if(E.skeleton===_&&!E.isAnInstance){const R=r[s[E.uniqueId]];if(!R||R.isAnInstance||(R.skeleton=g,a.indexOf(g)!==-1))continue;a.push(g);for(const x of g.bones)x._linkedTransformNode&&(x._linkedTransformNode=r[s[x._linkedTransformNode.uniqueId]])}n.skeletons.push(g)}),this.animationGroups.forEach(_=>{if(h.predicate&&!h.predicate(_))return;const g=_.clone(e?e(_.name):"Clone of "+_.name,E=>r[s[E.uniqueId]]||E);n.animationGroups.push(g)}),n}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||Y.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){const t=[];this.cameras.forEach(i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))}),this.lights.forEach(i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))}),this.meshes.forEach(i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))}),this.skeletons.forEach(i=>{e&&!e(i)||this.scene.addSkeleton(i)}),this.animations.forEach(i=>{e&&!e(i)||this.scene.addAnimation(i)}),this.animationGroups.forEach(i=>{e&&!e(i)||this.scene.addAnimationGroup(i)}),this.multiMaterials.forEach(i=>{e&&!e(i)||this.scene.addMultiMaterial(i)}),this.materials.forEach(i=>{e&&!e(i)||this.scene.addMaterial(i)}),this.morphTargetManagers.forEach(i=>{e&&!e(i)||this.scene.addMorphTargetManager(i)}),this.geometries.forEach(i=>{e&&!e(i)||this.scene.addGeometry(i)}),this.transformNodes.forEach(i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))}),this.actionManagers.forEach(i=>{e&&!e(i)||this.scene.addActionManager(i)}),this.textures.forEach(i=>{e&&!e(i)||this.scene.addTexture(i)}),this.reflectionProbes.forEach(i=>{e&&!e(i)||this.scene.addReflectionProbe(i)});for(const i of t)i.parent&&this.scene.getNodes().indexOf(i.parent)===-1&&(i.setParent?i.setParent(null):i.parent=null)}removeAllFromScene(){this._isValidHierarchy()||Y.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t,!0)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(const s of e){let r=!0;if(i){for(const n of i)if(s===n){r=!1;break}}r&&(t.push(s),s._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new AP);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new re("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=Ze.LastCreatedScene,t,i=null){if(!e)return q.Error("No scene available to merge animations to"),[];const s=i||(a=>{let l=null;const h=a.animations.length?a.animations[0].targetProperty:"",c=a.name.split(".").join("").split("_primitive")[0];switch(h){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(a.name)||e.getTransformNodeByName(c);break;case"influence":l=e.getMorphTargetByName(a.name)||e.getMorphTargetByName(c);break;default:l=e.getNodeByName(a.name)||e.getNodeByName(c)}return l});this.getNodes().forEach(a=>{const l=s(a);if(l!==null){for(const h of a.animations){const c=l.animations.filter(u=>u.targetProperty===h.targetProperty);for(const u of c){const d=l.animations.indexOf(u,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(a.animations)}});const n=[];return this.animationGroups.slice().forEach(a=>{n.push(a.clone(a.name,s)),a.animatables.forEach(l=>{l.stop()})}),t.forEach(a=>{const l=s(a.target);l&&(e.beginAnimation(l,a.fromFrame,a.toFrame,a.loopAnimation,a.speedRatio,a.onAnimationEnd?a.onAnimationEnd:void 0,void 0,!0,void 0,a.onAnimationLoop?a.onAnimationLoop:void 0),e.stopAnimation(a.target))}),n}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.transformNodes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.lights.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.cameras.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)})}addAllAssetsToContainer(e){if(!e)return;const t=[],i=new Set;for(t.push(e);t.length>0;){const s=t.pop();if(s instanceof re?(s.geometry&&this.geometries.indexOf(s.geometry)===-1&&this.geometries.push(s.geometry),this.meshes.push(s)):s instanceof we?this.transformNodes.push(s):s instanceof qe?this.lights.push(s):s instanceof De&&this.cameras.push(s),s instanceof pi){if(s.material&&this.materials.indexOf(s.material)===-1){this.materials.push(s.material);for(const r of s.material.getActiveTextures())this.textures.indexOf(r)===-1&&this.textures.push(r)}s.skeleton&&this.skeletons.indexOf(s.skeleton)===-1&&this.skeletons.push(s.skeleton),s.morphTargetManager&&this.morphTargetManagers.indexOf(s.morphTargetManager)===-1&&this.morphTargetManagers.push(s.morphTargetManager)}for(const r of s.getChildren())i.has(r)||t.push(r);i.add(s)}this.populateRootNodes()}}class yc{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return _0(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}function Md(o,e,t,i){const s={externalResourceFunction:i};return t&&(s.uri=e==="file:"?t:e+t),ArrayBuffer.isView(o)?GLTFValidator.validateBytes(o,s):GLTFValidator.validateString(o,s)}function bP(){const o=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{Md(t.data,t.rootUrl,t.fileName,i=>new Promise((s,r)=>{const n=o.length;o.push({resolve:s,reject:r}),postMessage({id:"getExternalResource",index:n,uri:i})})).then(i=>{postMessage({id:"validate.resolve",value:i})},i=>{postMessage({id:"validate.reject",reason:i})});break}case"getExternalResource.resolve":{o[t.index].resolve(t.value);break}case"getExternalResource.reject":{o[t.index].reject(t.reason);break}}}}class Jm{static ValidateAsync(e,t,i,s){return typeof Worker=="function"?new Promise((r,n)=>{const a=`${Md}(${bP})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),h=new Worker(l),c=d=>{h.removeEventListener("error",c),h.removeEventListener("message",u),n(d)},u=d=>{const f=d.data;switch(f.id){case"getExternalResource":{s(f.uri).then(p=>{h.postMessage({id:"getExternalResource.resolve",index:f.index,value:p},[p])},p=>{h.postMessage({id:"getExternalResource.reject",index:f.index,reason:p})});break}case"validate.resolve":{h.removeEventListener("error",c),h.removeEventListener("message",u),r(f.value),h.terminate();break}case"validate.reject":h.removeEventListener("error",c),h.removeEventListener("message",u),n(f.reason),h.terminate()}};if(h.addEventListener("error",c),h.addEventListener("message",u),h.postMessage({id:"init",url:Y.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const d=e.slice();h.postMessage({id:"validate",data:d,rootUrl:t,fileName:i},[d.buffer])}else h.postMessage({id:"validate",data:e,rootUrl:t,fileName:i})}):(this._LoadScriptPromise||(this._LoadScriptPromise=Y.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>Md(e,t,i,s)))}}Jm.Configuration={url:`${Y._DefaultCdnUrl}/gltf_validator.js`};function bg(o,e,t){try{return Promise.resolve(new Uint8Array(o,e,t))}catch(i){return Promise.reject(i)}}function SP(o,e,t){try{if(e<0||e>=o.byteLength)throw new RangeError("Offset is out of range.");if(e+t>o.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(o.buffer,o.byteOffset+e,t))}catch(i){return Promise.reject(i)}}var mh;(function(o){o[o.AUTO=0]="AUTO",o[o.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(mh||(mh={}));var ia;(function(o){o[o.NONE=0]="NONE",o[o.FIRST=1]="FIRST",o[o.ALL=2]="ALL"})(ia||(ia={}));var Es;(function(o){o[o.LOADING=0]="LOADING",o[o.READY=1]="READY",o[o.COMPLETE=2]="COMPLETE"})(Es||(Es={}));class Kt{constructor(){this.onParsedObservable=new j,this.coordinateSystemMode=mh.AUTO,this.animationStartMode=ia.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new j,this.onSkinLoadedObservable=new j,this.onTextureLoadedObservable=new j,this.onMaterialLoadedObservable=new j,this.onCameraLoadedObservable=new j,this.onCompleteObservable=new j,this.onErrorObservable=new j,this.onDisposeObservable=new j,this.onExtensionLoadedObservable=new j,this.validate=!1,this.onValidatedObservable=new j,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new j,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,i,s,r,n,a,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,i,s,a,l),null;this._progressCallback=r;const h=t.name||Y.GetFilename(t);if(n){if(this.useRangeRequests){this.validate&&q.Warn("glTF validation is not supported when range requests are enabled");const c={abort:()=>{},onCompleteObservable:new j},u={readAsync:(d,f)=>new Promise((p,_)=>{this._loadFile(e,t,g=>{p(new Uint8Array(g))},!0,g=>{_(g)},g=>{g.setRequestHeader("Range",`bytes=${d}-${d+f-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new yc(u)).then(d=>{c.onCompleteObservable.notifyObservers(c),s(d)},a?d=>a(void 0,d):void 0),c}return this._loadFile(e,t,c=>{this._validate(e,new Uint8Array(c,0,c.byteLength),i,h),this._unpackBinaryAsync(new yc({readAsync:(u,d)=>bg(c,u,d),byteLength:c.byteLength})).then(u=>{s(u)},a?u=>a(void 0,u):void 0)},!0,a)}else return this._loadFile(e,t,c=>{this._validate(e,c,i,h),s({json:this._parseJson(c)})},!1,a)}_loadBinary(e,t,i,s,r,n){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i,n),this._unpackBinaryAsync(new yc({readAsync:(a,l)=>SP(t,a,l),byteLength:t.byteLength})).then(a=>{s(a)},r?a=>r(void 0,a):void 0)}importMeshAsync(e,t,i,s,r,n){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${n||""}`),this._loader=this._getLoader(i),this._loader.importMeshAsync(e,t,null,i,s,r,n)))}loadAsync(e,t,i,s,r){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,i,s,r)))}loadAssetContainerAsync(e,t,i,s,r){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t);const n=new Qm(e),a=[];this.onMaterialLoadedObservable.add(u=>{a.push(u)});const l=[];this.onTextureLoadedObservable.add(u=>{l.push(u)});const h=[];this.onCameraLoadedObservable.add(u=>{h.push(u)});const c=[];return this.onMeshLoadedObservable.add(u=>{u.morphTargetManager&&c.push(u.morphTargetManager)}),this._loader.importMeshAsync(null,e,n,t,i,s,r).then(u=>(Array.prototype.push.apply(n.geometries,u.geometries),Array.prototype.push.apply(n.meshes,u.meshes),Array.prototype.push.apply(n.particleSystems,u.particleSystems),Array.prototype.push.apply(n.skeletons,u.skeletons),Array.prototype.push.apply(n.animationGroups,u.animationGroups),Array.prototype.push.apply(n.materials,a),Array.prototype.push.apply(n.textures,l),Array.prototype.push.apply(n.lights,u.lights),Array.prototype.push.apply(n.transformNodes,u.transformNodes),Array.prototype.push.apply(n.cameras,h),Array.prototype.push.apply(n.morphTargetManagers,c),n))})}canDirectLoad(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+Kt._MagicBase64Encoded)||e.startsWith("data:;base64,"+Kt._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+Kt._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+Kt._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+Kt._MagicBase64Encoded)||t.startsWith(";base64,"+Kt._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+Kt._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+Kt._MagicBase64Encoded)){const i=yh(t);return this._validate(e,new Uint8Array(i,0,i.byteLength)),this._unpackBinaryAsync(new yc({readAsync:(s,r)=>bg(i,s,r),byteLength:i.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new Kt}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(i=>{t(i)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(Es[this._state]))}_loadFile(e,t,i,s,r,n){const a=e._loadFile(t,i,l=>{this._onProgress(l,a)},!0,s,r,n);return a.onCompleteObservable.add(l=>{this._requests.splice(this._requests.indexOf(l),1)}),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let i=!0,s=0,r=0;for(const n of this._requests){if(n._lengthComputable===void 0||n._loaded===void 0||n._total===void 0)return;i=i&&n._lengthComputable,s+=n._loaded,r+=n._total}this._progressCallback({lengthComputable:i,loaded:s,total:i?r:0})}_validate(e,t,i="",s=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),Jm.ValidateAsync(t,i,s,r=>this.preprocessUrlAsync(i+r).then(n=>e._loadFileAsync(n,void 0,!0,!0).then(a=>new Uint8Array(a,0,a.byteLength)))).then(r=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(r),this.onValidatedObservable.clear()},r=>{this._endPerformanceCounter("Validate JSON"),Y.Warn(`Failed to validate: ${r.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const i=Kt._parseVersion(t.version);if(!i)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const n=Kt._parseVersion(t.minVersion);if(!n)throw new Error("Invalid minimum version: "+t.minVersion);if(Kt._compareVersion(n,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const r={1:Kt._CreateGLTF1Loader,2:Kt._CreateGLTF2Loader}[i.major];if(!r)throw new Error("Unsupported version: "+t.version);return r(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},i=e.readUint32();if(i!==t.Magic)throw new fr("Unexpected magic: "+i,pn.GLTFLoaderUnexpectedMagicError);const s=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${s}`);const r=e.readUint32();!this.useRangeRequests&&r!==e.buffer.byteLength&&q.Warn(`Length in header does not match actual data length: ${r} != ${e.buffer.byteLength}`);let n;switch(s){case 1:{n=this._unpackBinaryV1Async(e,r);break}case 2:{n=this._unpackBinaryV2Async(e,r);break}default:throw new Error("Unsupported version: "+s)}return this._endPerformanceCounter("Unpack Binary"),n})}_unpackBinaryV1Async(e,t){const i={JSON:0},s=e.readUint32(),r=e.readUint32();if(r!==i.JSON)throw new Error(`Unexpected content format: ${r}`);const n=t-e.byteOffset,a={json:this._parseJson(e.readString(s)),bin:null};if(n!==0){const l=e.byteOffset;a.bin={readAsync:(h,c)=>e.buffer.readAsync(l+h,c),byteLength:n}}return Promise.resolve(a)}_unpackBinaryV2Async(e,t){const i={JSON:1313821514,BIN:5130562},s=e.readUint32();if(e.readUint32()!==i.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+s===t?e.loadAsync(s).then(()=>({json:this._parseJson(e.readString(s)),bin:null})):e.loadAsync(s+8).then(()=>{const n={json:this._parseJson(e.readString(s)),bin:null},a=()=>{const l=e.readUint32();switch(e.readUint32()){case i.JSON:throw new Error("Unexpected JSON chunk");case i.BIN:{const c=e.byteOffset;n.bin={readAsync:(u,d)=>e.buffer.readAsync(c+u,d),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(a):Promise.resolve(n)};return a()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=Kt._logSpaces.substr(0,this._logIndentLevel*2);q.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){Y.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){Y.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}Kt.IncrementalLoading=!0;Kt.HomogeneousCoordinates=!1;Kt._MagicBase64Encoded="Z2xURg";Kt._logSpaces="                                ";ct&&ct.RegisterPlugin(new Kt);var un;(function(o){o[o.BYTE=5120]="BYTE",o[o.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",o[o.SHORT=5122]="SHORT",o[o.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",o[o.FLOAT=5126]="FLOAT"})(un||(un={}));var Id;(function(o){o[o.FRAGMENT=35632]="FRAGMENT",o[o.VERTEX=35633]="VERTEX"})(Id||(Id={}));var os;(function(o){o[o.BYTE=5120]="BYTE",o[o.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",o[o.SHORT=5122]="SHORT",o[o.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",o[o.INT=5124]="INT",o[o.UNSIGNED_INT=5125]="UNSIGNED_INT",o[o.FLOAT=5126]="FLOAT",o[o.FLOAT_VEC2=35664]="FLOAT_VEC2",o[o.FLOAT_VEC3=35665]="FLOAT_VEC3",o[o.FLOAT_VEC4=35666]="FLOAT_VEC4",o[o.INT_VEC2=35667]="INT_VEC2",o[o.INT_VEC3=35668]="INT_VEC3",o[o.INT_VEC4=35669]="INT_VEC4",o[o.BOOL=35670]="BOOL",o[o.BOOL_VEC2=35671]="BOOL_VEC2",o[o.BOOL_VEC3=35672]="BOOL_VEC3",o[o.BOOL_VEC4=35673]="BOOL_VEC4",o[o.FLOAT_MAT2=35674]="FLOAT_MAT2",o[o.FLOAT_MAT3=35675]="FLOAT_MAT3",o[o.FLOAT_MAT4=35676]="FLOAT_MAT4",o[o.SAMPLER_2D=35678]="SAMPLER_2D"})(os||(os={}));var oh;(function(o){o[o.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",o[o.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",o[o.REPEAT=10497]="REPEAT"})(oh||(oh={}));var Js;(function(o){o[o.NEAREST=9728]="NEAREST",o[o.LINEAR=9728]="LINEAR",o[o.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",o[o.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",o[o.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",o[o.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Js||(Js={}));var Sg;(function(o){o[o.ALPHA=6406]="ALPHA",o[o.RGB=6407]="RGB",o[o.RGBA=6408]="RGBA",o[o.LUMINANCE=6409]="LUMINANCE",o[o.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Sg||(Sg={}));var Pd;(function(o){o[o.FRONT=1028]="FRONT",o[o.BACK=1029]="BACK",o[o.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Pd||(Pd={}));var ri;(function(o){o[o.ZERO=0]="ZERO",o[o.ONE=1]="ONE",o[o.SRC_COLOR=768]="SRC_COLOR",o[o.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",o[o.DST_COLOR=774]="DST_COLOR",o[o.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",o[o.SRC_ALPHA=770]="SRC_ALPHA",o[o.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",o[o.DST_ALPHA=772]="DST_ALPHA",o[o.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",o[o.CONSTANT_COLOR=32769]="CONSTANT_COLOR",o[o.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",o[o.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",o[o.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",o[o.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(ri||(ri={}));class vi extends De{constructor(e,t,i,s=!0){super(e,t,i,s),this._tmpUpVector=m.Zero(),this._tmpTargetVector=m.Zero(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new Ke(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new le,this.rotation=new m(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=m.Zero(),this._initialFocalDistance=1,this._viewMatrix=L.Zero(),this._camMatrix=L.Zero(),this._cameraTransformMatrix=L.Zero(),this._cameraRotationMatrix=L.Zero(),this._referencePoint=new m(0,0,1),this._transformedReferencePoint=m.Zero(),this._deferredPositionUpdate=new m,this._deferredRotationQuaternionUpdate=new le,this._deferredRotationUpdate=new m,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=m.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){const e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new le(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=dt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),L.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&le.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(D.Matrix[0]),m.TransformNormalToRef(this.cameraDirection,D.Matrix[0],D.Vector3[0]),this._deferredPositionUpdate.addInPlace(D.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(le.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))),t&&(Math.abs(this.cameraDirection.x)<this.speed*dt&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*dt&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*dt&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*dt&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*dt&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):L.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return m.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),m.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?En.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(le.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),En.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const s=this.parent.getWorldMatrix();m.TransformCoordinatesToRef(e,s,this._globalPosition),m.TransformCoordinatesToRef(t,s,this._tmpTargetVector),m.TransformNormalToRef(i,s,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?L.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):L.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?L.LookAtRHToRef(e,t,i,this._viewMatrix):L.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const s=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(s,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==De.RIG_MODE_NONE){const i=new vi(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,this.cameraRigMode===De.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new le),i._cameraRigParams={},i.rotationQuaternion=new le),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case De.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case De.RIG_MODE_STEREOSCOPIC_OVERUNDER:case De.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,t);break}case De.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,vi._TargetFocalPoint),vi._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const s=vi._TargetFocalPoint.addInPlace(this.position);L.TranslationToRef(-s.x,-s.y,-s.z,vi._TargetTransformMatrix),vi._TargetTransformMatrix.multiplyToRef(L.RotationAxis(t.upVector,e),vi._RigCamTransformMatrix),L.TranslationToRef(s.x,s.y,s.z,vi._TargetTransformMatrix),vi._RigCamTransformMatrix.multiplyToRef(vi._TargetTransformMatrix,vi._RigCamTransformMatrix),m.TransformCoordinatesToRef(this.position,vi._RigCamTransformMatrix,t.position),t.setTarget(s)}getClassName(){return"TargetCamera"}}vi._RigCamTransformMatrix=new L;vi._TargetTransformMatrix=new L;vi._TargetFocalPoint=new m;v([zi()],vi.prototype,"rotation",void 0);v([M()],vi.prototype,"speed",void 0);v([Rf("lockedTargetId")],vi.prototype,"lockedTarget",void 0);var zr={};class eE{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();if(this.attached[t]){q.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const t in this.attached){const i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=De.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const s=this.attached[i],r=Le.Serialize(s);t[s.getClassName()]=r}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const s=zr[i];if(s){const r=t[i],n=Le.Parse(()=>new s,r,null);this.add(n)}}}else for(const i in this.attached){const s=zr[this.attached[i].getClassName()];if(s){const r=Le.Parse(()=>new s,e,null);this.remove(this.attached[i]),this.add(r)}}}}class Ns{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=Y.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===to.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-s,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,s):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(s,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-s):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,s,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-s,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),m.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){const e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}}v([M()],Ns.prototype,"keysUp",void 0);v([M()],Ns.prototype,"keysUpward",void 0);v([M()],Ns.prototype,"keysDown",void 0);v([M()],Ns.prototype,"keysDownward",void 0);v([M()],Ns.prototype,"keysLeft",void 0);v([M()],Ns.prototype,"keysRight",void 0);v([M()],Ns.prototype,"rotationSpeed",void 0);v([M()],Ns.prototype,"keysRotateLeft",void 0);v([M()],Ns.prototype,"keysRotateRight",void 0);v([M()],Ns.prototype,"keysRotateUp",void 0);v([M()],Ns.prototype,"keysRotateDown",void 0);zr.FreeCameraKeyboardMoveInput=Ns;class Jc{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new j,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=Y.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=s=>{const r=s.event,n=r.pointerType==="touch";if(!this.touchEnabled&&n||s.type!==xe.POINTERMOVE&&this.buttons.indexOf(r.button)===-1)return;const a=r.target;if(s.type===xe.POINTERDOWN){if(n&&this._activePointerId!==-1||!n&&this._currentActiveButton!==-1)return;this._activePointerId=r.pointerId;try{a==null||a.setPointerCapture(r.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=r.button),this._previousPosition={x:r.clientX,y:r.clientY},e||(r.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(s.event)}else if(s.type===xe.POINTERUP){if(n&&this._activePointerId!==r.pointerId||!n&&this._currentActiveButton!==r.button)return;try{a==null||a.releasePointerCapture(r.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||r.preventDefault(),this._activePointerId=-1}else if(s.type===xe.POINTERMOVE&&(this._activePointerId===r.pointerId||!n)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(s.event);else if(this._previousPosition){const l=this.camera._calculateHandednessMultiplier(),h=(r.clientX-this._previousPosition.x)*l,c=r.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=h/this.angularSensibility,this.camera.cameraRotation.x+=c/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:h,offsetY:c}),this._previousPosition={x:r.clientX,y:r.clientY},e||r.preventDefault()}}}),this._onMouseMove=s=>{if(!t.isPointerLock)return;const r=this.camera._calculateHandednessMultiplier(),n=s.movementX*r;this.camera.cameraRotation.y+=n/this.angularSensibility;const a=s.movementY;this.camera.cameraRotation.x+=a/this.angularSensibility,this._previousPosition=null,e||s.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,xe.POINTERDOWN|xe.POINTERUP|xe.POINTERMOVE),i&&(this._contextMenuBind=s=>this.onContextMenu(s),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}v([M()],Jc.prototype,"buttons",void 0);v([M()],Jc.prototype,"angularSensibility",void 0);zr.FreeCameraMouseInput=Jc;class eu{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new j,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=Y.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==xe.POINTERWHEEL)return;const i=t.event,s=i.deltaMode===vl.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,xe.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}v([M()],eu.prototype,"wheelPrecisionX",void 0);v([M()],eu.prototype,"wheelPrecisionY",void 0);v([M()],eu.prototype,"wheelPrecisionZ",void 0);var Mt;(function(o){o[o.MoveRelative=0]="MoveRelative",o[o.RotateRelative=1]="RotateRelative",o[o.MoveScene=2]="MoveScene"})(Mt||(Mt={}));class rr extends eu{constructor(){super(...arguments),this._moveRelative=m.Zero(),this._rotateRelative=m.Zero(),this._moveScene=m.Zero(),this._wheelXAction=Mt.MoveRelative,this._wheelXActionCoordinate=Kn.X,this._wheelYAction=Mt.MoveRelative,this._wheelYActionCoordinate=Kn.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==Mt.MoveRelative||(this._wheelXAction=Mt.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==Mt.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==Mt.MoveRelative||(this._wheelYAction=Mt.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==Mt.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==Mt.MoveRelative||(this._wheelZAction=Mt.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==Mt.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==Mt.RotateRelative||(this._wheelXAction=Mt.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==Mt.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==Mt.RotateRelative||(this._wheelYAction=Mt.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==Mt.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==Mt.RotateRelative||(this._wheelZAction=Mt.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==Mt.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==Mt.MoveScene||(this._wheelXAction=Mt.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==Mt.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==Mt.MoveScene||(this._wheelYAction=Mt.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==Mt.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==Mt.MoveScene||(this._wheelZAction=Mt.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==Mt.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=L.Zero();this.camera.getViewMatrix().invertToRef(e);const t=m.Zero();m.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let s=null;switch(t){case Mt.MoveRelative:s=this._moveRelative;break;case Mt.RotateRelative:s=this._rotateRelative;break;case Mt.MoveScene:s=this._moveScene;break}switch(i){case Kn.X:s.set(e,0,0);break;case Kn.Y:s.set(0,e,0);break;case Kn.Z:s.set(0,0,e);break}}}v([M()],rr.prototype,"wheelXMoveRelative",null);v([M()],rr.prototype,"wheelYMoveRelative",null);v([M()],rr.prototype,"wheelZMoveRelative",null);v([M()],rr.prototype,"wheelXRotateRelative",null);v([M()],rr.prototype,"wheelYRotateRelative",null);v([M()],rr.prototype,"wheelZRotateRelative",null);v([M()],rr.prototype,"wheelXMoveScene",null);v([M()],rr.prototype,"wheelYMoveScene",null);v([M()],rr.prototype,"wheelZMoveScene",null);zr.FreeCameraMouseWheelInput=rr;class tu{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=Y.IsSafari()}attachControl(e){e=Y.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const s=i.event,r=s.pointerType==="mouse"||this._isSafari&&typeof s.pointerType>"u";if(!(!this.allowMouse&&r)){if(i.type===xe.POINTERDOWN){if(e||s.preventDefault(),this._pointerPressed.push(s.pointerId),this._pointerPressed.length!==1)return;t={x:s.clientX,y:s.clientY}}else if(i.type===xe.POINTERUP){e||s.preventDefault();const n=this._pointerPressed.indexOf(s.pointerId);if(n===-1||(this._pointerPressed.splice(n,1),n!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===xe.POINTERMOVE){if(e||s.preventDefault(),!t||this._pointerPressed.indexOf(s.pointerId)!=0)return;this._offsetX=s.clientX-t.x,this._offsetY=-(s.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,xe.POINTERDOWN|xe.POINTERUP|xe.POINTERMOVE),this._onLostFocus){const s=this.camera.getEngine().getInputElement();s&&s.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const s=e._computeLocalCameraSpeed(),r=new m(0,0,this.touchMoveSensibility!==0?s*this._offsetY/this.touchMoveSensibility:0);L.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(m.TransformCoordinates(r,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}v([M()],tu.prototype,"touchAngularSensibility",void 0);v([M()],tu.prototype,"touchMoveSensibility",void 0);zr.FreeCameraTouchInput=tu;class yP extends eE{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Ns),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Jc(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new rr,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new tu),this}clear(){super.clear(),this._mouseInput=null}}class oa extends vi{get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){const e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){const e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=m.Zero(),this._diffPosition=m.Zero(),this._newPosition=m.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(r,n,a=null)=>{this._newPosition.copyFrom(n),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>H.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&a&&this.onCollide(a))},this.inputs=new yP(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=Y.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new Ke(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=m.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=m.Zero(),this._transformedDirection=m.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}v([zi()],oa.prototype,"ellipsoid",void 0);v([zi()],oa.prototype,"ellipsoidOffset",void 0);v([M()],oa.prototype,"checkCollisions",void 0);v([M()],oa.prototype,"applyGravity",void 0);Ie.prototype.updateRawTexture=function(o,e,t,i,s=null,r=0,n=!1){if(!o)return;const a=this._getRGBABufferInternalSizedFormat(r,t,n),l=this._getInternalFormat(t),h=this._getWebGLTextureType(r);this._bindTextureDirectly(this._gl.TEXTURE_2D,o,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(o._bufferView=e,o.format=t,o.type=r,o.invertY=i,o._compression=s),o.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[s],o.width,o.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,o.width,o.height,0,l,h,e),o.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),o.isReady=!0};Ie.prototype.createRawTexture=function(o,e,t,i,s,r,n,a=null,l=0,h=0,c=!1){const u=new wi(this,At.Raw);u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=s,u.samplingMode=n,u.invertY=r,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!s),this._doNotHandleContextLost||(u._bufferView=o),this.updateRawTexture(u,o,i,r,a,l,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);const d=this._getSamplingParameters(n,s);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u};Ie.prototype.createRawCubeTexture=function(o,e,t,i,s,r,n,a=null){const l=this._gl,h=new wi(this,At.CubeRaw);h.isCube=!0,h.format=t,h.type=i,this._doNotHandleContextLost||(h._bufferViewArray=o);const c=this._getWebGLTextureType(i);let u=this._getInternalFormat(t);u===l.RGB&&(u=l.RGBA),c===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(s=!1,n=1,q.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(s=!1,n=1,q.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===l.FLOAT&&!this._caps.textureFloatRender?(s=!1,q.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):c===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(s=!1,q.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const d=e,f=d;if(h.width=d,h.height=f,h.invertY=r,h._compression=a,!this.needPOTTextures||Y.IsExponentOfTwo(h.width)&&Y.IsExponentOfTwo(h.height)||(s=!1),o)this.updateRawCubeTexture(h,o,t,i,r,a);else{const g=this._getRGBABufferInternalSizedFormat(i),E=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,h,!0);for(let R=0;R<6;R++)a?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+R,E,this.getCaps().s3tc[a],h.width,h.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+R,E,g,h.width,h.height,0,u,c,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,h,!0),o&&s&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const _=this._getSamplingParameters(n,s);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),h.generateMipMaps=s,h.samplingMode=n,h.isReady=!0,h};Ie.prototype.updateRawCubeTexture=function(o,e,t,i,s,r=null,n=0){o._bufferViewArray=e,o.format=t,o.type=i,o.invertY=s,o._compression=r;const a=this._gl,l=this._getWebGLTextureType(i);let h=this._getInternalFormat(t);const c=this._getRGBABufferInternalSizedFormat(i);let u=!1;h===a.RGB&&(h=a.RGBA,u=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,o,!0),this._unpackFlipY(s===void 0?!0:!!s),o.width%4!==0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let p=e[f];r?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,this.getCaps().s3tc[r],o.width,o.height,0,p):(u&&(p=tE(p,o.width,o.height,i)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,c,o.width,o.height,0,h,l,p))}(!this.needPOTTextures||Y.IsExponentOfTwo(o.width)&&Y.IsExponentOfTwo(o.height))&&o.generateMipMaps&&n===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),o.isReady=!0};Ie.prototype.createRawCubeTextureFromUrl=function(o,e,t,i,s,r,n,a,l=null,h=null,c=3,u=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,i,s,!r,u,c,null);e==null||e.addPendingData(f),f.url=o,f.isReady=!1,this._internalTexturesCache.push(f);const p=(g,E)=>{e==null||e.removePendingData(f),h&&g&&h(g.status+" "+g.statusText,E)},_=g=>{const E=f.width,R=n(g);if(R){if(a){const x=this._getWebGLTextureType(s);let S=this._getInternalFormat(i);const b=this._getRGBABufferInternalSizedFormat(s);let y=!1;S===d.RGB&&(S=d.RGBA,y=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const I=a(R);for(let O=0;O<I.length;O++){const N=E>>O;for(let w=0;w<6;w++){let G=I[O][w];y&&(G=tE(G,N,N,s)),d.texImage2D(w,O,b,N,N,0,S,x,G)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,R,i,s,u);f.isReady=!0,e==null||e.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(o,g=>{_(g)},void 0,e==null?void 0:e.offlineProvider,!0,p),f};function tE(o,e,t,i){let s,r=1;i===1?s=new Float32Array(e*t*4):i===2?(s=new Uint16Array(e*t*4),r=15360):i===7?s=new Uint32Array(e*t*4):s=new Uint8Array(e*t*4);for(let n=0;n<e;n++)for(let a=0;a<t;a++){const l=(a*e+n)*3,h=(a*e+n)*4;s[h+0]=o[l+0],s[h+1]=o[l+1],s[h+2]=o[l+2],s[h+3]=r}return s}function iE(o){return function(e,t,i,s,r,n,a,l,h=null,c=0){const u=o?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=o?At.Raw3D:At.Raw2DArray,f=new wi(this,d);f.baseWidth=t,f.baseHeight=i,f.baseDepth=s,f.width=t,f.height=i,f.depth=s,f.format=r,f.type=c,f.generateMipMaps=n,f.samplingMode=l,o?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),o?this.updateRawTexture3D(f,e,r,a,h,c):this.updateRawTexture2DArray(f,e,r,a,h,c),this._bindTextureDirectly(u,f,!0);const p=this._getSamplingParameters(l,n);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,p.min),n&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(f),f}}Ie.prototype.createRawTexture2DArray=iE(!1);Ie.prototype.createRawTexture3D=iE(!0);function sE(o){return function(e,t,i,s,r=null,n=0){const a=o?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(n),h=this._getInternalFormat(i),c=this._getRGBABufferInternalSizedFormat(n,i);this._bindTextureDirectly(a,e,!0),this._unpackFlipY(s===void 0?!0:!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=s,e._compression=r),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&t?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[r],e.width,e.height,e.depth,0,t):this._gl.texImage3D(a,0,c,e.width,e.height,e.depth,0,h,l,t),e.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),e.isReady=!0}}Ie.prototype.updateRawTexture2DArray=sE(!1);Ie.prototype.updateRawTexture3D=sE(!0);class Fs extends V{constructor(e,t,i,s,r,n=!0,a=!1,l=3,h=0,c,u){super(null,r,!n,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,c),this.format=s,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&h===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&h===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,s,n,a,l,null,h,c??0,u??!1),this.wrapU=V.CLAMP_ADDRESSMODE,this.wrapV=V.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,s,r=!0,n=!1,a=3){return new Fs(e,t,i,1,s,r,n,a)}static CreateLuminanceAlphaTexture(e,t,i,s,r=!0,n=!1,a=3){return new Fs(e,t,i,2,s,r,n,a)}static CreateAlphaTexture(e,t,i,s,r=!0,n=!1,a=3){return new Fs(e,t,i,0,s,r,n,a)}static CreateRGBTexture(e,t,i,s,r=!0,n=!1,a=3,l=0,h=0,c=!1){return new Fs(e,t,i,4,s,r,n,a,l,h,c)}static CreateRGBATexture(e,t,i,s,r=!0,n=!1,a=3,l=0,h=0,c=!1){return new Fs(e,t,i,5,s,r,n,a,l,h,c)}static CreateRGBAStorageTexture(e,t,i,s,r=!0,n=!1,a=3,l=0,h=!1){return new Fs(e,t,i,5,s,r,n,a,l,1,h)}static CreateRTexture(e,t,i,s,r=!0,n=!1,a=V.TRILINEAR_SAMPLINGMODE,l=1){return new Fs(e,t,i,6,s,r,n,a,l)}static CreateRStorageTexture(e,t,i,s,r=!0,n=!1,a=V.TRILINEAR_SAMPLINGMODE,l=1){return new Fs(e,t,i,6,s,r,n,a,l,1)}}class so{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=L.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new j,this.bones=[],this._scene=i||Ze.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const s=this._scene.getEngine().getCaps();this._canUseTextureForBones=s.textureFloat&&s.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):((!this._transformMatrices||this._isDirty)&&this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const s in this._ranges)i&&(t+=", ",i=!1),t+=s;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new io(e,t,i);for(let s=0,r=this.bones.length;s<r;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.bones.length;i<s;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let s=!0;const r=this._getHighestAnimationFrame()+1,n={},a=e.bones;let l,h;for(h=0,l=a.length;h<l;h++)n[a[h].name]=a[h];this.bones.length!==a.length&&(q.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),s=!1);const c=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(h=0,l=this.bones.length;h<l;h++){const d=this.bones[h].name,f=n[d];f?s=s&&this.bones[h].copyAnimationRange(f,t,r,i,c):(q.Warn("copyAnimationRange: not same rig, missing source bone "+d),s=!1)}const u=e.getAnimationRange(t);return u&&(this._ranges[t]=new io(t,u.from+r,u.to+r)),s}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const s=this.bones[t].animations[0].getHighestFrame();e<s&&(e=s)}return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}static MakeAnimationAdditive(e,t=0,i){const s=e.getAnimationRange(i);if(!s)return null;const r=e._scene.getAllAnimatablesByTarget(e);let n=null;for(let l=0;l<r.length;l++){const h=r[l];if(h.fromFrame===(s==null?void 0:s.from)&&h.toFrame===(s==null?void 0:s.to)){n=h;break}}const a=e.getAnimatables();for(let l=0;l<a.length;l++){const c=a[l].animations;if(c)for(let u=0;u<c.length;u++)W.MakeAnimationAdditive(c[u],t,i)}return n&&(n.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const s=this.bones[i];s._childUpdateId++;const r=s.getParent();if(r?s.getLocalMatrix().multiplyToRef(r.getFinalMatrix(),s.getFinalMatrix()):t?s.getLocalMatrix().multiplyToRef(t,s.getFinalMatrix()):s.getFinalMatrix().copyFrom(s.getLocalMatrix()),s._index!==-1){const n=s._index===null?i:s._index;s.getAbsoluteInverseBindMatrix().multiplyToArray(s.getFinalMatrix(),e,n*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){const t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(const t of this.bones)if(t._linkedTransformNode){const i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(const t of this._meshesWithPoseMatrix){const i=t.getPoseMatrix();let s=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),s=!0),!!s){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(const r of this.bones)r.getParent()||(r.getBindMatrix().multiplyToRef(i,D.Matrix[1]),r._updateAbsoluteBindMatrices(D.Matrix[1]));if(this.isUsingTextureForMatrices){const r=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==r)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=Fs.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=Fs.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new so(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let s=0;s<this.bones.length;s++){const r=this.bones[s];let n=null;const a=r.getParent();if(a){const h=this.bones.indexOf(a);n=i.bones[h]}const l=new vt(r.name,i,n,r.getBindMatrix().clone(),r.getRestMatrix().clone());l._index=r._index,r._linkedTransformNode&&l.linkTransformNode(r._linkedTransformNode),Yc.DeepCopy(r.animations,l.animations)}if(this._ranges){i._ranges={};for(const s in this._ranges){const r=this._ranges[s];r&&(i._ranges[s]=r.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const s=this.bones[i],r=s.getParent(),n={parentBoneIndex:r?this.bones.indexOf(r):-1,index:s.getIndex(),name:s.name,id:s.id,matrix:s.getBindMatrix().toArray(),rest:s.getRestMatrix().toArray(),linkedTransformNodeId:(e=s.getTransformNode())===null||e===void 0?void 0:e.id};t.bones.push(n),s.length&&(n.length=s.length),s.metadata&&(n.metadata=s.metadata),s.animations&&s.animations.length>0&&(n.animation=s.animations[0].serialize()),t.ranges=[];for(const a in this._ranges){const l=this._ranges[a];if(!l)continue;const h={};h.name=a,h.from=l.from,h.to=l.to,t.ranges.push(h)}}return t}static Parse(e,t){const i=new so(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=m.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix;let s;for(s=0;s<e.bones.length;s++){const r=e.bones[s],n=e.bones[s].index;let a=null;r.parentBoneIndex>-1&&(a=i.bones[r.parentBoneIndex]);const l=r.rest?L.FromArray(r.rest):null,h=new vt(r.name,i,a,L.FromArray(r.matrix),l,null,n);r.id!==void 0&&r.id!==null&&(h.id=r.id),r.length&&(h.length=r.length),r.metadata&&(h.metadata=r.metadata),r.animation&&h.animations.push(W.Parse(r.animation)),r.linkedTransformNodeId!==void 0&&r.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,h._waitingTransformNodeId=r.linkedTransformNodeId)}if(e.ranges)for(s=0;s<e.ranges.length;s++){const r=e.ranges[s];i.createAnimationRange(r.name,r.from,r.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const s=this.bones[e];if(!s)return;s._index===void 0&&(s._index=e);const r=s.getParent();r&&this._sortBones(this.bones.indexOf(r),t,i),t.push(s)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}const CP="defaultFragmentDeclaration",xP=`uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;X.IncludesShadersStore[CP]=xP;const MP="defaultUboDeclaration",IP=`layout(std140,column_major) uniform;uniform Material
{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;X.IncludesShadersStore[MP]=IP;const PP="lightsFragmentFunctions",DP=`struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)
{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}`;X.IncludesShadersStore[PP]=DP;const OP="fresnelFunction",NP=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;X.IncludesShadersStore[OP]=NP;const LP="defaultPixelShader",FP=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;float aggShadow=0.;float numLights=0.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); 
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;X.ShadersStore[LP]=FP;const wP="defaultVertexDeclaration",BP=`uniform mat4 viewProjection;uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;X.IncludesShadersStore[wP]=BP;const UP="defaultVertexShader",kP=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;X.ShadersStore[UP]=kP;const ad={effect:null,subMesh:null};class VP extends ir{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class oe extends Ph{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new J(0,0,0),this.diffuseColor=new J(1,1,1),this.specularColor=new J(1,1,1),this.emissiveColor=new J(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._renderTargets=new li(16),this._worldViewProjectionMatrix=L.Zero(),this._globalAmbientColor=new J(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new On(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Fc,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),oe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),oe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return oe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||oe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Q.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Q.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Di.GetDefineNames,this._eventInfo),t.materialDefines=new VP(this._eventInfo.defineNames));const s=this.getScene(),r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();r._needNormals=se.PrepareDefinesForLights(s,e,r,!0,this._maxSimultaneousLights,this._disableLighting),se.PrepareDefinesForMultiview(s,r);const a=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(se.PrepareDefinesForPrePass(s,r,this.canRenderToMRT&&!a),se.PrepareDefinesForOIT(s,r,a),r._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,r._needUVs=!1;for(let h=1;h<=6;++h)r["MAINUV"+h]=!1;if(s.texturesEnabled){if(r.DIFFUSEDIRECTUV=0,r.BUMPDIRECTUV=0,r.AMBIENTDIRECTUV=0,r.OPACITYDIRECTUV=0,r.EMISSIVEDIRECTUV=0,r.SPECULARDIRECTUV=0,r.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&oe.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE");else return!1;else r.DIFFUSE=!1;if(this._ambientTexture&&oe.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._ambientTexture,r,"AMBIENT");else return!1;else r.AMBIENT=!1;if(this._opacityTexture&&oe.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._opacityTexture,r,"OPACITY"),r.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else r.OPACITY=!1;if(this._reflectionTexture&&oe.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(r._needNormals=!0,r.REFLECTION=!0,r.ROUGHNESS=this._roughness>0,r.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,r.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===V.INVCUBIC_MODE,r.REFLECTIONMAP_3D=this._reflectionTexture.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,r.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case V.EXPLICIT_MODE:r.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case V.PLANAR_MODE:r.setReflectionMode("REFLECTIONMAP_PLANAR");break;case V.PROJECTION_MODE:r.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case V.SKYBOX_MODE:r.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case V.SPHERICAL_MODE:r.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case V.EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case V.FIXED_EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case V.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case V.CUBIC_MODE:case V.INVCUBIC_MODE:default:r.setReflectionMode("REFLECTIONMAP_CUBIC");break}r.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else r.REFLECTION=!1,r.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&oe.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._emissiveTexture,r,"EMISSIVE");else return!1;else r.EMISSIVE=!1;if(this._lightmapTexture&&oe.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._lightmapTexture,r,"LIGHTMAP"),r.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,r.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else r.LIGHTMAP=!1;if(this._specularTexture&&oe.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._specularTexture,r,"SPECULAR"),r.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else r.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&oe.BumpTextureEnabled){if(this._bumpTexture.isReady())se.PrepareDefinesForMergedUV(this._bumpTexture,r,"BUMP"),r.PARALLAX=this._useParallax,r.PARALLAX_RHS=s.useRightHandedSystem,r.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;r.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else r.BUMP=!1,r.PARALLAX=!1,r.PARALLAX_RHS=!1,r.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&oe.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())r._needUVs=!0,r.REFRACTION=!0,r.REFRACTIONMAP_3D=this._refractionTexture.isCube,r.RGBDREFRACTION=this._refractionTexture.isRGBD,r.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else r.REFRACTION=!1;r.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else r.DIFFUSE=!1,r.AMBIENT=!1,r.OPACITY=!1,r.REFLECTION=!1,r.EMISSIVE=!1,r.LIGHTMAP=!1,r.BUMP=!1,r.REFRACTION=!1;r.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),r.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,r.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,r.SPECULAROVERALPHA=this._useSpecularOverAlpha,r.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,r.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,r.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r),r.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,r.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}r._areFresnelDirty&&(oe.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(r.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,r.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,r.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,r.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,r.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,r.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,r._needNormals=!0,r.FRESNEL=!0):r.FRESNEL=!1),se.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,r,this._applyDecalMapAfterDetailMap),se.PrepareDefinesForFrameBoundValues(s,n,this,r,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=r,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),se.PrepareDefinesForAttributes(e,r,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let l=!1;if(r.isDirty){const h=r._areLightsDisposed;r.markAsProcessed();const c=new Ih;r.REFLECTION&&c.addFallback(0,"REFLECTION"),r.SPECULAR&&c.addFallback(0,"SPECULAR"),r.BUMP&&c.addFallback(0,"BUMP"),r.PARALLAX&&c.addFallback(1,"PARALLAX"),r.PARALLAX_RHS&&c.addFallback(1,"PARALLAX_RHS"),r.PARALLAXOCCLUSION&&c.addFallback(0,"PARALLAXOCCLUSION"),r.SPECULAROVERALPHA&&c.addFallback(0,"SPECULAROVERALPHA"),r.FOG&&c.addFallback(1,"FOG"),r.POINTSIZE&&c.addFallback(0,"POINTSIZE"),r.LOGARITHMICDEPTH&&c.addFallback(0,"LOGARITHMICDEPTH"),se.HandleFallbacksForShadows(r,c,this._maxSimultaneousLights),r.SPECULARTERM&&c.addFallback(0,"SPECULARTERM"),r.DIFFUSEFRESNEL&&c.addFallback(1,"DIFFUSEFRESNEL"),r.OPACITYFRESNEL&&c.addFallback(2,"OPACITYFRESNEL"),r.REFLECTIONFRESNEL&&c.addFallback(3,"REFLECTIONFRESNEL"),r.EMISSIVEFRESNEL&&c.addFallback(4,"EMISSIVEFRESNEL"),r.FRESNEL&&c.addFallback(4,"FRESNEL"),r.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");const u=[T.PositionKind];r.NORMAL&&u.push(T.NormalKind),r.TANGENT&&u.push(T.TangentKind);for(let b=1;b<=6;++b)r["UV"+b]&&u.push(`uv${b===1?"":b}`);r.VERTEXCOLOR&&u.push(T.ColorKind),se.PrepareAttributesForBones(u,e,r,c),se.PrepareAttributesForInstances(u,r),se.PrepareAttributesForMorphTargets(u,e,r),se.PrepareAttributesForBakedVertexAnimation(u,e,r);let d="default";const f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],p=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"],g={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=0,this._eventInfo.defines=r,this._eventInfo.uniforms=f,this._eventInfo.attributes=u,this._eventInfo.samplers=p,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=g,this._callbackPluginEventGeneric(Di.PrepareEffect,this._eventInfo),Fc.AddUniforms(f),st&&(st.PrepareUniforms(f,r),st.PrepareSamplers(p,r)),se.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:_,samplers:p,defines:r,maxSimultaneousLights:this._maxSimultaneousLights}),In(f);const E={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,f,_,p,r,u,E));const R=r.toString(),x=t.effect;let S=s.getEngine().createEffect(d,{attributes:u,uniformsNames:f,uniformBuffersNames:_,samplers:p,defines:R,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:g,processFinalCode:E.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:r.PREPASS},n);if(this._eventInfo.customCode=void 0,S)if(this._onEffectCreatedObservable&&(ad.effect=S,ad.subMesh=t,this._onEffectCreatedObservable.notifyObservers(ad)),this.allowShaderHotSwapping&&x&&!S.isReady()){if(S=x,r.markAsUnprocessed(),l=this.isFrozen,h)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(S,r,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!l,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s;const r=this.getScene(),n=i.materialDefines;if(!n)return;const a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=a._forceRebindOnNextCall||this._mustRebind(r,a,t.visibility);se.BindBonesParameters(t,a);const h=this._uniformBuffer;if(l){if(this.bindViewProjection(a),!h.useUbo||!this.isFrozen||!h.isSync||a._forceRebindOnNextCall){if(oe.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(h.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),h.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&h.updateColor4("opacityParts",new J(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(h.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),h.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(h.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),h.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(h.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),h.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&oe.DiffuseTextureEnabled&&(h.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),se.BindTextureMatrix(this._diffuseTexture,h,"diffuse")),this._ambientTexture&&oe.AmbientTextureEnabled&&(h.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),se.BindTextureMatrix(this._ambientTexture,h,"ambient")),this._opacityTexture&&oe.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),se.BindTextureMatrix(this._opacityTexture,h,"opacity")),this._hasAlphaChannel()&&h.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&oe.ReflectionTextureEnabled&&(h.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),h.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const c=this._reflectionTexture;h.updateVector3("vReflectionPosition",c.boundingBoxPosition),h.updateVector3("vReflectionSize",c.boundingBoxSize)}if(this._emissiveTexture&&oe.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),se.BindTextureMatrix(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&oe.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),se.BindTextureMatrix(this._lightmapTexture,h,"lightmap")),this._specularTexture&&oe.SpecularTextureEnabled&&(h.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),se.BindTextureMatrix(this._specularTexture,h,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&oe.BumpTextureEnabled&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),se.BindTextureMatrix(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&oe.RefractionTextureEnabled){let c=1;if(this._refractionTexture.isCube||(h.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(c=this._refractionTexture.depth)),h.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const u=this._refractionTexture;h.updateVector3("vRefractionPosition",u.boundingBoxPosition),h.updateVector3("vRefractionSize",u.boundingBoxSize)}}}this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),n.SPECULARTERM&&h.updateColor4("vSpecularColor",this.specularColor,this.specularPower),h.updateColor3("vEmissiveColor",oe.EmissiveTextureEnabled?this.emissiveColor:J.BlackReadOnly),h.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&oe.DiffuseTextureEnabled&&a.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&oe.AmbientTextureEnabled&&a.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&oe.OpacityTextureEnabled&&a.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&oe.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?a.setTexture("reflectionCubeSampler",this._reflectionTexture):a.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&oe.EmissiveTextureEnabled&&a.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&oe.LightmapTextureEnabled&&a.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&oe.SpecularTextureEnabled&&a.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&oe.BumpTextureEnabled&&a.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&oe.RefractionTextureEnabled&&(this._refractionTexture.isCube?a.setTexture("refractionCubeSampler",this._refractionTexture):a.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Pn(a,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&se.BindLights(r,t,a,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Ve.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(a),se.BindFogParameters(r,t,a),n.NUM_MORPH_INFLUENCERS&&se.BindMorphTargetParameters(t,a),n.BAKED_VERTEX_ANIMATION_TEXTURE&&((s=t.bakedVertexAnimationManager)===null||s===void 0||s.bind(a,n.INSTANCES)),this.useLogarithmicDepth&&se.BindLogDepth(n,a,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),h.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){var i,s,r,n,a,l,h,c,u;t&&((i=this._diffuseTexture)===null||i===void 0||i.dispose(),(s=this._ambientTexture)===null||s===void 0||s.dispose(),(r=this._opacityTexture)===null||r===void 0||r.dispose(),(n=this._reflectionTexture)===null||n===void 0||n.dispose(),(a=this._emissiveTexture)===null||a===void 0||a.dispose(),(l=this._specularTexture)===null||l===void 0||l.dispose(),(h=this._bumpTexture)===null||h===void 0||h.dispose(),(c=this._lightmapTexture)===null||c===void 0||c.dispose(),(u=this._refractionTexture)===null||u===void 0||u.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){const s=Le.Clone(()=>new oe(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return s.name=e,s.id=e,this.stencil.copyTo(s.stencil),this._clonePlugins(s,i),s}static Parse(e,t,i){const s=Le.Parse(()=>new oe(e.name,t),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),Q._parsePlugins(e,s,t,i),s}static get DiffuseTextureEnabled(){return ie.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){ie.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return ie.DetailTextureEnabled}static set DetailTextureEnabled(e){ie.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return ie.AmbientTextureEnabled}static set AmbientTextureEnabled(e){ie.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return ie.OpacityTextureEnabled}static set OpacityTextureEnabled(e){ie.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return ie.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){ie.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return ie.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){ie.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return ie.SpecularTextureEnabled}static set SpecularTextureEnabled(e){ie.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return ie.BumpTextureEnabled}static set BumpTextureEnabled(e){ie.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return ie.LightmapTextureEnabled}static set LightmapTextureEnabled(e){ie.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return ie.RefractionTextureEnabled}static set RefractionTextureEnabled(e){ie.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return ie.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){ie.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return ie.FresnelEnabled}static set FresnelEnabled(e){ie.FresnelEnabled=e}}v([rt("diffuseTexture")],oe.prototype,"_diffuseTexture",void 0);v([Z("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"diffuseTexture",void 0);v([rt("ambientTexture")],oe.prototype,"_ambientTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"ambientTexture",void 0);v([rt("opacityTexture")],oe.prototype,"_opacityTexture",void 0);v([Z("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"opacityTexture",void 0);v([rt("reflectionTexture")],oe.prototype,"_reflectionTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"reflectionTexture",void 0);v([rt("emissiveTexture")],oe.prototype,"_emissiveTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"emissiveTexture",void 0);v([rt("specularTexture")],oe.prototype,"_specularTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"specularTexture",void 0);v([rt("bumpTexture")],oe.prototype,"_bumpTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"bumpTexture",void 0);v([rt("lightmapTexture")],oe.prototype,"_lightmapTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"lightmapTexture",void 0);v([rt("refractionTexture")],oe.prototype,"_refractionTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"refractionTexture",void 0);v([oi("ambient")],oe.prototype,"ambientColor",void 0);v([oi("diffuse")],oe.prototype,"diffuseColor",void 0);v([oi("specular")],oe.prototype,"specularColor",void 0);v([oi("emissive")],oe.prototype,"emissiveColor",void 0);v([M()],oe.prototype,"specularPower",void 0);v([M("useAlphaFromDiffuseTexture")],oe.prototype,"_useAlphaFromDiffuseTexture",void 0);v([Z("_markAllSubMeshesAsTexturesAndMiscDirty")],oe.prototype,"useAlphaFromDiffuseTexture",void 0);v([M("useEmissiveAsIllumination")],oe.prototype,"_useEmissiveAsIllumination",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useEmissiveAsIllumination",void 0);v([M("linkEmissiveWithDiffuse")],oe.prototype,"_linkEmissiveWithDiffuse",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"linkEmissiveWithDiffuse",void 0);v([M("useSpecularOverAlpha")],oe.prototype,"_useSpecularOverAlpha",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useSpecularOverAlpha",void 0);v([M("useReflectionOverAlpha")],oe.prototype,"_useReflectionOverAlpha",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useReflectionOverAlpha",void 0);v([M("disableLighting")],oe.prototype,"_disableLighting",void 0);v([Z("_markAllSubMeshesAsLightsDirty")],oe.prototype,"disableLighting",void 0);v([M("useObjectSpaceNormalMap")],oe.prototype,"_useObjectSpaceNormalMap",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useObjectSpaceNormalMap",void 0);v([M("useParallax")],oe.prototype,"_useParallax",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useParallax",void 0);v([M("useParallaxOcclusion")],oe.prototype,"_useParallaxOcclusion",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useParallaxOcclusion",void 0);v([M()],oe.prototype,"parallaxScaleBias",void 0);v([M("roughness")],oe.prototype,"_roughness",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"roughness",void 0);v([M()],oe.prototype,"indexOfRefraction",void 0);v([M()],oe.prototype,"invertRefractionY",void 0);v([M()],oe.prototype,"alphaCutOff",void 0);v([M("useLightmapAsShadowmap")],oe.prototype,"_useLightmapAsShadowmap",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useLightmapAsShadowmap",void 0);v([Sh("diffuseFresnelParameters")],oe.prototype,"_diffuseFresnelParameters",void 0);v([Z("_markAllSubMeshesAsFresnelDirty")],oe.prototype,"diffuseFresnelParameters",void 0);v([Sh("opacityFresnelParameters")],oe.prototype,"_opacityFresnelParameters",void 0);v([Z("_markAllSubMeshesAsFresnelAndMiscDirty")],oe.prototype,"opacityFresnelParameters",void 0);v([Sh("reflectionFresnelParameters")],oe.prototype,"_reflectionFresnelParameters",void 0);v([Z("_markAllSubMeshesAsFresnelDirty")],oe.prototype,"reflectionFresnelParameters",void 0);v([Sh("refractionFresnelParameters")],oe.prototype,"_refractionFresnelParameters",void 0);v([Z("_markAllSubMeshesAsFresnelDirty")],oe.prototype,"refractionFresnelParameters",void 0);v([Sh("emissiveFresnelParameters")],oe.prototype,"_emissiveFresnelParameters",void 0);v([Z("_markAllSubMeshesAsFresnelDirty")],oe.prototype,"emissiveFresnelParameters",void 0);v([M("useReflectionFresnelFromSpecular")],oe.prototype,"_useReflectionFresnelFromSpecular",void 0);v([Z("_markAllSubMeshesAsFresnelDirty")],oe.prototype,"useReflectionFresnelFromSpecular",void 0);v([M("useGlossinessFromSpecularMapAlpha")],oe.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"useGlossinessFromSpecularMapAlpha",void 0);v([M("maxSimultaneousLights")],oe.prototype,"_maxSimultaneousLights",void 0);v([Z("_markAllSubMeshesAsLightsDirty")],oe.prototype,"maxSimultaneousLights",void 0);v([M("invertNormalMapX")],oe.prototype,"_invertNormalMapX",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"invertNormalMapX",void 0);v([M("invertNormalMapY")],oe.prototype,"_invertNormalMapY",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"invertNormalMapY",void 0);v([M("twoSidedLighting")],oe.prototype,"_twoSidedLighting",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],oe.prototype,"twoSidedLighting",void 0);v([M("applyDecalMapAfterDetailMap")],oe.prototype,"_applyDecalMapAfterDetailMap",void 0);v([Z("_markAllSubMeshesAsMiscDirty")],oe.prototype,"applyDecalMapAfterDetailMap",void 0);Re("BABYLON.StandardMaterial",oe);Ve.DefaultMaterialFactory=o=>new oe("default material",o);class gi{static SetMatrix(e,t,i,s,r){let n=null;if(i.semantic==="MODEL"?n=t.getWorldMatrix():i.semantic==="PROJECTION"?n=e.getProjectionMatrix():i.semantic==="VIEW"?n=e.getViewMatrix():i.semantic==="MODELVIEWINVERSETRANSPOSE"?n=L.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):i.semantic==="MODELVIEW"?n=t.getWorldMatrix().multiply(e.getViewMatrix()):i.semantic==="MODELVIEWPROJECTION"?n=t.getWorldMatrix().multiply(e.getTransformMatrix()):i.semantic==="MODELINVERSE"?n=t.getWorldMatrix().invert():i.semantic==="VIEWINVERSE"?n=e.getViewMatrix().invert():i.semantic==="PROJECTIONINVERSE"?n=e.getProjectionMatrix().invert():i.semantic==="MODELVIEWINVERSE"?n=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():i.semantic==="MODELVIEWPROJECTIONINVERSE"?n=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():i.semantic==="MODELINVERSETRANSPOSE"&&(n=L.Transpose(t.getWorldMatrix().invert())),n)switch(i.type){case os.FLOAT_MAT2:r.setMatrix2x2(s,L.GetAsMatrix2x2(n));break;case os.FLOAT_MAT3:r.setMatrix3x3(s,L.GetAsMatrix3x3(n));break;case os.FLOAT_MAT4:r.setMatrix(s,n);break}}static SetUniform(e,t,i,s){switch(s){case os.FLOAT:return e.setFloat(t,i),!0;case os.FLOAT_VEC2:return e.setVector2(t,Ke.FromArray(i)),!0;case os.FLOAT_VEC3:return e.setVector3(t,m.FromArray(i)),!0;case os.FLOAT_VEC4:return e.setVector4(t,ut.FromArray(i)),!0;default:return!1}}static GetWrapMode(e){switch(e){case oh.CLAMP_TO_EDGE:return V.CLAMP_ADDRESSMODE;case oh.MIRRORED_REPEAT:return V.MIRROR_ADDRESSMODE;case oh.REPEAT:return V.WRAP_ADDRESSMODE;default:return V.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case Js.LINEAR:case Js.LINEAR_MIPMAP_NEAREST:case Js.LINEAR_MIPMAP_LINEAR:return V.TRILINEAR_SAMPLINGMODE;case Js.NEAREST:case Js.NEAREST_MIPMAP_NEAREST:return V.NEAREST_SAMPLINGMODE;default:return V.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,i,s,r){i=t.byteOffset+i;const n=e.loadedBufferViews[t.buffer];if(i+s>n.byteLength)throw new Error("Buffer access is out of range");const a=n.buffer;switch(i+=n.byteOffset,r){case un.BYTE:return new Int8Array(a,i,s);case un.UNSIGNED_BYTE:return new Uint8Array(a,i,s);case un.SHORT:return new Int16Array(a,i,s);case un.UNSIGNED_SHORT:return new Uint16Array(a,i,s);default:return new Float32Array(a,i,s)}}static GetBufferFromAccessor(e,t){const i=e.bufferViews[t.bufferView],s=t.count*gi.GetByteStrideFromType(t);return gi.GetBufferFromBufferView(e,i,t.byteOffset,s,t.componentType)}static DecodeBufferToText(e){let t="";const i=e.byteLength;for(let s=0;s<i;++s)t+=String.fromCharCode(e[s]);return t}static GetDefaultMaterial(e){if(!gi._DefaultMaterial){ai.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),ai.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},i={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};gi._DefaultMaterial=new Rs("GLTFDefaultMaterial",e,t,i),gi._DefaultMaterial.setColor4("u_emission",new He(.5,.5,.5,1))}return gi._DefaultMaterial}}gi._DefaultMaterial=null;class B{}B.ALPHA_DISABLE=0;B.ALPHA_ADD=1;B.ALPHA_COMBINE=2;B.ALPHA_SUBTRACT=3;B.ALPHA_MULTIPLY=4;B.ALPHA_MAXIMIZED=5;B.ALPHA_ONEONE=6;B.ALPHA_PREMULTIPLIED=7;B.ALPHA_PREMULTIPLIED_PORTERDUFF=8;B.ALPHA_INTERPOLATE=9;B.ALPHA_SCREENMODE=10;B.ALPHA_ONEONE_ONEONE=11;B.ALPHA_ALPHATOCOLOR=12;B.ALPHA_REVERSEONEMINUS=13;B.ALPHA_SRC_DSTONEMINUSSRCALPHA=14;B.ALPHA_ONEONE_ONEZERO=15;B.ALPHA_EXCLUSION=16;B.ALPHA_LAYER_ACCUMULATE=17;B.ALPHA_EQUATION_ADD=0;B.ALPHA_EQUATION_SUBSTRACT=1;B.ALPHA_EQUATION_REVERSE_SUBTRACT=2;B.ALPHA_EQUATION_MAX=3;B.ALPHA_EQUATION_MIN=4;B.ALPHA_EQUATION_DARKEN=5;B.DELAYLOADSTATE_NONE=0;B.DELAYLOADSTATE_LOADED=1;B.DELAYLOADSTATE_LOADING=2;B.DELAYLOADSTATE_NOTLOADED=4;B.NEVER=512;B.ALWAYS=519;B.LESS=513;B.EQUAL=514;B.LEQUAL=515;B.GREATER=516;B.GEQUAL=518;B.NOTEQUAL=517;B.KEEP=7680;B.ZERO=0;B.REPLACE=7681;B.INCR=7682;B.DECR=7683;B.INVERT=5386;B.INCR_WRAP=34055;B.DECR_WRAP=34056;B.TEXTURE_CLAMP_ADDRESSMODE=0;B.TEXTURE_WRAP_ADDRESSMODE=1;B.TEXTURE_MIRROR_ADDRESSMODE=2;B.TEXTURE_CREATIONFLAG_STORAGE=1;B.TEXTUREFORMAT_ALPHA=0;B.TEXTUREFORMAT_LUMINANCE=1;B.TEXTUREFORMAT_LUMINANCE_ALPHA=2;B.TEXTUREFORMAT_RGB=4;B.TEXTUREFORMAT_RGBA=5;B.TEXTUREFORMAT_RED=6;B.TEXTUREFORMAT_R=6;B.TEXTUREFORMAT_RG=7;B.TEXTUREFORMAT_RED_INTEGER=8;B.TEXTUREFORMAT_R_INTEGER=8;B.TEXTUREFORMAT_RG_INTEGER=9;B.TEXTUREFORMAT_RGB_INTEGER=10;B.TEXTUREFORMAT_RGBA_INTEGER=11;B.TEXTUREFORMAT_BGRA=12;B.TEXTUREFORMAT_DEPTH24_STENCIL8=13;B.TEXTUREFORMAT_DEPTH32_FLOAT=14;B.TEXTUREFORMAT_DEPTH16=15;B.TEXTUREFORMAT_DEPTH24=16;B.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17;B.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18;B.TEXTUREFORMAT_STENCIL8=19;B.TEXTUREFORMAT_UNDEFINED=4294967295;B.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492;B.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493;B.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495;B.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494;B.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779;B.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919;B.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778;B.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918;B.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777;B.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776;B.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917;B.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916;B.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808;B.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840;B.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196;B.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492;B.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493;B.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494;B.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495;B.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496;B.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497;B.TEXTURETYPE_UNSIGNED_BYTE=0;B.TEXTURETYPE_UNSIGNED_INT=0;B.TEXTURETYPE_FLOAT=1;B.TEXTURETYPE_HALF_FLOAT=2;B.TEXTURETYPE_BYTE=3;B.TEXTURETYPE_SHORT=4;B.TEXTURETYPE_UNSIGNED_SHORT=5;B.TEXTURETYPE_INT=6;B.TEXTURETYPE_UNSIGNED_INTEGER=7;B.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;B.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;B.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;B.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;B.TEXTURETYPE_UNSIGNED_INT_24_8=12;B.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;B.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;B.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;B.TEXTURETYPE_UNDEFINED=16;B.TEXTURE_2D=3553;B.TEXTURE_2D_ARRAY=35866;B.TEXTURE_CUBE_MAP=34067;B.TEXTURE_CUBE_MAP_ARRAY=3735928559;B.TEXTURE_3D=32879;B.TEXTURE_NEAREST_SAMPLINGMODE=1;B.TEXTURE_NEAREST_NEAREST=1;B.TEXTURE_BILINEAR_SAMPLINGMODE=2;B.TEXTURE_LINEAR_LINEAR=2;B.TEXTURE_TRILINEAR_SAMPLINGMODE=3;B.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;B.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;B.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;B.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;B.TEXTURE_NEAREST_LINEAR=7;B.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;B.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;B.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;B.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;B.TEXTURE_LINEAR_NEAREST=12;B.TEXTURE_EXPLICIT_MODE=0;B.TEXTURE_SPHERICAL_MODE=1;B.TEXTURE_PLANAR_MODE=2;B.TEXTURE_CUBIC_MODE=3;B.TEXTURE_PROJECTION_MODE=4;B.TEXTURE_SKYBOX_MODE=5;B.TEXTURE_INVCUBIC_MODE=6;B.TEXTURE_EQUIRECTANGULAR_MODE=7;B.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;B.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;B.TEXTURE_FILTERING_QUALITY_OFFLINE=4096;B.TEXTURE_FILTERING_QUALITY_HIGH=64;B.TEXTURE_FILTERING_QUALITY_MEDIUM=16;B.TEXTURE_FILTERING_QUALITY_LOW=8;B.SCALEMODE_FLOOR=1;B.SCALEMODE_NEAREST=2;B.SCALEMODE_CEILING=3;B.MATERIAL_TextureDirtyFlag=1;B.MATERIAL_LightDirtyFlag=2;B.MATERIAL_FresnelDirtyFlag=4;B.MATERIAL_AttributesDirtyFlag=8;B.MATERIAL_MiscDirtyFlag=16;B.MATERIAL_PrePassDirtyFlag=32;B.MATERIAL_AllDirtyFlag=63;B.MATERIAL_TriangleFillMode=0;B.MATERIAL_WireFrameFillMode=1;B.MATERIAL_PointFillMode=2;B.MATERIAL_PointListDrawMode=3;B.MATERIAL_LineListDrawMode=4;B.MATERIAL_LineLoopDrawMode=5;B.MATERIAL_LineStripDrawMode=6;B.MATERIAL_TriangleStripDrawMode=7;B.MATERIAL_TriangleFanDrawMode=8;B.MATERIAL_ClockWiseSideOrientation=0;B.MATERIAL_CounterClockWiseSideOrientation=1;B.ACTION_NothingTrigger=0;B.ACTION_OnPickTrigger=1;B.ACTION_OnLeftPickTrigger=2;B.ACTION_OnRightPickTrigger=3;B.ACTION_OnCenterPickTrigger=4;B.ACTION_OnPickDownTrigger=5;B.ACTION_OnDoublePickTrigger=6;B.ACTION_OnPickUpTrigger=7;B.ACTION_OnPickOutTrigger=16;B.ACTION_OnLongPressTrigger=8;B.ACTION_OnPointerOverTrigger=9;B.ACTION_OnPointerOutTrigger=10;B.ACTION_OnEveryFrameTrigger=11;B.ACTION_OnIntersectionEnterTrigger=12;B.ACTION_OnIntersectionExitTrigger=13;B.ACTION_OnKeyDownTrigger=14;B.ACTION_OnKeyUpTrigger=15;B.PARTICLES_BILLBOARDMODE_Y=2;B.PARTICLES_BILLBOARDMODE_ALL=7;B.PARTICLES_BILLBOARDMODE_STRETCHED=8;B.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9;B.MESHES_CULLINGSTRATEGY_STANDARD=0;B.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;B.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;B.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;B.SCENELOADER_NO_LOGGING=0;B.SCENELOADER_MINIMAL_LOGGING=1;B.SCENELOADER_SUMMARY_LOGGING=2;B.SCENELOADER_DETAILED_LOGGING=3;B.PREPASS_IRRADIANCE_TEXTURE_TYPE=0;B.PREPASS_POSITION_TEXTURE_TYPE=1;B.PREPASS_VELOCITY_TEXTURE_TYPE=2;B.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3;B.PREPASS_COLOR_TEXTURE_TYPE=4;B.PREPASS_DEPTH_TEXTURE_TYPE=5;B.PREPASS_NORMAL_TEXTURE_TYPE=6;B.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7;B.BUFFER_CREATIONFLAG_READ=1;B.BUFFER_CREATIONFLAG_WRITE=2;B.BUFFER_CREATIONFLAG_READWRITE=3;B.BUFFER_CREATIONFLAG_UNIFORM=4;B.BUFFER_CREATIONFLAG_VERTEX=8;B.BUFFER_CREATIONFLAG_INDEX=16;B.BUFFER_CREATIONFLAG_STORAGE=32;B.RENDERPASS_MAIN=0;B.INPUT_ALT_KEY=18;B.INPUT_CTRL_KEY=17;B.INPUT_META_KEY1=91;B.INPUT_META_KEY2=92;B.INPUT_META_KEY3=93;B.INPUT_SHIFT_KEY=16;B.SNAPSHOTRENDERING_STANDARD=0;B.SNAPSHOTRENDERING_FAST=1;B.PERSPECTIVE_CAMERA=0;B.ORTHOGRAPHIC_CAMERA=1;B.FOVMODE_VERTICAL_FIXED=0;B.FOVMODE_HORIZONTAL_FIXED=1;B.RIG_MODE_NONE=0;B.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;B.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;B.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;B.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;B.RIG_MODE_STEREOSCOPIC_INTERLACED=14;B.RIG_MODE_VR=20;B.RIG_MODE_CUSTOM=22;B.MAX_SUPPORTED_UV_SETS=6;B.GL_ALPHA_EQUATION_ADD=32774;B.GL_ALPHA_EQUATION_MIN=32775;B.GL_ALPHA_EQUATION_MAX=32776;B.GL_ALPHA_EQUATION_SUBTRACT=32778;B.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779;B.GL_ALPHA_FUNCTION_SRC=768;B.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769;B.GL_ALPHA_FUNCTION_SRC_ALPHA=770;B.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771;B.GL_ALPHA_FUNCTION_DST_ALPHA=772;B.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773;B.GL_ALPHA_FUNCTION_DST_COLOR=774;B.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775;B.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776;B.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769;B.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770;B.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771;B.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772;B.SnippetUrl="https://snippet.babylonjs.com";var dn;(function(o){o[o.IDENTIFIER=1]="IDENTIFIER",o[o.UNKNOWN=2]="UNKNOWN",o[o.END_OF_INPUT=3]="END_OF_INPUT"})(dn||(dn={}));class yg{constructor(e){this._pos=0,this.currentToken=dn.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return dn.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=dn.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=dn.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const rE=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],nE=["world","view","projection","worldView","worldViewProjection","mBones"],GP=["translation","rotation","scale"],zP=["position","rotationQuaternion","scaling"],HP=(o,e)=>{for(const t in o){const i=o[t];e.buffers[t]=i,e.buffersCount++}},WP=(o,e)=>{for(const t in o){const i=o[t];e.shaders[t]=i,e.shaderscount++}},Qi=(o,e,t)=>{for(const i in o){const s=o[i];t[e][i]=s}},XP=o=>{if(o)for(let e=0;e<o.length/2;e++)o[e*2+1]=1-o[e*2+1]},Cg=o=>{if(o.semantic==="NORMAL")return"normal";if(o.semantic==="POSITION")return"position";if(o.semantic==="JOINT")return"matricesIndices";if(o.semantic==="WEIGHT")return"matricesWeights";if(o.semantic==="COLOR")return"color";if(o.semantic&&o.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(o.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},YP=o=>{for(const e in o.animations){const t=o.animations[e];if(!t.channels||!t.samplers)continue;let i=null;for(let s=0;s<t.channels.length;s++){const r=t.channels[s],n=t.samplers[r.sampler];if(!n)continue;let a=null,l=null;t.parameters?(a=t.parameters[n.input],l=t.parameters[n.output]):(a=n.input,l=n.output);const h=gi.GetBufferFromAccessor(o,o.accessors[a]),c=gi.GetBufferFromAccessor(o,o.accessors[l]),u=r.target.id;let d=o.scene.getNodeById(u);if(d===null&&(d=o.scene.getNodeByName(u)),d===null){Y.Warn("Creating animation named "+e+". But cannot find node named "+u+" to attach to");continue}const f=d instanceof vt;let p=r.target.path;const _=GP.indexOf(p);_!==-1&&(p=zP[_]);let g=W.ANIMATIONTYPE_MATRIX;f||(p==="rotationQuaternion"?(g=W.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new le):g=W.ANIMATIONTYPE_VECTOR3);let E=null;const R=[];let x=0,S=!1;f&&i&&i.getKeys().length===h.length&&(E=i,S=!0),S||(o.scene._blockEntityCollection=!!o.assetContainer,E=new W(e,f?"_matrix":p,1,g,W.ANIMATIONLOOPMODE_CYCLE),o.scene._blockEntityCollection=!1);for(let b=0;b<h.length;b++){let y=null;if(p==="rotationQuaternion"?(y=le.FromArray([c[x],c[x+1],c[x+2],c[x+3]]),x+=4):(y=m.FromArray([c[x],c[x+1],c[x+2]]),x+=3),f){const I=d;let O=m.Zero(),N=new le,w=m.Zero(),G=I.getBaseMatrix();S&&i&&(G=i.getKeys()[b].value),G.decompose(w,N,O),p==="position"?O=y:p==="rotationQuaternion"?N=y:w=y,y=L.Compose(w,N,O)}S?i&&(i.getKeys()[b].value=y):R.push({frame:h[b],value:y})}!S&&E&&(E.setKeys(R),d.animations.push(E)),i=E,o.scene.stopAnimation(d),o.scene.beginAnimation(d,0,h[h.length-1],!0,1)}}},Nf=o=>{let e=null;if(o.translation||o.rotation||o.scale){const t=m.FromArray(o.scale||[1,1,1]),i=le.FromArray(o.rotation||[0,0,0,1]),s=m.FromArray(o.translation||[0,0,0]);e=L.Compose(t,i,s)}else e=L.FromArray(o.matrix);return e},aE=(o,e,t,i)=>{for(let r=0;r<i.bones.length;r++)if(i.bones[r].name===t)return i.bones[r];const s=o.nodes;for(const r in s){const n=s[r];if(!n.jointName)continue;const a=n.children;for(let l=0;l<a.length;l++){const h=o.nodes[a[l]];if(h.jointName&&h.jointName===t){const c=Nf(n),u=new vt(n.name||"",i,aE(o,e,n.jointName,i),c);return u.id=r,u}}}return null},KP=(o,e)=>{for(let t=0;t<o.length;t++){const i=o[t];for(let s=0;s<i.node.children.length;s++)if(i.node.children[s]===e)return i.bone}return null},od=(o,e)=>{const t=o.nodes;let i=t[e];if(i)return{node:i,id:e};for(const s in t)if(i=t[s],i.jointName===e)return{node:i,id:s};return null},$P=(o,e)=>{for(let t=0;t<o.jointNames.length;t++)if(o.jointNames[t]===e)return!0;return!1},jP=(o,e,t,i)=>{for(const s in o.nodes){const r=o.nodes[s],n=s;if(!r.jointName||$P(t,r.jointName))continue;const a=Nf(r),l=new vt(r.name||"",e,null,a);l.id=n,i.push({bone:l,node:r,id:n})}for(let s=0;s<i.length;s++){const r=i[s],n=r.node.children;for(let a=0;a<n.length;a++){let l=null;for(let h=0;h<i.length;h++)if(i[h].id===n[a]){l=i[h];break}l&&(l.bone._parent=r.bone,r.bone.children.push(l.bone))}}},qP=(o,e,t,i)=>{if(i||(i=new so(e.name||"","",o.scene)),!e.babylonSkeleton)return i;const s=[],r=[];jP(o,i,e,s),i.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=od(o,e.jointNames[a]);if(!l)continue;const h=l.node;if(!h){Y.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}const c=l.id,u=o.scene.getBoneById(c);if(u){i.bones.push(u);continue}let d=!1,f=null;for(let g=0;g<a;g++){const E=od(o,e.jointNames[g]);if(!E)continue;const R=E.node;if(!R){Y.Warn("Joint named "+e.jointNames[g]+" does not exist when looking for parent");continue}const x=R.children;if(x){d=!1;for(let S=0;S<x.length;S++)if(x[S]===c){f=aE(o,e,e.jointNames[g],i),d=!0;break}if(d)break}}const p=Nf(h);!f&&s.length>0&&(f=KP(s,c),f&&r.indexOf(f)===-1&&r.push(f));const _=new vt(h.jointName||"",i,f,p);_.id=c}const n=i.bones;i.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=od(o,e.jointNames[a]);if(l){for(let h=0;h<n.length;h++)if(n[h].id===l.id){i.bones.push(n[h]);break}}}i.prepare();for(let a=0;a<r.length;a++)i.bones.push(r[a]);return i},xg=(o,e,t,i,s)=>{if(s||(o.scene._blockEntityCollection=!!o.assetContainer,s=new re(e.name||"",o.scene),s._parentContainer=o.assetContainer,o.scene._blockEntityCollection=!1,s.id=i),!e.babylonNode)return s;const r=[];let n=null;const a=[],l=[],h=[],c=[];for(let f=0;f<t.length;f++){const p=t[f],_=o.meshes[p];if(_)for(let g=0;g<_.primitives.length;g++){const E=new fe,R=_.primitives[g];R.mode;const x=R.attributes;let S=null,b=null;for(const I in x)if(S=o.accessors[x[I]],b=gi.GetBufferFromAccessor(o,S),I==="NORMAL")E.normals=new Float32Array(b.length),E.normals.set(b);else if(I==="POSITION"){if(Kt.HomogeneousCoordinates){E.positions=new Float32Array(b.length-b.length/4);for(let O=0;O<b.length;O+=4)E.positions[O]=b[O],E.positions[O+1]=b[O+1],E.positions[O+2]=b[O+2]}else E.positions=new Float32Array(b.length),E.positions.set(b);l.push(E.positions.length)}else if(I.indexOf("TEXCOORD_")!==-1){const O=Number(I.split("_")[1]),N=T.UVKind+(O===0?"":O+1),w=new Float32Array(b.length);w.set(b),XP(w),E.set(w,N)}else I==="JOINT"?(E.matricesIndices=new Float32Array(b.length),E.matricesIndices.set(b)):I==="WEIGHT"?(E.matricesWeights=new Float32Array(b.length),E.matricesWeights.set(b)):I==="COLOR"&&(E.colors=new Float32Array(b.length),E.colors.set(b));if(S=o.accessors[R.indices],S)b=gi.GetBufferFromAccessor(o,S),E.indices=new Int32Array(b.length),E.indices.set(b),c.push(E.indices.length);else{const I=[];for(let O=0;O<E.positions.length/3;O++)I.push(O);E.indices=new Int32Array(I),c.push(E.indices.length)}n?n.merge(E):n=E;const y=o.scene.getMaterialById(R.material);r.push(y===null?gi.GetDefaultMaterial(o.scene):y),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),h.push(h.length===0?0:h[h.length-1]+c[c.length-2])}}let u;o.scene._blockEntityCollection=!!o.assetContainer,r.length>1?(u=new aa("multimat"+i,o.scene),u.subMaterials=r):u=new oe("multimat"+i,o.scene),r.length===1&&(u=r[0]),u._parentContainer=o.assetContainer,s.material||(s.material=u),new Ai(i,o.scene,n,!1,s),s.computeWorldMatrix(!0),o.scene._blockEntityCollection=!1,s.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){const p=t[f],_=o.meshes[p];if(_)for(let g=0;g<_.primitives.length;g++)_.primitives[g].mode,Ps.AddToMesh(d,a[d],l[d],h[d],c[d],s,s,!0),d++}return s},Dd=(o,e,t,i)=>{o.position&&(o.position=e),(o.rotationQuaternion||o.rotation)&&(o.rotationQuaternion=t),o.scaling&&(o.scaling=i)},ZP=(o,e)=>{if(e.matrix){const t=new m(0,0,0),i=new le,s=new m(0,0,0);L.FromArray(e.matrix).decompose(s,i,t),Dd(o,t,i,s)}else e.translation&&e.rotation&&e.scale&&Dd(o,m.FromArray(e.translation),le.FromArray(e.rotation),m.FromArray(e.scale));o.computeWorldMatrix(!0)},QP=(o,e,t)=>{let i=null;if(o.importOnlyMeshes&&(e.skin||e.meshes)&&o.importMeshesNames&&o.importMeshesNames.length>0&&o.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const s=o.skins[e.skin],r=xg(o,e,e.meshes,t,e.babylonNode);r.skeleton=o.scene.getLastSkeletonById(e.skin),r.skeleton===null&&(r.skeleton=qP(o,s,r,s.babylonSkeleton),s.babylonSkeleton||(s.babylonSkeleton=r.skeleton)),i=r}}else if(e.meshes)i=xg(o,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!o.importOnlyMeshes){const s=o.lights[e.light];if(s){if(s.type==="ambient"){const r=s[s.type],n=new Dn(e.light,m.Zero(),o.scene);n.name=e.name||"",r.color&&(n.diffuse=J.FromArray(r.color)),i=n}else if(s.type==="directional"){const r=s[s.type],n=new bs(e.light,m.Zero(),o.scene);n.name=e.name||"",r.color&&(n.diffuse=J.FromArray(r.color)),i=n}else if(s.type==="point"){const r=s[s.type],n=new Rl(e.light,m.Zero(),o.scene);n.name=e.name||"",r.color&&(n.diffuse=J.FromArray(r.color)),i=n}else if(s.type==="spot"){const r=s[s.type],n=new es(e.light,m.Zero(),m.Zero(),0,0,o.scene);n.name=e.name||"",r.color&&(n.diffuse=J.FromArray(r.color)),r.fallOfAngle&&(n.angle=r.fallOfAngle),r.fallOffExponent&&(n.exponent=r.fallOffExponent),i=n}}}else if(e.camera&&!e.babylonNode&&!o.importOnlyMeshes){const s=o.cameras[e.camera];if(s){if(o.scene._blockEntityCollection=!!o.assetContainer,s.type==="orthographic"){const r=new oa(e.camera,m.Zero(),o.scene,!1);r.name=e.name||"",r.mode=De.ORTHOGRAPHIC_CAMERA,r.attachControl(),i=r,r._parentContainer=o.assetContainer}else if(s.type==="perspective"){const r=s[s.type],n=new oa(e.camera,m.Zero(),o.scene,!1);n.name=e.name||"",n.attachControl(),r.aspectRatio||(r.aspectRatio=o.scene.getEngine().getRenderWidth()/o.scene.getEngine().getRenderHeight()),r.znear&&r.zfar&&(n.maxZ=r.zfar,n.minZ=r.znear),i=n,n._parentContainer=o.assetContainer}o.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(i===null){o.scene._blockEntityCollection=!!o.assetContainer;const s=new re(e.name||"",o.scene);s._parentContainer=o.assetContainer,o.scene._blockEntityCollection=!1,e.babylonNode=s,i=s}}if(i!==null){if(e.matrix&&i instanceof re)ZP(i,e);else{const s=e.translation||[0,0,0],r=e.rotation||[0,0,0,1],n=e.scale||[1,1,1];Dd(i,m.FromArray(s),le.FromArray(r),m.FromArray(n))}i.updateCache(!0),e.babylonNode=i}return i},Eh=(o,e,t,i=!1)=>{const s=o.nodes[e];let r=null;if(o.importOnlyMeshes&&!i&&o.importMeshesNames?o.importMeshesNames.indexOf(s.name||"")!==-1||o.importMeshesNames.length===0?i=!0:i=!1:i=!0,!s.jointName&&i&&(r=QP(o,s,e),r!==null&&(r.id=e,r.parent=t)),s.children)for(let n=0;n<s.children.length;n++)Eh(o,s.children[n],r,i)},Mg=o=>{let e=o.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)Eh(o,e.nodes[t],null);else for(const t in o.scenes){e=o.scenes[t];for(let i=0;i<e.nodes.length;i++)Eh(o,e.nodes[i],null)}YP(o);for(let t=0;t<o.scene.skeletons.length;t++){const i=o.scene.skeletons[t];o.scene.beginAnimation(i,0,Number.MAX_VALUE,!0,1)}},JP=(o,e,t,i,s,r,n)=>{const a=r.values||s.parameters;for(const l in t){const h=t[l],c=h.type;if(c===os.FLOAT_MAT2||c===os.FLOAT_MAT3||c===os.FLOAT_MAT4){if(h.semantic&&!h.source&&!h.node)gi.SetMatrix(e.scene,o,h,l,i.getEffect());else if(h.semantic&&(h.source||h.node)){let u=e.scene.getNodeByName(h.source||h.node||"");if(u===null&&(u=e.scene.getNodeById(h.source||h.node||"")),u===null)continue;gi.SetMatrix(e.scene,u,h,l,i.getEffect())}}else{const u=a[s.uniforms[l]];if(!u)continue;if(c===os.SAMPLER_2D){const d=e.textures[r.values?u:h.value].babylonTexture;if(d==null)continue;i.getEffect().setTexture(l,d)}else gi.SetUniform(i.getEffect(),l,u,c)}}n(i)},eD=(o,e,t,i,s)=>{const r=i.values||t.parameters,n=t.uniforms;for(const a in s){const l=s[a],h=l.type;let c=r[n[a]];if(c===void 0&&(c=l.value),!c)continue;const u=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete s[d])};h===os.SAMPLER_2D?Li.LoadTextureAsync(o,i.values?c:l.value,u(a),()=>u(null)):l.value&&gi.SetUniform(e,a,i.values?c:l.value,h)&&delete s[a]}},tD=(o,e,t)=>(i,s)=>{e.dispose(!0),t("Cannot compile program named "+o.name+". Error: "+s+". Default material will be applied")},iD=(o,e,t,i,s,r)=>n=>{eD(o,e,t,i,s),e.onBind=a=>{JP(a,o,s,e,t,i,r)}},Ig=(o,e,t)=>{for(const i in e.uniforms){const s=e.uniforms[i],r=e.parameters[s];if(o.currentIdentifier===i&&r.semantic&&!r.source&&!r.node){const n=rE.indexOf(r.semantic);if(n!==-1)return delete t[i],nE[n]}}return o.currentIdentifier},Pg=o=>{for(const e in o.materials)Li.LoadMaterialAsync(o,e,()=>{},()=>{})};class Fr{static CreateRuntime(e,t,i){const s={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&Qi(e.extensions,"extensions",s),e.extensionsUsed&&Qi(e.extensionsUsed,"extensionsUsed",s),e.buffers&&HP(e.buffers,s),e.bufferViews&&Qi(e.bufferViews,"bufferViews",s),e.accessors&&Qi(e.accessors,"accessors",s),e.meshes&&Qi(e.meshes,"meshes",s),e.lights&&Qi(e.lights,"lights",s),e.cameras&&Qi(e.cameras,"cameras",s),e.nodes&&Qi(e.nodes,"nodes",s),e.images&&Qi(e.images,"images",s),e.textures&&Qi(e.textures,"textures",s),e.shaders&&WP(e.shaders,s),e.programs&&Qi(e.programs,"programs",s),e.samplers&&Qi(e.samplers,"samplers",s),e.techniques&&Qi(e.techniques,"techniques",s),e.materials&&Qi(e.materials,"materials",s),e.animations&&Qi(e.animations,"animations",s),e.skins&&Qi(e.skins,"skins",s),e.scenes&&(s.scenes=e.scenes),e.scene&&e.scenes&&(s.currentScene=e.scenes[e.scene]),s}static LoadBufferAsync(e,t,i,s,r){const n=e.buffers[t];Y.IsBase64(n.uri)?setTimeout(()=>i(new Uint8Array(Y.DecodeBase64(n.uri)))):Y.LoadFile(e.rootUrl+n.uri,a=>i(new Uint8Array(a)),r,void 0,!0,a=>{a&&s(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,i,s){const r=e.textures[t];if(!r||!r.source){s("");return}if(r.babylonTexture){i(null);return}const n=e.images[r.source];Y.IsBase64(n.uri)?setTimeout(()=>i(new Uint8Array(Y.DecodeBase64(n.uri)))):Y.LoadFile(e.rootUrl+n.uri,a=>i(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&s(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,i,s){const r=e.textures[t];if(r.babylonTexture){s(r.babylonTexture);return}const n=e.samplers[r.sampler],a=n.minFilter===Js.NEAREST_MIPMAP_NEAREST||n.minFilter===Js.NEAREST_MIPMAP_LINEAR||n.minFilter===Js.LINEAR_MIPMAP_NEAREST||n.minFilter===Js.LINEAR_MIPMAP_LINEAR,l=V.BILINEAR_SAMPLINGMODE,h=i==null?new Blob:new Blob([i]),c=URL.createObjectURL(h),u=()=>URL.revokeObjectURL(c),d=new V(c,e.scene,!a,!0,l,u,u);n.wrapS!==void 0&&(d.wrapU=gi.GetWrapMode(n.wrapS)),n.wrapT!==void 0&&(d.wrapV=gi.GetWrapMode(n.wrapT)),d.name=t,r.babylonTexture=d,s(d)}static LoadShaderStringAsync(e,t,i,s){const r=e.shaders[t];if(Y.IsBase64(r.uri)){const n=atob(r.uri.split(",")[1]);i&&i(n)}else Y.LoadFile(e.rootUrl+r.uri,i,void 0,void 0,!1,n=>{n&&s&&s(n.status+" "+n.statusText)})}static LoadMaterialAsync(e,t,i,s){const r=e.materials[t];if(!r.technique){s&&s("No technique found.");return}const n=e.techniques[r.technique];if(!n){e.scene._blockEntityCollection=!!e.assetContainer;const y=new oe(t,e.scene);y._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,y.diffuseColor=new J(.5,.5,.5),y.sideOrientation=Q.CounterClockWiseSideOrientation,i(y);return}const a=e.programs[n.program],l=n.states,h=ai.ShadersStore[a.vertexShader+"VertexShader"],c=ai.ShadersStore[a.fragmentShader+"PixelShader"];let u="",d="";const f=new yg(h),p=new yg(c),_={},g=[],E=[],R=[];for(const y in n.uniforms){const I=n.uniforms[y],O=n.parameters[I];if(_[y]=O,O.semantic&&!O.node&&!O.source){const N=rE.indexOf(O.semantic);N!==-1?(g.push(nE[N]),delete _[y]):g.push(y)}else O.type===os.SAMPLER_2D?R.push(y):g.push(y)}for(const y in n.attributes){const I=n.attributes[y],O=n.parameters[I];if(O.semantic){const N=Cg(O);N&&E.push(N)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==dn.IDENTIFIER){u+=f.currentString;continue}let I=!1;for(const O in n.attributes){const N=n.attributes[O],w=n.parameters[N];if(f.currentIdentifier===O&&w.semantic){u+=Cg(w),I=!0;break}}I||(u+=Ig(f,n,_))}for(;!p.isEnd()&&p.getNextToken();){if(p.currentToken!==dn.IDENTIFIER){d+=p.currentString;continue}d+=Ig(p,n,_)}const x={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},S={attributes:E,uniforms:g,samplers:R,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};ai.ShadersStore[a.vertexShader+t+"VertexShader"]=u,ai.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;const b=new Rs(t,e.scene,x,S);if(b.onError=tD(a,b,s),b.onCompiled=iD(e,b,n,r,_,i),b.sideOrientation=Q.CounterClockWiseSideOrientation,l&&l.functions){const y=l.functions;y.cullFace&&y.cullFace[0]!==Pd.BACK&&(b.backFaceCulling=!1);const I=y.blendFuncSeparate;I&&(I[0]===ri.SRC_ALPHA&&I[1]===ri.ONE_MINUS_SRC_ALPHA&&I[2]===ri.ONE&&I[3]===ri.ONE?b.alphaMode=B.ALPHA_COMBINE:I[0]===ri.ONE&&I[1]===ri.ONE&&I[2]===ri.ZERO&&I[3]===ri.ONE?b.alphaMode=B.ALPHA_ONEONE:I[0]===ri.SRC_ALPHA&&I[1]===ri.ONE&&I[2]===ri.ZERO&&I[3]===ri.ONE?b.alphaMode=B.ALPHA_ADD:I[0]===ri.ZERO&&I[1]===ri.ONE_MINUS_SRC_COLOR&&I[2]===ri.ONE&&I[3]===ri.ONE?b.alphaMode=B.ALPHA_SUBTRACT:I[0]===ri.DST_COLOR&&I[1]===ri.ZERO&&I[2]===ri.ONE&&I[3]===ri.ONE?b.alphaMode=B.ALPHA_MULTIPLY:I[0]===ri.SRC_ALPHA&&I[1]===ri.ONE_MINUS_SRC_COLOR&&I[2]===ri.ONE&&I[3]===ri.ONE&&(b.alphaMode=B.ALPHA_MAXIMIZED))}}}let ro=class Od{static RegisterExtension(e){if(Od.Extensions[e.name]){Y.Error('Tool with the same name "'+e.name+'" already exists');return}Od.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,i,s,r,n,a,l){return t.useRightHandedSystem=!0,Li.LoadRuntimeAsync(t,i,s,h=>{h.assetContainer=r,h.importOnlyMeshes=!0,e===""?h.importMeshesNames=[]:typeof e=="string"?h.importMeshesNames=[e]:e&&!(e instanceof Array)?h.importMeshesNames=[e]:(h.importMeshesNames=[],Y.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(h);const c=[],u=[];for(const d in h.nodes){const f=h.nodes[d];f.babylonNode instanceof pi&&c.push(f.babylonNode)}for(const d in h.skins){const f=h.skins[d];f.babylonSkeleton instanceof so&&u.push(f.babylonSkeleton)}this._loadBuffersAsync(h,()=>{this._loadShadersAsync(h,()=>{Pg(h),Mg(h),!Kt.IncrementalLoading&&n&&n(c,u)})}),Kt.IncrementalLoading&&n&&n(c,u)},l),!0}importMeshAsync(e,t,i,s,r,n){return new Promise((a,l)=>{this._importMeshAsync(e,t,s,r,i,(h,c)=>{a({meshes:h,particleSystems:[],skeletons:c,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},n,h=>{l(new Error(h))})})}_loadAsync(e,t,i,s,r,n){e.useRightHandedSystem=!0,Li.LoadRuntimeAsync(e,t,i,a=>{Li.LoadRuntimeExtensionsAsync(a,()=>{this._createNodes(a),this._loadBuffersAsync(a,()=>{this._loadShadersAsync(a,()=>{Pg(a),Mg(a),Kt.IncrementalLoading||s()})}),Kt.IncrementalLoading&&s()},n)},n)}loadAsync(e,t,i,s){return new Promise((r,n)=>{this._loadAsync(e,t,i,()=>{r()},s,a=>{n(new Error(a))})})}_loadShadersAsync(e,t){let i=!1;const s=(r,n)=>{Li.LoadShaderStringAsync(e,r,a=>{a instanceof ArrayBuffer||(e.loadedShaderCount++,a&&(ai.ShadersStore[r+(n.type===Id.VERTEX?"VertexShader":"PixelShader")]=a),e.loadedShaderCount===e.shaderscount&&t())},()=>{Y.Error("Error when loading shader program named "+r+" located at "+n.uri)})};for(const r in e.shaders){i=!0;const n=e.shaders[r];n?s.bind(this,r,n)():Y.Error("No shader named: "+r)}i||t()}_loadBuffersAsync(e,t){let i=!1;const s=(r,n)=>{Li.LoadBufferAsync(e,r,a=>{e.loadedBufferCount++,a&&(a.byteLength!=e.buffers[r].byteLength&&Y.Error("Buffer named "+r+" is length "+a.byteLength+". Expected: "+n.byteLength),e.loadedBufferViews[r]=a),e.loadedBufferCount===e.buffersCount&&t()},()=>{Y.Error("Error when loading buffer named "+r+" located at "+n.uri)})};for(const r in e.buffers){i=!0;const n=e.buffers[r];n?s.bind(this,r,n)():Y.Error("No buffer named: "+r)}i||t()}_createNodes(e){let t=e.currentScene;if(t)for(let i=0;i<t.nodes.length;i++)Eh(e,t.nodes[i],null);else for(const i in e.scenes){t=e.scenes[i];for(let s=0;s<t.nodes.length;s++)Eh(e,t.nodes[s],null)}}};ro.Extensions={};class Li{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,i,s,r){return!1}loadRuntimeExtensionsAsync(e,t,i){return!1}loadBufferAsync(e,t,i,s,r){return!1}loadTextureBufferAsync(e,t,i,s){return!1}createTextureAsync(e,t,i,s,r){return!1}loadShaderStringAsync(e,t,i,s){return!1}loadMaterialAsync(e,t,i,s){return!1}static LoadRuntimeAsync(e,t,i,s,r){Li._ApplyExtensions(n=>n.loadRuntimeAsync(e,t,i,s,r),()=>{setTimeout(()=>{s&&s(Fr.CreateRuntime(t.json,e,i))})})}static LoadRuntimeExtensionsAsync(e,t,i){Li._ApplyExtensions(s=>s.loadRuntimeExtensionsAsync(e,t,i),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,i,s,r){Li._ApplyExtensions(n=>n.loadBufferAsync(e,t,i,s,r),()=>{Fr.LoadBufferAsync(e,t,i,s,r)})}static LoadTextureAsync(e,t,i,s){Li._LoadTextureBufferAsync(e,t,r=>{r&&Li._CreateTextureAsync(e,t,r,i,s)},s)}static LoadShaderStringAsync(e,t,i,s){Li._ApplyExtensions(r=>r.loadShaderStringAsync(e,t,i,s),()=>{Fr.LoadShaderStringAsync(e,t,i,s)})}static LoadMaterialAsync(e,t,i,s){Li._ApplyExtensions(r=>r.loadMaterialAsync(e,t,i,s),()=>{Fr.LoadMaterialAsync(e,t,i,s)})}static _LoadTextureBufferAsync(e,t,i,s){Li._ApplyExtensions(r=>r.loadTextureBufferAsync(e,t,i,s),()=>{Fr.LoadTextureBufferAsync(e,t,i,s)})}static _CreateTextureAsync(e,t,i,s,r){Li._ApplyExtensions(n=>n.createTextureAsync(e,t,i,s,r),()=>{Fr.CreateTextureAsync(e,t,i,s)})}static _ApplyExtensions(e,t){for(const i in ro.Extensions){const s=ro.Extensions[i];if(e(s))return}t()}}Kt._CreateGLTF1Loader=()=>new ro;const sD="binary_glTF";class rD extends Li{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,i,s){const r=t.json.extensionsUsed;return!r||r.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,s(Fr.CreateRuntime(t.json,e,i)),!0)}loadBufferAsync(e,t,i,s){return e.extensionsUsed.indexOf(this.name)===-1||t!==sD?!1:(this._bin.readAsync(0,this._bin.byteLength).then(i,r=>s(r.message)),!0)}loadTextureBufferAsync(e,t,i){const s=e.textures[t],r=e.images[s.source];if(!r.extensions||!(this.name in r.extensions))return!1;const n=r.extensions[this.name],a=e.bufferViews[n.bufferView],l=gi.GetBufferFromBufferView(e,a,0,a.byteLength,un.UNSIGNED_BYTE);return i(l),!0}loadShaderStringAsync(e,t,i){const s=e.shaders[t];if(!s.extensions||!(this.name in s.extensions))return!1;const r=s.extensions[this.name],n=e.bufferViews[r.bufferView],a=gi.GetBufferFromBufferView(e,n,0,n.byteLength,un.UNSIGNED_BYTE);return setTimeout(()=>{const l=gi.DecodeBufferToText(a);i(l)}),!0}}ro.RegisterExtension(new rD);class nD extends Li{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const i=t.lights;if(i)for(const s in i){const r=i[s];switch(r.type){case"ambient":{const n=new Dn(r.name,new m(0,1,0),e.scene),a=r.ambient;a&&(n.diffuse=J.FromArray(a.color||[1,1,1]));break}case"point":{const n=new Rl(r.name,new m(10,10,10),e.scene),a=r.point;a&&(n.diffuse=J.FromArray(a.color||[1,1,1]));break}case"directional":{const n=new bs(r.name,new m(0,-1,0),e.scene),a=r.directional;a&&(n.diffuse=J.FromArray(a.color||[1,1,1]));break}case"spot":{const n=r.spot;if(n){const a=new es(r.name,new m(0,10,0),new m(0,-1,0),n.fallOffAngle||Math.PI,n.fallOffExponent||0,e.scene);a.diffuse=J.FromArray(n.color||[1,1,1])}break}default:Y.Warn('GLTF Material Common extension: light type "'+r.type+"” not supported");break}}return!1}loadMaterialAsync(e,t,i,s){const r=e.materials[t];if(!r||!r.extensions)return!1;const n=r.extensions[this.name];if(!n)return!1;const a=new oe(t,e.scene);return a.sideOrientation=Q.CounterClockWiseSideOrientation,n.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=n.doubleSided===void 0?!1:!n.doubleSided,a.alpha=n.values.transparency===void 0?1:n.values.transparency,a.specularPower=n.values.shininess===void 0?0:n.values.shininess,typeof n.values.ambient=="string"?this._loadTexture(e,n.values.ambient,a,"ambientTexture",s):a.ambientColor=J.FromArray(n.values.ambient||[0,0,0]),typeof n.values.diffuse=="string"?this._loadTexture(e,n.values.diffuse,a,"diffuseTexture",s):a.diffuseColor=J.FromArray(n.values.diffuse||[0,0,0]),typeof n.values.emission=="string"?this._loadTexture(e,n.values.emission,a,"emissiveTexture",s):a.emissiveColor=J.FromArray(n.values.emission||[0,0,0]),typeof n.values.specular=="string"?this._loadTexture(e,n.values.specular,a,"specularTexture",s):a.specularColor=J.FromArray(n.values.specular||[0,0,0]),!0}_loadTexture(e,t,i,s,r){Fr.LoadTextureBufferAsync(e,t,n=>{Fr.CreateTextureAsync(e,t,n,a=>i[s]=a)},r)}}ro.RegisterExtension(new nD);class eh{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}class sa{get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new j,this._onDataLayoutChanged=new j,this._animationPropertiesOverride=null,this._scene=i||Ze.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=Le.Clone(()=>new sa(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),Le.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new sa(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let s=0;s<e.animations.length;s++){const r=e.animations[s],n=Gr("BABYLON.Animation");n&&i.animations.push(n.Parse(r))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const s=new sa(t,i,e.getScene());return s.setPositions(e.getVerticesData(T.PositionKind)),e.isVerticesDataPresent(T.NormalKind)&&s.setNormals(e.getVerticesData(T.NormalKind)),e.isVerticesDataPresent(T.TangentKind)&&s.setTangents(e.getVerticesData(T.TangentKind)),e.isVerticesDataPresent(T.UVKind)&&s.setUVs(e.getVerticesData(T.UVKind)),s}}v([M()],sa.prototype,"id",void 0);class Lf extends V{get depth(){return this._depth}constructor(e,t,i,s,r,n,a=!0,l=!1,h=V.TRILINEAR_SAMPLINGMODE,c=0,u){super(null,n,!a,l),this.format=r,this._texture=n.getEngine().createRawTexture2DArray(e,t,i,s,r,a,l,h,null,c,u),this._depth=s,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,s,r,n=!0,a=!1,l=3,h=0){return new Lf(e,t,i,s,5,r,n,a,l,h)}}class fn{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new li(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=Ze.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){var e;return fn.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!(!((e=this._scene)===null||e===void 0)&&e.getEngine().getCaps().disableMorphTargetTexture)}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new fn(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const s of this._targets){if(i++,s.influence===0&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=fn.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(s),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=s.influence,this._supportsNormals=this._supportsNormals&&s.hasNormals,this._supportsTangents=this._supportsTangents&&s.hasTangents,this._supportsUVs=this._supportsUVs&&s.hasUVs;const r=s.getPositions();if(r){const n=r.length/3;if(this._vertexCount===0)this._vertexCount=n;else if(this._vertexCount!==n){q.Error("Incompatible target. Targets must all have the same vertices count.");return}}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(let s=0;s<t;s++)this._influences[s]=this._tempInfluences[s];e&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const i=this._targetStoreTexture.getSize();i.width===this._textureWidth&&i.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const i=this._targets.length,s=new Float32Array(i*this._textureWidth*this._textureHeight*4);let r=0;for(let n=0;n<i;n++){const a=this._targets[n],l=a.getPositions(),h=a.getNormals(),c=a.getUVs(),u=a.getTangents();if(!l){n===0&&q.Error("Invalid morph target. Target must have positions.");return}r=n*this._textureWidth*this._textureHeight*4;for(let d=0;d<this._vertexCount;d++)s[r]=l[d*3],s[r+1]=l[d*3+1],s[r+2]=l[d*3+2],r+=4,this._supportsNormals&&h&&(s[r]=h[d*3],s[r+1]=h[d*3+1],s[r+2]=h[d*3+2],r+=4),this._supportsUVs&&c&&(s[r]=c[d*2],s[r+1]=c[d*2+1],r+=4),this._supportsTangents&&u&&(s[r]=u[d*3],s[r+1]=u[d*3+1],s[r+2]=u[d*3+2],r+=4)}this._targetStoreTexture=Lf.CreateRGBATexture(s,this._textureWidth,this._textureHeight,i,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(const e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){const i=new fn(t);i._uniqueId=e.id;for(const s of e.targets)i.addTarget(sa.Parse(s,t));return i}}fn.EnableTextureStorage=!0;fn.MaxActiveMorphTargetsInVertexAttributeMode=8;function Dg(o,e,t,i){return m.FromArray(e,t).scaleInPlace(i)}function aD(o,e,t,i){return le.FromArray(e,t).scaleInPlace(i)}function oD(o,e,t,i){const s=new Array(o._numMorphTargets);for(let r=0;r<s.length;r++)s[r]=e[t++]*i;return s}class Nh{constructor(e,t,i,s){this.type=e,this.name=t,this.getValue=i,this.getStride=s}_buildAnimation(e,t,i){const s=new W(e,this.name,t,this.type);return s.setKeys(i),s}}class ld extends Nh{buildAnimations(e,t,i,s,r){r(e._babylonTransformNode,this._buildAnimation(t,i,s))}}class lD extends Nh{buildAnimations(e,t,i,s,r){if(e._numMorphTargets)for(let n=0;n<e._numMorphTargets;n++){const a=new W(`${t}_${n}`,this.name,i,this.type);if(a.setKeys(s.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[n]:void 0,value:l.value[n],outTangent:l.outTangent?l.outTangent[n]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const h=l.morphTargetManager.getTarget(n),c=a.clone();h.animations.push(c),r(h,c)}}}}}const th={translation:[new ld(W.ANIMATIONTYPE_VECTOR3,"position",Dg,()=>3)],rotation:[new ld(W.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",aD,()=>4)],scale:[new ld(W.ANIMATIONTYPE_VECTOR3,"scaling",Dg,()=>3)],weights:[new lD(W.ANIMATIONTYPE_FLOAT,"influence",oD,o=>o._numMorphTargets)]};function oE(...o){const e=t=>t&&typeof t=="object";return o.reduce((t,i)=>(Object.keys(i).forEach(s=>{const r=t[s],n=i[s];Array.isArray(r)&&Array.isArray(n)?t[s]=r.concat(...n):e(r)&&e(n)?t[s]=oE(r,n):t[s]=n}),t),{})}class Ye{static Get(e,t,i){if(!t||i==null||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class Ae{static RegisterExtension(e,t){Ae.UnregisterExtension(e)&&q.Warn(`Extension with the name '${e}' already exists`),Ae._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return Ae._RegisteredExtensions[e]?(delete Ae._RegisteredExtensions[e],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,i,s,r,n,a=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=i,this._loadData(s);let l=null;if(e){const h={};if(this._gltf.nodes)for(const u of this._gltf.nodes)u.name&&(h[u.name]=u.index);l=(e instanceof Array?e:[e]).map(u=>{const d=h[u];if(d===void 0)throw new Error(`Failed to find node '${u}'`);return d})}return this._loadAsync(r,a,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(e,t,i,s,r=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(i,r,null,()=>{})))}_loadAsync(e,t,i,s){return Promise.resolve().then(()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,this._loadExtensions(),this._checkExtensions();const r=`${Es[Es.LOADING]} => ${Es[Es.READY]}`,n=`${Es[Es.LOADING]} => ${Es[Es.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(n),this._parent._setState(Es.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(i)a.push(this.loadSceneAsync("/nodes",{nodes:i,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const c=Ye.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${c.index}`,c))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let c=0;c<this._gltf.materials.length;++c){const u=this._gltf.materials[c],d="/materials/"+c,f=Q.TriangleFillMode;a.push(this._loadMaterialAsync(d,u,null,f,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync()),Promise.all(a).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(Es.READY),this._startAnimations(),s())).then(c=>(this._parent._endPerformanceCounter(r),Y.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(n),this._parent._setState(Es.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},u=>{this._parent.onErrorObservable.notifyObservers(u),this._parent.onErrorObservable.clear(),this.dispose()})}),c))}).catch(r=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(r),this._parent.onErrorObservable.clear(),this.dispose()),r})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const i=t[0];(i.byteLength<e.bin.byteLength-3||i.byteLength>e.bin.byteLength)&&q.Warn(`Binary buffer length (${i.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else q.Warn("Unexpected BIN chunk")}}_setupData(){if(Ye.Assign(this._gltf.accessors),Ye.Assign(this._gltf.animations),Ye.Assign(this._gltf.buffers),Ye.Assign(this._gltf.bufferViews),Ye.Assign(this._gltf.cameras),Ye.Assign(this._gltf.images),Ye.Assign(this._gltf.materials),Ye.Assign(this._gltf.meshes),Ye.Assign(this._gltf.nodes),Ye.Assign(this._gltf.samplers),Ye.Assign(this._gltf.scenes),Ye.Assign(this._gltf.skins),Ye.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const i of this._gltf.nodes)if(i.children)for(const s of i.children)e[s]=i.index;const t=this._createRootNode();for(const i of this._gltf.nodes){const s=e[i.index];i.parent=s===void 0?t:this._gltf.nodes[s]}}}_loadExtensions(){for(const e in Ae._RegisteredExtensions){const t=Ae._RegisteredExtensions[e].factory(this);t.name!==e&&q.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(i=>i.name===e&&i.enabled))throw new Error(`Required extension ${e} is not available`)}}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new re("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case mh.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],Ae._LoadTransform(e,this._rootBabylonMesh));break}case mh.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const i=this._extensionsLoadSceneAsync(e,t);if(i)return i;const s=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const r of t.nodes){const n=Ye.Get(`${e}/nodes/${r}`,this._gltf.nodes,r);s.push(this.loadNodeAsync(`/nodes/${n.index}`,n,a=>{a.parent=this._rootBabylonMesh}))}for(const r of this._postSceneLoadActions)r();return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const i of e._primitiveBabylonMeshes)t(i)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,s=>{const r=s.geometry;r&&e.indexOf(r)===-1&&e.push(r)});return e}_getMeshes(){const e=[];this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const i of t)this._forEachPrimitive(i,s=>{e.push(s)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const i of t)i._babylonTransformNode&&i._babylonTransformNode.getClassName()==="TransformNode"&&e.push(i._babylonTransformNode),i._babylonTransformNodeForSkin&&e.push(i._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const i of t)i._data&&e.push(i._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const i of t)i._babylonAnimationGroup&&e.push(i._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case ia.NONE:break;case ia.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case ia.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{q.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,i=()=>{}){const s=this._extensionsLoadNodeAsync(e,t,i);if(s)return s;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${t.name||""}`);const n=a=>{if(Ae.AddPointerMetadata(a,e),Ae._LoadTransform(t,a),t.camera!=null){const l=Ye.Get(`${e}/camera`,this._gltf.cameras,t.camera);r.push(this.loadCameraAsync(`/cameras/${l.index}`,l,h=>{h.parent=a}))}if(t.children)for(const l of t.children){const h=Ye.Get(`${e}/children/${l}`,this._gltf.nodes,l);r.push(this.loadNodeAsync(`/nodes/${h.index}`,h,c=>{c.parent=a}))}i(a)};if(t.mesh==null||t.skin!=null){const a=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const l=new we(a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=l:t._babylonTransformNodeForSkin=l,n(l)}if(t.mesh!=null)if(t.skin==null){const a=Ye.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,n))}else{const a=Ye.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,l=>{const h=t._babylonTransformNodeForSkin;l.metadata=oE(h.metadata,l.metadata||{});const c=Ye.Get(`${e}/skin`,this._gltf.skins,t.skin);r.push(this._loadSkinAsync(`/skins/${c.index}`,t,c,u=>{this._forEachPrimitive(t,d=>{d.skeleton=u}),this._postSceneLoadActions.push(()=>{if(c.skeleton!=null){const d=Ye.Get(`/skins/${c.index}/skeleton`,this._gltf.nodes,c.skeleton).parent;t.index===d.index?l.parent=h.parent:l.parent=d._babylonTransformNode}else l.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:l})})}))}))}return this.logClose(),Promise.all(r).then(()=>(this._forEachPrimitive(t,a=>{a.geometry&&a.geometry.useBoundingInfoFromGeometry?a._updateBoundingInfo():a.refreshBoundingInfo(!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,i,s){const r=i.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);r[0].index==null&&Ye.Assign(r);const n=new Array;this.logOpen(`${e} ${i.name||""}`);const a=t.name||`node${t.index}`;if(r.length===1){const l=i.primitives[0];n.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,a,t,i,l,h=>{t._babylonTransformNode=h,t._primitiveBabylonMeshes=[h]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new we(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of r)n.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${a}_primitive${l.index}`,t,i,l,h=>{h.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(h)}))}return s(t._babylonTransformNode),this.logClose(),Promise.all(n).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,i,s,r,n){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,i,s,r,n);if(a)return a;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&i.skin==null&&!s.primitives[0].targets;let h,c;if(l&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,h=r._instanceData.babylonSourceMesh.createInstance(t),h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c=r._instanceData.promise;else{const u=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const d=new re(t,this._babylonScene);d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,d.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation,this._createMorphTargets(e,i,s,r,d),u.push(this._loadVertexDataAsync(e,r,d).then(p=>this._loadMorphTargetsAsync(e,r,d,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(d),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=Ae._GetDrawMode(e,r.mode);if(r.material==null){let p=this._defaultBabylonMaterialData[f];p||(p=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[f]=p),d.material=p}else if(!this.parent.skipMaterials){const p=Ye.Get(`${e}/material`,this._gltf.materials,r.material);u.push(this._loadMaterialAsync(`/materials/${p.index}`,p,d,f,_=>{d.material=_}))}c=Promise.all(u),l&&(r._instanceData={babylonSourceMesh:d,promise:c}),h=d}return Ae.AddPointerMetadata(h,e),this._parent.onMeshLoadedObservable.notifyObservers(h),n(h),this.logClose(),c.then(()=>h)}_loadVertexDataAsync(e,t,i){const s=this._extensionsLoadVertexDataAsync(e,t,i);if(s)return s;const r=t.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const n=new Array,a=new Ai(i.name,this._babylonScene);if(t.indices==null)i.isUnIndexed=!0;else{const h=Ye.Get(`${e}/indices`,this._gltf.accessors,t.indices);n.push(this._loadIndicesAccessorAsync(`/accessors/${h.index}`,h).then(c=>{a.setIndices(c)}))}const l=(h,c,u)=>{if(r[h]==null)return;i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(c)===-1&&i._delayInfo.push(c);const d=Ye.Get(`${e}/attributes/${h}`,this._gltf.accessors,r[h]);n.push(this._loadVertexAccessorAsync(`/accessors/${d.index}`,d,c).then(f=>{if(f.getKind()===T.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!i.skeleton&&d.min&&d.max){const p=D.Vector3[0].copyFromFloats(...d.min),_=D.Vector3[1].copyFromFloats(...d.max);if(d.normalized&&d.componentType!==5126){let g=1;switch(d.componentType){case 5120:g=127;break;case 5121:g=255;break;case 5122:g=32767;break;case 5123:g=65535;break}const E=1/g;p.scaleInPlace(E),_.scaleInPlace(E)}a._boundingInfo=new hs(p,_),a.useBoundingInfoFromGeometry=!0}a.setVerticesBuffer(f,d.count)})),c==T.MatricesIndicesExtraKind&&(i.numBoneInfluencers=8),u&&u(d)};return l("POSITION",T.PositionKind),l("NORMAL",T.NormalKind),l("TANGENT",T.TangentKind),l("TEXCOORD_0",T.UVKind),l("TEXCOORD_1",T.UV2Kind),l("TEXCOORD_2",T.UV3Kind),l("TEXCOORD_3",T.UV4Kind),l("TEXCOORD_4",T.UV5Kind),l("TEXCOORD_5",T.UV6Kind),l("JOINTS_0",T.MatricesIndicesKind),l("WEIGHTS_0",T.MatricesWeightsKind),l("JOINTS_1",T.MatricesIndicesExtraKind),l("WEIGHTS_1",T.MatricesWeightsExtraKind),l("COLOR_0",T.ColorKind,h=>{h.type==="VEC4"&&(i.hasVertexAlpha=!0)}),Promise.all(n).then(()=>a)}_createMorphTargets(e,t,i,s,r){if(!s.targets)return;if(t._numMorphTargets==null)t._numMorphTargets=s.targets.length;else if(s.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const n=i.extras?i.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,r.morphTargetManager=new fn(this._babylonScene),r.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.morphTargetManager.areUpdatesFrozen=!0;for(let a=0;a<s.targets.length;a++){const l=t.weights?t.weights[a]:i.weights?i.weights[a]:0,h=n?n[a]:`morphTarget${a}`;r.morphTargetManager.addTarget(new sa(h,l,r.getScene()))}}_loadMorphTargetsAsync(e,t,i,s){if(!t.targets)return Promise.resolve();const r=new Array,n=i.morphTargetManager;for(let a=0;a<n.numTargets;a++){const l=n.getTarget(a);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${a}`,s,t.targets[a],l))}return Promise.all(r).then(()=>{n.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,i,s){const r=new Array,n=(a,l,h)=>{if(i[a]==null)return;const c=t.getVertexBuffer(l);if(!c)return;const u=Ye.Get(`${e}/${a}`,this._gltf.accessors,i[a]);r.push(this._loadFloatAccessorAsync(`/accessors/${u.index}`,u).then(d=>{h(c,d)}))};return n("POSITION",T.PositionKind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(l.length,(c,u)=>{h[u]=l[u]+c}),s.setPositions(h)}),n("NORMAL",T.NormalKind,(a,l)=>{const h=new Float32Array(l.length);a.forEach(h.length,(c,u)=>{h[u]=l[u]+c}),s.setNormals(h)}),n("TANGENT",T.TangentKind,(a,l)=>{const h=new Float32Array(l.length/3*4);let c=0;a.forEach(l.length/3*4,(u,d)=>{(d+1)%4!==0&&(h[c]=l[c]+u,c++)}),s.setTangents(h)}),Promise.all(r).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let i=m.Zero(),s=le.Identity(),r=m.One();e.matrix?L.FromArray(e.matrix).decompose(r,s,i):(e.translation&&(i=m.FromArray(e.translation)),e.rotation&&(s=le.FromArray(e.rotation)),e.scale&&(r=m.FromArray(e.scale))),t.position=i,t.rotationQuaternion=s,t.scaling=r}_loadSkinAsync(e,t,i,s){const r=this._extensionsLoadSkinAsync(e,t,i);if(r)return r;if(i._data)return s(i._data.babylonSkeleton),i._data.promise;const n=`skeleton${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new so(i.name||n,n,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,i,a);const l=this._loadSkinInverseBindMatricesDataAsync(e,i).then(h=>{this._updateBoneMatrices(a,h)});return i._data={babylonSkeleton:a,promise:l},s(a),l}_loadBones(e,t,i){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const r=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(r)if(t.skeleton===void 0)t.skeleton=r.index;else{const n=(l,h)=>{for(;h.parent;h=h.parent)if(h.parent===l)return!0;return!1},a=Ye.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);a!==r&&!n(a,r)&&(q.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=r.index)}else q.Warn(`${e}: Failed to find common root`)}const s={};for(const r of t.joints){const n=Ye.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(n,t,i,s)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const i={};for(const r of t){const n=[];let a=Ye.Get(`${e}/${r}`,this._gltf.nodes,r);for(;a.index!==-1;)n.unshift(a),a=a.parent;i[r]=n}let s=null;for(let r=0;;++r){let n=i[t[0]];if(r>=n.length)return s;const a=n[r];for(let l=1;l<t.length;++l)if(n=i[t[l]],r>=n.length||a!==n[r])return s;s=a}}_loadBone(e,t,i,s){let r=s[e.index];if(r)return r;let n=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?n=this._loadBone(e.parent,t,i,s):t.skeleton!==void 0&&q.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return r=new vt(e.name||`joint${e.index}`,i,n,this._getNodeMatrix(e),null,null,a),s[e.index]=r,this._postSceneLoadActions.push(()=>{r.linkTransformNode(e._babylonTransformNode)}),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const i=Ye.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)}_updateBoneMatrices(e,t){for(const i of e.bones){const s=L.Identity(),r=i._index;t&&r!==-1&&(L.FromArrayToRef(t,r*16,s),s.invertToRef(s));const n=i.getParent();n&&s.multiplyToRef(n.getAbsoluteInverseBindMatrix(),s),i.updateMatrix(s,!1,!1),i._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?L.FromArray(e.matrix):L.Compose(e.scale?m.FromArray(e.scale):m.One(),e.rotation?le.FromArray(e.rotation):le.Identity(),e.translation?m.FromArray(e.translation):m.Zero())}loadCameraAsync(e,t,i=()=>{}){const s=this._extensionsLoadCameraAsync(e,t,i);if(s)return s;const r=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new oa(t.name||`camera${t.index}`,m.Zero(),this._babylonScene,!1);switch(n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.ignoreParentScaling=!0,t._babylonCamera=n,n.rotation.set(0,Math.PI,0),t.type){case"perspective":{const a=t.perspective;if(!a)throw new Error(`${e}: Camera perspective properties are missing`);n.fov=a.yfov,n.minZ=a.znear,n.maxZ=a.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);n.mode=De.ORTHOGRAPHIC_CAMERA,n.orthoLeft=-t.orthographic.xmag,n.orthoRight=t.orthographic.xmag,n.orthoBottom=-t.orthographic.ymag,n.orthoTop=t.orthographic.ymag,n.minZ=t.orthographic.znear,n.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return Ae.AddPointerMetadata(n,e),this._parent.onCameraLoadedObservable.notifyObservers(n),i(n),this.logClose(),Promise.all(r).then(()=>n)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let i=0;i<e.length;i++){const s=e[i];t.push(this.loadAnimationAsync(`/animations/${s.index}`,s).then(r=>{r.targetedAnimations.length===0&&r.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const i=this._extensionsLoadAnimationAsync(e,t);if(i)return i;this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new Nr(t.name||`animation${t.index}`,this._babylonScene);s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=s;const r=new Array;Ye.Assign(t.channels),Ye.Assign(t.samplers);for(const n of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${n.index}`,e,t,n,(a,l)=>{a.animations=a.animations||[],a.animations.push(l),s.addTargetedAnimation(l,a)}));return Promise.all(r).then(()=>(s.normalize(0),s))}_loadAnimationChannelAsync(e,t,i,s,r){const n=this._extensionsLoadAnimationChannelAsync(e,t,i,s,r);if(n)return n;if(s.target.node==null)return Promise.resolve();const a=Ye.Get(`${e}/target/node`,this._gltf.nodes,s.target.node);if(s.target.path==="weights"&&!a._numMorphTargets||s.target.path!=="weights"&&!a._babylonTransformNode)return Promise.resolve();let l;switch(s.target.path){case"translation":{l=th.translation;break}case"rotation":{l=th.rotation;break}case"scale":{l=th.scale;break}case"weights":{l=th.weights;break}default:throw new Error(`${e}/target/path: Invalid value (${s.target.path})`)}const h={target:a,properties:l};return this._loadAnimationChannelFromTargetInfoAsync(e,t,i,s,h,r)}_loadAnimationChannelFromTargetInfoAsync(e,t,i,s,r,n){const a=this.parent.targetFps,l=1/a,h=Ye.Get(`${e}/sampler`,i.samplers,s.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${s.sampler}`,h).then(c=>{let u=0;for(const d of r.properties){const f=d.getStride(r.target),p=c.input,_=c.output,g=new Array(p.length);let E=0;switch(c.interpolation){case"STEP":{for(let R=0;R<p.length;R++){const x=d.getValue(r.target,_,E,1);E+=f,g[R]={frame:p[R]*a,value:x,interpolation:Lc.STEP}}break}case"CUBICSPLINE":{for(let R=0;R<p.length;R++){const x=d.getValue(r.target,_,E,l);E+=f;const S=d.getValue(r.target,_,E,1);E+=f;const b=d.getValue(r.target,_,E,l);E+=f,g[R]={frame:p[R]*a,inTangent:x,value:S,outTangent:b}}break}case"LINEAR":{for(let R=0;R<p.length;R++){const x=d.getValue(r.target,_,E,1);E+=f,g[R]={frame:p[R]*a,value:x}}break}}if(E>0){const R=`${i.name||`animation${i.index}`}_channel${s.index}_${u}`;d.buildAnimations(r.target,R,a,g,(x,S)=>{++u,n(x,S)})}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const i=t.interpolation||"LINEAR";switch(i){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const s=Ye.Get(`${e}/input`,this._gltf.accessors,t.input),r=Ye.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${s.index}`,s),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then(([n,a])=>({input:n,interpolation:i,output:a})),t._data}loadBufferAsync(e,t,i,s){const r=this._extensionsLoadBufferAsync(e,t,i,s);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(n=>{try{return new Uint8Array(n.buffer,n.byteOffset+i,s)}catch(a){throw new Error(`${e}: ${a.message}`)}})}loadBufferViewAsync(e,t){const i=this._extensionsLoadBufferViewAsync(e,t);if(i)return i;if(t._data)return t._data;const s=Ye.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${s.index}`,s,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,i){if(t._data)return t._data;const s=Ae._GetNumComponents(e,t.type),r=s*T.GetTypeByteLength(t.componentType),n=s*t.count;if(t.bufferView==null)t._data=Promise.resolve(new i(n));else{const a=Ye.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then(l=>{if(t.componentType===5126&&!t.normalized&&(!a.byteStride||a.byteStride===r))return Ae._GetTypedArray(e,t.componentType,l,t.byteOffset,n);{const h=new i(n);return T.ForEach(l,t.byteOffset||0,a.byteStride||r,s,t.componentType,h.length,t.normalized||!1,(c,u)=>{h[u]=c}),h}})}if(t.sparse){const a=t.sparse;t._data=t._data.then(l=>{const h=l,c=Ye.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,a.indices.bufferView),u=Ye.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,a.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${c.index}`,c),this.loadBufferViewAsync(`/bufferViews/${u.index}`,u)]).then(([d,f])=>{const p=Ae._GetTypedArray(`${e}/sparse/indices`,a.indices.componentType,d,a.indices.byteOffset,a.count),_=s*a.count;let g;if(t.componentType===5126&&!t.normalized)g=Ae._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,_);else{const R=Ae._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,_);g=new i(_),T.ForEach(R,0,r,s,t.componentType,g.length,t.normalized||!1,(x,S)=>{g[S]=x})}let E=0;for(let R=0;R<p.length;R++){let x=p[R]*s;for(let S=0;S<s;S++)h[x++]=g[E++]}return h})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const i=Ae._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,i)}else{const i=Ye.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(s=>Ae._GetTypedArray(e,t.componentType,s,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(i=>new eo(t,i,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,i){var s;if(!((s=t._babylonVertexBuffer)===null||s===void 0)&&s[i])return t._babylonVertexBuffer[i];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const r=this._babylonScene.getEngine();if(t.sparse||t.bufferView==null)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then(n=>new T(r,n,i,!1));else{const n=Ye.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[i]=this._loadVertexBufferViewAsync(n).then(a=>{const l=Ae._GetNumComponents(e,t.type);return new T(r,a,i,!1,void 0,n.byteStride,void 0,t.byteOffset,l,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[i]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const s=new Array;return t&&(t.baseColorFactor?(i.albedoColor=J.FromArray(t.baseColorFactor),i.alpha=t.baseColorFactor[3]):i.albedoColor=J.White(),i.metallic=t.metallicFactor==null?1:t.metallicFactor,i.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&s.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,r=>{r.name=`${i.name} (Base Color)`,i.albedoTexture=r})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,r=>{r.name=`${i.name} (Metallic Roughness)`,i.metallicTexture=r})),i.useMetallnessFromMetallicTextureBlue=!0,i.useRoughnessFromMetallicTextureGreen=!0,i.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(s).then(()=>{})}_loadMaterialAsync(e,t,i,s,r=()=>{}){const n=this._extensionsLoadMaterialAsync(e,t,i,s,r);if(n)return n;t._data=t._data||{};let a=t._data[s];if(!a){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,s);a={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[s]=a,Ae.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return i&&(a.babylonMeshes.push(i),i.onDisposeObservable.addOnce(()=>{const l=a.babylonMeshes.indexOf(i);l!==-1&&a.babylonMeshes.splice(l,1)})),r(a.babylonMaterial),a.promise.then(()=>a.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const i=new me(e,this._babylonScene);return i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.fillMode=t,i.enableSpecularAntiAliasing=!0,i.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,i.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,i.transparencyMode=me.PBRMATERIAL_OPAQUE,i.metallic=1,i.roughness=1,i}createMaterial(e,t,i){const s=this._extensionsCreateMaterial(e,t,i);if(s)return s;const r=t.name||`material${t.index}`;return this._createDefaultMaterial(r,i)}loadMaterialPropertiesAsync(e,t,i){const s=this._extensionsLoadMaterialPropertiesAsync(e,t,i);if(s)return s;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,i)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,i)),this.loadMaterialAlphaProperties(e,t,i),Promise.all(r).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.emissiveColor=t.emissiveFactor?J.FromArray(t.emissiveFactor):new J(0,0,0),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,r=>{r.name=`${i.name} (Normal)`,i.bumpTexture=r})),i.invertNormalMapX=!this._babylonScene.useRightHandedSystem,i.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&i.bumpTexture&&(i.bumpTexture.level=t.normalTexture.scale),i.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,r=>{r.name=`${i.name} (Occlusion)`,i.ambientTexture=r})),i.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(i.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&s.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,r=>{r.name=`${i.name} (Emissive)`,i.emissiveTexture=r})),Promise.all(s).then(()=>{})}loadMaterialAlphaProperties(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{i.transparencyMode=me.PBRMATERIAL_OPAQUE,i.alpha=1;break}case"MASK":{i.transparencyMode=me.PBRMATERIAL_ALPHATEST,i.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0);break}case"BLEND":{i.transparencyMode=me.PBRMATERIAL_ALPHABLEND,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0,i.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,i=()=>{}){const s=this._extensionsLoadTextureInfoAsync(e,t,i);if(s)return s;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=Ye.Get(`${e}/index`,this._gltf.textures,t.index);r._textureInfo=t;const n=this._loadTextureAsync(`/textures/${t.index}`,r,a=>{a.coordinatesIndex=t.texCoord||0,Ae.AddPointerMetadata(a,e),this._parent.onTextureLoadedObservable.notifyObservers(a),i(a)});return this.logClose(),n}_loadTextureAsync(e,t,i=()=>{}){const s=this._extensionsLoadTextureAsync(e,t,i);if(s)return s;this.logOpen(`${e} ${t.name||""}`);const r=t.sampler==null?Ae.DefaultSampler:Ye.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),n=Ye.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,r,n,i,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,i,s=()=>{},r,n){const a=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,h=new eh;this._babylonScene._blockEntityCollection=!!this._assetContainer;const c={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(d,f)=>{this._disposed||h.reject(new Error(`${e}: ${f&&f.message?f.message:d||"Failed to load texture"}`))},mimeType:i.mimeType,loaderOptions:r,useSRGBBuffer:!!n&&this._parent.useSRGBBuffers},u=new V(null,this._babylonScene,c);return u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(h.promise),l.push(this.loadImageAsync(`/images/${i.index}`,i).then(d=>{const f=i.uri||`${this._fileName}#image${i.index}`,p=`data:${this._uniqueRootUrl}${f}`;u.updateURL(p,d)})),u.wrapU=a.wrapU,u.wrapV=a.wrapV,s(u),Promise.all(l).then(()=>u)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:Ae._GetTextureSamplingMode(e,t),wrapU:Ae._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:Ae._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const i=Ye.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i)}this.logClose()}return t._data}loadUriAsync(e,t,i){const s=this._extensionsLoadUriAsync(e,t,i);if(s)return s;if(!Ae._ValidateUri(i))throw new Error(`${e}: '${i}' is invalid`);if(Xc(i)){const r=new Uint8Array(yh(i));return this.log(`${e}: Decoded ${i.substr(0,64)}... (${r.length} bytes)`),Promise.resolve(r)}return this.log(`${e}: Loading ${i}`),this._parent.preprocessUrlAsync(this._rootUrl+i).then(r=>new Promise((n,a)=>{this._parent._loadFile(this._babylonScene,r,l=>{this._disposed||(this.log(`${e}: Loaded ${i} (${l.byteLength} bytes)`),n(new Uint8Array(l)))},!0,l=>{a(new _h(`${e}: Failed to load '${i}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const i=e._internalMetadata=e._internalMetadata||{},s=i.gltf=i.gltf||{};(s.pointers=s.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return V.CLAMP_ADDRESSMODE;case 33648:return V.MIRROR_ADDRESSMODE;case 10497:return V.WRAP_ADDRESSMODE;default:return q.Warn(`${e}: Invalid value (${t})`),V.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const i=t.magFilter==null?9729:t.magFilter,s=t.minFilter==null?9987:t.minFilter;if(i===9729)switch(s){case 9728:return V.LINEAR_NEAREST;case 9729:return V.LINEAR_LINEAR;case 9984:return V.LINEAR_NEAREST_MIPNEAREST;case 9985:return V.LINEAR_LINEAR_MIPNEAREST;case 9986:return V.LINEAR_NEAREST_MIPLINEAR;case 9987:return V.LINEAR_LINEAR_MIPLINEAR;default:return q.Warn(`${e}/minFilter: Invalid value (${s})`),V.LINEAR_LINEAR_MIPLINEAR}else switch(i!==9728&&q.Warn(`${e}/magFilter: Invalid value (${i})`),s){case 9728:return V.NEAREST_NEAREST;case 9729:return V.NEAREST_LINEAR;case 9984:return V.NEAREST_NEAREST_MIPNEAREST;case 9985:return V.NEAREST_LINEAR_MIPNEAREST;case 9986:return V.NEAREST_NEAREST_MIPLINEAR;case 9987:return V.NEAREST_LINEAR_MIPLINEAR;default:return q.Warn(`${e}/minFilter: Invalid value (${s})`),V.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,i,s,r){const n=i.buffer;s=i.byteOffset+(s||0);const a=Ae._GetTypedArrayConstructor(`${e}/componentType`,t),l=T.GetTypeByteLength(t);return s%l!==0?(q.Warn(`${e}: Copying buffer as byte offset (${s}) is not a multiple of component type byte length (${l})`),new a(n.slice(s,s+r*l),0)):new a(n,s,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return Y.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return Q.PointListDrawMode;case 1:return Q.LineListDrawMode;case 2:return Q.LineLoopDrawMode;case 3:return Q.LineStripDrawMode;case 4:return Q.TriangleFillMode;case 5:return Q.TriangleStripDrawMode;case 6:return Q.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const i in t._data){const s=t._data[i];for(const r of s.babylonMeshes){r.computeWorldMatrix(!0);const n=s.babylonMaterial;e.push(n.forceCompilationAsync(r)),e.push(n.forceCompilationAsync(r,{useInstances:!0})),this._parent.useClipPlane&&(e.push(n.forceCompilationAsync(r,{clipPlane:!0})),e.push(n.forceCompilationAsync(r,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const i of t){const s=i.getShadowGenerator();s&&e.push(s.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,i){for(const s of this._extensions)if(s.enabled){const r=`${s.name}.${t}`,n=e;n._activeLoaderExtensionFunctions=n._activeLoaderExtensionFunctions||{};const a=n._activeLoaderExtensionFunctions;if(!a[r]){a[r]=!0;try{const l=i(s);if(l)return l}finally{delete a[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",i=>i.loadSceneAsync&&i.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,i){return this._applyExtensions(t,"loadNode",s=>s.loadNodeAsync&&s.loadNodeAsync(e,t,i))}_extensionsLoadCameraAsync(e,t,i){return this._applyExtensions(t,"loadCamera",s=>s.loadCameraAsync&&s.loadCameraAsync(e,t,i))}_extensionsLoadVertexDataAsync(e,t,i){return this._applyExtensions(t,"loadVertexData",s=>s._loadVertexDataAsync&&s._loadVertexDataAsync(e,t,i))}_extensionsLoadMeshPrimitiveAsync(e,t,i,s,r,n){return this._applyExtensions(r,"loadMeshPrimitive",a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,i,s,r,n))}_extensionsLoadMaterialAsync(e,t,i,s,r){return this._applyExtensions(t,"loadMaterial",n=>n._loadMaterialAsync&&n._loadMaterialAsync(e,t,i,s,r))}_extensionsCreateMaterial(e,t,i){return this._applyExtensions(t,"createMaterial",s=>s.createMaterial&&s.createMaterial(e,t,i))}_extensionsLoadMaterialPropertiesAsync(e,t,i){return this._applyExtensions(t,"loadMaterialProperties",s=>s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(e,t,i))}_extensionsLoadTextureInfoAsync(e,t,i){return this._applyExtensions(t,"loadTextureInfo",s=>s.loadTextureInfoAsync&&s.loadTextureInfoAsync(e,t,i))}_extensionsLoadTextureAsync(e,t,i){return this._applyExtensions(t,"loadTexture",s=>s._loadTextureAsync&&s._loadTextureAsync(e,t,i))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",i=>i.loadAnimationAsync&&i.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,i,s,r){return this._applyExtensions(i,"loadAnimationChannel",n=>n._loadAnimationChannelAsync&&n._loadAnimationChannelAsync(e,t,i,s,r))}_extensionsLoadSkinAsync(e,t,i){return this._applyExtensions(i,"loadSkin",s=>s._loadSkinAsync&&s._loadSkinAsync(e,t,i))}_extensionsLoadUriAsync(e,t,i){return this._applyExtensions(t,"loadUri",s=>s._loadUriAsync&&s._loadUriAsync(e,t,i))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",i=>i.loadBufferViewAsync&&i.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,i,s){return this._applyExtensions(t,"loadBuffer",r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,i,s))}static LoadExtensionAsync(e,t,i,s){if(!t.extensions)return null;const n=t.extensions[i];return n?s(`${e}/extensions/${i}`,n):null}static LoadExtraAsync(e,t,i,s){if(!t.extras)return null;const n=t.extras[i];return n?s(`${e}/extras/${i}`,n):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}Ae._RegisteredExtensions={};Ae.DefaultSampler={index:-1};Kt._CreateGLTF2Loader=o=>new Ae(o);class Si extends bt{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(L.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";return e.forEach(r=>s+=r),new Si(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=!0){const r=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const n=new Si(e,t,null,!1,null,null,null,void 0,!0,i,s);return t.useDelayedTextureLoading=r,n}constructor(e,t,i=null,s=!1,r=null,n=null,a=null,l=5,h=!1,c=null,u=!1,d=.8,f=0,p,_){var g;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new j,this.boundingBoxPosition=m.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new L,this.name=e,this.url=e,this._noMipmap=s,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=L.Identity(),this._createPolynomials=u,this.coordinatesMode=V.CUBIC_MODE,this._extensions=i,this._files=r,this._forcedExtension=c,this._loaderOptions=p,this._useSRGBBuffer=_,this._lodScale=d,this._lodOffset=f,!(!e&&!r)&&this.updateURL(e,c,n,h,a,i,(g=this.getScene())===null||g===void 0?void 0:g.useDelayedTextureLoading,r)}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,s=!1,r=null,n=null,a=!1,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const h=e.lastIndexOf("."),c=t||(h>-1?e.substring(h).toLowerCase():""),u=c.indexOf(".dds")===0,d=c.indexOf(".env")===0,f=c.indexOf(".basis")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!f&&!d&&!u&&!n&&(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let p=0;p<n.length;p++)this._files.push(e+n[p]);this._extensions=n}a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=r):this._loadTexture(i,r)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t,i;if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,a=>a.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e,!(!((i=this.getScene())===null||i===void 0)&&i.useRightHandedSystem)))return;const s=D.Vector3[0],r=D.Quaternion[0],n=D.Vector3[1];this._textureMatrix.decompose(s,r,n),r.z*=-1,r.w*=-1,L.ComposeToRef(s,r,n,this._textureMatrixRefraction)}getRefractionTextureMatrix(){var e;return!((e=this.getScene())===null||e===void 0)&&e.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){var i;const s=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const n=()=>{var l;this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),(l=this.getScene())===null||l===void 0||l.markAllMaterialsAsDirty(1)),e&&e()},a=(l,h)=>{this._loadingError=!0,this._errorObject={message:l,exception:h},t&&t(l,h),V.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?Y.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(()=>n()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,e,a,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,e,a,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(i=this._texture)===null||i===void 0||i.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const s=Le.Parse(()=>{var r;let n=!1;return e.prefiltered&&(n=e.prefiltered),new Si(i+((r=e.url)!==null&&r!==void 0?r:e.name),t,e.extensions,!1,e.files||null,null,null,void 0,n,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=m.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=m.FromArray(e.boundingBoxSize)),e.animations)for(let r=0;r<e.animations.length;r++){const n=e.animations[r],a=Gr("BABYLON.Animation");a&&s.animations.push(a.Parse(n))}return s}clone(){let e=0;const t=Le.Clone(()=>{const i=new Si(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}v([M()],Si.prototype,"url",void 0);v([zi()],Si.prototype,"boundingBoxPosition",void 0);v([zi()],Si.prototype,"boundingBoxSize",null);v([M("rotationY")],Si.prototype,"rotationY",null);v([M("files")],Si.prototype,"_files",void 0);v([M("forcedExtension")],Si.prototype,"_forcedExtension",void 0);v([M("extensions")],Si.prototype,"_extensions",void 0);v([Am("textureMatrix")],Si.prototype,"_textureMatrix",void 0);v([Am("textureMatrixRefraction")],Si.prototype,"_textureMatrixRefraction",void 0);V._CubeTextureParser=Si.Parse;Re("BABYLON.CubeTexture",Si);class Ff extends Si{constructor(e,t,i,s=5,r=0,n=!1,a=!1,l=3,h=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,s,r,n,a,l,h)}update(e,t,i,s,r=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,s,r)}updateRGBDAsync(e,t=null,i=.8,s=0){return ab(this._texture,e,t,i,s).then(()=>{})}clone(){return Le.Clone(()=>{const e=this.getScene(),t=this._texture,i=new Ff(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===At.CubeRawRGBD&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}}const Nd="EXT_lights_image_based";class hD{constructor(e){this.name=Nd,this._loader=e,this.enabled=this._loader.isExtensionUsed(Nd)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return Ae.LoadExtensionAsync(e,t,this.name,(i,s)=>{this._loader._allMaterialsDirtyRequired=!0;const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);const n=Ye.Get(`${i}/light`,this._lights,s.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${s.light}`,n).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),Promise.all(r).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const i=new Array;this._loader.logOpen(`${e}`);const s=new Array(t.specularImages.length);for(let r=0;r<t.specularImages.length;r++){const n=t.specularImages[r];s[r]=new Array(n.length);for(let a=0;a<n.length;a++){const l=`${e}/specularImages/${r}/${a}`;this._loader.logOpen(`${l}`);const h=n[a],c=Ye.Get(l,this._loader.gltf.images,h);i.push(this._loader.loadImageAsync(`/images/${h}`,c).then(u=>{s[r][a]=u})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(()=>{const r=new Ff(this._loader.babylonScene,null,t.specularImageSize);if(r.name=t.name||"environment",t._babylonTexture=r,t.intensity!=null&&(r.level=t.intensity),t.rotation){let h=le.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(h=le.Inverse(h)),L.FromQuaternionToRef(h,r.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const n=Qa.FromArray(t.irradianceCoefficients);n.scaleInPlace(t.intensity),n.convertIrradianceToLambertianRadiance();const a=Tn.FromHarmonics(n),l=(s.length-1)/Te.Log2(t.specularImageSize);return r.updateRGBDAsync(s,a,l)})}return t._loaded.then(()=>t._babylonTexture)}}Ae.RegisterExtension(Nd,o=>new hD(o));re.prototype.thinInstanceAdd=function(o,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return q.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(o)?o.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(o))for(let i=0;i<o.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,o[i],i===o.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,o,e);return t};re.prototype.thinInstanceAddSelf=function(o=!0){return this.thinInstanceAdd(L.IdentityReadOnly,o)};re.prototype.thinInstanceRegisterAttribute=function(o,e){o===T.ColorKind&&(o=T.ColorInstanceKind),this.removeVerticesData(o),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[o]=e,this._userThinInstanceBuffersStorage.sizes[o]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[o]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[o]),this._userThinInstanceBuffersStorage.vertexBuffers[o]=new T(this.getEngine(),this._userThinInstanceBuffersStorage.data[o],o,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o])};re.prototype.thinInstanceSetMatrixAt=function(o,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||o>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,o*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[o]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};re.prototype.thinInstanceSetAttributeAt=function(o,e,t,i=!0){return o===T.ColorKind&&(o=T.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[o]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(o,0),this._userThinInstanceBuffersStorage.data[o].set(t,e*this._userThinInstanceBuffersStorage.strides[o]),i&&this.thinInstanceBufferUpdated(o),!0)};Object.defineProperty(re.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(o){var e,t;const i=(e=this._thinInstanceDataStorage.matrixData)!==null&&e!==void 0?e:(t=this.source)===null||t===void 0?void 0:t._thinInstanceDataStorage.matrixData,s=i?i.length/16:0;o<=s&&(this._thinInstanceDataStorage.instancesCount=o)},enumerable:!0,configurable:!0});re.prototype._thinInstanceCreateMatrixBuffer=function(o,e,t=!1){o===T.ColorKind&&(o=T.ColorInstanceKind);const i=new eo(this.getEngine(),e,!t,16,!1,!0);for(let s=0;s<4;s++)this.setVerticesBuffer(i.createVertexBuffer(o+s,s*4,4));return i};re.prototype.thinInstanceSetBuffer=function(o,e,t=0,i=!1){var s,r,n;t=t||16,o==="matrix"?((s=this._thinInstanceDataStorage.matrixBuffer)===null||s===void 0||s.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):o==="previousMatrix"?((r=this._thinInstanceDataStorage.previousMatrixBuffer)===null||r===void 0||r.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(o===T.ColorKind&&(o=T.ColorInstanceKind),e===null?!((n=this._userThinInstanceBuffersStorage)===null||n===void 0)&&n.data[o]&&(this.removeVerticesData(o),delete this._userThinInstanceBuffersStorage.data[o],delete this._userThinInstanceBuffersStorage.strides[o],delete this._userThinInstanceBuffersStorage.sizes[o],delete this._userThinInstanceBuffersStorage.vertexBuffers[o]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[o]=e,this._userThinInstanceBuffersStorage.strides[o]=t,this._userThinInstanceBuffersStorage.sizes[o]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[o]=new T(this.getEngine(),e,o,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o])))};re.prototype.thinInstanceBufferUpdated=function(o){var e,t,i;o==="matrix"?(e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):o==="previousMatrix"?(t=this._thinInstanceDataStorage.previousMatrixBuffer)===null||t===void 0||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(o===T.ColorKind&&(o=T.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[o]&&this._userThinInstanceBuffersStorage.vertexBuffers[o].updateDirectly(this._userThinInstanceBuffersStorage.data[o],0))};re.prototype.thinInstancePartialBufferUpdate=function(o,e,t){var i;o==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(o===T.ColorKind&&(o=T.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[o]&&this._userThinInstanceBuffersStorage.vertexBuffers[o].updateDirectly(e,t))};re.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const o=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=L.FromArray(o,e*16)}return this._thinInstanceDataStorage.worldMatrices};re.prototype.thinInstanceRefreshBoundingInfo=function(o=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;if(o||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);const n=this.getBoundingInfo();this.rawBoundingInfo=new hs(n.minimum,n.maximum)}const s=this.getBoundingInfo(),r=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let n=0;n<s.boundingBox.vectors.length;++n)i.push(s.boundingBox.vectors[n].clone());D.Vector3[0].setAll(Number.POSITIVE_INFINITY),D.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let n=0;n<this._thinInstanceDataStorage.instancesCount;++n){L.FromArrayToRef(r,n*16,D.Matrix[0]);for(let a=0;a<i.length;++a)m.TransformCoordinatesToRef(i[a],D.Matrix[0],D.Vector3[2]),D.Vector3[0].minimizeInPlace(D.Vector3[2]),D.Vector3[1].maximizeInPlace(D.Vector3[2])}s.reConstruct(D.Vector3[0],D.Vector3[1]),this._updateBoundingInfo()};re.prototype._thinInstanceUpdateBufferSize=function(o,e=1){var t,i,s;o===T.ColorKind&&(o=T.ColorInstanceKind);const r=o==="matrix";if(!r&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[o]))return;const n=r?16:this._userThinInstanceBuffersStorage.strides[o],a=r?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[o];let l=r?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[o];const h=(this._thinInstanceDataStorage.instancesCount+e)*n;let c=a;for(;c<h;)c*=2;if(!l||a!=c){if(!l)l=new Float32Array(c);else{const u=new Float32Array(c);u.set(l,0),l=u}r?((t=this._thinInstanceDataStorage.matrixBuffer)===null||t===void 0||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=c,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):((s=this._userThinInstanceBuffersStorage.vertexBuffers[o])===null||s===void 0||s.dispose(),this._userThinInstanceBuffersStorage.data[o]=l,this._userThinInstanceBuffersStorage.sizes[o]=c,this._userThinInstanceBuffersStorage.vertexBuffers[o]=new T(this.getEngine(),l,o,!0,!1,n,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[o]))}};re.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};re.prototype._disposeThinInstanceSpecificData=function(){var o;!((o=this._thinInstanceDataStorage)===null||o===void 0)&&o.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};const Ld="EXT_mesh_gpu_instancing";class cD{constructor(e){this.name=Ld,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ld)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{this._loader._disableInstancedMesh++;const n=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return n;const a=new Array;let l=0;const h=c=>{if(r.attributes[c]==null){a.push(Promise.resolve(null));return}const u=Ye.Get(`${s}/attributes/${c}`,this._loader.gltf.accessors,r.attributes[c]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${u.bufferView}`,u)),l===0)l=u.count;else if(l!==u.count)throw new Error(`${s}/attributes: Instance buffer accessors do not have the same count.`)};return h("TRANSLATION"),h("ROTATION"),h("SCALE"),n.then(c=>Promise.all(a).then(([u,d,f])=>{const p=new Float32Array(l*16);D.Vector3[0].copyFromFloats(0,0,0),D.Quaternion[0].copyFromFloats(0,0,0,1),D.Vector3[1].copyFromFloats(1,1,1);for(let _=0;_<l;++_)u&&m.FromArrayToRef(u,_*3,D.Vector3[0]),d&&le.FromArrayToRef(d,_*4,D.Quaternion[0]),f&&m.FromArrayToRef(f,_*3,D.Vector3[1]),L.ComposeToRef(D.Vector3[1],D.Quaternion[0],D.Vector3[0],D.Matrix[0]),D.Matrix[0].copyToArray(p,_*16);for(const _ of t._primitiveBabylonMeshes)_.thinInstanceSetBuffer("matrix",p,16,!0);return c}))})}}Ae.RegisterExtension(Ld,o=>new cD(o));class Br{static get Default(){return Br._Default||(Br._Default=new Br),Br._Default}constructor(){const e=Br.Configuration.decoder;this._decoderModulePromise=Y.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,s,r){return this._decoderModulePromise.then(()=>{const n=new Uint8Array(t*i);return MeshoptDecoder.decodeGltfBuffer(n,t,i,e,s,r),n})}}Br.Configuration={decoder:{url:`${Y._DefaultCdnUrl}/meshopt_decoder.js`}};Br._Default=null;const Fd="EXT_meshopt_compression";class uD{constructor(e){this.name=Fd,this.enabled=e.isExtensionUsed(Fd),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return Ae.LoadExtensionAsync(e,t,this.name,(i,s)=>{const r=t;if(r._meshOptData)return r._meshOptData;const n=Ye.Get(`${e}/buffer`,this._loader.gltf.buffers,s.buffer);return r._meshOptData=this._loader.loadBufferAsync(`/buffers/${n.index}`,n,s.byteOffset||0,s.byteLength).then(a=>Br.Default.decodeGltfBufferAsync(a,s.count,s.byteStride,s.mode,s.filter)),r._meshOptData})}}Ae.RegisterExtension(Fd,o=>new uD(o));const wd="EXT_texture_webp";class dD{constructor(e){this.name=wd,this._loader=e,this.enabled=e.isExtensionUsed(wd)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=t.sampler==null?Ae.DefaultSampler:Ye.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Ye.Get(`${s}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,n,a,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}}Ae.RegisterExtension(wd,o=>new dD(o));function fD(o){return new Promise(e=>{DracoDecoderModule({wasmBinary:o}).then(t=>{e({module:t})})})}function Bd(o,e,t,i,s){let r=null,n=null,a=null;try{r=new o.Decoder,n=new o.DecoderBuffer,n.Init(e,e.byteLength);let l;const h=r.GetEncodedGeometryType(n);switch(h){case o.TRIANGULAR_MESH:{const d=new o.Mesh;if(l=r.DecodeBufferToMesh(n,d),!l.ok()||d.ptr===0)throw new Error(l.error_msg());const p=d.num_faces()*3,_=p*4,g=o._malloc(_);try{r.GetTrianglesUInt32Array(d,_,g);const E=new Uint32Array(p);E.set(new Uint32Array(o.HEAPF32.buffer,g,p)),i(E)}finally{o._free(g)}a=d;break}case o.POINT_CLOUD:{const d=new o.PointCloud;if(l=r.DecodeBufferToPointCloud(n,d),!l.ok()||!d.ptr)throw new Error(l.error_msg());a=d;break}default:throw new Error(`Invalid geometry type ${h}`)}const c=a.num_points(),u=(d,f,p,_)=>{const g=_.data_type(),E=_.num_components(),R=_.normalized(),x=_.byte_stride(),S=_.byte_offset(),y={[o.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:o.HEAPF32},[o.DT_INT8]:{typedArrayConstructor:Int8Array,heap:o.HEAP8},[o.DT_INT16]:{typedArrayConstructor:Int16Array,heap:o.HEAP16},[o.DT_INT32]:{typedArrayConstructor:Int32Array,heap:o.HEAP32},[o.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:o.HEAPU8},[o.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:o.HEAPU16},[o.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:o.HEAPU32}}[g];if(!y)throw new Error(`Invalid data type ${g}`);const I=c*E,O=I*y.typedArrayConstructor.BYTES_PER_ELEMENT,N=o._malloc(O);try{d.GetAttributeDataArrayForAllPoints(f,_,g,O,N);const w=new y.typedArrayConstructor(y.heap.buffer,N,I);s(p,w.slice(),E,S,x,R)}finally{o._free(N)}};if(t)for(const d in t){const f=t[d],p=r.GetAttributeByUniqueId(a,f);u(r,a,d,p)}else{const d={position:o.POSITION,normal:o.NORMAL,color:o.COLOR,uv:o.TEX_COORD};for(const f in d){const p=r.GetAttributeId(a,d[f]);if(p!==-1){const _=r.GetAttribute(a,p);u(r,a,f,_)}}}return c}finally{a&&o.destroy(a),n&&o.destroy(n),r&&o.destroy(r)}}function _D(){let o;onmessage=e=>{const t=e.data;switch(t.id){case"init":{const i=t.decoder;i.url&&(importScripts(i.url),o=DracoDecoderModule({wasmBinary:i.wasmBinary})),postMessage({id:"initDone"});break}case"decodeMesh":{if(!o)throw new Error("Draco decoder module is not available");o.then(i=>{const s=Bd(i,t.dataView,t.attributes,r=>{postMessage({id:"indices",data:r},[r.buffer])},(r,n,a,l,h,c)=>{postMessage({id:"attribute",kind:r,data:n,size:a,byteOffset:l,byteStride:h,normalized:c},[n.buffer])});postMessage({id:"decodeMeshDone",totalVertices:s})});break}}}}class Ts{static get DecoderAvailable(){const e=Ts.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"||e.fallbackUrl)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static get Default(){return Ts._Default||(Ts._Default=new Ts),Ts._Default}constructor(e=Ts.DefaultNumWorkers){const t=Ts.Configuration.decoder,i=t.wasmUrl&&t.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:Y.GetBabylonScriptURL(t.wasmUrl,!0),wasmBinaryPromise:Y.LoadFileAsync(Y.GetBabylonScriptURL(t.wasmBinaryUrl,!0))}:{url:Y.GetBabylonScriptURL(t.fallbackUrl),wasmBinaryPromise:Promise.resolve(void 0)};e&&typeof Worker=="function"&&typeof URL=="function"?this._workerPoolPromise=i.wasmBinaryPromise.then(s=>{const r=`${Bd}(${_D})()`,n=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));return new xh(e,()=>new Promise((a,l)=>{const h=new Worker(n),c=d=>{h.removeEventListener("error",c),h.removeEventListener("message",u),l(d)},u=d=>{d.data.id==="initDone"&&(h.removeEventListener("error",c),h.removeEventListener("message",u),a(h))};h.addEventListener("error",c),h.addEventListener("message",u),h.postMessage({id:"init",decoder:{url:i.url,wasmBinary:s}})}))}):this._decoderModulePromise=i.wasmBinaryPromise.then(s=>{if(!i.url)throw new Error("Draco decoder module is not available");return Y.LoadBabylonScriptAsync(i.url).then(()=>fD(s))})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return this._workerPoolPromise?this._workerPoolPromise.then(()=>{}):this._decoderModulePromise?this._decoderModulePromise.then(()=>{}):Promise.resolve()}_decodeMeshAsync(e,t,i){const s=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),r=(n,a)=>i&&i[n]!==void 0?(a!==i[n]&&q.Warn(`Normalized flag from Draco data (${a}) does not match normalized flag from glTF accessor (${i[n]}). Using flag from glTF accessor.`),i[n]):a;if(this._workerPoolPromise)return this._workerPoolPromise.then(n=>new Promise((a,l)=>{n.push((h,c)=>{let u=null;const d=[],f=g=>{h.removeEventListener("error",f),h.removeEventListener("message",p),l(g),c()},p=g=>{const E=g.data;switch(E.id){case"decodeMeshDone":{h.removeEventListener("error",f),h.removeEventListener("message",p),a({indices:u,attributes:d,totalVertices:E.totalVertices}),c();break}case"indices":{u=E.data;break}case"attribute":{d.push({kind:E.kind,data:E.data,size:E.size,byteOffset:E.byteOffset,byteStride:E.byteStride,normalized:r(E.kind,E.normalized)});break}}};h.addEventListener("error",f),h.addEventListener("message",p);const _=s.slice();h.postMessage({id:"decodeMesh",dataView:_,attributes:t},[_.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(n=>{let a=null;const l=[],h=Bd(n.module,s,t,c=>{a=c},(c,u,d,f,p,_)=>{l.push({kind:c,data:u,size:d,byteOffset:f,byteStride:p,normalized:_})});return{indices:a,attributes:l,totalVertices:h}});throw new Error("Draco decoder module is not available")}decodeMeshToGeometryAsync(e,t,i,s){return this._decodeMeshAsync(i,s).then(r=>{const n=new Ai(e,t);r.indices&&n.setIndices(r.indices);for(const a of r.attributes)n.setVerticesBuffer(new T(t.getEngine(),a.data,a.kind,!1,void 0,a.byteStride,void 0,a.byteOffset,a.size,void 0,a.normalized,!0),r.totalVertices);return n})}_decodeMeshToGeometryForGltfAsync(e,t,i,s,r){return this._decodeMeshAsync(i,s,r).then(n=>{const a=new Ai(e,t);n.indices&&a.setIndices(n.indices);for(const l of n.attributes)a.setVerticesBuffer(new T(t.getEngine(),l.data,l.kind,!1,void 0,l.byteStride,void 0,l.byteOffset,l.size,void 0,l.normalized,!0),n.totalVertices);return a})}decodeMeshAsync(e,t){return this._decodeMeshAsync(e,t).then(i=>{const s=new fe;i.indices&&(s.indices=i.indices);for(const r of i.attributes){const n=T.GetFloatData(r.data,r.size,T.GetDataType(r.data),r.byteOffset,r.byteStride,r.normalized,i.totalVertices);s.set(n,r.kind)}return s})}}Ts.Configuration={decoder:{wasmUrl:`${Y._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${Y._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${Y._DefaultCdnUrl}/draco_decoder_gltf.js`}};Ts.DefaultNumWorkers=Ts.GetDefaultNumWorkers();Ts._Default=null;const Ud="KHR_draco_mesh_compression";class pD{constructor(e){this.name=Ud,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=Ts.DecoderAvailable&&this._loader.isExtensionUsed(Ud)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);const n={},a={},l=(c,u)=>{const d=r.attributes[c];if(d!=null&&(i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(u)===-1&&i._delayInfo.push(u),n[u]=d,this.useNormalizedFlagFromAccessor)){const f=Ye.TryGet(this._loader.gltf.accessors,t.attributes[c]);f&&(a[u]=f.normalized||!1)}};l("POSITION",T.PositionKind),l("NORMAL",T.NormalKind),l("TANGENT",T.TangentKind),l("TEXCOORD_0",T.UVKind),l("TEXCOORD_1",T.UV2Kind),l("TEXCOORD_2",T.UV3Kind),l("TEXCOORD_3",T.UV4Kind),l("TEXCOORD_4",T.UV5Kind),l("TEXCOORD_5",T.UV6Kind),l("JOINTS_0",T.MatricesIndicesKind),l("WEIGHTS_0",T.MatricesWeightsKind),l("COLOR_0",T.ColorKind);const h=Ye.Get(s,this._loader.gltf.bufferViews,r.bufferView);return h._dracoBabylonGeometry||(h._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${h.index}`,h).then(c=>(this.dracoCompression||Ts.Default)._decodeMeshToGeometryForGltfAsync(i.name,this._loader.babylonScene,c,n,a).catch(d=>{throw new Error(`${e}: ${d.message}`)}))),h._dracoBabylonGeometry})}}Ae.RegisterExtension(Ud,o=>new pD(o));const kd="KHR_lights_punctual";class gD{constructor(e){this.name=kd,this._loader=e,this.enabled=this._loader.isExtensionUsed(kd)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,Ye.Assign(this._lights)}}loadNodeAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>(this._loader._allMaterialsDirtyRequired=!0,this._loader.loadNodeAsync(e,t,n=>{let a;const l=Ye.Get(s,this._lights,r.light),h=l.name||n.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const c=new bs(h,m.Backward(),this._loader.babylonScene);c.position.setAll(0),a=c;break}case"point":{a=new Rl(h,m.Zero(),this._loader.babylonScene);break}case"spot":{const c=new es(h,m.Zero(),m.Backward(),0,1,this._loader.babylonScene);c.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,c.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=c;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${s}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=qe.FALLOFF_GLTF,a.diffuse=l.color?J.FromArray(l.color):J.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=n,this._loader._babylonLights.push(a),Ae.AddPointerMetadata(a,s),i(n)})))}}Ae.RegisterExtension(kd,o=>new gD(o));const Vd="KHR_materials_pbrSpecularGlossiness";class mD{constructor(e){this.name=Vd,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(Vd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loadSpecularGlossinessPropertiesAsync(s,r,i)),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(n).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.metallic=null,i.roughness=null,t.diffuseFactor?(i.albedoColor=J.FromArray(t.diffuseFactor),i.alpha=t.diffuseFactor[3]):i.albedoColor=J.White(),i.reflectivityColor=t.specularFactor?J.FromArray(t.specularFactor):J.White(),i.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,r=>{r.name=`${i.name} (Diffuse)`,i.albedoTexture=r})),t.specularGlossinessTexture&&(s.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,r=>{r.name=`${i.name} (Specular Glossiness)`,i.reflectivityTexture=r,i.reflectivityTexture.hasAlpha=!0})),i.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(s).then(()=>{})}}Ae.RegisterExtension(Vd,o=>new mD(o));const Gd="KHR_materials_unlit";class ED{constructor(e){this.name=Gd,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Gd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,i))}_loadUnlitPropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const s=new Array;i.unlit=!0;const r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(i.albedoColor=J.FromArray(r.baseColorFactor),i.alpha=r.baseColorFactor[3]):i.albedoColor=J.White(),r.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,r.baseColorTexture,n=>{n.name=`${i.name} (Base Color)`,i.albedoTexture=n}))),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(s).then(()=>{})}}Ae.RegisterExtension(Gd,o=>new ED(o));const zd="KHR_materials_clearcoat";class TD{constructor(e){this.name=zd,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(zd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadClearCoatPropertiesAsync(s,r,i)),Promise.all(n).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.clearCoat.isEnabled=!0,i.clearCoat.useRoughnessFromMainTexture=!1,i.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?i.clearCoat.intensity=t.clearcoatFactor:i.clearCoat.intensity=0,t.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,r=>{r.name=`${i.name} (ClearCoat Intensity)`,i.clearCoat.texture=r})),t.clearcoatRoughnessFactor!=null?i.clearCoat.roughness=t.clearcoatRoughnessFactor:i.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,r=>{r.name=`${i.name} (ClearCoat Roughness)`,i.clearCoat.textureRoughness=r}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,r=>{r.name=`${i.name} (ClearCoat Normal)`,i.clearCoat.bumpTexture=r})),i.invertNormalMapX=!i.getScene().useRightHandedSystem,i.invertNormalMapY=i.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(i.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(s).then(()=>{})}}Ae.RegisterExtension(zd,o=>new TD(o));const Hd="KHR_materials_iridescence";class vD{constructor(e){this.name=Hd,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Hd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIridescencePropertiesAsync(s,r,i)),Promise.all(n).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){var s,r,n,a,l;if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const h=new Array;return i.iridescence.isEnabled=!0,i.iridescence.intensity=(s=t.iridescenceFactor)!==null&&s!==void 0?s:0,i.iridescence.indexOfRefraction=(n=(r=t.iridescenceIor)!==null&&r!==void 0?r:t.iridescenceIOR)!==null&&n!==void 0?n:1.3,i.iridescence.minimumThickness=(a=t.iridescenceThicknessMinimum)!==null&&a!==void 0?a:100,i.iridescence.maximumThickness=(l=t.iridescenceThicknessMaximum)!==null&&l!==void 0?l:400,t.iridescenceTexture&&h.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,c=>{c.name=`${i.name} (Iridescence Intensity)`,i.iridescence.texture=c})),t.iridescenceThicknessTexture&&h.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,c=>{c.name=`${i.name} (Iridescence Thickness)`,i.iridescence.thicknessTexture=c})),Promise.all(h).then(()=>{})}}Ae.RegisterExtension(Hd,o=>new vD(o));const Wd="KHR_materials_anisotropy";class AD{constructor(e){this.name=Wd,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Wd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIridescencePropertiesAsync(s,r,i)),Promise.all(n).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){var s,r;if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const n=new Array;return i.anisotropy.isEnabled=!0,i.anisotropy.intensity=(s=t.anisotropyStrength)!==null&&s!==void 0?s:0,i.anisotropy.angle=(r=t.anisotropyRotation)!==null&&r!==void 0?r:0,t.anisotropyTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,a=>{a.name=`${i.name} (Anisotropy Intensity)`,i.anisotropy.texture=a})),Promise.all(n).then(()=>{})}}Ae.RegisterExtension(Wd,o=>new AD(o));const Xd="KHR_materials_emissive_strength";class RD{constructor(e){this.name=Xd,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>this._loader.loadMaterialPropertiesAsync(e,t,i).then(()=>{this._loadEmissiveProperties(s,r,i)}))}_loadEmissiveProperties(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&i.emissiveColor.scaleToRef(t.emissiveStrength,i.emissiveColor)}}Ae.RegisterExtension(Xd,o=>new RD(o));const Yd="KHR_materials_sheen";class bD{constructor(e){this.name=Yd,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Yd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadSheenPropertiesAsync(s,r,i)),Promise.all(n).then(()=>{})})}_loadSheenPropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const s=new Array;return i.sheen.isEnabled=!0,i.sheen.intensity=1,t.sheenColorFactor!=null?i.sheen.color=J.FromArray(t.sheenColorFactor):i.sheen.color=J.Black(),t.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,r=>{r.name=`${i.name} (Sheen Color)`,i.sheen.texture=r})),t.sheenRoughnessFactor!==void 0?i.sheen.roughness=t.sheenRoughnessFactor:i.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,r=>{r.name=`${i.name} (Sheen Roughness)`,i.sheen.textureRoughness=r}))),i.sheen.albedoScaling=!0,i.sheen.useRoughnessFromMainTexture=!1,Promise.all(s).then(()=>{})}}Ae.RegisterExtension(Yd,o=>new bD(o));const Kd="KHR_materials_specular";class SD{constructor(e){this.name=Kd,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Kd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadSpecularPropertiesAsync(s,r,i)),Promise.all(n).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const s=new Array;return t.specularFactor!==void 0&&(i.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(i.metallicReflectanceColor=J.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,r=>{r.name=`${i.name} (Specular F0 Strength)`,i.metallicReflectanceTexture=r,i.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,r=>{r.name=`${i.name} (Specular F0 Color)`,i.reflectanceTexture=r})),Promise.all(s).then(()=>{})}}Ae.RegisterExtension(Kd,o=>new SD(o));const $d="KHR_materials_ior";class iu{constructor(e){this.name=$d,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed($d)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadIorPropertiesAsync(s,r,i)),Promise.all(n).then(()=>{})})}_loadIorPropertiesAsync(e,t,i){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?i.indexOfRefraction=t.ior:i.indexOfRefraction=iu._DEFAULT_IOR,Promise.resolve()}}iu._DEFAULT_IOR=1.5;Ae.RegisterExtension($d,o=>new iu(o));const ns="KHR_materials_variants";class ln{constructor(e){this.name=ns,this._loader=e,this.enabled=this._loader.isExtensionUsed(ns)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return ln.GetAvailableVariants(e)}static SelectVariant(e,t){const i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${ns} extension`);const s=r=>{const n=i.variants[r];if(n)for(const a of n)a.mesh.material=a.material};if(t instanceof Array)for(const r of t)s(r);else s(t);i.lastSelected=t}selectVariant(e,t){return ln.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${ns} extension`);for(const i of t.original)i.mesh.material=i.material;t.lastSelected=null}reset(e){return ln.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${ns} extension`);return t.lastSelected}getLastSelectedVariant(e){return ln.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,i;return((i=(t=e==null?void 0:e._internalMetadata)===null||t===void 0?void 0:t.gltf)===null||i===void 0?void 0:i[ns])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,i,s,r,n){return Ae.LoadExtensionAsync(e,r,this.name,(a,l)=>{const h=new Array;return h.push(this._loader._loadMeshPrimitiveAsync(e,t,i,s,r,c=>{if(n(c),c instanceof re){const u=Ae._GetDrawMode(e,r.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},p=f.gltf=f.gltf||{},_=p[ns]=p[ns]||{lastSelected:null,original:[],variants:{}};_.original.push({mesh:c,material:c.material});for(let g=0;g<l.mappings.length;++g){const E=l.mappings[g],R=Ye.Get(`${a}/mappings/${g}/material`,this._loader.gltf.materials,E.material);h.push(this._loader._loadMaterialAsync(`#/materials/${E.material}`,R,c,u,x=>{for(let S=0;S<E.variants.length;++S){const b=E.variants[S],y=Ye.Get(`/extensions/${ns}/variants/${b}`,this._variants,b);_.variants[y.name]=_.variants[y.name]||[],_.variants[y.name].push({mesh:c,material:x}),c.onClonedObservable.add(I=>{const O=I;let N=null,w=O;do{if(w=w.parent,!w)return;N=ln._GetExtensionMetadata(w)}while(N===null);if(d&&N===ln._GetExtensionMetadata(d)){w._internalMetadata={};for(const G in d._internalMetadata)w._internalMetadata[G]=d._internalMetadata[G];w._internalMetadata.gltf=[];for(const G in d._internalMetadata.gltf)w._internalMetadata.gltf[G]=d._internalMetadata.gltf[G];w._internalMetadata.gltf[ns]={lastSelected:null,original:[],variants:{}};for(const G of N.original)w._internalMetadata.gltf[ns].original.push({mesh:G.mesh,material:G.material});for(const G in N.variants)if(Object.prototype.hasOwnProperty.call(N.variants,G)){w._internalMetadata.gltf[ns].variants[G]=[];for(const k of N.variants[G])w._internalMetadata.gltf[ns].variants[G].push({mesh:k.mesh,material:k.material})}N=w._internalMetadata.gltf[ns]}for(const G of N.original)G.mesh===c&&(G.mesh=O);for(const G of N.variants[y.name])G.mesh===c&&(G.mesh=O)})}}))}}})),Promise.all(h).then(([c])=>c)})}}Ae.RegisterExtension(ns,o=>new ln(o));class wf{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:B.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...wf._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new j,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(r=>this._options[r]!==e[r]).length)return;const i={...this._options,...e},s=this._options;this._options=i,i.renderSize!==s.renderSize||i.renderTargetTextureType!==s.renderTargetTextureType||i.generateMipmaps!==s.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof me&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),Y.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof me&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),i!==-1?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):i===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return((e=this._opaqueRenderTarget)===null||e===void 0?void 0:e.getInternalTexture())!==null}_setupRenderTargets(){var e,t;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Ki("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=(t=(e=this._options.clearColor)===null||e===void 0?void 0:e.clone())!==null&&t!==void 0?t:this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0;let i,s;this._opaqueRenderTarget.onBeforeBindObservable.add(r=>{s=this._scene.environmentIntensity,this._scene.environmentIntensity=1,i=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?r.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(r.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=s,this._scene.imageProcessingConfiguration._applyByPostProcess=i}),this._transparentMeshesCache.forEach(r=>{this._shouldRenderAsTransmission(r.material)&&(r.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const jd="KHR_materials_transmission";class yD{constructor(e){this.name=jd,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(jd),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadTransparentPropertiesAsync(s,t,i,r)),Promise.all(n).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,i,s){var r,n;if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const a=i;if(a.subSurface.isRefractionEnabled=!0,a.subSurface.volumeIndexOfRefraction=1,a.subSurface.useAlbedoToTintRefraction=!0,s.transmissionFactor!==void 0){a.subSurface.refractionIntensity=s.transmissionFactor;const l=a.getScene();a.subSurface.refractionIntensity&&!l._transmissionHelper?new wf({},a.getScene()):a.subSurface.refractionIntensity&&!(!((r=l._transmissionHelper)===null||r===void 0)&&r._isRenderTargetValid())&&((n=l._transmissionHelper)===null||n===void 0||n._setupRenderTargets())}else return a.subSurface.refractionIntensity=0,a.subSurface.isRefractionEnabled=!1,Promise.resolve();return a.subSurface.minimumThickness=0,a.subSurface.maximumThickness=0,s.transmissionTexture?(s.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,s.transmissionTexture,void 0).then(l=>{a.subSurface.refractionIntensityTexture=l,a.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}Ae.RegisterExtension(jd,o=>new yD(o));const qd="KHR_materials_translucency";class CD{constructor(e){this.name=qd,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(qd),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadTranslucentPropertiesAsync(s,t,i,r)),Promise.all(n).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,i,s){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);const r=i;if(r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!0,s.translucencyFactor!==void 0)r.subSurface.translucencyIntensity=s.translucencyFactor;else return r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return s.translucencyTexture?(s.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,s.translucencyTexture).then(n=>{r.subSurface.translucencyIntensityTexture=n})):Promise.resolve()}}Ae.RegisterExtension(qd,o=>new CD(o));const Zd="KHR_materials_volume";class xD{constructor(e){this.name=Zd,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Zd),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadVolumePropertiesAsync(s,t,i,r)),Promise.all(n).then(()=>{})})}_loadVolumePropertiesAsync(e,t,i,s){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);if(!i.subSurface.isRefractionEnabled&&!i.subSurface.isTranslucencyEnabled||!s.thicknessFactor)return Promise.resolve();i.subSurface.volumeIndexOfRefraction=i.indexOfRefraction;const r=s.attenuationDistance!==void 0?s.attenuationDistance:Number.MAX_VALUE;return i.subSurface.tintColorAtDistance=r,s.attenuationColor!==void 0&&s.attenuationColor.length==3&&i.subSurface.tintColor.copyFromFloats(s.attenuationColor[0],s.attenuationColor[1],s.attenuationColor[2]),i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=s.thicknessFactor,i.subSurface.useThicknessAsDepth=!0,s.thicknessTexture?(s.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,s.thicknessTexture).then(n=>{i.subSurface.thicknessTexture=n,i.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}Ae.RegisterExtension(Zd,o=>new xD(o));const Qd="KHR_materials_dispersion";class MD{constructor(e){this.name=Qd,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Qd)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return n.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),n.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),n.push(this._loadDispersionPropertiesAsync(s,t,i,r)),Promise.all(n).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,i,s){if(!(i instanceof me))throw new Error(`${e}: Material type not supported`);return!i.subSurface.isRefractionEnabled||!s.dispersion||(i.subSurface.isDispersionEnabled=!0,i.subSurface.dispersion=s.dispersion),Promise.resolve()}}Ae.RegisterExtension(Qd,o=>new MD(o));const Jd="KHR_mesh_quantization";class ID{constructor(e){this.name=Jd,this.enabled=e.isExtensionUsed(Jd)}dispose(){}}Ae.RegisterExtension(Jd,o=>new ID(o));const ef="KHR_texture_basisu";class PD{constructor(e){this.name=ef,this._loader=e,this.enabled=e.isExtensionUsed(ef)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=t.sampler==null?Ae.DefaultSampler:Ye.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Ye.Get(`${s}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,n,a,l=>{i(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}Ae.RegisterExtension(ef,o=>new PD(o));const tf="KHR_texture_transform";class DD{constructor(e){this.name=tf,this._loader=e,this.enabled=this._loader.isExtensionUsed(tf)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>this._loader.loadTextureInfoAsync(e,t,n=>{if(!(n instanceof V))throw new Error(`${s}: Texture type not supported`);r.offset&&(n.uOffset=r.offset[0],n.vOffset=r.offset[1]),n.uRotationCenter=0,n.vRotationCenter=0,r.rotation&&(n.wAng=-r.rotation),r.scale&&(n.uScale=r.scale[0],n.vScale=r.scale[1]),r.texCoord!=null&&(n.coordinatesIndex=r.texCoord),i(n)}))}}Ae.RegisterExtension(tf,o=>new DD(o));const sf="KHR_xmp_json_ld";class OD{constructor(e){this.name=sf,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(sf)}dispose(){this._loader=null}onLoading(){var e,t,i;if(this._loader.rootBabylonMesh===null)return;const s=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_xmp_json_ld,r=(i=(t=this._loader.gltf.asset)===null||t===void 0?void 0:t.extensions)===null||i===void 0?void 0:i.KHR_xmp_json_ld;if(s&&r){const n=+r.packet;s.packets&&n<s.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=s.packets[n])}}}Ae.RegisterExtension(sf,o=>new OD(o));function Va(o,e,t,i){return J.FromArray(e,t).scale(i)}function ND(o,e,t,i){return e[t+3]*i}function Xt(o,e,t,i){return e[t]*i}function rf(o,e,t,i){return-e[t]*i}function wc(o,e,t,i){return e[t+1]*i}function Og(o,e,t,i){return e[t]*i*2}function hd(o){return{scale:[new wt(W.ANIMATIONTYPE_FLOAT,`${o}.uScale`,Xt,()=>2),new wt(W.ANIMATIONTYPE_FLOAT,`${o}.vScale`,wc,()=>2)],offset:[new wt(W.ANIMATIONTYPE_FLOAT,`${o}.uOffset`,Xt,()=>2),new wt(W.ANIMATIONTYPE_FLOAT,`${o}.vOffset`,wc,()=>2)],rotation:[new wt(W.ANIMATIONTYPE_FLOAT,`${o}.wAng`,rf,()=>1)]}}class Or extends Nh{buildAnimations(e,t,i,s,r){r(e._babylonCamera,this._buildAnimation(t,i,s))}}class wt extends Nh{buildAnimations(e,t,i,s,r){for(const n in e._data)r(e._data[n].babylonMaterial,this._buildAnimation(t,i,s))}}class Kl extends Nh{buildAnimations(e,t,i,s,r){r(e._babylonLight,this._buildAnimation(t,i,s))}}const LD={__array__:{__target__:!0,...th}},FD={__array__:{__target__:!0,orthographic:{xmag:[new Or(W.ANIMATIONTYPE_FLOAT,"orthoLeft",rf,()=>1),new Or(W.ANIMATIONTYPE_FLOAT,"orthoRight",wc,()=>1)],ymag:[new Or(W.ANIMATIONTYPE_FLOAT,"orthoBottom",rf,()=>1),new Or(W.ANIMATIONTYPE_FLOAT,"orthoTop",wc,()=>1)],zfar:[new Or(W.ANIMATIONTYPE_FLOAT,"maxZ",Xt,()=>1)],znear:[new Or(W.ANIMATIONTYPE_FLOAT,"minZ",Xt,()=>1)]},perspective:{yfov:[new Or(W.ANIMATIONTYPE_FLOAT,"fov",Xt,()=>1)],zfar:[new Or(W.ANIMATIONTYPE_FLOAT,"maxZ",Xt,()=>1)],znear:[new Or(W.ANIMATIONTYPE_FLOAT,"minZ",Xt,()=>1)]}}},wD={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new wt(W.ANIMATIONTYPE_COLOR3,"albedoColor",Va,()=>4),new wt(W.ANIMATIONTYPE_FLOAT,"alpha",ND,()=>4)],metallicFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"metallic",Xt,()=>1)],roughnessFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"roughness",Xt,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:hd("albedoTexture")}}},emissiveFactor:[new wt(W.ANIMATIONTYPE_COLOR3,"emissiveColor",Va,()=>3)],normalTexture:{scale:[new wt(W.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Xt,()=>1)]},occlusionTexture:{strength:[new wt(W.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Xt,()=>1)],extensions:{KHR_texture_transform:hd("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:hd("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new wt(W.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Xt,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Xt,()=>1)],clearcoatRoughnessFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Xt,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new wt(W.ANIMATIONTYPE_COLOR3,"sheen.color",Va,()=>3)],sheenRoughnessFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"sheen.roughness",Xt,()=>1)]},KHR_materials_specular:{specularFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Xt,()=>1)],specularColorFactor:[new wt(W.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",Va,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new wt(W.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Xt,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Xt,()=>1)]},KHR_materials_volume:{attenuationColor:[new wt(W.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",Va,()=>3)],attenuationDistance:[new wt(W.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Xt,()=>1)],thicknessFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Xt,()=>1)]},KHR_materials_dispersion:{dispersion:[new wt(W.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",Xt,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new wt(W.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Xt,()=>1)],iridescenceIor:[new wt(W.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Xt,()=>1)],iridescenceThicknessMinimum:[new wt(W.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Xt,()=>1)],iridescenceThicknessMaximum:[new wt(W.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Xt,()=>1)]},KHR_materials_anisotropy:{anisotropyStrength:[new wt(W.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",Xt,()=>1)],anisotropyRotation:[new wt(W.ANIMATIONTYPE_FLOAT,"anisotropy.angle",Xt,()=>1)]}}}},BD={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new Kl(W.ANIMATIONTYPE_COLOR3,"diffuse",Va,()=>3)],intensity:[new Kl(W.ANIMATIONTYPE_FLOAT,"intensity",Xt,()=>1)],range:[new Kl(W.ANIMATIONTYPE_FLOAT,"range",Xt,()=>1)],spot:{innerConeAngle:[new Kl(W.ANIMATIONTYPE_FLOAT,"innerAngle",Og,()=>1)],outerConeAngle:[new Kl(W.ANIMATIONTYPE_FLOAT,"angle",Og,()=>1)]}}}}},UD={nodes:LD,materials:wD,cameras:FD,extensions:BD},nf="KHR_animation_pointer";class kD{constructor(e){this.name=nf,this._loader=e}get enabled(){return this._loader.isExtensionUsed(nf)}dispose(){this._loader=null}_loadAnimationChannelAsync(e,t,i,s,r){var n;const a=(n=s.target.extensions)===null||n===void 0?void 0:n.KHR_animation_pointer;if(!a)return null;s.target.path!=="pointer"&&q.Warn(`${e}/target/path: Value (${s.target.path}) must be (pointer) when using the ${this.name} extension`),s.target.node!=null&&q.Warn(`${e}/target/node: Value (${s.target.node}) must not be present when using the ${this.name} extension`);const l=`${e}/extensions/${this.name}`,h=a.pointer;if(!h)throw new Error(`${l}: Pointer is missing`);const c=this._parseAnimationPointer(`${l}/pointer`,h);return c?this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,s,c,r):(q.Warn(`${l}/pointer: Invalid pointer (${h}) skipped`),null)}_parseAnimationPointer(e,t){if(!t.startsWith("/"))return q.Warn(`${e}: Value (${t}) must start with a slash`),null;const i=t.split("/");i.shift();let s=UD,r=this._loader.gltf,n;for(const a of i){if(s.__array__)s=s.__array__;else if(s=s[a],!s)return null;r=r&&r[a],s.__target__&&(n=r)}return!n||!Array.isArray(s)?null:{target:n,properties:s}}}Ae.RegisterExtension(nf,o=>new kD(o));class Jn{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(!((e=H.audioEngine)===null||e===void 0)&&e.audioContext&&(this.isPlaying||this.isPaused)){const t=this.isPaused?0:H.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;const t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,s=null,r){var n,a,l,h,c;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new j,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=m.Zero(),this._localDirection=new m(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||Ze.LastCreatedScene,!!i)if(this._scene=i,Jn._SceneComponentInitialization(i),this._readyToPlayCallback=s,this._customAttenuationFunction=(u,d,f,p,_)=>d<f?u*(1-d/f):0,r&&(this.autoplay=r.autoplay||!1,this._loop=r.loop||!1,r.volume!==void 0&&(this._volume=r.volume),this._spatialSound=(n=r.spatialSound)!==null&&n!==void 0?n:!1,this.maxDistance=(a=r.maxDistance)!==null&&a!==void 0?a:100,this.useCustomAttenuation=(l=r.useCustomAttenuation)!==null&&l!==void 0?l:!1,this.rolloffFactor=r.rolloffFactor||1,this.refDistance=r.refDistance||1,this.distanceModel=r.distanceModel||"linear",this._playbackRate=r.playbackRate||1,this._streaming=(h=r.streaming)!==null&&h!==void 0?h:!1,this._length=r.length,this._offset=r.offset),!((c=H.audioEngine)===null||c===void 0)&&c.canUseWebAudio&&H.audioEngine.audioContext){this._soundGain=H.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let u=!0;if(t)try{typeof t=="string"?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let d=[],f=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=H.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=H.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(f=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":d.push(t);case"Array":d.length===0&&(d=t);for(let p=0;p<d.length;p++){const _=d[p];if(f=r&&r.skipCodecCheck||_.indexOf(".mp3",_.length-4)!==-1&&H.audioEngine.isMP3supported||_.indexOf(".ogg",_.length-4)!==-1&&H.audioEngine.isOGGsupported||_.indexOf(".wav",_.length-4)!==-1||_.indexOf(".m4a",_.length-4)!==-1||_.indexOf(".mp4",_.length-4)!==-1||_.indexOf("blob:")!==-1,f){this._streaming?(this._htmlAudioElement=new Audio(_),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,Y.SetCorsBehavior(_,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(_,g=>{this._soundLoaded(g)},void 0,!0,!0,g=>{g&&q.Error("XHR "+g.status+" error on: "+_+"."),q.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:u=!1;break}u?f||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):q.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{q.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),H.audioEngine&&!H.audioEngine.WarnedWebAudioUnsupported&&(q.Error("Web Audio is not supported by your browser."),H.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){var e;!((e=H.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;!((t=H.audioEngine)===null||t===void 0)&&t.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;!((t=H.audioEngine)===null||t===void 0)&&t.audioContext&&H.audioEngine.audioContext.decodeAudioData(e,i=>{this._audioBufferLoaded(i)},i=>{q.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(e){var t;!((t=H.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var t,i,s,r,n,a,l,h,c,u,d;e&&(this.loop=(t=e.loop)!==null&&t!==void 0?t:this.loop,this.maxDistance=(i=e.maxDistance)!==null&&i!==void 0?i:this.maxDistance,this.useCustomAttenuation=(s=e.useCustomAttenuation)!==null&&s!==void 0?s:this.useCustomAttenuation,this.rolloffFactor=(r=e.rolloffFactor)!==null&&r!==void 0?r:this.rolloffFactor,this.refDistance=(n=e.refDistance)!==null&&n!==void 0?n:this.refDistance,this.distanceModel=(a=e.distanceModel)!==null&&a!==void 0?a:this.distanceModel,this._playbackRate=(l=e.playbackRate)!==null&&l!==void 0?l:this._playbackRate,this._length=(h=e.length)!==null&&h!==void 0?h:void 0,this.spatialSound=(c=e.spatialSound)!==null&&c!==void 0?c:this._spatialSound,this._setOffset((u=e.offset)!==null&&u!==void 0?u:void 0),this.setVolume((d=e.volume)!==null&&d!==void 0?d:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e,t;!((e=H.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&H.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(t=this._soundPanner)!==null&&t!==void 0?t:H.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){var e;this._spatialSound&&(this._inputAudioNode=this._soundGain,(e=this._soundPanner)===null||e===void 0||e.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;!((e=H.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;!((t=H.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){q.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){q.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,!((t=H.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){q.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,!((t=H.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),!((t=H.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,!((t=H.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=m.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if(!((e=H.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var s,r,n,a;if(this._isReadyToPlay&&this._scene.audioEnabled&&(!((s=H.audioEngine)===null||s===void 0)&&s.audioContext))try{this._clearTimeoutsAndObservers();let l=e?((r=H.audioEngine)===null||r===void 0?void 0:r.audioContext.currentTime)+e:(n=H.audioEngine)===null||n===void 0?void 0:n.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=H.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const h=()=>{var c,u;if(!((c=H.audioEngine)===null||c===void 0)&&c.unlocked){const d=this._htmlAudioElement.play();d!==void 0&&d.catch(()=>{var f,p;(f=H.audioEngine)===null||f===void 0||f.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(p=H.audioEngine)===null||p===void 0?void 0:p.onAudioUnlockedObservable.addOnce(()=>{h()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=(u=H.audioEngine)===null||u===void 0?void 0:u.onAudioUnlockedObservable.addOnce(()=>{h()}))};h()}}else{const h=()=>{var c,u,d,f;if(!((c=H.audioEngine)===null||c===void 0)&&c.audioContext){if(i=i||this._length,t!==void 0&&this._setOffset(t),this._soundSource){const p=this._soundSource;p.onended=()=>{p.disconnect()}}if(this._soundSource=(u=H.audioEngine)===null||u===void 0?void 0:u.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((d=H.audioEngine)===null||d===void 0?void 0:d.audioContext.currentTime)+e:H.audioEngine.audioContext.currentTime;const p=((this.isPaused?this.currentTime:0)+((f=this._offset)!==null&&f!==void 0?f:0))%this._soundSource.buffer.duration;this._soundSource.start(l,p,this.loop?void 0:i)}}};((a=H.audioEngine)===null||a===void 0?void 0:a.audioContext.state)==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{var c;((c=H.audioEngine)===null||c===void 0?void 0:c.audioContext.state)==="suspended"?(H.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=H.audioEngine.onAudioUnlockedObservable.addOnce(()=>{h()}))):h()},500):h()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){q.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t;if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(!((t=H.audioEngine)===null||t===void 0)&&t.audioContext&&this._soundSource){const i=e?H.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(i)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){var e;this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):!((e=H.audioEngine)===null||e===void 0)&&e.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=H.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;!((i=H.audioEngine)===null||i===void 0)&&i.canUseWebAudio&&this._soundGain&&(t&&H.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(H.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,H.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,H.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const s=e.getBoundingInfo();this.setPosition(s.boundingSphere.centerWorld)}!((t=H.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new Jn(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,s){const r=e.name;let n;e.url?n=i+e.url:n=i+r;const a={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!s)l=new Jn(r,n,t,()=>{t.removePendingData(l)},a),t.addPendingData(l);else{const h=()=>{s._isReadyToPlay?(l._audioBuffer=s.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)):setTimeout(h,300)};l=new Jn(r,new ArrayBuffer(0),t,null,a),h()}if(e.position){const h=m.FromArray(e.position);l.setPosition(h)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const h=m.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(h)}if(e.connectedMeshId){const h=t.getMeshById(e.connectedMeshId);h&&l.attachToMesh(h)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){var e;this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&((e=H.audioEngine)===null||e===void 0||e.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}Jn._SceneComponentInitialization=o=>{throw ke("AudioSceneComponent")};class VD{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let s=0;for(const n of i)s+=n;const r=s>0?1/s:0;for(let n=0;n<this._weights.length;n++)this._weights[n]*=r;this._sounds=t;for(const n of this._sounds)n.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){q.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){q.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const i=Math.random();let s=0;for(let r=0;r<this._weights.length;r++)if(s+=this._weights[r],i<=s){this._currentIndex=r;break}}const t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}const af="MSFT_audio_emitter";class GD{constructor(e){this.name=af,this._loader=e,this.enabled=this._loader.isExtensionUsed(af)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,Ye.Assign(this._clips),Ye.Assign(this._emitters)}}loadSceneAsync(e,t){return Ae.LoadExtensionAsync(e,t,this.name,(i,s)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t));for(const n of s.emitters){const a=Ye.Get(`${i}/emitters`,this._emitters,n);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);r.push(this._loadEmitterAsync(`${i}/emitters/${a.index}`,a))}return Promise.all(r).then(()=>{})})}loadNodeAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{const n=new Array;return this._loader.loadNodeAsync(s,t,a=>{for(const l of r.emitters){const h=Ye.Get(`${s}/emitters`,this._emitters,l);n.push(this._loadEmitterAsync(`${s}/emitters/${h.index}`,h).then(()=>{for(const c of h._babylonSounds)c.attachToMesh(a),(h.innerAngle!=null||h.outerAngle!=null)&&(c.setLocalDirectionToMesh(m.Forward()),c.setDirectionalCone(2*Y.ToDegrees(h.innerAngle==null?Math.PI:h.innerAngle),2*Y.ToDegrees(h.outerAngle==null?Math.PI:h.outerAngle),0))}))}i(a)}).then(a=>Promise.all(n).then(()=>a))})}loadAnimationAsync(e,t){return Ae.LoadExtensionAsync(e,t,this.name,(i,s)=>this._loader.loadAnimationAsync(e,t).then(r=>{const n=new Array;Ye.Assign(s.events);for(const a of s.events)n.push(this._loadAnimationEventAsync(`${i}/events/${a.index}`,e,t,a,r));return Promise.all(n).then(()=>r)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{const s=Ye.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}return t._objectURL=i.then(s=>URL.createObjectURL(new Blob([s],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const i=new Array,s=t.name||`emitter${t.index}`,r={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){const l=`/extensions/${this.name}/clips`,h=Ye.Get(l,this._clips,t.clips[a].clip);i.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,h).then(c=>{const u=t._babylonSounds[a]=new Jn(s,c,this._loader.babylonScene,null,r);u.refDistance=t.refDistance||1,u.maxDistance=t.maxDistance||256,u.rolloffFactor=t.rolloffFactor||1,u.distanceModel=t.distanceModel||"exponential"}))}const n=Promise.all(i).then(()=>{const a=t.clips.map(h=>h.weight||1),l=new VD(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*Y.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*Y.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:n}}return t._babylonData.loaded}_getEventAction(e,t,i,s,r){switch(i){case"play":return n=>{const a=(r||0)+(n-s);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,s,r){if(r.targetedAnimations.length==0)return Promise.resolve();const n=r.targetedAnimations[0],a=s.emitter,l=Ye.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{const h=l._babylonData.sound;if(h){const c=new If(s.time,this._getEventAction(e,h,s.action,s.time,s.startOffset));n.animation.addEvent(c),r.onAnimationGroupEndObservable.add(()=>{h.stop()}),r.onAnimationGroupPauseObservable.add(()=>{h.pause()})}})}}Ae.RegisterExtension(af,o=>new GD(o));const of="MSFT_lod";class zD{constructor(e){this.name=of,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new j,this.onMaterialLODsLoadedObservable=new j,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(of)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return Ae.LoadExtensionAsync(e,t,this.name,(s,r)=>{let n;const a=this._getLODs(s,t,this._loader.gltf.nodes,r.ids);this._loader.logOpen(`${s}`);for(let l=0;l<a.length;l++){const h=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new eh);const c=d=>{i(d),d.setEnabled(!1)},u=this._loader.loadNodeAsync(`/nodes/${h.index}`,h,c).then(d=>{if(l!==0){const f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?n=u:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(u))}return this._loader.logClose(),n})}_loadMaterialAsync(e,t,i,s,r){return this._nodeIndexLOD?null:Ae.LoadExtensionAsync(e,t,this.name,(n,a)=>{let l;const h=this._getLODs(n,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${n}`);for(let c=0;c<h.length;c++){const u=h[c];c!==0&&(this._materialIndexLOD=c);const d=this._loader._loadMaterialAsync(`/materials/${u.index}`,u,i,s,f=>{c===0&&r(f)}).then(f=>{if(c!==0){r(f);const p=h[c-1]._data;p[s]&&(this._disposeMaterials([p[s].babylonMaterial]),delete p[s])}return f});this._materialPromiseLODs[c]=this._materialPromiseLODs[c]||[],c===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[c].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,i){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const s=this._nodeIndexLOD-1;return this._nodeSignalLODs[s]=this._nodeSignalLODs[s]||new eh,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,i))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const s=this._materialIndexLOD-1;return this._materialSignalLODs[s]=this._materialSignalLODs[s]||new eh,this._materialSignalLODs[s].promise.then(()=>this._loader.loadUriAsync(e,t,i))}return null}loadBufferAsync(e,t,i,s){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const r=(n,a)=>{const l=i,h=l+s-1;let c=n[a];return c?(c.start=Math.min(c.start,l),c.end=Math.max(c.end,h)):(c={start:l,end:h,loaded:new eh},n[a]=c),c.loaded.promise.then(u=>new Uint8Array(u.buffer,u.byteOffset+i-c.start,s))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?r(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?r(this._materialBufferLODs,this._materialIndexLOD):r(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(s=>{i.loaded.resolve(s)},s=>{i.loaded.reject(s)}))}_getLODs(e,t,i,s){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=[];for(let n=s.length-1;n>=0;n--)if(r.push(Ye.Get(`${e}/ids/${s[n]}`,i,s[n])),r.length===this.maxLODsToLoad)return r;return r.push(t),r}_disposeTransformNode(e){const t=[],i=e.material;i&&t.push(i);for(const r of e.getChildMeshes())r.material&&t.push(r.material);e.dispose();const s=t.filter(r=>this._loader.babylonScene.meshes.every(n=>n.material!=r));this._disposeMaterials(s)}_disposeMaterials(e){const t={};for(const i of e){for(const s of i.getActiveTextures())t[s.uniqueId]=s;i.dispose()}for(const i in t)for(const s of this._loader.babylonScene.materials)s.hasTexture(t[i])&&delete t[i];for(const i in t)t[i].dispose()}}Ae.RegisterExtension(of,o=>new zD(o));const lf="MSFT_minecraftMesh";class HD{constructor(e){this.name=lf,this._loader=e,this.enabled=this._loader.isExtensionUsed(lf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtraAsync(e,t,this.name,(s,r)=>{if(r){if(!(i instanceof me))throw new Error(`${s}: Material type not supported`);const n=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,n}return null})}}Ae.RegisterExtension(lf,o=>new HD(o));const hf="MSFT_sRGBFactors";class WD{constructor(e){this.name=hf,this._loader=e,this.enabled=this._loader.isExtensionUsed(hf)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ae.LoadExtraAsync(e,t,this.name,(s,r)=>{if(r){if(!(i instanceof me))throw new Error(`${s}: Material type not supported`);const n=this._loader.loadMaterialPropertiesAsync(e,t,i),a=i.getScene().getEngine().useExactSrgbConversions;return i.albedoTexture||i.albedoColor.toLinearSpaceToRef(i.albedoColor,a),i.reflectivityTexture||i.reflectivityColor.toLinearSpaceToRef(i.reflectivityColor,a),n}return null})}}Ae.RegisterExtension(hf,o=>new WD(o));var vs;(function(o){o[o.Input=0]="Input",o[o.Output=1]="Output"})(vs||(vs={}));class cf{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=Qs(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(const t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}static Parse(e={},t){const i=Y.Instantiate(e.className),s=new i(e.name,e._connectionType,t);return s.deserialize(e),s}}class Ws{constructor(e,t){this.typeName=e,this.defaultValue=t}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}static Parse(e){return new Ws(e.typeName,e.defaultValue)}}const ge=new Ws("any",void 0),ci=new Ws("number",0),Nn=new Ws("boolean",!1),Ng=new Ws("Vector2",Ke.Zero()),Ka=new Ws("Vector3",m.Zero());new Ws("Vector4",ut.Zero());new Ws("Matrix",L.Identity());new Ws("Color3",J.Black());new Ws("Quaternion",le.Identity());class uf extends cf{constructor(e,t,i,s){super(e,t,i),this.richType=s}_isSingularConnection(){return this.connectionType===vs.Input}setValue(e,t){t._setConnectionValue(this,e)}connectTo(e){super.connectTo(e)}_getValueOrDefault(e){return e._hasConnectionValue(this)?e._getConnectionValue(this):this.richType.defaultValue}getValue(e){return this.connectionType===vs.Output?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e),this._getValueOrDefault(e)):this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e)}getClassName(){return"FGDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType)}static Parse(e,t){const i=cf.Parse(e,t);return i.richType=Ws.Parse(e.richType),i}}Re("FGDataConnection",uf);const XD=/([./])({?\w+}?)/g;class Ds{constructor(e){this._templateSubstitutions={},this._pathParts=[],this._templateStrings=[],this.hasTemplateStrings=!1,this._path=e;const{pathParts:t,templateStrings:i}=this._getPathPartsAndTemplateStrings(e);this._pathParts=t,this._templateStrings=i,this.hasTemplateStrings=i.length>0}_getPathPartsAndTemplateStrings(e){const t=e.matchAll(XD),i=[],s=[];let r=t.next();for(;!r.done;){const n=r.value,[,a,l]=n;let h=l,c=!1;l.startsWith("{")&&l.endsWith("}")&&(c=!0,h=l.slice(1,l.length-1),s.indexOf(h)===-1&&s.push(h)),i.push({value:l,isTemplate:c,valueWithoutBraces:h,separator:a}),r=t.next()}return{pathParts:i,templateStrings:s}}getTemplateStrings(){return this._templateStrings}setTemplateSubstitution(e,t){if(this._templateStrings.indexOf(e)===-1)throw new Error(`Template string ${e} does not exist in path ${this._path}`);this._templateSubstitutions[e]=t}_evaluateTemplates(){for(const e of this._pathParts)if(e.isTemplate){const t=this._templateSubstitutions[e.valueWithoutBraces];if(t===void 0)throw new Error(`Template string ${e.value} was not substituted`);e.replacedValue=t.toString()}}getFinalPath(){let e="";for(const t of this._pathParts)e+=t.separator,t.isTemplate?e+=t.replacedValue:e+=t.value;return e}_evaluatePath(e){this._evaluateTemplates();const t=[],i=[];let s=e.userVariables;for(const r of this._pathParts){if(s===void 0)throw new Error(`Could not find path ${this.getFinalPath()} in target context`);const n=r.isTemplate?r.replacedValue:r.value;if(!n)throw new Error(`Invalid path ${this.getFinalPath()}`);s=s[n],t.push(s),i.push(n)}return{entityChain:t,splitPath:i}}getProperty(e){for(const i of Ds.Extensions)if(i.shouldProcess(this))return i.processGet(this,e);const{entityChain:t}=this._evaluatePath(e);return t[t.length-1]}setProperty(e,t){for(const a of Ds.Extensions)if(a.shouldProcess(this)){a.processSet(this,e,t);return}const{entityChain:i,splitPath:s}=this._evaluatePath(e),r=i[i.length-2],n=s[s.length-1];r[n]=t}getClassName(){return Ds.ClassName}serialize(e={}){return e.path=this._path,e.className=this.getClassName(),e}static Parse(e){return new Ds(e.path)}}Ds.Extensions=[];Ds.ClassName="FGPath";Re(Ds.ClassName,Ds);function lE(o){return o==="Mesh"||o==="AbstractMesh"||o==="GroundMesh"||o==="InstanceMesh"||o==="LinesMesh"||o==="GoldbergMesh"||o==="GreasedLineMesh"||o==="TrailMesh"}function hE(o){return o==="Vector2"||o==="Vector3"||o==="Vector4"||o==="Quaternion"||o==="Color3"||o==="Color4"}function YD(o,e){if(o==="Vector2")return Ke.FromArray(e);if(o==="Vector3")return m.FromArray(e);if(o==="Vector4")return ut.FromArray(e);if(o==="Quaternion")return le.FromArray(e);if(o==="Color3")return new J(e[0],e[1],e[2]);if(o==="Color4")return new He(e[0],e[1],e[2],e[3]);throw new Error(`Unknown vector class name ${o}`)}function cE(o,e,t){var i,s;const r=(s=(i=e==null?void 0:e.getClassName)===null||i===void 0?void 0:i.call(e))!==null&&s!==void 0?s:"";lE(r)?t[o]={name:e.name,className:r}:hE(r)?t[o]={value:e.asArray(),className:r}:t[o]=e}function uE(o,e,t){const i=e[o];let s;const r=i==null?void 0:i.className;return lE(r)?s=t.getMeshByName(i.name):hE(r)?s=YD(r,i.value):r===Ds.ClassName?s=Ds.Parse(i):i&&i.value!==void 0?s=i.value:s=i,s}class Lh{constructor(e){this.config=e,this.uniqueId=Qs(),this.configure()}configure(){var e,t;this.name=(t=(e=this.config)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t){const i=new uf(e,vs.Input,this,t);return this.dataInputs.push(i),i}registerDataOutput(e,t){const i=new uf(e,vs.Output,this,t);return this.dataOutputs.push(i),i}getDataInput(e){return this.dataInputs.find(t=>t.name===e)}getDataOutput(e){return this.dataOutputs.find(t=>t.name===e)}serialize(e={},t=cE){e.uniqueId=this.uniqueId,e.config={},this.config&&(e.config.name=this.config.name),e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(const i of this.dataInputs){const s={};i.serialize(s),e.dataInputs.push(s)}for(const i of this.dataOutputs){const s={};i.serialize(s),e.dataOutputs.push(s)}}getClassName(){return"FGBlock"}static Parse(e,t,i=uE){const s=Y.Instantiate(e.className),r={};if(e.config)for(const a in e.config)r[a]=i(a,e.config,t);const n=new s(r);n.uniqueId=e.uniqueId;for(let a=0;a<e.dataInputs.length;a++){const l=n.getDataInput(e.dataInputs[a].name);if(l)l.deserialize(e.dataInputs[a]);else throw new Error("Could not find data input with name "+e.dataInputs[a].name+" in block "+e.className)}for(let a=0;a<e.dataOutputs.length;a++){const l=n.getDataOutput(e.dataOutputs[a].name);if(l)l.deserialize(e.dataOutputs[a]);else throw new Error("Could not find data output with name "+e.dataOutputs[a].name+" in block "+e.className)}return n.metadata=e.metadata,n.deserialize&&n.deserialize(e),n}}class df extends cf{_isSingularConnection(){return this.connectionType===vs.Output}_activateSignal(e){var t;this.connectionType===vs.Input?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId()):(t=this._connectedPoint[0])===null||t===void 0||t._activateSignal(e)}}Re("FlowGraphSignalConnection",df);class $a extends Lh{constructor(e){super(e),this.in=this._registerSignalInput("in")}configure(){super.configure(),this.signalInputs=[],this.signalOutputs=[]}_registerSignalInput(e){const t=new df(e,vs.Input,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){const t=new df(e,vs.Output,this);return this.signalOutputs.push(t),t}getSignalInput(e){return this.signalInputs.find(t=>t.name===e)}getSignalOutput(e){return this.signalOutputs.find(t=>t.name===e)}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(const t of this.signalInputs){const i={};t.serialize(i),e.signalInputs.push(i)}for(const t of this.signalOutputs){const i={};t.serialize(i),e.signalOutputs.push(i)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){const i=this.getSignalInput(e.signalInputs[t].name);if(i)i.deserialize(e.signalInputs[t]);else throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className)}for(let t=0;t<e.signalOutputs.length;t++){const i=this.getSignalOutput(e.signalOutputs[t].name);if(i)i.deserialize(e.signalOutputs[t]);else throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className)}}getClassName(){return"FGExecutionBlock"}}class dE extends $a{constructor(e){super(e),this.out=this._registerSignalOutput("out"),this.done=this._registerSignalOutput("done")}_startPendingTasks(e){this._preparePendingTasks(e),e._addPendingBlock(this)}}class Fh extends dE{_execute(e){e._notifyExecuteNode(this),this.out._activateSignal(e)}}class ff{constructor(e){this.uniqueId=Qs(),this._userVariables={},this._executionVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new j,this._configuration=e}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t}getVariable(e){return this._userVariables[e]}get userVariables(){return this._userVariables}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t}_getConnectionValue(e){return this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}_addPendingBlock(e){this._pendingBlocks.push(e)}_removePendingBlock(e){const t=this._pendingBlocks.indexOf(e);t!==-1&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(const e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=cE){e.uniqueId=this.uniqueId,e._userVariables={};for(const i in this._userVariables)t(i,this._userVariables[i],e._userVariables);e._connectionValues={};for(const i in this._connectionValues)t(i,this._connectionValues[i],e._connectionValues)}getClassName(){return"FGContext"}static Parse(e,t,i=uE){const s=t.createContext();s.uniqueId=e.uniqueId;for(const r in e._userVariables){const n=i(r,e._userVariables,s._configuration.scene);s._userVariables[r]=n}for(const r in e._connectionValues){const n=i(r,e._connectionValues,s._configuration.scene);s._connectionValues[r]=n}return s}}v([M()],ff.prototype,"uniqueId",void 0);function Bf(o,e){return!!(o.parent&&(o.parent===e||Bf(o.parent,e)))}class no extends Fh{constructor(e){e.path.hasTemplateStrings&&Y.Warn("Template strings are not supported in the path of mesh pick event blocks."),super(e),this.config=e}_getReferencedMesh(e){return this.config.path.getProperty(e)}_preparePendingTasks(e){let t=e._getExecutionVariable(this,"meshPickObserver");if(!t){const i=this.config.path.getProperty(e);if(!i||!(i instanceof pi))throw new Error("Mesh pick event block requires a valid mesh");e._setExecutionVariable(this,"mesh",i),t=i.getScene().onPointerObservable.add(r=>{var n,a,l;r.type===xe.POINTERPICK&&(!((n=r.pickInfo)===null||n===void 0)&&n.pickedMesh)&&(((a=r.pickInfo)===null||a===void 0?void 0:a.pickedMesh)===i||Bf((l=r.pickInfo)===null||l===void 0?void 0:l.pickedMesh,i))&&this._execute(e)});const s=i.onDisposeObservable.add(()=>this._onDispose);e._setExecutionVariable(this,"meshPickObserver",t),e._setExecutionVariable(this,"meshDisposeObserver",s)}}_onDispose(e){this._cancelPendingTasks(e),e._removePendingBlock(this)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"mesh"),i=e._getExecutionVariable(this,"meshPickObserver"),s=e._getExecutionVariable(this,"meshDisposeObserver");t.getScene().onPointerObservable.remove(i),t.onDisposeObservable.remove(s),e._deleteExecutionVariable(this,"mesh"),e._deleteExecutionVariable(this,"meshPickObserver"),e._deleteExecutionVariable(this,"meshDisposeObserver")}getClassName(){return no.ClassName}serialize(e){super.serialize(e),e.config.path=this.config.path.serialize()}}no.ClassName="FGMeshPickEventBlock";Re(no.ClassName,no);var qn;(function(o){o[o.Stopped=0]="Stopped",o[o.Started=1]="Started"})(qn||(qn={}));class ao{constructor(e){this._eventBlocks=[],this._executionContexts=[],this.state=qn.Stopped,this._scene=e.scene,this._coordinator=e.coordinator,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>this.dispose())}createContext(){const e=new ff({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){this._eventBlocks.push(e)}start(){if(this.state!==qn.Started){this.state=qn.Started,this._executionContexts.length===0&&this.createContext();for(const e of this._executionContexts){const t=this._getContextualOrder(e);for(const i of t)i._startPendingTasks(e)}}}_getContextualOrder(e){const t=[];for(const i of this._eventBlocks)if(i.getClassName()===no.ClassName){const s=i._getReferencedMesh(e);let r=0;for(;r<t.length;r++){const a=t[r]._getReferencedMesh(e);if(s&&a&&Bf(s,a))break}t.splice(r,0,i)}else t.push(i);return t}dispose(){if(this.state!==qn.Stopped){this.state=qn.Stopped;for(const e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0,this._eventBlocks.length=0,this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null}}visitAllBlocks(e){const t=[],i=new Set;for(const s of this._eventBlocks)t.push(s),i.add(s.uniqueId);for(;t.length>0;){const s=t.pop();e(s);for(const r of s.dataInputs)for(const n of r._connectedPoint)i.has(n._ownerBlock.uniqueId)||(t.push(n._ownerBlock),i.add(n._ownerBlock.uniqueId));if(s instanceof $a)for(const r of s.signalOutputs)for(const n of r._connectedPoint)i.has(n._ownerBlock.uniqueId)||(t.push(n._ownerBlock),i.add(n._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks(i=>{const s={};i.serialize(s),e.allBlocks.push(s)}),e.executionContexts=[];for(const i of this._executionContexts){const s={};i.serialize(s,t),e.executionContexts.push(s)}}static GetDataOutConnectionByUniqueId(e,t){for(const i of e)for(const s of i.dataOutputs)if(s.uniqueId===t)return s;throw new Error("Could not find data out connection with unique id "+t)}static GetSignalInConnectionByUniqueId(e,t){for(const i of e)if(i instanceof $a){for(const s of i.signalInputs)if(s.uniqueId===t)return s}throw new Error("Could not find signal in connection with unique id "+t)}static Parse(e,t,i){const s=t.createGraph(),r=[];for(const n of e.allBlocks){const a=Lh.Parse(n,t.config.scene,i);r.push(a),a instanceof Fh&&s.addEventBlock(a)}for(const n of r){for(const a of n.dataInputs)for(const l of a.connectedPointIds){const h=ao.GetDataOutConnectionByUniqueId(r,l);a.connectTo(h)}if(n instanceof $a)for(const a of n.signalOutputs)for(const l of a.connectedPointIds){const h=ao.GetSignalInConnectionByUniqueId(r,l);a.connectTo(h)}}for(const n of e.executionContexts)ff.Parse(n,s,i);return s}}class ja{constructor(e){var t;this.config=e,this._flowGraphs=[],this._customEventsMap=new Map,this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),((t=ja.SceneCoordinators.get(this.config.scene))!==null&&t!==void 0?t:[]).push(this)}createGraph(){const e=new ao({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){const t=this._flowGraphs.indexOf(e);t!==-1&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){this._flowGraphs.forEach(e=>e.start())}dispose(){var e;this._flowGraphs.forEach(s=>s.dispose()),this._flowGraphs.length=0;const t=(e=ja.SceneCoordinators.get(this.config.scene))!==null&&e!==void 0?e:[],i=t.indexOf(this);i!==-1&&t.splice(i,1)}serialize(e,t){e._flowGraphs=[],this._flowGraphs.forEach(i=>{const s={};i.serialize(s,t),e._flowGraphs.push(s)})}static Parse(e,t,i){var s;const r=new ja({scene:t});return(s=e._flowGraphs)===null||s===void 0||s.forEach(n=>{ao.Parse(n,r,i)}),r}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new j,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t){const i=this._customEventsMap.get(e);i&&i.notifyObservers(t)}}ja.SceneCoordinators=new Map;class wh extends Fh{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneReadyObserver")){const i=e.configuration.scene.onReadyObservable.add(()=>{this._execute(e)});e._setExecutionVariable(this,"sceneReadyObserver",i)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneReadyObserver");e.configuration.scene.onReadyObservable.remove(t),e._deleteExecutionVariable(this,"sceneReadyObserver")}getClassName(){return wh.ClassName}}wh.ClassName="FGSceneReadyEventBlock";Re("FGSceneReadyEventBlock",wh);class oo extends Fh{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneBeforeRender")){const i=e.configuration.scene.onBeforeRenderObservable.add(()=>{this._execute(e)});e._setExecutionVariable(this,"sceneBeforeRender",i)}}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"sceneBeforeRender");e.configuration.scene.onBeforeRenderObservable.remove(t),e._deleteExecutionVariable(this,"sceneBeforeRender")}getClassName(){return oo.ClassName}}oo.ClassName="FGSceneTickEventBlock";Re(oo.ClassName,oo);class Sl extends $a{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}class lo extends Sl{constructor(e){super(e),this.message=this.registerDataInput("message",ge)}_execute(e){const t=this.message.getValue(e);q.Log(t),this.out._activateSignal(e)}getClassName(){return lo.ClassName}}lo.ClassName="FGConsoleLogBlock";Re(lo.ClassName,lo);var Zn;(function(o){o[o.INIT=0]="INIT",o[o.STARTED=1]="STARTED",o[o.ENDED=2]="ENDED"})(Zn||(Zn={}));class KD{constructor(e){var t,i;this.onEachCountObservable=new j,this.onTimerAbortedObservable=new j,this.onTimerEndedObservable=new j,this.onStateChangedObservable=new j,this._observer=null,this._breakOnNextTick=!1,this._tick=s=>{const r=Date.now();this._timer=r-this._startTime;const n={startTime:this._startTime,currentTime:r,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:s},a=this._breakOnNextTick||this._breakCondition(n);a||this._timer>=this._timeToEnd?this._stop(n,a):this.onEachCountObservable.notifyObservers(n)},this._setState(Zn.INIT),this._contextObservable=e.contextObservable,this._observableParameters=(t=e.observableParameters)!==null&&t!==void 0?t:{},this._breakCondition=(i=e.breakCondition)!==null&&i!==void 0?i:()=>!1,this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===Zn.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(Zn.STARTED)}stop(){this._state===Zn.STARTED&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(Zn.ENDED),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}class Bh extends dE{constructor(e){super(e),this.timeout=this.registerDataInput("timeout",ci)}_preparePendingTasks(e){const t=this.timeout.getValue(e);if(t!==void 0&&t>=0){const i=e._getExecutionVariable(this,"runningTimers")||[],s=e.configuration.scene,r=new KD({timeout:t,contextObservable:s.onBeforeRenderObservable,onEnded:()=>this._onEnded(r,e)});r.start(),i.push(r),e._setExecutionVariable(this,"runningTimers",i)}}_execute(e){this._startPendingTasks(e),this.out._activateSignal(e)}_onEnded(e,t){const i=t._getExecutionVariable(this,"runningTimers")||[],s=i.indexOf(e);s!==-1?i.splice(s,1):Y.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t)}_cancelPendingTasks(e){const t=e._getExecutionVariable(this,"runningTimers")||[];for(const i of t)i.dispose();e._deleteExecutionVariable(this,"runningTimers")}getClassName(){return Bh.ClassName}}Bh.ClassName="FGTimerBlock";Re("FGTimerBlock",Bh);class Uh extends Sl{constructor(e){super(e),this.config=e}configure(){super.configure();for(let e=0;e<this.config.eventData.length;e++){const t=this.config.eventData[e];this.registerDataInput(t,ge)}}_execute(e){const t=this.config.eventId,i=this.dataInputs.map(s=>s.getValue(e));e.configuration.coordinator.notifyCustomEvent(t,i),this.out._activateSignal(e)}getClassName(){return Uh.ClassName}}Uh.ClassName="FGSendCustomEventBlock";Re("FGSendCustomEventBlock",Uh);class ho extends Fh{constructor(e){super(e),this.config=e}configure(){super.configure();for(let e=0;e<this.config.eventData.length;e++){const t=this.config.eventData[e];this.registerDataOutput(t,ge)}}_preparePendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);this._eventObserver=t.add(i=>{for(let s=0;s<i.length;s++)this.dataOutputs[s].setValue(i[s],e);this._execute(e)})}_cancelPendingTasks(e){const t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);t?t.remove(this._eventObserver):Y.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}getClassName(){return ho.ClassName}serialize(e){super.serialize(e),e.eventId=this.config.eventId,e.eventData=this.config.eventData}}ho.ClassName="FGReceiveCustomEventBlock";Re(ho.ClassName,ho);class co extends $a{constructor(e){super(e),this.config=e}configure(){super.configure(),this.outFlows=[];for(let e=0;e<this.config.numberOutputFlows;e++)this.outFlows.push(this._registerSignalOutput(`${e}`))}_execute(e){for(let t=0;t<this.config.numberOutputFlows;t++)this.outFlows[t]._activateSignal(e)}getClassName(){return co.ClassName}}co.ClassName="FGSequenceBlock";Re(co.ClassName,co);class fE{constructor(e,t){this.templateStringInputs=[],this.path=e,this.ownerBlock=t;for(const i of e.getTemplateStrings())this.templateStringInputs.push(this.ownerBlock.registerDataInput(i,ci))}substitutePath(e){for(const t of this.templateStringInputs){const i=t.getValue(e),s=t.name;this.path.setTemplateSubstitution(s,i)}return this.path}getProperty(e){return this.substitutePath(e),this.path.getProperty(e)}setProperty(e,t){this.substitutePath(e),this.path.setProperty(e,t)}}class uo extends Lh{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",ge),this.templateComponent=new fE(e.path,this)}_updateOutputs(e){const t=this.templateComponent.getProperty(e);this.value.setValue(t,e)}getClassName(){return uo.ClassName}}uo.ClassName="FGGetPropertyBlock";Re(uo.ClassName,uo);class kh extends Sl{constructor(e){super(e),this.config=e,this.a=this.registerDataInput("a",ge),this.templateComponent=new fE(e.path,this)}_execute(e){const t=this.a.getValue(e);this.templateComponent.setProperty(e,t),this.out._activateSignal(e)}serialize(e={}){super.serialize(e),e.config.path=this.config.path.serialize()}getClassName(){return kh.ClassName}}kh.ClassName="FGSetPropertyBlock";Re("FGSetPropertyBlock",kh);const Lg="cachedOperationValue",Fg="cachedExecutionId";class su extends Lh{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e)}_updateOutputs(e){const t=e._getExecutionVariable(this,Fg),i=e._getExecutionVariable(this,Lg);if(i!==void 0&&t===e.executionId)this.value.setValue(i,e);else{const s=this._doOperation(e);e._setExecutionVariable(this,Lg,s),e._setExecutionVariable(this,Fg,e.executionId),this.value.setValue(s,e)}}}class ji extends su{constructor(e,t,i,s,r,n){super(i,n),this._operation=s,this._className=r,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e))}getClassName(){return this._className}}class Vh extends su{constructor(e,t,i,s){super(e,s),this._operation=t,this._className=i}_doOperation(e){return this._operation()}getClassName(){return this._className}}class Nt extends su{constructor(e,t,i,s,r){super(t,r),this._operation=i,this._className=s,this.input=this.registerDataInput("input",e)}_doOperation(e){return this._operation(this.input.getValue(e))}getClassName(){return this._className}}class Uf extends su{constructor(e,t,i,s,r,n,a){super(s,a),this._operation=r,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}}function mi(o){return o.getClassName?o.getClassName():""}function Gh(o,e){return o==="Vector2"&&e==="Vector2"||o==="Vector3"&&e==="Vector3"||o==="Vector4"&&e==="Vector4"}class la extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicAdd(t,i),la.ClassName,e)}_polymorphicAdd(e,t){const i=mi(e),s=mi(t);return Gh(i,s)?e.add(t):e+t}getClassName(){return la.ClassName}}la.ClassName="FGAddBlock";Re(la.ClassName,la);class ha extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicAdd(t,i),ha.ClassName,e)}_polymorphicAdd(e,t){const i=mi(e),s=mi(t);return Gh(i,s)?e.subtract(t):e-t}getClassName(){return ha.ClassName}}ha.ClassName="FGSubBlock";Re(ha.ClassName,ha);class fo extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicMultiply(t,i),fo.ClassName,e)}_polymorphicMultiply(e,t){const i=mi(e),s=mi(t);return Gh(i,s)?e.multiply(t):e*t}}fo.ClassName="FGMultiplyBlock";Re(fo.ClassName,fo);class _o extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicDivide(t,i),_o.ClassName,e)}_polymorphicDivide(e,t){const i=mi(e),s=mi(t);return Gh(i,s)?e.divide(t):e/t}}_o.ClassName="FGDivideBlock";Re(_o.ClassName,_o);class po extends Vh{constructor(e){super(ci,()=>Math.random(),po.ClassName,e)}}po.ClassName="FGRandomBlock";Re(po.ClassName,po);class go extends ji{constructor(e){super(ge,ge,ci,(t,i)=>this._polymorphicDot(t,i),go.ClassName,e)}_polymorphicDot(e,t){switch(mi(e)){case"Vector2":return Ke.Dot(e,t);case"Vector3":return m.Dot(e,t);case"Vector4":return ut.Dot(e,t);default:throw new Error(`Cannot get dot product of ${e} and ${t}`)}}}go.ClassName="FGDotBlock";Re(go.ClassName,go);class mo extends Vh{constructor(e){super(ci,()=>Math.E,mo.ClassName,e)}}mo.ClassName="FGEBlock";Re(mo.ClassName,mo);class Eo extends Vh{constructor(e){super(ci,()=>Math.PI,Eo.ClassName,e)}}Eo.ClassName="FGPIBlock";Re(Eo.ClassName,Eo);class To extends Vh{constructor(e){super(ci,()=>Number.POSITIVE_INFINITY,To.ClassName,e)}}To.ClassName="FGInfBlock";Re(To.ClassName,To);class vo extends Vh{constructor(e){super(ci,()=>Number.NaN,vo.ClassName,e)}}vo.ClassName="FGNaNBlock";Re(vo.ClassName,vo);function Zt(o,e){switch(mi(o)){case"Vector2":return new Ke(e(o.x),e(o.y));case"Vector3":return new m(e(o.x),e(o.y),e(o.z));case"Vector4":return new ut(e(o.x),e(o.y),e(o.z),e(o.w));default:return e(o)}}class Ao extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicAbs(t),Ao.ClassName,e)}_polymorphicAbs(e){return Zt(e,Math.abs)}}Ao.ClassName="FGAbsBlock";Re(Ao.ClassName,Ao);class Ro extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicSign(t),Ro.ClassName,e)}_polymorphicSign(e){return Zt(e,Math.sign)}}Ro.ClassName="FGSignBlock";Re(Ro.ClassName,Ro);class bo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicTrunc(t),bo.ClassName,e)}_polymorphicTrunc(e){return Zt(e,Math.trunc)}}bo.ClassName="FGTruncBlock";Re(bo.ClassName,bo);class So extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicFloor(t),So.ClassName,e)}_polymorphicFloor(e){return Zt(e,Math.floor)}}So.ClassName="FGFloorBlock";Re(So.ClassName,So);class yo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicCeiling(t),yo.ClassName,e)}_polymorphicCeiling(e){return Zt(e,Math.ceil)}}yo.ClassName="FGCeilBlock";Re(yo.ClassName,yo);class Co extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicFract(t),Co.ClassName,e)}_polymorphicFract(e){return Zt(e,t=>t-Math.floor(t))}}Co.ClassName="FGFractBlock";Re(Co.ClassName,Co);class xo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicNeg(t),xo.ClassName,e)}_polymorphicNeg(e){return Zt(e,t=>-t)}}xo.ClassName="FGNegBlock";Re(xo.ClassName,xo);function zh(o,e,t){switch(mi(o)){case"Vector2":return new Ke(t(o.x,e.x),t(o.y,e.y));case"Vector3":return new m(t(o.x,e.x),t(o.y,e.y),t(o.z,e.z));case"Vector4":return new ut(t(o.x,e.x),t(o.y,e.y),t(o.z,e.z),t(o.w,e.w));default:return t(o,e)}}class Mo extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicRemainder(t,i),Mo.ClassName,e)}_polymorphicRemainder(e,t){return zh(e,t,(i,s)=>i%s)}}Mo.ClassName="FGRemainderBlock";Re(Mo.ClassName,Mo);class Io extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicMin(t,i),Io.ClassName,e)}_polymorphicMin(e,t){return zh(e,t,Math.min)}}Io.ClassName="FGMinBlock";Re(Io.ClassName,Io);class Po extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicMax(t,i),Po.ClassName,e)}_polymorphicMax(e,t){return zh(e,t,Math.max)}}Po.ClassName="FGMaxBlock";Re(Po.ClassName,Po);function _E(o,e,t){return Math.min(Math.max(o,e),t)}function pE(o,e,t,i){switch(mi(o)){case"Vector2":return new Ke(i(o.x,e.x,t.x),i(o.y,e.y,t.y));case"Vector3":return new m(i(o.x,e.x,t.x),i(o.y,e.y,t.y),i(o.z,e.z,t.z));case"Vector4":return new ut(i(o.x,e.x,t.x),i(o.y,e.y,t.y),i(o.z,e.z,t.z),i(o.w,e.w,t.w));default:return i(o,e,t)}}class Do extends Uf{constructor(e){super(ge,ge,ge,ge,(t,i,s)=>this._polymorphicClamp(t,i,s),Do.ClassName,e)}_polymorphicClamp(e,t,i){return pE(e,t,i,_E)}}Do.ClassName="FGClampBlock";Re(Do.ClassName,Do);class Oo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicSaturate(t),Oo.ClassName,e)}_polymorphicSaturate(e){return Zt(e,t=>_E(t,0,1))}}Oo.ClassName="FGSaturateBlock";Re(Oo.ClassName,Oo);class No extends Uf{constructor(e){super(ge,ge,ge,ge,(t,i,s)=>this._polymorphicInterpolate(t,i,s),No.ClassName,e)}_interpolate(e,t,i){return(1-i)*e+i*t}_polymorphicInterpolate(e,t,i){return pE(e,t,i,this._interpolate)}}No.ClassName="FGInterpolateBlock";Re(No.ClassName,No);class Lo extends ji{constructor(e){super(ge,ge,Nn,(t,i)=>this._polymorphicEq(t,i),Lo.ClassName,e)}_polymorphicEq(e,t){const i=mi(e),s=mi(t);return Gh(i,s)?e.equals(t):e===t}}Lo.ClassName="FGEqBlock";Re(Lo.ClassName,Lo);class Fo extends ji{constructor(e){super(ge,ge,Nn,(t,i)=>this._polymorphicLessThan(t,i),Fo.ClassName,e)}_polymorphicLessThan(e,t){switch(mi(e)){case"Vector2":return e.x<t.x&&e.y<t.y;case"Vector3":return e.x<t.x&&e.y<t.y&&e.z<t.z;case"Vector4":return e.x<t.x&&e.y<t.y&&e.z<t.z&&e.w<t.w;default:return e<t}}}Fo.ClassName="FGLessThanBlock";Re(Fo.ClassName,Fo);class ru extends ji{constructor(e){super(ge,ge,Nn,(t,i)=>this._polymorphicLessThanOrEqual(t,i),ru.ClassName,e)}_polymorphicLessThanOrEqual(e,t){switch(mi(e)){case"Vector2":return e.x<=t.x&&e.y<=t.y;case"Vector3":return e.x<=t.x&&e.y<=t.y&&e.z<=t.z;case"Vector4":return e.x<=t.x&&e.y<=t.y&&e.z<=t.z&&e.w<=t.w;default:return e<=t}}}ru.ClassName="FGLessThanOrEqualBlock";class wo extends ji{constructor(e){super(ge,ge,Nn,(t,i)=>this._polymorphicGreaterThan(t,i),wo.ClassName,e)}_polymorphicGreaterThan(e,t){switch(mi(e)){case"Vector2":return e.x>t.x&&e.y>t.y;case"Vector3":return e.x>t.x&&e.y>t.y&&e.z>t.z;case"Vector4":return e.x>t.x&&e.y>t.y&&e.z>t.z&&e.w>t.w;default:return e>t}}}wo.ClassName="FGGreaterThanBlock";Re(wo.ClassName,wo);class Bo extends ji{constructor(e){super(ge,ge,Nn,(t,i)=>this._polymorphicGreaterThanOrEqual(t,i),Bo.ClassName,e)}_polymorphicGreaterThanOrEqual(e,t){switch(mi(e)){case"Vector2":return e.x>=t.x&&e.y>=t.y;case"Vector3":return e.x>=t.x&&e.y>=t.y&&e.z>=t.z;case"Vector4":return e.x>=t.x&&e.y>=t.y&&e.z>=t.z&&e.w>=t.w;default:return e>=t}}}Bo.ClassName="FGGreaterThanOrEqualBlock";Re(Bo.ClassName,Bo);class Uo extends Nt{constructor(e){super(ge,Nn,t=>this._polymorphicIsNan(t),Uo.ClassName,e)}_polymorphicIsNan(e){switch(mi(e)){case"Vector2":return isNaN(e.x)||isNaN(e.y);case"Vector3":return isNaN(e.x)||isNaN(e.y)||isNaN(e.z);case"Vector4":return isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||isNaN(e.w);default:return isNaN(e)}}}Uo.ClassName="FGIsNanBlock";Re(Uo.ClassName,Uo);class nu extends Nt{constructor(e){super(ge,Nn,t=>this._polymorphicIsInf(t),nu.ClassName,e)}_polymorphicIsInf(e){switch(mi(e)){case"Vector2":return!isFinite(e.x)||!isFinite(e.y);case"Vector3":return!isFinite(e.x)||!isFinite(e.y)||!isFinite(e.z);case"Vector4":return!isFinite(e.x)||!isFinite(e.y)||!isFinite(e.z)||!isFinite(e.w);default:return!isFinite(e)}}}nu.ClassName="FGIsInfBlock";class ko extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicDegToRad(t),ko.ClassName,e)}_degToRad(e){return e*Math.PI/180}_polymorphicDegToRad(e){return Zt(e,this._degToRad)}}ko.ClassName="FGDegToRadBlock";Re(ko.ClassName,ko);class Vo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicRadToDeg(t),Vo.ClassName,e)}_radToDeg(e){return e*180/Math.PI}_polymorphicRadToDeg(e){return Zt(e,this._radToDeg)}}Vo.ClassName="FGRadToDegBlock";Re(Vo.ClassName,Vo);class Go extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicSin(t),Go.ClassName,e)}_polymorphicSin(e){return Zt(e,Math.sin)}}Go.ClassName="FGSinBlock";Re(Go.ClassName,Go);class zo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicCos(t),zo.ClassName,e)}_polymorphicCos(e){return Zt(e,Math.cos)}}zo.ClassName="FGCosBlock";Re(zo.ClassName,zo);class Ho extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicTan(t),Ho.ClassName,e)}_polymorphicTan(e){return Zt(e,Math.tan)}}Ho.ClassName="FGTanBlock";Re(Ho.ClassName,Ho);class Wo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicAsin(t),Wo.ClassName,e)}_polymorphicAsin(e){return Zt(e,Math.asin)}}Wo.ClassName="FGAsinBlock";Re(Wo.ClassName,Wo);class Xo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicAcos(t),Xo.ClassName,e)}_polymorphicAcos(e){return Zt(e,Math.acos)}}Xo.ClassName="FGAcosBlock";Re(Xo.ClassName,Xo);class Yo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicAtan(t),Yo.ClassName,e)}_polymorphicAtan(e){return Zt(e,Math.atan)}}Yo.ClassName="FGAtanBlock";Re(Yo.ClassName,Yo);class Ko extends ji{constructor(e){super(ge,ge,ge,(t,i)=>this._polymorphicAtan2(t,i),Ko.ClassName,e)}_polymorphicAtan2(e,t){return zh(e,t,Math.atan2)}}Ko.ClassName="FGAtan2Block";Re(Ko.ClassName,Ko);class $o extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicSinh(t),$o.ClassName,e)}_polymorphicSinh(e){return Zt(e,Math.sinh)}}$o.ClassName="FGSinhBlock";Re($o.ClassName,$o);class jo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicCosh(t),jo.ClassName,e)}_polymorphicCosh(e){return Zt(e,Math.cosh)}}jo.ClassName="FGCoshBlock";Re(jo.ClassName,jo);class qo extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicTanh(t),qo.ClassName,e)}_polymorphicTanh(e){return Zt(e,Math.tanh)}}qo.ClassName="FGTanhBlock";Re(qo.ClassName,qo);class Zo extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicAsinh(t),Zo.ClassName,e)}_polymorphicAsinh(e){return Zt(e,Math.asinh)}}Zo.ClassName="FGAsinhBlock";Re(Zo.ClassName,Zo);class Qo extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicAcosh(t),Qo.ClassName,e)}_polymorphicAcosh(e){return Zt(e,Math.acosh)}}Qo.ClassName="FGAcoshBlock";Re(Qo.ClassName,Qo);class Jo extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicAtanh(t),Jo.ClassName,e)}_polymorphicAtanh(e){return Zt(e,Math.atanh)}}Jo.ClassName="FGAtanhBlock";Re(Jo.ClassName,Jo);class el extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicExp(t),el.ClassName,e)}_polymorphicExp(e){return Zt(e,Math.exp)}}el.ClassName="FGExpBlock";Re(el.ClassName,el);class tl extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicLog(t),tl.ClassName,e)}_polymorphicLog(e){return Zt(e,Math.log)}}tl.ClassName="FGLogBlock";Re(tl.ClassName,tl);class il extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicLog2(t),il.ClassName,e)}_polymorphicLog2(e){return Zt(e,Math.log2)}}il.ClassName="FGLog2Block";Re(il.ClassName,il);class sl extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicLog10(t),sl.ClassName,e)}_polymorphicLog10(e){return Zt(e,Math.log10)}}sl.ClassName="FGLog10Block";Re(sl.ClassName,sl);class rl extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicSqrt(t),rl.ClassName,e)}_polymorphicSqrt(e){return Zt(e,Math.sqrt)}}rl.ClassName="FGSqrtBlock";Re(rl.ClassName,rl);class nl extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicCubeRoot(t),nl.ClassName,e)}_polymorphicCubeRoot(e){return Zt(e,Math.cbrt)}}nl.ClassName="FGCubeRootBlock";Re(nl.ClassName,nl);class al extends ji{constructor(e){super(ge,ci,ci,(t,i)=>this._polymorphicPow(t,i),al.ClassName,e)}_polymorphicPow(e,t){return zh(e,t,Math.pow)}}al.ClassName="FGPowBlock";Re(al.ClassName,al);class ol extends Nt{constructor(e){super(ge,ci,t=>this._polymorphicLength(t),ol.ClassName,e)}_polymorphicLength(e){switch(mi(e)){case"Vector2":case"Vector3":case"Vector4":return e.length();default:throw new Error(`Cannot compute length of value ${e}`)}}}ol.ClassName="FGLengthBlock";Re(ol.ClassName,ol);class ll extends Nt{constructor(e){super(ge,ge,t=>this._polymorphicNormalize(t),ll.ClassName,e)}_polymorphicNormalize(e){switch(mi(e)){case"Vector2":case"Vector3":case"Vector4":return e.normalize();default:throw new Error(`Cannot normalize value ${e}`)}}}ll.ClassName="FGNormalizeBlock";Re(ll.ClassName,ll);class hl extends ji{constructor(e){super(Ka,Ka,Ka,(t,i)=>m.Cross(t,i),hl.ClassName,e)}}hl.ClassName="FGCrossBlock";Re(hl.ClassName,hl);class cl extends ji{constructor(e){super(Ng,ci,Ng,(t,i)=>Ke.Transform(t,L.RotationZ(i)),cl.ClassName,e)}}cl.ClassName="FGRotate2DBlock";Re(cl.ClassName,cl);class ul extends Uf{constructor(e){super(Ka,Ka,ci,Ka,(t,i,s)=>m.TransformCoordinates(t,L.RotationAxis(i,s)),ul.ClassName,e)}}ul.ClassName="FGRotate3DBlock";Re(ul.ClassName,ul);class dl extends Sl{constructor(e={startIndex:0}){super(e),this.config=e,this.reset=this._registerSignalInput("reset"),this.n=this.registerDataInput("n",ci),this.value=this.registerDataOutput("value",ci)}_execute(e,t){if(t===this.reset)this.value.setValue(this.config.startIndex,e);else{const i=this.value.getValue(e);i<this.n.getValue(e)&&(this.value.setValue(i+1,e),this.out._activateSignal(e))}}getClassName(){return dl.ClassName}}dl.ClassName="FGDoNBlock";Re(dl.ClassName,dl);class fl extends Lh{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput(e.variableName,ge)}_updateOutputs(e){const t=this.config.variableName;e.hasVariable(t)&&this.output.setValue(e.getVariable(t),e)}getClassName(){return fl.ClassName}serialize(e){super.serialize(e),e.config.variableName=this.config.variableName}}fl.ClassName="FGGetVariableBlock";Re(fl.ClassName,fl);class _l extends Sl{constructor(e){super(e),this.config=e,this.input=this.registerDataInput(e.variableName,ge)}_execute(e){const t=this.config.variableName,i=this.input.getValue(e);e.setVariable(t,i),this.out._activateSignal(e)}getClassName(){return _l.ClassName}}_l.ClassName="FGSetVariableBlock";Re(_l.ClassName,_l);class pl extends Sl{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",Nn),this.loopBody=this._registerSignalOutput("loopBody")}_execute(e,t){var i;let s=this.condition.getValue(e);for(!((i=this.config)===null||i===void 0)&&i.isDo&&!s&&this.loopBody._activateSignal(e);s;)this.loopBody._activateSignal(e),s=this.condition.getValue(e);this.out._activateSignal(e)}getClassName(){return pl.ClassName}serialize(e){var t;super.serialize(e),e.isDo=(t=this.config)===null||t===void 0?void 0:t.isDo}}pl.ClassName="FGWhileLoopBlock";Re(pl.ClassName,pl);const $D={"lifecycle/onStart":wh.ClassName,"lifecycle/onTick":oo.ClassName,log:lo.ClassName,"flow/delay":Bh.ClassName,"customEvent/send":Uh.ClassName,"customEvent/receive":ho.ClassName,"flow/sequence":co.ClassName,"world/get":uo.ClassName,"world/set":kh.ClassName,"flow/doN":dl.ClassName,"variable/get":fl.ClassName,"variable/set":_l.ClassName,"flow/whileLoop":pl.ClassName,"math/random":po.ClassName,"math/e":mo.ClassName,"math/pi":Eo.ClassName,"math/inf":To.ClassName,"math/nan":vo.ClassName,"math/abs":Ao.ClassName,"math/sign":Ro.ClassName,"math/trunc":bo.ClassName,"math/floor":So.ClassName,"math/ceil":yo.ClassName,"math/fract":Co.ClassName,"math/neg":xo.ClassName,"math/add":la.ClassName,"math/sub":ha.ClassName,"math/mul":fo.ClassName,"math/div":_o.ClassName,"math/rem":Mo.ClassName,"math/min":Io.ClassName,"math/max":Po.ClassName,"math/clamp":Do.ClassName,"math/saturate":Oo.ClassName,"math/mix":No.ClassName,"math/eq":Lo.ClassName,"math/lt":Fo.ClassName,"math/le":ru.ClassName,"math/gt":wo.ClassName,"math/ge":Bo.ClassName,"math/isnan":Uo.ClassName,"math/isinf":nu.ClassName,"math/rad":ko.ClassName,"math/deg":Vo.ClassName,"math/sin":Go.ClassName,"math/cos":zo.ClassName,"math/tan":Ho.ClassName,"math/asin":Wo.ClassName,"math/acos":Xo.ClassName,"math/atan":Yo.ClassName,"math/atan2":Ko.ClassName,"math/sinh":$o.ClassName,"math/cosh":jo.ClassName,"math/tanh":qo.ClassName,"math/asinh":Zo.ClassName,"math/acosh":Qo.ClassName,"math/atanh":Jo.ClassName,"math/exp":el.ClassName,"math/log":tl.ClassName,"math/log2":il.ClassName,"math/log10":sl.ClassName,"math/sqrt":rl.ClassName,"math/cbrt":nl.ClassName,"math/pow":al.ClassName,"math/length":ol.ClassName,"math/normalize":ll.ClassName,"math/dot":go.ClassName,"math/cross":hl.ClassName,"math/rotate2d":cl.ClassName,"math/rotate3d":ul.ClassName},jD={float2:"Vector2",float3:"Vector3",float4:"Vector4"};function _f(o,e,t){if(o.type!==void 0){const i=e.types&&e.types[o.type];if(!i)throw new Error(`${t}: Unknown type: ${o.type}`);const s=i.signature;if(!s)throw new Error(`${t}: Type ${o.type} has no signature`);const r=jD[s];return{value:o.value,className:r}}else return o.value}function qD(o,e,t){var i;const s={},r=(i=o.configuration)!==null&&i!==void 0?i:[];for(const n of r)if(n.id==="customEvent"){const a=e.customEvents&&e.customEvents[n.value];if(!a)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Unknown custom event: ${n.value}`);s.eventId=a.id,s.eventData=a.values.map(l=>l.id)}else if(n.id==="variable"){const a=e.variables&&e.variables[n.value];if(!a)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Unknown variable: ${n.value}`);s.variableName=a.id}else if(n.id==="path"){const a=n.value;s.path={path:a,className:"FGPath"}}else s[n.id]=_f(n,e,`/extensions/KHR_interactivity/nodes/${t}`);return s}function ZD(o,e,t){const i=$D[e.type];if(!i)throw new Error(`/extensions/KHR_interactivity/nodes/${o}: Unknown block type: ${e.type}`);const s=o.toString(),r=qD(e,t,s),n=e.metadata;return{className:i,config:r,uniqueId:s,metadata:n,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[]}}function QD(o){var e,t,i;const s={uniqueId:Qs(),_userVariables:{},_connectionValues:{}},r=[s],n=[];for(let l=0;l<o.nodes.length;l++){const h=o.nodes[l],c=ZD(l,h,o);n.push(c)}for(let l=0;l<o.nodes.length;l++){const h=o.nodes[l],c=n[l],u=(e=h.flows)!==null&&e!==void 0?e:[];for(const f of u){const p=f.id,_={uniqueId:Qs(),name:p,_connectionType:vs.Output,connectedPointIds:[]};c.signalOutputs.push(_);const g=f.node,E=f.socket,R=n[g];if(!R)throw new Error(`/extensions/KHR_interactivity/nodes/${l}: Could not find node with id ${g} that connects its input with with node ${l}'s output ${p}`);let x=R.signalInputs.find(S=>S.name===E);x||(x={uniqueId:Qs(),name:E,_connectionType:vs.Input,connectedPointIds:[]},R.signalInputs.push(x)),x.connectedPointIds.push(_.uniqueId),_.connectedPointIds.push(x.uniqueId)}const d=(t=h.values)!==null&&t!==void 0?t:[];for(const f of d){const p=f.id,_={uniqueId:Qs(),name:p,_connectionType:vs.Input,connectedPointIds:[]};if(c.dataInputs.push(_),f.value!==void 0){const g=_f(f,o,`/extensions/KHR_interactivity/nodes/${l}`);s._connectionValues[_.uniqueId]=g}else if(f.node!==void 0&&f.socket!==void 0){const g=f.node,E=f.socket,R=n[g];if(!R)throw new Error(`/extensions/KHR_interactivity/nodes/${l}: Could not find node with id ${g} that connects its output with node${l}'s input ${p}`);let x=R.dataOutputs.find(S=>S.name===E);x||(x={uniqueId:Qs(),name:E,_connectionType:vs.Output,connectedPointIds:[]},R.dataOutputs.push(x)),_.connectedPointIds.push(x.uniqueId),x.connectedPointIds.push(_.uniqueId)}else throw new Error(`/extensions/KHR_interactivity/nodes/${l}: Invalid socket ${p} in node ${l}`)}}const a=(i=o.variables)!==null&&i!==void 0?i:[];for(let l=0;l<a.length;l++){const h=a[l],c=h.id;s._userVariables[c]=_f(h,o,`/extensions/KHR_interactivity/variables/${l}`)}return{allBlocks:n,executionContexts:r}}const gE=/^\/nodes\/(\d+)\/(translation|rotation|scale)$/;function wg(o,e){const t=o.getFinalPath(),i=e.getVariable("gltf");if(!i)throw new Error(`No glTF tree found for path ${t}`);const s=t.match(gE);if(!s||s.length!==3)throw new Error(`Invalid path ${t}`);const r=parseInt(s[1]),n=i.nodes&&i.nodes[r];if(!n)throw new Error(`Invalid node index for path ${t}`);const a=n._babylonTransformNode;if(!a)throw new Error(`No Babylon node found for path ${t}`);const l=s[2];if(!l)throw new Error(`Invalid property for path ${t}`);const h=JD[l];if(!h)throw new Error(`Invalid property for path ${t}`);return{babylonNode:a,babylonProperty:h}}const JD={translation:"position",scale:"scaling",rotation:"rotationQuaternion"},eO={shouldProcess(o){return!!o.getFinalPath().match(gE)},processGet(o,e){const{babylonNode:t,babylonProperty:i}=wg(o,e);return t[i]},processSet(o,e,t){const{babylonNode:i,babylonProperty:s}=wg(o,e);i[s]=t}},mE=/^\/materials\/(\d+)\/(pbrMetallicRoughness\/baseColorFactor|pbrMetallicRoughness\/metallicFactor|pbrMetallicRoughness\/roughnessFactor|alphaCutoff|emissiveFactor|normalTexture\/scale|emissiveTexture\/strength)$/,tO={"pbrMetallicRoughness/baseColorFactor":"albedoColor","pbrMetallicRoughness/metallicFactor":"metallic","pbrMetallicRoughness/roughnessFactor":"roughness",emissiveFactor:"emissiveColor"};function Bg(o,e){var t;const i=o.getFinalPath(),s=e.getVariable("gltf");if(!s)throw new Error(`No glTF tree found for path ${i}`);const r=i.match(mE);if(!r||r.length!==3)throw new Error(`Invalid path ${i}`);const n=parseInt(r[1]),a=s.materials&&s.materials[n];if(!a)throw new Error(`Invalid material index for path ${i}`);const l=[];if(!a._data)throw new Error(`No Babylon materials found for path ${i}`);for(const u of Object.keys(a._data)){const d=a._data[parseInt(u)].babylonMaterial;d&&l.push(d)}if(!l||l.length===0)throw new Error(`No Babylon materials found for path ${i}`);const h=r[2];if(!h)throw new Error(`Invalid property for path ${i}`);const c=(t=tO[h])!==null&&t!==void 0?t:h;return{babylonMaterials:l,babylonProperty:c}}const iO={shouldProcess(o){return!!o.getFinalPath().match(mE)},processGet(o,e){var t,i;const{babylonMaterials:s,babylonProperty:r}=Bg(o,e);return r==="normalTexture/scale"?(t=s[0].bumpTexture)===null||t===void 0?void 0:t.uScale:r==="emissiveTexture/strength"?(i=s[0].emissiveTexture)===null||i===void 0?void 0:i.level:s[0][r]},processSet(o,e,t){const{babylonMaterials:i,babylonProperty:s}=Bg(o,e);for(const r of i)if(s==="normalTexture/scale")r.bumpTexture.uScale=t,r.bumpTexture.vScale=t;else if(s==="emissiveTexture/strength")r.emissiveTexture.level=t;else{let n=t;(s==="albedoColor"||s==="emissiveColor")&&(n=new J(t.x,t.y,t.z)),r[s]=n}}},EE=/^\/cameras\/(\d+)\/(orthographic|perspective)\/(xmag|ymag|zfar|znear|aspectRatio|yfov)$/;function Ug(o,e){const t=o.getFinalPath(),i=e.getVariable("gltf");if(!i)throw new Error(`No glTF tree found for path ${t}`);const s=t.match(EE);if(!s||s.length!==4)throw new Error(`Invalid path ${t}`);const r=parseInt(s[1]),n=i.cameras&&i.cameras[r];if(!n)throw new Error(`Invalid camera index for path ${t}`);const a=n._babylonCamera;if(!a)throw new Error(`No Babylon camera found for path ${t}`);const l=s[3];if(!l)throw new Error(`Invalid property for path ${t}`);return{babylonCamera:a,gltfProperty:l}}const sO={shouldProcess(o){return!!o.getFinalPath().match(EE)},processGet(o,e){const{babylonCamera:t,gltfProperty:i}=Ug(o,e);switch(i){case"aspectRatio":return Y.Warn("Getting aspect ratio is not supported."),-1;case"zNear":return t.minZ;case"zFar":return t.maxZ;case"yfov":return t.fov;case"xmag":return t.orthoRight;case"ymag":return t.orthoTop}},processSet(o,e,t){const{babylonCamera:i,gltfProperty:s}=Ug(o,e);switch(s){case"aspectRatio":Y.Warn("Setting aspect ratio is not supported.");break;case"zNear":i.minZ=t;break;case"zFar":i.maxZ=t;break;case"yfov":i.fov=t;break;case"xmag":i.orthoLeft=-t,i.orthoRight=t;break;case"ymag":i.orthoTop=t,i.orthoBottom=-t;break}}},rO=[eO,iO,sO],pf="KHR_interactivity";class nO{constructor(e){this._loader=e,this.name=pf,this.enabled=this._loader.isExtensionUsed(pf)}dispose(){this._loader=null}onReady(){var e;if(!this._loader.babylonScene)return;const t=this._loader.babylonScene,i=(e=this._loader.gltf.extensions)===null||e===void 0?void 0:e.KHR_interactivity;for(const l of rO)Ds.Extensions.includes(l)||Ds.Extensions.push(l);const s=QD(i),r=new ja({scene:t});ao.Parse(s,r).getContext(0).setVariable("gltf",this._loader.gltf),r.start()}}Ae.RegisterExtension(pf,o=>new nO(o));const TE="ExtrasAsMetadata";class aO{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const i=e.metadata=e.metadata||{},s=i.gltf=i.gltf||{};s.extras=t.extras}}constructor(e){this.name=TE,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,s=>{this._assignExtras(s,t),i(s)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,s=>{this._assignExtras(s,t),i(s)})}createMaterial(e,t,i){const s=this._loader.createMaterial(e,t,i);return this._assignExtras(s,t),s}}Ae.RegisterExtension(TE,o=>new aO(o));var Bc;(function(o){o[o.Origin=0]="Origin",o[o.Pivot=1]="Pivot"})(Bc||(Bc={}));var gl;(function(o){o[o.World=0]="World",o[o.Local=1]="Local"})(gl||(gl={}));class jt{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(t=>{t.dispose()}),e.parent=this._rootMesh,this._customMeshSet=!0}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e;const t=e==gl.Local;this.updateGizmoRotationToMatchAttachedMesh=t,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=Yt.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=Bc.Origin,this._updateScale=!0,this._coordinatesMode=gl.Local,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=L.RotationY(Math.PI),this._rootMesh=new re("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=le.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(()=>{this._update()})}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(this.anchorPoint==Bc.Pivot&&e.getAbsolutePivotPoint){const t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{const t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new m(0,0,0);this._rootMesh.position.copyFrom(i)}if(this.updateGizmoRotationToMatchAttachedMesh){const i=e._isMesh||e.getClassName()==="AbstractMesh"||e.getClassName()==="TransformNode"||e.getClassName()==="InstancedMesh"?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,jt.PreserveScaling?i:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){const t=this.gizmoLayer.utilityLayerScene.activeCamera,i=t.globalPosition;this._rootMesh.position.subtractToRef(i,D.Vector3[0]);let s=this.scaleRatio;if(t.mode==De.ORTHOGRAPHIC_CAMERA){if(t.orthoTop&&t.orthoBottom){const r=t.orthoTop-t.orthoBottom;s*=r}}else{const r=t.getScene().useRightHandedSystem?m.RightHandedForwardReadOnly:m.LeftHandedForwardReadOnly,n=t.getDirection(r);s*=m.Dot(D.Vector3[0],n)}this._rootMesh.scaling.setAll(s),e._getWorldMatrixDeterminant()<0&&!jt.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}}_handlePivotMatrixInverse(e,t,i){if(e.isUsingPivotMatrix()&&!e.isUsingPostMultiplyPivotMatrix()){e.getPivotMatrix().invertToRef(D.Matrix[5]),D.Matrix[5].multiplyToRef(t,i);return}i.copyFrom(t)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){const e=this._attachedNode;let t,i;if(e.parent){const r=D.Matrix[1];e.parent._worldMatrix.invertToRef(r),this._attachedNode._worldMatrix.multiplyToRef(r,D.Matrix[0]),t=D.Matrix[0]}else t=this._attachedNode._worldMatrix;if(e.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(t,D.Matrix[1]),i=D.Matrix[1]):i=t,i.decompose(D.Vector3[1],D.Quaternion[0],D.Vector3[0]),this._attachedNode.getClassName()==="FreeCamera"||this._attachedNode.getClassName()==="FlyCamera"||this._attachedNode.getClassName()==="ArcFollowCamera"||this._attachedNode.getClassName()==="TargetCamera"||this._attachedNode.getClassName()==="TouchCamera"||this._attachedNode.getClassName()==="UniversalCamera"){const r=this._attachedNode;r.rotation=D.Quaternion[0].toEulerAngles(),r.rotationQuaternion&&(r.rotationQuaternion.copyFrom(D.Quaternion[0]),r.rotationQuaternion.normalize())}e.position.copyFrom(D.Vector3[0])}else if(this._attachedNode._isMesh||this._attachedNode.getClassName()==="AbstractMesh"||this._attachedNode.getClassName()==="TransformNode"||this._attachedNode.getClassName()==="InstancedMesh"){const e=this._attachedNode;if(e.parent){const t=D.Matrix[0],i=D.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i);const s=D.Matrix[4];if(this._handlePivotMatrixInverse(e,i,s),s.decompose(D.Vector3[0],D.Quaternion[0],e.position,jt.PreserveScaling?e:void 0,jt.UseAbsoluteScaling),D.Quaternion[0].normalize(),e.isUsingPivotMatrix()){const r=D.Quaternion[1];le.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,r);const n=D.Matrix[2];L.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,n);const a=D.Matrix[2];r.toRotationMatrix(a);const l=e.getPivotMatrix(),h=D.Matrix[3];l.invertToRef(h),l.multiplyToRef(n,D.Matrix[4]),D.Matrix[4].multiplyToRef(a,D.Matrix[5]),D.Matrix[5].multiplyToRef(h,D.Matrix[6]),D.Matrix[6].getTranslationToRef(D.Vector3[1]),e.position.subtractInPlace(D.Vector3[1])}}else{const t=D.Matrix[4];this._handlePivotMatrixInverse(e,this._attachedNode._worldMatrix,t),t.decompose(D.Vector3[0],D.Quaternion[0],e.position,jt.PreserveScaling?e:void 0,jt.UseAbsoluteScaling)}D.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(D.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(D.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=D.Quaternion[0].toEulerAngles())}else if(this._attachedNode.getClassName()==="Bone"){const e=this._attachedNode,t=e.getParent();if(t){const i=D.Matrix[0],s=D.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,s),e.getLocalMatrix().copyFrom(s)}else e.getLocalMatrix().copyFrom(e.getFinalMatrix());e.markAsDirty()}else{const e=this._attachedNode;if(e.getTypeID){const t=e.getTypeID();if(t===qe.LIGHTTYPEID_DIRECTIONALLIGHT||t===qe.LIGHTTYPEID_SPOTLIGHT||t===qe.LIGHTTYPEID_POINTLIGHT){const i=e.parent;if(i){const s=D.Matrix[0],r=D.Matrix[1];i.getWorldMatrix().invertToRef(s),e.getWorldMatrix().multiplyToRef(s,r),r.decompose(void 0,D.Quaternion[0],D.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,D.Quaternion[0],D.Vector3[0]);e.position=new m(D.Vector3[0].x,D.Vector3[0].y,D.Vector3[0].z),e.direction&&(e.direction=new m(e.direction.x,e.direction.y,e.direction.z))}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach(i=>{i.material=t,i.color&&(i.color=t.diffuseColor)})}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add(r=>{var n,a;if(r.pickInfo){if(r.type===xe.POINTERMOVE){if(i)return;t.forEach(l=>{var h,c;if(l.colliderMeshes&&l.gizmoMeshes){const u=((h=l.colliderMeshes)===null||h===void 0?void 0:h.indexOf((c=r==null?void 0:r.pickInfo)===null||c===void 0?void 0:c.pickedMesh))!=-1,d=l.dragBehavior.enabled?u||l.active?l.hoverMaterial:l.material:l.disableMaterial;l.gizmoMeshes.forEach(f=>{f.material=d,f.color&&(f.color=d.diffuseColor)})}})}if(r.type===xe.POINTERDOWN&&t.has((n=r.pickInfo.pickedMesh)===null||n===void 0?void 0:n.parent)){i=!0;const l=t.get((a=r.pickInfo.pickedMesh)===null||a===void 0?void 0:a.parent);l.active=!0,t.forEach(h=>{var c,u;const f=(((c=h.colliderMeshes)===null||c===void 0?void 0:c.indexOf((u=r==null?void 0:r.pickInfo)===null||u===void 0?void 0:u.pickedMesh))!=-1||h.active)&&h.dragBehavior.enabled?h.hoverMaterial:h.disableMaterial;h.gizmoMeshes.forEach(p=>{p.material=f,p.color&&(p.color=f.diffuseColor)})})}r.type===xe.POINTERUP&&t.forEach(l=>{l.active=!1,i=!1,l.gizmoMeshes.forEach(h=>{h.material=l.dragBehavior.enabled?l.material:l.disableMaterial,h.color&&(h.color=l.material.diffuseColor)})})}})}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}jt.PreserveScaling=!1;jt.UseAbsoluteScaling=!0;jt.PreserveScaling=!0;jt.UseAbsoluteScaling=!1;Ve.prototype.loadModel=async function(e,t){return new Promise((i,s)=>{const r=e.lastIndexOf("/"),n=e.slice(0,r+1),a=e.slice(r+1),l=ct.LoadAssetContainer(n,a,this,h=>{const{meshes:c,materials:u}=h;c.forEach(d=>{d instanceof Zc||(d.receiveShadows=!0)}),u.forEach(d=>{d instanceof me&&(d.metallicF0Factor=0,d.alpha<1&&(d.transparencyMode=2)),d.needAlphaBlending()&&(d.separateCullingPass=!0)}),i(h)},void 0,(h,c,u)=>s(u),t);l instanceof Kt&&(l.compileMaterials=!0,l.animationStartMode=ia.NONE)})};Object.defineProperty(Ve.prototype,"defaultUtilityLayer",{get:function(){return this._defaultUtilityLayer||(this._defaultUtilityLayer=new Yt(this,!1)),this._defaultUtilityLayer}});Object.defineProperty(Ve.prototype,"defaultUtilityLayerWithEvents",{get:function(){return this._defaultUtilityLayerWithEvents||(this._defaultUtilityLayerWithEvents=new Yt(this,!0)),this._defaultUtilityLayerWithEvents}});const oO=new Set(["abort","animationcancel","animationend","animationiteration","animationstart","auxclick","beforeinput","blur","cancel","canplay","canplaythrough","change","click","close","compositionend","compositionstart","compositionupdate","contextmenu","copy","cuechange","cut","dblclick","drag","dragend","dragenter","dragleave","dragover","dragstart","drop","durationchange","emptied","ended","error","focus","focusin","focusout","formdata","gotpointercapture","input","invalid","keydown","keypress","keyup","load","loadeddata","loadedmetadata","loadstart","lostpointercapture","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","paste","pause","play","playing","pointercancel","pointerdown","pointerenter","pointerleave","pointermove","pointerout","pointerover","pointerup","progress","ratechange","reset","resize","scroll","scrollend","securitypolicyviolation","seeked","seeking","select","selectionchange","selectstart","slotchange","stalled","submit","suspend","timeupdate","toggle","touchcancel","touchend","touchmove","touchstart","transitioncancel","transitionend","transitionrun","transitionstart","volumechange","waiting","webkitanimationend","webkitanimationiteration","webkitanimationstart","webkittransitionend","wheel","fullscreenchange","fullscreenerror"]);/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */let vE=class extends Event{constructor(e,t,i){super("context-request",{bubbles:!0,composed:!0}),this.context=e,this.callback=t,this.subscribe=i??!1}};/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 *//**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */let kg=class{constructor(e,t,i,s){if(this.subscribe=!1,this.provided=!1,this.value=void 0,this.t=(r,n)=>{this.unsubscribe&&(this.unsubscribe!==n&&(this.provided=!1,this.unsubscribe()),this.subscribe||this.unsubscribe()),this.value=r,this.host.requestUpdate(),this.provided&&!this.subscribe||(this.provided=!0,this.callback&&this.callback(r,n)),this.unsubscribe=n},this.host=e,t.context!==void 0){const r=t;this.context=r.context,this.callback=r.callback,this.subscribe=r.subscribe??!1}else this.context=t,this.callback=i,this.subscribe=s??!1;this.host.addController(this)}hostConnected(){this.dispatchRequest()}hostDisconnected(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=void 0)}dispatchRequest(){this.host.dispatchEvent(new vE(this.context,this.t,this.subscribe))}};/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */let lO=class{get value(){return this.o}set value(e){this.setValue(e)}setValue(e,t=!1){const i=t||!Object.is(e,this.o);this.o=e,i&&this.updateObservers()}constructor(e){this.subscriptions=new Map,this.updateObservers=()=>{for(const[t,{disposer:i}]of this.subscriptions)t(this.o,i)},e!==void 0&&(this.value=e)}addCallback(e,t,i){if(!i)return void e(this.value);this.subscriptions.has(e)||this.subscriptions.set(e,{disposer:()=>{this.subscriptions.delete(e)},consumerHost:t});const{disposer:s}=this.subscriptions.get(e);e(this.value,s)}clearCallbacks(){this.subscriptions.clear()}};/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */let hO=class extends Event{constructor(e){super("context-provider",{bubbles:!0,composed:!0}),this.context=e}},Vg=class extends lO{constructor(e,t,i){var s,r;super(t.context!==void 0?t.initialValue:i),this.onContextRequest=n=>{const a=n.composedPath()[0];n.context===this.context&&a!==this.host&&(n.stopPropagation(),this.addCallback(n.callback,a,n.subscribe))},this.onProviderRequest=n=>{const a=n.composedPath()[0];if(n.context!==this.context||a===this.host)return;const l=new Set;for(const[h,{consumerHost:c}]of this.subscriptions)l.has(h)||(l.add(h),c.dispatchEvent(new vE(this.context,h,!0)));n.stopPropagation()},this.host=e,t.context!==void 0?this.context=t.context:this.context=t,this.attachListeners(),(r=(s=this.host).addController)==null||r.call(s,this)}attachListeners(){this.host.addEventListener("context-request",this.onContextRequest),this.host.addEventListener("context-provider",this.onProviderRequest)}hostConnected(){this.host.dispatchEvent(new hO(this.context))}};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function AE({context:o}){return(e,t)=>{const i=new WeakMap;if(typeof t=="object")return t.addInitializer(function(){i.set(this,new Vg(this,{context:o}))}),{get(){return e.get.call(this)},set(s){var r;return(r=i.get(this))==null||r.setValue(s),e.set.call(this,s)},init(s){var r;return(r=i.get(this))==null||r.setValue(s),s}};{e.constructor.addInitializer(n=>{i.set(n,new Vg(n,{context:o}))});const s=Object.getOwnPropertyDescriptor(e,t);let r;if(s===void 0){const n=new WeakMap;r={get:function(){return n.get(this)},set:function(a){i.get(this).setValue(a),n.set(this,a)},configurable:!0,enumerable:!0}}else{const n=s.set;r={...s,set:function(a){i.get(this).setValue(a),n==null||n.call(this,a)}}}return void Object.defineProperty(e,t,r)}}}/**
 * @license
 * Copyright 2022 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function Gg({context:o,subscribe:e}){return(t,i)=>{typeof i=="object"?i.addInitializer(function(){new kg(this,{context:o,callback:s=>{this[i.name]=s},subscribe:e})}):t.constructor.addInitializer(s=>{new kg(s,{context:o,callback:r=>{s[i]=r},subscribe:e})})}}const Uc={Engine:"Engine",Scene:"Scene",TransformNode:"TransformNode",AssetContainer:"AssetContainer"};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const cO=o=>(e,t)=>{t!==void 0?t.addInitializer(()=>{customElements.define(o,e)}):customElements.define(o,e)};/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const Mc=globalThis,kf=Mc.ShadowRoot&&(Mc.ShadyCSS===void 0||Mc.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,RE=Symbol(),zg=new WeakMap;let uO=class{constructor(e,t,i){if(this._$cssResult$=!0,i!==RE)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(kf&&e===void 0){const i=t!==void 0&&t.length===1;i&&(e=zg.get(t)),e===void 0&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),i&&zg.set(t,e))}return e}toString(){return this.cssText}};const dO=o=>new uO(typeof o=="string"?o:o+"",void 0,RE),fO=(o,e)=>{if(kf)o.adoptedStyleSheets=e.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet);else for(const t of e){const i=document.createElement("style"),s=Mc.litNonce;s!==void 0&&i.setAttribute("nonce",s),i.textContent=t.cssText,o.appendChild(i)}},Hg=kf?o=>o:o=>o instanceof CSSStyleSheet?(e=>{let t="";for(const i of e.cssRules)t+=i.cssText;return dO(t)})(o):o;/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const{is:_O,defineProperty:pO,getOwnPropertyDescriptor:gO,getOwnPropertyNames:mO,getOwnPropertySymbols:EO,getPrototypeOf:TO}=Object,mn=globalThis,Wg=mn.trustedTypes,vO=Wg?Wg.emptyScript:"",cd=mn.reactiveElementPolyfillSupport,lh=(o,e)=>o,kc={toAttribute(o,e){switch(e){case Boolean:o=o?vO:null;break;case Object:case Array:o=o==null?o:JSON.stringify(o)}return o},fromAttribute(o,e){let t=o;switch(e){case Boolean:t=o!==null;break;case Number:t=o===null?null:Number(o);break;case Object:case Array:try{t=JSON.parse(o)}catch{t=null}}return t}},Vf=(o,e)=>!_O(o,e),Xg={attribute:!0,type:String,converter:kc,reflect:!1,hasChanged:Vf};Symbol.metadata??(Symbol.metadata=Symbol("metadata")),mn.litPropertyMetadata??(mn.litPropertyMetadata=new WeakMap);class Ga extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??(this.l=[])).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=Xg){if(t.state&&(t.attribute=!1),this._$Ei(),this.elementProperties.set(e,t),!t.noAccessor){const i=Symbol(),s=this.getPropertyDescriptor(e,i,t);s!==void 0&&pO(this.prototype,e,s)}}static getPropertyDescriptor(e,t,i){const{get:s,set:r}=gO(this.prototype,e)??{get(){return this[t]},set(n){this[t]=n}};return{get(){return s==null?void 0:s.call(this)},set(n){const a=s==null?void 0:s.call(this);r.call(this,n),this.requestUpdate(e,a,i)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??Xg}static _$Ei(){if(this.hasOwnProperty(lh("elementProperties")))return;const e=TO(this);e.finalize(),e.l!==void 0&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(lh("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(lh("properties"))){const t=this.properties,i=[...mO(t),...EO(t)];for(const s of i)this.createProperty(s,t[s])}const e=this[Symbol.metadata];if(e!==null){const t=litPropertyMetadata.get(e);if(t!==void 0)for(const[i,s]of t)this.elementProperties.set(i,s)}this._$Eh=new Map;for(const[t,i]of this.elementProperties){const s=this._$Eu(t,i);s!==void 0&&this._$Eh.set(s,t)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const i=new Set(e.flat(1/0).reverse());for(const s of i)t.unshift(Hg(s))}else e!==void 0&&t.push(Hg(e));return t}static _$Eu(e,t){const i=t.attribute;return i===!1?void 0:typeof i=="string"?i:typeof e=="string"?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){var e;this._$Eg=new Promise(t=>this.enableUpdating=t),this._$AL=new Map,this._$ES(),this.requestUpdate(),(e=this.constructor.l)==null||e.forEach(t=>t(this))}addController(e){var t;(this._$E_??(this._$E_=new Set)).add(e),this.renderRoot!==void 0&&this.isConnected&&((t=e.hostConnected)==null||t.call(e))}removeController(e){var t;(t=this._$E_)==null||t.delete(e)}_$ES(){const e=new Map,t=this.constructor.elementProperties;for(const i of t.keys())this.hasOwnProperty(i)&&(e.set(i,this[i]),delete this[i]);e.size>0&&(this._$Ep=e)}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return fO(e,this.constructor.elementStyles),e}connectedCallback(){var e;this.renderRoot??(this.renderRoot=this.createRenderRoot()),this.enableUpdating(!0),(e=this._$E_)==null||e.forEach(t=>{var i;return(i=t.hostConnected)==null?void 0:i.call(t)})}enableUpdating(e){}disconnectedCallback(){var e;(e=this._$E_)==null||e.forEach(t=>{var i;return(i=t.hostDisconnected)==null?void 0:i.call(t)})}attributeChangedCallback(e,t,i){this._$AK(e,i)}_$EO(e,t){var r;const i=this.constructor.elementProperties.get(e),s=this.constructor._$Eu(e,i);if(s!==void 0&&i.reflect===!0){const n=(((r=i.converter)==null?void 0:r.toAttribute)!==void 0?i.converter:kc).toAttribute(t,i.type);this._$Em=e,n==null?this.removeAttribute(s):this.setAttribute(s,n),this._$Em=null}}_$AK(e,t){var r;const i=this.constructor,s=i._$Eh.get(e);if(s!==void 0&&this._$Em!==s){const n=i.getPropertyOptions(s),a=typeof n.converter=="function"?{fromAttribute:n.converter}:((r=n.converter)==null?void 0:r.fromAttribute)!==void 0?n.converter:kc;this._$Em=s,this[s]=a.fromAttribute(t,n.type),this._$Em=null}}requestUpdate(e,t,i,s=!1,r){if(e!==void 0){if(i??(i=this.constructor.getPropertyOptions(e)),!(i.hasChanged??Vf)(s?r:this[e],t))return;this.C(e,t,i)}this.isUpdatePending===!1&&(this._$Eg=this._$EP())}C(e,t,i){this._$AL.has(e)||this._$AL.set(e,t),i.reflect===!0&&this._$Em!==e&&(this._$Ej??(this._$Ej=new Set)).add(e)}async _$EP(){this.isUpdatePending=!0;try{await this._$Eg}catch(t){Promise.reject(t)}const e=this.scheduleUpdate();return e!=null&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){var i;if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??(this.renderRoot=this.createRenderRoot()),this._$Ep){for(const[r,n]of this._$Ep)this[r]=n;this._$Ep=void 0}const s=this.constructor.elementProperties;if(s.size>0)for(const[r,n]of s)n.wrapped!==!0||this._$AL.has(r)||this[r]===void 0||this.C(r,this[r],n)}let e=!1;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),(i=this._$E_)==null||i.forEach(s=>{var r;return(r=s.hostUpdate)==null?void 0:r.call(s)}),this.update(t)):this._$ET()}catch(s){throw e=!1,this._$ET(),s}e&&this._$AE(t)}willUpdate(e){}_$AE(e){var t;(t=this._$E_)==null||t.forEach(i=>{var s;return(s=i.hostUpdated)==null?void 0:s.call(i)}),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$ET(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$Eg}shouldUpdate(e){return!0}update(e){this._$Ej&&(this._$Ej=this._$Ej.forEach(t=>this._$EO(t,this[t]))),this._$ET()}updated(e){}firstUpdated(e){}}Ga.elementStyles=[],Ga.shadowRootOptions={mode:"open"},Ga[lh("elementProperties")]=new Map,Ga[lh("finalized")]=new Map,cd==null||cd({ReactiveElement:Ga}),(mn.reactiveElementVersions??(mn.reactiveElementVersions=[])).push("2.0.2");/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const AO={attribute:!0,type:String,converter:kc,reflect:!1,hasChanged:Vf},RO=(o=AO,e,t)=>{const{kind:i,metadata:s}=t;let r=globalThis.litPropertyMetadata.get(s);if(r===void 0&&globalThis.litPropertyMetadata.set(s,r=new Map),r.set(t.name,o),i==="accessor"){const{name:n}=t;return{set(a){const l=e.get.call(this);e.set.call(this,a),this.requestUpdate(n,l,o)},init(a){return a!==void 0&&this.C(n,void 0,o),a}}}if(i==="setter"){const{name:n}=t;return function(a){const l=this[n];e.call(this,a),this.requestUpdate(n,l,o)}}throw Error("Unsupported decorator location: "+i)};function bE(o){return(e,t)=>typeof t=="object"?RO(o,e,t):((i,s,r)=>{const n=s.hasOwnProperty(r);return s.constructor.createProperty(r,n?{...i,wrapped:!0}:i),n?Object.getOwnPropertyDescriptor(s,r):void 0})(o,e,t)}/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */function Ss(o){return bE({...o,state:!0,attribute:!1})}const Gs={closestTransformNodeLike:o=>{let e=o.parentElement;for(;e;){const t=e.entity;if(t&&t instanceof we)return t;e=e.parentElement}return null},toAttributeObject:o=>new Proxy(o,{get(e,t,i){return typeof t=="symbol"?Reflect.get(e,t,i):e.getAttribute(t)||""},set(e,t,i,s){return typeof t=="symbol"?Reflect.set(e,t,i,s):(e.setAttribute(t,i+""),!0)}}),displayText:o=>{const e=o.tagName.toLowerCase();return o.id?`${e}#${o.id}`:e}},FU={Number:Te.Lerp,Vector2:Ke.Lerp,Vector3:(o,e,t,i)=>m.LerpToRef(o,e,t,i||new m),Vector4:(o,e,t,i)=>(i||(i=new ut),i.x=Te.Lerp(o.x,e.x,t),i.y=Te.Lerp(o.y,e.y,t),i.z=Te.Lerp(o.z,e.z,t),i.w=Te.Lerp(o.w,e.w,t),i),Color3:J.Lerp,Color4:He.Lerp,String:(o,e)=>e,Boolean:(o,e)=>e,Array:(o,e)=>e,Object:(o,e)=>e,Matrix:(o,e,t,i)=>L.LerpToRef(o,e,t,i||new L),Quaternion:(o,e,t,i)=>le.SlerpToRef(o,e,t,i||new le),TransitionList:(o,e)=>e},wU={minmax(o,e){let t=1/0,i=-1/0;for(const s of o){const r=e(s);r<t&&(t=r),r>i&&(i=r)}return[t,i]},calcRotAxisAngle(o){const e=Math.acos(o.w)*2,t=new m(o.x,o.y,o.z).normalize();let i=180/Math.PI*e;return i>180&&(i=360-i,t.scaleInPlace(-1)),{axis:t,angle:i}}};function bO(o){const[e,t]=o.split(new RegExp("(?<=\\d)(?=[a-zA-Z])"));return parseFloat(e)*(t==="ms"?1:1e3)}var Yi=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Gf(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var SE={exports:{}};/**
 * chroma.js - JavaScript library for color conversions
 *
 * Copyright (c) 2011-2019, Gregor Aisch
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this
 * list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 *
 * 3. The name Gregor Aisch may not be used to endorse or promote products
 * derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL GREGOR AISCH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
 * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * -------------------------------------------------------
 *
 * chroma.js includes colors from colorbrewer2.org, which are released under
 * the following license:
 *
 * Copyright (c) 2002 Cynthia Brewer, Mark Harrower,
 * and The Pennsylvania State University.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied. See the License for the specific
 * language governing permissions and limitations under the License.
 *
 * ------------------------------------------------------
 *
 * Named colors are taken from X11 Color Names.
 * http://www.w3.org/TR/css3-color/#svg-color
 *
 * @preserve
 */(function(o,e){(function(t,i){o.exports=i()})(Yi,function(){for(var t=function(A,C,P){return C===void 0&&(C=0),P===void 0&&(P=1),A<C?C:A>P?P:A},i=t,s=function(A){A._clipped=!1,A._unclipped=A.slice(0);for(var C=0;C<=3;C++)C<3?((A[C]<0||A[C]>255)&&(A._clipped=!0),A[C]=i(A[C],0,255)):C===3&&(A[C]=i(A[C],0,1));return A},r={},n=0,a=["Boolean","Number","String","Function","Array","Date","RegExp","Undefined","Null"];n<a.length;n+=1){var l=a[n];r["[object "+l+"]"]=l.toLowerCase()}var h=function(A){return r[Object.prototype.toString.call(A)]||"object"},c=h,u=function(A,C){return C===void 0&&(C=null),A.length>=3?Array.prototype.slice.call(A):c(A[0])=="object"&&C?C.split("").filter(function(P){return A[0][P]!==void 0}).map(function(P){return A[0][P]}):A[0]},d=h,f=function(A){if(A.length<2)return null;var C=A.length-1;return d(A[C])=="string"?A[C].toLowerCase():null},p=Math.PI,_={clip_rgb:s,limit:t,type:h,unpack:u,last:f,PI:p,TWOPI:p*2,PITHIRD:p/3,DEG2RAD:p/180,RAD2DEG:180/p},g={format:{},autodetect:[]},E=_.last,R=_.clip_rgb,x=_.type,S=g,b=function(){for(var C=[],P=arguments.length;P--;)C[P]=arguments[P];var F=this;if(x(C[0])==="object"&&C[0].constructor&&C[0].constructor===this.constructor)return C[0];var z=E(C),K=!1;if(!z){K=!0,S.sorted||(S.autodetect=S.autodetect.sort(function(Ee,Ge){return Ge.p-Ee.p}),S.sorted=!0);for(var U=0,ee=S.autodetect;U<ee.length;U+=1){var te=ee[U];if(z=te.test.apply(te,C),z)break}}if(S.format[z]){var ue=S.format[z].apply(null,K?C:C.slice(0,-1));F._rgb=R(ue)}else throw new Error("unknown format: "+C);F._rgb.length===3&&F._rgb.push(1)};b.prototype.toString=function(){return x(this.hex)=="function"?this.hex():"["+this._rgb.join(",")+"]"};var y=b,I=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(I.Color,[null].concat(A)))};I.Color=y,I.version="2.4.2";var O=I,N=_.unpack,w=Math.max,G=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=N(A,"rgb"),F=P[0],z=P[1],K=P[2];F=F/255,z=z/255,K=K/255;var U=1-w(F,w(z,K)),ee=U<1?1/(1-U):0,te=(1-F-U)*ee,ue=(1-z-U)*ee,Ee=(1-K-U)*ee;return[te,ue,Ee,U]},k=G,de=_.unpack,ae=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=de(A,"cmyk");var P=A[0],F=A[1],z=A[2],K=A[3],U=A.length>4?A[4]:1;return K===1?[0,0,0,U]:[P>=1?0:255*(1-P)*(1-K),F>=1?0:255*(1-F)*(1-K),z>=1?0:255*(1-z)*(1-K),U]},_e=ae,Ce=O,ce=y,ze=g,We=_.unpack,nt=_.type,ne=k;ce.prototype.cmyk=function(){return ne(this._rgb)},Ce.cmyk=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(ce,[null].concat(A,["cmyk"])))},ze.format.cmyk=_e,ze.autodetect.push({p:2,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=We(A,"cmyk"),nt(A)==="array"&&A.length===4)return"cmyk"}});var Ue=_.unpack,Je=_.last,St=function(A){return Math.round(A*100)/100},yt=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=Ue(A,"hsla"),F=Je(A)||"lsa";return P[0]=St(P[0]||0),P[1]=St(P[1]*100)+"%",P[2]=St(P[2]*100)+"%",F==="hsla"||P.length>3&&P[3]<1?(P[3]=P.length>3?P[3]:1,F="hsla"):P.length=3,F+"("+P.join(",")+")"},tt=yt,he=_.unpack,Ne=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=he(A,"rgba");var P=A[0],F=A[1],z=A[2];P/=255,F/=255,z/=255;var K=Math.min(P,F,z),U=Math.max(P,F,z),ee=(U+K)/2,te,ue;return U===K?(te=0,ue=Number.NaN):te=ee<.5?(U-K)/(U+K):(U-K)/(2-U-K),P==U?ue=(F-z)/(U-K):F==U?ue=2+(z-P)/(U-K):z==U&&(ue=4+(P-F)/(U-K)),ue*=60,ue<0&&(ue+=360),A.length>3&&A[3]!==void 0?[ue,te,ee,A[3]]:[ue,te,ee]},Qe=Ne,Me=_.unpack,at=_.last,zt=tt,Ht=Qe,ti=Math.round,Ci=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=Me(A,"rgba"),F=at(A)||"rgb";return F.substr(0,3)=="hsl"?zt(Ht(P),F):(P[0]=ti(P[0]),P[1]=ti(P[1]),P[2]=ti(P[2]),(F==="rgba"||P.length>3&&P[3]<1)&&(P[3]=P.length>3?P[3]:1,F="rgba"),F+"("+P.slice(0,F==="rgb"?3:4).join(",")+")")},ui=Ci,_s=_.unpack,Zi=Math.round,Jr=function(){for(var A,C=[],P=arguments.length;P--;)C[P]=arguments[P];C=_s(C,"hsl");var F=C[0],z=C[1],K=C[2],U,ee,te;if(z===0)U=ee=te=K*255;else{var ue=[0,0,0],Ee=[0,0,0],Ge=K<.5?K*(1+z):K+z-K*z,be=2*K-Ge,je=F/360;ue[0]=je+1/3,ue[1]=je,ue[2]=je-1/3;for(var $e=0;$e<3;$e++)ue[$e]<0&&(ue[$e]+=1),ue[$e]>1&&(ue[$e]-=1),6*ue[$e]<1?Ee[$e]=be+(Ge-be)*6*ue[$e]:2*ue[$e]<1?Ee[$e]=Ge:3*ue[$e]<2?Ee[$e]=be+(Ge-be)*(2/3-ue[$e])*6:Ee[$e]=be;A=[Zi(Ee[0]*255),Zi(Ee[1]*255),Zi(Ee[2]*255)],U=A[0],ee=A[1],te=A[2]}return C.length>3?[U,ee,te,C[3]]:[U,ee,te,1]},Sr=Jr,yr=Sr,Cr=g,Aa=/^rgb\(\s*(-?\d+),\s*(-?\d+)\s*,\s*(-?\d+)\s*\)$/,Ra=/^rgba\(\s*(-?\d+),\s*(-?\d+)\s*,\s*(-?\d+)\s*,\s*([01]|[01]?\.\d+)\)$/,ps=/^rgb\(\s*(-?\d+(?:\.\d+)?)%,\s*(-?\d+(?:\.\d+)?)%\s*,\s*(-?\d+(?:\.\d+)?)%\s*\)$/,Un=/^rgba\(\s*(-?\d+(?:\.\d+)?)%,\s*(-?\d+(?:\.\d+)?)%\s*,\s*(-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)$/,ss=/^hsl\(\s*(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)%\s*,\s*(-?\d+(?:\.\d+)?)%\s*\)$/,Nl=/^hsla\(\s*(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)%\s*,\s*(-?\d+(?:\.\d+)?)%\s*,\s*([01]|[01]?\.\d+)\)$/,Ll=Math.round,Fl=function(A){A=A.toLowerCase().trim();var C;if(Cr.format.named)try{return Cr.format.named(A)}catch{}if(C=A.match(Aa)){for(var P=C.slice(1,4),F=0;F<3;F++)P[F]=+P[F];return P[3]=1,P}if(C=A.match(Ra)){for(var z=C.slice(1,5),K=0;K<4;K++)z[K]=+z[K];return z}if(C=A.match(ps)){for(var U=C.slice(1,4),ee=0;ee<3;ee++)U[ee]=Ll(U[ee]*2.55);return U[3]=1,U}if(C=A.match(Un)){for(var te=C.slice(1,5),ue=0;ue<3;ue++)te[ue]=Ll(te[ue]*2.55);return te[3]=+te[3],te}if(C=A.match(ss)){var Ee=C.slice(1,4);Ee[1]*=.01,Ee[2]*=.01;var Ge=yr(Ee);return Ge[3]=1,Ge}if(C=A.match(Nl)){var be=C.slice(1,4);be[1]*=.01,be[2]*=.01;var je=yr(be);return je[3]=+C[4],je}};Fl.test=function(A){return Aa.test(A)||Ra.test(A)||ps.test(A)||Un.test(A)||ss.test(A)||Nl.test(A)};var mu=Fl,Eu=O,ic=y,wl=g,sc=_.type,rc=ui,nc=mu;ic.prototype.css=function(A){return rc(this._rgb,A)},Eu.css=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(ic,[null].concat(A,["css"])))},wl.format.css=nc,wl.autodetect.push({p:5,test:function(A){for(var C=[],P=arguments.length-1;P-- >0;)C[P]=arguments[P+1];if(!C.length&&sc(A)==="string"&&nc.test(A))return"css"}});var ac=y,Tu=O,Bl=g,Ul=_.unpack;Bl.format.gl=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=Ul(A,"rgba");return P[0]*=255,P[1]*=255,P[2]*=255,P},Tu.gl=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(ac,[null].concat(A,["gl"])))},ac.prototype.gl=function(){var A=this._rgb;return[A[0]/255,A[1]/255,A[2]/255,A[3]]};var kl=_.unpack,Vl=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=kl(A,"rgb"),F=P[0],z=P[1],K=P[2],U=Math.min(F,z,K),ee=Math.max(F,z,K),te=ee-U,ue=te*100/255,Ee=U/(255-te)*100,Ge;return te===0?Ge=Number.NaN:(F===ee&&(Ge=(z-K)/te),z===ee&&(Ge=2+(K-F)/te),K===ee&&(Ge=4+(F-z)/te),Ge*=60,Ge<0&&(Ge+=360)),[Ge,ue,Ee]},kn=Vl,Gl=_.unpack,oc=Math.floor,zl=function(){for(var A,C,P,F,z,K,U=[],ee=arguments.length;ee--;)U[ee]=arguments[ee];U=Gl(U,"hcg");var te=U[0],ue=U[1],Ee=U[2],Ge,be,je;Ee=Ee*255;var $e=ue*255;if(ue===0)Ge=be=je=Ee;else{te===360&&(te=0),te>360&&(te-=360),te<0&&(te+=360),te/=60;var _t=oc(te),Et=te-_t,Ct=Ee*(1-ue),Lt=Ct+$e*(1-Et),Hi=Ct+$e*Et,ki=Ct+$e;switch(_t){case 0:A=[ki,Hi,Ct],Ge=A[0],be=A[1],je=A[2];break;case 1:C=[Lt,ki,Ct],Ge=C[0],be=C[1],je=C[2];break;case 2:P=[Ct,ki,Hi],Ge=P[0],be=P[1],je=P[2];break;case 3:F=[Ct,Lt,ki],Ge=F[0],be=F[1],je=F[2];break;case 4:z=[Hi,Ct,ki],Ge=z[0],be=z[1],je=z[2];break;case 5:K=[ki,Ct,Lt],Ge=K[0],be=K[1],je=K[2];break}}return[Ge,be,je,U.length>3?U[3]:1]},lc=zl,hc=_.unpack,xr=_.type,ba=O,gs=y,en=g,ZE=kn;gs.prototype.hcg=function(){return ZE(this._rgb)},ba.hcg=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(gs,[null].concat(A,["hcg"])))},en.format.hcg=lc,en.autodetect.push({p:1,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=hc(A,"hcg"),xr(A)==="array"&&A.length===3)return"hcg"}});var QE=_.unpack,JE=_.last,cc=Math.round,eT=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=QE(A,"rgba"),F=P[0],z=P[1],K=P[2],U=P[3],ee=JE(A)||"auto";U===void 0&&(U=1),ee==="auto"&&(ee=U<1?"rgba":"rgb"),F=cc(F),z=cc(z),K=cc(K);var te=F<<16|z<<8|K,ue="000000"+te.toString(16);ue=ue.substr(ue.length-6);var Ee="0"+cc(U*255).toString(16);switch(Ee=Ee.substr(Ee.length-2),ee.toLowerCase()){case"rgba":return"#"+ue+Ee;case"argb":return"#"+Ee+ue;default:return"#"+ue}},T_=eT,tT=/^#?([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/,iT=/^#?([A-Fa-f0-9]{8}|[A-Fa-f0-9]{4})$/,sT=function(A){if(A.match(tT)){(A.length===4||A.length===7)&&(A=A.substr(1)),A.length===3&&(A=A.split(""),A=A[0]+A[0]+A[1]+A[1]+A[2]+A[2]);var C=parseInt(A,16),P=C>>16,F=C>>8&255,z=C&255;return[P,F,z,1]}if(A.match(iT)){(A.length===5||A.length===9)&&(A=A.substr(1)),A.length===4&&(A=A.split(""),A=A[0]+A[0]+A[1]+A[1]+A[2]+A[2]+A[3]+A[3]);var K=parseInt(A,16),U=K>>24&255,ee=K>>16&255,te=K>>8&255,ue=Math.round((K&255)/255*100)/100;return[U,ee,te,ue]}throw new Error("unknown hex color: "+A)},v_=sT,rT=O,A_=y,nT=_.type,R_=g,aT=T_;A_.prototype.hex=function(A){return aT(this._rgb,A)},rT.hex=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(A_,[null].concat(A,["hex"])))},R_.format.hex=v_,R_.autodetect.push({p:4,test:function(A){for(var C=[],P=arguments.length-1;P-- >0;)C[P]=arguments[P+1];if(!C.length&&nT(A)==="string"&&[3,4,5,6,7,8,9].indexOf(A.length)>=0)return"hex"}});var oT=_.unpack,b_=_.TWOPI,lT=Math.min,hT=Math.sqrt,cT=Math.acos,uT=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=oT(A,"rgb"),F=P[0],z=P[1],K=P[2];F/=255,z/=255,K/=255;var U,ee=lT(F,z,K),te=(F+z+K)/3,ue=te>0?1-ee/te:0;return ue===0?U=NaN:(U=(F-z+(F-K))/2,U/=hT((F-z)*(F-z)+(F-K)*(z-K)),U=cT(U),K>z&&(U=b_-U),U/=b_),[U*360,ue,te]},dT=uT,fT=_.unpack,vu=_.limit,Sa=_.TWOPI,Au=_.PITHIRD,ya=Math.cos,_T=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=fT(A,"hsi");var P=A[0],F=A[1],z=A[2],K,U,ee;return isNaN(P)&&(P=0),isNaN(F)&&(F=0),P>360&&(P-=360),P<0&&(P+=360),P/=360,P<1/3?(ee=(1-F)/3,K=(1+F*ya(Sa*P)/ya(Au-Sa*P))/3,U=1-(ee+K)):P<2/3?(P-=1/3,K=(1-F)/3,U=(1+F*ya(Sa*P)/ya(Au-Sa*P))/3,ee=1-(K+U)):(P-=2/3,U=(1-F)/3,ee=(1+F*ya(Sa*P)/ya(Au-Sa*P))/3,K=1-(U+ee)),K=vu(z*K*3),U=vu(z*U*3),ee=vu(z*ee*3),[K*255,U*255,ee*255,A.length>3?A[3]:1]},pT=_T,gT=_.unpack,mT=_.type,ET=O,S_=y,y_=g,TT=dT;S_.prototype.hsi=function(){return TT(this._rgb)},ET.hsi=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(S_,[null].concat(A,["hsi"])))},y_.format.hsi=pT,y_.autodetect.push({p:2,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=gT(A,"hsi"),mT(A)==="array"&&A.length===3)return"hsi"}});var vT=_.unpack,AT=_.type,RT=O,C_=y,x_=g,bT=Qe;C_.prototype.hsl=function(){return bT(this._rgb)},RT.hsl=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(C_,[null].concat(A,["hsl"])))},x_.format.hsl=Sr,x_.autodetect.push({p:2,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=vT(A,"hsl"),AT(A)==="array"&&A.length===3)return"hsl"}});var ST=_.unpack,yT=Math.min,CT=Math.max,xT=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=ST(A,"rgb");var P=A[0],F=A[1],z=A[2],K=yT(P,F,z),U=CT(P,F,z),ee=U-K,te,ue,Ee;return Ee=U/255,U===0?(te=Number.NaN,ue=0):(ue=ee/U,P===U&&(te=(F-z)/ee),F===U&&(te=2+(z-P)/ee),z===U&&(te=4+(P-F)/ee),te*=60,te<0&&(te+=360)),[te,ue,Ee]},MT=xT,IT=_.unpack,PT=Math.floor,DT=function(){for(var A,C,P,F,z,K,U=[],ee=arguments.length;ee--;)U[ee]=arguments[ee];U=IT(U,"hsv");var te=U[0],ue=U[1],Ee=U[2],Ge,be,je;if(Ee*=255,ue===0)Ge=be=je=Ee;else{te===360&&(te=0),te>360&&(te-=360),te<0&&(te+=360),te/=60;var $e=PT(te),_t=te-$e,Et=Ee*(1-ue),Ct=Ee*(1-ue*_t),Lt=Ee*(1-ue*(1-_t));switch($e){case 0:A=[Ee,Lt,Et],Ge=A[0],be=A[1],je=A[2];break;case 1:C=[Ct,Ee,Et],Ge=C[0],be=C[1],je=C[2];break;case 2:P=[Et,Ee,Lt],Ge=P[0],be=P[1],je=P[2];break;case 3:F=[Et,Ct,Ee],Ge=F[0],be=F[1],je=F[2];break;case 4:z=[Lt,Et,Ee],Ge=z[0],be=z[1],je=z[2];break;case 5:K=[Ee,Et,Ct],Ge=K[0],be=K[1],je=K[2];break}}return[Ge,be,je,U.length>3?U[3]:1]},OT=DT,NT=_.unpack,LT=_.type,FT=O,M_=y,I_=g,wT=MT;M_.prototype.hsv=function(){return wT(this._rgb)},FT.hsv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(M_,[null].concat(A,["hsv"])))},I_.format.hsv=OT,I_.autodetect.push({p:2,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=NT(A,"hsv"),LT(A)==="array"&&A.length===3)return"hsv"}});var uc={Kn:18,Xn:.95047,Yn:1,Zn:1.08883,t0:.137931034,t1:.206896552,t2:.12841855,t3:.008856452},Ca=uc,BT=_.unpack,P_=Math.pow,UT=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=BT(A,"rgb"),F=P[0],z=P[1],K=P[2],U=kT(F,z,K),ee=U[0],te=U[1],ue=U[2],Ee=116*te-16;return[Ee<0?0:Ee,500*(ee-te),200*(te-ue)]},Ru=function(A){return(A/=255)<=.04045?A/12.92:P_((A+.055)/1.055,2.4)},bu=function(A){return A>Ca.t3?P_(A,1/3):A/Ca.t2+Ca.t0},kT=function(A,C,P){A=Ru(A),C=Ru(C),P=Ru(P);var F=bu((.4124564*A+.3575761*C+.1804375*P)/Ca.Xn),z=bu((.2126729*A+.7151522*C+.072175*P)/Ca.Yn),K=bu((.0193339*A+.119192*C+.9503041*P)/Ca.Zn);return[F,z,K]},D_=UT,xa=uc,VT=_.unpack,GT=Math.pow,zT=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=VT(A,"lab");var P=A[0],F=A[1],z=A[2],K,U,ee,te,ue,Ee;return U=(P+16)/116,K=isNaN(F)?U:U+F/500,ee=isNaN(z)?U:U-z/200,U=xa.Yn*yu(U),K=xa.Xn*yu(K),ee=xa.Zn*yu(ee),te=Su(3.2404542*K-1.5371385*U-.4985314*ee),ue=Su(-.969266*K+1.8760108*U+.041556*ee),Ee=Su(.0556434*K-.2040259*U+1.0572252*ee),[te,ue,Ee,A.length>3?A[3]:1]},Su=function(A){return 255*(A<=.00304?12.92*A:1.055*GT(A,1/2.4)-.055)},yu=function(A){return A>xa.t1?A*A*A:xa.t2*(A-xa.t0)},O_=zT,HT=_.unpack,WT=_.type,XT=O,N_=y,L_=g,YT=D_;N_.prototype.lab=function(){return YT(this._rgb)},XT.lab=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(N_,[null].concat(A,["lab"])))},L_.format.lab=O_,L_.autodetect.push({p:2,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=HT(A,"lab"),WT(A)==="array"&&A.length===3)return"lab"}});var KT=_.unpack,$T=_.RAD2DEG,jT=Math.sqrt,qT=Math.atan2,ZT=Math.round,QT=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=KT(A,"lab"),F=P[0],z=P[1],K=P[2],U=jT(z*z+K*K),ee=(qT(K,z)*$T+360)%360;return ZT(U*1e4)===0&&(ee=Number.NaN),[F,U,ee]},F_=QT,JT=_.unpack,ev=D_,tv=F_,iv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=JT(A,"rgb"),F=P[0],z=P[1],K=P[2],U=ev(F,z,K),ee=U[0],te=U[1],ue=U[2];return tv(ee,te,ue)},sv=iv,rv=_.unpack,nv=_.DEG2RAD,av=Math.sin,ov=Math.cos,lv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=rv(A,"lch"),F=P[0],z=P[1],K=P[2];return isNaN(K)&&(K=0),K=K*nv,[F,ov(K)*z,av(K)*z]},w_=lv,hv=_.unpack,cv=w_,uv=O_,dv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=hv(A,"lch");var P=A[0],F=A[1],z=A[2],K=cv(P,F,z),U=K[0],ee=K[1],te=K[2],ue=uv(U,ee,te),Ee=ue[0],Ge=ue[1],be=ue[2];return[Ee,Ge,be,A.length>3?A[3]:1]},B_=dv,fv=_.unpack,_v=B_,pv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=fv(A,"hcl").reverse();return _v.apply(void 0,P)},gv=pv,mv=_.unpack,Ev=_.type,U_=O,dc=y,Cu=g,k_=sv;dc.prototype.lch=function(){return k_(this._rgb)},dc.prototype.hcl=function(){return k_(this._rgb).reverse()},U_.lch=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(dc,[null].concat(A,["lch"])))},U_.hcl=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(dc,[null].concat(A,["hcl"])))},Cu.format.lch=B_,Cu.format.hcl=gv,["lch","hcl"].forEach(function(A){return Cu.autodetect.push({p:2,test:function(){for(var C=[],P=arguments.length;P--;)C[P]=arguments[P];if(C=mv(C,A),Ev(C)==="array"&&C.length===3)return A}})});var Tv={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflower:"#6495ed",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",laserlemon:"#ffff54",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrod:"#fafad2",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",maroon2:"#7f0000",maroon3:"#b03060",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",purple2:"#7f007f",purple3:"#a020f0",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},V_=Tv,vv=y,G_=g,Av=_.type,Hl=V_,Rv=v_,bv=T_;vv.prototype.name=function(){for(var A=bv(this._rgb,"rgb"),C=0,P=Object.keys(Hl);C<P.length;C+=1){var F=P[C];if(Hl[F]===A)return F.toLowerCase()}return A},G_.format.named=function(A){if(A=A.toLowerCase(),Hl[A])return Rv(Hl[A]);throw new Error("unknown color name: "+A)},G_.autodetect.push({p:5,test:function(A){for(var C=[],P=arguments.length-1;P-- >0;)C[P]=arguments[P+1];if(!C.length&&Av(A)==="string"&&Hl[A.toLowerCase()])return"named"}});var Sv=_.unpack,yv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=Sv(A,"rgb"),F=P[0],z=P[1],K=P[2];return(F<<16)+(z<<8)+K},Cv=yv,xv=_.type,Mv=function(A){if(xv(A)=="number"&&A>=0&&A<=16777215){var C=A>>16,P=A>>8&255,F=A&255;return[C,P,F,1]}throw new Error("unknown num color: "+A)},Iv=Mv,Pv=O,z_=y,H_=g,Dv=_.type,Ov=Cv;z_.prototype.num=function(){return Ov(this._rgb)},Pv.num=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(z_,[null].concat(A,["num"])))},H_.format.num=Iv,H_.autodetect.push({p:5,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A.length===1&&Dv(A[0])==="number"&&A[0]>=0&&A[0]<=16777215)return"num"}});var Nv=O,xu=y,W_=g,X_=_.unpack,Y_=_.type,K_=Math.round;xu.prototype.rgb=function(A){return A===void 0&&(A=!0),A===!1?this._rgb.slice(0,3):this._rgb.slice(0,3).map(K_)},xu.prototype.rgba=function(A){return A===void 0&&(A=!0),this._rgb.slice(0,4).map(function(C,P){return P<3?A===!1?C:K_(C):C})},Nv.rgb=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(xu,[null].concat(A,["rgb"])))},W_.format.rgb=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=X_(A,"rgba");return P[3]===void 0&&(P[3]=1),P},W_.autodetect.push({p:3,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=X_(A,"rgba"),Y_(A)==="array"&&(A.length===3||A.length===4&&Y_(A[3])=="number"&&A[3]>=0&&A[3]<=1))return"rgb"}});var fc=Math.log,Lv=function(A){var C=A/100,P,F,z;return C<66?(P=255,F=C<6?0:-155.25485562709179-.44596950469579133*(F=C-2)+104.49216199393888*fc(F),z=C<20?0:-254.76935184120902+.8274096064007395*(z=C-10)+115.67994401066147*fc(z)):(P=351.97690566805693+.114206453784165*(P=C-55)-40.25366309332127*fc(P),F=325.4494125711974+.07943456536662342*(F=C-50)-28.0852963507957*fc(F),z=255),[P,F,z,1]},$_=Lv,Fv=$_,wv=_.unpack,Bv=Math.round,Uv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];for(var P=wv(A,"rgb"),F=P[0],z=P[2],K=1e3,U=4e4,ee=.4,te;U-K>ee;){te=(U+K)*.5;var ue=Fv(te);ue[2]/ue[0]>=z/F?U=te:K=te}return Bv(te)},kv=Uv,Mu=O,_c=y,Iu=g,Vv=kv;_c.prototype.temp=_c.prototype.kelvin=_c.prototype.temperature=function(){return Vv(this._rgb)},Mu.temp=Mu.kelvin=Mu.temperature=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(_c,[null].concat(A,["temp"])))},Iu.format.temp=Iu.format.kelvin=Iu.format.temperature=$_;var Gv=_.unpack,Pu=Math.cbrt,zv=Math.pow,Hv=Math.sign,Wv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=Gv(A,"rgb"),F=P[0],z=P[1],K=P[2],U=[Du(F/255),Du(z/255),Du(K/255)],ee=U[0],te=U[1],ue=U[2],Ee=Pu(.4122214708*ee+.5363325363*te+.0514459929*ue),Ge=Pu(.2119034982*ee+.6806995451*te+.1073969566*ue),be=Pu(.0883024619*ee+.2817188376*te+.6299787005*ue);return[.2104542553*Ee+.793617785*Ge-.0040720468*be,1.9779984951*Ee-2.428592205*Ge+.4505937099*be,.0259040371*Ee+.7827717662*Ge-.808675766*be]},j_=Wv;function Du(A){var C=Math.abs(A);return C<.04045?A/12.92:(Hv(A)||1)*zv((C+.055)/1.055,2.4)}var Xv=_.unpack,pc=Math.pow,Yv=Math.sign,Kv=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=Xv(A,"lab");var P=A[0],F=A[1],z=A[2],K=pc(P+.3963377774*F+.2158037573*z,3),U=pc(P-.1055613458*F-.0638541728*z,3),ee=pc(P-.0894841775*F-1.291485548*z,3);return[255*Ou(4.0767416621*K-3.3077115913*U+.2309699292*ee),255*Ou(-1.2684380046*K+2.6097574011*U-.3413193965*ee),255*Ou(-.0041960863*K-.7034186147*U+1.707614701*ee),A.length>3?A[3]:1]},q_=Kv;function Ou(A){var C=Math.abs(A);return C>.0031308?(Yv(A)||1)*(1.055*pc(C,1/2.4)-.055):A*12.92}var $v=_.unpack,jv=_.type,qv=O,Z_=y,Q_=g,Zv=j_;Z_.prototype.oklab=function(){return Zv(this._rgb)},qv.oklab=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(Z_,[null].concat(A,["oklab"])))},Q_.format.oklab=q_,Q_.autodetect.push({p:3,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=$v(A,"oklab"),jv(A)==="array"&&A.length===3)return"oklab"}});var Qv=_.unpack,Jv=j_,eA=F_,tA=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];var P=Qv(A,"rgb"),F=P[0],z=P[1],K=P[2],U=Jv(F,z,K),ee=U[0],te=U[1],ue=U[2];return eA(ee,te,ue)},iA=tA,sA=_.unpack,rA=w_,nA=q_,aA=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];A=sA(A,"lch");var P=A[0],F=A[1],z=A[2],K=rA(P,F,z),U=K[0],ee=K[1],te=K[2],ue=nA(U,ee,te),Ee=ue[0],Ge=ue[1],be=ue[2];return[Ee,Ge,be,A.length>3?A[3]:1]},oA=aA,lA=_.unpack,hA=_.type,cA=O,J_=y,ep=g,uA=iA;J_.prototype.oklch=function(){return uA(this._rgb)},cA.oklch=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];return new(Function.prototype.bind.apply(J_,[null].concat(A,["oklch"])))},ep.format.oklch=oA,ep.autodetect.push({p:3,test:function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];if(A=lA(A,"oklch"),hA(A)==="array"&&A.length===3)return"oklch"}});var tp=y,dA=_.type;tp.prototype.alpha=function(A,C){return C===void 0&&(C=!1),A!==void 0&&dA(A)==="number"?C?(this._rgb[3]=A,this):new tp([this._rgb[0],this._rgb[1],this._rgb[2],A],"rgb"):this._rgb[3]};var fA=y;fA.prototype.clipped=function(){return this._rgb._clipped||!1};var Vn=y,_A=uc;Vn.prototype.darken=function(A){A===void 0&&(A=1);var C=this,P=C.lab();return P[0]-=_A.Kn*A,new Vn(P,"lab").alpha(C.alpha(),!0)},Vn.prototype.brighten=function(A){return A===void 0&&(A=1),this.darken(-A)},Vn.prototype.darker=Vn.prototype.darken,Vn.prototype.brighter=Vn.prototype.brighten;var pA=y;pA.prototype.get=function(A){var C=A.split("."),P=C[0],F=C[1],z=this[P]();if(F){var K=P.indexOf(F)-(P.substr(0,2)==="ok"?2:0);if(K>-1)return z[K];throw new Error("unknown channel "+F+" in mode "+P)}else return z};var Ma=y,gA=_.type,mA=Math.pow,EA=1e-7,TA=20;Ma.prototype.luminance=function(A){if(A!==void 0&&gA(A)==="number"){if(A===0)return new Ma([0,0,0,this._rgb[3]],"rgb");if(A===1)return new Ma([255,255,255,this._rgb[3]],"rgb");var C=this.luminance(),P="rgb",F=TA,z=function(U,ee){var te=U.interpolate(ee,.5,P),ue=te.luminance();return Math.abs(A-ue)<EA||!F--?te:ue>A?z(U,te):z(te,ee)},K=(C>A?z(new Ma([0,0,0]),this):z(this,new Ma([255,255,255]))).rgb();return new Ma(K.concat([this._rgb[3]]))}return vA.apply(void 0,this._rgb.slice(0,3))};var vA=function(A,C,P){return A=Nu(A),C=Nu(C),P=Nu(P),.2126*A+.7152*C+.0722*P},Nu=function(A){return A/=255,A<=.03928?A/12.92:mA((A+.055)/1.055,2.4)},ys={},ip=y,sp=_.type,gc=ys,rp=function(A,C,P){P===void 0&&(P=.5);for(var F=[],z=arguments.length-3;z-- >0;)F[z]=arguments[z+3];var K=F[0]||"lrgb";if(!gc[K]&&!F.length&&(K=Object.keys(gc)[0]),!gc[K])throw new Error("interpolation mode "+K+" is not defined");return sp(A)!=="object"&&(A=new ip(A)),sp(C)!=="object"&&(C=new ip(C)),gc[K](A,C,P).alpha(A.alpha()+P*(C.alpha()-A.alpha()))},np=y,AA=rp;np.prototype.mix=np.prototype.interpolate=function(A,C){C===void 0&&(C=.5);for(var P=[],F=arguments.length-2;F-- >0;)P[F]=arguments[F+2];return AA.apply(void 0,[this,A,C].concat(P))};var ap=y;ap.prototype.premultiply=function(A){A===void 0&&(A=!1);var C=this._rgb,P=C[3];return A?(this._rgb=[C[0]*P,C[1]*P,C[2]*P,P],this):new ap([C[0]*P,C[1]*P,C[2]*P,P],"rgb")};var Lu=y,RA=uc;Lu.prototype.saturate=function(A){A===void 0&&(A=1);var C=this,P=C.lch();return P[1]+=RA.Kn*A,P[1]<0&&(P[1]=0),new Lu(P,"lch").alpha(C.alpha(),!0)},Lu.prototype.desaturate=function(A){return A===void 0&&(A=1),this.saturate(-A)};var op=y,lp=_.type;op.prototype.set=function(A,C,P){P===void 0&&(P=!1);var F=A.split("."),z=F[0],K=F[1],U=this[z]();if(K){var ee=z.indexOf(K)-(z.substr(0,2)==="ok"?2:0);if(ee>-1){if(lp(C)=="string")switch(C.charAt(0)){case"+":U[ee]+=+C;break;case"-":U[ee]+=+C;break;case"*":U[ee]*=+C.substr(1);break;case"/":U[ee]/=+C.substr(1);break;default:U[ee]=+C}else if(lp(C)==="number")U[ee]=C;else throw new Error("unsupported value for Color.set");var te=new op(U,z);return P?(this._rgb=te._rgb,this):te}throw new Error("unknown channel "+K+" in mode "+z)}else return U};var bA=y,SA=function(A,C,P){var F=A._rgb,z=C._rgb;return new bA(F[0]+P*(z[0]-F[0]),F[1]+P*(z[1]-F[1]),F[2]+P*(z[2]-F[2]),"rgb")};ys.rgb=SA;var yA=y,Fu=Math.sqrt,Ia=Math.pow,CA=function(A,C,P){var F=A._rgb,z=F[0],K=F[1],U=F[2],ee=C._rgb,te=ee[0],ue=ee[1],Ee=ee[2];return new yA(Fu(Ia(z,2)*(1-P)+Ia(te,2)*P),Fu(Ia(K,2)*(1-P)+Ia(ue,2)*P),Fu(Ia(U,2)*(1-P)+Ia(Ee,2)*P),"rgb")};ys.lrgb=CA;var xA=y,MA=function(A,C,P){var F=A.lab(),z=C.lab();return new xA(F[0]+P*(z[0]-F[0]),F[1]+P*(z[1]-F[1]),F[2]+P*(z[2]-F[2]),"lab")};ys.lab=MA;var hp=y,Pa=function(A,C,P,F){var z,K,U,ee;F==="hsl"?(U=A.hsl(),ee=C.hsl()):F==="hsv"?(U=A.hsv(),ee=C.hsv()):F==="hcg"?(U=A.hcg(),ee=C.hcg()):F==="hsi"?(U=A.hsi(),ee=C.hsi()):F==="lch"||F==="hcl"?(F="hcl",U=A.hcl(),ee=C.hcl()):F==="oklch"&&(U=A.oklch().reverse(),ee=C.oklch().reverse());var te,ue,Ee,Ge,be,je;(F.substr(0,1)==="h"||F==="oklch")&&(z=U,te=z[0],Ee=z[1],be=z[2],K=ee,ue=K[0],Ge=K[1],je=K[2]);var $e,_t,Et,Ct;return!isNaN(te)&&!isNaN(ue)?(ue>te&&ue-te>180?Ct=ue-(te+360):ue<te&&te-ue>180?Ct=ue+360-te:Ct=ue-te,_t=te+P*Ct):isNaN(te)?isNaN(ue)?_t=Number.NaN:(_t=ue,(be==1||be==0)&&F!="hsv"&&($e=Ge)):(_t=te,(je==1||je==0)&&F!="hsv"&&($e=Ee)),$e===void 0&&($e=Ee+P*(Ge-Ee)),Et=be+P*(je-be),F==="oklch"?new hp([Et,$e,_t],F):new hp([_t,$e,Et],F)},IA=Pa,cp=function(A,C,P){return IA(A,C,P,"lch")};ys.lch=cp,ys.hcl=cp;var PA=y,DA=function(A,C,P){var F=A.num(),z=C.num();return new PA(F+P*(z-F),"num")};ys.num=DA;var OA=Pa,NA=function(A,C,P){return OA(A,C,P,"hcg")};ys.hcg=NA;var LA=Pa,FA=function(A,C,P){return LA(A,C,P,"hsi")};ys.hsi=FA;var wA=Pa,BA=function(A,C,P){return wA(A,C,P,"hsl")};ys.hsl=BA;var UA=Pa,kA=function(A,C,P){return UA(A,C,P,"hsv")};ys.hsv=kA;var VA=y,GA=function(A,C,P){var F=A.oklab(),z=C.oklab();return new VA(F[0]+P*(z[0]-F[0]),F[1]+P*(z[1]-F[1]),F[2]+P*(z[2]-F[2]),"oklab")};ys.oklab=GA;var zA=Pa,HA=function(A,C,P){return zA(A,C,P,"oklch")};ys.oklch=HA;var wu=y,WA=_.clip_rgb,Bu=Math.pow,Uu=Math.sqrt,ku=Math.PI,up=Math.cos,dp=Math.sin,XA=Math.atan2,YA=function(A,C,P){C===void 0&&(C="lrgb"),P===void 0&&(P=null);var F=A.length;P||(P=Array.from(new Array(F)).map(function(){return 1}));var z=F/P.reduce(function(_t,Et){return _t+Et});if(P.forEach(function(_t,Et){P[Et]*=z}),A=A.map(function(_t){return new wu(_t)}),C==="lrgb")return KA(A,P);for(var K=A.shift(),U=K.get(C),ee=[],te=0,ue=0,Ee=0;Ee<U.length;Ee++)if(U[Ee]=(U[Ee]||0)*P[0],ee.push(isNaN(U[Ee])?0:P[0]),C.charAt(Ee)==="h"&&!isNaN(U[Ee])){var Ge=U[Ee]/180*ku;te+=up(Ge)*P[0],ue+=dp(Ge)*P[0]}var be=K.alpha()*P[0];A.forEach(function(_t,Et){var Ct=_t.get(C);be+=_t.alpha()*P[Et+1];for(var Lt=0;Lt<U.length;Lt++)if(!isNaN(Ct[Lt]))if(ee[Lt]+=P[Et+1],C.charAt(Lt)==="h"){var Hi=Ct[Lt]/180*ku;te+=up(Hi)*P[Et+1],ue+=dp(Hi)*P[Et+1]}else U[Lt]+=Ct[Lt]*P[Et+1]});for(var je=0;je<U.length;je++)if(C.charAt(je)==="h"){for(var $e=XA(ue/ee[je],te/ee[je])/ku*180;$e<0;)$e+=360;for(;$e>=360;)$e-=360;U[je]=$e}else U[je]=U[je]/ee[je];return be/=F,new wu(U,C).alpha(be>.99999?1:be,!0)},KA=function(A,C){for(var P=A.length,F=[0,0,0,0],z=0;z<A.length;z++){var K=A[z],U=C[z]/P,ee=K._rgb;F[0]+=Bu(ee[0],2)*U,F[1]+=Bu(ee[1],2)*U,F[2]+=Bu(ee[2],2)*U,F[3]+=ee[3]*U}return F[0]=Uu(F[0]),F[1]=Uu(F[1]),F[2]=Uu(F[2]),F[3]>.9999999&&(F[3]=1),new wu(WA(F))},Ys=O,Da=_.type,$A=Math.pow,Vu=function(A){var C="rgb",P=Ys("#ccc"),F=0,z=[0,1],K=[],U=[0,0],ee=!1,te=[],ue=!1,Ee=0,Ge=1,be=!1,je={},$e=!0,_t=1,Et=function(ye){if(ye=ye||["#fff","#000"],ye&&Da(ye)==="string"&&Ys.brewer&&Ys.brewer[ye.toLowerCase()]&&(ye=Ys.brewer[ye.toLowerCase()]),Da(ye)==="array"){ye.length===1&&(ye=[ye[0],ye[0]]),ye=ye.slice(0);for(var it=0;it<ye.length;it++)ye[it]=Ys(ye[it]);K.length=0;for(var gt=0;gt<ye.length;gt++)K.push(gt/(ye.length-1))}return ms(),te=ye},Ct=function(ye){if(ee!=null){for(var it=ee.length-1,gt=0;gt<it&&ye>=ee[gt];)gt++;return gt-1}return 0},Lt=function(ye){return ye},Hi=function(ye){return ye},ki=function(ye,it){var gt,pt;if(it==null&&(it=!1),isNaN(ye)||ye===null)return P;if(it)pt=ye;else if(ee&&ee.length>2){var Wi=Ct(ye);pt=Wi/(ee.length-2)}else Ge!==Ee?pt=(ye-Ee)/(Ge-Ee):pt=1;pt=Hi(pt),it||(pt=Lt(pt)),_t!==1&&(pt=$A(pt,_t)),pt=U[0]+pt*(1-U[0]-U[1]),pt=Math.min(1,Math.max(0,pt));var ii=Math.floor(pt*1e4);if($e&&je[ii])gt=je[ii];else{if(Da(te)==="array")for(var xt=0;xt<K.length;xt++){var Bt=K[xt];if(pt<=Bt){gt=te[xt];break}if(pt>=Bt&&xt===K.length-1){gt=te[xt];break}if(pt>Bt&&pt<K[xt+1]){pt=(pt-Bt)/(K[xt+1]-Bt),gt=Ys.interpolate(te[xt],te[xt+1],pt,C);break}}else Da(te)==="function"&&(gt=te(pt));$e&&(je[ii]=gt)}return gt},ms=function(){return je={}};Et(A);var Rt=function(ye){var it=Ys(ki(ye));return ue&&it[ue]?it[ue]():it};return Rt.classes=function(ye){if(ye!=null){if(Da(ye)==="array")ee=ye,z=[ye[0],ye[ye.length-1]];else{var it=Ys.analyze(z);ye===0?ee=[it.min,it.max]:ee=Ys.limits(it,"e",ye)}return Rt}return ee},Rt.domain=function(ye){if(!arguments.length)return z;Ee=ye[0],Ge=ye[ye.length-1],K=[];var it=te.length;if(ye.length===it&&Ee!==Ge)for(var gt=0,pt=Array.from(ye);gt<pt.length;gt+=1){var Wi=pt[gt];K.push((Wi-Ee)/(Ge-Ee))}else{for(var ii=0;ii<it;ii++)K.push(ii/(it-1));if(ye.length>2){var xt=ye.map(function(Ut,Wt){return Wt/(ye.length-1)}),Bt=ye.map(function(Ut){return(Ut-Ee)/(Ge-Ee)});Bt.every(function(Ut,Wt){return xt[Wt]===Ut})||(Hi=function(Ut){if(Ut<=0||Ut>=1)return Ut;for(var Wt=0;Ut>=Bt[Wt+1];)Wt++;var $s=(Ut-Bt[Wt])/(Bt[Wt+1]-Bt[Wt]),rn=xt[Wt]+$s*(xt[Wt+1]-xt[Wt]);return rn})}}return z=[Ee,Ge],Rt},Rt.mode=function(ye){return arguments.length?(C=ye,ms(),Rt):C},Rt.range=function(ye,it){return Et(ye),Rt},Rt.out=function(ye){return ue=ye,Rt},Rt.spread=function(ye){return arguments.length?(F=ye,Rt):F},Rt.correctLightness=function(ye){return ye==null&&(ye=!0),be=ye,ms(),be?Lt=function(it){for(var gt=ki(0,!0).lab()[0],pt=ki(1,!0).lab()[0],Wi=gt>pt,ii=ki(it,!0).lab()[0],xt=gt+(pt-gt)*it,Bt=ii-xt,Ut=0,Wt=1,$s=20;Math.abs(Bt)>.01&&$s-- >0;)(function(){return Wi&&(Bt*=-1),Bt<0?(Ut=it,it+=(Wt-it)*.5):(Wt=it,it+=(Ut-it)*.5),ii=ki(it,!0).lab()[0],Bt=ii-xt})();return it}:Lt=function(it){return it},Rt},Rt.padding=function(ye){return ye!=null?(Da(ye)==="number"&&(ye=[ye,ye]),U=ye,Rt):U},Rt.colors=function(ye,it){arguments.length<2&&(it="hex");var gt=[];if(arguments.length===0)gt=te.slice(0);else if(ye===1)gt=[Rt(.5)];else if(ye>1){var pt=z[0],Wi=z[1]-pt;gt=jA(0,ye,!1).map(function(Wt){return Rt(pt+Wt/(ye-1)*Wi)})}else{A=[];var ii=[];if(ee&&ee.length>2)for(var xt=1,Bt=ee.length,Ut=1<=Bt;Ut?xt<Bt:xt>Bt;Ut?xt++:xt--)ii.push((ee[xt-1]+ee[xt])*.5);else ii=z;gt=ii.map(function(Wt){return Rt(Wt)})}return Ys[it]&&(gt=gt.map(function(Wt){return Wt[it]()})),gt},Rt.cache=function(ye){return ye!=null?($e=ye,Rt):$e},Rt.gamma=function(ye){return ye!=null?(_t=ye,Rt):_t},Rt.nodata=function(ye){return ye!=null?(P=Ys(ye),Rt):P},Rt};function jA(A,C,P){for(var F=[],z=A<C,K=P?z?C+1:C-1:C,U=A;z?U<K:U>K;z?U++:U--)F.push(U);return F}var Wl=y,qA=Vu,ZA=function(A){for(var C=[1,1],P=1;P<A;P++){for(var F=[1],z=1;z<=C.length;z++)F[z]=(C[z]||0)+C[z-1];C=F}return C},QA=function(A){var C,P,F,z,K,U,ee;if(A=A.map(function(be){return new Wl(be)}),A.length===2)C=A.map(function(be){return be.lab()}),K=C[0],U=C[1],z=function(be){var je=[0,1,2].map(function($e){return K[$e]+be*(U[$e]-K[$e])});return new Wl(je,"lab")};else if(A.length===3)P=A.map(function(be){return be.lab()}),K=P[0],U=P[1],ee=P[2],z=function(be){var je=[0,1,2].map(function($e){return(1-be)*(1-be)*K[$e]+2*(1-be)*be*U[$e]+be*be*ee[$e]});return new Wl(je,"lab")};else if(A.length===4){var te;F=A.map(function(be){return be.lab()}),K=F[0],U=F[1],ee=F[2],te=F[3],z=function(be){var je=[0,1,2].map(function($e){return(1-be)*(1-be)*(1-be)*K[$e]+3*(1-be)*(1-be)*be*U[$e]+3*(1-be)*be*be*ee[$e]+be*be*be*te[$e]});return new Wl(je,"lab")}}else if(A.length>=5){var ue,Ee,Ge;ue=A.map(function(be){return be.lab()}),Ge=A.length-1,Ee=ZA(Ge),z=function(be){var je=1-be,$e=[0,1,2].map(function(_t){return ue.reduce(function(Et,Ct,Lt){return Et+Ee[Lt]*Math.pow(je,Ge-Lt)*Math.pow(be,Lt)*Ct[_t]},0)});return new Wl($e,"lab")}}else throw new RangeError("No point in running bezier with only one color.");return z},JA=function(A){var C=QA(A);return C.scale=function(){return qA(C)},C},Gu=O,Ks=function(A,C,P){if(!Ks[P])throw new Error("unknown blend mode "+P);return Ks[P](A,C)},tn=function(A){return function(C,P){var F=Gu(P).rgb(),z=Gu(C).rgb();return Gu.rgb(A(F,z))}},sn=function(A){return function(C,P){var F=[];return F[0]=A(C[0],P[0]),F[1]=A(C[1],P[1]),F[2]=A(C[2],P[2]),F}},eR=function(A){return A},tR=function(A,C){return A*C/255},iR=function(A,C){return A>C?C:A},sR=function(A,C){return A>C?A:C},rR=function(A,C){return 255*(1-(1-A/255)*(1-C/255))},nR=function(A,C){return C<128?2*A*C/255:255*(1-2*(1-A/255)*(1-C/255))},aR=function(A,C){return 255*(1-(1-C/255)/(A/255))},oR=function(A,C){return A===255?255:(A=255*(C/255)/(1-A/255),A>255?255:A)};Ks.normal=tn(sn(eR)),Ks.multiply=tn(sn(tR)),Ks.screen=tn(sn(rR)),Ks.overlay=tn(sn(nR)),Ks.darken=tn(sn(iR)),Ks.lighten=tn(sn(sR)),Ks.dodge=tn(sn(oR)),Ks.burn=tn(sn(aR));for(var lR=Ks,zu=_.type,hR=_.clip_rgb,cR=_.TWOPI,uR=Math.pow,dR=Math.sin,fR=Math.cos,fp=O,_R=function(A,C,P,F,z){A===void 0&&(A=300),C===void 0&&(C=-1.5),P===void 0&&(P=1),F===void 0&&(F=1),z===void 0&&(z=[0,1]);var K=0,U;zu(z)==="array"?U=z[1]-z[0]:(U=0,z=[z,z]);var ee=function(te){var ue=cR*((A+120)/360+C*te),Ee=uR(z[0]+U*te,F),Ge=K!==0?P[0]+te*K:P,be=Ge*Ee*(1-Ee)/2,je=fR(ue),$e=dR(ue),_t=Ee+be*(-.14861*je+1.78277*$e),Et=Ee+be*(-.29227*je-.90649*$e),Ct=Ee+be*(1.97294*je);return fp(hR([_t*255,Et*255,Ct*255,1]))};return ee.start=function(te){return te==null?A:(A=te,ee)},ee.rotations=function(te){return te==null?C:(C=te,ee)},ee.gamma=function(te){return te==null?F:(F=te,ee)},ee.hue=function(te){return te==null?P:(P=te,zu(P)==="array"?(K=P[1]-P[0],K===0&&(P=P[1])):K=0,ee)},ee.lightness=function(te){return te==null?z:(zu(te)==="array"?(z=te,U=te[1]-te[0]):(z=[te,te],U=0),ee)},ee.scale=function(){return fp.scale(ee)},ee.hue(P),ee},pR=y,gR="0123456789abcdef",mR=Math.floor,ER=Math.random,TR=function(){for(var A="#",C=0;C<6;C++)A+=gR.charAt(mR(ER()*16));return new pR(A,"hex")},Hu=h,_p=Math.log,vR=Math.pow,AR=Math.floor,RR=Math.abs,pp=function(A,C){C===void 0&&(C=null);var P={min:Number.MAX_VALUE,max:Number.MAX_VALUE*-1,sum:0,values:[],count:0};return Hu(A)==="object"&&(A=Object.values(A)),A.forEach(function(F){C&&Hu(F)==="object"&&(F=F[C]),F!=null&&!isNaN(F)&&(P.values.push(F),P.sum+=F,F<P.min&&(P.min=F),F>P.max&&(P.max=F),P.count+=1)}),P.domain=[P.min,P.max],P.limits=function(F,z){return gp(P,F,z)},P},gp=function(A,C,P){C===void 0&&(C="equal"),P===void 0&&(P=7),Hu(A)=="array"&&(A=pp(A));var F=A.min,z=A.max,K=A.values.sort(function(Xu,Yu){return Xu-Yu});if(P===1)return[F,z];var U=[];if(C.substr(0,1)==="c"&&(U.push(F),U.push(z)),C.substr(0,1)==="e"){U.push(F);for(var ee=1;ee<P;ee++)U.push(F+ee/P*(z-F));U.push(z)}else if(C.substr(0,1)==="l"){if(F<=0)throw new Error("Logarithmic scales are only possible for values > 0");var te=Math.LOG10E*_p(F),ue=Math.LOG10E*_p(z);U.push(F);for(var Ee=1;Ee<P;Ee++)U.push(vR(10,te+Ee/P*(ue-te)));U.push(z)}else if(C.substr(0,1)==="q"){U.push(F);for(var Ge=1;Ge<P;Ge++){var be=(K.length-1)*Ge/P,je=AR(be);if(je===be)U.push(K[je]);else{var $e=be-je;U.push(K[je]*(1-$e)+K[je+1]*$e)}}U.push(z)}else if(C.substr(0,1)==="k"){var _t,Et=K.length,Ct=new Array(Et),Lt=new Array(P),Hi=!0,ki=0,ms=null;ms=[],ms.push(F);for(var Rt=1;Rt<P;Rt++)ms.push(F+Rt/P*(z-F));for(ms.push(z);Hi;){for(var ye=0;ye<P;ye++)Lt[ye]=0;for(var it=0;it<Et;it++)for(var gt=K[it],pt=Number.MAX_VALUE,Wi=void 0,ii=0;ii<P;ii++){var xt=RR(ms[ii]-gt);xt<pt&&(pt=xt,Wi=ii),Lt[Wi]++,Ct[it]=Wi}for(var Bt=new Array(P),Ut=0;Ut<P;Ut++)Bt[Ut]=null;for(var Wt=0;Wt<Et;Wt++)_t=Ct[Wt],Bt[_t]===null?Bt[_t]=K[Wt]:Bt[_t]+=K[Wt];for(var $s=0;$s<P;$s++)Bt[$s]*=1/Lt[$s];Hi=!1;for(var rn=0;rn<P;rn++)if(Bt[rn]!==ms[rn]){Hi=!0;break}ms=Bt,ki++,ki>200&&(Hi=!1)}for(var nn={},Oa=0;Oa<P;Oa++)nn[Oa]=[];for(var Na=0;Na<Et;Na++)_t=Ct[Na],nn[_t].push(K[Na]);for(var Ir=[],Gn=0;Gn<P;Gn++)Ir.push(nn[Gn][0]),Ir.push(nn[Gn][nn[Gn].length-1]);Ir=Ir.sort(function(Xu,Yu){return Xu-Yu}),U.push(Ir[0]);for(var Xl=1;Xl<Ir.length;Xl+=2){var zn=Ir[Xl];!isNaN(zn)&&U.indexOf(zn)===-1&&U.push(zn)}}return U},mp={analyze:pp,limits:gp},Ep=y,bR=function(A,C){A=new Ep(A),C=new Ep(C);var P=A.luminance(),F=C.luminance();return P>F?(P+.05)/(F+.05):(F+.05)/(P+.05)},Tp=y,Mr=Math.sqrt,xi=Math.pow,SR=Math.min,yR=Math.max,vp=Math.atan2,Ap=Math.abs,mc=Math.cos,Rp=Math.sin,CR=Math.exp,bp=Math.PI,xR=function(A,C,P,F,z){P===void 0&&(P=1),F===void 0&&(F=1),z===void 0&&(z=1);var K=function(zn){return 360*zn/(2*bp)},U=function(zn){return 2*bp*zn/360};A=new Tp(A),C=new Tp(C);var ee=Array.from(A.lab()),te=ee[0],ue=ee[1],Ee=ee[2],Ge=Array.from(C.lab()),be=Ge[0],je=Ge[1],$e=Ge[2],_t=(te+be)/2,Et=Mr(xi(ue,2)+xi(Ee,2)),Ct=Mr(xi(je,2)+xi($e,2)),Lt=(Et+Ct)/2,Hi=.5*(1-Mr(xi(Lt,7)/(xi(Lt,7)+xi(25,7)))),ki=ue*(1+Hi),ms=je*(1+Hi),Rt=Mr(xi(ki,2)+xi(Ee,2)),ye=Mr(xi(ms,2)+xi($e,2)),it=(Rt+ye)/2,gt=K(vp(Ee,ki)),pt=K(vp($e,ms)),Wi=gt>=0?gt:gt+360,ii=pt>=0?pt:pt+360,xt=Ap(Wi-ii)>180?(Wi+ii+360)/2:(Wi+ii)/2,Bt=1-.17*mc(U(xt-30))+.24*mc(U(2*xt))+.32*mc(U(3*xt+6))-.2*mc(U(4*xt-63)),Ut=ii-Wi;Ut=Ap(Ut)<=180?Ut:ii<=Wi?Ut+360:Ut-360,Ut=2*Mr(Rt*ye)*Rp(U(Ut)/2);var Wt=be-te,$s=ye-Rt,rn=1+.015*xi(_t-50,2)/Mr(20+xi(_t-50,2)),nn=1+.045*it,Oa=1+.015*it*Bt,Na=30*CR(-xi((xt-275)/25,2)),Ir=2*Mr(xi(it,7)/(xi(it,7)+xi(25,7))),Gn=-Ir*Rp(2*U(Na)),Xl=Mr(xi(Wt/(P*rn),2)+xi($s/(F*nn),2)+xi(Ut/(z*Oa),2)+Gn*($s/(F*nn))*(Ut/(z*Oa)));return yR(0,SR(100,Xl))},Sp=y,MR=function(A,C,P){P===void 0&&(P="lab"),A=new Sp(A),C=new Sp(C);var F=A.get(P),z=C.get(P),K=0;for(var U in F){var ee=(F[U]||0)-(z[U]||0);K+=ee*ee}return Math.sqrt(K)},IR=y,PR=function(){for(var A=[],C=arguments.length;C--;)A[C]=arguments[C];try{return new(Function.prototype.bind.apply(IR,[null].concat(A))),!0}catch{return!1}},yp=O,Cp=Vu,DR={cool:function(){return Cp([yp.hsl(180,1,.9),yp.hsl(250,.7,.4)])},hot:function(){return Cp(["#000","#f00","#ff0","#fff"]).mode("rgb")}},Ec={OrRd:["#fff7ec","#fee8c8","#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#b30000","#7f0000"],PuBu:["#fff7fb","#ece7f2","#d0d1e6","#a6bddb","#74a9cf","#3690c0","#0570b0","#045a8d","#023858"],BuPu:["#f7fcfd","#e0ecf4","#bfd3e6","#9ebcda","#8c96c6","#8c6bb1","#88419d","#810f7c","#4d004b"],Oranges:["#fff5eb","#fee6ce","#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704"],BuGn:["#f7fcfd","#e5f5f9","#ccece6","#99d8c9","#66c2a4","#41ae76","#238b45","#006d2c","#00441b"],YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],YlGn:["#ffffe5","#f7fcb9","#d9f0a3","#addd8e","#78c679","#41ab5d","#238443","#006837","#004529"],Reds:["#fff5f0","#fee0d2","#fcbba1","#fc9272","#fb6a4a","#ef3b2c","#cb181d","#a50f15","#67000d"],RdPu:["#fff7f3","#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"],Greens:["#f7fcf5","#e5f5e0","#c7e9c0","#a1d99b","#74c476","#41ab5d","#238b45","#006d2c","#00441b"],YlGnBu:["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"],Purples:["#fcfbfd","#efedf5","#dadaeb","#bcbddc","#9e9ac8","#807dba","#6a51a3","#54278f","#3f007d"],GnBu:["#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4","#4eb3d3","#2b8cbe","#0868ac","#084081"],Greys:["#ffffff","#f0f0f0","#d9d9d9","#bdbdbd","#969696","#737373","#525252","#252525","#000000"],YlOrRd:["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026"],PuRd:["#f7f4f9","#e7e1ef","#d4b9da","#c994c7","#df65b0","#e7298a","#ce1256","#980043","#67001f"],Blues:["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],PuBuGn:["#fff7fb","#ece2f0","#d0d1e6","#a6bddb","#67a9cf","#3690c0","#02818a","#016c59","#014636"],Viridis:["#440154","#482777","#3f4a8a","#31678e","#26838f","#1f9d8a","#6cce5a","#b6de2b","#fee825"],Spectral:["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],RdYlGn:["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],RdBu:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#f7f7f7","#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"],PiYG:["#8e0152","#c51b7d","#de77ae","#f1b6da","#fde0ef","#f7f7f7","#e6f5d0","#b8e186","#7fbc41","#4d9221","#276419"],PRGn:["#40004b","#762a83","#9970ab","#c2a5cf","#e7d4e8","#f7f7f7","#d9f0d3","#a6dba0","#5aae61","#1b7837","#00441b"],RdYlBu:["#a50026","#d73027","#f46d43","#fdae61","#fee090","#ffffbf","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],BrBG:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#f5f5f5","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],RdGy:["#67001f","#b2182b","#d6604d","#f4a582","#fddbc7","#ffffff","#e0e0e0","#bababa","#878787","#4d4d4d","#1a1a1a"],PuOr:["#7f3b08","#b35806","#e08214","#fdb863","#fee0b6","#f7f7f7","#d8daeb","#b2abd2","#8073ac","#542788","#2d004b"],Set2:["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"],Accent:["#7fc97f","#beaed4","#fdc086","#ffff99","#386cb0","#f0027f","#bf5b17","#666666"],Set1:["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],Set3:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"],Dark2:["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#a6761d","#666666"],Paired:["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"],Pastel2:["#b3e2cd","#fdcdac","#cbd5e8","#f4cae4","#e6f5c9","#fff2ae","#f1e2cc","#cccccc"],Pastel1:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"]},Wu=0,xp=Object.keys(Ec);Wu<xp.length;Wu+=1){var Mp=xp[Wu];Ec[Mp.toLowerCase()]=Ec[Mp]}var OR=Ec,Ui=O;Ui.average=YA,Ui.bezier=JA,Ui.blend=lR,Ui.cubehelix=_R,Ui.mix=Ui.interpolate=rp,Ui.random=TR,Ui.scale=Vu,Ui.analyze=mp.analyze,Ui.contrast=bR,Ui.deltaE=xR,Ui.distance=MR,Ui.limits=mp.limits,Ui.valid=PR,Ui.scales=DR,Ui.colors=V_,Ui.brewer=OR;var NR=Ui;return NR})})(SE);var SO=SE.exports;const Yg=Gf(SO),Vr={fromAttr(o,e){if(e===null)return null;if(o==="Number")return Number(e)||0;if(o==="String")return String(e);if(o==="Boolean")return!0;if(o==="Array")return e.split(" ").map(t=>t.trim());if(o==="Vector2")return Ke.FromArray($l(e));if(o==="Vector3")return m.FromArray($l(e));if(o==="Vector4")return ut.FromArray($l(e));if(o==="Quaternion")return le.FromArray($l(e));if(o==="Color3")return J.FromHexString(Yg(e).hex());if(o==="Color4")return He.FromHexString(Yg(e).hex());if(o==="Matrix")return L.FromArray($l(e));if(o==="Object"){const t={};if(e==="")return t;const i=e.split(";");for(const s of i){if(!s)continue;const r=s.indexOf(":"),n=s.slice(0,r).trim(),a=s.slice(r+1).trim();t[n]=a}return t}else if(o==="TransitionList"){const t=[],i=e.split(",").map(s=>s.trim());for(const s of i){const[r,n="0s",a="",l="0s"]=s.split(/\s+/g);t.push({property:r,duration:bO(n),timingFunction:a,delay:parseFloat(l)})}return t}else throw new Error(`Schema.parse: unknown schema type ${o}`)},toAttr(o,e){if(e===null)return null;if(o==="Number")return String(e);if(o==="String")return String(e);if(o==="Boolean")return"";if(o==="Array")return e.join(" ");if(o==="Vector2")return e.asArray().join(" ");if(o==="Vector3")return e.asArray().join(" ");if(o==="Vector4")return e.asArray().join(" ");if(o==="Quaternion")return e.asArray().join(" ");if(o==="Color3")return e.toHexString();if(o==="Color4")return e.toHexString();if(o==="Matrix")return e.asArray().join(" ");if(o==="Object"){const t=[];for(const i in e)t.push(`${i}:${e[i]}`);return t.join(";")}else if(o==="TransitionList"){const t=[];for(const i of e)t.push(`${i.property} ${i.duration}s ${i.timingFunction} ${i.delay}s`);return t.join(",")}else throw new Error(`Schema.stringify: unknown schema type ${o}`)},isEqual(o,e,t){return typeof e>"u"||e===null?typeof t>"u"||t===null:o==="Number"||o==="String"||o==="Boolean"||o==="Array"?e===t:o==="Vector2"||o==="Vector3"||o==="Vector4"||o==="Quaternion"||o==="Color3"||o==="Color4"||o==="Matrix"?e.equals(t):o==="Object"||o==="TransitionList"?e===t:!1},toCssLiteral(o,e){if(o==="Boolean")return e?"true":"";const t=this.toAttr(o,e);return t===null?"":o==="String"||o==="Object"?`"${t}"`:t},fromCssLiteral(o,e){return e===""?null:this.fromAttr(o,e.replace(/^['"]/,"").replace(/['"]$/,""))}};function $l(o){return o.split(" ").map(e=>Number(e.trim()))}class Kg{constructor(e,t){this.type=e,this._value=t}valueOf(){return this._value}}function BU(o,e){const t=new Map;for(let i=0;i<e.length;i++){const s=e[i],r=t.get(s[o]);r?r.push(s):t.set(s[o],[s])}for(const[i,s]of t)if(!(s.length<2))for(let r=1;r<s.length;r++){const n=s[r];n[o]=`${i}.${(r+"").padStart(4,"0")}`}}function Hh(){const o=Math.random().toString(32).slice(-6),e=new Date().valueOf().toString(32).slice(-2);return[o,e].join("")}function yE(o){return typeof o>"u"||typeof o=="boolean"||typeof o=="number"||typeof o=="string"||o===null?o:typeof o.clone=="function"?o.clone():JSON.parse(JSON.stringify(o))}const $={scene:()=>Gg({context:Uc.Scene,subscribe:!0}),AssetContainer:()=>Gg({context:Uc.AssetContainer,subscribe:!0}),property:(o,e,t)=>bE({dType:o,initValue:yE(t),attribute:e,converter:{fromAttribute:i=>Vr.fromAttr(o,i),toAttribute:i=>Vr.toAttr(o,i)},hasChanged:(i,s)=>!Vr.isEqual(o,i,s)})};class yO{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===xe.POINTERDOWN){this._isPointerDown=!0;return}i.type===xe.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=Os.Now;let s=0;this._lastFrameTime!=null&&(s=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const r=i-this._lastInteractionTime-this._idleRotationWaitTime,n=Math.max(Math.min(r/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*n,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(s/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Os.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<dt:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Os.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class ra{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(!i)return;i.computeWorldMatrix(!0);const s=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=s*.05,this.upperRadiusTransitionRange=s*.05}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(ra.EasingFunction.setEasingMode(ra.EasingMode),this._radiusBounceTransition=W.CreateAnimation("radius",W.ANIMATIONTYPE_FLOAT,60,ra.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=W.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}ra.EasingFunction=new zb(.3);ra.EasingMode=tr.EASINGMODE_EASEOUT;class as{constructor(){this.onTargetFramingAnimationEndObservable=new j,this._mode=as.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();as.EasingFunction.setEasingMode(as.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===xe.POINTERDOWN){this._isPointerDown=!0;return}i.type===xe.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(s.min,s.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const s=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let n=0;n<e.length;n++){const a=e[n].getHierarchyBoundingVectors(!0);m.CheckExtends(a.min,s,r),m.CheckExtends(a.max,s,r)}this.zoomOnBoundingInfo(s,r,t,i)}zoomOnBoundingInfo(e,t,i=!1,s=null){let r;if(!this._attachedCamera)return!1;const n=e.y,a=t.y,l=n+(a-n)*this._positionScale,h=t.subtract(e).scale(.5);if(i)r=new m(0,l,0);else{const d=e.add(h);r=new m(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=W.CreateAnimation("target",W.ANIMATIONTYPE_VECTOR3,60,as.EasingFunction)),this._betaIsAnimating=!0;let c=W.TransitionTo("target",r,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);c&&this._animatables.push(c);let u=0;if(this._mode===as.FitFrustumSidesMode){const d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=h.length()+this._attachedCamera.minZ),u=d}else this._mode===as.IgnoreBoundsSizeMode&&(u=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/u}return this._radiusTransition||(this._radiusTransition=W.CreateAnimation("radius",W.ANIMATIONTYPE_FLOAT,60,as.EasingFunction)),c=W.TransitionTo("radius",u,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),s&&s(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),c&&this._animatables.push(c),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){const i=this._attachedCamera;if(!i)return 0;let s=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===as.IgnoreBoundsSizeMode&&(s=s<i.lowerRadiusLimit?i.lowerRadiusLimit:s),i.upperRadiusLimit&&(s=s>i.upperRadiusLimit?i.upperRadiusLimit:s),s}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=Os.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=W.CreateAnimation("beta",W.ANIMATIONTYPE_FLOAT,60,as.EasingFunction));const s=W.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});s&&this._animatables.push(s)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Os.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}as.EasingFunction=new Hb;as.EasingMode=tr.EASINGMODE_EASEINOUT;as.IgnoreBoundsSizeMode=0;as.FitFrustumSidesMode=1;class CE{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=Y.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let s=0,r=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=a=>{var l,h;const c=a.event,u=c.pointerType==="touch";if(a.type!==xe.POINTERMOVE&&this.buttons.indexOf(c.button)===-1)return;const d=c.target;if(this._altKey=c.altKey,this._ctrlKey=c.ctrlKey,this._metaKey=c.metaKey,this._shiftKey=c.shiftKey,this._buttonsPressed=c.buttons,t.isPointerLock){const f=c.movementX,p=c.movementY;this.onTouch(null,f,p),this._pointA=null,this._pointB=null}else{if(a.type!==xe.POINTERDOWN&&u&&((l=this._pointA)===null||l===void 0?void 0:l.pointerId)!==c.pointerId&&((h=this._pointB)===null||h===void 0?void 0:h.pointerId)!==c.pointerId)return;if(a.type===xe.POINTERDOWN&&(this._currentActiveButton===-1||u)){try{d==null||d.setPointerCapture(c.pointerId)}catch{}if(this._pointA===null)this._pointA={x:c.clientX,y:c.clientY,pointerId:c.pointerId,type:c.pointerType};else if(this._pointB===null)this._pointB={x:c.clientX,y:c.clientY,pointerId:c.pointerId,type:c.pointerType};else return;this._currentActiveButton===-1&&!u&&(this._currentActiveButton=c.button),this.onButtonDown(c),e||(c.preventDefault(),i&&i.focus())}else if(a.type===xe.POINTERDOUBLETAP)this.onDoubleTap(c.pointerType);else if(a.type===xe.POINTERUP&&(this._currentActiveButton===c.button||u)){try{d==null||d.releasePointerCapture(c.pointerId)}catch{}u||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==c.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==c.pointerId?this._pointB=null:this._pointA=this._pointB=null,(s!==0||r)&&(this.onMultiTouch(this._pointA,this._pointB,s,0,r,null),s=0,r=null),this._currentActiveButton=-1,this.onButtonUp(c),e||c.preventDefault()}else if(a.type===xe.POINTERMOVE){if(e||c.preventDefault(),this._pointA&&this._pointB===null){const f=c.clientX-this._pointA.x,p=c.clientY-this._pointA.y;this.onTouch(this._pointA,f,p),this._pointA.x=c.clientX,this._pointA.y=c.clientY}else if(this._pointA&&this._pointB){const f=this._pointA.pointerId===c.pointerId?this._pointA:this._pointB;f.x=c.clientX,f.y=c.clientY;const p=this._pointA.x-this._pointB.x,_=this._pointA.y-this._pointB.y,g=p*p+_*_,E={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:c.pointerId,type:a.type};this.onMultiTouch(this._pointA,this._pointB,s,g,r,E),r=E,s=g}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,xe.POINTERDOWN|xe.POINTERUP|xe.POINTERMOVE|xe.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,s=0,r=null,this.onLostFocus()},this._contextMenuBind=a=>this.onContextMenu(a),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const n=this.camera.getScene().getEngine().getHostWindow();n&&Y.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&Y.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,s,r,n){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}v([M()],CE.prototype,"buttons",void 0);class fs extends CE{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){const i=t.x-e.x,s=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||fs.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,s,r,n){i===0&&r===null||s===0&&n===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,s),this._computeMultiTouchPanning(r,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(s)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,s),this._isPinching=!0):this._computeMultiTouchPanning(r,n)):this.multiTouchPanning?this._computeMultiTouchPanning(r,n):this.pinchZoom&&this._computePinchZoom(i,s))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}fs.MinimumRadiusForPinch=.001;v([M()],fs.prototype,"buttons",void 0);v([M()],fs.prototype,"angularSensibilityX",void 0);v([M()],fs.prototype,"angularSensibilityY",void 0);v([M()],fs.prototype,"pinchPrecision",void 0);v([M()],fs.prototype,"pinchDeltaPercentage",void 0);v([M()],fs.prototype,"useNaturalPinchZoom",void 0);v([M()],fs.prototype,"pinchZoom",void 0);v([M()],fs.prototype,"panningSensibility",void 0);v([M()],fs.prototype,"multiTouchPanning",void 0);v([M()],fs.prototype,"multiTouchPanAndZoom",void 0);zr.ArcRotateCameraPointersInput=fs;class nr{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=Y.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===to.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}v([M()],nr.prototype,"keysUp",void 0);v([M()],nr.prototype,"keysDown",void 0);v([M()],nr.prototype,"keysLeft",void 0);v([M()],nr.prototype,"keysRight",void 0);v([M()],nr.prototype,"keysReset",void 0);v([M()],nr.prototype,"panningSensibility",void 0);v([M()],nr.prototype,"zoomingSensibility",void 0);v([M()],nr.prototype,"useAltToZoom",void 0);v([M()],nr.prototype,"angularSpeed",void 0);zr.ArcRotateCameraKeyboardMoveInput=nr;const CO=40;class Wh{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new m(0,0,0),this._globalOffset=new m(0,0,0),this._inertialPanning=m.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const s=e*.01*this.wheelDeltaPercentage*t;return e>0?i=s/(1+this.wheelDeltaPercentage):i=s*(1+this.wheelDeltaPercentage),i}attachControl(e){e=Y.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==xe.POINTERWHEEL)return;const i=t.event;let s=0;const r=i.deltaMode===vl.DOM_DELTA_LINE?CO:1,n=-(i.deltaY*r);if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),s>0){let a=this.camera.radius,l=this.camera.inertialRadiusOffset+s;for(let h=0;h<20&&Math.abs(l)>.001;h++)a-=l,l*=this.camera.inertia;a=Te.Clamp(a,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(n,a)}}else s=n/(this.wheelPrecision*40);s&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(s)):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,xe.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Us.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),s=i.createPickingRay(i.pointerX,i.pointerY,L.Identity(),t,!1);(t.targetScreenOffset.x!==0||t.targetScreenOffset.y!==0)&&(this._viewOffset.set(t.targetScreenOffset.x,t.targetScreenOffset.y,0),t.getViewMatrix().invertToRef(t._cameraTransformMatrix),this._globalOffset=m.TransformNormal(this._viewOffset,t._cameraTransformMatrix),s.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=(e=s.intersectsPlane(this._hitPlane))!==null&&e!==void 0?e:0),s.origin.addInPlace(s.direction.scaleInPlace(r))}_zoomToMouse(e){var t,i;const s=this.camera,r=1-s.inertia;if(s.lowerRadiusLimit){const c=(t=s.lowerRadiusLimit)!==null&&t!==void 0?t:0;s.radius-(s.inertialRadiusOffset+e)/r<c&&(e=(s.radius-c)*r-s.inertialRadiusOffset)}if(s.upperRadiusLimit){const c=(i=s.upperRadiusLimit)!==null&&i!==void 0?i:0;s.radius-(s.inertialRadiusOffset+e)/r>c&&(e=(s.radius-c)*r-s.inertialRadiusOffset)}const a=e/r/s.radius,l=this._getPosition(),h=D.Vector3[6];l.subtractToRef(s.target,h),h.scaleInPlace(a),h.scaleInPlace(r),this._inertialPanning.addInPlace(h),s.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<dt&&(e.x=0),Math.abs(e.y)<dt&&(e.y=0),Math.abs(e.z)<dt&&(e.z=0)}}v([M()],Wh.prototype,"wheelPrecision",void 0);v([M()],Wh.prototype,"zoomToMouseLocation",void 0);v([M()],Wh.prototype,"wheelDeltaPercentage",void 0);zr.ArcRotateCameraMouseWheelInput=Wh;class xO extends eE{constructor(e){super(e)}addMouseWheel(){return this.add(new Wh),this}addPointers(){return this.add(new fs),this}addKeyboard(){return this.add(new nr),this}}Jt.AddNodeConstructor("ArcRotateCamera",(o,e)=>()=>new Gt(o,0,0,1,m.Zero(),e));class Gt extends vi{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new L,this._upToYMatrix=new L,this._upVector=m.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){L.RotationAlignToRef(m.UpReadOnly,this._upVector,this._yToUpMatrix),L.RotationAlignToRef(this._upVector,m.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new ra,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new as,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new yO,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,s,r,n,a=!0){super(e,m.Zero(),n,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=m.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=Ke.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new L,this.panningAxis=new m(1,1,0),this._transformedDirection=new m,this.mapPanning=!1,this.onMeshTargetChangedObservable=new j,this.checkCollisions=!1,this.collisionRadius=new m(.5,.5,.5),this._previousPosition=m.Zero(),this._collisionVelocity=m.Zero(),this._newPosition=m.Zero(),this._computationVector=m.Zero(),this._onCollisionPositionChange=(l,h,c=null)=>{c?(this.setPosition(h),this.onCollide&&this.onCollide(c)):this._previousPosition.copyFrom(this._position);const u=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta);let p=Math.sin(this.beta);p===0&&(p=1e-4);const _=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*u*p,this.radius*f,this.radius*d*p),_.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let g=this.upVector;this.allowUpsideDown&&this.beta<0&&(g=g.clone(),g=g.negate()),this._computeViewMatrix(this._position,_,g),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=m.Zero(),r&&this.setTarget(r),this.alpha=t,this.beta=i,this.radius=s,this.getViewMatrix(),this.inputs=new xO(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=Ke.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,s=2){const r=arguments;t=Y.BackCompatCameraNoPreventDefault(r),this._useCtrlForPanning=i,this._panningMouseButton=s,typeof r[0]=="boolean"&&(r.length>1&&(this._useCtrlForPanning=r[1]),r.length>2&&(this._panningMouseButton=r[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier();let i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<dt&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<dt&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*dt&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new m(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),m.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){const t=this.upVector,i=m.CrossToRef(this._transformedDirection,t,this._transformedDirection);m.CrossToRef(t,i,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),m.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*dt&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*dt&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,s=!1){var r;if(s=(r=this.overrideCloneAlphaBetaRadius)!==null&&r!==void 0?r:s,e.getBoundingInfo)t?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const n=e,a=this._getTargetPosition();if(a&&!i&&a.equals(n))return;this._targetHost=null,this._target=n,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}s||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let s=Math.sin(this.beta);s===0&&(s=1e-4),this.radius===0&&(this.radius=1e-4);const r=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*s,this.radius*i,this.radius*t*s),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),r.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,n.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let n=this.upVector;this.allowUpsideDown&&s<0&&(n=n.negate()),this._computeViewMatrix(this._position,r,n),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=r,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=re.MinMax(e);let s=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);s=Math.max(Math.min(s,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=s*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:s},t)}focusOn(e,t=!1){let i,s;if(e.min===void 0){const r=e||this.getScene().meshes;i=re.MinMax(r),s=m.Distance(i.min,i.max)}else{const r=e;i=r,s=r.distance}this._target=re.Center(i),t||(this.maxZ=s*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case De.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case De.RIG_MODE_STEREOSCOPIC_OVERUNDER:case De.RIG_MODE_STEREOSCOPIC_INTERLACED:case De.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}const s=new Gt(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return s._cameraRigParams={},s.isRigCamera=!0,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case De.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case De.RIG_MODE_STEREOSCOPIC_OVERUNDER:case De.RIG_MODE_STEREOSCOPIC_INTERLACED:case De.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case De.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){const s=m.Distance(e,t),n=this.getScene().getEngine().getAspectRatio(this),a=Math.tan(this.fov/2),l=a*n,c=s*.5*i,u=c*Math.sqrt(1+1/(l*l)),d=c*Math.sqrt(1+1/(a*a));return Math.max(u,d)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}v([M()],Gt.prototype,"alpha",void 0);v([M()],Gt.prototype,"beta",void 0);v([M()],Gt.prototype,"radius",void 0);v([M()],Gt.prototype,"overrideCloneAlphaBetaRadius",void 0);v([zi("target")],Gt.prototype,"_target",void 0);v([Rf("targetHost")],Gt.prototype,"_targetHost",void 0);v([M()],Gt.prototype,"inertialAlphaOffset",void 0);v([M()],Gt.prototype,"inertialBetaOffset",void 0);v([M()],Gt.prototype,"inertialRadiusOffset",void 0);v([M()],Gt.prototype,"lowerAlphaLimit",void 0);v([M()],Gt.prototype,"upperAlphaLimit",void 0);v([M()],Gt.prototype,"lowerBetaLimit",void 0);v([M()],Gt.prototype,"upperBetaLimit",void 0);v([M()],Gt.prototype,"lowerRadiusLimit",void 0);v([M()],Gt.prototype,"upperRadiusLimit",void 0);v([M()],Gt.prototype,"inertialPanningX",void 0);v([M()],Gt.prototype,"inertialPanningY",void 0);v([M()],Gt.prototype,"pinchToPanMaxDistance",void 0);v([M()],Gt.prototype,"panningDistanceLimit",void 0);v([zi()],Gt.prototype,"panningOriginTarget",void 0);v([M()],Gt.prototype,"panningInertia",void 0);v([M()],Gt.prototype,"zoomToMouseLocation",null);v([M()],Gt.prototype,"zoomOnFactor",void 0);v([Af()],Gt.prototype,"targetScreenOffset",void 0);v([M()],Gt.prototype,"allowUpsideDown",void 0);v([M()],Gt.prototype,"useInputToRestoreState",void 0);var ml={},zf={},xE={};Object.defineProperty(xE,"__esModule",{value:!0});var au={},ou={};(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.LoggerLevelNameMap=o.ILoggerLevel=void 0;var e;(function(t){t[t.ALL=0]="ALL",t[t.DEBUG=1]="DEBUG",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR"})(e=o.ILoggerLevel||(o.ILoggerLevel={})),o.LoggerLevelNameMap=new Map(Object.keys(e).map(function(t){return[e[t],t]}))})(ou);Object.defineProperty(au,"__esModule",{value:!0});au.ConsoleAppender=void 0;var ud=ou,MO=function(){function o(){}return o.prototype.append=function(e,t){e===ud.ILoggerLevel.ERROR?console.error(t):e===ud.ILoggerLevel.INFO?console.info(t):e===ud.ILoggerLevel.WARN?console.warn(t):console.info(t)},o}();au.ConsoleAppender=MO;(function(o){var e=Yi&&Yi.__createBinding||(Object.create?function(i,s,r,n){n===void 0&&(n=r);var a=Object.getOwnPropertyDescriptor(s,r);(!a||("get"in a?!s.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return s[r]}}),Object.defineProperty(i,n,a)}:function(i,s,r,n){n===void 0&&(n=r),i[n]=s[r]}),t=Yi&&Yi.__exportStar||function(i,s){for(var r in i)r!=="default"&&!Object.prototype.hasOwnProperty.call(s,r)&&e(s,i,r)};Object.defineProperty(o,"__esModule",{value:!0}),t(xE,o),t(au,o)})(zf);var Xh={};Object.defineProperty(Xh,"__esModule",{value:!0});Xh.formatDate=void 0;function IO(o,e){e===void 0&&(e=new Date);var t={"M+":e.getMonth()+1,"D+":e.getDate(),"H+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(Y+)/.test(o)&&(o=o.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in t)new RegExp("("+i+")").test(o)&&(o=o.replace(RegExp.$1,RegExp.$1.length==1?t[i]:("00"+t[i]).substr((""+t[i]).length)));return o}Xh.formatDate=IO;var Yh={},ME={};(function(o){(function(){var e={not_string:/[^s]/,not_bool:/[^t]/,not_type:/[^T]/,not_primitive:/[^v]/,number:/[diefg]/,numeric_arg:/[bcdiefguxX]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijostTuvxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[+-]/};function t(a){return s(n(a),arguments)}function i(a,l){return t.apply(null,[a].concat(l||[]))}function s(a,l){var h=1,c=a.length,u,d="",f,p,_,g,E,R,x,S;for(f=0;f<c;f++)if(typeof a[f]=="string")d+=a[f];else if(typeof a[f]=="object"){if(_=a[f],_.keys)for(u=l[h],p=0;p<_.keys.length;p++){if(u==null)throw new Error(t('[sprintf] Cannot access property "%s" of undefined value "%s"',_.keys[p],_.keys[p-1]));u=u[_.keys[p]]}else _.param_no?u=l[_.param_no]:u=l[h++];if(e.not_type.test(_.type)&&e.not_primitive.test(_.type)&&u instanceof Function&&(u=u()),e.numeric_arg.test(_.type)&&typeof u!="number"&&isNaN(u))throw new TypeError(t("[sprintf] expecting number but found %T",u));switch(e.number.test(_.type)&&(x=u>=0),_.type){case"b":u=parseInt(u,10).toString(2);break;case"c":u=String.fromCharCode(parseInt(u,10));break;case"d":case"i":u=parseInt(u,10);break;case"j":u=JSON.stringify(u,null,_.width?parseInt(_.width):0);break;case"e":u=_.precision?parseFloat(u).toExponential(_.precision):parseFloat(u).toExponential();break;case"f":u=_.precision?parseFloat(u).toFixed(_.precision):parseFloat(u);break;case"g":u=_.precision?String(Number(u.toPrecision(_.precision))):parseFloat(u);break;case"o":u=(parseInt(u,10)>>>0).toString(8);break;case"s":u=String(u),u=_.precision?u.substring(0,_.precision):u;break;case"t":u=String(!!u),u=_.precision?u.substring(0,_.precision):u;break;case"T":u=Object.prototype.toString.call(u).slice(8,-1).toLowerCase(),u=_.precision?u.substring(0,_.precision):u;break;case"u":u=parseInt(u,10)>>>0;break;case"v":u=u.valueOf(),u=_.precision?u.substring(0,_.precision):u;break;case"x":u=(parseInt(u,10)>>>0).toString(16);break;case"X":u=(parseInt(u,10)>>>0).toString(16).toUpperCase();break}e.json.test(_.type)?d+=u:(e.number.test(_.type)&&(!x||_.sign)?(S=x?"+":"-",u=u.toString().replace(e.sign,"")):S="",E=_.pad_char?_.pad_char==="0"?"0":_.pad_char.charAt(1):" ",R=_.width-(S+u).length,g=_.width&&R>0?E.repeat(R):"",d+=_.align?S+u+g:E==="0"?S+g+u:g+S+u)}return d}var r=Object.create(null);function n(a){if(r[a])return r[a];for(var l=a,h,c=[],u=0;l;){if((h=e.text.exec(l))!==null)c.push(h[0]);else if((h=e.modulo.exec(l))!==null)c.push("%");else if((h=e.placeholder.exec(l))!==null){if(h[2]){u|=1;var d=[],f=h[2],p=[];if((p=e.key.exec(f))!==null)for(d.push(p[1]);(f=f.substring(p[0].length))!=="";)if((p=e.key_access.exec(f))!==null)d.push(p[1]);else if((p=e.index_access.exec(f))!==null)d.push(p[1]);else throw new SyntaxError("[sprintf] failed to parse named argument key");else throw new SyntaxError("[sprintf] failed to parse named argument key");h[2]=d}else u|=2;if(u===3)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");c.push({placeholder:h[0],param_no:h[1],keys:h[2],sign:h[3],pad_char:h[4],align:h[5],width:h[6],precision:h[7],type:h[8]})}else throw new SyntaxError("[sprintf] unexpected placeholder");l=l.substring(h[0].length)}return r[a]=c}o.sprintf=t,o.vsprintf=i,typeof window<"u"&&(window.sprintf=t,window.vsprintf=i)})()})(ME);var PO=Yi&&Yi.__spreadArray||function(o,e,t){if(t||arguments.length===2)for(var i=0,s=e.length,r;i<s;i++)(r||!(i in e))&&(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return o.concat(r||Array.prototype.slice.call(e))};Object.defineProperty(Yh,"__esModule",{value:!0});Yh.formatMsg=void 0;var DO=ME,OO=function(o){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];return DO.sprintf.apply(void 0,PO([o],e,!1))};Yh.formatMsg=OO;var Hf={};(function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.getGlobalLogLevel=o.setGlobalLogLevel=o.GlobalLogLevel=void 0;var e=function(i){o.GlobalLogLevel=i};o.setGlobalLogLevel=e;var t=function(){return o.GlobalLogLevel};o.getGlobalLogLevel=t})(Hf);var lu={},jl=Yi&&Yi.__spreadArray||function(o,e,t){if(t||arguments.length===2)for(var i=0,s=e.length,r;i<s;i++)(r||!(i in e))&&(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return o.concat(r||Array.prototype.slice.call(e))};Object.defineProperty(lu,"__esModule",{value:!0});lu.Logger=void 0;var NO=zf,LO=Xh,dd=Hf,ka=ou,FO=Yh,wO=function(){function o(e,t){t===void 0&&(t=[new NO.ConsoleAppender]),this.name=e,this.appenders=t,this._selfLogLevel=ka.ILoggerLevel.ALL}return o.prototype.append=function(e,t){for(var i=[],s=2;s<arguments.length;s++)i[s-2]=arguments[s];if(!(e<this.logLevel)){var r=ka.LoggerLevelNameMap.get(e)||e+"";t="[".concat((0,LO.formatDate)("YYYY-MM-DD HH:mm:ss.S"),"|").concat(this.name,"|").concat(r,"]")+" "+t;for(var n=FO.formatMsg.apply(void 0,jl([t],i,!1)),a=0;a<this.appenders.length;a++){var l=this.appenders[a];l.append(e,n)}}},o.prototype.extend=function(e){return new o([this.name,e].join("."),this.appenders.concat())},Object.defineProperty(o.prototype,"logLevel",{get:function(){return dd.GlobalLogLevel!==null&&dd.GlobalLogLevel!==void 0?dd.GlobalLogLevel:this._selfLogLevel},set:function(e){this._selfLogLevel=e},enumerable:!1,configurable:!0}),o.prototype.info=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.append.apply(this,jl([ka.ILoggerLevel.INFO,e],t,!1))},o.prototype.warn=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.append.apply(this,jl([ka.ILoggerLevel.WARN,e],t,!1))},o.prototype.error=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.append.apply(this,jl([ka.ILoggerLevel.ERROR,e],t,!1))},o.prototype.debug=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.append.apply(this,jl([ka.ILoggerLevel.DEBUG,e],t,!1))},o}();lu.Logger=wO;(function(o){var e=Yi&&Yi.__createBinding||(Object.create?function(i,s,r,n){n===void 0&&(n=r);var a=Object.getOwnPropertyDescriptor(s,r);(!a||("get"in a?!s.__esModule:a.writable||a.configurable))&&(a={enumerable:!0,get:function(){return s[r]}}),Object.defineProperty(i,n,a)}:function(i,s,r,n){n===void 0&&(n=r),i[n]=s[r]}),t=Yi&&Yi.__exportStar||function(i,s){for(var r in i)r!=="default"&&!Object.prototype.hasOwnProperty.call(s,r)&&e(s,i,r)};Object.defineProperty(o,"__esModule",{value:!0}),t(zf,o),t(Xh,o),t(Yh,o),t(Hf,o),t(ou,o),t(lu,o)})(ml);const IE="LOGGER_LEVEL",BO=ml.ILoggerLevel[localStorage.getItem(IE)||"INFO"];ml.setGlobalLogLevel(BO);window.addEventListener("storage",o=>{o.key===IE&&ml.setGlobalLogLevel(o.newValue?ml.ILoggerLevel[o.newValue]:null)});const gf=new ml.Logger("DEFAULT");/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const hh=globalThis,Vc=hh.trustedTypes,$g=Vc?Vc.createPolicy("lit-html",{createHTML:o=>o}):void 0,PE="$lit$",hn=`lit$${(Math.random()+"").slice(9)}$`,DE="?"+hn,UO=`<${DE}>`,ca=document,Th=()=>ca.createComment(""),vh=o=>o===null||typeof o!="object"&&typeof o!="function",OE=Array.isArray,kO=o=>OE(o)||typeof(o==null?void 0:o[Symbol.iterator])=="function",fd=`[ 	
\f\r]`,ql=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,jg=/-->/g,qg=/>/g,Wn=RegExp(`>|${fd}(?:([^\\s"'>=/]+)(${fd}*=${fd}*(?:[^ 	
\f\r"'\`<>=]|("|')|))|$)`,"g"),Zg=/'/g,Qg=/"/g,NE=/^(?:script|style|textarea|title)$/i,VO=o=>(e,...t)=>({_$litType$:o,strings:e,values:t}),As=VO(1),El=Symbol.for("lit-noChange"),Gi=Symbol.for("lit-nothing"),Jg=new WeakMap,ea=ca.createTreeWalker(ca,129);function LE(o,e){if(!Array.isArray(o)||!o.hasOwnProperty("raw"))throw Error("invalid template strings array");return $g!==void 0?$g.createHTML(e):e}const GO=(o,e)=>{const t=o.length-1,i=[];let s,r=e===2?"<svg>":"",n=ql;for(let a=0;a<t;a++){const l=o[a];let h,c,u=-1,d=0;for(;d<l.length&&(n.lastIndex=d,c=n.exec(l),c!==null);)d=n.lastIndex,n===ql?c[1]==="!--"?n=jg:c[1]!==void 0?n=qg:c[2]!==void 0?(NE.test(c[2])&&(s=RegExp("</"+c[2],"g")),n=Wn):c[3]!==void 0&&(n=Wn):n===Wn?c[0]===">"?(n=s??ql,u=-1):c[1]===void 0?u=-2:(u=n.lastIndex-c[2].length,h=c[1],n=c[3]===void 0?Wn:c[3]==='"'?Qg:Zg):n===Qg||n===Zg?n=Wn:n===jg||n===qg?n=ql:(n=Wn,s=void 0);const f=n===Wn&&o[a+1].startsWith("/>")?" ":"";r+=n===ql?l+UO:u>=0?(i.push(h),l.slice(0,u)+PE+l.slice(u)+hn+f):l+hn+(u===-2?a:f)}return[LE(o,r+(o[t]||"<?>")+(e===2?"</svg>":"")),i]};class Ah{constructor({strings:e,_$litType$:t},i){let s;this.parts=[];let r=0,n=0;const a=e.length-1,l=this.parts,[h,c]=GO(e,t);if(this.el=Ah.createElement(h,i),ea.currentNode=this.el.content,t===2){const u=this.el.content.firstChild;u.replaceWith(...u.childNodes)}for(;(s=ea.nextNode())!==null&&l.length<a;){if(s.nodeType===1){if(s.hasAttributes())for(const u of s.getAttributeNames())if(u.endsWith(PE)){const d=c[n++],f=s.getAttribute(u).split(hn),p=/([.?@])?(.*)/.exec(d);l.push({type:1,index:r,name:p[2],strings:f,ctor:p[1]==="."?HO:p[1]==="?"?WO:p[1]==="@"?XO:hu}),s.removeAttribute(u)}else u.startsWith(hn)&&(l.push({type:6,index:r}),s.removeAttribute(u));if(NE.test(s.tagName)){const u=s.textContent.split(hn),d=u.length-1;if(d>0){s.textContent=Vc?Vc.emptyScript:"";for(let f=0;f<d;f++)s.append(u[f],Th()),ea.nextNode(),l.push({type:2,index:++r});s.append(u[d],Th())}}}else if(s.nodeType===8)if(s.data===DE)l.push({type:2,index:r});else{let u=-1;for(;(u=s.data.indexOf(hn,u+1))!==-1;)l.push({type:7,index:r}),u+=hn.length-1}r++}}static createElement(e,t){const i=ca.createElement("template");return i.innerHTML=e,i}}function Tl(o,e,t=o,i){var n,a;if(e===El)return e;let s=i!==void 0?(n=t._$Co)==null?void 0:n[i]:t._$Cl;const r=vh(e)?void 0:e._$litDirective$;return(s==null?void 0:s.constructor)!==r&&((a=s==null?void 0:s._$AO)==null||a.call(s,!1),r===void 0?s=void 0:(s=new r(o),s._$AT(o,t,i)),i!==void 0?(t._$Co??(t._$Co=[]))[i]=s:t._$Cl=s),s!==void 0&&(e=Tl(o,s._$AS(o,e.values),s,i)),e}class zO{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){const{el:{content:t},parts:i}=this._$AD,s=((e==null?void 0:e.creationScope)??ca).importNode(t,!0);ea.currentNode=s;let r=ea.nextNode(),n=0,a=0,l=i[0];for(;l!==void 0;){if(n===l.index){let h;l.type===2?h=new Kh(r,r.nextSibling,this,e):l.type===1?h=new l.ctor(r,l.name,l.strings,this,e):l.type===6&&(h=new YO(r,this,e)),this._$AV.push(h),l=i[++a]}n!==(l==null?void 0:l.index)&&(r=ea.nextNode(),n++)}return ea.currentNode=ca,s}p(e){let t=0;for(const i of this._$AV)i!==void 0&&(i.strings!==void 0?(i._$AI(e,i,t),t+=i.strings.length-2):i._$AI(e[t])),t++}}class Kh{get _$AU(){var e;return((e=this._$AM)==null?void 0:e._$AU)??this._$Cv}constructor(e,t,i,s){this.type=2,this._$AH=Gi,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=i,this.options=s,this._$Cv=(s==null?void 0:s.isConnected)??!0}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return t!==void 0&&(e==null?void 0:e.nodeType)===11&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=Tl(this,e,t),vh(e)?e===Gi||e==null||e===""?(this._$AH!==Gi&&this._$AR(),this._$AH=Gi):e!==this._$AH&&e!==El&&this._(e):e._$litType$!==void 0?this.g(e):e.nodeType!==void 0?this.$(e):kO(e)?this.T(e):this._(e)}k(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}$(e){this._$AH!==e&&(this._$AR(),this._$AH=this.k(e))}_(e){this._$AH!==Gi&&vh(this._$AH)?this._$AA.nextSibling.data=e:this.$(ca.createTextNode(e)),this._$AH=e}g(e){var r;const{values:t,_$litType$:i}=e,s=typeof i=="number"?this._$AC(e):(i.el===void 0&&(i.el=Ah.createElement(LE(i.h,i.h[0]),this.options)),i);if(((r=this._$AH)==null?void 0:r._$AD)===s)this._$AH.p(t);else{const n=new zO(s,this),a=n.u(this.options);n.p(t),this.$(a),this._$AH=n}}_$AC(e){let t=Jg.get(e.strings);return t===void 0&&Jg.set(e.strings,t=new Ah(e)),t}T(e){OE(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let i,s=0;for(const r of e)s===t.length?t.push(i=new Kh(this.k(Th()),this.k(Th()),this,this.options)):i=t[s],i._$AI(r),s++;s<t.length&&(this._$AR(i&&i._$AB.nextSibling,s),t.length=s)}_$AR(e=this._$AA.nextSibling,t){var i;for((i=this._$AP)==null?void 0:i.call(this,!1,!0,t);e&&e!==this._$AB;){const s=e.nextSibling;e.remove(),e=s}}setConnected(e){var t;this._$AM===void 0&&(this._$Cv=e,(t=this._$AP)==null||t.call(this,e))}}class hu{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(e,t,i,s,r){this.type=1,this._$AH=Gi,this._$AN=void 0,this.element=e,this.name=t,this._$AM=s,this.options=r,i.length>2||i[0]!==""||i[1]!==""?(this._$AH=Array(i.length-1).fill(new String),this.strings=i):this._$AH=Gi}_$AI(e,t=this,i,s){const r=this.strings;let n=!1;if(r===void 0)e=Tl(this,e,t,0),n=!vh(e)||e!==this._$AH&&e!==El,n&&(this._$AH=e);else{const a=e;let l,h;for(e=r[0],l=0;l<r.length-1;l++)h=Tl(this,a[i+l],t,l),h===El&&(h=this._$AH[l]),n||(n=!vh(h)||h!==this._$AH[l]),h===Gi?e=Gi:e!==Gi&&(e+=(h??"")+r[l+1]),this._$AH[l]=h}n&&!s&&this.O(e)}O(e){e===Gi?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"")}}class HO extends hu{constructor(){super(...arguments),this.type=3}O(e){this.element[this.name]=e===Gi?void 0:e}}class WO extends hu{constructor(){super(...arguments),this.type=4}O(e){this.element.toggleAttribute(this.name,!!e&&e!==Gi)}}class XO extends hu{constructor(e,t,i,s,r){super(e,t,i,s,r),this.type=5}_$AI(e,t=this){if((e=Tl(this,e,t,0)??Gi)===El)return;const i=this._$AH,s=e===Gi&&i!==Gi||e.capture!==i.capture||e.once!==i.once||e.passive!==i.passive,r=e!==Gi&&(i===Gi||s);s&&this.element.removeEventListener(this.name,this,i),r&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){var t;typeof this._$AH=="function"?this._$AH.call(((t=this.options)==null?void 0:t.host)??this.element,e):this._$AH.handleEvent(e)}}class YO{constructor(e,t,i){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=i}get _$AU(){return this._$AM._$AU}_$AI(e){Tl(this,e)}}const _d=hh.litHtmlPolyfillSupport;_d==null||_d(Ah,Kh),(hh.litHtmlVersions??(hh.litHtmlVersions=[])).push("3.1.0");const KO=(o,e,t)=>{const i=(t==null?void 0:t.renderBefore)??e;let s=i._$litPart$;if(s===void 0){const r=(t==null?void 0:t.renderBefore)??null;i._$litPart$=s=new Kh(e.insertBefore(Th(),r),r,void 0,t??{})}return s._$AI(o),s};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */class ch extends Ga{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){var t;const e=super.createRenderRoot();return(t=this.renderOptions).renderBefore??(t.renderBefore=e.firstChild),e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=KO(t,this.renderRoot,this.renderOptions)}connectedCallback(){var e;super.connectedCallback(),(e=this._$Do)==null||e.setConnected(!0)}disconnectedCallback(){var e;super.disconnectedCallback(),(e=this._$Do)==null||e.setConnected(!1)}render(){return El}}var _m;ch._$litElement$=!0,ch.finalized=!0,(_m=globalThis.litElementHydrateSupport)==null||_m.call(globalThis,{LitElement:ch});const pd=globalThis.litElementPolyfillSupport;pd==null||pd({LitElement:ch});(globalThis.litElementVersions??(globalThis.litElementVersions=[])).push("4.0.2");class UU{constructor(e,t,i=!1){this.host=e,this._onChange=t,this._skipRequestUpdate=i,this._mob=null,this.host.addController(this)}hostConnected(){var e;this._mob=new MutationObserver(t=>{t.forEach(i=>{var a;const{type:s,attributeName:r,oldValue:n}=i;s==="attributes"&&r&&(this._skipRequestUpdate||this.host.requestUpdate(r,n),(a=this._onChange)==null||a.call(this,r,n))})}),this._mob.observe(this.host,{attributes:!0,attributeOldValue:!0});for(const t of Array.from(this.host.attributes))this.host.requestUpdate(t.name),(e=this._onChange)==null||e.call(this,t.name,null)}hostDisconnected(){this._mob&&(this._mob.disconnect(),this._mob=null)}}function Wf(o){const e=o.height||2;let t=o.diameterTop===0?0:o.diameterTop||o.diameter||1,i=o.diameterBottom===0?0:o.diameterBottom||o.diameter||1;t=t||1e-5,i=i||1e-5;const s=(o.tessellation||24)|0,r=(o.subdivisions||1)|0,n=!!o.hasRings,a=!!o.enclose,l=o.cap===0?0:o.cap||re.CAP_ALL,h=o.arc&&(o.arc<=0||o.arc>1)?1:o.arc||1,c=o.sideOrientation===0?0:o.sideOrientation||fe.DEFAULTSIDE,u=o.faceUV||new Array(3),d=o.faceColors,f=h!==1&&a?2:0,p=n?r:1,_=2+(1+f)*p;let g;for(g=0;g<_;g++)d&&d[g]===void 0&&(d[g]=new He(1,1,1,1));for(g=0;g<_;g++)u&&u[g]===void 0&&(u[g]=new ut(0,0,1,1));const E=[],R=[],x=[],S=[],b=[],y=Math.PI*2*h/s;let I,O,N;const w=(i-t)/2/e,G=m.Zero(),k=m.Zero(),de=m.Zero(),ae=m.Zero(),_e=m.Zero(),Ce=En.Y;let ce,ze,We,nt=1,ne=1,Ue=0,Je=0;for(ce=0;ce<=r;ce++)for(O=ce/r,N=(O*(t-i)+i)/2,nt=n&&ce!==0&&ce!==r?2:1,We=0;We<nt;We++){for(n&&(ne+=We),a&&(ne+=2*We),ze=0;ze<=s;ze++)I=ze*y,G.x=Math.cos(-I)*N,G.y=-e/2+O*e,G.z=Math.sin(-I)*N,t===0&&ce===r?(k.x=x[x.length-(s+1)*3],k.y=x[x.length-(s+1)*3+1],k.z=x[x.length-(s+1)*3+2]):(k.x=G.x,k.z=G.z,k.y=Math.sqrt(k.x*k.x+k.z*k.z)*w,k.normalize()),ze===0&&(de.copyFrom(G),ae.copyFrom(k)),R.push(G.x,G.y,G.z),x.push(k.x,k.y,k.z),n?Je=Ue!==ne?u[ne].y:u[ne].w:Je=u[ne].y+(u[ne].w-u[ne].y)*O,S.push(u[ne].x+(u[ne].z-u[ne].x)*ze/s,Dt.UseOpenGLOrientationForUV?1-Je:Je),d&&b.push(d[ne].r,d[ne].g,d[ne].b,d[ne].a);h!==1&&a&&(R.push(G.x,G.y,G.z),R.push(0,G.y,0),R.push(0,G.y,0),R.push(de.x,de.y,de.z),m.CrossToRef(Ce,k,_e),_e.normalize(),x.push(_e.x,_e.y,_e.z,_e.x,_e.y,_e.z),m.CrossToRef(ae,Ce,_e),_e.normalize(),x.push(_e.x,_e.y,_e.z,_e.x,_e.y,_e.z),n?Je=Ue!==ne?u[ne+1].y:u[ne+1].w:Je=u[ne+1].y+(u[ne+1].w-u[ne+1].y)*O,S.push(u[ne+1].x,Dt.UseOpenGLOrientationForUV?1-Je:Je),S.push(u[ne+1].z,Dt.UseOpenGLOrientationForUV?1-Je:Je),n?Je=Ue!==ne?u[ne+2].y:u[ne+2].w:Je=u[ne+2].y+(u[ne+2].w-u[ne+2].y)*O,S.push(u[ne+2].x,Dt.UseOpenGLOrientationForUV?1-Je:Je),S.push(u[ne+2].z,Dt.UseOpenGLOrientationForUV?1-Je:Je),d&&(b.push(d[ne+1].r,d[ne+1].g,d[ne+1].b,d[ne+1].a),b.push(d[ne+1].r,d[ne+1].g,d[ne+1].b,d[ne+1].a),b.push(d[ne+2].r,d[ne+2].g,d[ne+2].b,d[ne+2].a),b.push(d[ne+2].r,d[ne+2].g,d[ne+2].b,d[ne+2].a))),Ue!==ne&&(Ue=ne)}const St=h!==1&&a?s+4:s;for(ce=0,ne=0;ne<r;ne++){let he=0,Ne=0,Qe=0,Me=0;for(ze=0;ze<s;ze++)he=ce*(St+1)+ze,Ne=(ce+1)*(St+1)+ze,Qe=ce*(St+1)+(ze+1),Me=(ce+1)*(St+1)+(ze+1),E.push(he,Ne,Qe),E.push(Me,Qe,Ne);h!==1&&a&&(E.push(he+2,Ne+2,Qe+2),E.push(Me+2,Qe+2,Ne+2),E.push(he+4,Ne+4,Qe+4),E.push(Me+4,Qe+4,Ne+4)),ce=n?ce+2:ce+1}const yt=he=>{const Ne=he?t/2:i/2;if(Ne===0)return;let Qe,Me,at;const zt=he?u[_-1]:u[0];let Ht=null;d&&(Ht=he?d[_-1]:d[0]);const ti=R.length/3,Ci=he?e/2:-e/2,ui=new m(0,Ci,0);R.push(ui.x,ui.y,ui.z),x.push(0,he?1:-1,0);const _s=zt.y+(zt.w-zt.y)*.5;S.push(zt.x+(zt.z-zt.x)*.5,Dt.UseOpenGLOrientationForUV?1-_s:_s),Ht&&b.push(Ht.r,Ht.g,Ht.b,Ht.a);const Zi=new Ke(.5,.5);for(at=0;at<=s;at++){Qe=Math.PI*2*at*h/s;const Jr=Math.cos(-Qe),Sr=Math.sin(-Qe);Me=new m(Jr*Ne,Ci,Sr*Ne);const yr=new Ke(Jr*Zi.x+.5,Sr*Zi.y+.5);R.push(Me.x,Me.y,Me.z),x.push(0,he?1:-1,0);const Cr=zt.y+(zt.w-zt.y)*yr.y;S.push(zt.x+(zt.z-zt.x)*yr.x,Dt.UseOpenGLOrientationForUV?1-Cr:Cr),Ht&&b.push(Ht.r,Ht.g,Ht.b,Ht.a)}for(at=0;at<s;at++)he?(E.push(ti),E.push(ti+(at+2)),E.push(ti+(at+1))):(E.push(ti),E.push(ti+(at+1)),E.push(ti+(at+2)))};(l===re.CAP_START||l===re.CAP_ALL)&&yt(!1),(l===re.CAP_END||l===re.CAP_ALL)&&yt(!0),fe._ComputeSides(c,R,E,x,S,o.frontUVs,o.backUVs);const tt=new fe;return tt.indices=E,tt.positions=R,tt.normals=x,tt.uvs=S,d&&(tt.colors=b),tt}function ua(o,e={},t){const i=new re(o,t);return e.sideOrientation=re._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Wf(e).applyToMesh(i,e.updatable),i}fe.CreateCylinder=Wf;re.CreateCylinder=(o,e,t,i,s,r,n,a,l)=>((n===void 0||!(n instanceof Ve))&&(n!==void 0&&(l=a||re.DEFAULTSIDE,a=n),n=r,r=1),ua(o,{height:e,diameterTop:t,diameterBottom:i,tessellation:s,subdivisions:r,sideOrientation:l,updatable:a},n));class lt{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new lt(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const s=lt._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),r=lt._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let n=0,a=Number.MAX_VALUE,l,h,c,u;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>r.x)return!1}else if(l=1/this.direction.x,h=(s.x-this.origin.x)*l,c=(r.x-this.origin.x)*l,c===-1/0&&(c=1/0),h>c&&(u=h,h=c,c=u),n=Math.max(h,n),a=Math.min(c,a),n>a)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>r.y)return!1}else if(l=1/this.direction.y,h=(s.y-this.origin.y)*l,c=(r.y-this.origin.y)*l,c===-1/0&&(c=1/0),h>c&&(u=h,h=c,c=u),n=Math.max(h,n),a=Math.min(c,a),n>a)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>r.z)return!1}else if(l=1/this.direction.z,h=(s.z-this.origin.z)*l,c=(r.z-this.origin.z)*l,c===-1/0&&(c=1/0),h>c&&(u=h,h=c,c=u),n=Math.max(h,n),a=Math.min(c,a),n>a)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,s=e.center.y-this.origin.y,r=e.center.z-this.origin.z,n=i*i+s*s+r*r,a=e.radius+t,l=a*a;if(n<=l)return!0;const h=i*this.direction.x+s*this.direction.y+r*this.direction.z;return h<0?!1:n-h*h<=l}intersectsTriangle(e,t,i){const s=lt._TmpVector3[0],r=lt._TmpVector3[1],n=lt._TmpVector3[2],a=lt._TmpVector3[3],l=lt._TmpVector3[4];t.subtractToRef(e,s),i.subtractToRef(e,r),m.CrossToRef(this.direction,r,n);const h=m.Dot(s,n);if(h===0)return null;const c=1/h;this.origin.subtractToRef(e,a);const u=m.Dot(a,n)*c;if(u<0||u>1)return null;m.CrossToRef(a,s,l);const d=m.Dot(this.direction,l)*c;if(d<0||u+d>1)return null;const f=m.Dot(r,l)*c;return f>this.length?null:new Cd(1-u-d,u,f)}intersectsPlane(e){let t;const i=m.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const s=m.Dot(e.normal,this.origin);return t=(-e.d-s)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new m(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new m(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new m(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,s=!1,r,n=!1){const a=D.Matrix[0];return e.getWorldMatrix().invertToRef(a),this._tmpRay?lt.TransformToRef(this,a,this._tmpRay):this._tmpRay=lt.Transform(this,a),e.intersects(this._tmpRay,t,i,s,r,n)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let s=0;s<e.length;s++){const r=this.intersectsMesh(e[s],t);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const s=this.origin,r=D.Vector3[0],n=D.Vector3[1],a=D.Vector3[2],l=D.Vector3[3];t.subtractToRef(e,r),this.direction.scaleToRef(lt._Rayl,a),s.addToRef(a,n),e.subtractToRef(s,l);const h=m.Dot(r,r),c=m.Dot(r,a),u=m.Dot(a,a),d=m.Dot(r,l),f=m.Dot(a,l),p=h*u-c*c;let _,g=p,E,R=p;p<lt._Smallnum?(_=0,g=1,E=f,R=u):(_=c*f-u*d,E=h*f-c*d,_<0?(_=0,E=f,R=u):_>g&&(_=g,E=f+c,R=u)),E<0?(E=0,-d<0?_=0:-d>h?_=g:(_=-d,g=h)):E>R&&(E=R,-d+c<0?_=0:-d+c>h?_=g:(_=-d+c,g=h));const x=Math.abs(_)<lt._Smallnum?0:_/g,S=Math.abs(E)<lt._Smallnum?0:E/R,b=D.Vector3[4];a.scaleToRef(S,b);const y=D.Vector3[5];r.scaleToRef(x,y),y.addInPlace(l);const I=D.Vector3[6];return y.subtractToRef(b,I),S>0&&S<=this.length&&I.lengthSquared()<i*i?y.length():-1}update(e,t,i,s,r,n,a,l=!1){if(l){lt._RayDistant||(lt._RayDistant=lt.Zero()),lt._RayDistant.unprojectRayToRef(e,t,i,s,L.IdentityReadOnly,n,a);const h=D.Matrix[0];r.invertToRef(h),lt.TransformToRef(lt._RayDistant,h,this)}else this.unprojectRayToRef(e,t,i,s,r,n,a);return this}static Zero(){return new lt(m.Zero(),m.Zero())}static CreateNew(e,t,i,s,r,n,a){return lt.Zero().update(e,t,i,s,r,n,a)}static CreateNewFromTo(e,t,i=L.IdentityReadOnly){const s=t.subtract(e),r=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),lt.Transform(new lt(e,s,r),i)}static Transform(e,t){const i=new lt(new m(0,0,0),new m(0,0,0));return lt.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){m.TransformCoordinatesToRef(e.origin,t,i.origin),m.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const s=i.direction,r=s.length();if(!(r===0||r===1)){const n=1/r;s.x*=n,s.y*=n,s.z*=n,i.length*=r}}unprojectRayToRef(e,t,i,s,r,n,a){const l=D.Matrix[0];r.multiplyToRef(n,l),l.multiplyToRef(a,l),l.invert();const h=Ze.LastCreatedEngine,c=D.Vector3[0];c.x=e/i*2-1,c.y=-(t/s*2-1),c.z=h!=null&&h.useReverseDepthBuffer?1:h!=null&&h.isNDCHalfZRange?0:-1;const u=D.Vector3[1].copyFromFloats(c.x,c.y,1-1e-8),d=D.Vector3[2],f=D.Vector3[3];m._UnprojectFromInvertedMatrixToRef(c,l,d),m._UnprojectFromInvertedMatrixToRef(u,l,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}lt._TmpVector3=yi.BuildArray(6,m.Zero);lt._RayDistant=lt.Zero();lt._Smallnum=1e-8;lt._Rayl=1e9;Ve.prototype.createPickingRay=function(o,e,t,i,s=!1){const r=lt.Zero();return this.createPickingRayToRef(o,e,t,r,i,s),r};Ve.prototype.createPickingRayToRef=function(o,e,t,i,s,r=!1,n=!1){const a=this.getEngine();if(!s&&!(s=this.activeCamera))return this;const l=s.viewport,h=a.getRenderHeight(),{x:c,y:u,width:d,height:f}=l.toGlobal(a.getRenderWidth(),h),p=1/a.getHardwareScalingLevel();return o=o*p-c,e=e*p-(h-u-f),i.update(o,e,d,f,t||L.IdentityReadOnly,r?L.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),n),this};Ve.prototype.createPickingRayInCameraSpace=function(o,e,t){const i=lt.Zero();return this.createPickingRayInCameraSpaceToRef(o,e,i,t),i};Ve.prototype.createPickingRayInCameraSpaceToRef=function(o,e,t,i){if(!pr)return this;const s=this.getEngine();if(!i&&!(i=this.activeCamera))throw new Error("Active camera not set");const r=i.viewport,n=s.getRenderHeight(),{x:a,y:l,width:h,height:c}=r.toGlobal(s.getRenderWidth(),n),u=L.Identity(),d=1/s.getHardwareScalingLevel();return o=o*d-a,e=e*d-(n-l-c),t.update(o,e,h,c,u,u,i.getProjectionMatrix()),this};Ve.prototype._internalPickForMesh=function(o,e,t,i,s,r,n,a){const l=e(i,t.enableDistantPicking),h=t.intersects(l,s,n,r,i,a);return!h||!h.hit||!s&&o!=null&&h.distance>=o.distance?null:h};Ve.prototype._internalPick=function(o,e,t,i,s){let r=null;const n=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){const h=this.meshes[l];if(e){if(!e(h))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;const c=n&&h.isWorldMatrixCameraDependent(),u=h.computeWorldMatrix(c,a);if(h.hasThinInstances&&h.thinInstanceEnablePicking){const d=this._internalPickForMesh(r,o,h,u,!0,!0,s);if(d){if(i)return d;const f=D.Matrix[1],p=h.thinInstanceGetWorldMatrices();for(let _=0;_<p.length;_++){p[_].multiplyToRef(u,f);const E=this._internalPickForMesh(r,o,h,f,t,i,s,!0);if(E&&(r=E,r.thinInstanceIndex=_,t))return r}}}else{const d=this._internalPickForMesh(r,o,h,u,t,i,s);if(d&&(r=d,t))return r}}return r||new pr};Ve.prototype._internalMultiPick=function(o,e,t){if(!pr)return null;const i=[],s=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),r=this.cameraToUseForPointers||this.activeCamera;for(let n=0;n<this.meshes.length;n++){const a=this.meshes[n];if(e){if(!e(a))continue}else if(!a.isEnabled()||!a.isVisible||!a.isPickable)continue;const l=s&&a.isWorldMatrixCameraDependent(),h=a.computeWorldMatrix(l,r);if(a.hasThinInstances&&a.thinInstanceEnablePicking){if(this._internalPickForMesh(null,o,a,h,!0,!0,t)){const u=D.Matrix[1],d=a.thinInstanceGetWorldMatrices();for(let f=0;f<d.length;f++){d[f].multiplyToRef(h,u);const _=this._internalPickForMesh(null,o,a,u,!1,!1,t,!0);_&&(_.thinInstanceIndex=f,i.push(_))}}}else{const c=this._internalPickForMesh(null,o,a,h,!1,!1,t);c&&i.push(c)}}return i};Ve.prototype.pickWithBoundingInfo=function(o,e,t,i,s){if(!pr)return null;const r=this._internalPick(n=>(this._tempPickingRay||(this._tempPickingRay=lt.Zero()),this.createPickingRayToRef(o,e,n,this._tempPickingRay,s||null),this._tempPickingRay),t,i,!0);return r&&(r.ray=this.createPickingRay(o,e,L.Identity(),s||null)),r};Object.defineProperty(Ve.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1});Ve.prototype.pick=function(o,e,t,i,s,r,n=!1){const a=this._internalPick((l,h)=>(this._tempPickingRay||(this._tempPickingRay=lt.Zero()),this.createPickingRayToRef(o,e,l,this._tempPickingRay,s||null,!1,h),this._tempPickingRay),t,i,!1,r);return a&&(a.ray=this.createPickingRay(o,e,L.Identity(),s||null)),a};Ve.prototype.pickWithRay=function(o,e,t,i){const s=this._internalPick(r=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=L.Identity()),r.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=lt.Zero()),lt.TransformToRef(o,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return s&&(s.ray=o),s};Ve.prototype.multiPick=function(o,e,t,i,s){return this._internalMultiPick(r=>this.createPickingRay(o,e,r,i||null),t,s)};Ve.prototype.multiPickWithRay=function(o,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=L.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=lt.Zero()),lt.TransformToRef(o,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)};De.prototype.getForwardRay=function(o=100,e,t){return this.getForwardRayToRef(new lt(m.Zero(),m.Zero(),o),o,e,t)};De.prototype.getForwardRayToRef=function(o,e=100,t,i){t||(t=this.getWorldMatrix()),o.length=e,i?o.origin.copyFrom(i):o.origin.copyFrom(this.position);const s=D.Vector3[2];s.set(0,0,this._scene.useRightHandedSystem?-1:1);const r=D.Vector3[3];return m.TransformNormalToRef(s,t,r),m.NormalizeToRef(r,o.direction),o};class It{static _RemoveAndStorePivotPoint(e){e&&It._PivotCached===0&&(e.getPivotPointToRef(It._OldPivotPoint),It._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,It._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(L.IdentityReadOnly),It._OldPivotPoint.subtractToRef(e.getPivotPoint(),It._PivotTranslation),It._PivotTmpVector.copyFromFloats(1,1,1),It._PivotTmpVector.subtractInPlace(e.scaling),It._PivotTmpVector.multiplyInPlace(It._PivotTranslation),e.position.addInPlace(It._PivotTmpVector))),It._PivotCached++}static _RestorePivotPoint(e){e&&!It._OldPivotPoint.equalsToFloats(0,0,0)&&It._PivotCached===1&&(e.setPivotPoint(It._OldPivotPoint),e._postMultiplyPivotMatrix=It._PivotPostMultiplyPivotMatrix,It._PivotTmpVector.copyFromFloats(1,1,1),It._PivotTmpVector.subtractInPlace(e.scaling),It._PivotTmpVector.multiplyInPlace(It._PivotTranslation),e.position.subtractInPlace(It._PivotTmpVector)),this._PivotCached--}}It._PivotCached=0;It._OldPivotPoint=new m;It._PivotTranslation=new m;It._PivotTmpVector=new m;It._PivotPostMultiplyPivotMatrix=!1;function Xf(o){const e=[],t=[],i=[],s=[],r=o.width||o.size||1,n=o.height||o.size||1,a=o.sideOrientation===0?0:o.sideOrientation||fe.DEFAULTSIDE,l=r/2,h=n/2;t.push(-l,-h,0),i.push(0,0,-1),s.push(0,Dt.UseOpenGLOrientationForUV?1:0),t.push(l,-h,0),i.push(0,0,-1),s.push(1,Dt.UseOpenGLOrientationForUV?1:0),t.push(l,h,0),i.push(0,0,-1),s.push(1,Dt.UseOpenGLOrientationForUV?0:1),t.push(-l,h,0),i.push(0,0,-1),s.push(0,Dt.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),fe._ComputeSides(a,t,e,i,s,o.frontUVs,o.backUVs);const c=new fe;return c.indices=e,c.positions=t,c.normals=i,c.uvs=s,c}function $h(o,e={},t=null){const i=new re(o,t);return e.sideOrientation=re._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Xf(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}fe.CreatePlane=Xf;re.CreatePlane=(o,e,t,i,s)=>$h(o,{size:e,width:e,height:e,sideOrientation:s,updatable:i},t);class Xi{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}set enabled(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e}get enabled(){return this._enabled}get options(){return this._options}set options(e){this._options=e}constructor(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new j,this.onDragStartObservable=new j,this.onDragEndObservable=new j,this.onEnabledObservable=new j,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=i=>!0,this._tmpVector=new m(0,0,0),this._alternatePickedPoint=new m(0,0,0),this._worldDragAxis=new m(0,0,0),this._targetPosition=new m(0,0,0),this._attachedToElement=!1,this._startDragRay=new lt(new m,new m),this._lastPointerRay={},this._dragDelta=new m,this._pointA=new m(0,0,0),this._pointC=new m(0,0,0),this._localAxis=new m(0,0,0),this._lookAt=new m(0,0,0),this._options=e||{};let t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(e,t){this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,Xi._PlaneScene||(this._debugMode?Xi._PlaneScene=this._scene:(Xi._PlaneScene=new Ve(this._scene.getEngine(),{virtual:!0}),Xi._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce(()=>{Xi._PlaneScene.dispose(),Xi._PlaneScene=null}))),this._dragPlane=$h("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:re.DOUBLESIDE},Xi._PlaneScene),this.lastDragPosition=new m(0,0,0);const i=t||(s=>this.attachedNode==s||s.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add(s=>{if(!this.enabled){this._attachedToElement&&this.releaseDrag();return}if(s.type==xe.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&s.pickInfo&&s.pickInfo.hit&&s.pickInfo.pickedMesh&&s.pickInfo.pickedPoint&&s.pickInfo.ray&&i(s.pickInfo.pickedMesh)&&this._activeDragButton===-1&&this.dragButtons.indexOf(s.event.button)!==-1&&(this._activeDragButton=s.event.button,this._activePointerInfo=s,this._startDrag(s.event.pointerId,s.pickInfo.ray,s.pickInfo.pickedPoint));else if(s.type==xe.POINTERUP)this.startAndReleaseDragOnPointerEvents&&this.currentDraggingPointerId==s.event.pointerId&&(this._activeDragButton===s.event.button||this._activeDragButton===-1)&&this.releaseDrag();else if(s.type==xe.POINTERMOVE){const r=s.event.pointerId;if(this.currentDraggingPointerId===Xi._AnyMouseId&&r!==Xi._AnyMouseId){const n=s.event;(n.pointerType==="mouse"||!this._scene.getEngine().hostInformation.isMobile&&n instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[r]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=r)}this._lastPointerRay[r]||(this._lastPointerRay[r]=new lt(new m,new m)),s.pickInfo&&s.pickInfo.ray&&(this._lastPointerRay[r].origin.copyFrom(s.pickInfo.ray.origin),this._lastPointerRay[r].direction.copyFrom(s.pickInfo.ray.direction),this.currentDraggingPointerId==r&&this.dragging&&this._moveDrag(s.pickInfo.ray))}}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{if(this._moving&&this.moveAttached){let s=!1;It._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),s=!0),It._RestorePivotPoint(this.attachedNode),s&&this.attachedNode.computeWorldMatrix()}})}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if(this._scene.activeCamera.getClassName()==="ArcRotateCamera"){const e=this._scene.activeCamera;e.attachControl(e.inputs?e.inputs.noPreventDefault:!0,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(this._scene.activeCamera.inputs?this._scene.activeCamera.inputs.noPreventDefault:!0);this._attachedToElement=!1}}startDrag(e=Xi._AnyMouseId,t,i){this._startDrag(e,t,i);let s=this._lastPointerRay[e];e===Xi._AnyMouseId&&(s=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),s&&this._moveDrag(s)}_startDrag(e,t,i){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;It._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,i||this._tmpVector);const s=this._pickWithRayOnDragPlane(this._startDragRay);s?(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(s),this.onDragStartObservable.notifyObservers({dragPlanePoint:s,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),It._RestorePivotPoint(this.attachedNode)}_moveDrag(e){this._moving=!0;const t=this._pickWithRayOnDragPlane(e);if(t){It._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);let i=0;this._options.dragAxis?(this.useObjectOrientationForDragging?m.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),i=m.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(i,this._dragDelta)):(i=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:i,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(t),It._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(e){if(!e)return null;let t=Math.acos(m.Dot(this._dragPlane.forward,e.direction));if(t>Math.PI/2&&(t=Math.PI-t),this.maxDragAngle>0&&t>this.maxDragAngle)if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*m.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);const l=m.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-l,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}else return null;const i=this._dragPlane.forward,s=this._dragPlane.position,r=e.direction.dot(i);if(Math.abs(r)<dt)return null;s.subtractToRef(e.origin,D.Vector3[0]);const n=D.Vector3[0].dot(i)/r;return n<0?null:(e.direction.scaleToRef(n,D.Vector3[0]),e.origin.add(D.Vector3[0]))}_updateDragPlanePosition(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?m.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(m.Dot(this._localAxis,this._pointC))>.999?Math.abs(m.Dot(m.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(m.Right()):this._lookAt.copyFrom(m.UpReadOnly):(m.CrossToRef(this._localAxis,this._pointC,this._lookAt),m.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?m.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(e.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}Xi._AnyMouseId=-2;class ks extends jt{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreateArrow(e,t,i=1,s=!1){const r=new we("arrow",e),n=ua("cylinder",{diameterTop:0,height:.075,diameterBottom:.0375*(1+(i-1)/4),tessellation:96},e),a=ua("cylinder",{diameterTop:.005*i,height:.275,diameterBottom:.005*i,tessellation:96},e);return n.parent=r,n.material=t,n.rotation.x=Math.PI/2,n.position.z+=.3,a.parent=r,a.material=t,a.position.z+=.275/2,a.rotation.x=Math.PI/2,s&&(a.visibility=0,n.visibility=0),r}static _CreateArrowInstance(e,t){const i=new we("arrow",e);for(const s of t.getChildMeshes()){const r=s.createInstance(s.name);r.parent=i}return i}constructor(e,t=J.Gray(),i=Yt.DefaultUtilityLayer,s=null,r=1,n=J.Yellow(),a=J.Gray()){var l;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new j,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._parent=s,this._coloredMaterial=new oe("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new J(.1,.1,.1)),this._hoverMaterial=new oe("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=n,this._disableMaterial=new oe("",i.utilityLayerScene),this._disableMaterial.diffuseColor=a,this._disableMaterial.alpha=.4;const h=ks._CreateArrow(i.utilityLayerScene,this._coloredMaterial,r),c=ks._CreateArrow(i.utilityLayerScene,this._coloredMaterial,r+4,!0);this._gizmoMesh=new re("",i.utilityLayerScene),this._gizmoMesh.addChild(h),this._gizmoMesh.addChild(c),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let u=0;const d={snapDistance:0};this.dragBehavior=new Xi({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add(_=>{if(this.attachedNode){let g=!1;if(this.snapDistance==0)this.attachedNode.getWorldMatrix().getTranslationToRef(D.Vector3[2]),D.Vector3[2].addInPlace(_.delta),this.dragBehavior.validateDrag(D.Vector3[2])&&(this.attachedNode.position&&this.attachedNode.position.addInPlaceFromFloats(_.delta.x,_.delta.y,_.delta.z),this.attachedNode.getWorldMatrix().addTranslationFromFloats(_.delta.x,_.delta.y,_.delta.z),this.attachedNode.updateCache(),g=!0);else if(u+=_.dragDistance,Math.abs(u)>this.snapDistance){const E=Math.floor(Math.abs(u)/this.snapDistance);u=u%this.snapDistance,_.delta.normalizeToRef(D.Vector3[1]),D.Vector3[1].scaleInPlace(this.snapDistance*E),this.attachedNode.getWorldMatrix().getTranslationToRef(D.Vector3[2]),D.Vector3[2].addInPlace(D.Vector3[1]),this.dragBehavior.validateDrag(D.Vector3[2])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(D.Vector3[1].x,D.Vector3[1].y,D.Vector3[1].z),this.attachedNode.updateCache(),d.snapDistance=this.snapDistance*E*Math.sign(u),this.onSnapObservable.notifyObservers(d),g=!0)}g&&this._matrixChanged()}}),this.dragBehavior.onDragStartObservable.add(()=>{this._dragging=!0}),this.dragBehavior.onDragEndObservable.add(()=>{this._dragging=!1});const f=i._getSharedGizmoLight();f.includedOnlyMeshes=f.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const p={gizmoMeshes:h.getChildMeshes(),colliderMeshes:c.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};(l=this._parent)===null||l===void 0||l.addToAxisCache(c,p),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(_=>{var g;if(!this._customMeshSet&&(this._isHovered=p.colliderMeshes.indexOf((g=_==null?void 0:_.pickInfo)===null||g===void 0?void 0:g.pickedMesh)!=-1,!this._parent)){const E=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(p.gizmoMeshes,E)}}),this.dragBehavior.onEnabledObservable.add(_=>{this._setGizmoMeshMaterial(p.gizmoMeshes,_?p.material:p.disableMaterial)})}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()}),super.dispose()}}class za{get scaleLines(){return this._scaleLines}set scaleLines(e){this._scaleLines=e,this._xAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor),this._yAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor),this._zAxis.scaling.setAll(this._scaleLines*this._scaleLinesFactor)}get xAxis(){return this._xAxis}get yAxis(){return this._yAxis}get zAxis(){return this._zAxis}constructor(e,t=1,i=2,s,r,n,a=1){if(this._scaleLinesFactor=4,this._instanced=!1,this.scene=null,this._scaleLines=1,e=e||Ze.LastCreatedScene,!!e){if(!s){const l=new oe("xAxisMaterial",e);l.disableLighting=!0,l.emissiveColor=J.Red().scale(.5),s=ks._CreateArrow(e,l,a)}if(!r){const l=new oe("yAxisMaterial",e);l.disableLighting=!0,l.emissiveColor=J.Green().scale(.5),r=ks._CreateArrow(e,l,a)}if(!n){const l=new oe("zAxisMaterial",e);l.disableLighting=!0,l.emissiveColor=J.Blue().scale(.5),n=ks._CreateArrow(e,l,a)}this._xAxis=s,this._yAxis=r,this._zAxis=n,this.scaleLines=t,i!=null&&(za._SetRenderingGroupId(this._xAxis,i),za._SetRenderingGroupId(this._yAxis,i),za._SetRenderingGroupId(this._zAxis,i)),this.scene=e,this.update(new m,m.Right(),m.Up(),m.Forward())}}update(e,t,i,s){this._xAxis.position.copyFrom(e),this._xAxis.setDirection(t),this._yAxis.position.copyFrom(e),this._yAxis.setDirection(i),this._zAxis.position.copyFrom(e),this._zAxis.setDirection(s)}createInstance(){const e=ks._CreateArrowInstance(this.scene,this._xAxis),t=ks._CreateArrowInstance(this.scene,this._yAxis),i=ks._CreateArrowInstance(this.scene,this._zAxis),s=new za(this.scene,this.scaleLines,null,e,t,i);return s._instanced=!0,s}dispose(){this._xAxis&&this._xAxis.dispose(!1,!this._instanced),this._yAxis&&this._yAxis.dispose(!1,!this._instanced),this._zAxis&&this._zAxis.dispose(!1,!this._instanced),this.scene=null}static _SetRenderingGroupId(e,t){e.getChildMeshes().forEach(i=>{i.renderingGroupId=t})}}function FE(o){const e=[],t=[],i=o.lines,s=o.colors,r=[];let n=0;for(let l=0;l<i.length;l++){const h=i[l];for(let c=0;c<h.length;c++){const{x:u,y:d,z:f}=h[c];if(t.push(u,d,f),s){const p=s[l],{r:_,g,b:E,a:R}=p[c];r.push(_,g,E,R)}c>0&&(e.push(n-1),e.push(n)),n++}}const a=new fe;return a.indices=e,a.positions=t,s&&(a.colors=r),a}function wE(o){const e=o.dashSize||3,t=o.gapSize||1,i=o.dashNb||200,s=o.points,r=[],n=[],a=m.Zero();let l=0,h=0,c=0,u=0,d=0,f=0,p=0;for(p=0;p<s.length-1;p++)s[p+1].subtractToRef(s[p],a),l+=a.length();for(c=l/i,u=e*c/(e+t),p=0;p<s.length-1;p++){s[p+1].subtractToRef(s[p],a),h=Math.floor(a.length()/c),a.normalize();for(let g=0;g<h;g++)d=c*g,r.push(s[p].x+d*a.x,s[p].y+d*a.y,s[p].z+d*a.z),r.push(s[p].x+(d+u)*a.x,s[p].y+(d+u)*a.y,s[p].z+(d+u)*a.z),n.push(f,f+1),f+=2}const _=new fe;return _.positions=r,_.indices=n,_}function $O(o,e,t=null){const i=e.instance,s=e.lines,r=e.colors;if(i){const h=i.getVerticesData(T.PositionKind);let c,u;r&&(c=i.getVerticesData(T.ColorKind));let d=0,f=0;for(let p=0;p<s.length;p++){const _=s[p];for(let g=0;g<_.length;g++)h[d]=_[g].x,h[d+1]=_[g].y,h[d+2]=_[g].z,r&&c&&(u=r[p],c[f]=u[g].r,c[f+1]=u[g].g,c[f+2]=u[g].b,c[f+3]=u[g].a,f+=4),d+=3}return i.updateVerticesData(T.PositionKind,h,!1,!1),r&&c&&i.updateVerticesData(T.ColorKind,c,!1,!1),i}const n=!!r,a=new bn(o,t,null,void 0,void 0,n,e.useVertexAlpha,e.material);return FE(e).applyToMesh(a,e.updatable),a}function qa(o,e,t=null){const i=e.colors?[e.colors]:null;return $O(o,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function jO(o,e,t=null){const i=e.points,s=e.instance,r=e.gapSize||1,n=e.dashSize||3;if(s){const h=c=>{const u=m.Zero(),d=c.length/6;let f=0,p=0,_=0,g=0,E=0,R=0,x=0,S=0;for(x=0;x<i.length-1;x++)i[x+1].subtractToRef(i[x],u),f+=u.length();_=f/d;const b=s._creationDataStorage.dashSize,y=s._creationDataStorage.gapSize;for(g=b*_/(b+y),x=0;x<i.length-1;x++)for(i[x+1].subtractToRef(i[x],u),p=Math.floor(u.length()/_),u.normalize(),S=0;S<p&&R<c.length;)E=_*S,c[R]=i[x].x+E*u.x,c[R+1]=i[x].y+E*u.y,c[R+2]=i[x].z+E*u.z,c[R+3]=i[x].x+(E+g)*u.x,c[R+4]=i[x].y+(E+g)*u.y,c[R+5]=i[x].z+(E+g)*u.z,R+=6,S++;for(;R<c.length;)c[R]=i[x].x,c[R+1]=i[x].y,c[R+2]=i[x].z,R+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&q.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),s.updateMeshPositions(h,!1),s}const a=new bn(o,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return wE(e).applyToMesh(a,e.updatable),a._creationDataStorage=new tS,a._creationDataStorage.dashSize=n,a._creationDataStorage.gapSize=r,a}fe.CreateLineSystem=FE;fe.CreateDashedLines=wE;re.CreateLines=(o,e,t=null,i=!1,s=null)=>qa(o,{points:e,updatable:i,instance:s},t);re.CreateDashedLines=(o,e,t,i,s,r=null,n,a)=>jO(o,{points:e,dashSize:t,gapSize:i,dashNb:s,updatable:n,instance:a},r);class cu{static CreateAndShow(e,t,i){const s=new cu(e);return s.show(t,i),s}constructor(e){this.ray=e}show(e,t){if(!this._renderFunction&&this.ray){const i=this.ray;this._renderFunction=()=>this._render(),this._scene=e,this._renderPoints=[i.origin,i.origin.add(i.direction.scale(i.length))],this._renderLine=qa("ray",{points:this._renderPoints,updatable:!0},e),this._renderLine.isPickable=!1,this._renderFunction&&this._scene.registerBeforeRender(this._renderFunction)}t&&this._renderLine&&this._renderLine.color.copyFrom(t)}hide(){this._renderFunction&&this._scene&&(this._scene.unregisterBeforeRender(this._renderFunction),this._scene=null,this._renderFunction=null,this._renderLine&&(this._renderLine.dispose(),this._renderLine=null),this._renderPoints=[])}_render(){var e;const t=this.ray;if(!t)return;const i=this._renderPoints[1],s=Math.min(t.length,1e6);i.copyFrom(t.direction),i.scaleInPlace(s),i.addInPlace(t.origin),this._renderPoints[0].copyFrom(t.origin),qa("ray",{points:this._renderPoints,updatable:!0,instance:this._renderLine},this._scene),(e=this._renderLine)===null||e===void 0||e.refreshBoundingInfo()}attachToMesh(e,t,i,s){this._attachedToMesh=e;const r=this.ray;r&&(r.direction||(r.direction=m.Zero()),r.origin||(r.origin=m.Zero()),s&&(r.length=s),i||(i=m.Zero()),t||(t=new m(0,0,-1)),this._scene||(this._scene=e.getScene()),this._meshSpaceDirection?(this._meshSpaceDirection.copyFrom(t),this._meshSpaceOrigin.copyFrom(i)):(this._meshSpaceDirection=t.clone(),this._meshSpaceOrigin=i.clone()),this._onAfterRenderObserver||(this._onAfterRenderObserver=this._scene.onBeforeRenderObservable.add(()=>this._updateToMesh()),this._onAfterStepObserver=this._scene.onAfterStepObservable.add(()=>this._updateToMesh())),this._attachedToMesh.computeWorldMatrix(!0),this._updateToMesh())}detachFromMesh(){this._attachedToMesh&&this._scene&&(this._onAfterRenderObserver&&(this._scene.onBeforeRenderObservable.remove(this._onAfterRenderObserver),this._scene.onAfterStepObservable.remove(this._onAfterStepObserver)),this._attachedToMesh=null,this._onAfterRenderObserver=null,this._onAfterStepObserver=null,this._scene=null)}_updateToMesh(){const e=this.ray;if(!(!this._attachedToMesh||!e)){if(this._attachedToMesh.isDisposed()){this.detachFromMesh();return}this._attachedToMesh.getDirectionToRef(this._meshSpaceDirection,e.direction),m.TransformCoordinatesToRef(this._meshSpaceOrigin,this._attachedToMesh.getWorldMatrix(),e.origin)}}dispose(){this.hide(),this.detachFromMesh(),this.ray=null}}function Yf(o){const e=(o.segments||32)|0,t=o.diameterX||o.diameter||1,i=o.diameterY||o.diameter||1,s=o.diameterZ||o.diameter||1,r=o.arc&&(o.arc<=0||o.arc>1)?1:o.arc||1,n=o.slice&&o.slice<=0?1:o.slice||1,a=o.sideOrientation===0?0:o.sideOrientation||fe.DEFAULTSIDE,l=!!o.dedupTopBottomIndices,h=new m(t/2,i/2,s/2),c=2+e,u=2*c,d=[],f=[],p=[],_=[];for(let E=0;E<=c;E++){const R=E/c,x=R*Math.PI*n;for(let S=0;S<=u;S++){const b=S/u,y=b*Math.PI*2*r,I=L.RotationZ(-x),O=L.RotationY(y),N=m.TransformCoordinates(m.Up(),I),w=m.TransformCoordinates(N,O),G=w.multiply(h),k=w.divide(h).normalize();f.push(G.x,G.y,G.z),p.push(k.x,k.y,k.z),_.push(b,Dt.UseOpenGLOrientationForUV?1-R:R)}if(E>0){const S=f.length/3;for(let b=S-2*(u+1);b+u+2<S;b++)l?(E>1&&(d.push(b),d.push(b+1),d.push(b+u+1)),(E<c||n<1)&&(d.push(b+u+1),d.push(b+1),d.push(b+u+2))):(d.push(b),d.push(b+1),d.push(b+u+1),d.push(b+u+1),d.push(b+1),d.push(b+u+2))}}fe._ComputeSides(a,f,d,p,_,o.frontUVs,o.backUVs);const g=new fe;return g.indices=d,g.positions=f,g.normals=p,g.uvs=_,g}function uh(o,e={},t=null){const i=new re(o,t);return e.sideOrientation=re._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Yf(e).applyToMesh(i,e.updatable),i}fe.CreateSphere=Yf;re.CreateSphere=(o,e,t,i,s,r)=>uh(o,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:r,updatable:s},i);function Kf(o){const e=[],t=[],i=[],s=[],r=o.radius||.5,n=o.tessellation||64,a=o.arc&&(o.arc<=0||o.arc>1)?1:o.arc||1,l=o.sideOrientation===0?0:o.sideOrientation||fe.DEFAULTSIDE;e.push(0,0,0),s.push(.5,.5);const h=Math.PI*2*a,c=a===1?h/n:h/(n-1);let u=0;for(let p=0;p<n;p++){const _=Math.cos(u),g=Math.sin(u),E=(_+1)/2,R=(1-g)/2;e.push(r*_,r*g,0),s.push(E,Dt.UseOpenGLOrientationForUV?1-R:R),u+=c}a===1&&(e.push(e[3],e[4],e[5]),s.push(s[2],Dt.UseOpenGLOrientationForUV?1-s[3]:s[3]));const d=e.length/3;for(let p=1;p<d-1;p++)t.push(p+1,0,p);fe.ComputeNormals(e,t,i),fe._ComputeSides(l,e,t,i,s,o.frontUVs,o.backUVs);const f=new fe;return f.indices=t,f.positions=e,f.normals=i,f.uvs=s,f}function BE(o,e={},t=null){const i=new re(o,t);return e.sideOrientation=re._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Kf(e).applyToMesh(i,e.updatable),i}fe.CreateDisc=Kf;re.CreateDisc=(o,e,t,i=null,s,r)=>BE(o,{radius:e,tessellation:t,sideOrientation:r,updatable:s},i);function mf(o,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);const i=uh("",{slice:.5,diameter:e.diameter,segments:e.segments},t),s=BE("",{radius:e.diameter/2,tessellation:e.segments*3+(4-e.segments)},t);s.rotation.x=-Math.PI/2,s.parent=i;const r=re.MergeMeshes([s,i],!0);return r.name=o,r}re.CreateHemisphere=(o,e,t,i)=>mf(o,{segments:e,diameter:t},i);class ws extends jt{constructor(e=Yt.DefaultUtilityLayer){super(e),this._cachedPosition=new m,this._cachedForward=new m(0,0,1),this._pointerObserver=null,this.onClickedObservable=new j,this._light=null,this.attachedMesh=new pi("",this.gizmoLayer.utilityLayerScene),this._attachedMeshParent=new we("parent",this.gizmoLayer.utilityLayerScene),this.attachedMesh.parent=this._attachedMeshParent,this._material=new oe("light",this.gizmoLayer.utilityLayerScene),this._material.diffuseColor=new J(.5,.5,.5),this._material.specularColor=new J(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add(t=>{this._light&&(this._isHovered=!!(t.pickInfo&&this._rootMesh.getChildMeshes().indexOf(t.pickInfo.pickedMesh)!=-1),this._isHovered&&t.event.button===0&&this.onClickedObservable.notifyObservers(this._light))},xe.POINTERDOWN)}get attachedNode(){return this.attachedMesh}set attachedNode(e){q.Warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")}set light(e){if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof Dn?this._lightMesh=ws._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof bs?this._lightMesh=ws._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof es?this._lightMesh=ws._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=ws._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach(i=>{i.material=this._material}),this._lightMesh.parent=this._rootMesh;const t=this.gizmoLayer._getSharedGizmoLight();if(t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new le,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction){this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0);const i=this._getMeshForward();this._cachedForward.copyFrom(i)}this._update()}}get light(){return this._light}get material(){return this._material}_getMeshForward(){let e=this.attachedMesh.forward;return this.attachedMesh.getScene().useRightHandedSystem&&(e.negateToRef(D.Vector3[0]),e=D.Vector3[0]),e}_update(){if(super._update(),!!this._light){if(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position)if(this.attachedMesh.position.equals(this._cachedPosition))this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position);else{const e=this.attachedMesh.position;this._light.position=new m(e.x,e.y,e.z),this._cachedPosition.copyFrom(this.attachedMesh.position)}if(this._light.direction){const e=this._getMeshForward();if(m.DistanceSquared(e,this._cachedForward)>1e-4){const t=e;this._light.direction=new m(t.x,t.y,t.z),this._cachedForward.copyFrom(e)}else m.DistanceSquared(e,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(e))}}}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),super.dispose(),this._attachedMeshParent.dispose()}static _CreateHemisphericLightMesh(e){const t=new re("hemisphereLight",e),i=mf(t.name,{segments:10,diameter:1},e);i.position.z=-.15,i.rotation.x=Math.PI/2,i.parent=t;const s=this._CreateLightLines(3,e);return s.parent=t,t.scaling.scaleInPlace(ws._Scale),t.rotation.x=Math.PI/2,t}static _CreatePointLightMesh(e){const t=new re("pointLight",e),i=uh(t.name,{segments:10,diameter:1},e);i.rotation.x=Math.PI/2,i.parent=t;const s=this._CreateLightLines(5,e);return s.parent=t,t.scaling.scaleInPlace(ws._Scale),t.rotation.x=Math.PI/2,t}static _CreateSpotLightMesh(e){const t=new re("spotLight",e),i=uh(t.name,{segments:10,diameter:1},e);i.parent=t;const s=mf(t.name,{segments:10,diameter:2},e);s.parent=t,s.rotation.x=-Math.PI/2;const r=this._CreateLightLines(2,e);return r.parent=t,t.scaling.scaleInPlace(ws._Scale),t.rotation.x=Math.PI/2,t}static _CreateDirectionalLightMesh(e){const t=new re("directionalLight",e),i=new re(t.name,e);i.parent=t;const s=uh(t.name,{diameter:1.2,segments:10},e);s.parent=i;const r=ua(t.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},e);r.parent=i;let n=r.clone(t.name);n.scaling.y=.5,n.position.x+=1.25;let a=r.clone(t.name);a.scaling.y=.5,a.position.x+=-1.25;const l=ua(t.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},e);return l.position.y+=3,l.parent=i,n=l.clone(t.name),n.position.y=1.5,n.position.x+=1.25,a=l.clone(t.name),a.position.y=1.5,a.position.x+=-1.25,i.scaling.scaleInPlace(ws._Scale),i.rotation.z=Math.PI/2,i.rotation.y=Math.PI/2,t}}ws._Scale=.007;ws._CreateLightLines=(o,e)=>{const i=new re("root",e);i.rotation.x=Math.PI/2;const s=new re("linePivot",e);s.parent=i;const r=ua("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},e);if(r.position.y=r.scaling.y/2+1.2,r.parent=s,o<2)return s;for(let a=0;a<4;a++){const l=s.clone("lineParentClone");l.rotation.z=Math.PI/4,l.rotation.y=Math.PI/2+Math.PI/2*a,l.getChildMeshes()[0].scaling.y=.5,l.getChildMeshes()[0].scaling.x=l.getChildMeshes()[0].scaling.z=.8,l.getChildMeshes()[0].position.y=l.getChildMeshes()[0].scaling.y/2+1.2}if(o<3)return i;for(let a=0;a<4;a++){const l=s.clone("linePivotClone");l.rotation.z=Math.PI/2,l.rotation.y=Math.PI/2*a}if(o<4)return i;for(let a=0;a<4;a++){const l=s.clone("linePivotClone");l.rotation.z=Math.PI+Math.PI/4,l.rotation.y=Math.PI/2+Math.PI/2*a,l.getChildMeshes()[0].scaling.y=.5,l.getChildMeshes()[0].scaling.x=l.getChildMeshes()[0].scaling.z=.8,l.getChildMeshes()[0].position.y=l.getChildMeshes()[0].scaling.y/2+1.2}if(o<5)return i;const n=s.clone("linePivotClone");return n.rotation.z=Math.PI,i};class qO{constructor(e){this.host=e,this._axesViewer=null,this._rayHelper=null,this._lightGizmo=null,this.host.addController(this)}get scene(){return this.host.scene}_disposeGizmos(){this._axesViewer&&(this._axesViewer.dispose(),this._axesViewer=null),this._rayHelper&&(this._rayHelper.dispose(),this._rayHelper=null),this._lightGizmo&&(this._lightGizmo.dispose(),this._lightGizmo=null)}hostUpdate(){if(!this.scene)return;const e=this.host.entity,t=this.host.evaluated.inspect;if(e&&t){const i=this.scene.defaultUtilityLayer,s=i.utilityLayerScene,r=t.color||"#ff0000",n=parseFloat(t.scale||"1"),a=t.axes!=="false";e instanceof we&&(this._axesViewer||(this._axesViewer=new za(s,1,2)),e.computeWorldMatrix(!0),this._axesViewer.update(e.absolutePosition,e.right,e.up,e.forward),this._axesViewer.scaleLines=a?n:0),e instanceof lt&&(this._rayHelper||(this._rayHelper=new cu(e)),this._rayHelper.show(this.scene,J.FromHexString(r))),e instanceof qe&&(this._lightGizmo||(this._lightGizmo=new ws(i)),this._lightGizmo.light=e,this._lightGizmo.scaleRatio=n)}else this._disposeGizmos()}hostDisconnected(){this._disposeGizmos()}}class ZO{constructor(e){this.host=e,this.host.addController(this)}hostConnected(){}query(e){return this.host.querySelector(e)}queryList(e){return Array.from(this.host.querySelectorAll(e))}queryWatch(e,t,i,s){if(t.aborted)return;let r=this.query(e);r&&(this.host.logger.debug("resolved: %s -> %s",e,s),i(r));const n=new MutationObserver(()=>{const l=this.query(e);!l||l===r||(this.host.logger.debug("resolved: %s -> %s",e,s),i(l),r=l)}),a=()=>{n.disconnect(),t.removeEventListener("abort",a)};t.addEventListener("abort",a),n.observe(this.host,{childList:!0,subtree:!0})}queryWatchList(e,t,i,s){if(t.aborted)return;let r=this.queryList(e);this.host.logger.debug("resolved: %s x%s -> %s",e,r.length,s),i(r);const n=new MutationObserver(()=>{const l=this.queryList(e),h=new Set(l.concat(r));h.size===r.length&&h.size===l.length||(this.host.logger.debug("resolved: %s x%s -> %s",e,l.length,s),i(l),r=l)}),a=()=>{n.disconnect(),t.removeEventListener("abort",a)};t.addEventListener("abort",a),n.observe(this.host,{childList:!0,subtree:!0})}}class QO{constructor(e){this.host=e,this._mob=null,this._onBindEvents=new Map,this.host.addController(this)}hostConnected(){this._mob=new MutationObserver(t=>{t.forEach(i=>{const{type:s,attributeName:r}=i;s==="attributes"&&r&&r.startsWith("on")&&this._handleOnAttrChange(r)})}),this._mob.observe(this.host,{attributes:!0,attributeFilter:["on*"]}),this.host.getAttributeNames().forEach(t=>{t.startsWith("on")&&this._handleOnAttrChange(t)})}_handleOnAttrChange(e){if(!e.startsWith("on"))return;const t=e.slice(2);if(oO.has(t))return;const i=this.host.getAttribute(e),s=this._onBindEvents.has(t);if(!s&&i){const r=em(this.host,i);this.host.addEventListener(t,r),this._onBindEvents.set(t,r),this.host.logger.debug(`[EventDispatchController] addEventListener: ${t}`)}if(s&&!i){const r=this._onBindEvents.get(t);this.host.removeEventListener(t,r),this._onBindEvents.delete(t),this.host.logger.debug(`[EventDispatchController] removeEventListener: ${t}`)}if(s&&i){this.host.removeEventListener(t,this._onBindEvents.get(t));const r=em(this.host,i);this.host.addEventListener(t,r),this._onBindEvents.set(t,r)}}hostDisconnected(){this._mob&&(this._mob.disconnect(),this._mob=null),this._onBindEvents.forEach((e,t)=>{this.host.removeEventListener(t,e)}),this._onBindEvents.clear()}}function em(o,e){return new Function("event",e).bind(o)}class $f{constructor(e){this.host=e,this.host.addController(this)}hostUpdate(){if(!(this.host.entity instanceof qe))return;const e=this.host.entity;e.shadowEnabled=!1,this.host.diffuse&&e.diffuse.copyFrom(this.host.diffuse),this.host.specular&&e.specular.copyFrom(this.host.specular),this.host.intensity&&(e.intensity=this.host.intensity),this.host.shadowEnabled&&(e.shadowEnabled=this.host.shadowEnabled)}}class jf{constructor(e){this.host=e,this.host.addController(this)}hostUpdate(){if(!(this.host.entity instanceof Q))return;const e=this.host.entity;e.backFaceCulling=!!this.host.evaluated.backFaceCulling,e.wireframe=!!this.host.evaluated.wireframe,e.alpha=this.host.evaluated.alpha||1,this.host.evaluated.alphaMode!==null&&(e.alphaMode=this.host.evaluated.alphaMode),e.disableDepthWrite=!!this.host.evaluated.disableDepthWrite,e.zOffset=this.host.evaluated.zOffset||0,this.host.evaluated.sideOrientation!==null&&(e.sideOrientation=this.host.evaluated.sideOrientation)}}class JO{constructor(e){this.host=e,this._lastDisabled=this.host.disabled,this.host.addController(this)}reload(e){if(!(this.host.entity instanceof Jt)||!(this._lastDisabled!==this.host.disabled||e))return;this.host.entity.setEnabled(!this.host.disabled)}hostConnected(){this.reload()}hostUpdate(){this.reload()}}class eN{constructor(e){this.host=e,this._ptOb=null,this._handlePointer=t=>{const i=this.scene.pointerX,s=this.scene.pointerY,r=this.scene.pick(i,s);if(r&&r.pickedMesh){const n=this.host.querySelector(`xr-mesh#${r.pickedMesh.id}`);if(!n)return;t.type===xe.POINTERTAP&&n.click()}},this.host.addController(this)}get scene(){return this.host.scene}hostConnected(){this._ptOb=this.scene.onPointerObservable.add(this._handlePointer,xe.POINTERTAP)}hostUpdate(){}hostDisconnected(){this._ptOb&&(this._ptOb.remove(),this._ptOb=null)}}var tN=typeof Yi=="object"&&Yi&&Yi.Object===Object&&Yi,iN=tN,sN=iN,rN=typeof self=="object"&&self&&self.Object===Object&&self,nN=sN||rN||Function("return this")(),qf=nN,aN=qf,oN=aN.Symbol,Zf=oN,tm=Zf,UE=Object.prototype,lN=UE.hasOwnProperty,hN=UE.toString,Zl=tm?tm.toStringTag:void 0;function cN(o){var e=lN.call(o,Zl),t=o[Zl];try{o[Zl]=void 0;var i=!0}catch{}var s=hN.call(o);return i&&(e?o[Zl]=t:delete o[Zl]),s}var uN=cN,dN=Object.prototype,fN=dN.toString;function _N(o){return fN.call(o)}var pN=_N,im=Zf,gN=uN,mN=pN,EN="[object Null]",TN="[object Undefined]",sm=im?im.toStringTag:void 0;function vN(o){return o==null?o===void 0?TN:EN:sm&&sm in Object(o)?gN(o):mN(o)}var kE=vN;function AN(o){var e=typeof o;return o!=null&&(e=="object"||e=="function")}var VE=AN,RN=kE,bN=VE,SN="[object AsyncFunction]",yN="[object Function]",CN="[object GeneratorFunction]",xN="[object Proxy]";function MN(o){if(!bN(o))return!1;var e=RN(o);return e==yN||e==CN||e==SN||e==xN}var GE=MN,IN=qf,PN=IN["__core-js_shared__"],DN=PN,gd=DN,rm=function(){var o=/[^.]+$/.exec(gd&&gd.keys&&gd.keys.IE_PROTO||"");return o?"Symbol(src)_1."+o:""}();function ON(o){return!!rm&&rm in o}var NN=ON,LN=Function.prototype,FN=LN.toString;function wN(o){if(o!=null){try{return FN.call(o)}catch{}try{return o+""}catch{}}return""}var BN=wN,UN=GE,kN=NN,VN=VE,GN=BN,zN=/[\\^$.*+?()[\]{}|]/g,HN=/^\[object .+?Constructor\]$/,WN=Function.prototype,XN=Object.prototype,YN=WN.toString,KN=XN.hasOwnProperty,$N=RegExp("^"+YN.call(KN).replace(zN,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function jN(o){if(!VN(o)||kN(o))return!1;var e=UN(o)?$N:HN;return e.test(GN(o))}var qN=jN;function ZN(o,e){return o==null?void 0:o[e]}var QN=ZN,JN=qN,eL=QN;function tL(o,e){var t=eL(o,e);return JN(t)?t:void 0}var Qf=tL,iL=Qf,sL=iL(Object,"create"),uu=sL,nm=uu;function rL(){this.__data__=nm?nm(null):{},this.size=0}var nL=rL;function aL(o){var e=this.has(o)&&delete this.__data__[o];return this.size-=e?1:0,e}var oL=aL,lL=uu,hL="__lodash_hash_undefined__",cL=Object.prototype,uL=cL.hasOwnProperty;function dL(o){var e=this.__data__;if(lL){var t=e[o];return t===hL?void 0:t}return uL.call(e,o)?e[o]:void 0}var fL=dL,_L=uu,pL=Object.prototype,gL=pL.hasOwnProperty;function mL(o){var e=this.__data__;return _L?e[o]!==void 0:gL.call(e,o)}var EL=mL,TL=uu,vL="__lodash_hash_undefined__";function AL(o,e){var t=this.__data__;return this.size+=this.has(o)?0:1,t[o]=TL&&e===void 0?vL:e,this}var RL=AL,bL=nL,SL=oL,yL=fL,CL=EL,xL=RL;function yl(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var i=o[e];this.set(i[0],i[1])}}yl.prototype.clear=bL;yl.prototype.delete=SL;yl.prototype.get=yL;yl.prototype.has=CL;yl.prototype.set=xL;var ML=yl;function IL(){this.__data__=[],this.size=0}var PL=IL;function DL(o,e){return o===e||o!==o&&e!==e}var OL=DL,NL=OL;function LL(o,e){for(var t=o.length;t--;)if(NL(o[t][0],e))return t;return-1}var du=LL,FL=du,wL=Array.prototype,BL=wL.splice;function UL(o){var e=this.__data__,t=FL(e,o);if(t<0)return!1;var i=e.length-1;return t==i?e.pop():BL.call(e,t,1),--this.size,!0}var kL=UL,VL=du;function GL(o){var e=this.__data__,t=VL(e,o);return t<0?void 0:e[t][1]}var zL=GL,HL=du;function WL(o){return HL(this.__data__,o)>-1}var XL=WL,YL=du;function KL(o,e){var t=this.__data__,i=YL(t,o);return i<0?(++this.size,t.push([o,e])):t[i][1]=e,this}var $L=KL,jL=PL,qL=kL,ZL=zL,QL=XL,JL=$L;function Cl(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var i=o[e];this.set(i[0],i[1])}}Cl.prototype.clear=jL;Cl.prototype.delete=qL;Cl.prototype.get=ZL;Cl.prototype.has=QL;Cl.prototype.set=JL;var eF=Cl,tF=Qf,iF=qf,sF=tF(iF,"Map"),rF=sF,am=ML,nF=eF,aF=rF;function oF(){this.size=0,this.__data__={hash:new am,map:new(aF||nF),string:new am}}var lF=oF;function hF(o){var e=typeof o;return e=="string"||e=="number"||e=="symbol"||e=="boolean"?o!=="__proto__":o===null}var cF=hF,uF=cF;function dF(o,e){var t=o.__data__;return uF(e)?t[typeof e=="string"?"string":"hash"]:t.map}var fu=dF,fF=fu;function _F(o){var e=fF(this,o).delete(o);return this.size-=e?1:0,e}var pF=_F,gF=fu;function mF(o){return gF(this,o).get(o)}var EF=mF,TF=fu;function vF(o){return TF(this,o).has(o)}var AF=vF,RF=fu;function bF(o,e){var t=RF(this,o),i=t.size;return t.set(o,e),this.size+=t.size==i?0:1,this}var SF=bF,yF=lF,CF=pF,xF=EF,MF=AF,IF=SF;function xl(o){var e=-1,t=o==null?0:o.length;for(this.clear();++e<t;){var i=o[e];this.set(i[0],i[1])}}xl.prototype.clear=yF;xl.prototype.delete=CF;xl.prototype.get=xF;xl.prototype.has=MF;xl.prototype.set=IF;var PF=xl,DF="__lodash_hash_undefined__";function OF(o){return this.__data__.set(o,DF),this}var NF=OF;function LF(o){return this.__data__.has(o)}var FF=LF,wF=PF,BF=NF,UF=FF;function Gc(o){var e=-1,t=o==null?0:o.length;for(this.__data__=new wF;++e<t;)this.add(o[e])}Gc.prototype.add=Gc.prototype.push=BF;Gc.prototype.has=UF;var kF=Gc;function VF(o,e,t,i){for(var s=o.length,r=t+(i?1:-1);i?r--:++r<s;)if(e(o[r],r,o))return r;return-1}var GF=VF;function zF(o){return o!==o}var HF=zF;function WF(o,e,t){for(var i=t-1,s=o.length;++i<s;)if(o[i]===e)return i;return-1}var XF=WF,YF=GF,KF=HF,$F=XF;function jF(o,e,t){return e===e?$F(o,e,t):YF(o,KF,t)}var qF=jF,ZF=qF;function QF(o,e){var t=o==null?0:o.length;return!!t&&ZF(o,e,0)>-1}var JF=QF;function ew(o,e,t){for(var i=-1,s=o==null?0:o.length;++i<s;)if(t(e,o[i]))return!0;return!1}var tw=ew;function iw(o,e){for(var t=-1,i=o==null?0:o.length,s=Array(i);++t<i;)s[t]=e(o[t],t,o);return s}var sw=iw;function rw(o){return function(e){return o(e)}}var nw=rw;function aw(o,e){return o.has(e)}var ow=aw,lw=kF,hw=JF,cw=tw,uw=sw,dw=nw,fw=ow,_w=200;function pw(o,e,t,i){var s=-1,r=hw,n=!0,a=o.length,l=[],h=e.length;if(!a)return l;t&&(e=uw(e,dw(t))),i?(r=cw,n=!1):e.length>=_w&&(r=fw,n=!1,e=new lw(e));e:for(;++s<a;){var c=o[s],u=t==null?c:t(c);if(c=i||c!==0?c:0,n&&u===u){for(var d=h;d--;)if(e[d]===u)continue e;l.push(c)}else r(e,u,i)||l.push(c)}return l}var gw=pw;function mw(o,e){for(var t=-1,i=e.length,s=o.length;++t<i;)o[s+t]=e[t];return o}var Ew=mw;function Tw(o){return o!=null&&typeof o=="object"}var Jf=Tw,vw=kE,Aw=Jf,Rw="[object Arguments]";function bw(o){return Aw(o)&&vw(o)==Rw}var Sw=bw,om=Sw,yw=Jf,zE=Object.prototype,Cw=zE.hasOwnProperty,xw=zE.propertyIsEnumerable,Mw=om(function(){return arguments}())?om:function(o){return yw(o)&&Cw.call(o,"callee")&&!xw.call(o,"callee")},Iw=Mw,Pw=Array.isArray,Dw=Pw,lm=Zf,Ow=Iw,Nw=Dw,hm=lm?lm.isConcatSpreadable:void 0;function Lw(o){return Nw(o)||Ow(o)||!!(hm&&o&&o[hm])}var Fw=Lw,ww=Ew,Bw=Fw;function HE(o,e,t,i,s){var r=-1,n=o.length;for(t||(t=Bw),s||(s=[]);++r<n;){var a=o[r];e>0&&t(a)?e>1?HE(a,e-1,t,i,s):ww(s,a):i||(s[s.length]=a)}return s}var Uw=HE;function kw(o){return o}var WE=kw;function Vw(o,e,t){switch(t.length){case 0:return o.call(e);case 1:return o.call(e,t[0]);case 2:return o.call(e,t[0],t[1]);case 3:return o.call(e,t[0],t[1],t[2])}return o.apply(e,t)}var Gw=Vw,zw=Gw,cm=Math.max;function Hw(o,e,t){return e=cm(e===void 0?o.length-1:e,0),function(){for(var i=arguments,s=-1,r=cm(i.length-e,0),n=Array(r);++s<r;)n[s]=i[e+s];s=-1;for(var a=Array(e+1);++s<e;)a[s]=i[s];return a[e]=t(n),zw(o,this,a)}}var Ww=Hw;function Xw(o){return function(){return o}}var Yw=Xw,Kw=Qf,$w=function(){try{var o=Kw(Object,"defineProperty");return o({},"",{}),o}catch{}}(),jw=$w,qw=Yw,um=jw,Zw=WE,Qw=um?function(o,e){return um(o,"toString",{configurable:!0,enumerable:!1,value:qw(e),writable:!0})}:Zw,Jw=Qw,e1=800,t1=16,i1=Date.now;function s1(o){var e=0,t=0;return function(){var i=i1(),s=t1-(i-t);if(t=i,s>0){if(++e>=e1)return arguments[0]}else e=0;return o.apply(void 0,arguments)}}var r1=s1,n1=Jw,a1=r1,o1=a1(n1),l1=o1,h1=WE,c1=Ww,u1=l1;function d1(o,e){return u1(c1(o,e,h1),o+"")}var f1=d1,_1=9007199254740991;function p1(o){return typeof o=="number"&&o>-1&&o%1==0&&o<=_1}var g1=p1,m1=GE,E1=g1;function T1(o){return o!=null&&E1(o.length)&&!m1(o)}var v1=T1,A1=v1,R1=Jf;function b1(o){return R1(o)&&A1(o)}var S1=b1,y1=gw,C1=Uw,x1=f1,dm=S1,M1=x1(function(o,e){return dm(o)?y1(o,C1(e,1,dm,!0)):[]}),I1=M1;const P1=Gf(I1);class Hr{constructor(e,t,i,s){this.host=e,this.selectorProp=t,this.targetProp=i,this.fallbackTagName=s,this._ab=null,this._selfHostElement=null,this._lastIncomeData=null,this._sceneEle=null,this._setTarget=r=>{const n=this.host;n[this.targetProp]=r},this.host.addController(this)}hostConnected(){this._sceneEle=this.host.closest("xr-scene")}hostUpdated(){if(this._sceneEle&&this.host.changed.has(this.selectorProp)){const e=this.host.evaluated[this.selectorProp];if(typeof e=="string")if((e.includes(": ")||e==="")&&this.fallbackTagName){const t=Vr.fromAttr("Object",e);if(t){const i=typeof this.fallbackTagName=="function"?this.fallbackTagName(t):this.fallbackTagName,s=Vt.Instance.get(i);if(this._selfHostElement&&this._selfHostElement.tagName.toLowerCase()!==i.toLowerCase()&&(this._selfHostElement.remove(),this._selfHostElement=null),this._selfHostElement){const r=this._lastIncomeData?P1(Object.keys(this._lastIncomeData),Object.keys(t)):[];for(const n of r){const a=[...s.elementProperties.values()].find(c=>c.attribute===n)||s.elementProperties.get(n);if(!a)continue;const l=a.initValue;if(l===null)continue;const h=[...s.elementProperties.entries()].find(([,c])=>c===a)[0];this._selfHostElement[h]=yE(l)}for(const[n,a]of Object.entries(t))this._selfHostElement.setAttribute(n,a)}else{const r=new s;this._selfHostElement=r;for(const[n,a]of Object.entries(t))r.setAttribute(n,a);this.host.appendChild(r),r.entity||this.host.logger.warn("TagRefController: entity is null when ref is object. tag=%s",r.tagName.toLowerCase()),this._setTarget(r)}this._lastIncomeData=t}}else this._ab&&this._ab.abort(),this._ab=new AbortController,this._selfHostElement&&(this._selfHostElement.remove(),this._selfHostElement=null),this._sceneEle.querier.queryWatch(e,this._ab.signal,this._setTarget,this.host.displayText);else this._setTarget(null),this._selfHostElement&&(this._selfHostElement.remove(),this._selfHostElement=null)}}hostDisconnected(){this._ab&&(this._ab.abort(),this._ab=null),this._setTarget(null),this._selfHostElement&&(this._selfHostElement.remove(),this._selfHostElement=null),this._lastIncomeData=null}}class D1{constructor(e,t,i){this.host=e,this.selectorProp=t,this.targetProp=i,this._ab=null,this._sceneEle=null,this._setTarget=s=>{const r=this.host;r[this.targetProp]=s},this.host.addController(this)}hostConnected(){this._sceneEle=this.host.closest("xr-scene")}hostUpdated(){if(this._sceneEle&&this.host.changed.has(this.selectorProp)){const e=this.host.evaluated[this.selectorProp];typeof e=="string"?(this._ab&&(this._ab.abort(),this._ab=null),this._ab=new AbortController,this._sceneEle.querier.queryWatchList(e,this._ab.signal,this._setTarget,this.host.displayText)):this._setTarget(null)}}hostDisconnected(){this._ab&&(this._ab.abort(),this._ab=null),this._setTarget(null)}}class XE{constructor(e){this.host=e,this.host.addController(this)}hostUpdate(){if(!(this.host.entity instanceof bt))return;const e=this.host.entity;typeof this.host.hasAlpha=="boolean"&&(e.hasAlpha=this.host.hasAlpha),typeof this.host.level=="number"&&(e.level=this.host.level),typeof this.host.coordinatesIndex=="number"&&(e.coordinatesIndex=this.host.coordinatesIndex),typeof this.host.coordinatesMode=="number"&&(e.coordinatesMode=this.host.coordinatesMode),typeof this.host.wrapU=="number"&&(e.wrapU=this.host.wrapU),typeof this.host.wrapV=="number"&&(e.wrapV=this.host.wrapV)}}class e_{constructor(e,t){this.host=e,this._onTick=t,this._lastTime=0,this._tickOb=null,this._timer=null,this._handleFrame=()=>{const i=performance.now(),s=i-this._lastTime;this._lastTime=i,this._onTick(s)},this.host.addController(this)}get scene(){return this.host.scene}hostConnected(){if(this.scene)this._tickOb=this.scene.onBeforeRenderObservable.add(this._handleFrame);else{const e=()=>{this._handleFrame(),this._timer=requestAnimationFrame(e)};this._timer=requestAnimationFrame(e)}}hostDisconnected(){this._tickOb&&(this._tickOb.remove(),this._tickOb=null),this._timer&&(cancelAnimationFrame(this._timer),this._timer=null)}}class jh{constructor(e){this.host=e,this.host.addController(this)}hostUpdate(){const e=this.host.entity;if(!e)return;const t=this.host.evaluated.position,i=this.host.evaluated.rotation,s=this.host.evaluated.quaternion,r=this.host.evaluated.scale,n=this.host.changed;n.has("position")&&t&&e.position.copyFrom(t),n.has("rotation")&&i&&(e.rotation.copyFrom(i).scaleInPlace(Math.PI/180),e.rotationQuaternion&&le.FromEulerVectorToRef(e.rotation,e.rotationQuaternion)),n.has("quaternion")&&(s?e.rotationQuaternion?e.rotationQuaternion.copyFrom(s):e.rotationQuaternion=s.clone():e.rotationQuaternion=null),n.has("scale")&&r&&e.scaling.copyFrom(r),n.has("layer")&&e&&e instanceof re&&(e.renderingGroupId=this.host.evaluated.layer||0)}hostDisconnected(){this._matrixChangeOb&&(this._matrixChangeOb.remove(),this._matrixChangeOb=null)}}var O1=Object.defineProperty,N1=Object.getOwnPropertyDescriptor,t_=(o,e,t,i)=>{for(var s=i>1?void 0:i?N1(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&O1(e,t,s),s};const fm=Symbol("ComputedStylesFlagSym"),a_=class a_ extends ch{constructor(){super(),this.logger=gf.extend(this.tagName.toLowerCase()),this.entity=null,this.inspect=null,this.disabled=null,this._styled=null,this._styleRefData={},this._disposes=[],this.evaluated=new Proxy({},{get:(e,t)=>{var s;const i=t;return((s=this._styleRefData[i])==null?void 0:s.data)??null},set(e,t){throw new Error(`Can't set property "${t}" of evaluatedProps`)},ownKeys:()=>[...this._Cls.elementProperties.keys()].filter(t=>typeof t=="string"),getOwnPropertyDescriptor:(e,t)=>{const i=t;if(this._Cls.elementProperties.has(i))return{enumerable:!0,configurable:!0}}}),this.changed=new Map,new JO(this),new QO(this),new qO(this),new e_(this,()=>{this.checkComputedStyles()})}get _Cls(){return this.constructor}get displayText(){return Gs.displayText(this)}createRenderRoot(){return this}checkComputedStyles(){if(this._styled)for(const[e]of this._Cls.elementProperties){if(typeof e!="string")continue;const t=this.evaluated[e];this.reloadAttrFromComputedStyles(e)&&this.requestUpdate(e,new Kg(fm,t),{hasChanged:()=>!0})}}reloadAttrFromComputedStyles(e){var n;if(!this._styled)return;const t=this._Cls.elementProperties.get(e);if(!t||t.state)return;const i=t.attribute??e,s=this._styled.getPropertyValue("---"+i).trim();if(((n=this._styleRefData[e])==null?void 0:n.raw)===s)return;const r=Vr.fromCssLiteral(t.dType,s);if(r===null&&this._styleRefData[e])return delete this._styleRefData[e],!0;if(r!==null&&!this._styleRefData[e])return this._styleRefData[e]={raw:s,data:r},!0;if(r!==null&&this._styleRefData[e]&&!Vr.isEqual(t.dType,this._styleRefData[e].data,r))return this._styleRefData[e]={raw:s,data:r},!0}convertPropertyValue(e,t){const i=this._Cls.elementProperties.get(e);return i.converter?i.converter.fromAttribute(t):i.type?i.type(t):t}emit(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0}))}connectedCallback(){super.connectedCallback();for(const[e,t]of this._Cls.elementProperties)typeof this[e]>"u"&&this.logger.warn("Missing default value for property: %s",e);if(this.logger.debug("connected"),this.id||(this.id="_"+Hh()),this._Cls.requiredAttrs.length>0){const e=this._Cls.requiredAttrs.filter(t=>this.getAttribute(t)===null);if(e.length>0)throw new Error(`[${this.tagName}] Missing required attributes: ${e.join(", ")}`)}this._styled=getComputedStyle(this),this.checkComputedStyles(),this.connected()}willUpdate(e){super.willUpdate(e);for(const[t,i]of Array.from(e.entries()))i instanceof Kg&&i.type===fm?e.set(t,i.valueOf()):this._syncPropertyToStyle(t);this.changed.clear();for(const[t,i]of e)this.changed.set(t,i)}_syncPropertyToStyle(e){const t=this._Cls.elementProperties.get(e);if(!t||t.state)return;const i="---"+(t.attribute||e),s=this[e]===null?"":Vr.toCssLiteral(t.dType,this[e]);s===""?this.style.removeProperty(i):this.style.setProperty(i,s),this.reloadAttrFromComputedStyles(e)}shouldUpdate(e){return super.shouldUpdate(e)}updated(e){}disconnectedCallback(){super.disconnectedCallback(),this.logger.debug("remove"),this._styled=null;for(const e of this._disposes)e();this._disposes=[],this.disconnected()}connected(){}disconnected(){}render(){return null}toAttributeObject(){return Gs.toAttributeObject(this)}};a_.requiredAttrs=[];let yn=a_;t_([Ss()],yn.prototype,"entity",2);t_([$.property("Object","inspect",null)],yn.prototype,"inspect",2);t_([$.property("Boolean","disabled",null)],yn.prototype,"disabled",2);var L1=Object.defineProperty,F1=Object.getOwnPropertyDescriptor,w1=(o,e,t,i)=>{for(var s=i>1?void 0:i?F1(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&L1(e,t,s),s};class Bi extends yn{}w1([$.scene()],Bi.prototype,"scene",2);var B1=Object.defineProperty,U1=Object.getOwnPropertyDescriptor,Ml=(o,e,t,i)=>{for(var s=i>1?void 0:i?U1(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&B1(e,t,s),s};const o_=class o_ extends Bi{constructor(){super(...arguments),this.alpha=null,this.beta=null,this.radius=null,this.target=null,this.minZ=null,this.maxZ=null}connected(){super.connected(),this.entity=new Gt(this.id,0,0,1,new m(0,0,0),this.scene),this.entity.lowerRadiusLimit=this.minZ,this.entity.attachControl()}willUpdate(e){super.willUpdate(e),this.entity&&(e.has("alpha")&&this.evaluated.alpha!=null&&(this.entity.alpha=this.evaluated.alpha*Math.PI/180),e.has("beta")&&this.evaluated.beta!=null&&(this.entity.beta=this.evaluated.beta*Math.PI/180),e.has("radius")&&this.evaluated.radius!=null&&(this.entity.radius=this.evaluated.radius),e.has("target")&&(this.entity.lockedTarget=this.evaluated.target),e.has("minZ")&&this.evaluated.minZ!=null&&(this.entity.minZ=this.evaluated.minZ,this.entity.lowerRadiusLimit=this.evaluated.minZ),e.has("maxZ")&&this.evaluated.maxZ!=null&&(this.entity.maxZ=this.evaluated.maxZ))}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};o_.requiredAttrs=["id"];let Wr=o_;Ml([$.property("Number","alpha",-90)],Wr.prototype,"alpha",2);Ml([$.property("Number","beta",90)],Wr.prototype,"beta",2);Ml([$.property("Number","radius",10)],Wr.prototype,"radius",2);Ml([$.property("Vector3","target",m.Zero())],Wr.prototype,"target",2);Ml([$.property("Number","min-z",.1)],Wr.prototype,"minZ",2);Ml([$.property("Number","max-z",100)],Wr.prototype,"maxZ",2);var k1=Object.defineProperty,V1=Object.getOwnPropertyDescriptor,pa=(o,e,t,i)=>{for(var s=i>1?void 0:i?V1(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&k1(e,t,s),s},na;const Ln=(na=class extends yn{constructor(){super(...arguments),this.ID=Hh(),this.querier=new ZO(this),this.scene=null,this.background=null,this.envUrl=null,this.envRotationY=null,this.envIntensity=null,this.contrast=null,this.exposure=null,this._container=null,this._doRender=()=>{this.scene.activeCamera&&this.scene.render()}}static createEngine(e){const t=new H(e,!0,{stencil:!0,antialias:!0,adaptToDeviceRatio:!0,doNotHandleContextLost:!0});return t.loadingScreen={displayLoadingUI:()=>{},hideLoadingUI:()=>{},loadingUIBackgroundColor:"",loadingUIText:""},t}connected(){super.connected(),this.style.display="block",this.style.position="relative",this.style.width="100%",this.style.height="100%",this._container=document.createElement("div"),this._container.id=this.ID,this._container.classList.add("xr-canvas-container"),this._container.style.width="100%",this._container.style.height="100%",this.appendChild(this._container);const e=document.createElement("canvas");e.style.width="100%",e.style.height="100%",e.style.outline="none",this._container.appendChild(e),this.engine=na.createEngine(e),this.logger.info("Engine %s created",this.ID),this.scene=new Ve(this.engine),this.scene.autoClear=!0,this.scene.clearColor=new He(0,0,0,0),this.scene.environmentTexture=Si.CreateFromPrefilteredData(na.defaultEnvMap,this.scene);const t=new me("default",this.scene);t.metallic=.2,t.roughness=.8,this.scene.defaultMaterial=t,this.engine.runRenderLoop(this._doRender),new eN(this)}firstUpdated(){if(!this._container)return;const e=this.getBoundingClientRect();this._container.style.width=`${e.width}px`,this._container.style.height=`${e.height}px`,this.engine.resize()}updated(e){(e.has("width")||e.has("height"))&&this.engine.resize()}willUpdate(e){var t;super.willUpdate(e),e.has("contrast")&&(this.scene.imageProcessingConfiguration.contrast=this.evaluated.contrast||1),e.has("exposure")&&(this.scene.imageProcessingConfiguration.exposure=this.evaluated.exposure||1),e.has("envUrl")&&this.evaluated.envUrl&&this.scene.environmentTexture instanceof Si&&this.scene.environmentTexture.updateURL(this.evaluated.envUrl),e.has("envRotationY")&&this.scene.environmentTexture instanceof Si&&(this.scene.environmentTexture.rotationY=(this.evaluated.envRotationY||0)*(Math.PI/180)),e.has("envIntensity")&&(this.scene.environmentIntensity=this.evaluated.envIntensity||1),e.has("background")&&this._container&&(this._container.style.background=((t=this.evaluated.background)==null?void 0:t.toHexString())||"transparent")}disconnected(){super.disconnected(),this.engine.dispose(),this.logger.info("Engine %s disposed",this.ID)}},na.defaultEnvMap=new URL("/solidx.js/assets/EnvMap_3.0-256-TskdOyuZ.env",import.meta.url).href,na);pa([AE({context:Uc.Scene}),Ss()],Ln.prototype,"scene",2);pa([$.property("Color4","background",new He(1,1,1,0))],Ln.prototype,"background",2);pa([$.property("String","env-url",null)],Ln.prototype,"envUrl",2);pa([$.property("Number","env-rotation-y",null)],Ln.prototype,"envRotationY",2);pa([$.property("Number","env-intensity",null)],Ln.prototype,"envIntensity",2);pa([$.property("Number","contrast",1.2)],Ln.prototype,"contrast",2);pa([$.property("Number","exposure",1.2)],Ln.prototype,"exposure",2);let G1=Ln;var z1=Object.defineProperty,H1=Object.getOwnPropertyDescriptor,ga=(o,e,t,i)=>{for(var s=i>1?void 0:i?H1(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&z1(e,t,s),s};const l_=class l_ extends Bi{constructor(){super(),this.position=null,this.diffuse=null,this.specular=null,this.intensity=null,this.shadowEnabled=null,this.alpha=null,this.beta=null,new $f(this)}connected(){super.connected(),this.entity=new bs(this.id,new m(0,-1,0),this.scene),this.entity.position.set(0,0,0),this.entity.parent=Gs.closestTransformNodeLike(this)}willUpdate(e){if(super.willUpdate(e),!!this.entity&&typeof this.evaluated.alpha=="number"&&typeof this.evaluated.beta=="number"){const t=this.evaluated.alpha*(Math.PI/180),i=this.evaluated.beta*(Math.PI/180);this.entity.direction.x=Math.sin(i)*Math.cos(t),this.entity.direction.y=Math.cos(i),this.entity.direction.z=Math.sin(i)*Math.sin(t),this.entity.direction.scaleInPlace(-1)}}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};l_.requiredAttrs=["id"];let gr=l_;ga([$.property("Vector3","position",null)],gr.prototype,"position",2);ga([$.property("Color3","diffuse",null)],gr.prototype,"diffuse",2);ga([$.property("Color3","specular",null)],gr.prototype,"specular",2);ga([$.property("Number","intensity",null)],gr.prototype,"intensity",2);ga([$.property("Boolean","shadowEnabled",null)],gr.prototype,"shadowEnabled",2);ga([$.property("Number","alpha",40)],gr.prototype,"alpha",2);ga([$.property("Number","beta",30)],gr.prototype,"beta",2);var W1=Object.defineProperty,X1=Object.getOwnPropertyDescriptor,ma=(o,e,t,i)=>{for(var s=i>1?void 0:i?X1(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&W1(e,t,s),s};const h_=class h_ extends Bi{constructor(){super(),this.position=null,this.diffuse=null,this.specular=null,this.intensity=null,this.shadowEnabled=null,this.alpha=null,this.beta=null,new $f(this)}connected(){super.connected(),this.entity=new Dn(this.id,new m(0,1,0),this.scene),this.entity.parent=Gs.closestTransformNodeLike(this)}willUpdate(e){if(super.willUpdate(e),!!this.entity&&typeof this.evaluated.alpha=="number"&&typeof this.evaluated.beta=="number"){const t=this.evaluated.alpha*(Math.PI/180),i=this.evaluated.alpha*(Math.PI/180);this.entity.direction.x=Math.sin(i)*Math.cos(t),this.entity.direction.y=Math.cos(i),this.entity.direction.z=Math.sin(i)*Math.sin(t)}}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};h_.requiredAttrs=["id"];let mr=h_;ma([$.property("Vector3","position",null)],mr.prototype,"position",2);ma([$.property("Color3","diffuse",null)],mr.prototype,"diffuse",2);ma([$.property("Color3","specular",null)],mr.prototype,"specular",2);ma([$.property("Number","intensity",null)],mr.prototype,"intensity",2);ma([$.property("Boolean","shadowEnabled",null)],mr.prototype,"shadowEnabled",2);ma([$.property("Number","alpha",0)],mr.prototype,"alpha",2);ma([$.property("Number","beta",0)],mr.prototype,"beta",2);var Y1=Object.defineProperty,K1=Object.getOwnPropertyDescriptor,qh=(o,e,t,i)=>{for(var s=i>1?void 0:i?K1(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&Y1(e,t,s),s};const c_=class c_ extends Bi{constructor(){super(),this.position=null,this.diffuse=null,this.specular=null,this.intensity=null,this.shadowEnabled=null,new $f(this)}connected(){super.connected(),this.entity=new Rl(this.id,m.Zero(),this.scene),this.entity.parent=Gs.closestTransformNodeLike(this)}willUpdate(e){super.willUpdate(e),this.entity&&e.has("position")&&this.evaluated.position&&this.entity.position.copyFrom(this.evaluated.position)}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};c_.requiredAttrs=["id"];let Cn=c_;qh([$.property("Vector3","position",null)],Cn.prototype,"position",2);qh([$.property("Color3","diffuse",null)],Cn.prototype,"diffuse",2);qh([$.property("Color3","specular",null)],Cn.prototype,"specular",2);qh([$.property("Number","intensity",null)],Cn.prototype,"intensity",2);qh([$.property("Boolean","shadowEnabled",null)],Cn.prototype,"shadowEnabled",2);class YE{get name(){return this._name}get cameras(){return this._cameras}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];i&&i._enable(Y.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];i&&i._disable(Y.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=Y.MakeArray(e||this._cameras);if(!i)return;const s=[];let r;for(r=0;r<i.length;r++){const n=i[r];n&&(this._cameras.indexOf(n)===-1?this._cameras.push(n):t&&s.push(r))}for(r=0;r<s.length;r++)i.splice(s[r],1);for(const n in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,n)&&this._renderEffects[n]._attachCameras(i)}_detachCameras(e){const t=Y.MakeArray(e||this._cameras);if(t){for(const i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(t);for(let i=0;i<t.length;i++)this._cameras.splice(this._cameras.indexOf(t[i]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){const e=Object.keys(this._renderEffects);for(const t of e){const i=this._renderEffects[t].getPostProcesses();if(i)for(const s of i)s.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}v([M()],YE.prototype,"_name",void 0);class Ql{constructor(e,t,i,s){this._name=t,this._singleInstance=s||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let i=0;i<t.length;i++)if(!t[i].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=Y.MakeArray(e||this._cameras);if(i)for(let s=0;s<i.length;s++){const r=i[s];if(!r)continue;const n=r.name;if(this._singleInstance?t=0:t=n,!this._postProcesses[t]){const a=this._getPostProcesses();a&&(this._postProcesses[t]=Array.isArray(a)?a:[a])}this._indicesForCamera[n]||(this._indicesForCamera[n]=[]),this._postProcesses[t].forEach(a=>{const l=r.attachPostProcess(a);this._indicesForCamera[n].push(l)}),this._cameras[n]||(this._cameras[n]=r)}}_detachCameras(e){const t=Y.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const s=t[i],r=s.name,n=this._postProcesses[this._singleInstance?0:r];n&&n.forEach(a=>{s.detachPostProcess(a)}),this._cameras[r]&&(this._cameras[r]=null),delete this._indicesForCamera[r]}}_enable(e){const t=Y.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const s=t[i],r=s.name,n=this._singleInstance?0:r;for(let a=0;a<this._indicesForCamera[r].length;a++){const l=this._indicesForCamera[r][a],h=s._postProcesses[l];h==null&&t[i].attachPostProcess(this._postProcesses[n][a],l)}}}_disable(e){const t=Y.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){const s=t[i],r=s.name;this._postProcesses[this._singleInstance?0:r].forEach(n=>{s.detachPostProcess(n)})}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}class $1{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}class j1{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){const s=this._renderPipelines[e];s&&s._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];s&&s._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(Ve.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let o=this._getComponent(pe.NAME_POSTPROCESSRENDERPIPELINEMANAGER);o||(o=new q1(this),this._addComponent(o)),this._postProcessRenderPipelineManager=new j1}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class q1{constructor(e){this.name=pe.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(pe.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}const Z1="ssao2PixelShader",Q1=`precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()
{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=depth/abs(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}
float sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}
#endif
#ifdef BLUR
uniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;
#ifndef BLUR_BYPASS
uniform sampler2D depthSampler;
#ifdef BLUR_LEGACY
#define inline
float blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}
#endif
#endif
void main()
{float result=0.0;
#ifdef BLUR_BYPASS
result=textureLod(textureSampler,vUV,0.0).r;
#else
#ifdef BLUR_H
vec2 step=vec2(1.0/outSize,0.0);
#else
vec2 step=vec2(0.0,1.0/outSize);
#endif
#ifdef BLUR_LEGACY
result=blur13Bilateral(textureSampler,vUV,step);
#else
float compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)
{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,
float(samples),
float(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}
result/=weightSum;
#endif
#endif
gl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}
#endif
`;X.ShadersStore[Z1]=Q1;const J1="ssaoCombinePixelShader",eB=`uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);vec4 sceneColor=texture2D(originalColor,vUV);gl_FragColor=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;X.ShadersStore[J1]=eB;class hi extends YE{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){const t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){const t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=Ze.LastCreatedEngine;return e?e._features.supportSSAO2:!1}get scene(){return this._scene}constructor(e,t,i,s,r=!1,n=0){var a,l;if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=n,this._forceGeometryBuffer=r,!this.isSupported){q.Error("The current engine does not support SSAO 2.");return}const h=this._ratio.ssaoRatio||i,c=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),!((a=t.geometryBufferRenderer)===null||a===void 0)&&a.generateNormalsInWorldSpace&&q.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),!((l=t.prePassRenderer)===null||l===void 0)&&l.generateNormalsInWorldSpace&&q.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new Ch("SSAOOriginalSceneColor",1,null,V.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(h,c,this._textureType),this._createSSAOCombinePostProcess(c,this._textureType),this.addEffect(new Ql(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new Ql(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new Ql(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new Ql(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new Ql(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i=`#define BLUR
`;return t&&(i+=`#define BLUR_BYPASS
`),e||(i+=`#define BLUR_LEGACY
`),{h:i+`#define BLUR_H
`,v:i}}_createBlurPostProcess(e,t,i){const s=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),r=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",r,e,s.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",r,t,s.v,i,!1)}_createBlurFilter(e,t,i,s,r,n){const a=new ht(e,"ssao2",["outSize","samples","soften","tolerance"],t,i,null,V.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,r);return a.onApply=l=>{if(!this._scene.activeCamera)return;const h=n?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,c=n?this._originalColorPostProcess.width:this._originalColorPostProcess.height;l.setFloat("outSize",h>0?h:c),l.setInt("samples",this.bilateralSamples),l.setFloat("soften",this.bilateralSoften),l.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?l.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&l.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},a.samples=this.textureSamples,a}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=t*2*Math.PI,s=1-e*.85,r=Math.sqrt(1-s*s);return new m(Math.cos(i)*r,Math.sin(i)*r,s)}_generateHemisphere(){const e=this.samples,t=[];let i,s=0;for(;s<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const r=this._hammersley(s,e);i=this._hemisphereSample_uniform(r[0],r[1])}t.push(i.x,i.y,i.z),s++}return t}_getDefinesForSSAO(){return`#define SSAO
#define SAMPLES ${this.samples}
#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO(),s=["randomSampler","depthSampler","normalSampler"];this._ssaoPostProcess=new ht("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],s,e,null,V.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.onApply=r=>{var n,a,l,h;if(this._scene.activeCamera){if(r.setArray3("sampleSphere",this._sampleSphere),r.setFloat("randTextureTiles",32),r.setFloat("samplesFactor",1/this.samples),r.setFloat("totalStrength",this.totalStrength),r.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),r.setFloat("radius",this.radius),r.setFloat("maxZ",this.maxZ),r.setFloat("minZAspect",this.minZAspect),r.setFloat("base",this.base),r.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===De.PERSPECTIVE_CAMERA)r.setMatrix3x3("depthProjection",hi.PERSPECTIVE_DEPTH_PROJECTION),r.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),r.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const c=this._scene.getEngine().getRenderWidth()/2,u=this._scene.getEngine().getRenderHeight()/2,d=(n=this._scene.activeCamera.orthoLeft)!==null&&n!==void 0?n:-c,f=(a=this._scene.activeCamera.orthoRight)!==null&&a!==void 0?a:c,p=(l=this._scene.activeCamera.orthoBottom)!==null&&l!==void 0?l:-u,_=(h=this._scene.activeCamera.orthoTop)!==null&&h!==void 0?h:u;r.setMatrix3x3("depthProjection",hi.ORTHO_DEPTH_PROJECTION),r.setFloat("xViewport",(f-d)*.5),r.setFloat("yViewport",(_-p)*.5)}r.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(r.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),r.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(r.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),r.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),r.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new $1)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new ht("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,V.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=i=>{const s=this._scene.activeCamera.viewport;i.setVector4("viewport",D.Vector4[0].copyFromFloats(s.x,s.y,s.width,s.height)),i.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){const t=new Uint8Array(65536),i=Ke.Zero();for(let r=0;r<t.length;)i.set(Te.RandomRange(0,1),Te.RandomRange(0,1)).normalize().scaleInPlace(255),t[r++]=Math.floor(i.x),t[r++]=Math.floor(i.y),t[r++]=0,t[r++]=255;const s=Fs.CreateRGBATexture(t,128,128,this._scene,!1,!1,2);s.name="SSAORandomTexture",s.wrapU=V.WRAP_ADDRESSMODE,s.wrapV=V.WRAP_ADDRESSMODE,this._randomTexture=s}serialize(){const e=Le.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return Le.Parse(()=>new hi(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType),e,t,i)}}hi.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1];hi.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1];v([M()],hi.prototype,"totalStrength",void 0);v([M()],hi.prototype,"maxZ",void 0);v([M()],hi.prototype,"minZAspect",void 0);v([M("epsilon")],hi.prototype,"_epsilon",void 0);v([M("samples")],hi.prototype,"_samples",void 0);v([M("textureSamples")],hi.prototype,"_textureSamples",void 0);v([M()],hi.prototype,"_forceGeometryBuffer",void 0);v([M()],hi.prototype,"_ratio",void 0);v([M()],hi.prototype,"_textureType",void 0);v([M()],hi.prototype,"radius",void 0);v([M()],hi.prototype,"base",void 0);v([M("bypassBlur")],hi.prototype,"_bypassBlur",void 0);v([M("expensiveBlur")],hi.prototype,"_expensiveBlur",void 0);v([M()],hi.prototype,"bilateralSamples",void 0);v([M()],hi.prototype,"bilateralSoften",void 0);v([M()],hi.prototype,"bilateralTolerance",void 0);Re("BABYLON.SSAO2RenderingPipeline",hi);var tB=Object.defineProperty,iB=Object.getOwnPropertyDescriptor,_u=(o,e,t,i)=>{for(var s=i>1?void 0:i?iB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&tB(e,t,s),s};class Zh extends Bi{constructor(){super(...arguments),this.samples=null,this.radius=null,this.totalStrength=null,this.maxZ=null}connected(){super.connected(),this.entity=new hi(this.id,this.scene,1,this.scene.cameras),this.entity.bypassBlur=!1,this.entity.expensiveBlur=!1}willUpdate(e){super.willUpdate(e),this.entity&&(e.has("samples")&&this.evaluated.samples&&(this.entity.samples=this.evaluated.samples),e.has("radius")&&this.evaluated.radius&&(this.entity.radius=this.evaluated.radius),e.has("totalStrength")&&this.evaluated.totalStrength&&(this.entity.totalStrength=this.evaluated.totalStrength),e.has("maxZ")&&this.evaluated.maxZ&&(this.entity.maxZ=this.evaluated.maxZ))}disconnected(){super.disconnected(),this.entity&&(this.entity.dispose(),this.entity=null)}}_u([$.property("Number","samples",null)],Zh.prototype,"samples",2);_u([$.property("Number","radius",null)],Zh.prototype,"radius",2);_u([$.property("Number","total-strength",null)],Zh.prototype,"totalStrength",2);_u([$.property("Number","max-z",null)],Zh.prototype,"maxZ",2);const sB="volumetricLightScatteringPixelShader",rB=`uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}
vec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));
#define CUSTOM_FRAGMENT_MAIN_END
}
`;X.ShadersStore[sB]=rB;const nB="volumetricLightScatteringPassVertexShader",aB=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;X.ShadersStore[nB]=aB;const oB="volumetricLightScatteringPassPixelShader",lB=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);}
`;X.ShadersStore[oB]=lB;class us extends ht{get useDiffuseColor(){return q.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){q.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,s,r=100,n=V.BILINEAR_SAMPLINGMODE,a,l,h){var c,u;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,n,a,l,"#define NUM_SAMPLES "+r),this._screenCoordinates=Ke.Zero(),this.customMeshPosition=m.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,h=(u=(c=i==null?void 0:i.getScene())!==null&&c!==void 0?c:h)!==null&&u!==void 0?u:this._scene,a=h.getEngine(),this._viewPort=new Za(0,0,1,1).toGlobal(a.getRenderWidth(),a.getRenderHeight()),this.mesh=s??us.CreateDefaultMesh("VolumetricLightScatteringMesh",h),this._createPass(h,t.passRatio||t),this.onActivate=d=>{this.isSupported||this.dispose(d),this.onActivate=null},this.onApplyObservable.add(d=>{this._updateMeshScreenCoordinates(h),d.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),d.setFloat("exposure",this.exposure),d.setFloat("decay",this.decay),d.setFloat("weight",this.weight),d.setFloat("density",this.density),d.setVector2("meshPositionOnScreen",this._screenCoordinates)})}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var i;const s=e.getMesh();if(s===this.mesh&&s.material)return s.material.isReady(s);const r=(i=s._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(s,e,t);const n=[],a=[T.PositionKind],l=e.getMaterial();l&&(l.needAlphaTesting()&&n.push("#define ALPHATEST"),s.isVerticesDataPresent(T.UVKind)&&(a.push(T.UVKind),n.push("#define UV1")),s.isVerticesDataPresent(T.UV2Kind)&&(a.push(T.UV2Kind),n.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(a.push(T.MatricesIndicesKind),a.push(T.MatricesWeightsKind),n.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),n.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0"),t&&(n.push("#define INSTANCES"),se.PushAttributesForInstances(a),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const h=e._getDrawWrapper(void 0,!0),c=h.defines,u=n.join(`
`);return c!==u&&h.setEffect(s.getScene().getEngine().createEffect("volumetricLightScatteringPass",a,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],u,void 0,void 0,void 0,{maxSimultaneousMorphTargets:s.numBoneInfluencers}),u),h.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);t!==-1&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&this.includedMeshes.indexOf(e)===-1||this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new Ki("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=V.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=V.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const r=l=>{var h;const c=l.getRenderingMesh(),u=l.getEffectiveMesh();if(this._meshExcluded(c))return;u._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const d=l.getMaterial();if(!d)return;const f=c.getScene(),p=f.getEngine();p.setState(d.backFaceCulling,void 0,void 0,void 0,d.cullBackFaces);const _=c._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(_.mustReturn)return;const g=p.getCaps().instancedArrays&&(_.visibleInstances[l._id]!==null||c.hasThinInstances);if(this._isReady(l,g)){const E=(h=u._internalAbstractMeshDataInfo._materialForRenderPass)===null||h===void 0?void 0:h[p.currentRenderPassId];let R=l._getDrawWrapper();if(c===this.mesh&&!R&&(R=d._getDrawWrapper()),!R)return;const x=R.effect;if(p.enableEffect(R),g||c._bind(l,x,d.fillMode),c===this.mesh)d.bind(u.getWorldMatrix(),c);else if(E)E.bindForSubMesh(u.getWorldMatrix(),u,l);else{if(x.setMatrix("viewProjection",f.getTransformMatrix()),d&&d.needAlphaTesting()){const S=d.getAlphaTestTexture();x.setTexture("diffuseSampler",S),S&&x.setMatrix("diffuseMatrix",S.getTextureMatrix())}c.useBones&&c.computeBonesUsingShaders&&c.skeleton&&x.setMatrices("mBones",c.skeleton.getTransformMatrices(c))}g&&c.hasThinInstances&&x.setMatrix("world",u.getWorldMatrix()),c._processRendering(u,l,x,Q.TriangleFillMode,_,g,(S,b)=>{S||x.setMatrix("world",b)})}};let n;const a=new He(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(()=>{n=e.clearColor,e.clearColor=a}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(()=>{e.clearColor=n}),this._volumetricLightScatteringRTT.customIsReadyFunction=(l,h,c)=>{if((c||h===0)&&l.subMeshes)for(let u=0;u<l.subMeshes.length;++u){const d=l.subMeshes[u],f=d.getMaterial(),p=d.getRenderingMesh();if(!f)continue;const _=p._getInstancesRenderList(d._id,!!d.getReplacementMesh()),g=i.getCaps().instancedArrays&&(_.visibleInstances[d._id]!==null||p.hasThinInstances);if(!this._isReady(d,g))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(l,h,c,u)=>{const d=e.getEngine();let f;if(u.length){for(d.setColorWrite(!1),f=0;f<u.length;f++)r(u.data[f]);d.setColorWrite(!0)}for(f=0;f<l.length;f++)r(l.data[f]);for(f=0;f<h.length;f++)r(h.data[f]);if(c.length){for(f=0;f<c.length;f++){const _=c.data[f],g=_.getBoundingInfo();g&&e.activeCamera&&(_._alphaIndex=_.getMesh().alphaIndex,_._distanceToCamera=g.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const p=c.data.slice(0,c.length);for(p.sort((_,g)=>_._alphaIndex>g._alphaIndex?1:_._alphaIndex<g._alphaIndex?-1:_._distanceToCamera<g._distanceToCamera?1:_._distanceToCamera>g._distanceToCamera?-1:0),d.setAlphaMode(2),f=0;f<p.length;f++)r(p[f]);d.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;this.useCustomMeshPosition?i=this.customMeshPosition:this.attachedNode?i=this.attachedNode.position:i=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=m.Project(i,L.Identity(),t,this._viewPort);this._screenCoordinates.x=s.x/this._viewPort.width,this._screenCoordinates.y=s.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=$h(e,{size:1},t);i.billboardMode=pi.BILLBOARDMODE_ALL;const s=new oe(e+"Material",t);return s.emissiveColor=new J(1,1,1),i.material=s,i}}v([zi()],us.prototype,"customMeshPosition",void 0);v([M()],us.prototype,"useCustomMeshPosition",void 0);v([M()],us.prototype,"invert",void 0);v([Rf()],us.prototype,"mesh",void 0);v([M()],us.prototype,"excludedMeshes",void 0);v([M()],us.prototype,"includedMeshes",void 0);v([M()],us.prototype,"exposure",void 0);v([M()],us.prototype,"decay",void 0);v([M()],us.prototype,"weight",void 0);v([M()],us.prototype,"density",void 0);Re("BABYLON.VolumetricLightScatteringPostProcess",us);function hB(o){for(var e=-1,t=o==null?0:o.length,i=0,s=[];++e<t;){var r=o[e];r&&(s[i++]=r)}return s}var cB=hB;const uB=Gf(cB);var dB=Object.defineProperty,fB=Object.getOwnPropertyDescriptor,vr=(o,e,t,i)=>{for(var s=i>1?void 0:i?fB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&dB(e,t,s),s};class ar extends Bi{constructor(){super(),this.camera=null,this.source=null,this.excluded=null,this.exposure=null,this.decay=null,this.weight=null,this.density=null,this._camera=null,this._source=null,this._excluded=null,new Hr(this,"camera","_camera",null),new Hr(this,"source","_source",null),new D1(this,"excluded","_excluded")}connected(){super.connected(),this.entity=new us(this.id,1,this.scene.activeCamera,void 0,void 0,void 0,this.scene.getEngine(),void 0,this.scene),this.entity.mesh.setEnabled(!1)}willUpdate(e){var t,i,s;super.willUpdate(e),this.entity&&(e.has("_camera")&&((t=this._camera)!=null&&t.entity)&&(this.entity.dispose(this.entity.getCamera()),this.entity=null,this.entity=new us(this.id,1,this._camera.entity,void 0,void 0,void 0,this.scene.getEngine(),void 0,this.scene)),e.has("_source")&&((i=this._source)!=null&&i.entity)&&(this.entity.mesh=(s=this._source)==null?void 0:s.entity),e.has("exposure")&&this.evaluated.exposure&&(this.entity.exposure=this.evaluated.exposure),e.has("decay")&&this.evaluated.decay&&(this.entity.decay=this.evaluated.decay),e.has("weight")&&this.evaluated.weight&&(this.entity.weight=this.evaluated.weight),e.has("density")&&this.evaluated.density&&(this.entity.density=this.evaluated.density),e.has("_excluded")&&this._excluded&&(this.entity.excludedMeshes=uB(this._excluded.map(r=>r.entity))))}disconnected(){super.disconnected(),this.entity&&this.entity.dispose(this.entity.getCamera()),this.entity=null}}vr([$.property("String","camera",null)],ar.prototype,"camera",2);vr([$.property("String","source",null)],ar.prototype,"source",2);vr([$.property("String","excluded",null)],ar.prototype,"excluded",2);vr([$.property("Number","exposure",null)],ar.prototype,"exposure",2);vr([$.property("Number","decay",null)],ar.prototype,"decay",2);vr([$.property("Number","weight",null)],ar.prototype,"weight",2);vr([$.property("Number","density",null)],ar.prototype,"density",2);vr([Ss()],ar.prototype,"_camera",2);vr([Ss()],ar.prototype,"_source",2);vr([Ss()],ar.prototype,"_excluded",2);function i_(o){const e=[],t=[],i=[],s=[],r=o.diameter||1,n=o.thickness||.5,a=(o.tessellation||16)|0,l=o.sideOrientation===0?0:o.sideOrientation||fe.DEFAULTSIDE,h=a+1;for(let u=0;u<=a;u++){const d=u/a,f=u*Math.PI*2/a-Math.PI/2,p=L.Translation(r/2,0,0).multiply(L.RotationY(f));for(let _=0;_<=a;_++){const g=1-_/a,E=_*Math.PI*2/a+Math.PI,R=Math.cos(E),x=Math.sin(E);let S=new m(R,x,0),b=S.scale(n/2);const y=new Ke(d,g);b=m.TransformCoordinates(b,p),S=m.TransformNormal(S,p),t.push(b.x,b.y,b.z),i.push(S.x,S.y,S.z),s.push(y.x,Dt.UseOpenGLOrientationForUV?1-y.y:y.y);const I=(u+1)%h,O=(_+1)%h;e.push(u*h+_),e.push(u*h+O),e.push(I*h+_),e.push(u*h+O),e.push(I*h+O),e.push(I*h+_)}}fe._ComputeSides(l,t,e,i,s,o.frontUVs,o.backUVs);const c=new fe;return c.indices=e,c.positions=t,c.normals=i,c.uvs=s,c}function Ef(o,e={},t){const i=new re(o,t);return e.sideOrientation=re._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,i_(e).applyToMesh(i,e.updatable),i}fe.CreateTorus=i_;re.CreateTorus=(o,e,t,i,s,r,n)=>Ef(o,{diameter:e,thickness:t,tessellation:i,sideOrientation:n,updatable:r},s);var _B=Object.defineProperty,pB=Object.getOwnPropertyDescriptor,ei=(o,e,t,i)=>{for(var s=i>1?void 0:i?pB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&_B(e,t,s),s};const u_=class u_ extends Bi{constructor(){super(),this.type=null,this.size=null,this.width=null,this.height=null,this.depth=null,this.sideOrientation=null,this.frontUVs=null,this.backUVs=null,this.wrap=null,this.topBaseAt=null,this.bottomBaseAt=null,this.segments=null,this.diameter=null,this.diameterX=null,this.diameterY=null,this.diameterZ=null,this.arc=null,this.slice=null,this.dedupTopBottomIndices=null,this.diameterTop=null,this.diameterBottom=null,this.tessellation=null,this.subdivisions=null,this.hasRings=null,this.enclose=null,this.cap=null,this.thickness=null}connected(){super.connected(),this.entity=new Ai(this.id,this.scene,void 0,!0),this.scene.addGeometry(this.entity)}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}willUpdate(e){if(super.willUpdate(e),!this.entity)return;const t={...this.evaluated};if(!(!t.type||!md[t.type])&&(e.has("type")||md[t.type].props.some(i=>e.has(i)))){const i=md[t.type].factory(t);this.entity.setAllVerticesData(i,!0)}}};u_.requiredAttrs=["id","type"];let kt=u_;ei([$.property("String","type","box")],kt.prototype,"type",2);ei([$.property("Number","size",null)],kt.prototype,"size",2);ei([$.property("Number","width",null)],kt.prototype,"width",2);ei([$.property("Number","height",null)],kt.prototype,"height",2);ei([$.property("Number","depth",null)],kt.prototype,"depth",2);ei([$.property("Number","side-orientation",null)],kt.prototype,"sideOrientation",2);ei([$.property("Vector4","front-uvs",null)],kt.prototype,"frontUVs",2);ei([$.property("Vector4","back-uvs",null)],kt.prototype,"backUVs",2);ei([$.property("Boolean","wrap",null)],kt.prototype,"wrap",2);ei([$.property("Number","top-base-at",null)],kt.prototype,"topBaseAt",2);ei([$.property("Number","bottom-base-at",null)],kt.prototype,"bottomBaseAt",2);ei([$.property("Number","segments",null)],kt.prototype,"segments",2);ei([$.property("Number","diameter",null)],kt.prototype,"diameter",2);ei([$.property("Number","diameter-x",null)],kt.prototype,"diameterX",2);ei([$.property("Number","diameter-y",null)],kt.prototype,"diameterY",2);ei([$.property("Number","diameter-z",null)],kt.prototype,"diameterZ",2);ei([$.property("Number","arc",null)],kt.prototype,"arc",2);ei([$.property("Number","slice",null)],kt.prototype,"slice",2);ei([$.property("Boolean","dedup-top-bottom-indices",null)],kt.prototype,"dedupTopBottomIndices",2);ei([$.property("Number","diameter-top",null)],kt.prototype,"diameterTop",2);ei([$.property("Number","diameter-bottom",null)],kt.prototype,"diameterBottom",2);ei([$.property("Number","tessellation",null)],kt.prototype,"tessellation",2);ei([$.property("Number","subdivisions",null)],kt.prototype,"subdivisions",2);ei([$.property("Boolean","has-rings",null)],kt.prototype,"hasRings",2);ei([$.property("Boolean","enclose",null)],kt.prototype,"enclose",2);ei([$.property("Number","cap",null)],kt.prototype,"cap",2);ei([$.property("Number","thickness",null)],kt.prototype,"thickness",2);const md={box:{props:["size","width","height","depth","sideOrientation","frontUVs","backUVs","wrap","topBaseAt","bottomBaseAt"],factory:qc},sphere:{props:["diameter","diameterX","diameterY","diameterZ","arc","slice","sideOrientation","frontUVs","backUVs","dedupTopBottomIndices"],factory:Yf},disc:{props:["radius","tessellation","sideOrientation","frontUVs","backUVs"],factory:Kf},cylinder:{props:["height","diameterTop","diameterBottom","tessellation","subdivisions","hasRings","enclose","cap","sideOrientation","frontUVs","backUVs"],factory:Wf},plane:{props:["size","width","height","sideOrientation","frontUVs","backUVs"],factory:Xf},torus:{props:["diameter","thickness","tessellation","sideOrientation","frontUVs","backUVs"],factory:i_}};var gB=Object.defineProperty,mB=Object.getOwnPropertyDescriptor,Fn=(o,e,t,i)=>{for(var s=i>1?void 0:i?mB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&gB(e,t,s),s};class jr extends Bi{constructor(){super(),this.position=null,this.rotation=null,this.points=null,this.colors=null,this.disablePointerEvent=null,this.layer=null,this.quaternion=null,this.scale=null,this._curPointCount=0,new jh(this)}connected(){super.connected(),this.entity=qa(this.id,{points:[new m(0,0,0)],colors:[new He(1,1,1,1)],updatable:!0,useVertexAlpha:!0},this.scene),this.entity.parent=Gs.closestTransformNodeLike(this),this._curPointCount=0}disconnected(){super.disconnected(),this.entity&&this.entity.dispose(),this.entity=null,this._curPointCount=0}willUpdate(e){if(super.willUpdate(e),!!this.entity){if((e.has("points")||e.has("colors"))&&this.evaluated.points){const t=this.evaluated.points.split(",").map(r=>r.trim()).filter(Boolean).map(r=>r.split(" ").map(n=>n.trim()).filter(Boolean)).map(r=>new m(Number(r[0]),Number(r[1]),Number(r[2]))),i=this.evaluated.colors?this.evaluated.colors.split(",").map(r=>r.trim()).map(r=>He.FromHexString(r)):[];if(i.length<t.length){const r=i[i.length-1]||new He(1,1,1,1);for(let n=i.length;n<t.length;n++)i[n]=r.clone()}t.length!==this._curPointCount?(this._curPointCount=t.length,this.entity.dispose(),this.entity=qa(this.id,{points:t,colors:i,updatable:!0,useVertexAlpha:!0},this.scene),this.entity.parent=Gs.closestTransformNodeLike(this)):qa(this.id,{points:t,colors:i,instance:this.entity})}e.has("disablePointerEvent")&&(this.entity.isPickable=!this.disablePointerEvent)}}}Fn([$.property("Vector3","position",null)],jr.prototype,"position",2);Fn([$.property("Vector3","rotation",null)],jr.prototype,"rotation",2);Fn([$.property("String","points",null)],jr.prototype,"points",2);Fn([$.property("String","colors",null)],jr.prototype,"colors",2);Fn([$.property("Boolean","disable-pointer-event",null)],jr.prototype,"disablePointerEvent",2);Fn([$.property("Number","layer",null)],jr.prototype,"layer",2);Fn([$.property("Quaternion","quaternion",null)],jr.prototype,"quaternion",2);Fn([$.property("Vector3","scale",m.One())],jr.prototype,"scale",2);var EB=Object.defineProperty,TB=Object.getOwnPropertyDescriptor,Ar=(o,e,t,i)=>{for(var s=i>1?void 0:i?TB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&EB(e,t,s),s};class or extends Bi{constructor(){super(),this.geometry=null,this.material=null,this.position=null,this.rotation=null,this.quaternion=null,this.scale=null,this.disablePointerEvent=null,this.layer=null,this._geometry=null,this._material=null,new jh(this),new Hr(this,"geometry","_geometry","xr-geometry"),new Hr(this,"material","_material",e=>e.el||"xr-material")}connected(){super.connected(),this.entity=new re(this.id,this.scene,Gs.closestTransformNodeLike(this))}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}willUpdate(e){var t;super.willUpdate(e),this.entity&&(e.has("_geometry")&&this._geometry&&this._geometry.entity&&(this._geometry.entity.applyToMesh(this.entity),this.emit("loadeddata",{})),e.has("_material")&&(this.entity.material=((t=this._material)==null?void 0:t.entity)||this.scene.defaultMaterial),e.has("disablePointerEvent")&&(this.entity.isPickable=!this.disablePointerEvent))}}Ar([$.property("String","geometry",null)],or.prototype,"geometry",2);Ar([$.property("String","material",null)],or.prototype,"material",2);Ar([$.property("Vector3","position",null)],or.prototype,"position",2);Ar([$.property("Vector3","rotation",null)],or.prototype,"rotation",2);Ar([$.property("Quaternion","quaternion",null)],or.prototype,"quaternion",2);Ar([$.property("Vector3","scale",m.One())],or.prototype,"scale",2);Ar([$.property("Boolean","disable-pointer-event",null)],or.prototype,"disablePointerEvent",2);Ar([$.property("Number","layer",null)],or.prototype,"layer",2);Ar([Ss()],or.prototype,"_geometry",2);Ar([Ss()],or.prototype,"_material",2);var vB=Object.defineProperty,AB=Object.getOwnPropertyDescriptor,ts=(o,e,t,i)=>{for(var s=i>1?void 0:i?AB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&vB(e,t,s),s};class qi extends Bi{constructor(){super(),this._container=null,this.src=null,this.position=null,this.rotation=null,this.quaternion=null,this.scale=null,this.disablePointerEvent=null,this.layer=null,this.extension=null,this.material=null,this.autoPlay=null,this.loop=null,this.flatShading=null,this.originTransform=null,this.preload=null,this._material=null,new jh(this),new Hr(this,"material","_material","xr-material")}connected(){super.connected();const e=this.id||"model:"+Hh();this.entity=new we(e,this.scene),this.entity.parent=Gs.closestTransformNodeLike(this)}disconnected(){super.disconnected(),this.entity&&(this.entity.dispose(),this.entity=null),this._container&&(this._container.dispose(),this._container=null)}async reloadModel(){this._container&&(this._container.dispose(),this._container=null),!(!this.src||this.disabled&&!this.preload||this.scene.isDisposed)&&this.scene.loadModel(this.src,this.extension||void 0).then(e=>{if(this.entity){e.addAllToScene(),this._container=e,e.transformNodes.push(this.entity);for(const t of e.rootNodes)t.parent=this.entity;for(const t of e.meshes)t instanceof re&&(this.originTransform&&t.bakeTransformIntoVertices(L.Invert(this.originTransform)),this.flatShading&&t.convertToFlatShadedMesh());if(this.autoPlay!==null){let t=[];if(this.autoPlay==="")t=e.animationGroups;else{const i=Vr.fromAttr("Array",this.autoPlay);t=e.animationGroups.filter(s=>i.includes(s.name))}for(const i of t)i.play(!!this.loop)}this.requestUpdate("_material"),this.requestUpdate("disabled"),this.performUpdate(),this.emit("loadeddata",{container:e})}})}willUpdate(e){var t;if(super.willUpdate(e),(e.has("src")||!this._container)&&this.reloadModel(),e.has("disabled")&&this._container)for(const i of[...this._container.meshes,...this._container.transformNodes])i.setEnabled(!this.disabled);if(e.has("_material")&&this._container&&((t=this._material)!=null&&t.entity))for(const i of this._container.meshes)i.material=this._material.entity}}ts([AE({context:Uc.AssetContainer}),Ss()],qi.prototype,"_container",2);ts([$.property("String","src",null)],qi.prototype,"src",2);ts([$.property("Vector3","position",null)],qi.prototype,"position",2);ts([$.property("Vector3","rotation",null)],qi.prototype,"rotation",2);ts([$.property("Quaternion","quaternion",null)],qi.prototype,"quaternion",2);ts([$.property("Vector3","scale",m.One())],qi.prototype,"scale",2);ts([$.property("Boolean","disable-pointer-event",null)],qi.prototype,"disablePointerEvent",2);ts([$.property("Number","layer",null)],qi.prototype,"layer",2);ts([$.property("String","extension",null)],qi.prototype,"extension",2);ts([$.property("String","material",null)],qi.prototype,"material",2);ts([$.property("String","auto-play",null)],qi.prototype,"autoPlay",2);ts([$.property("Boolean","loop",null)],qi.prototype,"loop",2);ts([$.property("Boolean","flat-shading",null)],qi.prototype,"flatShading",2);ts([$.property("Matrix","origin-transform",null)],qi.prototype,"originTransform",2);ts([$.property("Boolean","preload",null)],qi.prototype,"preload",2);ts([Ss()],qi.prototype,"_material",2);var RB=Object.defineProperty,bB=Object.getOwnPropertyDescriptor,Qh=(o,e,t,i)=>{for(var s=i>1?void 0:i?bB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&RB(e,t,s),s};class Il extends Bi{constructor(){super(),this.position=null,this.rotation=null,this.quaternion=null,this.scale=null,this.layer=null,new jh(this)}connected(){super.connected();const e=this.id||"Node:"+Hh();this.entity=new we(e,this.scene),this.entity.parent=Gs.closestTransformNodeLike(this)}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}}Qh([$.property("Vector3","position",null)],Il.prototype,"position",2);Qh([$.property("Vector3","rotation",null)],Il.prototype,"rotation",2);Qh([$.property("Quaternion","quaternion",null)],Il.prototype,"quaternion",2);Qh([$.property("Vector3","scale",m.One())],Il.prototype,"scale",2);Qh([$.property("Number","layer",null)],Il.prototype,"layer",2);const SB=new m(1,0,0),yB=new m(-1,0,0),CB=new m(0,1,0),xB=new m(0,-1,0),MB=new m(0,0,1),IB=new m(0,0,-1);class zc{constructor(e=m.Zero(),t=m.Up(),i=Ke.Zero(),s=0,r=0,n=null,a=null,l=null,h=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=s,this.vertexIdxForBones=r,this.localPositionOverride=n,this.localNormalOverride=a,this.matrixIndicesOverride=l,this.matrixWeightsOverride=h}clone(){var e,t,i,s;return new zc(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,(e=this.localPositionOverride)===null||e===void 0?void 0:e.slice(),(t=this.localNormalOverride)===null||t===void 0?void 0:t.slice(),(i=this.matrixIndicesOverride)===null||i===void 0?void 0:i.slice(),(s=this.matrixWeightsOverride)===null||s===void 0?void 0:s.slice())}}function KE(o,e,t){var i,s,r,n;const a=!!e.skeleton,l=t.localMode||a,h=e.overrideMaterialSideOrientation!==null&&e.overrideMaterialSideOrientation!==void 0,c=e.getIndices(),u=a?e.getPositionData(!0,!0):e.getVerticesData(T.PositionKind),d=a?e.getNormalsData(!0,!0):e.getVerticesData(T.NormalKind),f=l?a?e.getVerticesData(T.PositionKind):u:null,p=l?a?e.getVerticesData(T.NormalKind):d:null,_=e.getVerticesData(T.UVKind),g=a?e.getVerticesData(T.MatricesIndicesKind):null,E=a?e.getVerticesData(T.MatricesWeightsKind):null,R=a?e.getVerticesData(T.MatricesIndicesExtraKind):null,x=a?e.getVerticesData(T.MatricesWeightsExtraKind):null,S=t.position||m.Zero();let b=t.normal||m.Up();const y=t.size||m.One(),I=t.angle||0;if(!b){const ne=new m(0,0,1),Ue=e.getScene().activeCamera,Je=m.TransformCoordinates(ne,Ue.getWorldMatrix());b=Ue.globalPosition.subtract(Je)}const O=-Math.atan2(b.z,b.x)-Math.PI/2,N=Math.sqrt(b.x*b.x+b.z*b.z),w=Math.atan2(b.y,N),G=new fe;G.indices=[],G.positions=[],G.normals=[],G.uvs=[],G.matricesIndices=a?[]:null,G.matricesWeights=a?[]:null,G.matricesIndicesExtra=R?[]:null,G.matricesWeightsExtra=x?[]:null;let k=0;const de=(ne,Ue)=>{const Je=new zc;if(!c||!u||!d)return Je;const St=c[ne];if(Je.vertexIdx=St*3,Je.vertexIdxForBones=St*4,Je.position=new m(u[St*3],u[St*3+1],u[St*3+2]),m.TransformCoordinatesToRef(Je.position,Ue,Je.position),Je.normal=new m(d[St*3],d[St*3+1],d[St*3+2]),m.TransformNormalToRef(Je.normal,Ue,Je.normal),t.captureUVS&&_){const yt=_[St*2+1];Je.uv=new Ke(_[St*2],Dt.UseOpenGLOrientationForUV?1-yt:yt)}return Je},ae=[0,0,0,0],_e=(ne,Ue)=>{if(ne.length===0)return ne;const Je=.5*Math.abs(m.Dot(y,Ue)),St=(he,Ne,Qe,Me)=>{for(let at=0;at<Me;++at)if(he[Qe+at]===Ne)return Qe+at;return-1},yt=(he,Ne)=>{var Qe,Me,at,zt,Ht,ti,Ci,ui,_s,Zi,Jr,Sr,yr,Cr,Aa,Ra;const ps=m.GetClipFactor(he.position,Ne.position,Ue,Je);let Un=ae,ss=ae;if(g&&E){const kn=he.matrixIndicesOverride?0:he.vertexIdxForBones,Gl=(Qe=he.matrixIndicesOverride)!==null&&Qe!==void 0?Qe:g,oc=(Me=he.matrixWeightsOverride)!==null&&Me!==void 0?Me:E,zl=Ne.matrixIndicesOverride?0:Ne.vertexIdxForBones,lc=(at=Ne.matrixIndicesOverride)!==null&&at!==void 0?at:g,hc=(zt=Ne.matrixWeightsOverride)!==null&&zt!==void 0?zt:E;Un=[0,0,0,0],ss=[0,0,0,0];let xr=0;for(let gs=0;gs<4;++gs)if(oc[kn+gs]>0){const en=St(lc,Gl[kn+gs],zl,4);Un[xr]=Gl[kn+gs],ss[xr]=Te.Lerp(oc[kn+gs],en>=0?hc[en]:0,ps),xr++}for(let gs=0;gs<4&&xr<4;++gs){const en=lc[zl+gs];St(Gl,en,kn,4)===-1&&(Un[xr]=en,ss[xr]=Te.Lerp(0,hc[zl+gs],ps),xr++)}const ba=ss[0]+ss[1]+ss[2]+ss[3];ss[0]/=ba,ss[1]/=ba,ss[2]/=ba,ss[3]/=ba}const Nl=he.localPositionOverride?he.localPositionOverride[0]:(Ht=f==null?void 0:f[he.vertexIdx])!==null&&Ht!==void 0?Ht:0,Ll=he.localPositionOverride?he.localPositionOverride[1]:(ti=f==null?void 0:f[he.vertexIdx+1])!==null&&ti!==void 0?ti:0,Fl=he.localPositionOverride?he.localPositionOverride[2]:(Ci=f==null?void 0:f[he.vertexIdx+2])!==null&&Ci!==void 0?Ci:0,mu=Ne.localPositionOverride?Ne.localPositionOverride[0]:(ui=f==null?void 0:f[Ne.vertexIdx])!==null&&ui!==void 0?ui:0,Eu=Ne.localPositionOverride?Ne.localPositionOverride[1]:(_s=f==null?void 0:f[Ne.vertexIdx+1])!==null&&_s!==void 0?_s:0,ic=Ne.localPositionOverride?Ne.localPositionOverride[2]:(Zi=f==null?void 0:f[Ne.vertexIdx+2])!==null&&Zi!==void 0?Zi:0,wl=he.localNormalOverride?he.localNormalOverride[0]:(Jr=p==null?void 0:p[he.vertexIdx])!==null&&Jr!==void 0?Jr:0,sc=he.localNormalOverride?he.localNormalOverride[1]:(Sr=p==null?void 0:p[he.vertexIdx+1])!==null&&Sr!==void 0?Sr:0,rc=he.localNormalOverride?he.localNormalOverride[2]:(yr=p==null?void 0:p[he.vertexIdx+2])!==null&&yr!==void 0?yr:0,nc=Ne.localNormalOverride?Ne.localNormalOverride[0]:(Cr=p==null?void 0:p[Ne.vertexIdx])!==null&&Cr!==void 0?Cr:0,ac=Ne.localNormalOverride?Ne.localNormalOverride[1]:(Aa=p==null?void 0:p[Ne.vertexIdx+1])!==null&&Aa!==void 0?Aa:0,Tu=Ne.localNormalOverride?Ne.localNormalOverride[2]:(Ra=p==null?void 0:p[Ne.vertexIdx+2])!==null&&Ra!==void 0?Ra:0,Bl=wl+(nc-wl)*ps,Ul=sc+(ac-sc)*ps,kl=rc+(Tu-rc)*ps,Vl=Math.sqrt(Bl*Bl+Ul*Ul+kl*kl);return new zc(m.Lerp(he.position,Ne.position,ps),m.Lerp(he.normal,Ne.normal,ps).normalize(),Ke.Lerp(he.uv,Ne.uv,ps),-1,-1,f?[Nl+(mu-Nl)*ps,Ll+(Eu-Ll)*ps,Fl+(ic-Fl)*ps]:null,p?[Bl/Vl,Ul/Vl,kl/Vl]:null,Un,ss)};let tt=null;ne.length>3&&(tt=[]);for(let he=0;he<ne.length;he+=3){let Ne=0,Qe=null,Me=null,at=null,zt=null;const Ht=m.Dot(ne[he].position,Ue)-Je,ti=m.Dot(ne[he+1].position,Ue)-Je,Ci=m.Dot(ne[he+2].position,Ue)-Je,ui=Ht>0,_s=ti>0,Zi=Ci>0;switch(Ne=(ui?1:0)+(_s?1:0)+(Zi?1:0),Ne){case 0:ne.length>3?(tt.push(ne[he]),tt.push(ne[he+1]),tt.push(ne[he+2])):tt=ne;break;case 1:if(tt=tt??new Array,ui&&(Qe=ne[he+1],Me=ne[he+2],at=yt(ne[he],Qe),zt=yt(ne[he],Me)),_s){Qe=ne[he],Me=ne[he+2],at=yt(ne[he+1],Qe),zt=yt(ne[he+1],Me),tt.push(at),tt.push(Me.clone()),tt.push(Qe.clone()),tt.push(Me.clone()),tt.push(at.clone()),tt.push(zt);break}Zi&&(Qe=ne[he],Me=ne[he+1],at=yt(ne[he+2],Qe),zt=yt(ne[he+2],Me)),Qe&&Me&&at&&zt&&(tt.push(Qe.clone()),tt.push(Me.clone()),tt.push(at),tt.push(zt),tt.push(at.clone()),tt.push(Me.clone()));break;case 2:tt=tt??new Array,ui||(Qe=ne[he].clone(),Me=yt(Qe,ne[he+1]),at=yt(Qe,ne[he+2]),tt.push(Qe),tt.push(Me),tt.push(at)),_s||(Qe=ne[he+1].clone(),Me=yt(Qe,ne[he+2]),at=yt(Qe,ne[he]),tt.push(Qe),tt.push(Me),tt.push(at)),Zi||(Qe=ne[he+2].clone(),Me=yt(Qe,ne[he]),at=yt(Qe,ne[he+1]),tt.push(Qe),tt.push(Me),tt.push(at));break}}return tt},Ce=e instanceof re?e:null,ce=Ce==null?void 0:Ce._thinInstanceDataStorage.matrixData,ze=(Ce==null?void 0:Ce.thinInstanceCount)||1,We=D.Matrix[0];We.copyFrom(L.IdentityReadOnly);for(let ne=0;ne<ze;++ne){if(Ce!=null&&Ce.hasThinInstances&&ce){const he=ne*16;We.setRowFromFloats(0,ce[he+0],ce[he+1],ce[he+2],ce[he+3]),We.setRowFromFloats(1,ce[he+4],ce[he+5],ce[he+6],ce[he+7]),We.setRowFromFloats(2,ce[he+8],ce[he+9],ce[he+10],ce[he+11]),We.setRowFromFloats(3,ce[he+12],ce[he+13],ce[he+14],ce[he+15])}const Ue=L.RotationYawPitchRoll(O,w,I).multiply(L.Translation(S.x,S.y,S.z)),Je=L.Invert(Ue),St=e.getWorldMatrix(),yt=We.multiply(St).multiply(Je),tt=new Array(3);for(let he=0;he<c.length;he+=3){let Ne=tt;if(Ne[0]=de(he,yt),h&&l?(Ne[1]=de(he+2,yt),Ne[2]=de(he+1,yt)):(Ne[1]=de(he+1,yt),Ne[2]=de(he+2,yt)),!(t.cullBackFaces&&-Ne[0].normal.z<=0&&-Ne[1].normal.z<=0&&-Ne[2].normal.z<=0)&&(Ne=_e(Ne,SB),!!Ne&&(Ne=_e(Ne,yB),!!Ne&&(Ne=_e(Ne,CB),!!Ne&&(Ne=_e(Ne,xB),!!Ne&&(Ne=_e(Ne,MB),!!Ne&&(Ne=_e(Ne,IB),!!Ne)))))))for(let Qe=0;Qe<Ne.length;Qe++){const Me=Ne[Qe];if(G.indices.push(k),l?(Me.localPositionOverride?(G.positions[k*3]=Me.localPositionOverride[0],G.positions[k*3+1]=Me.localPositionOverride[1],G.positions[k*3+2]=Me.localPositionOverride[2]):f&&(G.positions[k*3]=f[Me.vertexIdx],G.positions[k*3+1]=f[Me.vertexIdx+1],G.positions[k*3+2]=f[Me.vertexIdx+2]),Me.localNormalOverride?(G.normals[k*3]=Me.localNormalOverride[0],G.normals[k*3+1]=Me.localNormalOverride[1],G.normals[k*3+2]=Me.localNormalOverride[2]):p&&(G.normals[k*3]=p[Me.vertexIdx],G.normals[k*3+1]=p[Me.vertexIdx+1],G.normals[k*3+2]=p[Me.vertexIdx+2])):(Me.position.toArray(G.positions,k*3),Me.normal.toArray(G.normals,k*3)),G.matricesIndices&&G.matricesWeights&&(Me.matrixIndicesOverride?(G.matricesIndices[k*4]=Me.matrixIndicesOverride[0],G.matricesIndices[k*4+1]=Me.matrixIndicesOverride[1],G.matricesIndices[k*4+2]=Me.matrixIndicesOverride[2],G.matricesIndices[k*4+3]=Me.matrixIndicesOverride[3]):(g&&(G.matricesIndices[k*4]=g[Me.vertexIdxForBones],G.matricesIndices[k*4+1]=g[Me.vertexIdxForBones+1],G.matricesIndices[k*4+2]=g[Me.vertexIdxForBones+2],G.matricesIndices[k*4+3]=g[Me.vertexIdxForBones+3]),R&&G.matricesIndicesExtra&&(G.matricesIndicesExtra[k*4]=R[Me.vertexIdxForBones],G.matricesIndicesExtra[k*4+1]=R[Me.vertexIdxForBones+1],G.matricesIndicesExtra[k*4+2]=R[Me.vertexIdxForBones+2],G.matricesIndicesExtra[k*4+3]=R[Me.vertexIdxForBones+3])),Me.matrixWeightsOverride?(G.matricesWeights[k*4]=Me.matrixWeightsOverride[0],G.matricesWeights[k*4+1]=Me.matrixWeightsOverride[1],G.matricesWeights[k*4+2]=Me.matrixWeightsOverride[2],G.matricesWeights[k*4+3]=Me.matrixWeightsOverride[3]):(E&&(G.matricesWeights[k*4]=E[Me.vertexIdxForBones],G.matricesWeights[k*4+1]=E[Me.vertexIdxForBones+1],G.matricesWeights[k*4+2]=E[Me.vertexIdxForBones+2],G.matricesWeights[k*4+3]=E[Me.vertexIdxForBones+3]),x&&G.matricesWeightsExtra&&(G.matricesWeightsExtra[k*4]=x[Me.vertexIdxForBones],G.matricesWeightsExtra[k*4+1]=x[Me.vertexIdxForBones+1],G.matricesWeightsExtra[k*4+2]=x[Me.vertexIdxForBones+2],G.matricesWeightsExtra[k*4+3]=x[Me.vertexIdxForBones+3]))),t.captureUVS)Me.uv.toArray(G.uvs,k*2);else{G.uvs.push(.5+Me.position.x/y.x);const at=.5+Me.position.y/y.y;G.uvs.push(Dt.UseOpenGLOrientationForUV?1-at:at)}k++}}}G.indices.length===0&&(G.indices=null),G.positions.length===0&&(G.positions=null),G.normals.length===0&&(G.normals=null),G.uvs.length===0&&(G.uvs=null),((i=G.matricesIndices)===null||i===void 0?void 0:i.length)===0&&(G.matricesIndices=null),((s=G.matricesWeights)===null||s===void 0?void 0:s.length)===0&&(G.matricesWeights=null),((r=G.matricesIndicesExtra)===null||r===void 0?void 0:r.length)===0&&(G.matricesIndicesExtra=null),((n=G.matricesWeightsExtra)===null||n===void 0?void 0:n.length)===0&&(G.matricesWeightsExtra=null);const nt=new re(o,e.getScene());return G.applyToMesh(nt),l?(nt.skeleton=e.skeleton,nt.parent=e):(nt.position=S.clone(),nt.rotation=new m(w,O,I)),nt.computeWorldMatrix(!0),nt.refreshBoundingInfo(!0,!0),nt}re.CreateDecal=(o,e,t,i,s,r)=>KE(o,e,{position:t,normal:i,size:s,angle:r});var PB=Object.defineProperty,DB=Object.getOwnPropertyDescriptor,qr=(o,e,t,i)=>{for(var s=i>1?void 0:i?DB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&PB(e,t,s),s};class Rr extends Bi{constructor(){super(),this.position=null,this.rotation=null,this.quaternion=null,this.scale=null,this.layer=null,this.img=null,this.imgLevel=null,this.useRay=null,this.rayScope="scene",this._lastTargetMesh=null,this._decal=null,this._projector=null,this._material=null,this._texture=null,this._ray=null,this._rayHelper=null,this._sceneEle=null,this._handleSceneElementLoaded=e=>{e.target instanceof yn&&e.target.entity&&e.target.entity===this._lastTargetMesh&&this.reload()},new jh(this)}connected(){super.connected(),this.entity=new we("decal_"+this.id,this.scene),this._texture=new V(this.img||null,this.scene),this._texture.hasAlpha=!0,this._material=new oe("decal_material",this.scene),this._material.backFaceCulling=!1,this._material.zOffset=-2,this._material.diffuseTexture=this._texture,this._material.emissiveTexture=this._texture,this._material.disableLighting=!0,this._sceneEle=this.closest("xr-scene"),this._sceneEle&&this._sceneEle.addEventListener("loadeddata",this._handleSceneElementLoaded)}reload(){var l,h,c,u,d;this._decal&&(this._decal.dispose(),this._decal=null,this._lastTargetMesh=null);const e=((l=this.evaluated.position)==null?void 0:l.clone())||m.Zero(),t=this.evaluated.quaternion||le.FromEulerAnglesToRef((((h=this.evaluated.rotation)==null?void 0:h.x)||0)*Math.PI/180,(((c=this.evaluated.rotation)==null?void 0:c.y)||0)*Math.PI/180,(((u=this.evaluated.rotation)==null?void 0:u.z)||0)*Math.PI/180,D.Quaternion[0]),i=m.Forward().applyRotationQuaternion(t).normalize(),s=((d=this.evaluated.scale)==null?void 0:d.clone())||m.One(),r=t.toEulerAnglesToRef(D.Vector3[0]).z,n=Gs.closestTransformNodeLike(this);if(n){const f=n.getWorldMatrix();m.TransformCoordinatesToRef(e,f,e),m.TransformNormalToRef(i,f,i)}let a=null;if(this.useRay){this._ray||(this._ray=new lt(m.Zero(),m.Zero(),1)),this._ray.direction.copyFrom(i),this._ray.length=s.z,e.addToRef(i.scale(-this._ray.length/2),this._ray.origin);const f=new Set((this.rayScope==="parent"&&n?n.getChildMeshes(!1):this.scene.meshes).filter(_=>_.isPickable&&_.isVisible&&_.isEnabled()&&_.visibility>0)),p=this.scene.pickWithRay(this._ray,_=>f.has(_));p!=null&&p.pickedMesh&&p.pickedMesh instanceof re&&(a=p.pickedMesh)}else this._ray=null,n&&n instanceof re&&(a=n);if(a){this._lastTargetMesh=a;const f=this.id||Hh();this._decal=KE("decal_"+f,a,{localMode:!0,position:e,normal:i.scale(-1),size:s,angle:r,cullBackFaces:!0}),this._decal.material=this._material}this._updateProjector(e,i,s,r),this._updateRayHelper()}willUpdate(e){super.willUpdate(e),(e.has("scale")||e.has("position")||e.has("rotation")||e.has("quaternion")||e.has("useRay")||e.has("rayScope"))&&this.reload(),this._texture&&(e.has("img")&&this._texture.updateURL(this.evaluated.img||""),this._texture.level=this.evaluated.imgLevel||1)}_updateProjector(e,t,i,s){if(this.inspect&&!this._projector&&(this._projector=Df("projector",{size:1},this.scene),this._projector.enableEdgesRendering(.99),this._projector.edgesWidth=2,this._projector.visibility=.001,this._projector.isPickable=!1),!this.inspect&&this._projector&&(this._projector.dispose(!1,!0),this._projector=null),this.inspect&&this._projector){this._projector.position.copyFrom(e),this._projector.scaling.copyFrom(i);const r=this.inspect.color||"#ff0000";this._projector.edgesColor=He.FromHexString(r);const n=t.scale(-1),a=-Math.atan2(n.z,n.x)-Math.PI/2,l=Math.sqrt(n.x*n.x+n.z*n.z),h=Math.atan2(n.y,l);this._projector.rotation.set(h,a,s)}}_updateRayHelper(){this.inspect&&this._ray&&!this._rayHelper&&(this._rayHelper=new cu(this._ray)),!this.inspect&&this._rayHelper&&(this._rayHelper.dispose(),this._rayHelper=null),this.inspect&&this._rayHelper&&this._rayHelper.show(this.scene.defaultUtilityLayer.utilityLayerScene,J.FromHexString(this.inspect.color||"#ff0000"))}disconnected(){super.disconnected(),this._material&&this._material.dispose(),this._material=null,this._texture&&this._texture.dispose(),this._texture=null,this.entity&&this.entity.dispose(),this.entity=null,this._projector&&this._projector.dispose(),this._projector=null,this._ray=null,this._rayHelper&&this._rayHelper.dispose(),this._rayHelper=null,this._decal&&(this._decal.dispose(),this._decal=null),this._lastTargetMesh=null,this._sceneEle&&(this._sceneEle.removeEventListener("loadeddata",this._handleSceneElementLoaded),this._sceneEle=null)}}qr([$.property("Vector3","position",null)],Rr.prototype,"position",2);qr([$.property("Vector3","rotation",null)],Rr.prototype,"rotation",2);qr([$.property("Quaternion","quaternion",null)],Rr.prototype,"quaternion",2);qr([$.property("Vector3","scale",m.One())],Rr.prototype,"scale",2);qr([$.property("Number","layer",null)],Rr.prototype,"layer",2);qr([$.property("String","img",null)],Rr.prototype,"img",2);qr([$.property("Number","img-level",null)],Rr.prototype,"imgLevel",2);qr([$.property("Boolean","use-ray",null)],Rr.prototype,"useRay",2);qr([$.property("String","ray-scope","scene")],Rr.prototype,"rayScope",2);class dh extends jt{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}static _CreatePlane(e,t){const i=new we("plane",e),s=$h("dragPlane",{width:.1375,height:.1375,sideOrientation:2},e);return s.material=t,s.parent=i,i}constructor(e,t=J.Gray(),i=Yt.DefaultUtilityLayer,s=null,r=J.Yellow(),n=J.Gray()){var a;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new j,this._isEnabled=!1,this._parent=null,this._dragging=!1,this._parent=s,this._coloredMaterial=new oe("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new J(.1,.1,.1)),this._hoverMaterial=new oe("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=r,this._disableMaterial=new oe("",i.utilityLayerScene),this._disableMaterial.diffuseColor=n,this._disableMaterial.alpha=.4,this._gizmoMesh=dh._CreatePlane(i.utilityLayerScene,this._coloredMaterial),this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._gizmoMesh.scaling.scaleInPlace(1/3),this._gizmoMesh.parent=this._rootMesh;let l=0;const h=new m,c={snapDistance:0};this.dragBehavior=new Xi({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this._rootMesh.addBehavior(this.dragBehavior),this.dragBehavior.onDragObservable.add(f=>{if(this.attachedNode){if(this.snapDistance==0)this.attachedNode.getWorldMatrix().getTranslationToRef(D.Vector3[0]),D.Vector3[0].addToRef(f.delta,D.Vector3[0]),this.dragBehavior.validateDrag(D.Vector3[0])&&this.attachedNode.getWorldMatrix().addTranslationFromFloats(f.delta.x,f.delta.y,f.delta.z);else if(l+=f.dragDistance,Math.abs(l)>this.snapDistance){const p=Math.floor(Math.abs(l)/this.snapDistance);l=l%this.snapDistance,f.delta.normalizeToRef(h),h.scaleInPlace(this.snapDistance*p),this.attachedNode.getWorldMatrix().getTranslationToRef(D.Vector3[0]),D.Vector3[0].addToRef(h,D.Vector3[0]),this.dragBehavior.validateDrag(D.Vector3[0])&&(this.attachedNode.getWorldMatrix().addTranslationFromFloats(h.x,h.y,h.z),c.snapDistance=this.snapDistance*p,this.onSnapObservable.notifyObservers(c))}this._matrixChanged()}}),this.dragBehavior.onDragStartObservable.add(()=>{this._dragging=!0}),this.dragBehavior.onDragEndObservable.add(()=>{this._dragging=!1});const u=i._getSharedGizmoLight();u.includedOnlyMeshes=u.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const d={gizmoMeshes:this._gizmoMesh.getChildMeshes(),colliderMeshes:this._gizmoMesh.getChildMeshes(),material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};(a=this._parent)===null||a===void 0||a.addToAxisCache(this._gizmoMesh,d),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(f=>{var p;if(!this._customMeshSet&&(this._isHovered=d.colliderMeshes.indexOf((p=f==null?void 0:f.pickInfo)===null||p===void 0?void 0:p.pickedMesh)!=-1,!this._parent)){const _=d.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(d.gizmoMeshes,_)}}),this.dragBehavior.onEnabledObservable.add(f=>{this._setGizmoMeshMaterial(d.gizmoMeshes,f?this._coloredMaterial:this._disableMaterial)})}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedNode=this._parent.attachedNode):this.attachedNode=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),super.dispose(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()})}}class OB extends jt{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null})}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null})}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered||this.xPlaneGizmo.isHovered||this.yPlaneGizmo.isHovered||this.zPlaneGizmo.isHovered}constructor(e=Yt.DefaultUtilityLayer,t=1,i){super(e),this._meshAttached=null,this._nodeAttached=null,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new j,this.onDragObservable=new j,this.onDragEndObservable=new j,this._planarGizmoEnabled=!1,this.xGizmo=new ks(new m(1,0,0),J.Red().scale(.5),e,this,t),this.yGizmo=new ks(new m(0,1,0),J.Green().scale(.5),e,this,t),this.zGizmo=new ks(new m(0,0,1),J.Blue().scale(.5),e,this,t),this.xPlaneGizmo=new dh(new m(1,0,0),J.Red().scale(.5),this.gizmoLayer,this),this.yPlaneGizmo=new dh(new m(0,1,0),J.Green().scale(.5),this.gizmoLayer,this),this.zPlaneGizmo=new dh(new m(0,0,1),J.Blue().scale(.5),this.gizmoLayer,this),[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(s=>{s.dragBehavior.onDragStartObservable.add(()=>{this.onDragStartObservable.notifyObservers({})}),s.dragBehavior.onDragObservable.add(()=>{this.onDragObservable.notifyObservers({})}),s.dragBehavior.onDragEndObservable.add(()=>{this.onDragEndObservable.notifyObservers({})})}),this.attachedMesh=null,i?i.addToAxisCache(this._gizmoAxisCache):jt.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set planarGizmoEnabled(e){this._planarGizmoEnabled=e,[this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t&&(t.isEnabled=e,e&&(t.attachedMesh?t.attachedMesh=this.attachedMesh:t.attachedNode=this.attachedNode))},this)}get planarGizmoEnabled(){return this._planarGizmoEnabled}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t&&(t.customRotationQuaternion=e)})}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)})}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t&&(t.updateGizmoPositionToMatchAttachedMesh=e)})}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t.anchorPoint=e})}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t.coordinatesMode=e})}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t&&(t.snapDistance=e)})}get snapDistance(){return this._snapDistance}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(t=>{t&&(t.scaleRatio=e)})}get scaleRatio(){return this._scaleRatio}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.xPlaneGizmo,this.yPlaneGizmo,this.zPlaneGizmo].forEach(e=>{e&&e.dispose()}),this._observables.forEach(e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)}),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear()}setCustomMesh(){q.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo,gizmo.xPlaneGizmo, gizmo.yPlaneGizmo, gizmo.zPlaneGizmo)")}}class er extends jt{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}set rotationColor(e){this._rotationShaderMaterial.setColor3("rotationColor",e)}get disableMaterial(){return this._disableMaterial}constructor(e,t=J.Gray(),i=Yt.DefaultUtilityLayer,s=32,r=null,n=!1,a=1,l=J.Yellow(),h=J.Gray()){var c;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new j,this.angle=0,this.sensitivity=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new m,this._parent=r,this._coloredMaterial=new oe("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new J(.1,.1,.1)),this._hoverMaterial=new oe("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=l,this._hoverMaterial.specularColor=l,this._disableMaterial=new oe("",i.utilityLayerScene),this._disableMaterial.diffuseColor=h,this._disableMaterial.alpha=.4,this._gizmoMesh=new re("",i.utilityLayerScene);const{rotationMesh:u,collider:d}=this._createGizmoMesh(this._gizmoMesh,a,s);this._rotationDisplayPlane=$h("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=Math.PI*.5,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),ai.ShadersStore.rotationGizmoVertexShader=er._RotationGizmoVertexShader,ai.ShadersStore.rotationGizmoFragmentShader=er._RotationGizmoFragmentShader,this._rotationShaderMaterial=new Rs("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles","rotationColor"]}),this._rotationShaderMaterial.backFaceCulling=!1,this.rotationColor=l,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,jt.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new Xi({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=er.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);const f=new m,p=new L,_=new m;let g=new m;this.dragBehavior.onDragStartObservable.add(I=>{this.attachedNode&&(f.copyFrom(I.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(p),m.TransformCoordinatesToRef(I.dragPlanePoint,p,f),this._angles.x=Math.atan2(f.y,f.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,f.copyFrom(I.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)}),this.dragBehavior.onDragEndObservable.add(()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)});const E={snapDistance:0};let R=0;const x=new L,S=new le;this.dragBehavior.onDragObservable.add(I=>{if(this.attachedNode){const O=new m(1,1,1),N=new le(0,0,0,1),w=new m(0,0,0);if(this.attachedNode.getWorldMatrix().decompose(O,N,w),!(Math.abs(Math.abs(O.x)-Math.abs(O.y))<=dt&&Math.abs(Math.abs(O.x)-Math.abs(O.z))<=dt)&&this.updateGizmoRotationToMatchAttachedMesh){q.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");return}N.normalize();const k=this.updateGizmoPositionToMatchAttachedMesh?w:this._rootMesh.absolutePosition,de=I.dragPlanePoint.subtract(k).normalize(),ae=f.subtract(k).normalize(),_e=m.Cross(de,ae),Ce=m.Dot(de,ae);let ce=Math.atan2(_e.length(),Ce)*this.sensitivity;_.copyFrom(e),g.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(N.toRotationMatrix(p),g=m.TransformCoordinates(_,p));let ze=!1;if(i.utilityLayerScene.activeCamera){const Ue=i.utilityLayerScene.activeCamera.position.subtract(k).normalize();m.Dot(Ue,g)>0&&(_.scaleInPlace(-1),g.scaleInPlace(-1),ze=!0)}m.Dot(g,_e)>0&&(ce=-ce),D.Vector3[0].set(ce,0,0),this.dragBehavior.validateDrag(D.Vector3[0])||(ce=0);let nt=!1;if(this.snapDistance!=0)if(R+=ce,Math.abs(R)>this.snapDistance){let Ue=Math.floor(Math.abs(R)/this.snapDistance);R<0&&(Ue*=-1),R=R%this.snapDistance,ce=this.snapDistance*Ue,nt=!0}else ce=0;const ne=Math.sin(ce/2);if(S.set(_.x*ne,_.y*ne,_.z*ne,Math.cos(ce/2)),x.determinant()>0){const Ue=new m;S.toEulerAnglesToRef(Ue),le.RotationYawPitchRollToRef(Ue.y,-Ue.x,-Ue.z,S)}if(this.updateGizmoRotationToMatchAttachedMesh)N.multiplyToRef(S,N),N.normalize(),L.ComposeToRef(O,N,w,this.attachedNode.getWorldMatrix());else{S.toRotationMatrix(D.Matrix[0]);const Ue=this.attachedNode.getWorldMatrix().getTranslation();this.attachedNode.getWorldMatrix().multiplyToRef(D.Matrix[0],this.attachedNode.getWorldMatrix()),this.attachedNode.getWorldMatrix().setTranslation(Ue)}f.copyFrom(I.dragPlanePoint),nt&&(E.snapDistance=ce,this.onSnapObservable.notifyObservers(E)),this._angles.y+=ce,this.angle+=ze?-ce:ce,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}});const b=i._getSharedGizmoLight();b.includedOnlyMeshes=b.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));const y={colliderMeshes:[d],gizmoMeshes:[u],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};(c=this._parent)===null||c===void 0||c.addToAxisCache(this._gizmoMesh,y),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(I=>{var O;if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=er.MaxDragAngle,this._isHovered=y.colliderMeshes.indexOf((O=I==null?void 0:I.pickInfo)===null||O===void 0?void 0:O.pickedMesh)!=-1,!this._parent)){const N=y.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(y.gizmoMeshes,N)}}),this.dragBehavior.onEnabledObservable.add(I=>{this._setGizmoMeshMaterial(y.gizmoMeshes,I?this._coloredMaterial:this._disableMaterial)})}_createGizmoMesh(e,t,i){const s=Ef("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);s.visibility=0;const r=Ef("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return r.material=this._coloredMaterial,r.rotation.x=Math.PI/2,s.rotation.x=Math.PI/2,e.addChild(r,jt.PreserveScaling),e.addChild(s,jt.PreserveScaling),{rotationMesh:r,collider:s}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()}),super.dispose()}}er.MaxDragAngle=Math.PI*9/20;er._RotationGizmoVertexShader=`
        precision highp float;
        attribute vec3 position;
        attribute vec2 uv;
        uniform mat4 worldViewProjection;
        varying vec3 vPosition;
        varying vec2 vUV;

        void main(void) {
            gl_Position = worldViewProjection * vec4(position, 1.0);
            vUV = uv;
        }`;er._RotationGizmoFragmentShader=`
        precision highp float;
        varying vec2 vUV;
        varying vec3 vPosition;
        uniform vec3 angles;
        uniform vec3 rotationColor;

        #define twopi 6.283185307

        void main(void) {
            vec2 uv = vUV - vec2(0.5);
            float angle = atan(uv.y, uv.x) + 3.141592;
            float delta = gl_FrontFacing ? angles.y : -angles.y;
            float begin = angles.x - delta * angles.z;
            float start = (begin < (begin + delta)) ? begin : (begin + delta);
            float end = (begin > (begin + delta)) ? begin : (begin + delta);
            float len = sqrt(dot(uv,uv));
            float opacity = 1. - step(0.5, len);

            float base = abs(floor(start / twopi)) * twopi;
            start += base;
            end += base;

            float intensity = 0.;
            for (int i = 0; i < 5; i++)
            {
                intensity += max(step(start, angle) - step(end, angle), 0.);
                angle += twopi;
            }
            gl_FragColor = vec4(rotationColor, min(intensity * 0.25, 0.8)) * opacity;
        }
    `;class NB extends jt{get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null})}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,this._checkBillboardTransform(),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null})}_checkBillboardTransform(){this._nodeAttached&&this._nodeAttached.billboardMode&&q.Log("Rotation Gizmo will not work with transforms in billboard mode.")}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach(t=>{t&&(t.sensitivity=e)})}get sensitivity(){return this._sensitivity}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered}constructor(e=Yt.DefaultUtilityLayer,t=32,i=!1,s=1,r,n){super(e),this.onDragStartObservable=new j,this.onDragObservable=new j,this.onDragEndObservable=new j,this._observables=[],this._sensitivity=1,this._gizmoAxisCache=new Map;const a=n&&n.xOptions&&n.xOptions.color?n.xOptions.color:J.Red().scale(.5),l=n&&n.yOptions&&n.yOptions.color?n.yOptions.color:J.Green().scale(.5),h=n&&n.zOptions&&n.zOptions.color?n.zOptions.color:J.Blue().scale(.5);this.xGizmo=new er(new m(1,0,0),a,e,t,this,i,s),this.yGizmo=new er(new m(0,1,0),l,e,t,this,i,s),this.zGizmo=new er(new m(0,0,1),h,e,t,this,i,s),[this.xGizmo,this.yGizmo,this.zGizmo].forEach(c=>{n&&n.updateScale!=null&&(c.updateScale=n.updateScale),c.dragBehavior.onDragStartObservable.add(()=>{this.onDragStartObservable.notifyObservers({})}),c.dragBehavior.onDragObservable.add(()=>{this.onDragObservable.notifyObservers({})}),c.dragBehavior.onDragEndObservable.add(()=>{this.onDragEndObservable.notifyObservers({})})}),this.attachedMesh=null,this.attachedNode=null,r?r.addToAxisCache(this._gizmoAxisCache):jt.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}set updateGizmoRotationToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.yGizmo.updateGizmoRotationToMatchAttachedMesh=e,this.zGizmo.updateGizmoRotationToMatchAttachedMesh=e)}get updateGizmoRotationToMatchAttachedMesh(){return this.xGizmo.updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this.xGizmo&&(this.xGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.yGizmo.updateGizmoPositionToMatchAttachedMesh=e,this.zGizmo.updateGizmoPositionToMatchAttachedMesh=e)}get updateGizmoPositionToMatchAttachedMesh(){return this.xGizmo.updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach(t=>{t.anchorPoint=e})}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){[this.xGizmo,this.yGizmo,this.zGizmo].forEach(t=>{t.coordinatesMode=e})}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}set snapDistance(e){this.xGizmo&&(this.xGizmo.snapDistance=e,this.yGizmo.snapDistance=e,this.zGizmo.snapDistance=e)}get snapDistance(){return this.xGizmo.snapDistance}set scaleRatio(e){this.xGizmo&&(this.xGizmo.scaleRatio=e,this.yGizmo.scaleRatio=e,this.zGizmo.scaleRatio=e)}get scaleRatio(){return this.xGizmo.scaleRatio}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo].forEach(t=>{t&&(t.customRotationQuaternion=e)})}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){this.xGizmo.dispose(),this.yGizmo.dispose(),this.zGizmo.dispose(),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),this._observables.forEach(e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)})}setCustomMesh(){q.Error("Custom meshes are not supported on this gizmo, please set the custom meshes on the gizmos contained within this one (gizmo.xGizmo, gizmo.yGizmo, gizmo.zGizmo)")}}function $E(o){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const t=o.type&&(o.type<0||o.type>=e.length)?0:o.type||0,i=o.size,s=o.sizeX||i||1,r=o.sizeY||i||1,n=o.sizeZ||i||1,a=o.custom||e[t],l=a.face.length,h=o.faceUV||new Array(l),c=o.faceColors,u=o.flat===void 0?!0:o.flat,d=o.sideOrientation===0?0:o.sideOrientation||fe.DEFAULTSIDE,f=[],p=[],_=[],g=[],E=[];let R=0,x=0;const S=[];let b=0,y=0,I,O,N,w,G,k;if(u)for(y=0;y<l;y++)c&&c[y]===void 0&&(c[y]=new He(1,1,1,1)),h&&h[y]===void 0&&(h[y]=new ut(0,0,1,1));if(u)for(y=0;y<l;y++){const ae=a.face[y].length;for(N=2*Math.PI/ae,w=.5*Math.tan(N/2),G=.5,b=0;b<ae;b++)f.push(a.vertex[a.face[y][b]][0]*s,a.vertex[a.face[y][b]][1]*r,a.vertex[a.face[y][b]][2]*n),S.push(R),R++,I=h[y].x+(h[y].z-h[y].x)*(.5+w),O=h[y].y+(h[y].w-h[y].y)*(G-.5),g.push(I,Dt.UseOpenGLOrientationForUV?1-O:O),k=w*Math.cos(N)-G*Math.sin(N),G=w*Math.sin(N)+G*Math.cos(N),w=k,c&&E.push(c[y].r,c[y].g,c[y].b,c[y].a);for(b=0;b<ae-2;b++)p.push(S[0+x],S[b+2+x],S[b+1+x]);x+=ae}else{for(b=0;b<a.vertex.length;b++)f.push(a.vertex[b][0]*s,a.vertex[b][1]*r,a.vertex[b][2]*n),g.push(0,Dt.UseOpenGLOrientationForUV?1:0);for(y=0;y<l;y++)for(b=0;b<a.face[y].length-2;b++)p.push(a.face[y][0],a.face[y][b+2],a.face[y][b+1])}fe.ComputeNormals(f,p,_),fe._ComputeSides(d,f,p,_,g,o.frontUVs,o.backUVs);const de=new fe;return de.positions=f,de.indices=p,de.normals=_,de.uvs=g,c&&u&&(de.colors=E),de}function Tf(o,e={},t=null){const i=new re(o,t);return e.sideOrientation=re._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,$E(e).applyToMesh(i,e.updatable),i}fe.CreatePolyhedron=$E;re.CreatePolyhedron=(o,e,t)=>Tf(o,e,t);class Vs extends jt{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=J.Gray(),i=Yt.DefaultUtilityLayer,s=null,r=1,n=J.Yellow(),a=J.Gray()){var l,h,c,u,d,f,p;super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new j,this.uniformScaling=!1,this.sensitivity=1,this.dragScale=1,this.incrementalSnap=!1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._tmpVector=new m(0,0,0),this._incrementalStartupValue=m.Zero(),this._parent=s,this._coloredMaterial=new oe("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new J(.1,.1,.1)),this._hoverMaterial=new oe("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=n,this._disableMaterial=new oe("",i.utilityLayerScene),this._disableMaterial.diffuseColor=a,this._disableMaterial.alpha=.4,this._gizmoMesh=new re("axis",i.utilityLayerScene);const{arrowMesh:_,arrowTail:g}=this._createGizmoMesh(this._gizmoMesh,r),E=this._createGizmoMesh(this._gizmoMesh,r+4,!0);this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,jt.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3);const R=_.position.clone(),x=g.position.clone(),S=g.scaling.clone(),b=k=>{const de=k*(3/this._rootMesh.scaling.length())*6;_.position.z+=de/3.5,g.scaling.y+=de,this.dragScale=g.scaling.y,g.position.z=_.position.z/2},y=()=>{_.position.set(R.x,R.y,R.z),g.position.set(x.x,x.y,x.z),g.scaling.set(S.x,S.y,S.z),this.dragScale=g.scaling.y,this._dragging=!1};this.dragBehavior=new Xi({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior);let I=0,O=0;const N={snapDistance:0};this.dragBehavior.onDragObservable.add(k=>{if(this.attachedNode){const de=this.sensitivity*k.dragDistance*(this.scaleRatio*3/this._rootMesh.scaling.length()),ae=this._tmpVector;let _e=!1,Ce=0;if(this.uniformScaling?ae.setAll(.57735):ae.copyFrom(e),this.snapDistance==0)ae.scaleToRef(de,ae);else{I+=de,O+=de;const We=this.incrementalSnap?O:I;Math.abs(We)>this.snapDistance?(Ce=Math.floor(Math.abs(We)/this.snapDistance),We<0&&(Ce*=-1),I=I%this.snapDistance,ae.scaleToRef(this.snapDistance*Ce,ae),_e=!0):ae.scaleInPlace(0)}ae.addInPlaceFromFloats(1,1,1),ae.x=Math.abs(ae.x)<Vs.MinimumAbsoluteScale?Vs.MinimumAbsoluteScale*(ae.x<0?-1:1):ae.x,ae.y=Math.abs(ae.y)<Vs.MinimumAbsoluteScale?Vs.MinimumAbsoluteScale*(ae.y<0?-1:1):ae.y,ae.z=Math.abs(ae.z)<Vs.MinimumAbsoluteScale?Vs.MinimumAbsoluteScale*(ae.z<0?-1:1):ae.z;const ce=this.attachedNode._isMesh?this.attachedNode:void 0;Math.abs(this.snapDistance)>0&&this.incrementalSnap?(this.attachedNode.getWorldMatrix().decompose(void 0,D.Quaternion[0],D.Vector3[2],jt.PreserveScaling?ce:void 0),ae.addInPlace(this._incrementalStartupValue),ae.addInPlaceFromFloats(-1,-1,-1),ae.x=Math.abs(ae.x)*(this._incrementalStartupValue.x>0?1:-1),ae.y=Math.abs(ae.y)*(this._incrementalStartupValue.y>0?1:-1),ae.z=Math.abs(ae.z)*(this._incrementalStartupValue.z>0?1:-1),L.ComposeToRef(ae,D.Quaternion[0],D.Vector3[2],D.Matrix[1])):(L.ScalingToRef(ae.x,ae.y,ae.z,D.Matrix[2]),D.Matrix[2].multiplyToRef(this.attachedNode.getWorldMatrix(),D.Matrix[1])),D.Matrix[1].decompose(D.Vector3[1],void 0,void 0,jt.PreserveScaling?ce:void 0);const ze=1e5;Math.abs(D.Vector3[1].x)<ze&&Math.abs(D.Vector3[1].y)<ze&&Math.abs(D.Vector3[1].z)<ze&&this.attachedNode.getWorldMatrix().copyFrom(D.Matrix[1]),_e&&(N.snapDistance=this.snapDistance*Ce,this.onSnapObservable.notifyObservers(N)),this._matrixChanged()}}),this.dragBehavior.onDragStartObservable.add(()=>{var k;this._dragging=!0;const de=this.attachedNode._isMesh?this.attachedNode:void 0;(k=this.attachedNode)===null||k===void 0||k.getWorldMatrix().decompose(this._incrementalStartupValue,void 0,void 0,jt.PreserveScaling?de:void 0),I=0,O=0}),this.dragBehavior.onDragObservable.add(k=>b(k.dragDistance)),this.dragBehavior.onDragEndObservable.add(y),(c=(h=(l=s==null?void 0:s.uniformScaleGizmo)===null||l===void 0?void 0:l.dragBehavior)===null||h===void 0?void 0:h.onDragObservable)===null||c===void 0||c.add(k=>b(k.delta.y)),(f=(d=(u=s==null?void 0:s.uniformScaleGizmo)===null||u===void 0?void 0:u.dragBehavior)===null||d===void 0?void 0:d.onDragEndObservable)===null||f===void 0||f.add(y);const w={gizmoMeshes:[_,g],colliderMeshes:[E.arrowMesh,E.arrowTail],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};(p=this._parent)===null||p===void 0||p.addToAxisCache(this._gizmoMesh,w),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(k=>{var de;if(!this._customMeshSet&&(this._isHovered=w.colliderMeshes.indexOf((de=k==null?void 0:k.pickInfo)===null||de===void 0?void 0:de.pickedMesh)!=-1,!this._parent)){const ae=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(w.gizmoMeshes,ae)}}),this.dragBehavior.onEnabledObservable.add(k=>{this._setGizmoMeshMaterial(w.gizmoMeshes,k?this._coloredMaterial:this._disableMaterial)});const G=i._getSharedGizmoLight();G.includedOnlyMeshes=G.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes())}_createGizmoMesh(e,t,i=!1){const s=Df("yPosMesh",{size:.4*(1+(t-1)/4)},this.gizmoLayer.utilityLayerScene),r=ua("cylinder",{diameterTop:.005*t,height:.275,diameterBottom:.005*t,tessellation:96},this.gizmoLayer.utilityLayerScene);return s.scaling.scaleInPlace(.1),s.material=this._coloredMaterial,s.rotation.x=Math.PI/2,s.position.z+=.3,r.material=this._coloredMaterial,r.position.z+=.275/2,r.rotation.x=Math.PI/2,i&&(s.visibility=0,r.visibility=0),e.addChild(s),e.addChild(r),{arrowMesh:s,arrowTail:r}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()}),super.dispose()}setCustomMesh(e,t=!1){super.setCustomMesh(e),t&&(this._rootMesh.getChildMeshes().forEach(i=>{i.material=this._coloredMaterial,i.color&&(i.color=this._coloredMaterial.diffuseColor)}),this._customMeshSet=!1)}}Vs.MinimumAbsoluteScale=dt;class LB extends jt{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}get attachedMesh(){return this._meshAttached}set attachedMesh(e){this._meshAttached=e,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t.isEnabled?t.attachedMesh=e:t.attachedMesh=null})}get attachedNode(){return this._nodeAttached}set attachedNode(e){this._meshAttached=null,this._nodeAttached=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t.isEnabled?t.attachedNode=e:t.attachedNode=null})}set updateScale(e){this.xGizmo&&(this.xGizmo.updateScale=e,this.yGizmo.updateScale=e,this.zGizmo.updateScale=e)}get updateScale(){return this.xGizmo.updateScale}get isHovered(){return this.xGizmo.isHovered||this.yGizmo.isHovered||this.zGizmo.isHovered}constructor(e=Yt.DefaultUtilityLayer,t=1,i){super(e),this._meshAttached=null,this._nodeAttached=null,this._incrementalSnap=!1,this._sensitivity=1,this._observables=[],this._gizmoAxisCache=new Map,this.onDragStartObservable=new j,this.onDragObservable=new j,this.onDragEndObservable=new j,this.uniformScaleGizmo=this._createUniformScaleMesh(),this.xGizmo=new Vs(new m(1,0,0),J.Red().scale(.5),e,this,t),this.yGizmo=new Vs(new m(0,1,0),J.Green().scale(.5),e,this,t),this.zGizmo=new Vs(new m(0,0,1),J.Blue().scale(.5),e,this,t),[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(s=>{s.dragBehavior.onDragStartObservable.add(()=>{this.onDragStartObservable.notifyObservers({})}),s.dragBehavior.onDragObservable.add(()=>{this.onDragObservable.notifyObservers({})}),s.dragBehavior.onDragEndObservable.add(()=>{this.onDragEndObservable.notifyObservers({})})}),this.attachedMesh=null,this.attachedNode=null,i?i.addToAxisCache(this._gizmoAxisCache):jt.GizmoAxisPointerObserver(e,this._gizmoAxisCache)}_createUniformScaleMesh(){this._coloredMaterial=new oe("",this.gizmoLayer.utilityLayerScene),this._coloredMaterial.diffuseColor=J.Gray(),this._hoverMaterial=new oe("",this.gizmoLayer.utilityLayerScene),this._hoverMaterial.diffuseColor=J.Yellow(),this._disableMaterial=new oe("",this.gizmoLayer.utilityLayerScene),this._disableMaterial.diffuseColor=J.Gray(),this._disableMaterial.alpha=.4;const e=new Vs(new m(0,1,0),J.Gray().scale(.5),this.gizmoLayer,this);e.updateGizmoRotationToMatchAttachedMesh=!1,e.uniformScaling=!0,this._uniformScalingMesh=Tf("uniform",{type:1},e.gizmoLayer.utilityLayerScene),this._uniformScalingMesh.scaling.scaleInPlace(.01),this._uniformScalingMesh.visibility=0,this._octahedron=Tf("",{type:1},e.gizmoLayer.utilityLayerScene),this._octahedron.scaling.scaleInPlace(.007),this._uniformScalingMesh.addChild(this._octahedron),e.setCustomMesh(this._uniformScalingMesh,!0);const t=this.gizmoLayer._getSharedGizmoLight();t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._octahedron);const i={gizmoMeshes:[this._octahedron,this._uniformScalingMesh],colliderMeshes:[this._uniformScalingMesh],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:e.dragBehavior};return this.addToAxisCache(e._rootMesh,i),e}set updateGizmoRotationToMatchAttachedMesh(e){e?(this._updateGizmoRotationToMatchAttachedMesh=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t&&(t.updateGizmoRotationToMatchAttachedMesh=e)})):q.Warn("Setting updateGizmoRotationToMatchAttachedMesh = false on scaling gizmo is not supported.")}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t&&(t.anchorPoint=e)})}get anchorPoint(){return this._anchorPoint}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t&&(t.customRotationQuaternion=e)})}set coordinatesMode(e){e==gl.World&&q.Warn("Setting coordinates Mode to world on scaling gizmo is not supported."),[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t.coordinatesMode=gl.Local})}set snapDistance(e){this._snapDistance=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t&&(t.snapDistance=e)})}get snapDistance(){return this._snapDistance}set incrementalSnap(e){this._incrementalSnap=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t&&(t.incrementalSnap=e)})}get incrementalSnap(){return this._incrementalSnap}set scaleRatio(e){this._scaleRatio=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t&&(t.scaleRatio=e)})}get scaleRatio(){return this._scaleRatio}set sensitivity(e){this._sensitivity=e,[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(t=>{t&&(t.sensitivity=e)})}get sensitivity(){return this._sensitivity}addToAxisCache(e,t){this._gizmoAxisCache.set(e,t)}dispose(){[this.xGizmo,this.yGizmo,this.zGizmo,this.uniformScaleGizmo].forEach(e=>{e&&e.dispose()}),this._observables.forEach(e=>{this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(e)}),this.onDragStartObservable.clear(),this.onDragObservable.clear(),this.onDragEndObservable.clear(),[this._uniformScalingMesh,this._octahedron].forEach(e=>{e&&e.dispose()}),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()})}}var FB=Object.defineProperty,wB=Object.getOwnPropertyDescriptor,Ea=(o,e,t,i)=>{for(var s=i>1?void 0:i?wB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&FB(e,t,s),s};class wn extends Bi{constructor(){super(),this.scale=null,this.enablePosition=null,this.enableRotation=null,this.enableScale=null,this.target=null,this._dragStartInfo=null,this._target=null,this._rotEntity=null,this._posScaleEntity=null,this._posGiz=null,this._rotGiz=null,this._scaleGiz=null,this._onTick=()=>{if(this._dragStartInfo&&this.entity&&this._rotEntity&&this._posScaleEntity&&this._target&&this._target.entity){const e=this._target.entity,t=D.Vector3[0],i=D.Quaternion[0],s=D.Vector3[1];i.copyFrom(this._rotEntity.absoluteRotationQuaternion),t.copyFrom(this._posScaleEntity.absolutePosition),s.copyFrom(this._posScaleEntity.absoluteScaling);const r=D.Matrix[0];L.ComposeToRef(s,i,t,r);const n=e.parent?e.parent.getWorldMatrix():L.IdentityReadOnly,a=D.Matrix[1];n.invertToRef(a);const l=D.Matrix[2];r.multiplyToRef(a,l);const h=D.Vector3[2],c=D.Quaternion[1],u=D.Vector3[3];if(l.decompose(u,c,h),this._target.position=h.clone(),this._target.scale=u.clone(),this._target.quaternion)this._target.quaternion.equals(c)||(this._target.quaternion=c.clone());else{const d=c.toEulerAngles().scaleInPlace(180/Math.PI);this._target.rotation=d.clone()}this._target.performUpdate(),this._dragStartInfo.type==="rotation"?this._posScaleEntity.rotationQuaternion.copyFrom(this._rotEntity.rotationQuaternion):this._dragStartInfo.type==="position"&&this._rotEntity.position.copyFrom(this._posScaleEntity.position)}this._dragStartInfo||this._resetCursorTransform()},this._startDrag=e=>{!this._target||!this._target.entity||(this._dragStartInfo=e)},this._endDrag=()=>{this._dragStartInfo=null,this._resetCursorTransform()},new Hr(this,"target","_target",null),new e_(this,this._onTick)}connected(){super.connected(),this.entity=new we(this.id,this.scene),this.entity.rotationQuaternion=le.Identity(),this._rotEntity=new re(this.id+"-rot-host",this.scene),this._rotEntity.parent=this.entity,this._rotEntity.rotationQuaternion=le.Identity(),this._rotEntity.visibility=.5,this._rotEntity.showBoundingBox=!0,this._posScaleEntity=new re(this.id+"-pos-scale-host",this.scene),this._posScaleEntity.parent=this.entity,this._posScaleEntity.rotationQuaternion=le.Identity(),this._posScaleEntity.visibility=.5,this._posScaleEntity.showBoundingBox=!0}disconnected(){var e,t,i;super.disconnected(),this._posGiz&&(this._posGiz.dispose(),this._posGiz=null),this._rotGiz&&(this._rotGiz.dispose(),this._rotGiz=null),this._scaleGiz&&(this._scaleGiz.dispose(),this._scaleGiz=null),(e=this.entity)==null||e.dispose(),this.entity=null,(t=this._rotEntity)==null||t.dispose(),this._rotEntity=null,(i=this._posScaleEntity)==null||i.dispose(),this._posScaleEntity=null}_resetCursorTransform(){if(this.entity&&this._rotEntity&&this._posScaleEntity&&this._target&&this._target.entity){const e=this._target.entity.getWorldMatrix(),t=m.Zero(),i=le.Identity(),s=m.One();e.decompose(s,i,t),this._rotEntity.resetLocalMatrix(),this._posScaleEntity.resetLocalMatrix(),this.entity.position.copyFrom(t),this.entity.rotationQuaternion.copyFrom(i),this.entity.scaling.setAll(1),this._posScaleEntity.scaling.copyFrom(s)}}willUpdate(e){if(super.willUpdate(e),!this.entity||!this._rotEntity||!this._posScaleEntity)return;const t=this._rotEntity,i=this._posScaleEntity;if(e.has("enablePosition")){if(this.evaluated.enablePosition&&!this._posGiz){const s=new OB(this.scene.defaultUtilityLayerWithEvents);this._posGiz=s,s.attachedMesh=i,s.onDragStartObservable.add(()=>{this._startDrag({type:"position",activeAxis:s.xGizmo.isHovered?"x":s.yGizmo.isHovered?"y":"z",matrix:i.getWorldMatrix().clone()})}),s.onDragEndObservable.add(()=>this._endDrag())}!this.evaluated.enablePosition&&this._posGiz&&(this._posGiz.dispose(),this._posGiz=null)}if(e.has("enableRotation")){if(this.evaluated.enableRotation&&!this._rotGiz){const s=new NB(this.scene.defaultUtilityLayerWithEvents);this._rotGiz=s,s.updateGizmoRotationToMatchAttachedMesh,s.attachedMesh=t,s.onDragStartObservable.add(()=>{this._startDrag({type:"rotation",activeAxis:s.xGizmo.isHovered?"x":s.yGizmo.isHovered?"y":"z",matrix:t.getWorldMatrix().clone()})}),s.onDragEndObservable.add(()=>this._endDrag())}!this.evaluated.enableRotation&&this._rotGiz&&(this._rotGiz.dispose(),this._rotGiz=null)}if(e.has("enableScale")){if(this.evaluated.enableScale&&!this._scaleGiz){const s=new LB(this.scene.defaultUtilityLayerWithEvents);this._scaleGiz=s,s.attachedMesh=i,s.onDragStartObservable.add(()=>{this._startDrag({type:"scale",activeAxis:s.xGizmo.isHovered?"x":s.yGizmo.isHovered?"y":"z",matrix:i.getWorldMatrix().clone()})}),s.onDragEndObservable.add(()=>this._endDrag())}!this.evaluated.enableScale&&this._scaleGiz&&(this._scaleGiz.dispose(),this._scaleGiz=null)}e.has("scale")&&this.evaluated.scale&&(this._posGiz&&(this._posGiz.xGizmo.scaleRatio=this.evaluated.scale.x,this._posGiz.yGizmo.scaleRatio=this.evaluated.scale.y,this._posGiz.zGizmo.scaleRatio=this.evaluated.scale.z),this._scaleGiz&&(this._scaleGiz.xGizmo.scaleRatio=this.evaluated.scale.x*1.1,this._scaleGiz.yGizmo.scaleRatio=this.evaluated.scale.y*1.1,this._scaleGiz.zGizmo.scaleRatio=this.evaluated.scale.z*1.1),this._rotGiz&&(this._rotGiz.xGizmo.scaleRatio=this.evaluated.scale.x,this._rotGiz.yGizmo.scaleRatio=this.evaluated.scale.y,this._rotGiz.zGizmo.scaleRatio=this.evaluated.scale.z)),e.has("_target")&&this._resetCursorTransform()}render(){if(!this._dragStartInfo)return;const{type:e,activeAxis:t}=this._dragStartInfo;let i=null;if(e==="position"){const s=[];let r="#ffffff";const n=this.scene.activeCamera.maxZ*2;t==="x"&&(s.push(new m(-n,0,0),new m(n,0,0)),r="#ff000080"),t==="y"&&(s.push(new m(0,-n,0),new m(0,n,0)),r="#00ff0080"),t==="z"&&(s.push(new m(0,0,-n),new m(0,0,n)),r="#0000ff80"),i=As`<xr-line layer="1" points="${s.map(a=>a.asArray().join(" ")).join(", ")}" colors="${r}"></xr-line>`}return As`${i}`}}Ea([$.property("Vector3","scale",m.One())],wn.prototype,"scale",2);Ea([$.property("Boolean","enable-position",null)],wn.prototype,"enablePosition",2);Ea([$.property("Boolean","enable-rotation",null)],wn.prototype,"enableRotation",2);Ea([$.property("Boolean","enable-scale",null)],wn.prototype,"enableScale",2);Ea([$.property("String","target",null)],wn.prototype,"target",2);Ea([Ss()],wn.prototype,"_dragStartInfo",2);Ea([Ss()],wn.prototype,"_target",2);var BB=Object.defineProperty,UB=Object.getOwnPropertyDescriptor,s_=(o,e,t,i)=>{for(var s=i>1?void 0:i?UB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&BB(e,t,s),s};class pu extends Bi{constructor(){super(),this.position=null,this.rotation=null,this.length=null,this._onTick=()=>{if(!this.entity||!this.evaluated.rotation||!this.evaluated.position||!this.evaluated.length)return;const e=D.Quaternion[0];le.FromEulerAnglesToRef(this.evaluated.rotation.x/180*Math.PI,this.evaluated.rotation.y/180*Math.PI,this.evaluated.rotation.z/180*Math.PI,e),this.entity.origin.copyFrom(this.evaluated.position),m.RightHandedForwardReadOnly.rotateByQuaternionToRef(e,this.entity.direction),this.entity.length=this.evaluated.length;const t=Gs.closestTransformNodeLike(this);if(t){const i=t.getWorldMatrix();m.TransformCoordinatesToRef(this.entity.origin,i,this.entity.origin),m.TransformNormalToRef(this.entity.direction,i,this.entity.direction)}},new e_(this,()=>this._onTick())}connected(){super.connected(),this.entity=new lt(m.Zero(),m.Forward(),1),this._onTick(),this.pick()}pick(){if(!this.entity)return;const e=this.scene.pickWithRay(this.entity);e&&this.emit("pick",e)}disconnected(){super.disconnected(),this.entity=null}}s_([$.property("Vector3","position",m.Zero())],pu.prototype,"position",2);s_([$.property("Vector3","rotation",m.Zero())],pu.prototype,"rotation",2);s_([$.property("Number","length",1)],pu.prototype,"length",2);var kB=Object.defineProperty,VB=Object.getOwnPropertyDescriptor,Zr=(o,e,t,i)=>{for(var s=i>1?void 0:i?VB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&kB(e,t,s),s};const d_=class d_ extends Bi{constructor(){super(),this.hasAlpha=null,this.level=null,this.coordinatesIndex=null,this.coordinatesMode=null,this.wrapU=null,this.wrapV=null,this.url=null,this.rotationY=null,this.extension=null,new XE(this)}connected(){super.connected(),this.entity=new Si("",this.scene),this.entity.name=this.id}willUpdate(e){if(super.willUpdate(e),!!this.entity){if(e.has("url")&&this.evaluated.url){const t=this.evaluated.url;this.entity.updateURL(t,this.evaluated.extension||void 0)}e.has("rotationY")&&(this.entity.rotationY=this.evaluated.rotationY||0)}}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};d_.requiredAttrs=["id"];let zs=d_;Zr([$.property("Boolean","has-alpha",null)],zs.prototype,"hasAlpha",2);Zr([$.property("Number","level",null)],zs.prototype,"level",2);Zr([$.property("Number","coordinates-index",null)],zs.prototype,"coordinatesIndex",2);Zr([$.property("Number","coordinates-mode",null)],zs.prototype,"coordinatesMode",2);Zr([$.property("Number","wrap-u",null)],zs.prototype,"wrapU",2);Zr([$.property("Number","wrap-v",null)],zs.prototype,"wrapV",2);Zr([$.property("String","url",null)],zs.prototype,"url",2);Zr([$.property("Number","rotation-y",null)],zs.prototype,"rotationY",2);Zr([$.property("Boolean","extension",null)],zs.prototype,"extension",2);var GB=Object.defineProperty,zB=Object.getOwnPropertyDescriptor,Xs=(o,e,t,i)=>{for(var s=i>1?void 0:i?zB(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&GB(e,t,s),s};const f_=class f_ extends Bi{constructor(){super(),this.hasAlpha=null,this.level=null,this.coordinatesIndex=null,this.coordinatesMode=null,this.wrapU=null,this.wrapV=null,this.url=null,this.uOffset=null,this.vOffset=null,this.uScale=null,this.vScale=null,this.invertY=null,new XE(this)}connected(){super.connected(),this.entity=new V(null,this.scene,void 0,this.invertY||!1),this.entity.name=this.id}willUpdate(e){super.willUpdate(e),this.entity&&(e.has("url")&&this.entity.updateURL(this.evaluated.url||""),e.has("uOffset")&&(this.entity.uOffset=this.evaluated.uOffset||0),e.has("vOffset")&&(this.entity.vOffset=this.evaluated.vOffset||0),e.has("uScale")&&(this.entity.uScale=this.evaluated.uScale||0),e.has("vScale")&&(this.entity.vScale=this.evaluated.vScale||0))}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};f_.requiredAttrs=["id"];let ds=f_;Xs([$.property("Boolean","has-alpha",null)],ds.prototype,"hasAlpha",2);Xs([$.property("Number","level",1)],ds.prototype,"level",2);Xs([$.property("Number","coordinates-index",null)],ds.prototype,"coordinatesIndex",2);Xs([$.property("Number","coordinates-mode",null)],ds.prototype,"coordinatesMode",2);Xs([$.property("Number","wrap-u",null)],ds.prototype,"wrapU",2);Xs([$.property("Number","wrap-v",null)],ds.prototype,"wrapV",2);Xs([$.property("String","url",null)],ds.prototype,"url",2);Xs([$.property("Number","u-offset",null)],ds.prototype,"uOffset",2);Xs([$.property("Number","v-offset",null)],ds.prototype,"vOffset",2);Xs([$.property("Number","u-scale",1)],ds.prototype,"uScale",2);Xs([$.property("Number","v-scale",1)],ds.prototype,"vScale",2);Xs([$.property("Boolean","invert-y",null)],ds.prototype,"invertY",2);const HB="backgroundFragmentDeclaration",WB=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;X.IncludesShadersStore[HB]=WB;const XB="backgroundUboDeclaration",YB=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};
#include<sceneUboDeclaration>
`;X.IncludesShadersStore[XB]=YB;const KB="backgroundPixelShader",$B=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
float sphereIntersect(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return -1.0; }
h=sqrt(h);return-b+h;}
vec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersect(eyePosition,camDir,radius);vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersect(eyePosition,p,radius);vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
vec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;X.ShadersStore[KB]=$B;const jB="backgroundVertexDeclaration",qB=`uniform mat4 view;uniform mat4 viewProjection;uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;X.IncludesShadersStore[jB]=qB;const ZB="backgroundVertexShader",QB=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}
else
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;X.ShadersStore[ZB]=QB;class JB extends ir{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class et extends Ph{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=et.StandardReflectance0*t,this.reflectionReflectance90=et.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=et.StandardReflectance0+(1-et.StandardReflectance0)*t,this.reflectionReflectance90=et.StandardReflectance90+(1-et.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.primaryColor=J.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=m.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new li(16),this._reflectionControls=ut.Zero(),this._white=J.White(),this._primaryShadowColor=J.Black(),this._primaryHighlightColor=J.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new JB);const s=this.getScene(),r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(se.PrepareDefinesForLights(s,e,r,!1,this._maxSimultaneousLights),r._needNormals=!0,se.PrepareDefinesForMultiview(s,r),r._areTexturesDirty){if(r._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(r.TEXTURELODSUPPORT=!0),this._diffuseTexture&&ie.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;se.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE"),r.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,r.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,r.OPACITYFRESNEL=this._opacityFresnel}else r.DIFFUSE=!1,r.DIFFUSEDIRECTUV=0,r.DIFFUSEHASALPHA=!1,r.GAMMADIFFUSE=!1,r.OPACITYFRESNEL=!1;const a=this._reflectionTexture;if(a&&ie.ReflectionTextureEnabled){if(!a.isReadyOrNotBlocking())return!1;switch(r.REFLECTION=!0,r.GAMMAREFLECTION=a.gammaSpace,r.RGBDREFLECTION=a.isRGBD,r.REFLECTIONBLUR=this._reflectionBlur>0,r.LODINREFLECTIONALPHA=a.lodLevelInAlpha,r.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,r.REFLECTIONBGR=this.switchToBGR,a.coordinatesMode===V.INVCUBIC_MODE&&(r.INVERTCUBICMAP=!0),r.REFLECTIONMAP_3D=a.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!a.invertZ:a.invertZ,a.coordinatesMode){case V.EXPLICIT_MODE:r.REFLECTIONMAP_EXPLICIT=!0;break;case V.PLANAR_MODE:r.REFLECTIONMAP_PLANAR=!0;break;case V.PROJECTION_MODE:r.REFLECTIONMAP_PROJECTION=!0;break;case V.SKYBOX_MODE:r.REFLECTIONMAP_SKYBOX=!0;break;case V.SPHERICAL_MODE:r.REFLECTIONMAP_SPHERICAL=!0;break;case V.EQUIRECTANGULAR_MODE:r.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case V.FIXED_EQUIRECTANGULAR_MODE:r.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case V.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case V.CUBIC_MODE:case V.INVCUBIC_MODE:default:r.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(r.REFLECTIONFRESNEL=!0,r.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(r.REFLECTIONFRESNEL=!1,r.REFLECTIONFALLOFF=!1)}else r.REFLECTION=!1,r.REFLECTIONFRESNEL=!1,r.REFLECTIONFALLOFF=!1,r.REFLECTIONBLUR=!1,r.REFLECTIONMAP_3D=!1,r.REFLECTIONMAP_SPHERICAL=!1,r.REFLECTIONMAP_PLANAR=!1,r.REFLECTIONMAP_CUBIC=!1,r.REFLECTIONMAP_PROJECTION=!1,r.REFLECTIONMAP_SKYBOX=!1,r.REFLECTIONMAP_EXPLICIT=!1,r.REFLECTIONMAP_EQUIRECTANGULAR=!1,r.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,r.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,r.INVERTCUBICMAP=!1,r.REFLECTIONMAP_OPPOSITEZ=!1,r.LODINREFLECTIONALPHA=!1,r.GAMMAREFLECTION=!1,r.RGBDREFLECTION=!1}r.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,r.USERGBCOLOR=this._useRGBColor,r.NOISE=this._enableNoise}if(r._areLightsDirty&&(r.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),r.BACKMAT_SHADOWONLY=this._shadowOnly),r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r)}if(r._areMiscDirty&&(r.REFLECTIONMAP_3D&&this._enableGroundProjection?(r.PROJECTED_GROUND=!0,r.REFLECTIONMAP_SKYBOX=!0):r.PROJECTED_GROUND=!1),se.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),r),se.PrepareDefinesForFrameBoundValues(s,n,this,r,i,null,t.getRenderingMesh().hasThinInstances),se.PrepareDefinesForAttributes(e,r,!1,!0,!1)&&e&&!s.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(T.NormalKind)&&(e.createNormals(!0),q.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),r.isDirty){r.markAsProcessed(),s.resetCachedMaterial();const a=new Ih;r.FOG&&a.addFallback(0,"FOG"),r.POINTSIZE&&a.addFallback(1,"POINTSIZE"),r.MULTIVIEW&&a.addFallback(0,"MULTIVIEW"),se.HandleFallbacksForShadows(r,a,this._maxSimultaneousLights);const l=[T.PositionKind];r.NORMAL&&l.push(T.NormalKind),r.UV1&&l.push(T.UVKind),r.UV2&&l.push(T.UV2Kind),se.PrepareAttributesForBones(l,e,r,a),se.PrepareAttributesForInstances(l,r);const h=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];In(h);const c=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],u=["Material","Scene"];st&&(st.PrepareUniforms(h,r),st.PrepareSamplers(c,r)),se.PrepareUniformsAndSamplersList({uniformsNames:h,uniformBuffersNames:u,samplers:c,defines:r,maxSimultaneousLights:this._maxSimultaneousLights});const d=r.toString(),f=s.getEngine().createEffect("background",{attributes:l,uniformsNames:h,uniformBuffersNames:u,samplers:c,defines:d,fallbacks:a,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},n);t.setEffect(f,r,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),se.BindBonesParameters(t,this._activeEffect);const a=this._mustRebind(s,n,t.visibility);if(a){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(s.texturesEnabled&&(this._diffuseTexture&&ie.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),se.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&ie.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),r.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.texturesEnabled&&(this._diffuseTexture&&ie.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&ie.ReflectionTextureEnabled&&(r.REFLECTIONBLUR&&r.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):r.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),r.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),r.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),Pn(this._activeEffect,this,s),s.bindEyePosition(n)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(s.lightsEnabled&&se.BindLights(s,t,this._activeEffect,r,this._maxSimultaneousLights),this.bindView(n),se.BindFogParameters(s,t,this._activeEffect,!0),this._useLogarithmicDepth&&se.BindLogDepth(r,n,s),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return Le.Clone(()=>new et(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return Le.Parse(()=>new et(e.name,t),e,t,i)}}et.StandardReflectance0=.05;et.StandardReflectance90=.5;v([oi()],et.prototype,"_primaryColor",void 0);v([Z("_markAllSubMeshesAsLightsDirty")],et.prototype,"primaryColor",void 0);v([oi()],et.prototype,"__perceptualColor",void 0);v([M()],et.prototype,"_primaryColorShadowLevel",void 0);v([M()],et.prototype,"_primaryColorHighlightLevel",void 0);v([Z("_markAllSubMeshesAsLightsDirty")],et.prototype,"primaryColorHighlightLevel",null);v([rt()],et.prototype,"_reflectionTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionTexture",void 0);v([M()],et.prototype,"_reflectionBlur",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionBlur",void 0);v([rt()],et.prototype,"_diffuseTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"diffuseTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"shadowLights",void 0);v([M()],et.prototype,"_shadowLevel",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"shadowLevel",void 0);v([zi()],et.prototype,"_sceneCenter",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"sceneCenter",void 0);v([M()],et.prototype,"_opacityFresnel",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"opacityFresnel",void 0);v([M()],et.prototype,"_reflectionFresnel",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionFresnel",void 0);v([M()],et.prototype,"_reflectionFalloffDistance",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionFalloffDistance",void 0);v([M()],et.prototype,"_reflectionAmount",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionAmount",void 0);v([M()],et.prototype,"_reflectionReflectance0",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionReflectance0",void 0);v([M()],et.prototype,"_reflectionReflectance90",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionReflectance90",void 0);v([M()],et.prototype,"_useRGBColor",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"useRGBColor",void 0);v([M()],et.prototype,"_enableNoise",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"enableNoise",void 0);v([M()],et.prototype,"_maxSimultaneousLights",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"maxSimultaneousLights",void 0);v([M()],et.prototype,"_shadowOnly",void 0);v([Z("_markAllSubMeshesAsLightsDirty")],et.prototype,"shadowOnly",void 0);v([vm()],et.prototype,"_imageProcessingConfiguration",void 0);v([M(),Z("_markAllSubMeshesAsMiscDirty")],et.prototype,"enableGroundProjection",void 0);v([M()],et.prototype,"projectedGroundRadius",void 0);v([M()],et.prototype,"projectedGroundHeight",void 0);Re("BABYLON.BackgroundMaterial",et);var eU=Object.defineProperty,tU=Object.getOwnPropertyDescriptor,Ta=(o,e,t,i)=>{for(var s=i>1?void 0:i?tU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&eU(e,t,s),s};class br extends Bi{constructor(){super(...arguments),this.backFaceCulling=null,this.alpha=null,this.sideOrientation=null,this.wireframe=null,this.alphaMode=null,this.disableDepthWrite=null,this.zOffset=null}}Ta([$.property("Boolean","backface-culling",null)],br.prototype,"backFaceCulling",2);Ta([$.property("Number","alpha",null)],br.prototype,"alpha",2);Ta([$.property("Number","side-orientation",null)],br.prototype,"sideOrientation",2);Ta([$.property("Boolean","wireframe",null)],br.prototype,"wireframe",2);Ta([$.property("Number","alpha-mode",2)],br.prototype,"alphaMode",2);Ta([$.property("Boolean","disable-depth-write",null)],br.prototype,"disableDepthWrite",2);Ta([$.property("Number","z-offset",null)],br.prototype,"zOffset",2);var iU=Object.defineProperty,sU=Object.getOwnPropertyDescriptor,Jh=(o,e,t,i)=>{for(var s=i>1?void 0:i?sU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&iU(e,t,s),s};const __=class __ extends br{constructor(){super(),this.useRGBColor=null,this.primaryColor=null,this.enableNoise=null,this.reflectionTexture=null,this._reflectionTexture=null,new Hr(this,"reflectionTexture","_reflectionTexture","xr-cube-texture"),new jf(this)}connected(){super.connected(),this.entity=new et(this.id,this.scene)}willUpdate(e){var t;super.willUpdate(e),this.entity&&(e.has("useRGBColor")&&this.evaluated.useRGBColor&&(this.entity.useRGBColor=this.evaluated.useRGBColor),e.has("primaryColor")&&this.evaluated.primaryColor&&this.entity.primaryColor.copyFrom(this.evaluated.primaryColor),e.has("enableNoise")&&(this.entity.enableNoise=!!this.evaluated.enableNoise),e.has("_reflectionTexture")&&(this.entity.reflectionTexture=((t=this._reflectionTexture)==null?void 0:t.entity)||null))}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};__.requiredAttrs=["id"];let xn=__;Jh([$.property("Boolean","use-rgb-color",null)],xn.prototype,"useRGBColor",2);Jh([$.property("Color3","primary-color",null)],xn.prototype,"primaryColor",2);Jh([$.property("Boolean","enable-noise",null)],xn.prototype,"enableNoise",2);Jh([$.property("String","reflection-texture",null)],xn.prototype,"reflectionTexture",2);Jh([Ss()],xn.prototype,"_reflectionTexture",2);const rU="imageProcessingCompatibility",nU=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;X.IncludesShadersStore[rU]=nU;const aU="gridPixelShader",oU=`#extension GL_OES_standard_derivatives : enable
#define SQRT2 1.41421356
#define PI 3.14159
precision highp float;uniform float visibility;uniform vec3 mainColor;uniform vec3 lineColor;uniform vec4 gridControl;uniform vec3 gridOffset;varying vec3 vPosition;varying vec3 vNormal;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;uniform sampler2D opacitySampler;uniform vec2 vOpacityInfos;
#endif
float getDynamicVisibility(float position) {float majorGridFrequency=gridControl.y;if (floor(position+0.5)==floor(position/majorGridFrequency+0.5)*majorGridFrequency)
{return 1.0;}
return gridControl.z;}
float getAnisotropicAttenuation(float differentialLength) {const float maxNumberOfLines=10.0;return clamp(1.0/(differentialLength+1.0)-1.0/maxNumberOfLines,0.0,1.0);}
float isPointOnLine(float position,float differentialLength) {float fractionPartOfPosition=position-floor(position+0.5); 
fractionPartOfPosition/=differentialLength; 
#ifdef ANTIALIAS
fractionPartOfPosition=clamp(fractionPartOfPosition,-1.,1.);float result=0.5+0.5*cos(fractionPartOfPosition*PI); 
return result;
#else
return abs(fractionPartOfPosition)<SQRT2/4. ? 1. : 0.;
#endif
}
float contributionOnAxis(float position) {float differentialLength=length(vec2(dFdx(position),dFdy(position)));differentialLength*=SQRT2; 
float result=isPointOnLine(position,differentialLength);float dynamicVisibility=getDynamicVisibility(position);result*=dynamicVisibility;float anisotropicAttenuation=getAnisotropicAttenuation(differentialLength);result*=anisotropicAttenuation;return result;}
float normalImpactOnAxis(float x) {float normalImpact=clamp(1.0-3.0*abs(x*x*x),0.0,1.0);return normalImpact;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
float gridRatio=gridControl.x;vec3 gridPos=(vPosition+gridOffset.xyz)/gridRatio;float x=contributionOnAxis(gridPos.x);float y=contributionOnAxis(gridPos.y);float z=contributionOnAxis(gridPos.z);vec3 normal=normalize(vNormal);x*=normalImpactOnAxis(normal.x);y*=normalImpactOnAxis(normal.y);z*=normalImpactOnAxis(normal.z);
#ifdef MAX_LINE
float grid=clamp(max(max(x,y),z),0.,1.);
#else
float grid=clamp(x+y+z,0.,1.);
#endif
vec3 color=mix(mainColor,lineColor,grid);
#ifdef FOG
#include<fogFragment>
#endif
float opacity=1.0;
#ifdef TRANSPARENT
opacity=clamp(grid,0.08,gridControl.w*grid);
#endif
#ifdef OPACITY
opacity*=texture2D(opacitySampler,vOpacityUV).a;
#endif
gl_FragColor=vec4(color.rgb,opacity*visibility);
#ifdef TRANSPARENT
#ifdef PREMULTIPLYALPHA
gl_FragColor.rgb*=opacity;
#endif
#else
#endif
#include<logDepthFragment>
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;X.ShadersStore[aU]=oU;const lU="gridVertexShader",hU=`precision highp float;attribute vec3 position;attribute vec3 normal;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#include<instancesDeclaration>
uniform mat4 projection;uniform mat4 view;varying vec3 vPosition;varying vec3 vNormal;
#include<logDepthDeclaration>
#include<fogVertexDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<fogVertex>
vec4 cameraSpacePosition=view*worldPos;gl_Position=projection*cameraSpacePosition;
#ifdef OPACITY
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
if (vOpacityInfos.x==0.)
{vOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));}
else
{vOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));}
#endif 
#include<logDepthVertex>
vPosition=position;vNormal=normal;
#define CUSTOM_VERTEX_MAIN_END
}`;X.ShadersStore[lU]=hU;class cU extends ir{constructor(){super(),this.OPACITY=!1,this.ANTIALIAS=!1,this.TRANSPARENT=!1,this.FOG=!1,this.PREMULTIPLYALPHA=!1,this.MAX_LINE=!1,this.UV1=!1,this.UV2=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.LOGARITHMICDEPTH=!1,this.rebuild()}}class $i extends Ph{constructor(e,t){super(e,t),this.mainColor=J.Black(),this.lineColor=J.Teal(),this.gridRatio=1,this.gridOffset=m.Zero(),this.majorUnitFrequency=10,this.minorUnitVisibility=.33,this.opacity=1,this.antialias=!0,this.preMultiplyAlpha=!1,this.useMaxLine=!1,this._gridControl=new ut(this.gridRatio,this.majorUnitFrequency,this.minorUnitVisibility,this.opacity)}needAlphaBlending(){return this.opacity<1||this._opacityTexture&&this._opacityTexture.isReady()}needAlphaBlendingForMesh(e){return e.visibility<1||this.needAlphaBlending()}isReadyForSubMesh(e,t,i){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new cU);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;if(s.TRANSPARENT!==this.opacity<1&&(s.TRANSPARENT=!s.TRANSPARENT,s.markAsUnprocessed()),s.PREMULTIPLYALPHA!=this.preMultiplyAlpha&&(s.PREMULTIPLYALPHA=!s.PREMULTIPLYALPHA,s.markAsUnprocessed()),s.MAX_LINE!==this.useMaxLine&&(s.MAX_LINE=!s.MAX_LINE,s.markAsUnprocessed()),s.ANTIALIAS!==this.antialias&&(s.ANTIALIAS=!s.ANTIALIAS,s.markAsUnprocessed()),s._areTexturesDirty&&(s._needUVs=!1,r.texturesEnabled&&this._opacityTexture&&ie.OpacityTextureEnabled))if(this._opacityTexture.isReady())s._needUVs=!0,s.OPACITY=!0;else return!1;if(se.PrepareDefinesForMisc(e,r,this._useLogarithmicDepth,!1,this.fogEnabled,!1,s),se.PrepareDefinesForFrameBoundValues(r,r.getEngine(),this,s,!!i),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial(),se.PrepareDefinesForAttributes(e,s,!1,!1);const n=[T.PositionKind,T.NormalKind];s.UV1&&n.push(T.UVKind),s.UV2&&n.push(T.UV2Kind),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess,se.PrepareAttributesForInstances(n,s);const a=s.toString();t.setEffect(r.getEngine().createEffect("grid",n,["projection","mainColor","lineColor","gridControl","gridOffset","vFogInfos","vFogColor","world","view","opacityMatrix","vOpacityInfos","visibility","logarithmicDepthConstant"],["opacitySampler"],a,void 0,this.onCompiled,this.onError),s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=!!i,!0)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;n&&(this._activeEffect=n,this._activeEffect.setFloat("visibility",t.visibility),(!r.INSTANCES||r.THIN_INSTANCE)&&this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("view",s.getViewMatrix()),this._activeEffect.setMatrix("projection",s.getProjectionMatrix()),this._mustRebind(s,n)&&(this._activeEffect.setColor3("mainColor",this.mainColor),this._activeEffect.setColor3("lineColor",this.lineColor),this._activeEffect.setVector3("gridOffset",this.gridOffset),this._gridControl.x=this.gridRatio,this._gridControl.y=Math.round(this.majorUnitFrequency),this._gridControl.z=this.minorUnitVisibility,this._gridControl.w=this.opacity,this._activeEffect.setVector4("gridControl",this._gridControl),this._opacityTexture&&ie.OpacityTextureEnabled&&(this._activeEffect.setTexture("opacitySampler",this._opacityTexture),this._activeEffect.setFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),this._activeEffect.setMatrix("opacityMatrix",this._opacityTexture.getTextureMatrix())),this._useLogarithmicDepth&&se.BindLogDepth(r,n,s)),se.BindFogParameters(s,t,this._activeEffect),this._afterBind(t,this._activeEffect))}dispose(e){super.dispose(e)}clone(e){return Le.Clone(()=>new $i(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GridMaterial",e}getClassName(){return"GridMaterial"}static Parse(e,t,i){return Le.Parse(()=>new $i(e.name,t),e,t,i)}}v([oi()],$i.prototype,"mainColor",void 0);v([oi()],$i.prototype,"lineColor",void 0);v([M()],$i.prototype,"gridRatio",void 0);v([zi()],$i.prototype,"gridOffset",void 0);v([M()],$i.prototype,"majorUnitFrequency",void 0);v([M()],$i.prototype,"minorUnitVisibility",void 0);v([M()],$i.prototype,"opacity",void 0);v([M()],$i.prototype,"antialias",void 0);v([M()],$i.prototype,"preMultiplyAlpha",void 0);v([M()],$i.prototype,"useMaxLine",void 0);v([rt("opacityTexture")],$i.prototype,"_opacityTexture",void 0);v([Z("_markAllSubMeshesAsTexturesDirty")],$i.prototype,"opacityTexture",void 0);Re("BABYLON.GridMaterial",$i);var uU=Object.defineProperty,dU=Object.getOwnPropertyDescriptor,Pl=(o,e,t,i)=>{for(var s=i>1?void 0:i?dU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&uU(e,t,s),s};const p_=class p_ extends br{constructor(){super(),this.mainColor=null,this.lineColor=null,this.gridRatio=null,this.majorUnitFrequency=null,this.minorUnitVisibility=null,this.opacity=null,new jf(this)}connected(){super.connected(),this.entity=new $i(this.id,this.scene),this.entity.useMaxLine=!0}willUpdate(e){super.willUpdate(e),this.entity&&(e.has("mainColor")&&this.evaluated.mainColor!==null&&this.entity.mainColor.copyFrom(this.evaluated.mainColor),e.has("lineColor")&&this.evaluated.lineColor!==null&&this.entity.lineColor.copyFrom(this.evaluated.lineColor),e.has("gridRatio")&&this.evaluated.gridRatio!==null&&(this.entity.gridRatio=this.evaluated.gridRatio),e.has("majorUnitFrequency")&&this.evaluated.majorUnitFrequency!==null&&(this.entity.majorUnitFrequency=this.evaluated.majorUnitFrequency),e.has("minorUnitVisibility")&&this.evaluated.minorUnitVisibility!==null&&(this.entity.minorUnitVisibility=this.evaluated.minorUnitVisibility),e.has("opacity")&&this.evaluated.opacity!==null&&(this.entity.opacity=this.evaluated.opacity))}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};p_.requiredAttrs=["id"];let Xr=p_;Pl([$.property("Color3","main-color",J.White())],Xr.prototype,"mainColor",2);Pl([$.property("Color3","line-color",J.Black())],Xr.prototype,"lineColor",2);Pl([$.property("Number","grid-ratio",1)],Xr.prototype,"gridRatio",2);Pl([$.property("Number","major-unit-frequency",10)],Xr.prototype,"majorUnitFrequency",2);Pl([$.property("Number","minor-unit-visible",.5)],Xr.prototype,"minorUnitVisibility",2);Pl([$.property("Number","opacity",.99)],Xr.prototype,"opacity",2);class is extends Pt{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new J(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}v([M(),Z("_markAllSubMeshesAsLightsDirty")],is.prototype,"maxSimultaneousLights",void 0);v([M(),Z("_markAllSubMeshesAsLightsDirty")],is.prototype,"disableLighting",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],is.prototype,"environmentTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],is.prototype,"invertNormalMapX",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],is.prototype,"invertNormalMapY",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],is.prototype,"normalTexture",void 0);v([oi("emissive"),Z("_markAllSubMeshesAsTexturesDirty")],is.prototype,"emissiveColor",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty")],is.prototype,"emissiveTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],is.prototype,"occlusionStrength",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],is.prototype,"occlusionTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],is.prototype,"alphaCutOff",void 0);v([M()],is.prototype,"doubleSided",null);v([rt(),Z("_markAllSubMeshesAsTexturesDirty",null)],is.prototype,"lightmapTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],is.prototype,"useLightmapAsShadowmap",void 0);class Yr extends is{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=Le.Clone(()=>new Yr(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Le.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=Le.Parse(()=>new Yr(e.name,t),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}v([oi(),Z("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Yr.prototype,"baseColor",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Yr.prototype,"baseTexture",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Yr.prototype,"metallic",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty")],Yr.prototype,"roughness",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],Yr.prototype,"metallicRoughnessTexture",void 0);Re("BABYLON.PBRMetallicRoughnessMaterial",Yr);class Kr extends is{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=Le.Clone(()=>new Kr(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=Le.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=Le.Parse(()=>new Kr(e.name,t),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}v([oi("diffuse"),Z("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Kr.prototype,"diffuseColor",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Kr.prototype,"diffuseTexture",void 0);v([oi("specular"),Z("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],Kr.prototype,"specularColor",void 0);v([M(),Z("_markAllSubMeshesAsTexturesDirty","_microSurface")],Kr.prototype,"glossiness",void 0);v([rt(),Z("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],Kr.prototype,"specularGlossinessTexture",void 0);Re("BABYLON.PBRSpecularGlossinessMaterial",Kr);var fU=Object.defineProperty,_U=Object.getOwnPropertyDescriptor,va=(o,e,t,i)=>{for(var s=i>1?void 0:i?_U(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&fU(e,t,s),s};const g_=class g_ extends br{constructor(){super(),this.albedoColor=null,this.albedoTexture=null,this.metallic=null,this.roughness=null,this.emissiveColor=null,this.unlit=null,this._albedoTexture=null,new Hr(this,"albedoTexture","_albedoTexture","xr-texture"),new jf(this)}connected(){super.connected(),this.entity=new me(this.id,this.scene),this.entity.useAlphaFromAlbedoTexture=!0}willUpdate(e){var t;super.willUpdate(e),this.entity&&(e.has("albedoColor")&&this.evaluated.albedoColor!==null&&this.entity.albedoColor.copyFrom(this.evaluated.albedoColor),e.has("metallic")&&(this.entity.metallic=this.evaluated.metallic),e.has("roughness")&&(this.entity.roughness=this.evaluated.roughness),e.has("emissiveColor")&&this.evaluated.emissiveColor!==null&&this.entity.emissiveColor.copyFrom(this.evaluated.emissiveColor),e.has("unlit")&&this.evaluated.unlit!==null&&(this.entity.unlit=this.evaluated.unlit),e.has("_albedoTexture")&&(this.entity.albedoTexture=((t=this._albedoTexture)==null?void 0:t.entity)||null))}disconnected(){var e;super.disconnected(),(e=this.entity)==null||e.dispose(),this.entity=null}};g_.requiredAttrs=["id"];let Er=g_;va([$.property("Color3","albedo-color",new J(1,1,1))],Er.prototype,"albedoColor",2);va([$.property("String","albedo-texture",null)],Er.prototype,"albedoTexture",2);va([$.property("Number","metallic",.2)],Er.prototype,"metallic",2);va([$.property("Number","roughness",.8)],Er.prototype,"roughness",2);va([$.property("Color3","emissive-color",null)],Er.prototype,"emissiveColor",2);va([$.property("Boolean","unlit",null)],Er.prototype,"unlit",2);va([Ss()],Er.prototype,"_albedoTexture",2);const kU={isTransformNodeLikeImpl:o=>typeof o=="object"&&o.position instanceof m&&o.rotation instanceof m&&o.scale instanceof m&&typeof o.layer=="number",isGeometryImpl:o=>typeof o=="object",isTextureImpl:o=>typeof o=="object"&&typeof o.hasAlpha=="boolean"&&typeof o.level=="number"&&typeof o.coordinatesIndex=="number"&&typeof o.coordinatesMode=="number"&&typeof o.wrapU=="number"&&typeof o.wrapV=="number"};var Oe=Oe||{};Oe.CompressionMethod={RAW:5718354,MG1:3229517,MG2:3295053};Oe.Flags={NORMALS:1};Oe.File=function(o){this.load(o)};Oe.File.prototype.load=function(o){this.header=new Oe.FileHeader(o),this.body=new Oe.FileBody(this.header),this.getReader().read(o,this.body)};Oe.File.prototype.getReader=function(){var o;switch(this.header.compressionMethod){case Oe.CompressionMethod.RAW:o=new Oe.ReaderRAW;break;case Oe.CompressionMethod.MG1:o=new Oe.ReaderMG1;break;case Oe.CompressionMethod.MG2:o=new Oe.ReaderMG2;break}return o};Oe.FileHeader=function(o){var e=o.readInt32();if(e!==1297367887)throw new Error("Not a OpenCTM stream, magic number should be 0x4d54434f ('OCTM')");this.fileFormat=o.readInt32(),this.compressionMethod=o.readInt32(),this.vertexCount=o.readInt32(),this.triangleCount=o.readInt32(),this.uvMapCount=o.readInt32(),this.attrMapCount=o.readInt32(),this.flags=o.readInt32(),this.comment=o.readString()};Oe.FileHeader.prototype.hasNormals=function(){return this.flags&Oe.Flags.NORMALS};Oe.FileBody=function(o){var e=o.triangleCount*3,t=o.vertexCount*3,i=o.hasNormals()?o.vertexCount*3:0,s=o.vertexCount*2,r=o.vertexCount*4,n=0,a=new ArrayBuffer((e+t+i+s*o.uvMapCount+r*o.attrMapCount)*4);if(this.indices=new Uint32Array(a,0,e),this.vertices=new Float32Array(a,e*4,t),o.hasNormals()&&(this.normals=new Float32Array(a,(e+t)*4,i)),o.uvMapCount)for(this.uvMaps=[],n=0;n<o.uvMapCount;++n)this.uvMaps[n]={uv:new Float32Array(a,(e+t+i+n*s)*4,s)};if(o.attrMapCount)for(this.attrMaps=[],n=0;n<o.attrMapCount;++n)this.attrMaps[n]={attr:new Float32Array(a,(e+t+i+s*o.uvMapCount+n*r)*4,r)}};Oe.FileMG2Header=function(o){o.readInt32(),this.vertexPrecision=o.readFloat32(),this.normalPrecision=o.readFloat32(),this.lowerBoundx=o.readFloat32(),this.lowerBoundy=o.readFloat32(),this.lowerBoundz=o.readFloat32(),this.higherBoundx=o.readFloat32(),this.higherBoundy=o.readFloat32(),this.higherBoundz=o.readFloat32(),this.divx=o.readInt32(),this.divy=o.readInt32(),this.divz=o.readInt32(),this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx,this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy,this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz};Oe.ReaderRAW=function(){};Oe.ReaderRAW.prototype.read=function(o,e){this.readIndices(o,e.indices),this.readVertices(o,e.vertices),e.normals&&this.readNormals(o,e.normals),e.uvMaps&&this.readUVMaps(o,e.uvMaps),e.attrMaps&&this.readAttrMaps(o,e.attrMaps)};Oe.ReaderRAW.prototype.readIndices=function(o,e){o.readInt32(),o.readArrayInt32(e)};Oe.ReaderRAW.prototype.readVertices=function(o,e){o.readInt32(),o.readArrayFloat32(e)};Oe.ReaderRAW.prototype.readNormals=function(o,e){o.readInt32(),o.readArrayFloat32(e)};Oe.ReaderRAW.prototype.readUVMaps=function(o,e){for(var t=0;t<e.length;++t)o.readInt32(),e[t].name=o.readString(),e[t].filename=o.readString(),o.readArrayFloat32(e[t].uv)};Oe.ReaderRAW.prototype.readAttrMaps=function(o,e){for(var t=0;t<e.length;++t)o.readInt32(),e[t].name=o.readString(),o.readArrayFloat32(e[t].attr)};Oe.ReaderMG1=function(){};Oe.ReaderMG1.prototype.read=function(o,e){this.readIndices(o,e.indices),this.readVertices(o,e.vertices),e.normals&&this.readNormals(o,e.normals),e.uvMaps&&this.readUVMaps(o,e.uvMaps),e.attrMaps&&this.readAttrMaps(o,e.attrMaps)};Oe.ReaderMG1.prototype.readIndices=function(o,e){o.readInt32(),o.readInt32();var t=new Oe.InterleavedStream(e,3);Be.decompress(o,o,t,t.data.length),Oe.restoreIndices(e,e.length)};Oe.ReaderMG1.prototype.readVertices=function(o,e){o.readInt32(),o.readInt32();var t=new Oe.InterleavedStream(e,1);Be.decompress(o,o,t,t.data.length)};Oe.ReaderMG1.prototype.readNormals=function(o,e){o.readInt32(),o.readInt32();var t=new Oe.InterleavedStream(e,3);Be.decompress(o,o,t,t.data.length)};Oe.ReaderMG1.prototype.readUVMaps=function(o,e){for(var t=0;t<e.length;++t){o.readInt32(),e[t].name=o.readString(),e[t].filename=o.readString(),o.readInt32();var i=new Oe.InterleavedStream(e[t].uv,2);Be.decompress(o,o,i,i.data.length)}};Oe.ReaderMG1.prototype.readAttrMaps=function(o,e){for(var t=0;t<e.length;++t){o.readInt32(),e[t].name=o.readString(),o.readInt32();var i=new Oe.InterleavedStream(e[t].attr,4);Be.decompress(o,o,i,i.data.length)}};Oe.ReaderMG2=function(){};Oe.ReaderMG2.prototype.read=function(o,e){this.MG2Header=new Oe.FileMG2Header(o),this.readVertices(o,e.vertices),this.readIndices(o,e.indices),e.normals&&this.readNormals(o,e),e.uvMaps&&this.readUVMaps(o,e.uvMaps),e.attrMaps&&this.readAttrMaps(o,e.attrMaps)};Oe.ReaderMG2.prototype.readVertices=function(o,e){o.readInt32(),o.readInt32();var t=new Oe.InterleavedStream(e,3);Be.decompress(o,o,t,t.data.length);var i=this.readGridIndices(o,e);Oe.restoreVertices(e,this.MG2Header,i,this.MG2Header.vertexPrecision)};Oe.ReaderMG2.prototype.readGridIndices=function(o,e){o.readInt32(),o.readInt32();var t=new Uint32Array(e.length/3),i=new Oe.InterleavedStream(t,1);return Be.decompress(o,o,i,i.data.length),Oe.restoreGridIndices(t,t.length),t};Oe.ReaderMG2.prototype.readIndices=function(o,e){o.readInt32(),o.readInt32();var t=new Oe.InterleavedStream(e,3);Be.decompress(o,o,t,t.data.length),Oe.restoreIndices(e,e.length)};Oe.ReaderMG2.prototype.readNormals=function(o,e){o.readInt32(),o.readInt32();var t=new Oe.InterleavedStream(e.normals,3);Be.decompress(o,o,t,t.data.length);var i=Oe.calcSmoothNormals(e.indices,e.vertices);Oe.restoreNormals(e.normals,i,this.MG2Header.normalPrecision)};Oe.ReaderMG2.prototype.readUVMaps=function(o,e){for(var t=0;t<e.length;++t){o.readInt32(),e[t].name=o.readString(),e[t].filename=o.readString();var i=o.readFloat32();o.readInt32();var s=new Oe.InterleavedStream(e[t].uv,2);Be.decompress(o,o,s,s.data.length),Oe.restoreMap(e[t].uv,2,i)}};Oe.ReaderMG2.prototype.readAttrMaps=function(o,e){for(var t=0;t<e.length;++t){o.readInt32(),e[t].name=o.readString();var i=o.readFloat32();o.readInt32();var s=new Oe.InterleavedStream(e[t].attr,4);Be.decompress(o,o,s,s.data.length),Oe.restoreMap(e[t].attr,4,i)}};Oe.restoreIndices=function(o,e){var t=3;for(e>0&&(o[2]+=o[0]);t<e;t+=3)o[t]+=o[t-3],o[t]===o[t-3]?o[t+1]+=o[t-2]:o[t+1]+=o[t],o[t+2]+=o[t]};Oe.restoreGridIndices=function(o,e){for(var t=1;t<e;++t)o[t]+=o[t-1]};Oe.restoreVertices=function(o,e,t,i){for(var s,r,n,a,l,h=new Uint32Array(o.buffer,o.byteOffset,o.length),c=e.divx,u=c*e.divy,d=2147483647,f=0,p=0,_=0,g=t.length;p<g;_+=3)n=s=t[p++],l=~~(n/u),n-=~~(l*u),a=~~(n/c),n-=~~(a*c),r=h[_],s===d&&(r+=f),o[_]=e.lowerBoundx+n*e.sizex+i*r,o[_+1]=e.lowerBoundy+a*e.sizey+i*h[_+1],o[_+2]=e.lowerBoundz+l*e.sizez+i*h[_+2],d=s,f=r};Oe.restoreNormals=function(o,e,t){for(var i,s,r,n,a,l,h,c,u,d,f=new Uint32Array(o.buffer,o.byteOffset,o.length),p=0,_=o.length,g=3.141592653589793*.5;p<_;p+=3)i=f[p]*t,s=f[p+1],s===0?(o[p]=e[p]*i,o[p+1]=e[p+1]*i,o[p+2]=e[p+2]*i):(s<=4?r=(f[p+2]-2)*g:r=(f[p+2]*4/s-2)*g,s*=t*g,n=i*Math.sin(s),a=n*Math.cos(r),l=n*Math.sin(r),h=i*Math.cos(s),u=e[p+1],c=e[p]-e[p+2],d=Math.sqrt(2*u*u+c*c),d>1e-20&&(c/=d,u/=d),o[p]=e[p]*h+(e[p+1]*u-e[p+2]*c)*l-u*a,o[p+1]=e[p+1]*h-(e[p+2]+e[p])*u*l+c*a,o[p+2]=e[p+2]*h+(e[p]*c+e[p+1]*u)*l+u*a)};Oe.restoreMap=function(o,e,t){for(var i,s,r=new Uint32Array(o.buffer,o.byteOffset,o.length),n=0,a,l=o.length;n<e;++n)for(i=0,a=n;a<l;a+=e)s=r[a],i+=s&1?-(s+1>>1):s>>1,o[a]=i*t};Oe.calcSmoothNormals=function(o,e){var t=new Float32Array(e.length),i,s,r,n,a,l,h,c,u,d,f,p,_,g,E;for(g=0,E=o.length;g<E;)i=o[g++]*3,s=o[g++]*3,r=o[g++]*3,h=e[s]-e[i],d=e[r]-e[i],c=e[s+1]-e[i+1],f=e[r+1]-e[i+1],u=e[s+2]-e[i+2],p=e[r+2]-e[i+2],n=c*p-u*f,a=u*d-h*p,l=h*f-c*d,_=Math.sqrt(n*n+a*a+l*l),_>1e-10&&(n/=_,a/=_,l/=_),t[i]+=n,t[i+1]+=a,t[i+2]+=l,t[s]+=n,t[s+1]+=a,t[s+2]+=l,t[r]+=n,t[r+1]+=a,t[r+2]+=l;for(g=0,E=t.length;g<E;g+=3)_=Math.sqrt(t[g]*t[g]+t[g+1]*t[g+1]+t[g+2]*t[g+2]),_>1e-10&&(t[g]/=_,t[g+1]/=_,t[g+2]/=_);return t};Oe.isLittleEndian=function(){var o=new ArrayBuffer(2),e=new Uint8Array(o),t=new Uint16Array(o);return e[0]=1,t[0]===1}();Oe.InterleavedStream=function(o,e){this.data=new Uint8Array(o.buffer,o.byteOffset,o.byteLength),this.offset=Oe.isLittleEndian?3:0,this.count=e*4,this.len=this.data.length};Oe.InterleavedStream.prototype.writeByte=function(o){this.data[this.offset]=o,this.offset+=this.count,this.offset>=this.len&&(this.offset-=this.len-4,this.offset>=this.count&&(this.offset-=this.count+(Oe.isLittleEndian?1:-1)))};Oe.Stream=function(o){o instanceof ArrayBuffer?this.data=new Uint8Array(o):this.data=o,this.offset=0};Oe.Stream.prototype.getPosition=function(){return this.offset};Oe.Stream.prototype.setPosition=function(o){this.offset=o};Oe.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23);Oe.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126);Oe.Stream.prototype.readByte=function(){return this.data instanceof Uint8Array?this.data[this.offset++]:this.data.charCodeAt(this.offset++)&255};Oe.Stream.prototype.readInt32=function(){var o=this.readByte();return o|=this.readByte()<<8,o|=this.readByte()<<16,o|this.readByte()<<24};Oe.Stream.prototype.readFloat32=function(){var o=this.readByte();o+=this.readByte()<<8;var e=this.readByte(),t=this.readByte();o+=(e&127)<<16;var i=(t&127)<<1|(e&128)>>>7,s=t&128?-1:1;return i===255?o!==0?NaN:s*(1/0):i>0?s*(1+o*this.TWO_POW_MINUS23)*Math.pow(2,i-127):o!==0?s*o*this.TWO_POW_MINUS126:s*0};Oe.Stream.prototype.readString=function(){var o=this.readInt32();if(this.offset+=o,this.data instanceof Uint8Array){for(var e=this.offset-o,t="",i=e;i<e+o;++i)t+=String.fromCharCode(this.data[i]);return t}else return this.data.substr(this.offset-o,o)};Oe.Stream.prototype.readArrayInt32=function(o){for(var e=0,t=o.length;e<t;)o[e++]=this.readInt32();return o};Oe.Stream.prototype.readArrayFloat32=function(o){for(var e=0,t=o.length;e<t;)o[e++]=this.readFloat32();return o};var Be=Be||{};Be.OutWindow=function(){this._windowSize=0};Be.OutWindow.prototype.create=function(o){(!this._buffer||this._windowSize!==o)&&(this._buffer=[]),this._windowSize=o,this._pos=0,this._streamPos=0};Be.OutWindow.prototype.flush=function(){var o=this._pos-this._streamPos;if(o!==0){for(;o--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0),this._streamPos=this._pos}};Be.OutWindow.prototype.releaseStream=function(){this.flush(),this._stream=null};Be.OutWindow.prototype.setStream=function(o){this.releaseStream(),this._stream=o};Be.OutWindow.prototype.init=function(o){o||(this._streamPos=0,this._pos=0)};Be.OutWindow.prototype.copyBlock=function(o,e){var t=this._pos-o-1;for(t<0&&(t+=this._windowSize);e--;)t>=this._windowSize&&(t=0),this._buffer[this._pos++]=this._buffer[t++],this._pos>=this._windowSize&&this.flush()};Be.OutWindow.prototype.putByte=function(o){this._buffer[this._pos++]=o,this._pos>=this._windowSize&&this.flush()};Be.OutWindow.prototype.getByte=function(o){var e=this._pos-o-1;return e<0&&(e+=this._windowSize),this._buffer[e]};Be.RangeDecoder=function(){};Be.RangeDecoder.prototype.setStream=function(o){this._stream=o};Be.RangeDecoder.prototype.releaseStream=function(){this._stream=null};Be.RangeDecoder.prototype.init=function(){var o=5;for(this._code=0,this._range=-1;o--;)this._code=this._code<<8|this._stream.readByte()};Be.RangeDecoder.prototype.decodeDirectBits=function(o){for(var e=0,t=o,i;t--;)this._range>>>=1,i=this._code-this._range>>>31,this._code-=this._range&i-1,e=e<<1|1-i,this._range&4278190080||(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return e};Be.RangeDecoder.prototype.decodeBit=function(o,e){var t=o[e],i=(this._range>>>11)*t;return(this._code^2147483648)<(i^2147483648)?(this._range=i,o[e]+=2048-t>>>5,this._range&4278190080||(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0):(this._range-=i,this._code-=i,o[e]-=t>>>5,this._range&4278190080||(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),1)};Be.initBitModels=function(o,e){for(;e--;)o[e]=1024};Be.BitTreeDecoder=function(o){this._models=[],this._numBitLevels=o};Be.BitTreeDecoder.prototype.init=function(){Be.initBitModels(this._models,1<<this._numBitLevels)};Be.BitTreeDecoder.prototype.decode=function(o){for(var e=1,t=this._numBitLevels;t--;)e=e<<1|o.decodeBit(this._models,e);return e-(1<<this._numBitLevels)};Be.BitTreeDecoder.prototype.reverseDecode=function(o){for(var e=1,t=0,i=0,s;i<this._numBitLevels;++i)s=o.decodeBit(this._models,e),e=e<<1|s,t|=s<<i;return t};Be.reverseDecode2=function(o,e,t,i){for(var s=1,r=0,n=0,a;n<i;++n)a=t.decodeBit(o,e+s),s=s<<1|a,r|=a<<n;return r};Be.LenDecoder=function(){this._choice=[],this._lowCoder=[],this._midCoder=[],this._highCoder=new Be.BitTreeDecoder(8),this._numPosStates=0};Be.LenDecoder.prototype.create=function(o){for(;this._numPosStates<o;++this._numPosStates)this._lowCoder[this._numPosStates]=new Be.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new Be.BitTreeDecoder(3)};Be.LenDecoder.prototype.init=function(){var o=this._numPosStates;for(Be.initBitModels(this._choice,2);o--;)this._lowCoder[o].init(),this._midCoder[o].init();this._highCoder.init()};Be.LenDecoder.prototype.decode=function(o,e){return o.decodeBit(this._choice,0)===0?this._lowCoder[e].decode(o):o.decodeBit(this._choice,1)===0?8+this._midCoder[e].decode(o):16+this._highCoder.decode(o)};Be.Decoder2=function(){this._decoders=[]};Be.Decoder2.prototype.init=function(){Be.initBitModels(this._decoders,768)};Be.Decoder2.prototype.decodeNormal=function(o){var e=1;do e=e<<1|o.decodeBit(this._decoders,e);while(e<256);return e&255};Be.Decoder2.prototype.decodeWithMatchByte=function(o,e){var t=1,i,s;do if(i=e>>7&1,e<<=1,s=o.decodeBit(this._decoders,(1+i<<8)+t),t=t<<1|s,i!==s){for(;t<256;)t=t<<1|o.decodeBit(this._decoders,t);break}while(t<256);return t&255};Be.LiteralDecoder=function(){};Be.LiteralDecoder.prototype.create=function(o,e){var t;if(!(this._coders&&this._numPrevBits===e&&this._numPosBits===o))for(this._numPosBits=o,this._posMask=(1<<o)-1,this._numPrevBits=e,this._coders=[],t=1<<this._numPrevBits+this._numPosBits;t--;)this._coders[t]=new Be.Decoder2};Be.LiteralDecoder.prototype.init=function(){for(var o=1<<this._numPrevBits+this._numPosBits;o--;)this._coders[o].init()};Be.LiteralDecoder.prototype.getDecoder=function(o,e){return this._coders[((o&this._posMask)<<this._numPrevBits)+((e&255)>>>8-this._numPrevBits)]};Be.Decoder=function(){this._outWindow=new Be.OutWindow,this._rangeDecoder=new Be.RangeDecoder,this._isMatchDecoders=[],this._isRepDecoders=[],this._isRepG0Decoders=[],this._isRepG1Decoders=[],this._isRepG2Decoders=[],this._isRep0LongDecoders=[],this._posSlotDecoder=[],this._posDecoders=[],this._posAlignDecoder=new Be.BitTreeDecoder(4),this._lenDecoder=new Be.LenDecoder,this._repLenDecoder=new Be.LenDecoder,this._literalDecoder=new Be.LiteralDecoder,this._dictionarySize=-1,this._dictionarySizeCheck=-1,this._posSlotDecoder[0]=new Be.BitTreeDecoder(6),this._posSlotDecoder[1]=new Be.BitTreeDecoder(6),this._posSlotDecoder[2]=new Be.BitTreeDecoder(6),this._posSlotDecoder[3]=new Be.BitTreeDecoder(6)};Be.Decoder.prototype.setDictionarySize=function(o){return o<0?!1:(this._dictionarySize!==o&&(this._dictionarySize=o,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096))),!0)};Be.Decoder.prototype.setLcLpPb=function(o,e,t){var i=1<<t;return o>8||e>4||t>4?!1:(this._literalDecoder.create(e,o),this._lenDecoder.create(i),this._repLenDecoder.create(i),this._posStateMask=i-1,!0)};Be.Decoder.prototype.init=function(){var o=4;for(this._outWindow.init(!1),Be.initBitModels(this._isMatchDecoders,192),Be.initBitModels(this._isRep0LongDecoders,192),Be.initBitModels(this._isRepDecoders,12),Be.initBitModels(this._isRepG0Decoders,12),Be.initBitModels(this._isRepG1Decoders,12),Be.initBitModels(this._isRepG2Decoders,12),Be.initBitModels(this._posDecoders,114),this._literalDecoder.init();o--;)this._posSlotDecoder[o].init();this._lenDecoder.init(),this._repLenDecoder.init(),this._posAlignDecoder.init(),this._rangeDecoder.init()};Be.Decoder.prototype.decode=function(o,e,t){var i=0,s=0,r=0,n=0,a=0,l=0,h=0,c,u,d,f,p,_;for(this._rangeDecoder.setStream(o),this._outWindow.setStream(e),this.init();t<0||l<t;)if(c=l&this._posStateMask,this._rangeDecoder.decodeBit(this._isMatchDecoders,(i<<4)+c)===0)u=this._literalDecoder.getDecoder(l++,h),i>=7?h=u.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(s)):h=u.decodeNormal(this._rangeDecoder),this._outWindow.putByte(h),i=i<4?0:i-(i<10?3:6);else{if(this._rangeDecoder.decodeBit(this._isRepDecoders,i)===1)d=0,this._rangeDecoder.decodeBit(this._isRepG0Decoders,i)===0?this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(i<<4)+c)===0&&(i=i<7?9:11,d=1):(this._rangeDecoder.decodeBit(this._isRepG1Decoders,i)===0?f=r:(this._rangeDecoder.decodeBit(this._isRepG2Decoders,i)===0?f=n:(f=a,a=n),n=r),r=s,s=f),d===0&&(d=2+this._repLenDecoder.decode(this._rangeDecoder,c),i=i<7?8:11);else if(a=n,n=r,r=s,d=2+this._lenDecoder.decode(this._rangeDecoder,c),i=i<7?7:10,p=this._posSlotDecoder[d<=5?d-2:3].decode(this._rangeDecoder),p>=4){if(_=(p>>1)-1,s=(2|p&1)<<_,p<14)s+=Be.reverseDecode2(this._posDecoders,s-p-1,this._rangeDecoder,_);else if(s+=this._rangeDecoder.decodeDirectBits(_-4)<<4,s+=this._posAlignDecoder.reverseDecode(this._rangeDecoder),s<0){if(s===-1)break;return!1}}else s=p;if(s>=l||s>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(s,d),l+=d,h=this._outWindow.getByte(0)}return this._outWindow.flush(),this._outWindow.releaseStream(),this._rangeDecoder.releaseStream(),!0};Be.Decoder.prototype.setDecoderProperties=function(o){var e,t,i,s,r;return o.size<5||(e=o.readByte(),t=e%9,e=~~(e/9),i=e%5,s=~~(e/5),!this.setLcLpPb(t,i,s))?!1:(r=o.readByte(),r|=o.readByte()<<8,r|=o.readByte()<<16,r+=o.readByte()*16777216,this.setDictionarySize(r))};Be.decompress=function(o,e,t,i){var s=new Be.Decoder;if(!s.setDecoderProperties(o))throw"Incorrect stream properties";if(!s.decode(e,t,i))throw"Error in data stream";return!0};const m_=class m_{constructor(){this.name="ctm",this.extensions={".ctm":{isBinary:!0}}}importMesh(e,t,i,s,r){e||(e=["DefaultMesh"]),Array.isArray(e)||(e=[e]),this.scene=t;const n=[];for(let a=0;a<e.length;a++){const l=e[a],h=this.parse(l,t,i);n.push(h)}return r&&n.forEach(a=>r.push(a)),!0}load(e,t,i){return this.importMesh(null,e,t,i,null)}loadAssetContainer(e,t,i){const s=new Qm(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,i,s.meshes),e._blockEntityCollection=!1,s}parse(e,t,i){const s=new Oe.File(new Oe.Stream(i)),r=new re(e,t),{indices:n,vertices:a}=s.body;if(!t.useRightHandedSystem)for(let h=0;h<n.length;h+=3){const c=n[h+2];n[h+2]=n[h+1],n[h+1]=c}r.setIndices(n),r.setVerticesData(T.PositionKind,a);const l=[];return fe.ComputeNormals(a,n,l),r.setVerticesData(T.NormalKind,l),r.computeWorldMatrix(!0),r.name=e,r}};m_.DO_NOT_ALTER_FILE_COORDINATES=!0;let vf=m_;class Dl extends Bi{}var pU=Object.defineProperty,gU=Object.getOwnPropertyDescriptor,ec=(o,e,t,i)=>{for(var s=i>1?void 0:i?gU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&pU(e,t,s),s};const E_=class E_ extends Dl{constructor(){super(...arguments),this.thickness=null,this.position=null,this.rotation=null,this.scale=null,this.color=null}connected(){super.connected()}disconnected(){super.disconnected()}render(){const e=this.evaluated.thickness||1,t=As`<xr-material id="${this.id}-material" .albedoColor=${this.evaluated.color} unlit></xr-material> `,i=As`
      <xr-mesh
        id="${this.id}-arrow"
        geometry="type: cylinder; diameter-top: 0; height: 0.075; diameter-bottom: ${.0375*(1+(e-1)/4)}; tessellation: 96"
        material="${this.id}-material"
        rotation="90 0 0"
        position="0 0 0.3"
      ></xr-mesh>
    `,s=As`
      <xr-mesh
        id="${this.id}-line"
        geometry="type: cylinder; diameter-top: ${.005*e}; height: 0.275; diameter-bottom: ${.005*e}; tessellation: 96"
        material="${this.id}-material"
        rotation="90 0 0"
        position="0 0 ${.275/2}"
      ></xr-mesh>
    `;return As`
      <xr-node
        id="${this.id}-root"
        .position=${this.evaluated.position}
        .rotation=${this.evaluated.rotation}
        .scale=${this.evaluated.scale}
      >
        ${t}${i}${s}
      </xr-node>
    `}};E_.requiredAttrs=["id"];let Mn=E_;ec([$.property("Number","thickness",null)],Mn.prototype,"thickness",2);ec([$.property("Vector3","position",null)],Mn.prototype,"position",2);ec([$.property("Vector3","rotation",null)],Mn.prototype,"rotation",2);ec([$.property("Vector3","scale",m.One())],Mn.prototype,"scale",2);ec([$.property("Color3","color",null)],Mn.prototype,"color",2);var mU=Object.defineProperty,EU=Object.getOwnPropertyDescriptor,Bn=(o,e,t,i)=>{for(var s=i>1?void 0:i?EU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&mU(e,t,s),s};class Qr extends Dl{constructor(){super(...arguments),this.position=null,this.rotation=null,this.scale=null,this.layer=null,this.quaternion=null,this.radiusX=null,this.radiusY=null,this.color=null}connected(){super.connected()}disconnected(){super.disconnected()}render(){const{position:e,rotation:t,scale:i,layer:s,quaternion:r,radiusX:n,radiusY:a,color:l}=this.evaluated;if(!n||!a)return;const h=[];for(let c=0;c<=360;c+=2){const u=n*Math.cos(c*Math.PI/180),d=a*Math.sin(c*Math.PI/180);h.push([u,d,0])}return As`
      <xr-line
        id=${this.id+"-ellipse"}
        .position=${e}
        .rotation=${t}
        .scale=${i}
        .layer=${s}
        .quaternion=${r}
        .points=${h.map(c=>c.join(" ")).join(", ")}
        .colors=${l==null?void 0:l.toHexString()}
      ></xr-line>
    `}}Bn([$.property("Vector3","position",null)],Qr.prototype,"position",2);Bn([$.property("Vector3","rotation",null)],Qr.prototype,"rotation",2);Bn([$.property("Vector3","scale",m.One())],Qr.prototype,"scale",2);Bn([$.property("Number","layer",null)],Qr.prototype,"layer",2);Bn([$.property("Quaternion","quaternion",null)],Qr.prototype,"quaternion",2);Bn([$.property("Number","radius-x",1)],Qr.prototype,"radiusX",2);Bn([$.property("Number","radius-y",1)],Qr.prototype,"radiusY",2);Bn([$.property("Color3","color",null)],Qr.prototype,"color",2);var TU=Object.defineProperty,vU=Object.getOwnPropertyDescriptor,r_=(o,e,t,i)=>{for(var s=i>1?void 0:i?vU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&TU(e,t,s),s},_n;const gu=(_n=class extends Dl{constructor(){super(...arguments),this.position=null,this.rotation=null,this.scale=null}connected(){super.connected()}disconnected(){super.disconnected()}_renderLights(){return As`
      <xr-point-light
        id="env-point-light-1"
        .inspect=${this.inspect}
        intensity="7"
        radius="7"
        .position=${new m(-2,2.5,2)}
        shadow-enabled
      ></xr-point-light>

      <xr-point-light
        id="env-point-light-2"
        .inspect=${this.inspect}
        intensity="7"
        radius="0.4"
        .position=${new m(4,3,-.5)}
      ></xr-point-light>

      <xr-point-light
        id="env-point-light-3"
        .inspect=${this.inspect}
        intensity="1"
        radius="0.5"
        .position=${new m(-1,3,-3)}
      ></xr-point-light>
    `}_renderSkyBox(){return As`
      <xr-background-material
        id="env-sky-box"
        enable-noise
        reflection-texture="url: ${_n.defaultSkyBoxTexture}; coordinates-mode: 5"
      ></xr-material>
      <xr-mesh disable-pointer-event id="env-sky-box" geometry="type: sphere" material="#env-sky-box" scale="100 100 100"></xr-mesh>
    `}_renderGround(){return As`
      <xr-material
        id="env-ground"
        unlit
        backface-culling
        albedo-texture="url: ${_n.defaultGroundTexture}; has-alpha: true"
      ></xr-material>
      <xr-mesh
        disable-pointer-event
        id="env-ground"
        geometry="type: plane"
        material="#env-ground"
        scale="5 5 5"
        rotation="90 0 0"
      ></xr-mesh>
    `}render(){return As`
      <xr-node id="env" .position=${this.position} .rotation=${this.rotation} .scale=${this.scale}>
        ${this._renderLights()}${this._renderSkyBox()}${this._renderGround()}
      </xr-node>
    `}},_n.defaultSkyBoxTexture=new URL("/solidx.js/assets/Skybox_2.0-256-l9K4Rogk.dds",import.meta.url).href,_n.defaultGroundTexture=new URL("/solidx.js/assets/Ground_2.0-256-CN4dKI_F.png",import.meta.url).href,_n);r_([$.property("Vector3","position",null)],gu.prototype,"position",2);r_([$.property("Vector3","rotation",null)],gu.prototype,"rotation",2);r_([$.property("Vector3","scale",m.One())],gu.prototype,"scale",2);let AU=gu;var RU=Object.defineProperty,bU=Object.getOwnPropertyDescriptor,tc=(o,e,t,i)=>{for(var s=i>1?void 0:i?bU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&RU(e,t,s),s};class Ol extends Dl{constructor(){super(...arguments),this.position=null,this.rotation=null,this.scale=null,this.type=null,this.size=null}connected(){super.connected()}disconnected(){super.disconnected()}render(){const{position:e,rotation:t,scale:i,type:s,size:r}=this.evaluated;return As`
      <xr-node id="${this.id}-root" .position=${e} .rotation=${t} .scale=${i}>
        <xr-mesh
          id="${this.id}-plane"
          geometry="type: ${s}; size: ${r}"
          material="el: xr-grid-material"
          rotation="90 0 0"
          disable-pointer-event
        ></xr-mesh>
      </xr-node>
    `}}tc([$.property("Vector3","position",null)],Ol.prototype,"position",2);tc([$.property("Vector3","rotation",null)],Ol.prototype,"rotation",2);tc([$.property("Vector3","scale",m.One())],Ol.prototype,"scale",2);tc([$.property("String","type","plane")],Ol.prototype,"type",2);tc([$.property("Number","size",100)],Ol.prototype,"size",2);var SU=Object.defineProperty,yU=Object.getOwnPropertyDescriptor,jE=(o,e,t,i)=>{for(var s=i>1?void 0:i?yU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&SU(e,t,s),s};class n_ extends Dl{constructor(){super(),this.target=null,this._target=null,new Hr(this,"target","_target",null)}connected(){super.connected()}disconnected(){super.disconnected()}render(){return As`<div>aaa</div>`}}jE([$.property("String","target",null)],n_.prototype,"target",2);jE([Ss()],n_.prototype,"_target",2);var CU=Object.defineProperty,xU=Object.getOwnPropertyDescriptor,MU=(o,e,t,i)=>{for(var s=i>1?void 0:i?xU(e,t):e,r=o.length-1,n;r>=0;r--)(n=o[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&CU(e,t,s),s};class qE extends Dl{constructor(){super(...arguments),this.size=null}connected(){super.connected()}disconnected(){super.disconnected()}render(){const{size:e}=this.evaluated;if(e)return As`
      <xr-node id="${this.id}-root">
        <xr-line disable-pointer-event id="${this.id}-x" points="-${e/2} 0 0, ${e/2} 0 0" colors="#ff0000"></xr-line>
        <xr-line disable-pointer-event id="${this.id}-y" points="0 -${e/2} 0, 0 ${e/2} 0" colors="#00ff00"></xr-line>
        <xr-line disable-pointer-event id="${this.id}-z" points="0 0 -${e/2}, 0 0 ${e/2}" colors="#0000ff"></xr-line>
      </xr-node>
    `}}MU([$.property("Number","size",100)],qE.prototype,"size",2);const Hc=class Hc{constructor(){this._elements={}}register(e,t){if(this._elements[e])throw new Error(`Element "${e}" already registered`);this._elements[e]=t}get(e){return this._elements[e]}keys(){return Object.keys(this._elements)}doRegisterToGlobal(){const e={},t=new Map;for(const s of this.keys()){gf.info("register element: %s",s);const r=this.get(s);cO(s)(r);const n=[];for(const[a,l]of r.elementProperties){if(typeof a!="string"||l.state)continue;const h=typeof l.attribute=="string"?l.attribute:a;let c,u;l.dType==="Color3"||l.dType==="Color4"?(c="<color>",u="#000000"):(l.dType==="Number"||l.dType==="Vector2"||l.dType==="Vector3"||l.dType==="Vector4")&&(c="<number>+",u="0"),t.set(h,{syntax:c,initialValue:u}),l.initValue!==null&&n.push(`---${h}: ${Vr.toCssLiteral(l.dType,l.initValue)}`)}e[s]=n}const i=document.createElement("style");i.dataset.for="xr",i.textContent=Object.entries(e).reduce((s,[r,n])=>s+`${r} {
${n.join(`;
`)}
}
`,""),document.head.appendChild(i);for(const[s,r]of t){const n=`---${s}`;gf.info("register css property: %s, %s(%s)",n,r.syntax||"*",r.initialValue||""),CSS.registerProperty({name:n,...r,inherits:!1})}}};Hc.Instance=new Hc;let Vt=Hc;ct.RegisterPlugin(new vf);Vt.Instance.register("xr-scene",G1);Vt.Instance.register("xr-geometry",kt);Vt.Instance.register("xr-material",Er);Vt.Instance.register("xr-mesh",or);Vt.Instance.register("xr-node",Il);Vt.Instance.register("xr-camera",Wr);Vt.Instance.register("xr-directional-light",gr);Vt.Instance.register("xr-hemispheric-light",mr);Vt.Instance.register("xr-point-light",Cn);Vt.Instance.register("xr-model",qi);Vt.Instance.register("xr-ray",pu);Vt.Instance.register("xr-decal",Rr);Vt.Instance.register("xr-texture",ds);Vt.Instance.register("xr-cube-texture",zs);Vt.Instance.register("xr-background-material",xn);Vt.Instance.register("xr-grid-material",Xr);Vt.Instance.register("xr-line",jr);Vt.Instance.register("xr-dragger",wn);Vt.Instance.register("xr-pipeline-ssao2",Zh);Vt.Instance.register("xr-volumetric-light",ar);Vt.Instance.register("xr-env",AU);Vt.Instance.register("xr-ground",Ol);Vt.Instance.register("xr-arrow",Mn);Vt.Instance.register("xr-world-axis",qE);Vt.Instance.register("xr-scene-projector",n_);Vt.Instance.register("xr-ellipse",Qr);Vt.Instance.doRegisterToGlobal();export{UU as AttributeObserverController,oO as BuiltinEventList,J as Color3,He as Color4,Uc as Context,$ as Decorator,Vt as ElementRegistry,Gs as ElementUtil,qO as EntityInspectController,ZO as EntityQueryController,QO as EventDispatchController,FU as LerpFns,$f as LightController,jf as MaterialController,wU as MathUtil,L as Matrix,JO as NodeStateController,Us as Plane,eN as PointerController,Dl as PrimitiveBase,le as Quaternion,Vr as Schema,D1 as TagListRefController,Hr as TagRefController,XE as TextureController,e_ as TickController,jh as TransformLikeController,kU as TypeGuard,Kg as ValueWrapper,Ke as Vector2,m as Vector3,ut as Vector4,Mn as XRArrow,xn as XRBackgroundMaterial,br as XRBaseMaterial,Wr as XRCamera,zs as XRCubeTexture,Rr as XRDecal,gr as XRDirectionalLight,wn as XRDragger,yn as XRElement,Qr as XREllipse,AU as XREnv,kt as XRGeometry,Xr as XRGridMaterial,Ol as XRGround,mr as XRHemisphericLight,jr as XRLine,Er as XRMaterial,or as XRMesh,qi as XRModel,Il as XRNode,Zh as XRPipelineSSAO2,Cn as XRPointLight,pu as XRRay,G1 as XRScene,Bi as XRSceneScopeElement,n_ as XRScreenProjector,ds as XRTexture,ar as XRVolumetricLight,qE as XRWorldAxis,BU as makeUniqueKey,bO as parseDurationString,Hh as randomID,yE as typedClone};
